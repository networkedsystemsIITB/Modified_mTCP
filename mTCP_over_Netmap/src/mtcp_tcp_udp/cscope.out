cscope 15 $HOME/Music/mtcp_old_arp_new               0001579856
	@addr_pool.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<±h»ad.h
>

4 
	~"addr_poŞ.h
"

5 
	~"rss.h
"

6 
	~"debug.h
"

9 
	saddr_’Œy


11 
sockaddr_š
 
	maddr
;

12 
TAILQ_ENTRY
(
addr_’Œy
è
	maddr_lšk
;

15 
	saddr_m­


17 
addr_’Œy
 *
	maddrm­
[
MAX_PORT
];

20 
	saddr_poŞ


22 
addr_’Œy
 *
	mpoŞ
;

23 
addr_m­
 *
	mm­³r
;

25 
ušt32_t
 
	maddr_ba£
;

26 
	mnum_addr
;

28 
	mnum_’Œy
;

29 
	mnum_ä“
;

30 
	mnum_u£d
;

32 
±h»ad_mu‹x_t
 
	mlock
;

33 
TAILQ_HEAD
(, 
addr_’Œy
è
	mä“_li¡
;

34 
TAILQ_HEAD
(, 
addr_’Œy
è
	mu£d_li¡
;

37 
addr_poŞ_t


38 
	$C»©eAdd»ssPoŞ
(
š_addr_t
 
addr_ba£
, 
num_addr
)

40 
addr_poŞ
 *
­
;

41 
num_’Œy
;

42 
i
, 
j
, 
út
;

43 
š_addr_t
 
addr
;

44 
ušt32_t
 
addr_h
;

46 
­
 = (
addr_poŞ_t
)
	`ÿÎoc
(1, (
addr_poŞ
));

47 ià(!
­
)

48  
NULL
;

51 
num_’Œy
 = 
num_addr
 * (
MAX_PORT
 - 
MIN_PORT
);

52 
­
->
poŞ
 = (
addr_’Œy
 *)
	`ÿÎoc
(
num_’Œy
, (addr_entry));

53 ià(!
­
->
poŞ
) {

54 
	`ä“
(
­
);

55  
NULL
;

59 
­
->
m­³r
 = (
addr_m­
 *)
	`ÿÎoc
(
num_addr
, (addr_map));

60 ià(!
­
->
m­³r
) {

61 
	`ä“
(
­
->
poŞ
);

62 
	`ä“
(
­
);

63  
NULL
;

66 
	`TAILQ_INIT
(&
­
->
ä“_li¡
);

67 
	`TAILQ_INIT
(&
­
->
u£d_li¡
);

69 ià(
	`±h»ad_mu‹x_š™
(&
­
->
lock
, 
NULL
)) {

70 
	`ä“
(
­
->
poŞ
);

71 
	`ä“
(
­
);

72  
NULL
;

75 
	`±h»ad_mu‹x_lock
(&
­
->
lock
);

77 
­
->
addr_ba£
 = 
	`Áohl
(addr_base);

78 
­
->
num_addr
 =‚um_addr;

80 
út
 = 0;

81 
i
 = 0; i < 
num_addr
; i++) {

82 
addr_h
 = 
­
->
addr_ba£
 + 
i
;

83 
addr
 = 
	`htÚl
(
addr_h
);

84 
j
 = 
MIN_PORT
; j < 
MAX_PORT
; j++) {

85 
­
->
poŞ
[
út
].
addr
.
sš_addr
.
s_addr
 =‡ddr;

86 
­
->
poŞ
[
út
].
addr
.
sš_pÜt
 = 
	`htÚs
(
j
);

87 
­
->
m­³r
[
i
].
addrm­
[
j
] = &­->
poŞ
[
út
];

89 
	`TAILQ_INSERT_TAIL
(&
­
->
ä“_li¡
, &­->
poŞ
[
út
], 
addr_lšk
);

91 ià((++
út
è>ğ
num_’Œy
)

95 
­
->
num_’Œy
 = 
út
;

96 
­
->
num_ä“
 = 
út
;

97 
­
->
num_u£d
 = 0;

99 
	`±h»ad_mu‹x_uÆock
(&
­
->
lock
);

101  
­
;

102 
	}
}

104 
addr_poŞ_t


105 
	$C»©eAdd»ssPoŞP”CÜe
(
cÜe
, 
num_queues
,

106 
š_addr_t
 
§ddr_ba£
, 
num_addr
, in_addr_ˆ
daddr
, 
š_pÜt_t
 
dpÜt
)

108 
addr_poŞ
 *
­
;

109 
num_’Œy
;

110 
i
, 
j
, 
út
;

111 
š_addr_t
 
§ddr
;

112 
ušt32_t
 
§ddr_h
, 
daddr_h
;

113 
ušt16_t
 
¥Üt_h
, 
dpÜt_h
;

114 
rss_cÜe
;

115 
ušt8_t
 
’dŸn_check
 = (
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) ?

118 
­
 = (
addr_poŞ_t
)
	`ÿÎoc
(1, (
addr_poŞ
));

119 ià(!
­
)

120  
NULL
;

123 
num_’Œy
 = (
num_addr
 * (
MAX_PORT
 - 
MIN_PORT
)è/ 
num_queues
;

124 
­
->
poŞ
 = (
addr_’Œy
 *)
	`ÿÎoc
(
num_’Œy
, (addr_entry));

125 ià(!
­
->
poŞ
) {

126 
	`ä“
(
­
);

127  
NULL
;

131 
­
->
m­³r
 = (
addr_m­
 *)
	`ÿÎoc
(
num_addr
, (addr_map));

132 ià(!
­
->
m­³r
) {

133 
	`ä“
(
­
->
poŞ
);

134 
	`ä“
(
­
);

135  
NULL
;

138 
	`TAILQ_INIT
(&
­
->
ä“_li¡
);

139 
	`TAILQ_INIT
(&
­
->
u£d_li¡
);

141 ià(
	`±h»ad_mu‹x_š™
(&
­
->
lock
, 
NULL
)) {

142 
	`ä“
(
­
->
poŞ
);

143 
	`ä“
(
­
);

144  
NULL
;

147 
	`±h»ad_mu‹x_lock
(&
­
->
lock
);

149 
­
->
addr_ba£
 = 
	`Áohl
(
§ddr_ba£
);

150 
­
->
num_addr
 =‚um_addr;

151 
daddr_h
 = 
	`Áohl
(
daddr
);

152 
dpÜt_h
 = 
	`Áohs
(
dpÜt
);

155 
út
 = 0;

156 
i
 = 0; i < 
num_addr
; i++) {

157 
§ddr_h
 = 
­
->
addr_ba£
 + 
i
;

158 
§ddr
 = 
	`htÚl
(
§ddr_h
);

159 
j
 = 
MIN_PORT
; j < 
MAX_PORT
; j++) {

160 ià(
út
 >ğ
num_’Œy
)

163 
¥Üt_h
 = 
j
;

164 
rss_cÜe
 = 
	`G‘RSSCPUCÜe
(
daddr_h
, 
§ddr_h
, 
dpÜt_h
, 
¥Üt_h
, 
num_queues
, 
’dŸn_check
);

165 ià(
rss_cÜe
 !ğ
cÜe
)

168 
­
->
poŞ
[
út
].
addr
.
sš_addr
.
s_addr
 = 
§ddr
;

169 
­
->
poŞ
[
út
].
addr
.
sš_pÜt
 = 
	`htÚs
(
¥Üt_h
);

170 
­
->
m­³r
[
i
].
addrm­
[
j
] = &­->
poŞ
[
út
];

171 
	`TAILQ_INSERT_TAIL
(&
­
->
ä“_li¡
, &­->
poŞ
[
út
], 
addr_lšk
);

172 
út
++;

176 
­
->
num_’Œy
 = 
út
;

177 
­
->
num_ä“
 = 
út
;

178 
­
->
num_u£d
 = 0;

180 ià(
­
->
num_’Œy
 < 
CONFIG
.
max_cÚcu¼’cy
) {

181 
	`årštf
(
¡d”r
, "[WARINING] Available #‡ddresses (%d) is smallerhan"

183 
­
->
num_’Œy
, 
CONFIG
.
max_cÚcu¼’cy
);

186 
	`±h»ad_mu‹x_uÆock
(&
­
->
lock
);

188  
­
;

189 
	}
}

192 
	$De¡royAdd»ssPoŞ
(
addr_poŞ_t
 
­
)

194 ià(!
­
)

197 ià(
­
->
poŞ
) {

198 
	`ä“
(
­
->
poŞ
);

199 
­
->
poŞ
 = 
NULL
;

202 ià(
­
->
m­³r
) {

203 
	`ä“
(
­
->
m­³r
);

204 
­
->
m­³r
 = 
NULL
;

207 
	`±h»ad_mu‹x_de¡roy
(&
­
->
lock
);

209 
	`ä“
(
­
);

210 
	}
}

213 
	$F‘chAdd»ss
(
addr_poŞ_t
 
­
, 
cÜe
, 
num_queues
,

214 cÚ¡ 
sockaddr_š
 *
daddr
, sockaddr_š *
§ddr
)

216 
addr_’Œy
 *
w®k
, *
Ãxt
;

217 
rss_cÜe
;

218 
»t
 = -1;

219 
ušt8_t
 
’dŸn_check
 = (
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) ?

222 ià(!
­
 || !
daddr
 || !
§ddr
)

225 
	`±h»ad_mu‹x_lock
(&
­
->
lock
);

227 
w®k
 = 
	`TAILQ_FIRST
(&
­
->
ä“_li¡
);

228 
w®k
) {

229 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
addr_lšk
);

231 ià(
§ddr
->
sš_addr
.
s_addr
 !ğ
INADDR_ANY
 &&

232 
w®k
->
addr
.
sš_addr
.
s_addr
 !ğ
§ddr
->sin_addr.s_addr) {

233 
w®k
 = 
Ãxt
;

237 ià(
§ddr
->
sš_pÜt
 !ğ
INPORT_ANY
 &&

238 
w®k
->
addr
.
sš_pÜt
 !ğ
§ddr
->sin_port) {

239 
w®k
 = 
Ãxt
;

243 
rss_cÜe
 = 
	`G‘RSSCPUCÜe
(
	`Áohl
(
w®k
->
addr
.
sš_addr
.
s_addr
),

244 
	`Áohl
(
daddr
->
sš_addr
.
s_addr
), 
	`Áohs
(
w®k
->
addr
.
sš_pÜt
),

245 
	`Áohs
(
daddr
->
sš_pÜt
), 
num_queues
, 
’dŸn_check
);

247 ià(
cÜe
 =ğ
rss_cÜe
)

250 
w®k
 = 
Ãxt
;

253 ià(
w®k
) {

254 *
§ddr
 = 
w®k
->
addr
;

255 
	`TAILQ_REMOVE
(&
­
->
ä“_li¡
, 
w®k
, 
addr_lšk
);

256 
	`TAILQ_INSERT_TAIL
(&
­
->
u£d_li¡
, 
w®k
, 
addr_lšk
);

257 
­
->
num_ä“
--;

258 
­
->
num_u£d
++;

259 
»t
 = 0;

262 
	`±h»ad_mu‹x_uÆock
(&
­
->
lock
);

264  
»t
;

265 
	}
}

268 
	$F»eAdd»ss
(
addr_poŞ_t
 
­
, cÚ¡ 
sockaddr_š
 *
addr
)

270 
addr_’Œy
 *
w®k
, *
Ãxt
;

271 
»t
 = -1;

273 ià(!
­
 || !
addr
)

276 
	`±h»ad_mu‹x_lock
(&
­
->
lock
);

278 ià(
­
->
m­³r
) {

279 
ušt32_t
 
addr_h
 = 
	`Áohl
(
addr
->
sš_addr
.
s_addr
);

280 
ušt16_t
 
pÜt_h
 = 
	`Áohs
(
addr
->
sš_pÜt
);

281 
šdex
 = 
addr_h
 - 
­
->
addr_ba£
;

283 ià(
šdex
 >ğ0 || index < 
­
->
num_addr
) {

284 
w®k
 = 
­
->
m­³r
[
addr_h
 -‡p->
addr_ba£
].
addrm­
[
pÜt_h
];

286 
w®k
 = 
NULL
;

290 
w®k
 = 
	`TAILQ_FIRST
(&
­
->
u£d_li¡
);

291 
w®k
) {

292 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
addr_lšk
);

293 ià(
addr
->
sš_pÜt
 =ğ
w®k
->addr.sin_port &&

294 
addr
->
sš_addr
.
s_addr
 =ğ
w®k
->addr.sin_addr.s_addr) {

298 
w®k
 = 
Ãxt
;

303 ià(
w®k
) {

304 
	`TAILQ_REMOVE
(&
­
->
u£d_li¡
, 
w®k
, 
addr_lšk
);

305 
	`TAILQ_INSERT_TAIL
(&
­
->
ä“_li¡
, 
w®k
, 
addr_lšk
);

306 
­
->
num_ä“
++;

307 
­
->
num_u£d
--;

308 
»t
 = 0;

311 
	`±h»ad_mu‹x_uÆock
(&
­
->
lock
);

313  
»t
;

314 
	}
}

	@api.cpp

1 
	~<sys/queue.h
>

2 
	~<sys/ioùl.h
>

3 
	~<lim™s.h
>

4 
	~<uni¡d.h
>

5 
	~<as£¹.h
>

7 
	~"mtı.h
"

8 
	~"mtı_­i.h
"

9 
	~"tı_š.h
"

10 
	~"tı_¡»am.h
"

11 
	~"tı_out.h
"

12 
	~"_out.h
"

13 
	~"ev’Şl.h
"

14 
	~"pe.h
"

15 
	~"fhash.h
"

16 
	~"addr_poŞ.h
"

17 
	~"rss.h
"

18 
	~"cÚfig.h
"

19 
	~"debug.h
"

21 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

22 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

25 
šlše
 

26 
	$mtı_is_cÚÃùed
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

28 ià(!
cur_¡»am
) {

29 
	`TRACE_API
("Stream does‚otƒxist\n");

30  
FALSE
;

32 ià(
cur_¡»am
->
¡©e
 !ğ
TCP_ST_ESTABLISHED
) {

33 
	`TRACE_API
("Stream %d‚ot ESTABLISHED. state: %s\n",

34 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream));

35  
FALSE
;

38  
TRUE
;

39 
	}
}

41 
mtı_mªag”_t


42 
	$G‘MTCPMªag”
(
mùx_t
 
mùx
)

44 ià(!
mùx
) {

45 
”ºo
 = 
EINVAL
;

46  
NULL
;

49 ià(
mùx
->
ıu
 < 0 || mùx->ıu >ğ
num_ıus
) {

50 
”ºo
 = 
EINVAL
;

51  
NULL
;

54 ià(
g_mtı
[
mùx
->
ıu
]->
ùx
->
dÚe
 || g_mtı[mùx->ıu]->ùx->
ex™
) {

55 
”ºo
 = 
EPERM
;

56  
NULL
;

59  
g_mtı
[
mùx
->
ıu
];

60 
	}
}

62 
šlše
 

63 
	$G‘Sock‘E¼Ü
(
sock‘_m­_t
 
sock‘
, *
İtv®
, 
sockËn_t
 *
İ’
)

65 
tı_¡»am
 *
cur_¡»am
;

67 ià(!
sock‘
->
¡»am
) {

68 
”ºo
 = 
EBADF
;

72 
cur_¡»am
 = 
sock‘
->
¡»am
;

73 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSED
) {

74 ià(
cur_¡»am
->
şo£_»asÚ
 =ğ
TCP_TIMEDOUT
 ||

75 
cur_¡»am
->
şo£_»asÚ
 =ğ
TCP_CONN_FAIL
 ||

76 
cur_¡»am
->
şo£_»asÚ
 =ğ
TCP_CONN_LOST
) {

77 *(*)
İtv®
 = 
ETIMEDOUT
;

78 *
İ’
 = ();

84 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 ||

85 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSED
) {

86 ià(
cur_¡»am
->
şo£_»asÚ
 =ğ
TCP_RESET
) {

87 *(*)
İtv®
 = 
ECONNRESET
;

88 *
İ’
 = ();

94 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_SENT
 &&

95 
”ºo
 =ğ
EINPROGRESS
) {

96 *(*)
İtv®
 = 
”ºo
;

97 *
İ’
 = ();

106 ià(
cur_¡»am
->
şo£_»asÚ
 =ğ
TCP_NOT_CLOSED
) {

107 *(*)
İtv®
 = 0;

108 *
İ’
 = ();

113 
”ºo
 = 
ENOSYS
;

115 
	}
}

118 
	$mtı_g‘sockÇme
(
mùx_t
 
mùx
, 
sockid
, 
sockaddr
 *
addr
,

119 
sockËn_t
 *
add¾’
)

121 
mtı_mªag”_t
 
mtı
;

122 
sock‘_m­_t
 
sock‘
;

124 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

125 ià(!
mtı
) {

129 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

130 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

131 
”ºo
 = 
EBADF
;

135 
sock‘
 = &
mtı
->
sm­
[
sockid
];

136 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

137 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

138 
”ºo
 = 
EBADF
;

142 ià(*
add¾’
 <= 0) {

143 
	`TRACE_API
("Inv®id‡dd¾’: %d\n", *
add¾’
);

144 
”ºo
 = 
EINVAL
;

148 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_LISTENER
 &&

149 
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

150 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

151 
”ºo
 = 
ENOTSOCK
;

155 *(
sockaddr_š
 *)
addr
 = 
sock‘
->
§ddr
;

156 *
add¾’
 = (
sock‘
->
§ddr
);

159 
	}
}

162 
	$mtı_g‘³”Çme
(
mùx_t
 
mùx
, 
sockid
, 
sockaddr
 *
addr
,

163 
sockËn_t
 *
add¾’
)

165 
mtı_mªag”_t
 
mtı
;

166 
sock‘_m­_t
 
sock‘
;

167 
sockaddr_š
 *
addr_š
;

168 
tı_¡»am
 *
¡»am
;

170 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

171 ià(!
mtı
) {

175 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

176 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

177 
”ºo
 = 
EBADF
;

181 
sock‘
 = &
mtı
->
sm­
[
sockid
];

182 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

183 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

184 
”ºo
 = 
EBADF
;

188 ià(*
add¾’
 <= 0) {

189 
	`TRACE_API
("Inv®id‡dd¾’: %d\n", *
add¾’
);

190 
”ºo
 = 
EINVAL
;

194 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_LISTENER
 &&

195 
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

196 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

197 
”ºo
 = 
ENOTSOCK
;

201 
¡»am
 = 
sock‘
->stream;

202 ià(!
	`mtı_is_cÚÃùed
(
mtı
, 
¡»am
)) {

203 
”ºo
 = 
ENOTCONN
;

207 
addr_š
 = (
sockaddr_š
 *)
addr
;

208 
addr_š
->
sš_çmy
 = 
AF_INET
;

209 
addr_š
->
sš_pÜt
 = 
¡»am
->
dpÜt
;

210 
addr_š
->
sš_addr
.
s_addr
 = 
¡»am
->
daddr
;

211 *
add¾’
 = (*
addr_š
);

214 
	}
}

217 
	$mtı_g‘sockİt
(
mùx_t
 
mùx
, 
sockid
, 
Ëv–
,

218 
İŠame
, *
İtv®
, 
sockËn_t
 *
İ’
)

220 
mtı_mªag”_t
 
mtı
;

221 
sock‘_m­_t
 
sock‘
;

223 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

224 ià(!
mtı
) {

228 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

229 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

230 
”ºo
 = 
EBADF
;

234 
sock‘
 = &
mtı
->
sm­
[
sockid
];

235 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

236 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

237 
”ºo
 = 
EBADF
;

241 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_LISTENER
 &&

242 
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

243 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

244 
”ºo
 = 
ENOTSOCK
;

248 ià(
Ëv–
 =ğ
SOL_SOCKET
) {

249 ià(
İŠame
 =ğ
SO_ERROR
) {

250 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_STREAM
) {

251  
	`G‘Sock‘E¼Ü
(
sock‘
, 
İtv®
, 
İ’
);

256 
”ºo
 = 
ENOSYS
;

258 
	}
}

261 
	$mtı_£tsockİt
(
mùx_t
 
mùx
, 
sockid
, 
Ëv–
,

262 
İŠame
, cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
)

264 
mtı_mªag”_t
 
mtı
;

265 
sock‘_m­_t
 
sock‘
;

267 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

268 ià(!
mtı
) {

272 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

273 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

274 
”ºo
 = 
EBADF
;

278 
sock‘
 = &
mtı
->
sm­
[
sockid
];

279 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

280 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

281 
”ºo
 = 
EBADF
;

285 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_LISTENER
 &&

286 
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

287 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

288 
”ºo
 = 
ENOTSOCK
;

293 
	}
}

296 
	$mtı_£tsock_nÚblock
(
mùx_t
 
mùx
, 
sockid
)

298 
mtı_mªag”_t
 
mtı
;

300 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

301 ià(!
mtı
) {

305 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

306 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

307 
”ºo
 = 
EBADF
;

311 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

312 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

313 
”ºo
 = 
EBADF
;

317 
mtı
->
sm­
[
sockid
].
İts
 |ğ
MTCP_NONBLOCK
;

320 
	}
}

323 
	$mtı_sock‘_ioùl
(
mùx_t
 
mùx
, 
sockid
, 
»que¡
, *
¬gp
)

325 
mtı_mªag”_t
 
mtı
;

326 
sock‘_m­_t
 
sock‘
;

328 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

329 ià(!
mtı
) {

333 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

334 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

335 
”ºo
 = 
EBADF
;

340 
sock‘
 = &
mtı
->
sm­
[
sockid
];

341 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
 &&

342 
sock‘
->
sockty³
 !ğ
MTCP_SOCK_LISTENER
) {

343 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

344 
”ºo
 = 
EBADF
;

348 ià(!
¬gp
) {

349 
”ºo
 = 
EFAULT
;

353 ià(
»que¡
 =ğ
FIONREAD
) {

354 
tı_¡»am
 *
cur_¡»am
;

355 
tı_ršg_bufãr
 *
rbuf
;

357 
cur_¡»am
 = 
sock‘
->
¡»am
;

358 ià(!
cur_¡»am
) {

359 
”ºo
 = 
EBADF
;

362 
rbuf
 = 
cur_¡»am
->
rcvv¬
->
rcvbuf
;

363 ià(
rbuf
) {

364 *(*)
¬gp
 = 
rbuf
->
m”ged_Ën
;

366 *(*)
¬gp
 = 0;

369 } ià(
»que¡
 =ğ
FIONBIO
) {

370 
št32_t
 
¬g
 = *(št32_ˆ*)
¬gp
;

371 ià(
¬g
 != 0)

372  
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

374 
”ºo
 = 
EINVAL
;

379 
	}
}

382 
	$mtı_sock‘
(
mùx_t
 
mùx
, 
domaš
, 
ty³
, 
´ÙocŞ
)

384 
mtı_mªag”_t
 
mtı
;

385 
sock‘_m­_t
 
sock‘
;

387 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

388 ià(!
mtı
) {

392 ià(
domaš
 !ğ
AF_INET
) {

393 
”ºo
 = 
EAFNOSUPPORT
;

397 ià(
ty³
 =ğ
SOCK_STREAM
) {

398 
ty³
 = 
MTCP_SOCK_STREAM
;

400 
”ºo
 = 
EINVAL
;

404 
sock‘
 = 
	`AÎoÿ‹Sock‘
(
mùx
, 
ty³
, 
FALSE
);

405 ià(!
sock‘
) {

406 
”ºo
 = 
ENFILE
;

410  
sock‘
->
id
;

411 
	}
}

414 
	$mtı_bšd
(
mùx_t
 
mùx
, 
sockid
,

415 cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
)

417 
mtı_mªag”_t
 
mtı
;

418 
sockaddr_š
 *
addr_š
;

420 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

421 ià(!
mtı
) {

425 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

426 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

427 
”ºo
 = 
EBADF
;

431 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

432 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

433 
”ºo
 = 
EBADF
;

437 ià(
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_STREAM
 &&

438 
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_LISTENER
) {

439 
	`TRACE_API
("NÙ‡ sŒ—m sock‘ id: %d\n", 
sockid
);

440 
”ºo
 = 
ENOTSOCK
;

444 ià(!
addr
) {

445 
	`TRACE_API
("Sock‘ %d:ƒm±y‡dd»ss!\n", 
sockid
);

446 
”ºo
 = 
EINVAL
;

450 ià(
mtı
->
sm­
[
sockid
].
İts
 & 
MTCP_ADDR_BIND
) {

451 
	`TRACE_API
("Sock‘ %d:‡d»s ®»ady bšd fÜhi sock‘.\n", 
sockid
);

452 
”ºo
 = 
EINVAL
;

457 ià(
addr
->
§_çmy
 !ğ
AF_INET
 || 
add¾’
 < (
sockaddr_š
)) {

458 
	`TRACE_API
("Sock‘ %d: inv®id‡rgum’t!\n", 
sockid
);

459 
”ºo
 = 
EINVAL
;

465 
addr_š
 = (
sockaddr_š
 *)
addr
;

466 
mtı
->
sm­
[
sockid
].
§ddr
 = *
addr_š
;

467 
mtı
->
sm­
[
sockid
].
İts
 |ğ
MTCP_ADDR_BIND
;

470 
	}
}

473 
	$mtı_li¡’
(
mùx_t
 
mùx
, 
sockid
, 
backlog
)

475 
mtı_mªag”_t
 
mtı
;

476 
tı_li¡’”
 *
li¡’”
;

478 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

479 ià(!
mtı
) {

483 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

484 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

485 
”ºo
 = 
EBADF
;

489 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

490 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

491 
”ºo
 = 
EBADF
;

495 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_STREAM
) {

496 
mtı
->
sm­
[
sockid
].
sockty³
 = 
MTCP_SOCK_LISTENER
;

499 ià(
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_LISTENER
) {

500 
	`TRACE_API
("NÙ‡†i¡’šg sock‘. id: %d\n", 
sockid
);

501 
”ºo
 = 
ENOTSOCK
;

505 ià(
backlog
 <ğ0 || backlog > 
CONFIG
.
max_cÚcu¼’cy
) {

506 
”ºo
 = 
EINVAL
;

511 ià(
	`Li¡’”HTS—rch
(
mtı
->
li¡’”s
,

512 &
mtı
->
sm­
[
sockid
].
§ddr
.
sš_pÜt
)) {

513 
”ºo
 = 
EADDRINUSE
;

517 
li¡’”
 = (
tı_li¡’”
 *)
	`ÿÎoc
(1, (tcp_listener));

518 ià(!
li¡’”
) {

523 
li¡’”
->
sockid
 = sockid;

524 
li¡’”
->
backlog
 = backlog;

525 
li¡’”
->
sock‘
 = &
mtı
->
sm­
[
sockid
];

527 ià(
	`±h»ad_cÚd_š™
(&
li¡’”
->
acû±_cÚd
, 
NULL
)) {

528 
	`³¼Ü
("pthread_cond_init of ctx->accept_cond\n");

531 ià(
	`±h»ad_mu‹x_š™
(&
li¡’”
->
acû±_lock
, 
NULL
)) {

532 
	`³¼Ü
("pthread_mutex_init of ctx->accept_lock\n");

536 
li¡’”
->
acû±q
 = 
	`C»©eSŒ—mQueue
(
backlog
);

537 ià(!
li¡’”
->
acû±q
) {

538 
”ºo
 = 
ENOMEM
;

542 
mtı
->
sm­
[
sockid
].
li¡’”
 =†istener;

543 
	`Li¡’”HTIn£¹
(
mtı
->
li¡’”s
, 
li¡’”
);

546 
	}
}

549 
	$mtı_acû±
(
mùx_t
 
mùx
, 
sockid
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
)

551 
mtı_mªag”_t
 
mtı
;

552 
tı_li¡’”
 *
li¡’”
;

553 
sock‘_m­_t
 
sock‘
;

554 
tı_¡»am
 *
acû±ed
 = 
NULL
;

556 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

557 ià(!
mtı
) {

561 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

562 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

563 
”ºo
 = 
EBADF
;

568 ià(
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_LISTENER
) {

569 
”ºo
 = 
EINVAL
;

573 
li¡’”
 = 
mtı
->
sm­
[
sockid
].listener;

577 
acû±ed
 = 
	`SŒ—mDequeue
(
li¡’”
->
acû±q
);

578 ià(!
acû±ed
) {

579 ià(
li¡’”
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

580 
”ºo
 = 
EAGAIN
;

584 
	`±h»ad_mu‹x_lock
(&
li¡’”
->
acû±_lock
);

585 (
acû±ed
 = 
	`SŒ—mDequeue
(
li¡’”
->
acû±q
)è=ğ
NULL
) {

586 
	`±h»ad_cÚd_wa™
(&
li¡’”
->
acû±_cÚd
, &li¡’”->
acû±_lock
);

588 ià(
mtı
->
ùx
->
dÚe
 || mtı->ùx->
ex™
) {

589 
	`±h»ad_mu‹x_uÆock
(&
li¡’”
->
acû±_lock
);

590 
”ºo
 = 
EINTR
;

594 
	`±h»ad_mu‹x_uÆock
(&
li¡’”
->
acû±_lock
);

598 ià(!
acû±ed
) {

599 
	`TRACE_ERROR
("[NEVER HAPPEN] Empty‡ccept queue!\n");

602 ià(!
acû±ed
->
sock‘
) {

603 
sock‘
 = 
	`AÎoÿ‹Sock‘
(
mùx
, 
MTCP_SOCK_STREAM
, 
FALSE
);

604 ià(!
sock‘
) {

605 
	`TRACE_ERROR
("Failedo create‚ew socket!\n");

607 
”ºo
 = 
ENFILE
;

610 
sock‘
->
¡»am
 = 
acû±ed
;

611 
acû±ed
->
sock‘
 = socket;

614 
sock‘
->
§ddr
.
sš_çmy
 = 
AF_INET
;

615 
sock‘
->
§ddr
.
sš_pÜt
 = 
acû±ed
->
dpÜt
;

616 
sock‘
->
§ddr
.
sš_addr
.
s_addr
 = 
acû±ed
->
daddr
;

619 ià(!(
li¡’”
->
sock‘
->
•Şl
 & 
MTCP_EPOLLET
) &&

620 !
	`SŒ—mQueueIsEm±y
(
li¡’”
->
acû±q
))

621 
	`AddEpŞlEv’t
(
mtı
->
•
,

622 
USR_SHADOW_EVENT_QUEUE
,

623 
li¡’”
->
sock‘
, 
MTCP_EPOLLIN
);

625 
	`TRACE_API
("SŒ—m %d‡cû±ed.\n", 
acû±ed
->
id
);

627 ià(
addr
 && 
add¾’
) {

628 
sockaddr_š
 *
addr_š
 = (sockaddr_š *)
addr
;

629 
addr_š
->
sš_çmy
 = 
AF_INET
;

630 
addr_š
->
sš_pÜt
 = 
acû±ed
->
dpÜt
;

631 
addr_š
->
sš_addr
.
s_addr
 = 
acû±ed
->
daddr
;

632 *
add¾’
 = (
sockaddr_š
);

635  
acû±ed
->
sock‘
->
id
;

636 
	}
}

639 
	$mtı_š™_rss
(
mùx_t
 
mùx
, 
š_addr_t
 
§ddr_ba£
, 
num_addr
,

640 
š_addr_t
 
daddr
, in_addr_ˆ
dpÜt
)

642 
mtı_mªag”_t
 
mtı
;

643 
addr_poŞ_t
 
­
;

645 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

646 ià(!
mtı
) {

650 ià(
§ddr_ba£
 =ğ
INADDR_ANY
) {

651 
nif_out
;

655 
nif_out
 = 
	`G‘OuutIÁ”çû
(
daddr
);

656 
§ddr_ba£
 = 
CONFIG
.
‘hs
[
nif_out
].
_addr
;

659 
­
 = 
	`C»©eAdd»ssPoŞP”CÜe
(
mùx
->
ıu
, 
num_ıus
,

660 
§ddr_ba£
, 
num_addr
, 
daddr
, 
dpÜt
);

661 ià(!
­
) {

662 
”ºo
 = 
ENOMEM
;

666 
mtı
->
­
 =‡p;

669 
	}
}

672 
	$mtı_cÚÃù
(
mùx_t
 
mùx
, 
sockid
,

673 cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
)

675 
mtı_mªag”_t
 
mtı
;

676 
sock‘_m­_t
 
sock‘
;

677 
tı_¡»am
 *
cur_¡»am
;

678 
sockaddr_š
 *
addr_š
;

679 
š_addr_t
 
d
;

680 
š_pÜt_t
 
dpÜt
;

681 
is_dyn_bound
 = 
FALSE
;

682 
»t
;

684 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

685 ià(!
mtı
) {

689 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

690 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

691 
”ºo
 = 
EBADF
;

695 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

696 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

697 
”ºo
 = 
EBADF
;

701 ià(
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

702 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

703 
”ºo
 = 
ENOTSOCK
;

707 ià(!
addr
) {

708 
	`TRACE_API
("Sock‘ %d:ƒm±y‡dd»ss!\n", 
sockid
);

709 
”ºo
 = 
EFAULT
;

714 ià(
addr
->
§_çmy
 !ğ
AF_INET
 || 
add¾’
 < (
sockaddr_š
)) {

715 
	`TRACE_API
("Sock‘ %d: inv®id‡rgum’t!\n", 
sockid
);

716 
”ºo
 = 
EAFNOSUPPORT
;

720 
sock‘
 = &
mtı
->
sm­
[
sockid
];

721 ià(
sock‘
->
¡»am
) {

722 
	`TRACE_API
("Sock‘ %d: sŒ—m‡Ì—dyƒxi¡!\n", 
sockid
);

723 ià(
sock‘
->
¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
) {

724 
”ºo
 = 
EISCONN
;

726 
”ºo
 = 
EALREADY
;

731 
addr_š
 = (
sockaddr_š
 *)
addr
;

732 
d
 = 
addr_š
->
sš_addr
.
s_addr
;

733 
dpÜt
 = 
addr_š
->
sš_pÜt
;

736 ià((
sock‘
->
İts
 & 
MTCP_ADDR_BIND
) &&

737 
sock‘
->
§ddr
.
sš_pÜt
 !ğ
INPORT_ANY
 &&

738 
sock‘
->
§ddr
.
sš_addr
.
s_addr
 !ğ
INADDR_ANY
) {

739 
rss_cÜe
;

741 
ušt8_t
 
’dŸn_check
 = (
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) ?

752 ià(
mtı
->
­
) {

753 
»t
 = 
	`F‘chAdd»ss
(
mtı
->
­
,

754 
mùx
->
ıu
, 
num_queues
, 
addr_š
, &
sock‘
->
§ddr
);

756 
»t
 = 
	`F‘chAdd»ss
(
­
[
	`G‘OuutIÁ”çû
(
d
)],

757 
mùx
->
ıu
, 
num_queues
, 
addr_š
, &
sock‘
->
§ddr
);

759 ià(
»t
 < 0) {

760 
	`TRACE_ERROR
("Connectƒrror.");

761 
”ºo
 = 
EAGAIN
;

764 
sock‘
->
İts
 |ğ
MTCP_ADDR_BIND
;

765 
is_dyn_bound
 = 
TRUE
;

768 
cur_¡»am
 = 
	`C»©eTCPSŒ—m
(
mtı
, 
sock‘
, sock‘->
sockty³
,

769 
sock‘
->
§ddr
.
sš_addr
.
s_addr
, sock‘->§ddr.
sš_pÜt
, 
d
, 
dpÜt
);

770 ià(!
cur_¡»am
) {

771 
	`TRACE_ERROR
("Sock‘ %d: faedØü—‹ı_¡»am!\n", 
sockid
);

772 
”ºo
 = 
ENOMEM
;

776 ià(
is_dyn_bound
)

777 
cur_¡»am
->
is_bound_addr
 = 
TRUE
;

778 
cur_¡»am
->
¢dv¬
->
cwnd
 = 1;

779 
cur_¡»am
->
¢dv¬
->
s¡h»sh
 = cur_¡»am->¢dv¬->
mss
 * 10;

781 
cur_¡»am
->
¡©e
 = 
TCP_ST_SYN_SENT
;

782 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_SYN_SENT\n", 
cur_¡»am
->
id
);

784 
	`SQ_LOCK
(&
mtı
->
ùx
->
cÚÃù_lock
);

785 
»t
 = 
	`SŒ—mEnqueue
(
mtı
->
cÚÃùq
, 
cur_¡»am
);

786 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
cÚÃù_lock
);

787 
mtı
->
wakeup_æag
 = 
TRUE
;

788 ià(
»t
 < 0) {

789 
	`TRACE_ERROR
("Sock‘ %d: faedØ’queutØcÚ’ù queue!\n", 
sockid
);

790 
	`SQ_LOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

791 
	`SŒ—mEnqueue
(
mtı
->
de¡royq
, 
cur_¡»am
);

792 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

793 
”ºo
 = 
EAGAIN
;

798 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

799 
”ºo
 = 
EINPROGRESS
;

804 ià(!
cur_¡»am
) {

805 
	`TRACE_ERROR
("STREAM DESTROYED\n");

806 
”ºo
 = 
ETIMEDOUT
;

809 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_ESTABLISHED
) {

810 
	`TRACE_ERROR
("Socket %d: weird state %s\n",

811 
sockid
, 
	`TCPS‹ToSŒšg
(
cur_¡»am
));

813 
”ºo
 = 
ENOSYS
;

817 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

820 
	`u¦“p
(1000);

825 
	}
}

827 
šlše
 

828 
	$Clo£SŒ—mSock‘
(
mùx_t
 
mùx
, 
sockid
)

830 
mtı_mªag”_t
 
mtı
;

831 
tı_¡»am
 *
cur_¡»am
;

832 
»t
;

834 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

835 ià(!
mtı
) {

839 
cur_¡»am
 = 
mtı
->
sm­
[
sockid
].
¡»am
;

840 ià(!
cur_¡»am
) {

841 
	`TRACE_API
("Sock‘ %d: sŒ—m dÛ nÙƒxi¡.\n", 
sockid
);

842 
”ºo
 = 
ENOTCONN
;

846 ià(
cur_¡»am
->
şo£d
) {

847 
	`TRACE_API
("Socket %d (Stream %u):‡lready closed stream\n",

848 
sockid
, 
cur_¡»am
->
id
);

851 
cur_¡»am
->
şo£d
 = 
TRUE
;

853 
	`TRACE_API
("SŒ—m %d: closšgh¡»am.\n", 
cur_¡»am
->
id
);

855 
cur_¡»am
->
sock‘
 = 
NULL
;

857 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSED
) {

858 
	`TRACE_API
("Stream %d‡t TCP_ST_CLOSED. destroyinghe stream.\n",

859 
cur_¡»am
->
id
);

860 
	`SQ_LOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

861 
	`SŒ—mEnqueue
(
mtı
->
de¡royq
, 
cur_¡»am
);

862 
mtı
->
wakeup_æag
 = 
TRUE
;

863 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

866 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_SENT
) {

868 
	`SQ_LOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

869 
	`SŒ—mEnqueue
(
mtı
->
de¡royq
, 
cur_¡»am
);

870 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

871 
mtı
->
wakeup_æag
 = 
TRUE
;

875 } ià(
cur_¡»am
->
¡©e
 !ğ
TCP_ST_ESTABLISHED
 &&

876 
cur_¡»am
->
¡©e
 !ğ
TCP_ST_CLOSE_WAIT
) {

877 
	`TRACE_API
("Stream %d‡t state %s\n",

878 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream));

879 
”ºo
 = 
EBADF
;

883 
	`SQ_LOCK
(&
mtı
->
ùx
->
şo£_lock
);

884 
cur_¡»am
->
¢dv¬
->
Ú_şo£q
 = 
TRUE
;

885 
»t
 = 
	`SŒ—mEnqueue
(
mtı
->
şo£q
, 
cur_¡»am
);

886 
mtı
->
wakeup_æag
 = 
TRUE
;

887 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
şo£_lock
);

889 ià(
»t
 < 0) {

890 
	`TRACE_ERROR
("(NEVER HAPPEN) Failedoƒnqueuehe streamo close.\n");

891 
”ºo
 = 
EAGAIN
;

896 
	}
}

898 
šlše
 

899 
	$Clo£Li¡’šgSock‘
(
mùx_t
 
mùx
, 
sockid
)

901 
mtı_mªag”_t
 
mtı
;

902 
tı_li¡’”
 *
li¡’”
;

904 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

905 ià(!
mtı
) {

909 
li¡’”
 = 
mtı
->
sm­
[
sockid
].listener;

910 ià(!
li¡’”
) {

911 
”ºo
 = 
EINVAL
;

915 ià(
li¡’”
->
acû±q
) {

916 
	`De¡roySŒ—mQueue
(
li¡’”
->
acû±q
);

917 
li¡’”
->
acû±q
 = 
NULL
;

920 
	`±h»ad_mu‹x_lock
(&
li¡’”
->
acû±_lock
);

921 
	`±h»ad_cÚd_sigÇl
(&
li¡’”
->
acû±_cÚd
);

922 
	`±h»ad_mu‹x_uÆock
(&
li¡’”
->
acû±_lock
);

924 
	`±h»ad_cÚd_de¡roy
(&
li¡’”
->
acû±_cÚd
);

925 
	`±h»ad_mu‹x_de¡roy
(&
li¡’”
->
acû±_lock
);

927 
	`ä“
(
li¡’”
);

928 
mtı
->
sm­
[
sockid
].
li¡’”
 = 
NULL
;

931 
	}
}

934 
	$mtı_şo£
(
mùx_t
 
mùx
, 
sockid
)

936 
mtı_mªag”_t
 
mtı
;

937 
»t
;

939 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

940 ià(!
mtı
) {

944 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

945 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

946 
”ºo
 = 
EBADF
;

950 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

951 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

952 
”ºo
 = 
EBADF
;

956 
	`TRACE_API
("Sock‘ %d: mtı_şo£ c®Ëd.\n", 
sockid
);

958 
mtı
->
sm­
[
sockid
].
sockty³
) {

959 
MTCP_SOCK_STREAM
:

960 
»t
 = 
	`Clo£SŒ—mSock‘
(
mùx
, 
sockid
);

963 
MTCP_SOCK_LISTENER
:

964 
»t
 = 
	`Clo£Li¡’šgSock‘
(
mùx
, 
sockid
);

967 
MTCP_SOCK_EPOLL
:

968 
»t
 = 
	`Clo£EpŞlSock‘
(
mùx
, 
sockid
);

971 
MTCP_SOCK_PIPE
:

972 
»t
 = 
	`PeClo£
(
mùx
, 
sockid
);

976 
”ºo
 = 
EINVAL
;

977 
»t
 = -1;

981 
	`F»eSock‘
(
mùx
, 
sockid
, 
FALSE
);

983  
»t
;

984 
	}
}

987 
	$mtı_abÜt
(
mùx_t
 
mùx
, 
sockid
)

989 
mtı_mªag”_t
 
mtı
;

990 
tı_¡»am
 *
cur_¡»am
;

991 
»t
;

993 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

994 ià(!
mtı
) {

998 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

999 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

1000 
”ºo
 = 
EBADF
;

1004 ià(
mtı
->
sm­
[
sockid
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

1005 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

1006 
”ºo
 = 
EBADF
;

1010 ià(
mtı
->
sm­
[
sockid
].
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

1011 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

1012 
”ºo
 = 
ENOTSOCK
;

1016 
cur_¡»am
 = 
mtı
->
sm­
[
sockid
].
¡»am
;

1017 ià(!
cur_¡»am
) {

1018 
	`TRACE_API
("SŒ—m %d: dÛ nÙƒxi¡.\n", 
sockid
);

1019 
”ºo
 = 
ENOTCONN
;

1023 
	`TRACE_API
("Sock‘ %d: mtı_abÜt()\n", 
sockid
);

1025 
	`F»eSock‘
(
mùx
, 
sockid
, 
FALSE
);

1026 
cur_¡»am
->
sock‘
 = 
NULL
;

1028 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSED
) {

1029 
	`TRACE_API
("SŒ—m %d: cÚÃùiÚ‡Ì—dy„e£t.\n", 
sockid
);

1030  
ERROR
;

1032 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_SENT
) {

1035 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

1036 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

1037 
	`SQ_LOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

1038 
	`SŒ—mEnqueue
(
mtı
->
de¡royq
, 
cur_¡»am
);

1039 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

1040 
mtı
->
wakeup_æag
 = 
TRUE
;

1043 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
 ||

1044 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
 ||

1045 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_TIME_WAIT
) {

1046 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

1047 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

1048 
	`SQ_LOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

1049 
	`SŒ—mEnqueue
(
mtı
->
de¡royq
, 
cur_¡»am
);

1050 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
de¡royq_lock
);

1051 
mtı
->
wakeup_æag
 = 
TRUE
;

1056 ià(
cur_¡»am
->
¢dv¬
->
Ú_»£tq
) {

1057 
	`TRACE_ERROR
("Stream %d: calling mtcp_abort() "

1058 "wh’ iÀ»£ˆqueue.\n", 
sockid
);

1059 
”ºo
 = 
ECONNRESET
;

1062 
	`SQ_LOCK
(&
mtı
->
ùx
->
»£t_lock
);

1063 
cur_¡»am
->
¢dv¬
->
Ú_»£tq
 = 
TRUE
;

1064 
»t
 = 
	`SŒ—mEnqueue
(
mtı
->
»£tq
, 
cur_¡»am
);

1065 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
»£t_lock
);

1066 
mtı
->
wakeup_æag
 = 
TRUE
;

1068 ià(
»t
 < 0) {

1069 
	`TRACE_ERROR
("(NEVER HAPPEN) Failedoƒnqueuehe streamo close.\n");

1070 
”ºo
 = 
EAGAIN
;

1075 
	}
}

1077 
šlše
 

1078 
	$P“kFÜU£r
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, *
buf
, 
Ën
)

1080 
tı_»cv_v¬s
 *
rcvv¬
 = 
cur_¡»am
->rcvvar;

1081 
cİyËn
;

1083 
cİyËn
 = 
	`MIN
(
rcvv¬
->
rcvbuf
->
m”ged_Ën
, 
Ën
);

1084 ià(
cİyËn
 <= 0) {

1085 
”ºo
 = 
EAGAIN
;

1090 
	`memıy
(
buf
, 
rcvv¬
->
rcvbuf
->
h—d
, 
cİyËn
);

1092  
cİyËn
;

1093 
	}
}

1095 
šlše
 

1096 
	$CİyToU£r
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, *
buf
, 
Ën
)

1098 
tı_»cv_v¬s
 *
rcvv¬
 = 
cur_¡»am
->rcvvar;

1099 
ušt32_t
 
´ev_rcv_wnd
;

1100 
cİyËn
;

1102 
cİyËn
 = 
	`MIN
(
rcvv¬
->
rcvbuf
->
m”ged_Ën
, 
Ën
);

1103 ià(
cİyËn
 <= 0) {

1104 
”ºo
 = 
EAGAIN
;

1108 
´ev_rcv_wnd
 = 
rcvv¬
->
rcv_wnd
;

1110 
	`memıy
(
buf
, 
rcvv¬
->
rcvbuf
->
h—d
, 
cİyËn
);

1111 
	`RBRemove
(
mtı
->
rbm_rcv
, 
rcvv¬
->
rcvbuf
, 
cİyËn
, 
AT_APP
);

1112 
rcvv¬
->
rcv_wnd
 =„cvv¬->
rcvbuf
->
size
 -„cvv¬->rcvbuf->
m”ged_Ën
;

1115 ià(
cur_¡»am
->
Ãed_wnd_adv
) {

1116 ià(
rcvv¬
->
rcv_wnd
 > 
cur_¡»am
->
¢dv¬
->
eff_mss
) {

1117 ià(!
cur_¡»am
->
¢dv¬
->
Ú_ackq
) {

1118 
	`SQ_LOCK
(&
mtı
->
ùx
->
ackq_lock
);

1119 
cur_¡»am
->
¢dv¬
->
Ú_ackq
 = 
TRUE
;

1120 
	`SŒ—mEnqueue
(
mtı
->
ackq
, 
cur_¡»am
);

1121 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
ackq_lock
);

1122 
cur_¡»am
->
Ãed_wnd_adv
 = 
FALSE
;

1123 
mtı
->
wakeup_æag
 = 
TRUE
;

1128 
	`UNUSED
(
´ev_rcv_wnd
);

1129  
cİyËn
;

1130 
	}
}

1132 
ssize_t


1133 
	$mtı_»cv
(
mùx_t
 
mùx
, 
sockid
, *
buf
, 
size_t
 
Ën
, 
æags
)

1135 
mtı_mªag”_t
 
mtı
;

1136 
sock‘_m­_t
 
sock‘
;

1137 
tı_¡»am
 *
cur_¡»am
;

1138 
tı_»cv_v¬s
 *
rcvv¬
;

1139 
ev’t_»maššg
;

1140 
»t
;

1142 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

1143 ià(!
mtı
) {

1147 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

1148 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

1149 
”ºo
 = 
EBADF
;

1153 
sock‘
 = &
mtı
->
sm­
[
sockid
];

1154 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

1155 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

1156 
”ºo
 = 
EBADF
;

1160 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_PIPE
) {

1161  
	`PeR—d
(
mùx
, 
sockid
, 
buf
, 
Ën
);

1164 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

1165 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

1166 
”ºo
 = 
ENOTSOCK
;

1171 
cur_¡»am
 = 
sock‘
->
¡»am
;

1172 ià(!
cur_¡»am
 ||

1173 !(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
 &&

1174 
cur_¡»am
->
¡©e
 <ğ
TCP_ST_CLOSE_WAIT
)) {

1175 
”ºo
 = 
ENOTCONN
;

1179 
rcvv¬
 = 
cur_¡»am
->rcvvar;

1182 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

1183 ià(!
rcvv¬
->
rcvbuf
)

1186 ià(
rcvv¬
->
rcvbuf
->
m”ged_Ën
 == 0)

1191 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

1192 ià(!
rcvv¬
->
rcvbuf
 ||„cvv¬->rcvbuf->
m”ged_Ën
 == 0) {

1193 
”ºo
 = 
EAGAIN
;

1198 
	`SBUF_LOCK
(&
rcvv¬
->
»ad_lock
);

1199 #ià
BLOCKING_SUPPORT


1200 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1201 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 == 0) {

1202 ià(!
cur_¡»am
 || cur_¡»am->
¡©e
 !ğ
TCP_ST_ESTABLISHED
) {

1203 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

1204 
”ºo
 = 
EINTR
;

1207 
	`±h»ad_cÚd_wa™
(&
rcvv¬
->
»ad_cÚd
, &rcvv¬->
»ad_lock
);

1212 
æags
) {

1214 
»t
 = 
	`CİyToU£r
(
mtı
, 
cur_¡»am
, 
buf
, 
Ën
);

1216 
MSG_PEEK
:

1217 
»t
 = 
	`P“kFÜU£r
(
mtı
, 
cur_¡»am
, 
buf
, 
Ën
);

1220 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

1221 
»t
 = -1;

1222 
”ºo
 = 
EINVAL
;

1223  
»t
;

1226 
ev’t_»maššg
 = 
FALSE
;

1229 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

1230 ià(!(
sock‘
->
•Şl
 & 
MTCP_EPOLLET
è&& 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 > 0) {

1231 
ev’t_»maššg
 = 
TRUE
;

1235 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 &&

1236 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 =ğ0 && 
»t
 > 0) {

1237 
ev’t_»maššg
 = 
TRUE
;

1240 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

1242 ià(
ev’t_»maššg
) {

1243 ià(
sock‘
->
•Şl
) {

1244 
	`AddEpŞlEv’t
(
mtı
->
•
,

1245 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

1246 #ià
BLOCKING_SUPPORT


1247 } ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1248 ià(!
cur_¡»am
->
Ú_rcv_br_li¡
) {

1249 
cur_¡»am
->
Ú_rcv_br_li¡
 = 
TRUE
;

1250 
	`TAILQ_INSERT_TAIL
(&
mtı
->
rcv_br_li¡
,

1251 
cur_¡»am
, 
rcvv¬
->
rcv_br_lšk
);

1252 
mtı
->
rcv_br_li¡_út
++;

1258 
	`TRACE_API
("SŒ—m %d: mtı_»cv(è»tuºšg %d\n", 
cur_¡»am
->
id
, 
»t
);

1259  
»t
;

1260 
	}
}

1262 
ssize_t


1263 
	$mtı_»ad
(
mùx_t
 
mùx
, 
sockid
, *
buf
, 
size_t
 
Ën
)

1265  
	`mtı_»cv
(
mùx
, 
sockid
, 
buf
, 
Ën
, 0);

1266 
	}
}

1269 
	$mtı_»adv
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ 
iovec
 *
iov
, 
numIOV
)

1271 
mtı_mªag”_t
 
mtı
;

1272 
sock‘_m­_t
 
sock‘
;

1273 
tı_¡»am
 *
cur_¡»am
;

1274 
tı_»cv_v¬s
 *
rcvv¬
;

1275 
»t
, 
by‹s_»ad
, 
i
;

1276 
ev’t_»maššg
;

1278 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

1279 ià(!
mtı
) {

1283 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

1284 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

1285 
”ºo
 = 
EBADF
;

1289 
sock‘
 = &
mtı
->
sm­
[
sockid
];

1290 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

1291 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

1292 
”ºo
 = 
EBADF
;

1296 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

1297 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

1298 
”ºo
 = 
ENOTSOCK
;

1303 
cur_¡»am
 = 
sock‘
->
¡»am
;

1304 ià(!
cur_¡»am
 ||

1305 !(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
 &&

1306 
cur_¡»am
->
¡©e
 <ğ
TCP_ST_CLOSE_WAIT
)) {

1307 
”ºo
 = 
ENOTCONN
;

1311 
rcvv¬
 = 
cur_¡»am
->rcvvar;

1314 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

1315 ià(!
rcvv¬
->
rcvbuf
)

1318 ià(
rcvv¬
->
rcvbuf
->
m”ged_Ën
 == 0)

1323 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

1324 ià(!
rcvv¬
->
rcvbuf
 ||„cvv¬->rcvbuf->
m”ged_Ën
 == 0) {

1325 
”ºo
 = 
EAGAIN
;

1330 
	`SBUF_LOCK
(&
rcvv¬
->
»ad_lock
);

1331 #ià
BLOCKING_SUPPORT


1332 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1333 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 == 0) {

1334 ià(!
cur_¡»am
 || cur_¡»am->
¡©e
 !ğ
TCP_ST_ESTABLISHED
) {

1335 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

1336 
”ºo
 = 
EINTR
;

1339 
	`±h»ad_cÚd_wa™
(&
rcvv¬
->
»ad_cÚd
, &rcvv¬->
»ad_lock
);

1345 
by‹s_»ad
 = 0;

1346 
i
 = 0; i < 
numIOV
; i++) {

1347 ià(
iov
[
i
].
iov_Ën
 <= 0)

1350 
»t
 = 
	`CİyToU£r
(
mtı
, 
cur_¡»am
, 
iov
[
i
].
iov_ba£
, iov[i].
iov_Ën
);

1351 ià(
»t
 <= 0)

1354 
by‹s_»ad
 +ğ
»t
;

1356 ià(
»t
 < 
iov
[
i
].
iov_Ën
)

1360 
ev’t_»maššg
 = 
FALSE
;

1363 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

1364 ià(!(
sock‘
->
•Şl
 & 
MTCP_EPOLLET
è&& 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 > 0) {

1365 
ev’t_»maššg
 = 
TRUE
;

1369 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 &&

1370 
rcvv¬
->
rcvbuf
->
m”ged_Ën
 =ğ0 && 
by‹s_»ad
 > 0) {

1371 
ev’t_»maššg
 = 
TRUE
;

1374 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

1376 if(
ev’t_»maššg
) {

1377 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
 && !(sock‘->•ŞÈ& 
MTCP_EPOLLET
)) {

1378 
	`AddEpŞlEv’t
(
mtı
->
•
,

1379 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

1380 #ià
BLOCKING_SUPPORT


1381 } ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1382 ià(!
cur_¡»am
->
Ú_rcv_br_li¡
) {

1383 
cur_¡»am
->
Ú_rcv_br_li¡
 = 
TRUE
;

1384 
	`TAILQ_INSERT_TAIL
(&
mtı
->
rcv_br_li¡
,

1385 
cur_¡»am
, 
rcvv¬
->
rcv_br_lšk
);

1386 
mtı
->
rcv_br_li¡_út
++;

1392 
	`TRACE_API
("Stream %d: mtcp_readv()„eturning %d\n",

1393 
cur_¡»am
->
id
, 
by‹s_»ad
);

1394  
by‹s_»ad
;

1395 
	}
}

1397 
šlše
 

1398 
	$CİyFromU£r
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, cÚ¡ *
buf
, 
Ën
)

1400 
tı_£nd_v¬s
 *
¢dv¬
 = 
cur_¡»am
->sndvar;

1401 
¢dËn
;

1402 
»t
;

1404 
¢dËn
 = 
	`MIN
(()
¢dv¬
->
¢d_wnd
, 
Ën
);

1405 ià(
¢dËn
 <= 0) {

1406 
”ºo
 = 
EAGAIN
;

1411 ià(!
¢dv¬
->
¢dbuf
) {

1412 
¢dv¬
->
¢dbuf
 = 
	`SBIn™
(
mtı
->
rbm_¢d
, sndv¬->
iss
 + 1);

1413 ià(!
¢dv¬
->
¢dbuf
) {

1414 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_NO_MEM
;

1416 
”ºo
 = 
ENOMEM
;

1421 
»t
 = 
	`SBPut
(
mtı
->
rbm_¢d
, 
¢dv¬
->
¢dbuf
, 
buf
, 
¢dËn
);

1422 
	`as£¹
(
»t
 =ğ
¢dËn
);

1423 
¢dv¬
->
¢d_wnd
 = sndv¬->
¢dbuf
->
size
 - sndv¬->¢dbuf->
Ën
;

1424 ià(
»t
 <= 0) {

1425 
	`TRACE_ERROR
("SBPut failed.„eason: %d (sndlen: %u,†en: %u\n",

1426 
»t
, 
¢dËn
, 
¢dv¬
->
¢dbuf
->
Ën
);

1427 
”ºo
 = 
EAGAIN
;

1431 ià(
¢dv¬
->
¢d_wnd
 <= 0) {

1432 
	`TRACE_SNDBUF
("%u Sending buffer became full!! snd_wnd: %u\n",

1433 
cur_¡»am
->
id
, 
¢dv¬
->
¢d_wnd
);

1436  
»t
;

1437 
	}
}

1439 
ssize_t


1440 
	$mtı_wr™e
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ *
buf
, 
size_t
 
Ën
)

1442 
mtı_mªag”_t
 
mtı
;

1443 
sock‘_m­_t
 
sock‘
;

1444 
tı_¡»am
 *
cur_¡»am
;

1445 
tı_£nd_v¬s
 *
¢dv¬
;

1446 
»t
;

1448 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

1449 ià(!
mtı
) {

1453 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

1454 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

1455 
”ºo
 = 
EBADF
;

1459 
sock‘
 = &
mtı
->
sm­
[
sockid
];

1460 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

1461 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

1462 
”ºo
 = 
EBADF
;

1466 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_PIPE
) {

1467  
	`PeWr™e
(
mùx
, 
sockid
, 
buf
, 
Ën
);

1470 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

1471 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

1472 
”ºo
 = 
ENOTSOCK
;

1476 
cur_¡»am
 = 
sock‘
->
¡»am
;

1477 ià(!
cur_¡»am
 ||

1478 !(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
 ||

1479 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
)) {

1480 
”ºo
 = 
ENOTCONN
;

1484 ià(
Ën
 <= 0) {

1485 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

1486 
”ºo
 = 
EAGAIN
;

1493 
¢dv¬
 = 
cur_¡»am
->sndvar;

1495 
	`SBUF_LOCK
(&
¢dv¬
->
wr™e_lock
);

1496 #ià
BLOCKING_SUPPORT


1497 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1498 
¢dv¬
->
¢d_wnd
 <= 0) {

1499 
	`TRACE_SNDBUF
("Waiting for‡vailable sending window...\n");

1500 ià(!
cur_¡»am
 || cur_¡»am->
¡©e
 !ğ
TCP_ST_ESTABLISHED
) {

1501 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

1502 
”ºo
 = 
EINTR
;

1505 
	`±h»ad_cÚd_wa™
(&
¢dv¬
->
wr™e_cÚd
, &¢dv¬->
wr™e_lock
);

1506 
	`TRACE_SNDBUF
("Sending buffer became„eady! snd_wnd: %u\n",

1507 
¢dv¬
->
¢d_wnd
);

1512 
»t
 = 
	`CİyFromU£r
(
mtı
, 
cur_¡»am
, 
buf
, 
Ën
);

1514 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

1516 ià(
»t
 > 0 && !(
¢dv¬
->
Ú_£ndq
 || sndv¬->
Ú_£nd_li¡
)) {

1517 
	`SQ_LOCK
(&
mtı
->
ùx
->
£ndq_lock
);

1518 
¢dv¬
->
Ú_£ndq
 = 
TRUE
;

1519 
	`SŒ—mEnqueue
(
mtı
->
£ndq
, 
cur_¡»am
);

1520 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
£ndq_lock
);

1521 
mtı
->
wakeup_æag
 = 
TRUE
;

1524 ià(
»t
 =ğ0 && (
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1525 
»t
 = -1;

1526 
”ºo
 = 
EAGAIN
;

1530 ià(
¢dv¬
->
¢d_wnd
 > 0) {

1531 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
 && !(sock‘->•ŞÈ& 
MTCP_EPOLLET
)) {

1532 
	`AddEpŞlEv’t
(
mtı
->
•
,

1533 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLOUT
);

1534 #ià
BLOCKING_SUPPORT


1535 } ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1536 ià(!
cur_¡»am
->
Ú_¢d_br_li¡
) {

1537 
cur_¡»am
->
Ú_¢d_br_li¡
 = 
TRUE
;

1538 
	`TAILQ_INSERT_TAIL
(&
mtı
->
¢d_br_li¡
,

1539 
cur_¡»am
, 
¢dv¬
->
¢d_br_lšk
);

1540 
mtı
->
¢d_br_li¡_út
++;

1546 
	`TRACE_API
("SŒ—m %d: mtı_wr™e(è»tuºšg %d\n", 
cur_¡»am
->
id
, 
»t
);

1547  
»t
;

1548 
	}
}

1551 
	$mtı_wr™ev
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ 
iovec
 *
iov
, 
numIOV
)

1553 
mtı_mªag”_t
 
mtı
;

1554 
sock‘_m­_t
 
sock‘
;

1555 
tı_¡»am
 *
cur_¡»am
;

1556 
tı_£nd_v¬s
 *
¢dv¬
;

1557 
»t
, 
to_wr™e
, 
i
;

1559 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

1560 ià(!
mtı
) {

1564 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

1565 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

1566 
”ºo
 = 
EBADF
;

1570 
sock‘
 = &
mtı
->
sm­
[
sockid
];

1571 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

1572 
	`TRACE_API
("Inv®id sock‘ id: %d\n", 
sockid
);

1573 
”ºo
 = 
EBADF
;

1577 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_STREAM
) {

1578 
	`TRACE_API
("NÙ‡À’d sock‘. id: %d\n", 
sockid
);

1579 
”ºo
 = 
ENOTSOCK
;

1583 
cur_¡»am
 = 
sock‘
->
¡»am
;

1584 ià(!
cur_¡»am
 ||

1585 !(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
 ||

1586 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
)) {

1587 
”ºo
 = 
ENOTCONN
;

1591 
¢dv¬
 = 
cur_¡»am
->sndvar;

1592 
	`SBUF_LOCK
(&
¢dv¬
->
wr™e_lock
);

1593 #ià
BLOCKING_SUPPORT


1594 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1595 
¢dv¬
->
¢d_wnd
 <= 0) {

1596 
	`TRACE_SNDBUF
("Waiting for‡vailable sending window...\n");

1597 ià(!
cur_¡»am
 || cur_¡»am->
¡©e
 !ğ
TCP_ST_ESTABLISHED
) {

1598 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

1599 
”ºo
 = 
EINTR
;

1602 
	`±h»ad_cÚd_wa™
(&
¢dv¬
->
wr™e_cÚd
, &¢dv¬->
wr™e_lock
);

1603 
	`TRACE_SNDBUF
("Sending buffer became„eady! snd_wnd: %u\n",

1604 
¢dv¬
->
¢d_wnd
);

1610 
to_wr™e
 = 0;

1611 
i
 = 0; i < 
numIOV
; i++) {

1612 ià(
iov
[
i
].
iov_Ën
 <= 0)

1615 
»t
 = 
	`CİyFromU£r
(
mtı
, 
cur_¡»am
, 
iov
[
i
].
iov_ba£
, iov[i].
iov_Ën
);

1616 ià(
»t
 <= 0)

1619 
to_wr™e
 +ğ
»t
;

1621 ià(
»t
 < 
iov
[
i
].
iov_Ën
)

1624 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

1626 ià(
to_wr™e
 > 0 && !(
¢dv¬
->
Ú_£ndq
 || sndv¬->
Ú_£nd_li¡
)) {

1627 
	`SQ_LOCK
(&
mtı
->
ùx
->
£ndq_lock
);

1628 
¢dv¬
->
Ú_£ndq
 = 
TRUE
;

1629 
	`SŒ—mEnqueue
(
mtı
->
£ndq
, 
cur_¡»am
);

1630 
	`SQ_UNLOCK
(&
mtı
->
ùx
->
£ndq_lock
);

1631 
mtı
->
wakeup_æag
 = 
TRUE
;

1634 ià(
to_wr™e
 =ğ0 && (
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1635 
to_wr™e
 = -1;

1636 
”ºo
 = 
EAGAIN
;

1640 ià(
¢dv¬
->
¢d_wnd
 > 0) {

1641 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
 && !(sock‘->•ŞÈ& 
MTCP_EPOLLET
)) {

1642 
	`AddEpŞlEv’t
(
mtı
->
•
,

1643 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLOUT
);

1644 #ià
BLOCKING_SUPPORT


1645 } ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

1646 ià(!
cur_¡»am
->
Ú_¢d_br_li¡
) {

1647 
cur_¡»am
->
Ú_¢d_br_li¡
 = 
TRUE
;

1648 
	`TAILQ_INSERT_TAIL
(&
mtı
->
¢d_br_li¡
,

1649 
cur_¡»am
, 
¢dv¬
->
¢d_br_lšk
);

1650 
mtı
->
¢d_br_li¡_út
++;

1656 
	`TRACE_API
("Stream %d: mtcp_writev()„eturning %d\n",

1657 
cur_¡»am
->
id
, 
to_wr™e
);

1658  
to_wr™e
;

1659 
	}
}

	@arp.cpp

1 
	~<¡dšt.h
>

2 
	~<sys/ty³s.h
>

4 
	~"mtı.h
"

5 
	~"¬p.h
"

6 
	~"‘h_out.h
"

7 
	~"debug.h
"

9 
	#ARP_PAD_LEN
 18

	)

10 
	#ARP_TIMEOUT_SEC
 1

	)

13 
	e¬p_hrd_fÜm©


15 
	m¬p_hrd_‘h”Ãt
 = 1

18 
	e¬p_İcode


20 
	m¬p_İ_»que¡
 = 1,

21 
	m¬p_İ_»¶y
 = 2,

24 
	s¬phdr


26 
ušt16_t
 
	m¬_hrd
;

27 
ušt16_t
 
	m¬_´o
;

28 
ušt8_t
 
	m¬_hÊ
;

29 
ušt8_t
 
	m¬_¶n
;

30 
ušt16_t
 
	m¬_İ
;

32 
ušt8_t
 
	m¬_sha
[
ETH_ALEN
];

33 
ušt32_t
 
	m¬_s
;

34 
ušt8_t
 
	m¬_tha
[
ETH_ALEN
];

35 
ušt32_t
 
	m¬_t
;

37 
ušt8_t
 
	m·d
[
ARP_PAD_LEN
];

38 } 
__©Œibu‹__
 ((
·cked
));

40 
	s¬p_queue_’Œy


42 
ušt32_t
 
	m
;

43 
	mnif_out
;

44 
ušt32_t
 
	mts_out
;

46 
TAILQ_ENTRY
(
¬p_queue_’Œy
è
	m¬p_lšk
;

49 
	s¬p_mªag”


51 
TAILQ_HEAD
 (, 
¬p_queue_’Œy
è
	mli¡
;

52 
±h»ad_mu‹x_t
 
	mlock
;

55 
¬p_mªag”
 
	gg_¬pm
;

58 
DumpARPPack‘
(
¬phdr
 *
¬ph
);

61 
	$In™ARPTabË
()

63 
CONFIG
.
¬p
.
’Œ›s
 = 0;

65 
CONFIG
.
¬p
.
’Œy
 = (
¬p_’Œy
 *)

66 
	`ÿÎoc
(
MAX_ARPENTRY
, (
¬p_’Œy
));

67 ià(
CONFIG
.
¬p
.
’Œy
 =ğ
NULL
) {

68 
	`³¼Ü
("calloc");

72 
	`TAILQ_INIT
(&
g_¬pm
.
li¡
);

73 
	`±h»ad_mu‹x_š™
(&
g_¬pm
.
lock
, 
NULL
);

76 
	}
}

79 
	$G‘HWaddr
(
ušt32_t
 

)

81 
i
;

82 *
haddr
 = 
NULL
;

83 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

84 ià(

 =ğ
CONFIG
.
‘hs
[
i
].
_addr
) {

85 
haddr
 = 
CONFIG
.
‘hs
[
i
].haddr;

90  
haddr
;

91 
	}
}

94 
	$G‘De¡š©iÚHWaddr
(
ušt32_t
 
d
)

96 *
d_haddr
 = 
NULL
;

97 
´efix
 = 0;

98 
i
;

101 
i
 = 0; i < 
CONFIG
.
¬p
.
’Œ›s
; i++) {

102 ià(
CONFIG
.
¬p
.
’Œy
[
i
].
´efix
 == 1) {

103 ià(
CONFIG
.
¬p
.
’Œy
[
i
].

 =ğ
d
) {

104 
d_haddr
 = 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
;

108 ià((
d
 & 
CONFIG
.
¬p
.
’Œy
[
i
].
_mask
) ==

109 
CONFIG
.
¬p
.
’Œy
[
i
].
_masked
) {

111 ià(
CONFIG
.
¬p
.
’Œy
[
i
].
´efix
 >…refix) {

112 
d_haddr
 = 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
;

113 
´efix
 = 
CONFIG
.
¬p
.
’Œy
[
i
].prefix;

119  
d_haddr
;

120 
	}
}

123 
	$ARPOuut
(
mtı_mªag”
 *
mtı
, 
nif
, 
İcode
,

124 
ušt32_t
 
d¡_
, *
d¡_haddr
, *
rg‘_haddr
)

126 ià(!
d¡_haddr
)

130 
¬phdr
 *
¬ph
 = (¬phd¸*)
	`Eth”ÃtOuut
(
mtı
,

131 
ETH_P_ARP
, 
nif
, 
d¡_haddr
, (
¬phdr
));

132 ià(!
¬ph
) {

136 
¬ph
->
¬_hrd
 = 
	`htÚs
(
¬p_hrd_‘h”Ãt
);

137 
¬ph
->
¬_´o
 = 
	`htÚs
(
ETH_P_IP
);

138 
¬ph
->
¬_hÊ
 = 
ETH_ALEN
;

139 
¬ph
->
¬_¶n
 = 4;

140 
¬ph
->
¬_İ
 = 
	`htÚs
(
İcode
);

143 
¬ph
->
¬_s
 = 
CONFIG
.
‘hs
[
nif
].
_addr
;

144 
¬ph
->
¬_t
 = 
d¡_
;

146 
	`memıy
(
¬ph
->
¬_sha
, 
CONFIG
.
‘hs
[
nif
].
haddr
,‡½h->
¬_hÊ
);

147 ià(
rg‘_haddr
) {

148 
	`memıy
(
¬ph
->
¬_tha
, 
rg‘_haddr
,‡½h->
¬_hÊ
);

150 
	`memıy
(
¬ph
->
¬_tha
, 
d¡_haddr
,‡½h->
¬_hÊ
);

152 
	`mem£t
(
¬ph
->
·d
, 0, 
ARP_PAD_LEN
);

154 #ià
DBGMSG


155 
	`DumpARPPack‘
(
¬ph
);

159 
	}
}

162 
	$Regi¡”ARPEÁry
(
ušt32_t
 

, cÚ¡ *
haddr
)

164 
idx
 = 
CONFIG
.
¬p
.
’Œ›s
;

166 
CONFIG
.
¬p
.
’Œy
[
idx
].
´efix
 = 32;

167 
CONFIG
.
¬p
.
’Œy
[
idx
].

 = ip;

168 
	`memıy
(
CONFIG
.
¬p
.
’Œy
[
idx
].
haddr
, haddr, 
ETH_ALEN
);

169 
CONFIG
.
¬p
.
’Œy
[
idx
].
_mask
 = -1;

170 
CONFIG
.
¬p
.
’Œy
[
idx
].
_masked
 = 

;

172 
CONFIG
.
¬p
.
’Œ›s
 = 
idx
 + 1;

174 
	`TRACE_CONFIG
("Learned‚ew‡rpƒntry.\n");

175 
	`PrštARPTabË
();

178 
	}
}

181 
	$Reque¡ARP
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 

, 
nif
, ušt32_ˆ
cur_ts
)

183 
¬p_queue_’Œy
 *
’t
;

184 
haddr
[
ETH_ALEN
];

185 
ddr
[
ETH_ALEN
];

187 
	`±h»ad_mu‹x_lock
(&
g_¬pm
.
lock
);

189 
	`TAILQ_FOREACH
(
’t
, &
g_¬pm
.
li¡
, 
¬p_lšk
) {

190 ià(
’t
->

 == ip) {

191 
	`±h»ad_mu‹x_uÆock
(&
g_¬pm
.
lock
);

196 
’t
 = (
¬p_queue_’Œy
 *)
	`ÿÎoc
(1, (arp_queue_entry));

197 
’t
->

 = ip;

198 
’t
->
nif_out
 = 
nif
;

199 
’t
->
ts_out
 = 
cur_ts
;

200 
	`TAILQ_INSERT_TAIL
(&
g_¬pm
.
li¡
, 
’t
, 
¬p_lšk
);

201 
	`±h»ad_mu‹x_uÆock
(&
g_¬pm
.
lock
);

204 
	`mem£t
(
haddr
, 0xFF, 
ETH_ALEN
);

205 
	`mem£t
(
ddr
, 0x00, 
ETH_ALEN
);

206 
	`ARPOuut
(
mtı
, 
nif
, 
¬p_İ_»que¡
, 

, 
haddr
, 
ddr
);

207 
	}
}

210 
	$ProûssARPReque¡
(
mtı_mªag”_t
 
mtı
,

211 
¬phdr
 *
¬ph
, 
nif
, 
ušt32_t
 
cur_ts
)

213 *
‹mp
;

216 
‹mp
 = 
	`G‘De¡š©iÚHWaddr
(
¬ph
->
¬_s
);

217 ià(!
‹mp
) {

218 
	`Regi¡”ARPEÁry
(
¬ph
->
¬_s
,‡½h->
¬_sha
);

222 
	`ARPOuut
(
mtı
, 
nif
, 
¬p_İ_»¶y
, 
¬ph
->
¬_s
,‡½h->
¬_sha
, 
NULL
);

225 
	}
}

228 
	$ProûssARPR•ly
(
mtı_mªag”_t
 
mtı
, 
¬phdr
 *
¬ph
, 
ušt32_t
 
cur_ts
)

230 *
‹mp
;

231 
¬p_queue_’Œy
 *
’t
;

234 
‹mp
 = 
	`G‘De¡š©iÚHWaddr
(
¬ph
->
¬_s
);

235 ià(!
‹mp
) {

236 
	`Regi¡”ARPEÁry
(
¬ph
->
¬_s
,‡½h->
¬_sha
);

240 
	`±h»ad_mu‹x_lock
(&
g_¬pm
.
lock
);

241 
	`TAILQ_FOREACH
(
’t
, &
g_¬pm
.
li¡
, 
¬p_lšk
) {

242 ià(
’t
->

 =ğ
¬ph
->
¬_s
) {

243 
	`TAILQ_REMOVE
(&
g_¬pm
.
li¡
, 
’t
, 
¬p_lšk
);

244 
	`ä“
(
’t
);

248 
	`±h»ad_mu‹x_uÆock
(&
g_¬pm
.
lock
);

251 
	}
}

254 
	$ProûssARPPack‘
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

255 cÚ¡ 
ifidx
, *
pkt_d©a
, 
Ën
)

257 
¬phdr
 *
¬ph
 = (¬phd¸*)(
pkt_d©a
 + (
‘hhdr
));

258 
i
;

259 
to_me
 = 
FALSE
;

262 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

263 ià(
¬ph
->
¬_t
 =ğ
CONFIG
.
‘hs
[
i
].
_addr
) {

264 
to_me
 = 
TRUE
;

268 ià(!
to_me
)

269  
TRUE
;

271 #ià
DBGMSG


272 
	`DumpARPPack‘
(
¬ph
);

275 
	`Áohs
(
¬ph
->
¬_İ
)) {

276 
¬p_İ_»que¡
:

277 
	`ProûssARPReque¡
(
mtı
, 
¬ph
, 
ifidx
, 
cur_ts
);

280 
¬p_İ_»¶y
:

281 
	`ProûssARPR•ly
(
mtı
, 
¬ph
, 
cur_ts
);

288  
TRUE
;

289 
	}
}

295 
	$ARPTim”
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
)

297 
¬p_queue_’Œy
 *
’t
;

300 
	`±h»ad_mu‹x_lock
(&
g_¬pm
.
lock
);

301 
	`TAILQ_FOREACH
(
’t
, &
g_¬pm
.
li¡
, 
¬p_lšk
) {

302 ià(
	`TCP_SEQ_GT
(
cur_ts
, 
’t
->
ts_out
 + 
	`SEC_TO_TS
(
ARP_TIMEOUT_SEC
))) {

303 
	`TRACE_INFO
("[CPU%2d] ARP„equestimed out.\n",

304 
mtı
->
ùx
->
ıu
);

305 
	`TAILQ_REMOVE
(&
g_¬pm
.
li¡
, 
’t
, 
¬p_lšk
);

306 
	`ä“
(
’t
);

309 
	`±h»ad_mu‹x_uÆock
(&
g_¬pm
.
lock
);

310 
	}
}

313 
	$PrštARPTabË
()

315 
i
;

318 
	`TRACE_CONFIG
("ARP Table:\n");

319 
i
 = 0; i < 
CONFIG
.
¬p
.
’Œ›s
; i++) {

321 
ušt8_t
 *
da
 = (ušt8_ˆ*)&
CONFIG
.
¬p
.
’Œy
[
i
].

;

323 
	`TRACE_CONFIG
("IP‡ddr: %u.%u.%u.%u, "

325 
da
[0], da[1], da[2], da[3],

326 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[0],

327 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[1],

328 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[2],

329 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[3],

330 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[4],

331 
CONFIG
.
¬p
.
’Œy
[
i
].
haddr
[5]);

333 ià(
CONFIG
.
¬p
.
’Œ›s
 == 0)

334 
	`TRACE_CONFIG
("(blank)\n");

336 
	`TRACE_CONFIG
("----------------------------------------------------------"

338 
	}
}

341 
	$DumpARPPack‘
(
¬phdr
 *
¬ph
)

343 
ušt8_t
 *
t
;

345 
	`årštf
(
¡d”r
, "ARP header: \n");

346 
	`årštf
(
¡d”r
, "Hardwareype: %d (len: %d), "

348 
	`Áohs
(
¬ph
->
¬_hrd
),‡½h->
¬_hÊ
,

349 
	`Áohs
(
¬ph
->
¬_´o
),‡½h->
¬_¶n
,‚tohs×½h->
¬_İ
));

350 
t
 = (
ušt8_t
 *)&
¬ph
->
¬_s
;

351 
	`årštf
(
¡d”r
, "Sender IP: %u.%u.%u.%u, "

353 
t
[0],[1],[2],[3],

354 
¬ph
->
¬_sha
[0],‡rph->ar_sha[1],‡rph->ar_sha[2],

355 
¬ph
->
¬_sha
[3],‡rph->ar_sha[4],‡rph->ar_sha[5]);

356 
t
 = (
ušt8_t
 *)&
¬ph
->
¬_t
;

357 
	`årštf
(
¡d”r
, "Target IP: %u.%u.%u.%u, "

359 
t
[0],[1],[2],[3],

360 
¬ph
->
¬_tha
[0],‡rph->ar_tha[1],‡rph->ar_tha[2],

361 
¬ph
->
¬_tha
[3],‡rph->ar_tha[4],‡rph->ar_tha[5]);

362 
	}
}

	@config.cpp

1 
	~<¡dlib.h
>

2 
	~<as£¹.h
>

3 
	~<sys/sock‘.h
>

4 
	~<sys/ioùl.h
>

5 
	~<Ãt/if.h
>

6 
	~<¬·/š‘.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtdb.h
>

9 
	~<¡dio.h
>

10 
	~<uni¡d.h
>

11 
	~<ùy³.h
>

13 
	~"mtı.h
"

14 
	~"cÚfig.h
"

15 
	~"tı_š.h
"

16 
	~"¬p.h
"

17 
	~"debug.h
"

19 
	~"io_moduË.h
"

21 
	~<Ãt/if.h
>

23 
	#MAX_OPTLINE_LEN
 1024

	)

24 
	#ALL_STRING
 "®l"

	)

26 
	gnum_ıus
;

27 
	gnum_queues
;

28 
	gnum_deviûs
;

30 
	gnum_deviûs_©ched
;

31 
	gdeviûs_©ched
[
MAX_DEVICES
];

33 cÚ¡ *
	grou‹_fe
 = "config/route.conf";

34 cÚ¡ *
	g¬p_fe
 = "config/arp.conf";

35 
mtı_mªag”
 *
	gg_mtı
[
MAX_CPUS
] = {
NULL
};

36 
mtı_cÚfig
 
	gCONFIG
 = {0};

37 
addr_poŞ_t
 
	g­
[
ETH_NUM
] = {
NULL
};

41 
	$G‘IÁV®ue
(* 
v®ue
)

43 
»t
 = 0;

44 
»t
 = 
	`¡¹Ş
(
v®ue
, (**)
NULL
, 10);

45 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

47  
»t
;

48 
	}
}

50 
šlše
 
ušt32_t


51 
	$MaskFromP»fix
(
´efix
)

53 
ušt32_t
 
mask
 = 0;

54 
ušt8_t
 *
mask_t
 = (ušt8_ˆ*)&
mask
;

55 
i
, 
j
;

57 
i
 = 0; i <ğ
´efix
 / 8 && i < 4; i++) {

58 
j
 = 0; j < (
´efix
 - 
i
 * 8) && j < 8; j++) {

59 
mask_t
[
i
] |ğ(1 << (7 - 
j
));

63  
mask
;

64 
	}
}

67 
	$EÄŞlRou‹TabËEÁry
(*
İt¡r
)

69 *
daddr_s
;

70 *
´efix
;

71 *
dev
;

72 
ifidx
;

73 
ridx
;

74 
i
;

75 * 
§v•Œ
;

77 
daddr_s
 = 
	`¡¹ok_r
(
İt¡r
, "/", &
§v•Œ
);

78 
´efix
 = 
	`¡¹ok_r
(
NULL
, " ", &
§v•Œ
);

79 
dev
 = 
	`¡¹ok_r
(
NULL
, "\n", &
§v•Œ
);

81 
	`as£¹
(
daddr_s
 !ğ
NULL
);

82 
	`as£¹
(
´efix
 !ğ
NULL
);

83 
	`as£¹
(
dev
 !ğ
NULL
);

85 
ifidx
 = -1;

87 ià(
cu¼’t_iomoduË_func
 =ğ&
ps_moduË_func
) {

88 
i
 = 0; i < 
num_deviûs
; i++) {

89 ià(
	`¡rcmp
(
dev
, 
deviûs
[
i
].
Çme
) != 0)

92 
ifidx
 = 
deviûs
[
i
].
ifšdex
;

95 ià(
ifidx
 == -1) {

96 
	`TRACE_CONFIG
("IÁ”çû % dÛ nÙƒxi¡!\n", 
dev
);

97 
	`ex™
(4);

99 } ià(
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) {

100 
i
 = 0; i < 
num_deviûs
; i++) {

101 ià(
	`¡rcmp
(
CONFIG
.
‘hs
[
i
].
dev_Çme
, 
dev
))

103 
ifidx
 = 
CONFIG
.
‘hs
[
i
].
ifšdex
;

108 
ridx
 = 
CONFIG
.
rou‹s
++;

109 
CONFIG
.
¹abË
[
ridx
].
daddr
 = 
	`š‘_addr
(
daddr_s
);

110 
CONFIG
.
¹abË
[
ridx
].
´efix
 = 
	`©oi
(prefix);

111 ià(
CONFIG
.
¹abË
[
ridx
].
´efix
 > 32 || CONFIG.rtable[ridx].prefix < 0) {

112 
	`TRACE_CONFIG
("Prefix†ength should be between 0 - 32.\n");

113 
	`ex™
(4);

116 
CONFIG
.
¹abË
[
ridx
].
mask
 = 
	`MaskFromP»fix
(CONFIG.¹abË[ridx].
´efix
);

117 
CONFIG
.
¹abË
[
ridx
].
masked
 =

118 
CONFIG
.
¹abË
[
ridx
].
daddr
 & CONFIG.¹abË[ridx].
mask
;

119 
CONFIG
.
¹abË
[
ridx
].
nif
 = 
ifidx
;

120 
	}
}

123 
	$S‘RoutšgTabËFromFe
()

125 
	#ROUTES
 "ROUTES"

	)

127 
FILE
 *
fc
;

128 
İt¡r
[
MAX_OPTLINE_LEN
];

129 
i
;

131 
	`TRACE_CONFIG
("Lßdšg„outšg cÚfigu¿tiÚ äom : %s\n", 
rou‹_fe
);

133 
fc
 = 
	`fİ’
(
rou‹_fe
, "r");

134 ià(
fc
 =ğ
NULL
) {

135 
	`³¼Ü
("fopen");

136 
	`TRACE_CONFIG
("Skip†oading static„outingable\n");

141 *
iscomm’t
;

142 
num
;

144 ià(
	`fg‘s
(
İt¡r
, 
MAX_OPTLINE_LEN
, 
fc
è=ğ
NULL
)

148 
iscomm’t
 = 
	`¡rchr
(
İt¡r
, '#');

149 ià(
iscomm’t
 =ğ
İt¡r
)

151 ià(
iscomm’t
 !ğ
NULL
)

152 *
iscomm’t
 = 0;

154 ià(!
	`¡ºcmp
(
İt¡r
, 
ROUTES
, (ROUTES) - 1)) {

155 
num
 = 
	`G‘IÁV®ue
(
İt¡r
 + (
ROUTES
));

156 ià(
num
 <= 0)

159 
i
 = 0; i < 
num
; i++) {

160 ià(
	`fg‘s
(
İt¡r
, 
MAX_OPTLINE_LEN
, 
fc
è=ğ
NULL
)

163 ià(*
İt¡r
 == '#') {

164 
i
 -= 1;

167 
	`EÄŞlRou‹TabËEÁry
(
İt¡r
);

172 
	`fşo£
(
fc
);

174 
	}
}

177 
	$PrštRoutšgTabË
()

179 
i
;

180 
ušt8_t
 *
da
;

181 
ušt8_t
 *
m
;

182 
ušt8_t
 *
md
;

185 
	`TRACE_CONFIG
("Routes:\n");

186 
i
 = 0; i < 
CONFIG
.
rou‹s
; i++) {

187 
da
 = (
ušt8_t
 *)&
CONFIG
.
¹abË
[
i
].
daddr
;

188 
m
 = (
ušt8_t
 *)&
CONFIG
.
¹abË
[
i
].
mask
;

189 
md
 = (
ušt8_t
 *)&
CONFIG
.
¹abË
[
i
].
masked
;

190 
	`TRACE_CONFIG
("Destination: %u.%u.%u.%u/%d, Mask: %u.%u.%u.%u, "

192 
da
[0], da[1], da[2], da[3], 
CONFIG
.
¹abË
[
i
].
´efix
,

193 
m
[0], m[1], m[2], m[3], 
md
[0], md[1], md[2], md[3],

194 
CONFIG
.
¹abË
[
i
].
nif
);

196 ià(
CONFIG
.
rou‹s
 == 0)

197 
	`TRACE_CONFIG
("(blank)\n");

199 
	`TRACE_CONFIG
("----------------------------------------------------------"

201 
	}
}

204 
	$P¬£MACAdd»ss
(*
haddr
, *
haddr_¡r
)

206 
i
;

207 *
¡r
;

208 
‹mp
;

209 *
§v•Œ
 = 
NULL
;

211 
¡r
 = 
	`¡¹ok_r
(
haddr_¡r
, ":", &
§v•Œ
);

212 
i
 = 0;

213 
¡r
 !ğ
NULL
) {

214 ià(
i
 >ğ
ETH_ALEN
) {

215 
	`TRACE_CONFIG
("MAC‡dd»s Ëngthƒxûed %d!\n", 
ETH_ALEN
);

216 
	`ex™
(4);

218 
	`ssÿnf
(
¡r
, "%x", &
‹mp
);

219 
haddr
[
i
++] = 
‹mp
;

220 
¡r
 = 
	`¡¹ok_r
(
NULL
, ":", &
§v•Œ
);

222 ià(
i
 < 
ETH_ALEN
) {

223 
	`TRACE_CONFIG
("MAC‡dd»s Ëngth i Ës thª %d!\n", 
ETH_ALEN
);

224 
	`ex™
(4);

226 
	}
}

229 
	$P¬£IPAdd»ss
(
ušt32_t
 *
_addr
, *
_¡r
)

231 ià(
_¡r
 =ğ
NULL
) {

232 *
_addr
 = 0;

236 *
_addr
 = 
	`š‘_addr
(
_¡r
);

237 ià(*
_addr
 =ğ
INADDR_NONE
) {

238 
	`TRACE_CONFIG
("IP‡dd»s i nÙ v®id %s\n", 
_¡r
);

239 *
_addr
 = 0;

244 
	}
}

247 
	$S‘RoutšgTabË
()

249 
i
, 
ridx
;

250 
c
;

252 
CONFIG
.
rou‹s
 = 0;

253 
CONFIG
.
¹abË
 = (
rou‹_bË
 *)

254 
	`ÿÎoc
(
MAX_DEVICES
, (
rou‹_bË
));

255 ià(!
CONFIG
.
¹abË
)

256 
	`ex™
(
EXIT_FAILURE
);

259 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i ++) {

261 
ridx
 = 
CONFIG
.
rou‹s
++;

262 
CONFIG
.
¹abË
[
ridx
].
daddr
 = CONFIG.
‘hs
[
i
].
_addr
 & CONFIG.‘hs[i].
Ãtmask
;

264 
CONFIG
.
¹abË
[
ridx
].
´efix
 = 0;

265 
c
 = 
CONFIG
.
‘hs
[
i
].
Ãtmask
;

266 (
c
 = (c >> 1))){

267 
CONFIG
.
¹abË
[
ridx
].
´efix
++;

269 
CONFIG
.
¹abË
[
ridx
].
´efix
++;

271 
CONFIG
.
¹abË
[
ridx
].
mask
 = CONFIG.
‘hs
[
i
].
Ãtmask
;

272 
CONFIG
.
¹abË
[
ridx
].
masked
 = CONFIG.¹abË[ridx].
daddr
;

273 
CONFIG
.
¹abË
[
ridx
].
nif
 = CONFIG.
‘hs
[ridx].
ifšdex
;

277 
	`S‘RoutšgTabËFromFe
();

280 
	}
}

283 
	$PrštIÁ”çûInfo
()

285 
i
;

288 
	`TRACE_CONFIG
("Interfaces:\n");

289 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

291 
ušt8_t
 *
da
 = (ušt8_ˆ*)&
CONFIG
.
‘hs
[
i
].
_addr
;

292 
ušt8_t
 *
nm
 = (ušt8_ˆ*)&
CONFIG
.
‘hs
[
i
].
Ãtmask
;

294 
	`TRACE_CONFIG
("name: %s, ifindex: %d, "

298 
CONFIG
.
‘hs
[
i
].
dev_Çme
,

299 
CONFIG
.
‘hs
[
i
].
ifšdex
,

300 
CONFIG
.
‘hs
[
i
].
haddr
[0],

301 
CONFIG
.
‘hs
[
i
].
haddr
[1],

302 
CONFIG
.
‘hs
[
i
].
haddr
[2],

303 
CONFIG
.
‘hs
[
i
].
haddr
[3],

304 
CONFIG
.
‘hs
[
i
].
haddr
[4],

305 
CONFIG
.
‘hs
[
i
].
haddr
[5],

306 
da
[0], da[1], da[2], da[3],

307 
nm
[0],‚m[1],‚m[2],‚m[3]);

309 
	`TRACE_CONFIG
("Numb” oàNIC queues: %d\n", 
num_queues
);

310 
	`TRACE_CONFIG
("----------------------------------------------------------"

312 
	}
}

315 
	$EÄŞlARPTabËEÁry
(*
İt¡r
)

317 *
d_s
;

318 *
´efix_s
;

319 *
daddr_s
;

321 
´efix
;

322 
ušt32_t
 
d_mask
;

323 
idx
;

325 *
§v•Œ
;

327 
d_s
 = 
	`¡¹ok_r
(
İt¡r
, "/", &
§v•Œ
);

328 
´efix_s
 = 
	`¡¹ok_r
(
NULL
, " ", &
§v•Œ
);

329 
daddr_s
 = 
	`¡¹ok_r
(
NULL
, "\n", &
§v•Œ
);

331 
	`as£¹
(
d_s
 !ğ
NULL
);

332 
	`as£¹
(
´efix_s
 !ğ
NULL
);

333 
	`as£¹
(
daddr_s
 !ğ
NULL
);

335 ià(
´efix_s
 =ğ
NULL
)

336 
´efix
 = 32;

338 
´efix
 = 
	`©oi
(
´efix_s
);

340 ià(
´efix
 > 32 ||…refix < 0) {

341 
	`TRACE_CONFIG
("Prefix†ength should be between 0 - 32.\n");

345 
idx
 = 
CONFIG
.
¬p
.
’Œ›s
++;

346 
CONFIG
.
¬p
.
’Œy
[
idx
].
´efix
 =…refix;

347 
	`P¬£IPAdd»ss
(&
CONFIG
.
¬p
.
’Œy
[
idx
].

, 
d_s
);

348 
	`P¬£MACAdd»ss
(
CONFIG
.
¬p
.
’Œy
[
idx
].
haddr
, 
daddr_s
);

350 
d_mask
 = 
	`MaskFromP»fix
(
´efix
);

351 
CONFIG
.
¬p
.
’Œy
[
idx
].
_mask
 = 
d_mask
;

352 
CONFIG
.
¬p
.
’Œy
[
idx
].
_masked
 = CONFIG.¬p.’Œy[idx].

 & 
d_mask
;

365 
	}
}

443 
	$S‘MuÉiProûssSuµÜt
(*
muÉroûss_d‘as
)

445 *
tok’
 = " =";

446 *
§m¶e
;

447 *
§v•Œ
;

449 
	`TRACE_CONFIG
("Loading multi-process configuration\n");

451 
§m¶e
 = 
	`¡¹ok_r
(
muÉroûss_d‘as
, 
tok’
, &
§v•Œ
);

452 ià(
§m¶e
 =ğ
NULL
) {

453 
	`TRACE_CONFIG
("No option for multi-process support given!\n");

456 
CONFIG
.
muÉi_´oûss_cu¼_cÜe
 = 
	`©oi
(
§m¶e
);

458 
§m¶e
 = 
	`¡¹ok_r
(
NULL
, 
tok’
, &
§v•Œ
);

459 ià(
§m¶e
 !ğ
NULL
 && !
	`¡rcmp
(sample, "master"))

460 
CONFIG
.
muÉi_´oûss_is_ma¡”
 = 1;

463 
	}
}

466 
	$P¬£CÚfigu¿tiÚ
(*
lše
)

468 
İt¡r
[
MAX_OPTLINE_LEN
];

469 *
p
, *
q
;

471 *
§v•Œ
;

473 
	`¡ºıy
(
İt¡r
, 
lše
, 
MAX_OPTLINE_LEN
 - 1);

475 
p
 = 
	`¡¹ok_r
(
İt¡r
, " \t=", &
§v•Œ
);

476 ià(
p
 =ğ
NULL
) {

477 
	`TRACE_CONFIG
("NØİtiÚ‚amfound fÜhlše: %s\n", 
lše
);

481 
q
 = 
	`¡¹ok_r
(
NULL
, " \t=", &
§v•Œ
);

482 ià(
q
 =ğ
NULL
) {

483 
	`TRACE_CONFIG
("NØİtiÚ v®ufound fÜhlše: %s\n", 
lše
);

487 ià(
	`¡rcmp
(
p
, "num_cores") == 0) {

488 
CONFIG
.
num_cÜes
 = 
	`©oi
(
q
);

489 ià(
CONFIG
.
num_cÜes
 <= 0) {

490 
	`TRACE_CONFIG
("Number of cores should be†argerhan 0.\n");

493 ià(
CONFIG
.
num_cÜes
 > 
num_ıus
) {

494 
	`TRACE_CONFIG
("Number of cores should be smallerhan "

498 
num_ıus
 = 
CONFIG
.
num_cÜes
;

499 } ià(
	`¡rcmp
(
p
, "max_concurrency") == 0) {

500 
CONFIG
.
max_cÚcu¼’cy
 = 
	`©oi
(
q
);

501 ià(
CONFIG
.
max_cÚcu¼’cy
 < 0) {

502 
	`TRACE_CONFIG
("The maximum concurrency should be†argerhan 0.\n");

505 } ià(
	`¡rcmp
(
p
, "max_num_buffers") == 0) {

506 
CONFIG
.
max_num_bufãrs
 = 
	`©oi
(
q
);

507 ià(
CONFIG
.
max_num_bufãrs
 < 0) {

508 
	`TRACE_CONFIG
("The maximum # buffers should be†argerhan 0.\n");

511 } ià(
	`¡rcmp
(
p
, "rcvbuf") == 0) {

512 
CONFIG
.
rcvbuf_size
 = 
	`©oi
(
q
);

513 ià(
CONFIG
.
rcvbuf_size
 < 64) {

514 
	`TRACE_CONFIG
("Receive buffer size should be†argerhan 64.\n");

517 } ià(
	`¡rcmp
(
p
, "sndbuf") == 0) {

518 
CONFIG
.
¢dbuf_size
 = 
	`©oi
(
q
);

519 ià(
CONFIG
.
¢dbuf_size
 < 64) {

520 
	`TRACE_CONFIG
("Send buffer size should be†argerhan 64.\n");

523 } ià(
	`¡rcmp
(
p
, "tcp_timeout") == 0) {

524 
CONFIG
.
tı_timeout
 = 
	`©oi
(
q
);

525 ià(
CONFIG
.
tı_timeout
 > 0) {

526 
CONFIG
.
tı_timeout
 = 
	`SEC_TO_USEC
(CONFIG.tı_timeoutè/ 
TIME_TICK
;

528 } ià(
	`¡rcmp
(
p
, "tcp_timewait") == 0) {

529 
CONFIG
.
tı_timewa™
 = 
	`©oi
(
q
);

530 ià(
CONFIG
.
tı_timewa™
 > 0) {

531 
CONFIG
.
tı_timewa™
 = 
	`SEC_TO_USEC
(CONFIG.tı_timewa™è/ 
TIME_TICK
;

533 } ià(
	`¡rcmp
(
p
, "stat_print") == 0) {

534 
i
;

536 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

537 ià(
	`¡rcmp
(
CONFIG
.
‘hs
[
i
].
dev_Çme
, 
q
) == 0) {

538 
CONFIG
.
‘hs
[
i
].
¡©_´št
 = 
TRUE
;

541 } ià(
	`¡rcmp
(
p
, "port") == 0) {

542 if(
	`¡ºcmp
(
q
, 
ALL_STRING
, (ALL_STRING)) == 0) {

543 
	`S‘IÁ”çûInfo
(
q
);

545 
	`S‘IÁ”çûInfo
(
lše
 + 
	`¡¾’
(
p
) + 1);

547 } ià(
	`¡rcmp
(
p
, "io") == 0) {

548 
	`AssignIOModuË
(
q
);

549 } ià(
	`¡rcmp
(
p
, "num_mem_ch") == 0) {

550 
CONFIG
.
num_mem_ch
 = 
	`©oi
(
q
);

551 } ià(
	`¡rcmp
(
p
, "multiprocess") == 0) {

552 
CONFIG
.
muÉi_´oûss
 = 1;

553 
	`S‘MuÉiProûssSuµÜt
(
lše
 + 
	`¡¾’
(
p
) + 1);

555 
	`TRACE_CONFIG
("UnknowÀİtiÚy³: %s\n", 
lše
);

560 
	}
}

563 
	$LßdCÚfigu¿tiÚ
(cÚ¡ *
âame
)

565 
FILE
 *
å
;

566 
İt¡r
[
MAX_OPTLINE_LEN
];

568 
	`TRACE_CONFIG
("----------------------------------------------------------"

570 
	`TRACE_CONFIG
("Lßdšg mtı cÚfigu¿tiÚ from : %s\n", 
âame
);

572 
å
 = 
	`fİ’
(
âame
, "r");

573 ià(
å
 =ğ
NULL
) {

574 
	`³¼Ü
("fopen");

575 
	`TRACE_CONFIG
("FaedØlßd cÚfigu¿tiÚ fe: %s\n", 
âame
);

580 
CONFIG
.
num_cÜes
 = 
num_ıus
;

581 
CONFIG
.
max_cÚcu¼’cy
 = 100000;

582 
CONFIG
.
max_num_bufãrs
 = 100000;

583 
CONFIG
.
rcvbuf_size
 = 8192;

584 
CONFIG
.
¢dbuf_size
 = 8192;

585 
CONFIG
.
tı_timeout
 = 
TCP_TIMEOUT
;

586 
CONFIG
.
tı_timewa™
 = 
TCP_TIMEWAIT
;

587 
CONFIG
.
num_mem_ch
 = 0;

590 *
p
;

591 *
‹mp
;

593 ià(
	`fg‘s
(
İt¡r
, 
MAX_OPTLINE_LEN
, 
å
è=ğ
NULL
)

596 
p
 = 
İt¡r
;

599 ià((
‹mp
 = 
	`¡rchr
(
p
, '#')è!ğ
NULL
)

600 *
‹mp
 = 0;

602 *
p
 && 
	`is¥aû
(()*p))

603 
p
++;

604 
‹mp
 = 
p
 + 
	`¡¾’
(p) - 1;

605 
‹mp
 >ğ
p
 && 
	`is¥aû
(()*temp))

606 *
‹mp
 = 0;

607 ià(*
p
 == 0)

610 ià(
	`P¬£CÚfigu¿tiÚ
(
p
) < 0)

614 
	`fşo£
(
å
);

617 
	}
}

620 
	$PrštCÚfigu¿tiÚ
()

622 
i
;

624 
	`TRACE_CONFIG
("Configurations:\n");

625 
	`TRACE_CONFIG
("Numb” oàCPU cÜe avaabË: %d\n", 
num_ıus
);

626 
	`TRACE_CONFIG
("Numb” oàCPU cÜe tØu£: %d\n", 
CONFIG
.
num_cÜes
);

627 
	`TRACE_CONFIG
("Maximum‚umber of concurrency…er core: %d\n",

628 
CONFIG
.
max_cÚcu¼’cy
);

629 ià(
CONFIG
.
muÉi_´oûss
 == 1) {

630 
	`TRACE_CONFIG
("Multi-process support isƒnabled‡nd current core is: %d\n",

631 
CONFIG
.
muÉi_´oûss_cu¼_cÜe
);

632 ià(
CONFIG
.
muÉi_´oûss_is_ma¡”
 == 1)

633 
	`TRACE_CONFIG
("Current core is master (for multi-process)\n");

635 
	`TRACE_CONFIG
("Current core is‚ot master (for multi-process)\n");

637 
	`TRACE_CONFIG
("Maximum‚umber of…reallocated buffers…er core: %d\n",

638 
CONFIG
.
max_num_bufãrs
);

639 
	`TRACE_CONFIG
("Reûivbufã¸size: %d\n", 
CONFIG
.
rcvbuf_size
);

640 
	`TRACE_CONFIG
("S’d bufã¸size: %d\n", 
CONFIG
.
¢dbuf_size
);

642 ià(
CONFIG
.
tı_timeout
 > 0) {

643 
	`TRACE_CONFIG
("TCPimeout seconds: %d\n",

644 
	`USEC_TO_SEC
(
CONFIG
.
tı_timeout
 * 
TIME_TICK
));

646 
	`TRACE_CONFIG
("TCPimeout check disabled.\n");

648 
	`TRACE_CONFIG
("TCPimewait seconds: %d\n",

649 
	`USEC_TO_SEC
(
CONFIG
.
tı_timewa™
 * 
TIME_TICK
));

650 
	`TRACE_CONFIG
("NICso…rint statistics:");

651 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

652 ià(
CONFIG
.
‘hs
[
i
].
¡©_´št
) {

653 
	`TRACE_CONFIG
(" %s", 
CONFIG
.
‘hs
[
i
].
dev_Çme
);

656 
	`TRACE_CONFIG
("\n");

657 
	`TRACE_CONFIG
("----------------------------------------------------------"

659 
	}
}

	@core.cpp

1 #iâdeà
_GNU_SOURCE


2 
	#_GNU_SOURCE


	)

5 
	~<uni¡d.h
>

6 
	~<sys/time.h
>

7 
	~<£m­hÜe.h
>

8 
	~<sys/mmª.h
>

9 
	~<sigÇl.h
>

10 
	~<as£¹.h
>

11 
	~<sched.h
>

13 
	~"ıu.h
"

14 
	~"ps.h
"

15 
	~"‘h_š.h
"

16 
	~"fhash.h
"

17 
	~"tı_£nd_bufãr.h
"

18 
	~"tı_ršg_bufãr.h
"

19 
	~"sock‘.h
"

20 
	~"‘h_out.h
"

21 
	~"tı_š.h
"

22 
	~"tı_out.h
"

23 
	~"mtı_­i.h
"

24 
	~"ev’Şl.h
"

25 
	~"logg”.h
"

26 
	~"cÚfig.h
"

27 
	~"¬p.h
"

28 
	~"_out.h
"

29 
	~"tim”.h
"

30 
	~"debug.h
"

31 
	~"Ãtm­_­i.h
"

32 
	~<io¡»am
>

33 
usšg
 
Çme¥aû
 
	g¡d
;

34 #iâdeà
DISABLE_DPDK


36 
	~<¹e_Ïunch.h
>

37 
	~<¹e_lcÜe.h
>

40 
	#PS_CHUNK_SIZE
 64

	)

41 
	#RX_THRESH
 (
PS_CHUNK_SIZE
 * 0.8)

	)

43 
	#ROUND_STAT
 
FALSE


	)

44 
	#EVENT_STAT
 
FALSE


	)

45 
	#TESTING
 
FALSE


	)

47 
	#LOG_FILE_NAME
 "log"

	)

48 
	#MAX_FILE_NAME
 1024

	)

50 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

51 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

53 
	#PER_STREAM_SLICE
 0.1

54 
	#PER_STREAM_TCHECK
 1

55 
	#PS_SELECT_TIMEOUT
 100

56 

	)

57 
	#GBPS
(
by‹s
è(by‹ * 8.0 / (1000 * 1000 * 1000))

	)

61 
mtı_th»ad_cÚ‹xt
 *
	gg_pùx
[
MAX_CPUS
] = {0};

62 
log_th»ad_cÚ‹xt
 *
	gg_logùx
[
MAX_CPUS
] = {0};

64 
±h»ad_t
 
	gg_th»ad
[
MAX_CPUS
] = {0};

65 
±h»ad_t
 
	glog_th»ad
[
MAX_CPUS
] = {0};

67 
£m_t
 
	gg_š™_£m
[
MAX_CPUS
];

68 
	gruÂšg
[
MAX_CPUS
] = {0};

70 
mtı_sighªdËr_t
 
	g­p_sigÇl_hªdËr
;

71 
	gsigšt_út
[
MAX_CPUS
] = {0};

72 
time¥ec
 
	gsigšt_ts
[
MAX_CPUS
];

74 
	gmtı_ma¡”
 = -1;

77 
	$HªdËSigÇl
(
sigÇl
)

79 
i
 = 0;

81 ià(
sigÇl
 =ğ
SIGINT
) {

82 
cÜe
;

83 
time¥ec
 
cur_ts
;

85 
cÜe
 = 
	`sched_g‘ıu
();

86 
	`şock_g‘time
(
CLOCK_REALTIME
, &
cur_ts
);

88 ià(
CONFIG
.
muÉi_´oûss
) {

89 
i
 = 0; i < 
num_ıus
; i++)

90 ià(
ruÂšg
[
i
] =ğ
TRUE
)

91 
g_pùx
[
i
]->
ex™
 = 
TRUE
;

93 ià(
sigšt_út
[
cÜe
] > 0 && 
cur_ts
.
tv_£c
 > 
sigšt_ts
[core].tv_sec) {

94 
i
 = 0; i < 
num_ıus
; i++) {

95 ià(
ruÂšg
[
i
]) {

96 
g_pùx
[
i
]->
ex™
 = 
TRUE
;

100 
i
 = 0; i < 
num_ıus
; i++) {

101 ià(
ruÂšg
[
i
])

102 
g_pùx
[
i
]->
š‹¼u±
 = 
TRUE
;

104 ià(!
­p_sigÇl_hªdËr
) {

105 
i
 = 0; i < 
num_ıus
; i++) {

106 ià(
ruÂšg
[
i
]) {

107 
g_pùx
[
i
]->
ex™
 = 
TRUE
;

112 
sigšt_út
[
cÜe
]++;

113 
	`şock_g‘time
(
CLOCK_REALTIME
, &
sigšt_ts
[
cÜe
]);

117 ià(
sigÇl
 !ğ
SIGUSR1
) {

118 ià(
­p_sigÇl_hªdËr
) {

119 
	`­p_sigÇl_hªdËr
(
sigÇl
);

122 
	}
}

125 
	$A‰achDeviû
(
mtı_th»ad_cÚ‹xt
* 
ùx
)

127 
wÜkšg
 = -1;

128 
mtı_mªag”_t
 
mtı
 = 
ùx
->
mtı_mªag”
;

130 
wÜkšg
 = 
mtı
->
iom
->
	`lšk_deviûs
(
ùx
);

132  
wÜkšg
;

133 
	}
}

135 #ifdeà
NETSTAT


136 
šlše
 

137 
	$In™StCouÁ”
(
¡©_couÁ”
 *
couÁ”
)

139 
couÁ”
->
út
 = 0;

140 
couÁ”
->
sum
 = 0;

141 
couÁ”
->
max
 = 0;

142 
couÁ”
->
mš
 = 0;

143 
	}
}

145 
šlše
 

146 
	$Upd©eStCouÁ”
(
¡©_couÁ”
 *
couÁ”
, 
št64_t
 
v®ue
)

148 
couÁ”
->
út
++;

149 
couÁ”
->
sum
 +ğ
v®ue
;

150 ià(
v®ue
 > 
couÁ”
->
max
)

151 
couÁ”
->
max
 = 
v®ue
;

152 ià(
couÁ”
->
mš
 =ğ0 || 
v®ue
 < counter->min)

153 
couÁ”
->
mš
 = 
v®ue
;

154 
	}
}

156 
šlše
 
ušt64_t


157 
	$G‘Av”ageSt
(
¡©_couÁ”
 *
couÁ”
)

159  
couÁ”
->
út
 ? (couÁ”->
sum
 / counter->cnt) : 0;

160 
	}
}

162 
šlše
 
št64_t


163 
	$TimeDiffUs
(
timev®
 *
t2
, timev® *
t1
)

165  (
t2
->
tv_£c
 - 
t1
->tv_sec) * 1000000 +

166 (
št64_t
)(
t2
->
tv_u£c
 - 
t1
->tv_usec);

167 
	}
}

169 
šlše
 

170 
	$PrštTh»adN‘wÜkSts
(
mtı_mªag”_t
 
mtı
, 
Ãt_¡©
 *
ns
)

172 
i
;

174 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

175 
ns
->
rx_·ck‘s
[
i
] = 
mtı
->
n¡©
.rx_·ck‘s[i] - mtı->
p_n¡©
.rx_packets[i];

176 
ns
->
rx_”rÜs
[
i
] = 
mtı
->
n¡©
.rx_”rÜs[i] - mtı->
p_n¡©
.rx_errors[i];

177 
ns
->
rx_by‹s
[
i
] = 
mtı
->
n¡©
.rx_by‹s[i] - mtı->
p_n¡©
.rx_bytes[i];

178 
ns
->
tx_·ck‘s
[
i
] = 
mtı
->
n¡©
.tx_·ck‘s[i] - mtı->
p_n¡©
.tx_packets[i];

179 
ns
->
tx_drİs
[
i
] = 
mtı
->
n¡©
.tx_drİs[i] - mtı->
p_n¡©
.tx_drops[i];

180 
ns
->
tx_by‹s
[
i
] = 
mtı
->
n¡©
.tx_by‹s[i] - mtı->
p_n¡©
.tx_bytes[i];

181 #ià
NETSTAT_PERTHREAD


182 ià(
CONFIG
.
‘hs
[
i
].
¡©_´št
) {

183 
	`årštf
(
¡d”r
, "[CPU%2d] %s flows: %6u, "

186 
mtı
->
ùx
->
ıu
, 
CONFIG
.
‘hs
[
i
].
dev_Çme
, mtı->
æow_út
,

187 
ns
->
rx_·ck‘s
[
i
],‚s->
rx_”rÜs
[i], 
	`GBPS
Òs->
rx_by‹s
[i]),

188 
ns
->
tx_·ck‘s
[
i
], 
	`GBPS
Òs->
tx_by‹s
[i]));

192 #ifdeà
ENABLELRO


193 
ns
->
rx_gd±by‹s
 = 
mtı
->
n¡©
.rx_gd±by‹ - mtı->
p_n¡©
.rx_gdptbytes;

194 
ns
->
tx_gd±by‹s
 = 
mtı
->
n¡©
.tx_gd±by‹ - mtı->
p_n¡©
.tx_gdptbytes;

196 
mtı
->
p_n¡©
 = mtı->
n¡©
;

198 
	}
}

200 #ià
ROUND_STAT


201 
šlše
 

202 
	$PrštTh»adRoundSts
(
mtı_mªag”_t
 
mtı
, 
run_¡©
 *
rs
)

204 
	#ROUND_DIV
 (1000)

	)

205 
rs
->
rounds
 = 
mtı
->
run¡©
.round - mtı->
p_run¡©
.rounds;

206 
rs
->
rounds_rx
 = 
mtı
->
run¡©
.rounds_rx - mtı->
p_run¡©
.rounds_rx;

207 
rs
->
rounds_rx_Œy
 = 
mtı
->
run¡©
.rounds_rx_Œy - mtı->
p_run¡©
.rounds_rx_try;

208 
rs
->
rounds_tx
 = 
mtı
->
run¡©
.rounds_tx - mtı->
p_run¡©
.rounds_tx;

209 
rs
->
rounds_tx_Œy
 = 
mtı
->
run¡©
.rounds_tx_Œy - mtı->
p_run¡©
.rounds_tx_try;

210 
rs
->
rounds_£Ëù
 = 
mtı
->
run¡©
.rounds_£Ëù - mtı->
p_run¡©
.rounds_select;

211 
rs
->
rounds_£Ëù_rx
 = 
mtı
->
run¡©
.rounds_£Ëù_rx - mtı->
p_run¡©
.rounds_select_rx;

212 
rs
->
rounds_£Ëù_tx
 = 
mtı
->
run¡©
.rounds_£Ëù_tx - mtı->
p_run¡©
.rounds_select_tx;

213 
rs
->
rounds_£Ëù_šŒ
 = 
mtı
->
run¡©
.rounds_£Ëù_šŒ - mtı->
p_run¡©
.rounds_select_intr;

214 
rs
->
rounds_twcheck
 = 
mtı
->
run¡©
.rounds_twcheck - mtı->
p_run¡©
.rounds_twcheck;

215 
mtı
->
p_run¡©
 = mtı->
run¡©
;

216 #ià
NETSTAT_PERTHREAD


217 
	`årštf
(
¡d”r
, "[CPU%2d] Rounds: %4ldK, "

220 
mtı
->
ùx
->
ıu
, 
rs
->
rounds
 / 
ROUND_DIV
,

221 
rs
->
rounds_rx
 / 
ROUND_DIV
,„s->
rounds_rx_Œy
 / ROUND_DIV,

222 
rs
->
rounds_tx
 / 
ROUND_DIV
,„s->
rounds_tx_Œy
 / ROUND_DIV,

223 
rs
->
rounds_£Ëù
,

224 
rs
->
rounds_£Ëù_rx
,„s->
rounds_£Ëù_tx
,„s->
rounds_£Ëù_šŒ
);

226 
	}
}

231 #ià
EVENT_STAT


232 
šlše
 

233 
	$PrštEv’tSt
(
cÜe
, 
mtı_•Şl_¡©
 *
¡©
)

235 
	`årštf
(
¡d”r
, "[CPU%2d] calls: %lu, waits: %lu, wakes: %lu, "

237 
cÜe
, 
¡©
->
ÿÎs
, st->
wa™s
, st->
wakes
,

238 
¡©
->
issued
, st->
»gi¡”ed
, st->
šv®id©ed
, st->
hªdËd
);

239 
	`mem£t
(
¡©
, 0, (
mtı_•Şl_¡©
));

240 
	}
}

243 #ifdeà
NETSTAT


244 
šlše
 

245 
	$PrštN‘wÜkSts
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
)

247 
	#TIMEOUT
 1

	)

248 
i
;

249 
Ãt_¡©
 
ns
;

250 #ià
ROUND_STAT


251 
run_¡©
 
rs
;

253 #ifdeà
NETSTAT_TOTAL


254 
j
;

255 
ušt32_t
 
gæow_út
 = 0;

256 
Ãt_¡©
 
g_n¡©
;

257 #ià
ROUND_STAT


258 
run_¡©
 
g_run¡©
;

262 ià(
	`TS_TO_MSEC
(
cur_ts
 - 
mtı
->
p_n¡©_ts
è< 
	`SEC_TO_MSEC
(
TIMEOUT
)) {

266 
mtı
->
p_n¡©_ts
 = 
cur_ts
;

267 
gæow_út
 = 0;

268 
	`mem£t
(&
g_n¡©
, 0, (
Ãt_¡©
));

269 
i
 = 0; i < 
CONFIG
.
num_cÜes
; i++) {

270 ià(
ruÂšg
[
i
]) {

271 
	`PrštTh»adN‘wÜkSts
(
g_mtı
[
i
], &
ns
);

272 #ià
NETSTAT_TOTAL


273 
gæow_út
 +ğ
g_mtı
[
i
]->
æow_út
;

274 
j
 = 0; j < 
CONFIG
.
‘hs_num
; j++) {

275 
g_n¡©
.
rx_·ck‘s
[
j
] +ğ
ns
.rx_packets[j];

276 
g_n¡©
.
rx_”rÜs
[
j
] +ğ
ns
.rx_errors[j];

277 
g_n¡©
.
rx_by‹s
[
j
] +ğ
ns
.rx_bytes[j];

278 
g_n¡©
.
tx_·ck‘s
[
j
] +ğ
ns
.tx_packets[j];

279 
g_n¡©
.
tx_drİs
[
j
] +ğ
ns
.tx_drops[j];

280 
g_n¡©
.
tx_by‹s
[
j
] +ğ
ns
.tx_bytes[j];

282 #ifdeà
ENABLELRO


283 
g_n¡©
.
rx_gd±by‹s
 +ğ
ns
.rx_gdptbytes;

284 
g_n¡©
.
tx_gd±by‹s
 +ğ
ns
.tx_gdptbytes;

289 #ià
NETSTAT_TOTAL


290 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

291 ià(
CONFIG
.
‘hs
[
i
].
¡©_´št
) {

292 
	`årštf
(
¡d”r
, "[ ALL ] %s flows: %6u, "

294 "TX: %7ldÕps), %5.2lf(Gbps)\n", 
CONFIG
.
‘hs
[
i
].
dev_Çme
,

295 
gæow_út
, 
g_n¡©
.
rx_·ck‘s
[
i
], g_n¡©.
rx_”rÜs
[i],

296 
	`GBPS
(
g_n¡©
.
rx_by‹s
[
i
]), g_n¡©.
tx_·ck‘s
[i],

297 
	`GBPS
(
g_n¡©
.
tx_by‹s
[
i
]));

300 #ifdeà
ENABLELRO


301 
	`årštf
(
¡d”r
, "[ ALL ] Goodput RX: %5.2lf(Gbps), TX: %5.2lf(Gbps)\n",

302 
	`GBPS
(
g_n¡©
.
rx_gd±by‹s
), GBPS(g_n¡©.
tx_gd±by‹s
));

306 #ià
ROUND_STAT


307 
	`mem£t
(&
g_run¡©
, 0, (
run_¡©
));

308 
i
 = 0; i < 
CONFIG
.
num_cÜes
; i++) {

309 ià(
ruÂšg
[
i
]) {

310 
	`PrštTh»adRoundSts
(
g_mtı
[
i
], &
rs
);

312 
g_run¡©
.
rounds
 +ğ
rs
.rounds;

313 
g_run¡©
.
rounds_rx
 +ğ
rs
.rounds_rx;

314 
g_run¡©
.
rounds_rx_Œy
 +ğ
rs
.rounds_rx_try;

315 
g_run¡©
.
rounds_tx
 +ğ
rs
.rounds_tx;

316 
g_run¡©
.
rounds_tx_Œy
 +ğ
rs
.rounds_tx_try;

317 
g_run¡©
.
rounds_£Ëù
 +ğ
rs
.rounds_select;

318 
g_run¡©
.
rounds_£Ëù_rx
 +ğ
rs
.rounds_select_rx;

319 
g_run¡©
.
rounds_£Ëù_tx
 +ğ
rs
.rounds_select_tx;

324 
	`årštf
(
¡d”r
, "[ ALL ] Rounds: %4ldK, "

327 
g_run¡©
.
rounds
 / 1000, g_run¡©.
rounds_rx
 / 1000,

328 
g_run¡©
.
rounds_rx_Œy
 / 1000, g_run¡©.
rounds_tx
 / 1000,

329 
g_run¡©
.
rounds_tx_Œy
 / 1000, g_run¡©.
rounds_£Ëù
,

330 
g_run¡©
.
rounds_£Ëù_rx
, g_run¡©.
rounds_£Ëù_tx
);

334 #ià
EVENT_STAT


335 
i
 = 0; i < 
CONFIG
.
num_cÜes
; i++) {

336 ià(
ruÂšg
[
i
] && 
g_mtı
[i]->
•
) {

337 
	`PrštEv’tSt
(
i
, &
g_mtı
[i]->
•
->
¡©
);

342 
	`fæush
(
¡d”r
);

343 
	}
}

346 #ià
BLOCKING_SUPPORT


347 
šlše
 

348 
	$FlushAcû±Ev’ts
(
mtı_mªag”_t
 
mtı
)

350 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_acû±
);

352 
	`±h»ad_mu‹x_lock
(&
mtı
->
li¡’”
->
acû±_lock
);

353 ià(!
	`SŒ—mQueueIsEm±y
(
mtı
->
li¡’”
->
acû±q
)) {

354 
	`±h»ad_cÚd_sigÇl
(&
mtı
->
li¡’”
->
acû±_cÚd
);

356 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
li¡’”
->
acû±_lock
);

357 
	}
}

359 
šlše
 

360 
	$FlushWr™eEv’ts
(
mtı_mªag”_t
 
mtı
, 
th»sh
)

362 
tı_¡»am
 *
w®k
;

363 
tı_¡»am
 *
Ãxt
, *
Ï¡
;

364 
út
;

366 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_wr™e
);

369 
út
 = 0;

370 
w®k
 = 
	`TAILQ_FIRST
(&
mtı
->
¢d_br_li¡
);

371 
Ï¡
 = 
	`TAILQ_LAST
(&
mtı
->
¢d_br_li¡
, 
¢d_br_h—d
);

372 
w®k
) {

373 ià(++
út
 > 
th»sh
)

376 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
¢dv¬
->
¢d_br_lšk
);

377 
	`TRACE_LOOP
("Insid£nd brßdÿ¡šg†i¡. cÁ: %u\n", 
út
);

378 
	`TAILQ_REMOVE
(&
mtı
->
¢d_br_li¡
, 
w®k
, 
¢dv¬
->
¢d_br_lšk
);

379 
mtı
->
¢d_br_li¡_út
--;

380 ià(
w®k
->
Ú_¢d_br_li¡
) {

381 
	`TRACE_SNDBUF
("Broadcasting‡vailable sending buffer!\n");

382 ià(!(
w®k
->
•Şl
 & 
MTCP_EPOLLOUT
)) {

383 
	`±h»ad_cÚd_sigÇl
(&
w®k
->
wr™e_cÚd
);

384 
w®k
->
Ú_¢d_br_li¡
 = 
FALSE
;

388 ià(
w®k
 =ğ
Ï¡
)

390 
w®k
 = 
Ãxt
;

392 
	}
}

394 
šlše
 

395 
	$FlushR—dEv’ts
(
mtı_mªag”_t
 
mtı
, 
th»sh
)

397 
tı_¡»am
 *
w®k
;

398 
tı_¡»am
 *
Ãxt
, *
Ï¡
;

399 
út
;

401 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_»ad
);

404 
út
 = 0;

405 
w®k
 = 
	`TAILQ_FIRST
(&
mtı
->
rcv_br_li¡
);

406 
Ï¡
 = 
	`TAILQ_LAST
(&
mtı
->
rcv_br_li¡
, 
rcv_br_h—d
);

407 
w®k
) {

408 ià(++
út
 > 
th»sh
)

411 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
rcvv¬
->
rcv_br_lšk
);

412 
	`TRACE_LOOP
("Insid»cv brßdÿ¡šg†i¡. cÁ: %u\n", 
út
);

413 
	`TAILQ_REMOVE
(&
mtı
->
rcv_br_li¡
, 
w®k
, 
rcvv¬
->
rcv_br_lšk
);

414 
mtı
->
rcv_br_li¡_út
--;

415 ià(
w®k
->
Ú_rcv_br_li¡
) {

416 ià(!(
w®k
->
•Şl
 & 
MTCP_EPOLLIN
)) {

417 
	`TRACE_TEMP
("Broadcasting„ead contition\n");

418 
	`±h»ad_cÚd_sigÇl
(&
w®k
->
»ad_cÚd
);

419 
w®k
->
Ú_rcv_br_li¡
 = 
FALSE
;

423 ià(
w®k
 =ğ
Ï¡
)

425 
w®k
 = 
Ãxt
;

427 
	}
}

430 
šlše
 

431 
	$FlushEpŞlEv’ts
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
)

433 
mtı_•Şl
 *
•
 = 
mtı
->ep;

434 
ev’t_queue
 *
u¤q
 = 
•
->
u¤_queue
;

435 
ev’t_queue
 *
mtıq
 = 
•
->
mtı_queue
;

437 
	`±h»ad_mu‹x_lock
(&
•
->
•Şl_lock
);

438 ià(
•
->
mtı_queue
->
num_ev’ts
 > 0) {

441 
mtıq
->
num_ev’ts
 > 0 && 
u¤q
->num_ev’t < u¤q->
size
) {

443 
u¤q
->
ev’ts
[u¤q->
’d
++] = 
mtıq
->ev’ts[mtıq->
¡¬t
++];

445 ià(
u¤q
->
’d
 >ğu¤q->
size
)

446 
u¤q
->
’d
 = 0;

447 
u¤q
->
num_ev’ts
++;

449 ià(
mtıq
->
¡¬t
 >ğmtıq->
size
)

450 
mtıq
->
¡¬t
 = 0;

451 
mtıq
->
num_ev’ts
--;

456 ià(
•
->
wa™šg
 && (•->
u¤_queue
->
num_ev’ts
 > 0 ||

457 
•
->
u¤_shadow_queue
->
num_ev’ts
 > 0)) {

458 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_•Şl
);

459 
	`TRACE_EPOLL
("Broadcastingƒvents.‚um: %d, cur_ts: %u,…rev_ts: %u\n",

460 
•
->
u¤_queue
->
num_ev’ts
, 
cur_ts
, 
mtı
->
ts_Ï¡_ev’t
);

461 
mtı
->
ts_Ï¡_ev’t
 = 
cur_ts
;

462 
•
->
¡©
.
wakes
++;

463 
	`±h»ad_cÚd_sigÇl
(&
•
->
•Şl_cÚd
);

465 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

466 
	}
}

468 
šlše
 

469 
	$HªdËAµliÿtiÚC®ls
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
)

471 
tı_¡»am
 *
¡»am
;

472 
út
, 
max_út
;

473 
hªdËd
, 
d–ayed
;

474 
cÚŒŞ
, 
£nd
, 
ack
;

477 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
cÚÃùq
))) {

478 
	`AddtoCÚŒŞLi¡
(
mtı
, 
¡»am
, 
cur_ts
);

482 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
£ndq
))) {

483 
¡»am
->
¢dv¬
->
Ú_£ndq
 = 
FALSE
;

484 
	`AddtoS’dLi¡
(
mtı
, 
¡»am
);

488 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
ackq
))) {

489 
¡»am
->
¢dv¬
->
Ú_ackq
 = 
FALSE
;

490 
	`EnqueueACK
(
mtı
, 
¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

494 
hªdËd
 = 
d–ayed
 = 0;

495 
cÚŒŞ
 = 
£nd
 = 
ack
 = 0;

496 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
şo£q
))) {

497 
tı_£nd_v¬s
 *
¢dv¬
 = 
¡»am
->sndvar;

498 
¢dv¬
->
Ú_şo£q
 = 
FALSE
;

500 ià(
¢dv¬
->
¢dbuf
) {

501 
¢dv¬
->
fss
 = sndv¬->
¢dbuf
->
h—d_£q
 + sndv¬->¢dbuf->
Ën
;

503 
¢dv¬
->
fss
 = 
¡»am
->
¢d_nxt
;

506 ià(
CONFIG
.
tı_timeout
 > 0)

507 
	`RemoveFromTimeoutLi¡
(
mtı
, 
¡»am
);

509 ià(
¡»am
->
have_»£t
) {

510 
hªdËd
++;

511 ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

512 
¡»am
->
şo£_»asÚ
 = 
TCP_RESET
;

513 
¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

514 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
¡»am
->
id
);

515 
	`De¡royTCPSŒ—m
(
mtı
, 
¡»am
);

517 
	`TRACE_ERROR
("Stream‡lready closed.\n");

520 } ià(
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

521 
¢dv¬
->
Ú_şo£q_št
 = 
TRUE
;

522 
	`SŒ—mIÁ”ÇlEnqueue
(
mtı
->
şo£q_št
, 
¡»am
);

523 
d–ayed
++;

524 ià(
¢dv¬
->
Ú_cÚŒŞ_li¡
)

525 
cÚŒŞ
++;

526 ià(
¢dv¬
->
Ú_£nd_li¡
)

527 
£nd
++;

528 ià(
¢dv¬
->
Ú_ack_li¡
)

529 
ack
++;

531 } ià(
¢dv¬
->
Ú_£nd_li¡
 || sndv¬->
Ú_ack_li¡
) {

532 
hªdËd
++;

533 ià(
¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

534 
¡»am
->
¡©e
 = 
TCP_ST_FIN_WAIT_1
;

535 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_FIN_WAIT_1\n", 
¡»am
->
id
);

537 } ià(
¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

538 
¡»am
->
¡©e
 = 
TCP_ST_LAST_ACK
;

539 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_LAST_ACK\n", 
¡»am
->
id
);

541 
¡»am
->
cÚŒŞ_li¡_wa™šg
 = 
TRUE
;

543 } ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

544 
hªdËd
++;

545 ià(
¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

546 
¡»am
->
¡©e
 = 
TCP_ST_FIN_WAIT_1
;

547 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_FIN_WAIT_1\n", 
¡»am
->
id
);

549 } ià(
¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

550 
¡»am
->
¡©e
 = 
TCP_ST_LAST_ACK
;

551 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_LAST_ACK\n", 
¡»am
->
id
);

555 
	`AddtoCÚŒŞLi¡
(
mtı
, 
¡»am
, 
cur_ts
);

557 
	`TRACE_ERROR
("Already closed connection!\n");

560 
	`TRACE_ROUND
("Hªdlšg clo£ cÚÃùiÚs. cÁ: %d\n", 
út
);

562 
út
 = 0;

563 
max_út
 = 
mtı
->
şo£q_št
->
couÁ
;

564 
út
++ < 
max_út
) {

565 
¡»am
 = 
	`SŒ—mIÁ”ÇlDequeue
(
mtı
->
şo£q_št
);

567 ià(
¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

568 
	`SŒ—mIÁ”ÇlEnqueue
(
mtı
->
şo£q_št
, 
¡»am
);

570 } ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

571 
hªdËd
++;

572 
¡»am
->
¢dv¬
->
Ú_şo£q_št
 = 
FALSE
;

573 ià(
¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

574 
¡»am
->
¡©e
 = 
TCP_ST_FIN_WAIT_1
;

575 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_FIN_WAIT_1\n", 
¡»am
->
id
);

577 } ià(
¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

578 
¡»am
->
¡©e
 = 
TCP_ST_LAST_ACK
;

579 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_LAST_ACK\n", 
¡»am
->
id
);

581 
	`AddtoCÚŒŞLi¡
(
mtı
, 
¡»am
, 
cur_ts
);

583 
¡»am
->
¢dv¬
->
Ú_şo£q_št
 = 
FALSE
;

584 
	`TRACE_ERROR
("Already closed connection!\n");

589 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
»£tq
))) {

590 
¡»am
->
¢dv¬
->
Ú_»£tq
 = 
FALSE
;

592 ià(
CONFIG
.
tı_timeout
 > 0)

593 
	`RemoveFromTimeoutLi¡
(
mtı
, 
¡»am
);

595 ià(
¡»am
->
have_»£t
) {

596 ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

597 
¡»am
->
şo£_»asÚ
 = 
TCP_RESET
;

598 
¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

599 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
¡»am
->
id
);

600 
	`De¡royTCPSŒ—m
(
mtı
, 
¡»am
);

602 
	`TRACE_ERROR
("Stream‡lready closed.\n");

605 } ià(
¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 ||

606 
¡»am
->
¢dv¬
->
Ú_£nd_li¡
 || sŒ—m->¢dv¬->
Ú_ack_li¡
) {

608 
¡»am
->
¢dv¬
->
Ú_»£tq_št
 = 
TRUE
;

609 
	`SŒ—mIÁ”ÇlEnqueue
(
mtı
->
»£tq_št
, 
¡»am
);

612 ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

613 
¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

614 
¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

615 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
¡»am
->
id
);

616 
	`AddtoCÚŒŞLi¡
(
mtı
, 
¡»am
, 
cur_ts
);

618 
	`TRACE_ERROR
("Stream‡lready closed.\n");

622 
	`TRACE_ROUND
("Hªdlšg„e£ˆcÚÃùiÚs. cÁ: %d\n", 
út
);

624 
út
 = 0;

625 
max_út
 = 
mtı
->
»£tq_št
->
couÁ
;

626 
út
++ < 
max_út
) {

627 
¡»am
 = 
	`SŒ—mIÁ”ÇlDequeue
(
mtı
->
»£tq_št
);

629 ià(
¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 ||

630 
¡»am
->
¢dv¬
->
Ú_£nd_li¡
 || sŒ—m->¢dv¬->
Ú_ack_li¡
) {

632 
	`SŒ—mIÁ”ÇlEnqueue
(
mtı
->
»£tq_št
, 
¡»am
);

635 
¡»am
->
¢dv¬
->
Ú_»£tq_št
 = 
FALSE
;

637 ià(
¡»am
->
¡©e
 !ğ
TCP_ST_CLOSED
) {

638 
¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

639 
¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

640 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
¡»am
->
id
);

641 
	`AddtoCÚŒŞLi¡
(
mtı
, 
¡»am
, 
cur_ts
);

643 
	`TRACE_ERROR
("Stream‡lready closed.\n");

649 (
¡»am
 = 
	`SŒ—mDequeue
(
mtı
->
de¡royq
))) {

650 
	`De¡royTCPSŒ—m
(
mtı
, 
¡»am
);

653 
mtı
->
wakeup_æag
 = 
FALSE
;

654 
	}
}

656 
šlše
 

657 
	$Wr™ePack‘sToChunks
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
)

659 
th»sh
 = 
CONFIG
.
max_cÚcu¼’cy
;

660 
i
;

664 
	`as£¹
(
mtı
->
g_£nd”
 !ğ
NULL
);

665 ià(
mtı
->
g_£nd”
->
cÚŒŞ_li¡_út
)

666 
	`Wr™eTCPCÚŒŞLi¡
(
mtı
, mtı->
g_£nd”
, 
cur_ts
, 
th»sh
);

667 ià(
mtı
->
g_£nd”
->
ack_li¡_út
)

668 
	`Wr™eTCPACKLi¡
(
mtı
, mtı->
g_£nd”
, 
cur_ts
, 
th»sh
);

669 ià(
mtı
->
g_£nd”
->
£nd_li¡_út
)

670 
	`Wr™eTCPD©aLi¡
(
mtı
, mtı->
g_£nd”
, 
cur_ts
, 
th»sh
);

672 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

673 
	`as£¹
(
mtı
->
n_£nd”
[
i
] !ğ
NULL
);

674 ià(
mtı
->
n_£nd”
[
i
]->
cÚŒŞ_li¡_út
)

675 
	`Wr™eTCPCÚŒŞLi¡
(
mtı
, mtı->
n_£nd”
[
i
], 
cur_ts
, 
th»sh
);

676 ià(
mtı
->
n_£nd”
[
i
]->
ack_li¡_út
)

677 
	`Wr™eTCPACKLi¡
(
mtı
, mtı->
n_£nd”
[
i
], 
cur_ts
, 
th»sh
);

678 ià(
mtı
->
n_£nd”
[
i
]->
£nd_li¡_út
)

679 
	`Wr™eTCPD©aLi¡
(
mtı
, mtı->
n_£nd”
[
i
], 
cur_ts
, 
th»sh
);

681 
	}
}

683 #ià
TESTING


685 
	$De¡royRemaššgFlows
(
mtı_mªag”_t
 
mtı
)

687 
hashbË
 *
ht
 = 
mtı
->
tı_æow_bË
;

688 
tı_¡»am
 *
w®k
;

689 
út
, 
i
;

691 
út
 = 0;

693 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

694 "CPU %d: Flushšg„emaššg flows.\n", 
mtı
->
ùx
->
ıu
);

696 
i
 = 0; i < 
NUM_BINS
; i++) {

697 
	`TAILQ_FOREACH
(
w®k
, &
ht
->
ht_bË
[
i
], 
rcvv¬
->
he_lšk
) {

698 #ifdeà
DUMP_STREAM


699 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

700 "CPU %d: De¡royšg sŒ—m %d\n", 
mtı
->
ùx
->
ıu
, 
w®k
->
id
);

701 
	`DumpSŒ—m
(
mtı
, 
w®k
);

703 
	`De¡royTCPSŒ—m
(
mtı
, 
w®k
);

704 
út
++;

708  
út
;

709 
	}
}

713 
	$IÁ”ru±AµliÿtiÚ
(
mtı_mªag”_t
 
mtı
)

715 
i
;

716 
tı_li¡’”
 *
li¡’”
 = 
NULL
;

719 ià(
mtı
->
•
) {

720 
	`±h»ad_mu‹x_lock
(&
mtı
->
•
->
•Şl_lock
);

721 ià(
mtı
->
•
->
wa™šg
) {

722 
	`±h»ad_cÚd_sigÇl
(&
mtı
->
•
->
•Şl_cÚd
);

724 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
•
->
•Şl_lock
);

729 
i
 = 0; i < 
MAX_PORT
; i++) {

730 
li¡’”
 = 
	`Li¡’”HTS—rch
(
mtı
->
li¡’”s
, &
i
);

731 ià(
li¡’”
 !ğ
NULL
) {

732 
	`±h»ad_mu‹x_lock
(&
li¡’”
->
acû±_lock
);

733 ià(!(
li¡’”
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

734 
	`±h»ad_cÚd_sigÇl
(&
li¡’”
->
acû±_cÚd
);

736 
	`±h»ad_mu‹x_uÆock
(&
li¡’”
->
acû±_lock
);

739 
	}
}

742 
	$RunMašLoİ
(
mtı_th»ad_cÚ‹xt
 *
ùx
)

744 
mtı_mªag”_t
 
mtı
 = 
ùx
->
mtı_mªag”
;

745 
i
;

746 
»cv_út
;

747 
rx_šf
, 
tx_šf
;

748 
timev®
 
cur_ts
 = {0};

749 
ušt32_t
 
ts
, 
ts_´ev
;

750 
th»sh
;

751 
»t
;

752 
	`g‘timeofday
(&
cur_ts
, 
NULL
);

753 
	`TRACE_DBG
("CPU %d: mtıh»ad„uÂšg.\n", 
ùx
->
ıu
);

755 
ts
 = 
ts_´ev
 = 0;

756 (!
ùx
->
dÚe
 || 
mtı
->
æow_út
è&& !ùx->
ex™
) {

759 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds
);

760 
»cv_út
 = 0;

762 
	`g‘timeofday
(&
cur_ts
, 
NULL
);

763 
ts
 = 
	`TIMEVAL_TO_TS
(&
cur_ts
);

764 
mtı
->
cur_ts
 = 
ts
;

768 
rx_šf
 = 0;„x_šà< 
CONFIG
.
‘hs_num
;„x_inf++) {

772 
»cv_út
 = 
mtı
->
iom
->
	`»cv_pkts
(
ùx
, 
rx_šf
);

773 
ušt16_t
 
Ën
;

774 
ušt8_t
 *
pktbuf
;

778 
i
=1;i<=
»cv_út
;i++){

781 
pktbuf
 = 
mtı
->
iom
->
	`g‘_½Œ
(mtı->
ùx
, 
rx_šf
, 
i
, &
Ën
);

787 ià(
	`lik–y
(
pktbuf
 !ğ
NULL
))

790 
»t
 = 
	`ProûssPack‘
(
mtı
, 
rx_šf
, 
ts
, 
pktbuf
, 
Ën
);

792 
Ãtm­u£
.
	`syncbuäx
(
ùx
->
ıu
);

795 
mtı
->
n¡©
.
rx_”rÜs
[
rx_šf
]++;

813 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_rx
);

816 ià(
mtı
->
æow_út
 > 0) {

820 
th»sh
 = ()
mtı
->
æow_út
 / (
	`TS_TO_USEC
(
PER_STREAM_TCHECK
));

821 
	`as£¹
(
th»sh
 >= 0);

822 ià(
th»sh
 == 0)

823 
th»sh
 = 1;

824 ià(
»cv_út
 > 0 && 
th»sh
 >„ecv_cnt)

825 
th»sh
 = 
»cv_út
;

827 
th»sh
 = 
CONFIG
.
max_cÚcu¼’cy
;

832 ià(
th»sh
 == -1)

833 
th»sh
 = 
CONFIG
.
max_cÚcu¼’cy
;

835 
	`CheckRtmTimeout
(
mtı
, 
ts
, 
th»sh
);

836 
	`CheckTimewa™Expœe
(
mtı
, 
ts
, 
CONFIG
.
max_cÚcu¼’cy
);

838 ià(
CONFIG
.
tı_timeout
 > 0 && 
ts
 !ğ
ts_´ev
) {

839 
	`CheckCÚÃùiÚTimeout
(
mtı
, 
ts
, 
th»sh
);

844 ià(
mtı
->
•
) {

845 
	`FlushEpŞlEv’ts
(
mtı
, 
ts
);

848 ià(
mtı
->
æow_út
 > 0) {

850 
	`HªdËAµliÿtiÚC®ls
(
mtı
, 
ts
);

853 
	`Wr™ePack‘sToChunks
(
mtı
, 
ts
);

857 
tx_šf
 = 0;x_šà< 
CONFIG
.
‘hs_num
;x_inf++) {

858 
mtı
->
iom
->
	`£nd_pkts
(
ùx
, 
tx_šf
);

861 ià(
ts
 !ğ
ts_´ev
) {

862 
ts_´ev
 = 
ts
;

872 
mtı
->
iom
->
	`£Ëù
(
ùx
);

874 ià(
ùx
->
š‹¼u±
) {

875 
	`IÁ”ru±AµliÿtiÚ
(
mtı
);

879 #ià
TESTING


880 
	`De¡royRemaššgFlows
(
mtı
);

883 
	`TRACE_DBG
("MTCPh»ad %d ouˆoàmaš†oİ.\n", 
ùx
->
ıu
);

885 
	`æush_log_d©a
(
mtı
);

886 
	`TRACE_DBG
("MTCPh»ad %d flushed†ogs.\n", 
ùx
->
ıu
);

887 
	`IÁ”ru±AµliÿtiÚ
(
mtı
);

888 
	`TRACE_INFO
("MTCPh»ad %d fšished.\n", 
ùx
->
ıu
);

889 
	}
}

891 
mtı_£nd”
 *

892 
	$C»©eMTCPS’d”
(
ifidx
)

894 
mtı_£nd”
 *
£nd”
;

896 
£nd”
 = (
mtı_£nd”
 *)
	`ÿÎoc
(1, (mtcp_sender));

897 ià(!
£nd”
) {

898  
NULL
;

901 
£nd”
->
ifidx
 = ifidx;

903 
	`TAILQ_INIT
(&
£nd”
->
cÚŒŞ_li¡
);

904 
	`TAILQ_INIT
(&
£nd”
->
£nd_li¡
);

905 
	`TAILQ_INIT
(&
£nd”
->
ack_li¡
);

907 
£nd”
->
cÚŒŞ_li¡_út
 = 0;

908 
£nd”
->
£nd_li¡_út
 = 0;

909 
£nd”
->
ack_li¡_út
 = 0;

911  
£nd”
;

912 
	}
}

915 
	$De¡royMTCPS’d”
(
mtı_£nd”
 *
£nd”
)

917 
	`ä“
(
£nd”
);

918 
	}
}

920 
mtı_mªag”_t


921 
	$In™ŸlizeMTCPMªag”
(
mtı_th»ad_cÚ‹xt
* 
ùx
)

923 
mtı_mªag”_t
 
mtı
;

924 
log_Çme
[
MAX_FILE_NAME
];

925 
i
;

927 
mtı
 = (
mtı_mªag”_t
)
	`ÿÎoc
(1, (
mtı_mªag”
));

928 ià(!
mtı
) {

929 
	`³¼Ü
("malloc");

930 
	`CTRACE_ERROR
("Failedo‡llocate mtcp_manager.\n");

931  
NULL
;

933 
g_mtı
[
ùx
->
ıu
] = 
mtı
;

935 
mtı
->
tı_æow_bË
 = 
	`C»©eHashbË
(
HashFlow
, 
Equ®Flow
, 
NUM_BINS_FLOWS
);

936 ià(!
mtı
->
tı_æow_bË
) {

937 
	`CTRACE_ERROR
("Faliedo‡llocatecp flowable.\n");

938  
NULL
;

941 
mtı
->
li¡’”s
 = 
	`C»©eHashbË
(
HashLi¡’”
, 
Equ®Li¡’”
, 
NUM_BINS_LISTENERS
);

942 ià(!
mtı
->
li¡’”s
) {

943 
	`CTRACE_ERROR
("Failedo‡llocate†istenerable.\n");

944  
NULL
;

947 #ifdeà
HUGEPAGE


948 
	#IS_HUGEPAGE
 1

	)

950 
	#IS_HUGEPAGE
 0

	)

953 
mtı
->
æow_poŞ
 = 
	`MPC»©e
((
tı_¡»am
),

954 (
tı_¡»am
è* 
CONFIG
.
max_cÚcu¼’cy
, 
IS_HUGEPAGE
);

955 ià(!
mtı
->
æow_poŞ
) {

956 
	`CTRACE_ERROR
("Failedo‡llocatecp flow…ool.\n");

957  
NULL
;

959 
mtı
->
rv_poŞ
 = 
	`MPC»©e
((
tı_»cv_v¬s
),

960 (
tı_»cv_v¬s
è* 
CONFIG
.
max_cÚcu¼’cy
, 
IS_HUGEPAGE
);

961 ià(!
mtı
->
rv_poŞ
) {

962 
	`CTRACE_ERROR
("Failedo‡llocatecp„ecv variable…ool.\n");

963  
NULL
;

965 
mtı
->
sv_poŞ
 = 
	`MPC»©e
((
tı_£nd_v¬s
),

966 (
tı_£nd_v¬s
è* 
CONFIG
.
max_cÚcu¼’cy
, 
IS_HUGEPAGE
);

967 ià(!
mtı
->
sv_poŞ
) {

968 
	`CTRACE_ERROR
("Failedo‡llocatecp send variable…ool.\n");

969  
NULL
;

972 
mtı
->
rbm_¢d
 = 
	`SBMªag”C»©e
(
CONFIG
.
¢dbuf_size
, CONFIG.
max_num_bufãrs
);

973 ià(!
mtı
->
rbm_¢d
) {

974 
	`CTRACE_ERROR
("Failedo create send„ing buffer.\n");

975  
NULL
;

977 #ifdeà
ENABLELRO


978 
mtı
->
rbm_rcv
 = 
	`RBMªag”C»©e
(mtı, 
CONFIG
.
rcvbuf_size
, CONFIG.
max_num_bufãrs
);

980 
mtı
->
rbm_rcv
 = 
	`RBMªag”C»©e
(
CONFIG
.
rcvbuf_size
, CONFIG.
max_num_bufãrs
);

982 ià(!
mtı
->
rbm_rcv
) {

983 
	`CTRACE_ERROR
("Failedo create„ecv„ing buffer.\n");

984  
NULL
;

987 
	`In™ŸlizeTCPSŒ—mMªag”
();

989 
mtı
->
sm­
 = (
sock‘_m­_t
)
	`ÿÎoc
(
CONFIG
.
max_cÚcu¼’cy
, (
sock‘_m­
));

990 ià(!
mtı
->
sm­
) {

991 
	`³¼Ü
("calloc");

992 
	`CTRACE_ERROR
("Failedo‡llocate memory for stream map.\n");

993  
NULL
;

995 
	`TAILQ_INIT
(&
mtı
->
ä“_sm­
);

996 
i
 = 0; i < 
CONFIG
.
max_cÚcu¼’cy
; i++) {

997 
mtı
->
sm­
[
i
].
id
 = i;

998 
mtı
->
sm­
[
i
].
sockty³
 = 
MTCP_SOCK_UNUSED
;

999 
	`mem£t
(&
mtı
->
sm­
[
i
].
§ddr
, 0, (
sockaddr_š
));

1000 
mtı
->
sm­
[
i
].
¡»am
 = 
NULL
;

1001 
	`TAILQ_INSERT_TAIL
(&
mtı
->
ä“_sm­
, &mtı->
sm­
[
i
], 
ä“_sm­_lšk
);

1004 
mtı
->
ùx
 = ctx;

1005 
mtı
->
•
 = 
NULL
;

1007 
	`¢´štf
(
log_Çme
, 
MAX_FILE_NAME
, 
LOG_FILE_NAME
"_%d", 
ùx
->
ıu
);

1008 
mtı
->
log_å
 = 
	`fİ’
(
log_Çme
, "w");

1009 ià(!
mtı
->
log_å
) {

1010 
	`³¼Ü
("fopen");

1011 
	`CTRACE_ERROR
("Failedo create file for†ogging.\n");

1012  
NULL
;

1014 
mtı
->
¥_fd
 = 
g_logùx
[
ùx
->
ıu
]->
·œ_¥_fd
;

1015 
mtı
->
logg”
 = 
g_logùx
[
ùx
->
ıu
];

1017 
mtı
->
cÚÃùq
 = 
	`C»©eSŒ—mQueue
(
BACKLOG_SIZE
);

1018 ià(!
mtı
->
cÚÃùq
) {

1019 
	`CTRACE_ERROR
("Failedo create connect queue.\n");

1020  
NULL
;

1022 
mtı
->
£ndq
 = 
	`C»©eSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1023 ià(!
mtı
->
£ndq
) {

1024 
	`CTRACE_ERROR
("Failedo create send queue.\n");

1025  
NULL
;

1027 
mtı
->
ackq
 = 
	`C»©eSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1028 ià(!
mtı
->
ackq
) {

1029 
	`CTRACE_ERROR
("Failedo create‡ck queue.\n");

1030  
NULL
;

1032 
mtı
->
şo£q
 = 
	`C»©eSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1033 ià(!
mtı
->
şo£q
) {

1034 
	`CTRACE_ERROR
("Failedo create close queue.\n");

1035  
NULL
;

1037 
mtı
->
şo£q_št
 = 
	`C»©eIÁ”ÇlSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1038 ià(!
mtı
->
şo£q_št
) {

1039 
	`CTRACE_ERROR
("Failedo create close queue.\n");

1040  
NULL
;

1042 
mtı
->
»£tq
 = 
	`C»©eSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1043 ià(!
mtı
->
»£tq
) {

1044 
	`CTRACE_ERROR
("Failedo create„eset queue.\n");

1045  
NULL
;

1047 
mtı
->
»£tq_št
 = 
	`C»©eIÁ”ÇlSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1048 ià(!
mtı
->
»£tq_št
) {

1049 
	`CTRACE_ERROR
("Failedo create„eset queue.\n");

1050  
NULL
;

1052 
mtı
->
de¡royq
 = 
	`C»©eSŒ—mQueue
(
CONFIG
.
max_cÚcu¼’cy
);

1053 ià(!
mtı
->
de¡royq
) {

1054 
	`CTRACE_ERROR
("Failedo create destroy queue.\n");

1055  
NULL
;

1058 
mtı
->
g_£nd”
 = 
	`C»©eMTCPS’d”
(-1);

1059 ià(!
mtı
->
g_£nd”
) {

1060 
	`CTRACE_ERROR
("Failedo create global sender structure.\n");

1061  
NULL
;

1063 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

1064 
mtı
->
n_£nd”
[
i
] = 
	`C»©eMTCPS’d”
(i);

1065 ià(!
mtı
->
n_£nd”
[
i
]) {

1066 
	`CTRACE_ERROR
("Failedo create…er-nic sender structure.\n");

1067  
NULL
;

1071 
mtı
->
¹o_¡Üe
 = 
	`In™RTOHash¡Üe
();

1072 
	`TAILQ_INIT
(&
mtı
->
timewa™_li¡
);

1073 
	`TAILQ_INIT
(&
mtı
->
timeout_li¡
);

1075 #ià
BLOCKING_SUPPORT


1076 
	`TAILQ_INIT
(&
mtı
->
rcv_br_li¡
);

1077 
	`TAILQ_INIT
(&
mtı
->
¢d_br_li¡
);

1080  
mtı
;

1081 
	}
}

1084 
	$MTCPRunTh»ad
(*
¬g
)

1086 
mùx_t
 
mùx
 = (mùx_t)
¬g
;

1087 
ıu
 = 
mùx
->cpu;

1088 
wÜkšg
;

1089 
mtı_mªag”
 *
mtı
;

1090 
mtı_th»ad_cÚ‹xt
 *
ùx
;

1093 
	`mtı_cÜe_affš™ize
(
ıu
);

1097 
ùx
 = 
	`ÿÎoc
(1, (*ctx));

1098 ià(!
ùx
) {

1099 
	`³¼Ü
("calloc");

1100 
	`TRACE_ERROR
("Failedo calloc mtcp context.\n");

1101 
	`ex™
(-1);

1103 
ùx
->
th»ad
 = 
	`±h»ad_£lf
();

1104 
ùx
->
ıu
 = cpu;

1105 
mtı
 = 
ùx
->
mtı_mªag”
 = 
	`In™ŸlizeMTCPMªag”
(ctx);

1106 ià(!
mtı
) {

1107 
	`TRACE_ERROR
("Failedo initialize mtcp manager.\n");

1108 
	`ex™
(-1);

1112 
mtı
->
iom
 = 
cu¼’t_iomoduË_func
;

1115 
mtı
->
iom
->
	`š™_hªdË
(
ùx
);

1117 ià(
	`±h»ad_mu‹x_š™
(&
ùx
->
sm­_lock
, 
NULL
)) {

1118 
	`³¼Ü
("pthread_mutex_init of ctx->smap_lock\n");

1119 
	`ex™
(-1);

1122 ià(
	`±h»ad_mu‹x_š™
(&
ùx
->
æow_poŞ_lock
, 
NULL
)) {

1123 
	`³¼Ü
("pthread_mutex_init of ctx->flow_pool_lock\n");

1124 
	`ex™
(-1);

1127 ià(
	`±h»ad_mu‹x_š™
(&
ùx
->
sock‘_poŞ_lock
, 
NULL
)) {

1128 
	`³¼Ü
("pthread_mutex_init of ctx->socket_pool_lock\n");

1129 
	`ex™
(-1);

1132 
	`SQ_LOCK_INIT
(&
ùx
->
cÚÃù_lock
, "ùx->cÚÃù_lock", 
	`ex™
(-1));

1133 
	`SQ_LOCK_INIT
(&
ùx
->
şo£_lock
, "ùx->şo£_lock", 
	`ex™
(-1));

1134 
	`SQ_LOCK_INIT
(&
ùx
->
»£t_lock
, "ùx->»£t_lock", 
	`ex™
(-1));

1135 
	`SQ_LOCK_INIT
(&
ùx
->
£ndq_lock
, "ùx->£ndq_lock", 
	`ex™
(-1));

1136 
	`SQ_LOCK_INIT
(&
ùx
->
ackq_lock
, "ùx->ackq_lock", 
	`ex™
(-1));

1137 
	`SQ_LOCK_INIT
(&
ùx
->
de¡royq_lock
, "ùx->de¡royq_lock", 
	`ex™
(-1));

1140 
g_pùx
[
ıu
] = 
ùx
;

1141 
	`mlock®l
(
MCL_CURRENT
);

1144 
wÜkšg
 = 
	`A‰achDeviû
(
ùx
);

1145 ià(
wÜkšg
 != 0) {

1146 
	`³¼Ü
("attach");

1147  
NULL
;

1150 
	`TRACE_DBG
("CPU %d: in™Ÿliz©iÚ fšished.\n", 
ıu
);

1152 
	`årštf
(
¡d”r
, "CPU %d: in™Ÿliz©iÚ fšished.\n", 
ıu
);

1154 
	`£m_po¡
(&
g_š™_£m
[
ùx
->
ıu
]);

1157 
	`RunMašLoİ
(
ùx
);

1160 
	`De¡royHashbË
(
g_mtı
[
ıu
]->
tı_æow_bË
);

1161 
	`De¡royHashbË
(
g_mtı
[
ıu
]->
li¡’”s
);

1163 
	`TRACE_DBG
("MTCPh»ad %d fšished.\n", 
ùx
->
ıu
);

1166 
	}
}

1168 #iâdeà
DISABLE_DPDK


1169 
	$MTCPDPDKRunTh»ad
(*
¬g
)

1171 
	`MTCPRunTh»ad
(
¬g
);

1173 
	}
}

1176 
mùx_t


1177 
	$mtı_ü—‹_cÚ‹xt
(
ıu
)

1179 
mùx_t
 
mùx
;

1180 
»t
;

1182 ià(
ıu
 >ğ
CONFIG
.
num_cÜes
) {

1183 
	`TRACE_ERROR
("Failed initialize‚ew mtcp context. "

1185 
ıu
, 
CONFIG
.
num_cÜes
);

1186  
NULL
;

1190 ià(
g_logùx
[
ıu
] !ğ
NULL
) {

1191 
	`TRACE_ERROR
("%s was‡lready initialized before!\n",

1192 
__FUNCTION__
);

1193  
NULL
;

1196 
»t
 = 
	`£m_š™
(&
g_š™_£m
[
ıu
], 0, 0);

1197 ià(
»t
) {

1198 
	`TRACE_ERROR
("Failed initialize init_sem.\n");

1199  
NULL
;

1202 
mùx
 = (
mùx_t
)
	`ÿÎoc
(1, (
mtı_cÚ‹xt
));

1203 ià(!
mùx
) {

1204 
	`TRACE_ERROR
("Failedo‡llocate memory for mtcp_context.\n");

1205  
NULL
;

1207 
mùx
->
ıu
 = cpu;

1210 
g_logùx
[
ıu
] = (
log_th»ad_cÚ‹xt
 *)

1211 
	`ÿÎoc
(1, (
log_th»ad_cÚ‹xt
));

1212 ià(!
g_logùx
[
ıu
]) {

1213 
	`³¼Ü
("malloc");

1214 
	`TRACE_ERROR
("Failedo‡llocate memory for†oghread context.\n");

1215  
NULL
;

1217 
	`In™LogTh»adCÚ‹xt
(
g_logùx
[
ıu
], cpu);

1218 ià(
	`±h»ad_ü—‹
(&
log_th»ad
[
ıu
],

1219 
NULL
, 
Th»adLogMaš
, (*)
g_logùx
[
ıu
])) {

1220 
	`³¼Ü
("pthread_create");

1221 
	`TRACE_ERROR
("Failedo create†oghread\n");

1222  
NULL
;

1226 ià(
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) {

1227 #iâdeà
DISABLE_DPDK


1228 
ma¡”
;

1229 
ma¡”
 = 
	`¹e_g‘_ma¡”_lcÜe
();

1230 ià(
ma¡”
 =ğ
ıu
) {

1231 
lcÜe_cÚfig
[
ma¡”
].
»t
 = 0;

1232 
lcÜe_cÚfig
[
ma¡”
].
¡©e
 = 
FINISHED
;

1233 ià(
	`±h»ad_ü—‹
(&
g_th»ad
[
ıu
],

1234 
NULL
, 
MTCPRunTh»ad
, (*)
mùx
) != 0) {

1235 
	`TRACE_ERROR
("pthread_create of mtcphread failed!\n");

1236  
NULL
;

1239 
	`¹e_—l_»mÙe_Ïunch
(
MTCPDPDKRunTh»ad
, 
mùx
, 
ıu
);

1242 ià(
	`±h»ad_ü—‹
(&
g_th»ad
[
ıu
],

1243 
NULL
, 
MTCPRunTh»ad
, (*)
mùx
) != 0) {

1244 
	`TRACE_ERROR
("pthread_create of mtcphread failed!\n");

1245  
NULL
;

1249 
	`£m_wa™
(&
g_š™_£m
[
ıu
]);

1250 
	`£m_de¡roy
(&
g_š™_£m
[
ıu
]);

1252 
ruÂšg
[
ıu
] = 
TRUE
;

1254 ià(
mtı_ma¡”
 < 0) {

1255 
mtı_ma¡”
 = 
ıu
;

1256 
	`TRACE_INFO
("CPU %d i nowhma¡”h»ad.\n", 
mtı_ma¡”
);

1259  
mùx
;

1260 
	}
}

1263 
	$mtı_de¡roy_cÚ‹xt
(
mùx_t
 
mùx
)

1265 
mtı_th»ad_cÚ‹xt
 *
ùx
 = 
g_pùx
[
mùx
->
ıu
];

1266 
mtı_mªag”
 *
mtı
 = 
ùx
->mtcp_manager;

1267 
log_th»ad_cÚ‹xt
 *
log_ùx
 = 
mtı
->
logg”
;

1268 
»t
, 
i
;

1270 
	`TRACE_DBG
("CPU %d: mtı_de¡roy_cÚ‹xt()\n", 
mùx
->
ıu
);

1273 ià(!
ùx
->
ex™
) {

1274 
i
 = 0; i < 
CONFIG
.
max_cÚcu¼’cy
; i++) {

1275 ià(
mtı
->
sm­
[
i
].
sockty³
 =ğ
MTCP_SOCK_STREAM
) {

1276 
	`TRACE_DBG
("Closing„emaining socket %d (%s)\n",

1277 
i
, 
	`TCPS‹ToSŒšg
(
mtı
->
sm­
[i].
¡»am
));

1278 #ifdeà
DUMP_STREAM


1279 
	`DumpSŒ—m
(
mtı
, mtı->
sm­
[
i
].
¡»am
);

1281 
	`mtı_şo£
(
mùx
, 
i
);

1286 
ùx
->
dÚe
 = 1;

1290 ià(
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) {

1291 #iâdeà
DISABLE_DPDK


1292 
ma¡”
 = 
	`¹e_g‘_ma¡”_lcÜe
();

1293 ià(
ma¡”
 =ğ
mùx
->
ıu
)

1294 
	`±h»ad_još
(
g_th»ad
[
mùx
->
ıu
], 
NULL
);

1296 
	`¹e_—l_wa™_lcÜe
(
mùx
->
ıu
);

1299 
	`±h»ad_još
(
g_th»ad
[
mùx
->
ıu
], 
NULL
);

1301 
	`TRACE_INFO
("MTCPh»ad %d jošed.\n", 
mùx
->
ıu
);

1302 
ruÂšg
[
mùx
->
ıu
] = 
FALSE
;

1304 ià(
mtı_ma¡”
 =ğ
mùx
->
ıu
) {

1305 
i
 = 0; i < 
num_ıus
; i++) {

1306 ià(
i
 !ğ
mùx
->
ıu
 && 
ruÂšg
[i]) {

1307 
mtı_ma¡”
 = 
i
;

1313 
log_ùx
->
dÚe
 = 1;

1314 
»t
 = 
	`wr™e
(
log_ùx
->
·œ_¥_fd
, "F", 1);

1315 
	`as£¹
(
»t
 == 1);

1316 
	`UNUSED
(
»t
);

1317 
	`±h»ad_još
(
log_th»ad
[
ùx
->
ıu
], 
NULL
);

1318 
	`fşo£
(
mtı
->
log_å
);

1319 
	`TRACE_LOG
("Logh»ad %d jošed.\n", 
mùx
->
ıu
);

1321 ià(
mtı
->
cÚÃùq
) {

1322 
	`De¡roySŒ—mQueue
(
mtı
->
cÚÃùq
);

1323 
mtı
->
cÚÃùq
 = 
NULL
;

1325 ià(
mtı
->
£ndq
) {

1326 
	`De¡roySŒ—mQueue
(
mtı
->
£ndq
);

1327 
mtı
->
£ndq
 = 
NULL
;

1329 ià(
mtı
->
ackq
) {

1330 
	`De¡roySŒ—mQueue
(
mtı
->
ackq
);

1331 
mtı
->
ackq
 = 
NULL
;

1333 ià(
mtı
->
şo£q
) {

1334 
	`De¡roySŒ—mQueue
(
mtı
->
şo£q
);

1335 
mtı
->
şo£q
 = 
NULL
;

1337 ià(
mtı
->
şo£q_št
) {

1338 
	`De¡royIÁ”ÇlSŒ—mQueue
(
mtı
->
şo£q_št
);

1339 
mtı
->
şo£q_št
 = 
NULL
;

1341 ià(
mtı
->
»£tq
) {

1342 
	`De¡roySŒ—mQueue
(
mtı
->
»£tq
);

1343 
mtı
->
»£tq
 = 
NULL
;

1345 ià(
mtı
->
»£tq_št
) {

1346 
	`De¡royIÁ”ÇlSŒ—mQueue
(
mtı
->
»£tq_št
);

1347 
mtı
->
»£tq_št
 = 
NULL
;

1349 ià(
mtı
->
de¡royq
) {

1350 
	`De¡roySŒ—mQueue
(
mtı
->
de¡royq
);

1351 
mtı
->
de¡royq
 = 
NULL
;

1354 
	`De¡royMTCPS’d”
(
mtı
->
g_£nd”
);

1355 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

1356 
	`De¡royMTCPS’d”
(
mtı
->
n_£nd”
[
i
]);

1359 
	`MPDe¡roy
(
mtı
->
rv_poŞ
);

1360 
	`MPDe¡roy
(
mtı
->
sv_poŞ
);

1361 
	`MPDe¡roy
(
mtı
->
æow_poŞ
);

1363 ià(
mtı
->
­
) {

1364 
	`De¡royAdd»ssPoŞ
(
mtı
->
­
);

1367 
	`SQ_LOCK_DESTROY
(&
ùx
->
cÚÃù_lock
);

1368 
	`SQ_LOCK_DESTROY
(&
ùx
->
şo£_lock
);

1369 
	`SQ_LOCK_DESTROY
(&
ùx
->
»£t_lock
);

1370 
	`SQ_LOCK_DESTROY
(&
ùx
->
£ndq_lock
);

1371 
	`SQ_LOCK_DESTROY
(&
ùx
->
ackq_lock
);

1372 
	`SQ_LOCK_DESTROY
(&
ùx
->
de¡royq_lock
);

1375 
mtı
->
iom
->
	`de¡roy_hªdË
(
ùx
);

1376 
	`ä“
(
ùx
);

1377 
	`ä“
(
mùx
);

1378 
	}
}

1380 
mtı_sighªdËr_t


1381 
	$mtı_»gi¡”_sigÇl
(
signum
, 
mtı_sighªdËr_t
 
hªdËr
)

1383 
mtı_sighªdËr_t
 
´ev
;

1385 ià(
signum
 =ğ
SIGINT
) {

1386 
´ev
 = 
­p_sigÇl_hªdËr
;

1387 
­p_sigÇl_hªdËr
 = 
hªdËr
;

1389 ià((
´ev
 = 
	`sigÇl
(
signum
, 
hªdËr
)è=ğ
SIG_ERR
) {

1390 
	`³¼Ü
("signal");

1391  
SIG_ERR
;

1395  
´ev
;

1396 
	}
}

1399 
	$mtı_g‘cÚf
(
mtı_cÚf
 *
cÚf
)

1401 ià(!
cÚf
)

1404 
cÚf
->
num_cÜes
 = 
CONFIG
.num_cores;

1405 
cÚf
->
max_cÚcu¼’cy
 = 
CONFIG
.max_concurrency;

1407 
cÚf
->
max_num_bufãrs
 = 
CONFIG
.max_num_buffers;

1408 
cÚf
->
rcvbuf_size
 = 
CONFIG
.rcvbuf_size;

1409 
cÚf
->
¢dbuf_size
 = 
CONFIG
.sndbuf_size;

1411 
cÚf
->
tı_timewa™
 = 
CONFIG
.tcp_timewait;

1412 
cÚf
->
tı_timeout
 = 
CONFIG
.tcp_timeout;

1415 
	}
}

1418 
	$mtı_£tcÚf
(cÚ¡ 
mtı_cÚf
 *
cÚf
)

1420 ià(!
cÚf
)

1423 ià(
cÚf
->
num_cÜes
 > 0)

1424 
CONFIG
.
num_cÜes
 = 
cÚf
->num_cores;

1425 ià(
cÚf
->
max_cÚcu¼’cy
 > 0)

1426 
CONFIG
.
max_cÚcu¼’cy
 = 
cÚf
->max_concurrency;

1427 ià(
cÚf
->
max_num_bufãrs
 > 0)

1428 
CONFIG
.
max_num_bufãrs
 = 
cÚf
->max_num_buffers;

1429 ià(
cÚf
->
rcvbuf_size
 > 0)

1430 
CONFIG
.
rcvbuf_size
 = 
cÚf
->rcvbuf_size;

1431 ià(
cÚf
->
¢dbuf_size
 > 0)

1432 
CONFIG
.
¢dbuf_size
 = 
cÚf
->sndbuf_size;

1434 ià(
cÚf
->
tı_timewa™
 > 0)

1435 
CONFIG
.
tı_timewa™
 = 
cÚf
->tcp_timewait;

1436 ià(
cÚf
->
tı_timeout
 > 0)

1437 
CONFIG
.
tı_timeout
 = 
cÚf
->tcp_timeout;

1439 
	`TRACE_CONFIG
("Configuration updated by mtcp_setconf().\n");

1443 
	}
}

1446 
	$mtı_š™
(cÚ¡ *
cÚfig_fe
)

1448 
i
;

1449 
»t
;

1451 ià(
	`g‘euid
()) {

1452 
	`TRACE_CONFIG
("[CAUTION] Runhe‡pp‡s„oot!\n");

1453 
	`ex™
(
EXIT_FAILURE
);

1459 
num_ıus
 = (
CONFIG
.
num_cÜes
 =ğ0è? 
	`G‘NumCPUs
() : CONFIG.num_cores;

1461 
	`as£¹
(
num_ıus
 >= 1);

1463 ià(
num_ıus
 > 
MAX_CPUS
) {

1464 
	`TRACE_ERROR
("You cannot„un mTCP with morehan %d cores due "

1467 
MAX_CPUS
, 
num_ıus
 - MAX_CPUS);

1468 
	`ex™
(
EXIT_FAILURE
);

1471 
i
 = 0; i < 
num_ıus
; i++) {

1472 
g_mtı
[
i
] = 
NULL
;

1473 
ruÂšg
[
i
] = 
FALSE
;

1474 
sigšt_út
[
i
] = 0;

1477 
»t
 = 
	`LßdCÚfigu¿tiÚ
(
cÚfig_fe
);

1478 ià(
»t
) {

1479 
	`TRACE_CONFIG
("Error occured while†oading configuration.\n");

1482 
	`PrštCÚfigu¿tiÚ
();

1484 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

1485 
­
[
i
] = 
	`C»©eAdd»ssPoŞ
(
CONFIG
.
‘hs
[i].
_addr
, 1);

1486 ià(!
­
[
i
]) {

1487 
	`TRACE_CONFIG
("Error occured while create‡ddress…ool[%d]\n",

1488 
i
);

1493 
	`PrštIÁ”çûInfo
();

1495 
»t
 = 
	`S‘RoutšgTabË
();

1496 ià(
»t
) {

1497 
	`TRACE_CONFIG
("Error occured while†oading„outingable.\n");

1500 
	`PrštRoutšgTabË
();

1505 ià(
	`sigÇl
(
SIGUSR1
, 
HªdËSigÇl
è=ğ
SIG_ERR
) {

1506 
	`³¼Ü
("signal, SIGUSR1");

1509 ià(
	`sigÇl
(
SIGINT
, 
HªdËSigÇl
è=ğ
SIG_ERR
) {

1510 
	`³¼Ü
("signal, SIGINT");

1513 
­p_sigÇl_hªdËr
 = 
NULL
;

1519 
	}
}

1522 
	$mtı_de¡roy
()

1524 
i
;

1527 
i
 = 0; i < 
num_ıus
; i++) {

1528 ià(
ruÂšg
[
i
]) {

1529 
	`±h»ad_još
(
g_th»ad
[
i
], 
NULL
);

1533 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++)

1534 
	`De¡royAdd»ssPoŞ
(
­
[
i
]);

1536 
	`TRACE_INFO
("All MTCPhreads‡re joined.\n");

1537 
	}
}

	@cpu.cpp

1 #iâdeà
_GNU_SOURCE


2 
	#_GNU_SOURCE


	)

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

7 
	~<”ºo.h
>

8 
	~<numa.h
>

9 
	~<sched.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/sysÿÎ.h
>

12 
	~<as£¹.h
>

13 
	~"mtı_­i.h
"

15 
	#MAX_FILE_NAME
 1024

	)

19 
	$G‘NumCPUs
()

21  
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

22 
	}
}

24 
pid_t


25 
	$G‘tid
()

27  
	`sysÿÎ
(
__NR_g‘tid
);

28 
	}
}

31 
	$mtı_cÜe_affš™ize
(
ıu
)

33 
ıu_£t_t
 
ıus
;

34 
b™mask
 *
bmask
;

35 
FILE
 *
å
;

36 
sysâame
[
MAX_FILE_NAME
];

37 
phy_id
;

38 
size_t
 
n
;

39 
»t
;

40 
unu£d
;

42 
n
 = 
	`G‘NumCPUs
();

44 ià(
ıu
 < 0 || cpu >ğ(è
n
) {

45 
”ºo
 = -
EINVAL
;

49 
	`CPU_ZERO
(&
ıus
);

50 
	`CPU_SET
(()
ıu
, &
ıus
);

52 
»t
 = 
	`sched_£ffš™y
(
	`G‘tid
(), (
ıus
), &cpus);

79  
»t
;

80 
	}
}

	@debug.cpp

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<¡ršg.h
>

4 
	~<¡dšt.h
>

5 
	~<¡d¬g.h
>

6 
	~"debug.h
"

7 
	~"tı_š.h
"

8 
	~"logg”.h
"

11 
	$æush_log_d©a
(
mtı_mªag”_t
 
mtı
)

13 
»t
 = 0;

14 ià(
mtı
->
w_bufãr
) {

15 
	`EnqueueJobBufãr
(
mtı
->
logg”
, mtı->
w_bufãr
);

16 
»t
 = 
	`wr™e
(
mtı
->
¥_fd
, "A", 1);

17 ià(
»t
 != 1) {

18 
	`TRACE_INFO
("Failedo flush†ogs inhe buffer.\n");

19 
	`³¼Ü
("write() for…ipe");

22 
	}
}

25 
	$th»ad_´štf
(
mtı_mªag”_t
 
mtı
, 
FILE
* 
f_idx
, cÚ¡ * 
_FÜm©
, ...)

27 
va_li¡
 
¬g±r
;

28 
	`va_¡¬t
(
¬g±r
, 
_FÜm©
);

30 
	#PRINT_LIMIT
 4096

	)

31 
Ën
;

32 
log_buff
 *
wbuf
;

34 
	`as£¹
(
f_idx
 !ğ
NULL
);

36 
	`±h»ad_mu‹x_lock
(&
mtı
->
logg”
->
mu‹x
);

37 
wbuf
 = 
mtı
->
w_bufãr
;

38 ià(
wbuf
 && (wbuf->
buff_Ën
 + 
PRINT_LIMIT
 > 
LOG_BUFF_SIZE
)) {

39 
	`æush_log_d©a
(
mtı
);

40 
wbuf
 = 
NULL
;

43 ià(!
wbuf
) {

45 
wbuf
 = 
	`DequeueF»eBufãr
(
mtı
->
logg”
);

46 
	`as£¹
(
wbuf
);

47 } !
wbuf
);

48 
wbuf
->
buff_Ën
 = 0;

49 
wbuf
->
tid
 = 
mtı
->
ùx
->
ıu
;

50 
wbuf
->
fid
 = 
f_idx
;

51 
mtı
->
w_bufãr
 = 
wbuf
;

54 
Ën
 = 
	`v¢´štf
(
wbuf
->
buff
 + wbuf->
buff_Ën
, 
PRINT_LIMIT
, 
_FÜm©
, 
¬g±r
);

55 
wbuf
->
buff_Ën
 +ğ
Ën
;

56 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
logg”
->
mu‹x
);

58 
	`va_’d
(
¬g±r
);

60 
	}
}

63 
	$DumpPack‘
(
mtı_mªag”_t
 
mtı
, *
buf
, 
Ën
, *
¡•
, 
ifšdex
)

65 
‘hhdr
 *
‘hh
;

66 
hdr
 *
h
;

67 
udphdr
 *
udph
;

68 
tıhdr
 *
tıh
;

69 
ušt8_t
 *
t
;

71 ià(
ifšdex
 >= 0)

72 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "% %d %u", 
¡•
, 
ifšdex
, mtı->
cur_ts
);

74 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "% ? %u", 
¡•
, mtı->
cur_ts
);

76 
‘hh
 = (
‘hhdr
 *)
buf
;

77 ià(
	`Áohs
(
‘hh
->
h_´Ùo
è!ğ
ETH_P_IP
) {

78 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "%02X:%02X:%02X:%02X:%02X:%02X -> %02X:%02X:%02X:%02X:%02X:%02X ",

79 
‘hh
->
h_sourû
[0],

80 
‘hh
->
h_sourû
[1],

81 
‘hh
->
h_sourû
[2],

82 
‘hh
->
h_sourû
[3],

83 
‘hh
->
h_sourû
[4],

84 
‘hh
->
h_sourû
[5],

85 
‘hh
->
h_de¡
[0],

86 
‘hh
->
h_de¡
[1],

87 
‘hh
->
h_de¡
[2],

88 
‘hh
->
h_de¡
[3],

89 
‘hh
->
h_de¡
[4],

90 
‘hh
->
h_de¡
[5]);

92 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "´ÙocŞ %04hx ", 
	`Áohs
(
‘hh
->
h_´Ùo
));

93 
dÚe
;

96 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " ");

98 
h
 = (
hdr
 *)(
‘hh
 + 1);

99 
udph
 = (
udphdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

100 
tıh
 = (
tıhdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

102 
t
 = (
ušt8_t
 *)&
h
->
§ddr
;

103 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

104 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

105 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(%d)", 
	`Áohs
(
udph
->
sourû
));

107 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " -> ");

109 
t
 = (
ušt8_t
 *)&
h
->
daddr
;

110 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

111 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

112 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(%d)", 
	`Áohs
(
udph
->
de¡
));

114 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " IP_ID=%d", 
	`Áohs
(
h
->
id
));

115 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " TTL=%d ", 
h
->
‰l
);

117 ià(
	`_ç¡_csum
(
h
, iph->
ihl
)) {

118 
__sum16
 
Üg_csum
, 
cÜ»ù_csum
;

120 
Üg_csum
 = 
h
->
check
;

121 
h
->
check
 = 0;

122 
cÜ»ù_csum
 = 
	`_ç¡_csum
(
h
, iph->
ihl
);

123 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(bad checksum %04x should be %04x) ",

124 
	`Áohs
(
Üg_csum
),‚tohs(
cÜ»ù_csum
));

125 
h
->
check
 = 
Üg_csum
;

128 
h
->
´ÙocŞ
) {

129 
IPPROTO_TCP
:

130 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "TCP ");

132 ià(
tıh
->
syn
)

133 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "S ");

134 ià(
tıh
->
fš
)

135 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "F ");

136 ià(
tıh
->
ack
)

137 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "A ");

138 ià(
tıh
->
r¡
)

139 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "R ");

141 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "£q %u ", 
	`Áohl
(
tıh
->
£q
));

142 ià(
tıh
->
ack
)

143 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "ack %u ", 
	`Áohl
(
tıh
->
ack_£q
));

144 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "WDW=%u ", 
	`Áohs
(
tıh
->
wšdow
));

146 
IPPROTO_UDP
:

147 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "UDP ");

150 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "´ÙocŞ %d ", 
h
->
´ÙocŞ
);

151 
dÚe
;

153 
dÚe
:

154 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Ën=%d\n", 
Ën
);

155 
	}
}

158 
	$DumpIPPack‘
(
mtı_mªag”_t
 
mtı
, cÚ¡ 
hdr
 *
h
, 
Ën
)

160 
udphdr
 *
udph
;

161 
tıhdr
 *
tıh
;

162 
ušt8_t
 *
t
;

164 
udph
 = (
udphdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

165 
tıh
 = (
tıhdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

167 
t
 = (
ušt8_t
 *)&
h
->
§ddr
;

168 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

169 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

170 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(%d)", 
	`Áohs
(
udph
->
sourû
));

172 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " -> ");

174 
t
 = (
ušt8_t
 *)&
h
->
daddr
;

175 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

176 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

177 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(%d)", 
	`Áohs
(
udph
->
de¡
));

179 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " IP_ID=%d", 
	`Áohs
(
h
->
id
));

180 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, " TTL=%d ", 
h
->
‰l
);

182 ià(
	`_ç¡_csum
(
h
, iph->
ihl
)) {

183 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "(bad checksum) ");

186 
h
->
´ÙocŞ
) {

187 
IPPROTO_TCP
:

188 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "TCP ");

190 ià(
tıh
->
syn
)

191 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "S ");

192 ià(
tıh
->
fš
)

193 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "F ");

194 ià(
tıh
->
ack
)

195 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "A ");

196 ià(
tıh
->
r¡
)

197 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "R ");

199 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "£q %u ", 
	`Áohl
(
tıh
->
£q
));

200 ià(
tıh
->
ack
)

201 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "ack %u ", 
	`Áohl
(
tıh
->
ack_£q
));

202 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "WDW=%u ", 
	`Áohs
(
tıh
->
wšdow
));

204 
IPPROTO_UDP
:

205 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "UDP ");

208 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "´ÙocŞ %d ", 
h
->
´ÙocŞ
);

209 
dÚe
;

211 
dÚe
:

212 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Ën=%d\n", 
Ën
);

213 
	}
}

216 
	$DumpIPPack‘ToFe
(
FILE
 *
fout
, cÚ¡ 
hdr
 *
h
, 
Ën
)

218 
udphdr
 *
udph
;

219 
tıhdr
 *
tıh
;

220 
ušt8_t
 *
t
;

222 
udph
 = (
udphdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

223 
tıh
 = (
tıhdr
 *)((
ušt32_t
 *)
h
 + iph->
ihl
);

225 
t
 = (
ušt8_t
 *)&
h
->
§ddr
;

226 
	`årštf
(
fout
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

227 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

228 
	`årštf
(
fout
, "(%d)", 
	`Áohs
(
udph
->
sourû
));

230 
	`årštf
(
fout
, " -> ");

232 
t
 = (
ušt8_t
 *)&
h
->
daddr
;

233 
	`årštf
(
fout
, "%u.%u.%u.%u", 
t
[0],[1],[2],[3]);

234 ià(
h
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 || iph->´ÙocŞ =ğ
IPPROTO_UDP
)

235 
	`årštf
(
fout
, "(%d)", 
	`Áohs
(
udph
->
de¡
));

237 
	`årštf
(
fout
, " IP_ID=%d", 
	`Áohs
(
h
->
id
));

238 
	`årštf
(
fout
, " TTL=%d ", 
h
->
‰l
);

240 ià(
	`_ç¡_csum
(
h
, iph->
ihl
)) {

241 
	`årštf
(
fout
, "(bad checksum) ");

244 
h
->
´ÙocŞ
) {

245 
IPPROTO_TCP
:

246 
	`årštf
(
fout
, "TCP ");

248 ià(
tıh
->
syn
)

249 
	`årštf
(
fout
, "S ");

250 ià(
tıh
->
fš
)

251 
	`årštf
(
fout
, "F ");

252 ià(
tıh
->
ack
)

253 
	`årštf
(
fout
, "A ");

254 ià(
tıh
->
r¡
)

255 
	`årštf
(
fout
, "R ");

257 
	`årštf
(
fout
, "£q %u ", 
	`Áohl
(
tıh
->
£q
));

258 ià(
tıh
->
ack
)

259 
	`årštf
(
fout
, "ack %u ", 
	`Áohl
(
tıh
->
ack_£q
));

260 
	`årštf
(
fout
, "WDW=%u ", 
	`Áohs
(
tıh
->
wšdow
));

262 
IPPROTO_UDP
:

263 
	`årštf
(
fout
, "UDP ");

266 
	`årštf
(
fout
, "´ÙocŞ %d ", 
h
->
´ÙocŞ
);

267 
dÚe
;

269 
dÚe
:

270 
	`årštf
(
fout
, "Ën=%d\n", 
Ën
);

271 
	}
}

	@dpdk_module.cpp

2 
	~"io_moduË.h
"

3 #iâdeà
DISABLE_DPDK


5 
	~"mtı.h
"

7 
	~<”ºo.h
>

9 
	~"debug.h
"

11 
	~"cÚfig.h
"

13 
	~<¹e_commÚ.h
>

15 
	~<¹e_‘hdev.h
>

17 
	~<¹e_cyşes.h
>

18 
	~<¹e_”ºo.h
>

19 
	#ENABLE_STATS_IOCTL
 1

	)

20 #ifdeà
ENABLE_STATS_IOCTL


22 
	~<uni¡d.h
>

24 
	~<fú.h
>

26 
	~<sys/ioùl.h
>

29 
	~<¹e_.h
>

32 
	#MAX_RX_QUEUE_PER_LCORE
 
MAX_CPUS


	)

33 
	#MAX_TX_QUEUE_PER_PORT
 
MAX_CPUS


	)

35 #ifdeà
ENABLELRO


36 
	#MBUF_SIZE
 (16384 + (
¹e_mbuf
è+ 
RTE_PKTMBUF_HEADROOM
)

	)

38 
	#MBUF_SIZE
 (2048 + (
¹e_mbuf
è+ 
RTE_PKTMBUF_HEADROOM
)

	)

40 
	#NB_MBUF
 8192

	)

41 
	#MEMPOOL_CACHE_SIZE
 256

	)

43 
	#RX_IDLE_TIMEOUT
 1

	)

44 
	#RX_IDLE_THRESH
 64

	)

52 
	#RX_PTHRESH
 8

	)

53 
	#RX_HTHRESH
 8

	)

54 
	#RX_WTHRESH
 4

	)

61 
	#TX_PTHRESH
 36

	)

62 
	#TX_HTHRESH
 0

	)

63 
	#TX_WTHRESH
 0

	)

65 
	#MAX_PKT_BURST
 64

	)

70 
	#RTE_TEST_RX_DESC_DEFAULT
 128

	)

71 
	#RTE_TEST_TX_DESC_DEFAULT
 128

	)

73 
ušt16_t
 
	gnb_rxd
 = 
RTE_TEST_RX_DESC_DEFAULT
;

74 
ušt16_t
 
	gnb_txd
 = 
RTE_TEST_TX_DESC_DEFAULT
;

77 
¹e_mempoŞ
 *
	gpktmbuf_poŞ
[
MAX_CPUS
] = {
NULL
};

80 #ifdeà
DEBUG


82 
‘h”_addr
 
	gpÜts_‘h_addr
[
RTE_MAX_ETHPORTS
];

85 
¹e_‘h_dev_šfo
 
	gdev_šfo
[
RTE_MAX_ETHPORTS
];

87 
¹e_‘h_cÚf
 
	gpÜt_cÚf
 = {

88 .
rxmode
 = {

89 .
mq_mode
 = 
ETH_MQ_RX_RSS
,

90 .
	gmax_rx_pkt_Ën
 = 
ETHER_MAX_LEN
,

91 .
	g¥l™_hdr_size
 = 0,

92 .
	gh—d”_¥l™
 = 0,

93 .
	ghw__checksum
 = 1,

94 .
	ghw_vÏn_f‹r
 = 0,

95 .
	gjumbo_äame
 = 0,

96 .
	ghw_¡r_üc
 = 1,

97 #ifdeà
ENABLELRO


98 .
	g’abË_Ìo
 = 1,

101 .
	grx_adv_cÚf
 = {

102 .
rss_cÚf
 = {

103 .
rss_key
 = 
NULL
,

104 .
	grss_hf
 = 
ETH_RSS_TCP


107 .
	gtxmode
 = {

108 .
mq_mode
 = 
ETH_MQ_TX_NONE
,

112 cÚ¡ 
¹e_‘h_rxcÚf
 
	grx_cÚf
 = {

113 .
rx_th»sh
 = {

114 .
±h»sh
 = 
RX_PTHRESH
,

115 .
	ghth»sh
 = 
RX_HTHRESH
,

116 .
	gwth»sh
 = 
RX_WTHRESH
,

118 .
	grx_ä“_th»sh
 = 32,

121 cÚ¡ 
¹e_‘h_txcÚf
 
	gtx_cÚf
 = {

122 .
tx_th»sh
 = {

123 .
±h»sh
 = 
TX_PTHRESH
,

124 .
	ghth»sh
 = 
TX_HTHRESH
,

125 .
	gwth»sh
 = 
TX_WTHRESH
,

127 .
	gtx_ä“_th»sh
 = 0,

128 .
	gtx_rs_th»sh
 = 0,

133 .
	gtxq_æags
 = 0x0,

136 
	smbuf_bË
 {

137 
	mËn
;

138 
¹e_mbuf
 *
	mm_bË
[
MAX_PKT_BURST
];

141 
	sdpdk_´iv©e_cÚ‹xt
 {

142 
mbuf_bË
 
	mrmbufs
[
RTE_MAX_ETHPORTS
];

143 
mbuf_bË
 
	mwmbufs
[
RTE_MAX_ETHPORTS
];

144 
¹e_mempoŞ
 *
	mpktmbuf_poŞ
;

145 
¹e_mbuf
 *
	mpkts_bur¡
[
MAX_PKT_BURST
];

146 #ifdeà
RX_IDLE_ENABLE


147 
ušt8_t
 
	mrx_idË
;

149 #ifdeà
ENABLELRO


150 
¹e_mbuf
 *
	mcur_rx_m
;

152 #ifdeà
ENABLE_STATS_IOCTL


153 
	mfd
;

155 } 
	g__¹e_ÿche_®igÃd
;

157 #ifdeà
ENABLE_STATS_IOCTL


161 
	s¡©s_¡ruù
 {

162 
ušt64_t
 
	mtx_by‹s
;

163 
ušt64_t
 
	mtx_pkts
;

164 
ušt64_t
 
	mrx_by‹s
;

165 
ušt64_t
 
	mrx_pkts
;

166 
ušt8_t
 
	mqid
;

167 
ušt8_t
 
	mdev
;

172 
	$dpdk_š™_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

174 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

175 
i
, 
j
;

176 
mempoŞ_Çme
[20];

179 
ùxt
->
io_´iv©e_cÚ‹xt
 = 
	`ÿÎoc
(1, (
dpdk_´iv©e_cÚ‹xt
));

180 ià(
ùxt
->
io_´iv©e_cÚ‹xt
 =ğ
NULL
) {

181 
	`TRACE_ERROR
("Failedo initialize ctxt->io_private_context: "

183 
	`ex™
(
EXIT_FAILURE
);

186 
	`¥rštf
(
mempoŞ_Çme
, "mbuf_poŞ-%d", 
ùxt
->
ıu
);

187 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

188 
dpc
->
pktmbuf_poŞ
 =…ktmbuf_poŞ[
ùxt
->
ıu
];

191 
j
 = 0; j < 
num_deviûs_©ched
; j++) {

193 
i
 = 0; i < 
MAX_PKT_BURST
; i++) {

194 
dpc
->
wmbufs
[
j
].
m_bË
[
i
] = 
	`¹e_pktmbuf_®loc
(
pktmbuf_poŞ
[
ùxt
->
ıu
]);

195 ià(
dpc
->
wmbufs
[
j
].
m_bË
[
i
] =ğ
NULL
) {

196 
	`TRACE_ERROR
("Failedo‡llocate %d:wmbuf[%d] on device %d!\n",

197 
ùxt
->
ıu
, 
i
, 
j
);

198 
	`ex™
(
EXIT_FAILURE
);

202 
dpc
->
wmbufs
[
j
].
Ën
 = 0;

205 #ifdeà
ENABLE_STATS_IOCTL


206 
dpc
->
fd
 = 
	`İ’
("/dev/dpdk-içû", 
O_RDWR
);

207 ià(
dpc
->
fd
 == -1) {

208 
	`TRACE_ERROR
("Can't open /dev/dpdk-iface for context->cpu: %d! "

210 
ùxt
->
ıu
);

213 
	}
}

216 
	$dpdk_lšk_deviûs
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

221 
	}
}

224 
	$dpdk_»Ëa£_pkt
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, *
pkt_d©a
, 
Ën
)

230 
	}
}

233 
	$dpdk_£nd_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
)

235 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

236 
mtı_mªag”_t
 
mtı
;

237 
»t
, 
i
;

239 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

240 
mtı
 = 
ùxt
->
mtı_mªag”
;

241 
»t
 = 0;

244 ià(
dpc
->
wmbufs
[
nif
].
Ën
 > 0) {

245 
¹e_mbuf
 **
pkts
;

246 #ifdeà
ENABLE_STATS_IOCTL


247 
¡©s_¡ruù
 
ss
;

249 
út
 = 
dpc
->
wmbufs
[
nif
].
Ën
;

250 
pkts
 = 
dpc
->
wmbufs
[
nif
].
m_bË
;

251 #ifdeà
NETSTAT


252 
mtı
->
n¡©
.
tx_·ck‘s
[
nif
] +ğ
út
;

253 #ifdeà
ENABLE_STATS_IOCTL


254 ià(
	`lik–y
(
dpc
->
fd
 >= 0)) {

255 
ss
.
tx_pkts
 = 
mtı
->
n¡©
.
tx_·ck‘s
[
nif
];

256 
ss
.
tx_by‹s
 = 
mtı
->
n¡©
.tx_by‹s[
nif
];

257 
ss
.
rx_pkts
 = 
mtı
->
n¡©
.
rx_·ck‘s
[
nif
];

258 
ss
.
rx_by‹s
 = 
mtı
->
n¡©
.rx_by‹s[
nif
];

259 
ss
.
qid
 = 
ùxt
->
ıu
;

260 
ss
.
dev
 = 
nif
;

261 
	`ioùl
(
dpc
->
fd
, 0, &
ss
);

267 
»t
 = 
	`¹e_‘h_tx_bur¡
(
nif
, 
ùxt
->
ıu
,

268 
pkts
, 
út
);

269 
pkts
 +ğ
»t
;

270 
út
 -ğ
»t
;

272 } 
út
 > 0);

275 
i
 = 0; i < 
dpc
->
wmbufs
[
nif
].
Ën
; i++) {

276 
dpc
->
wmbufs
[
nif
].
m_bË
[
i
] = 
	`¹e_pktmbuf_®loc
(
pktmbuf_poŞ
[
ùxt
->
ıu
]);

278 ià(
	`uÆik–y
(
dpc
->
wmbufs
[
nif
].
m_bË
[
i
] =ğ
NULL
)) {

279 
	`TRACE_ERROR
("Failedo‡llocate %d:wmbuf[%d] on device %d!\n",

280 
ùxt
->
ıu
, 
i
, 
nif
);

281 
	`ex™
(
EXIT_FAILURE
);

285 
dpc
->
wmbufs
[
nif
].
Ën
 = 0;

288  
»t
;

289 
	}
}

291 
ušt8_t
 *

292 
	$dpdk_g‘_w±r
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
, 
ušt16_t
 
pktsize
)

294 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

295 
mtı_mªag”_t
 
mtı
;

296 
¹e_mbuf
 *
m
;

297 
ušt8_t
 *
±r
;

298 
Ën_of_mbuf
;

300 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

301 
mtı
 = 
ùxt
->
mtı_mªag”
;

304 ià(
	`uÆik–y
(
dpc
->
wmbufs
[
nif
].
Ën
 =ğ
MAX_PKT_BURST
))

305  
NULL
;

307 
Ën_of_mbuf
 = 
dpc
->
wmbufs
[
nif
].
Ën
;

308 
m
 = 
dpc
->
wmbufs
[
nif
].
m_bË
[
Ën_of_mbuf
];

311 
±r
 = (*)
	`¹e_pktmbuf_mtod
(
m
, 
‘h”_hdr
 *);

312 
m
->
pkt_Ën
 = m->
d©a_Ën
 = 
pktsize
;

313 
m
->
nb_£gs
 = 1;

314 
m
->
Ãxt
 = 
NULL
;

316 #ifdeà
NETSTAT


317 
mtı
->
n¡©
.
tx_by‹s
[
nif
] +ğ
pktsize
 + 24;

321 
dpc
->
wmbufs
[
nif
].
Ën
 = 
Ën_of_mbuf
 + 1;

323  (
ušt8_t
 *)
±r
;

324 
	}
}

326 
šlše
 

327 
	$ä“_pkts
(
¹e_mbuf
 **
mbË
, 
Ën
)

329 
i
;

332 
i
 = 0; i < 
Ën
; i++) {

333 
	`¹e_pktmbuf_ä“
(
mbË
[
i
]);

334 
	`RTE_MBUF_PREFETCH_TO_FREE
(
mbË
[
i
+1]);

336 
	}
}

338 
št32_t


339 
	$dpdk_»cv_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
)

341 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

342 
»t
;

344 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

346 ià(
dpc
->
rmbufs
[
ifidx
].
Ën
 != 0) {

347 
	`ä“_pkts
(
dpc
->
rmbufs
[
ifidx
].
m_bË
, dpc->rmbufs[ifidx].
Ën
);

348 
dpc
->
rmbufs
[
ifidx
].
Ën
 = 0;

351 
»t
 = 
	`¹e_‘h_rx_bur¡
((
ušt8_t
)
ifidx
, 
ùxt
->
ıu
,

352 
dpc
->
pkts_bur¡
, 
MAX_PKT_BURST
);

353 #ifdeà
RX_IDLE_ENABLE


354 
dpc
->
rx_idË
 = (
	`lik–y
(
»t
 != 0)) ? 0 : dpc->rx_idle + 1;

356 
dpc
->
rmbufs
[
ifidx
].
Ën
 = 
»t
;

358  
»t
;

359 
	}
}

361 
ušt8_t
 *

362 
	$dpdk_g‘_½Œ
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, 
šdex
, 
ušt16_t
 *
Ën
)

364 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

365 
¹e_mbuf
 *
m
;

366 
ušt8_t
 *
pktbuf
;

368 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

370 
m
 = 
dpc
->
pkts_bur¡
[
šdex
];

372 *
Ën
 = 
m
->
pkt_Ën
;

373 
pktbuf
 = 
	`¹e_pktmbuf_mtod
(
m
, 
ušt8_t
 *);

376 
dpc
->
rmbufs
[
ifidx
].
m_bË
[
šdex
] = 
m
;

379 ià((
m
->
Ş_æags
 & (
PKT_RX_L4_CKSUM_BAD
 | 
PKT_RX_IP_CKSUM_BAD
)) != 0) {

380 
	`TRACE_ERROR
("%s(%p, %d, %d): mbuf with invalid checksum: "

382 
__func__
, 
ùxt
, 
ifidx
, 
šdex
, 
m
, m->
Ş_æags
);

383 
pktbuf
 = 
NULL
;

385 #ifdeà
ENABLELRO


386 
dpc
->
cur_rx_m
 = 
m
;

389  
pktbuf
;

390 
	}
}

392 
št32_t


393 
	$dpdk_£Ëù
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

395 #ifdeà
RX_IDLE_ENABLE


396 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

398 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

399 ià(
dpc
->
rx_idË
 > 
RX_IDLE_THRESH
) {

400 
dpc
->
rx_idË
 = 0;

401 
	`u¦“p
(
RX_IDLE_TIMEOUT
);

405 
	}
}

408 
	$dpdk_de¡roy_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

410 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

411 
i
;

413 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

416 
i
 = 0; i < 
num_deviûs_©ched
; i++)

417 
	`ä“_pkts
(
dpc
->
wmbufs
[
i
].
m_bË
, 
MAX_PKT_BURST
);

419 #ifdeà
ENABLE_STATS_IOCTL


421 ià(
dpc
->
fd
 >= 0)

422 
	`şo£
(
dpc
->
fd
);

426 
	`ä“
(
dpc
);

427 
	}
}

430 
	$check_®l_pÜts_lšk_¡©us
(
ušt8_t
 
pÜt_num
, 
ušt32_t
 
pÜt_mask
)

432 
	#CHECK_INTERVAL
 100

	)

433 
	#MAX_CHECK_TIME
 90

	)

435 
ušt8_t
 
pÜtid
, 
couÁ
, 
®l_pÜts_up
, 
´št_æag
 = 0;

436 
¹e_‘h_lšk
 
lšk
;

438 
	`´štf
("\nChecking†ink status");

439 
	`fæush
(
¡dout
);

440 
couÁ
 = 0; couÁ <ğ
MAX_CHECK_TIME
; count++) {

441 
®l_pÜts_up
 = 1;

442 
pÜtid
 = 0;…Ütid < 
pÜt_num
;…ortid++) {

443 ià((
pÜt_mask
 & (1 << 
pÜtid
)) == 0)

445 
	`mem£t
(&
lšk
, 0, (link));

446 
	`¹e_‘h_lšk_g‘_nowa™
(
pÜtid
, &
lšk
);

448 ià(
´št_æag
 == 1) {

449 ià(
lšk
.
lšk_¡©us
)

450 
	`´štf
("Port %d Link Up - speed %u "

451 "Mbp - %s\n", (
ušt8_t
)
pÜtid
,

452 ()
lšk
.
lšk_¥“d
,

453 (
lšk
.
lšk_du¶ex
 =ğ
ETH_LINK_FULL_DUPLEX
) ?

456 
	`´štf
("Port %d Link Down\n",

457 (
ušt8_t
)
pÜtid
);

461 ià(
lšk
.
lšk_¡©us
 == 0) {

462 
®l_pÜts_up
 = 0;

467 ià(
´št_æag
 == 1)

470 ià(
®l_pÜts_up
 == 0) {

471 
	`´štf
(".");

472 
	`fæush
(
¡dout
);

473 
	`¹e_d–ay_ms
(
CHECK_INTERVAL
);

477 ià(
®l_pÜts_up
 =ğ1 || 
couÁ
 =ğ(
MAX_CHECK_TIME
 - 1)) {

478 
´št_æag
 = 1;

479 
	`´štf
("done\n");

482 
	}
}

485 
	$dpdk_lßd_moduË
()

487 
pÜtid
, 
rxlcÜe_id
, 
»t
;

489 
¹e_‘h_fc_cÚf
 
fc_cÚf
;

491 cÚ¡ 
ušt8_t
 
key
[] = {

498 
pÜt_cÚf
.
rx_adv_cÚf
.
rss_cÚf
.
rss_key
 = (
ušt8_t
 *)&
key
;

499 
pÜt_cÚf
.
rx_adv_cÚf
.
rss_cÚf
.
rss_key_Ën
 = (
key
);

501 ià(!
CONFIG
.
muÉi_´oûss
 || (CONFIG.muÉi_´oûs && CONFIG.
muÉi_´oûss_is_ma¡”
)) {

502 
rxlcÜe_id
 = 0;„xlcÜe_id < 
CONFIG
.
num_cÜes
;„xlcore_id++) {

503 
Çme
[20];

504 
	`¥rštf
(
Çme
, "mbuf_poŞ-%d", 
rxlcÜe_id
);

506 
pktmbuf_poŞ
[
rxlcÜe_id
] =

507 
	`¹e_mempoŞ_ü—‹
(
Çme
, 
NB_MBUF
,

508 
MBUF_SIZE
, 
MEMPOOL_CACHE_SIZE
,

509 (
¹e_pktmbuf_poŞ_´iv©e
),

510 
¹e_pktmbuf_poŞ_š™
, 
NULL
,

511 
¹e_pktmbuf_š™
, 
NULL
,

512 
	`¹e_sock‘_id
(), 0);

513 ià(
pktmbuf_poŞ
[
rxlcÜe_id
] =ğ
NULL
)

514 
	`¹e_ex™
(
EXIT_FAILURE
, "Cannot init mbuf…ool,ƒrrno: %d\n",

515 
¹e_”ºo
);

519 
pÜtid
 = 0;…Ütid < 
num_deviûs_©ched
;…ortid++) {

521 
	`´štf
("In™Ÿlizšg…Üˆ%u... ", (è
pÜtid
);

522 
	`fæush
(
¡dout
);

523 
»t
 = 
	`¹e_‘h_dev_cÚfigu»
(
pÜtid
, 
CONFIG
.
num_cÜes
, CONFIG.num_cÜes, &
pÜt_cÚf
);

524 ià(
»t
 < 0)

525 
	`¹e_ex™
(
EXIT_FAILURE
, "Cannot configure device:ƒrr=%d,…ort=%u\n",

526 
»t
, (è
pÜtid
);

529 
	`fæush
(
¡dout
);

530 #ifdeà
DEBUG


531 
	`¹e_‘h_maÿddr_g‘
(
pÜtid
, &
pÜts_‘h_addr
[portid]);

534 
	`¹e_‘h_dev_šfo_g‘
(
pÜtid
, &
dev_šfo
[portid]);

536 
rxlcÜe_id
 = 0;„xlcÜe_id < 
CONFIG
.
num_cÜes
;„xlcore_id++) {

537 
»t
 = 
	`¹e_‘h_rx_queue_£tup
(
pÜtid
, 
rxlcÜe_id
, 
nb_rxd
,

538 
	`¹e_‘h_dev_sock‘_id
(
pÜtid
), &
rx_cÚf
,

539 
pktmbuf_poŞ
[
rxlcÜe_id
]);

540 ià(
»t
 < 0)

541 
	`¹e_ex™
(
EXIT_FAILURE
,

543 
»t
, (è
pÜtid
, 
rxlcÜe_id
);

547 
	`fæush
(
¡dout
);

548 
rxlcÜe_id
 = 0;„xlcÜe_id < 
CONFIG
.
num_cÜes
;„xlcore_id++) {

549 
»t
 = 
	`¹e_‘h_tx_queue_£tup
(
pÜtid
, 
rxlcÜe_id
, 
nb_txd
,

550 
	`¹e_‘h_dev_sock‘_id
(
pÜtid
), &
tx_cÚf
);

551 ià(
»t
 < 0)

552 
	`¹e_ex™
(
EXIT_FAILURE
,

554 
»t
, (è
pÜtid
, 
rxlcÜe_id
);

558 
»t
 = 
	`¹e_‘h_dev_¡¬t
(
pÜtid
);

559 ià(
»t
 < 0)

560 
	`¹e_ex™
(
EXIT_FAILURE
, "rte_eth_dev_start:err=%d,…ort=%u\n",

561 
»t
, (è
pÜtid
);

563 
	`´štf
("done: \n");

564 
	`¹e_‘h_´omiscuous_’abË
(
pÜtid
);

567 
	`mem£t
(&
fc_cÚf
, 0, (fc_conf));

568 
»t
 = 
	`¹e_‘h_dev_æow_ù¾_g‘
(
pÜtid
, &
fc_cÚf
);

569 ià(
»t
 != 0)

570 
	`¹e_ex™
(
EXIT_FAILURE
, "Failedo get flow control info!\n");

573 
fc_cÚf
.
mode
 = 
RTE_FC_NONE
;

574 
»t
 = 
	`¹e_‘h_dev_æow_ù¾_£t
(
pÜtid
, &
fc_cÚf
);

575 ià(
»t
 != 0)

576 
	`¹e_ex™
(
EXIT_FAILURE
, "Failedo set flow control info!:ƒrrno: %d\n",

577 
»t
);

579 #ifdeà
DEBUG


580 
	`´štf
("Port %u, MAC‡ddress: %02X:%02X:%02X:%02X:%02X:%02X\n\n",

581 (è
pÜtid
,

582 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[0],

583 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[1],

584 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[2],

585 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[3],

586 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[4],

587 
pÜts_‘h_addr
[
pÜtid
].
addr_by‹s
[5]);

591 
rxlcÜe_id
 = 0;„xlcÜe_id < 
CONFIG
.
num_cÜes
;„xlcore_id++) {

592 
Çme
[20];

593 
	`¥rštf
(
Çme
, "mbuf_poŞ-%d", 
rxlcÜe_id
);

595 
pktmbuf_poŞ
[
rxlcÜe_id
] =

596 
	`¹e_mempoŞ_lookup
(
Çme
);

597 ià(
pktmbuf_poŞ
[
rxlcÜe_id
] =ğ
NULL
)

598 
	`¹e_ex™
(
EXIT_FAILURE
, "Cannot init mbuf…ool\n");

602 
	`check_®l_pÜts_lšk_¡©us
(
num_deviûs_©ched
, 0xFFFFFFFF);

603 
	}
}

605 
št32_t


606 
	$dpdk_dev_ioùl
(
mtı_th»ad_cÚ‹xt
 *
ùx
, 
nif
, 
cmd
, *
¬gp
)

608 
dpdk_´iv©e_cÚ‹xt
 *
dpc
;

609 
¹e_mbuf
 *
m
;

610 
Ën_of_mbuf
;

611 
hdr
 *
h
;

612 
tıhdr
 *
tıh
;

613 #ifdeà
ENABLELRO


614 
ušt8_t
 *
·ylßd
, *
to
;

615 
£g_off
;

617 
h
 = (
hdr
 *)
¬gp
;

618 
dpc
 = (
dpdk_´iv©e_cÚ‹xt
 *)
ùx
->
io_´iv©e_cÚ‹xt
;

619 
Ën_of_mbuf
 = 
dpc
->
wmbufs
[
nif
].
Ën
;

621 
cmd
) {

622 
PKT_TX_IP_CSUM
:

623 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_IPV4_CKSUM
) == 0)

624 
dev_ioùl_”r
;

625 
m
 = 
dpc
->
wmbufs
[
nif
].
m_bË
[
Ën_of_mbuf
 - 1];

626 
m
->
Ş_æags
 = 
PKT_TX_IP_CKSUM
 | 
PKT_TX_IPV4
;

627 
m
->
l2_Ën
 = (
‘h”_hdr
);

628 
m
->
l3_Ën
 = (
h
->
ihl
<<2);

630 
PKT_TX_TCP_CSUM
:

631 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_TCP_CKSUM
) == 0)

632 
dev_ioùl_”r
;

633 
m
 = 
dpc
->
wmbufs
[
nif
].
m_bË
[
Ën_of_mbuf
 - 1];

634 
tıh
 = (
tıhdr
 *)((*)
h
 + (h->
ihl
<<2));

635 
m
->
Ş_æags
 |ğ
PKT_TX_TCP_CKSUM
;

636 
tıh
->
check
 = 
	`¹e_v4_phdr_cksum
((
v4_hdr
 *)
h
, 
m
->
Ş_æags
);

638 #ifdeà
ENABLELRO


639 
PKT_RX_TCP_LROSEG
:

640 
m
 = 
dpc
->
cur_rx_m
;

643 
h
 = 
	`¹e_pktmbuf_mtod_off£t
(
m
, 
hdr
 *, (
‘h”_hdr
));

644 
tıh
 = (
tıhdr
 *)((
u_ch¬
 *)
h
 + (h->
ihl
 << 2));

645 
·ylßd
 = (
ušt8_t
 *)
tıh
 + (tıh->
doff
 << 2);

647 
£g_off
 = 
m
->
d©a_Ën
 -

648 (
‘h”_hdr
è- (
h
->
ihl
 << 2) -

649 (
tıh
->
doff
 << 2);

651 
to
 = (
ušt8_t
 *è
¬gp
;

652 
m
 = m->
Ãxt
;

653 
	`memıy
(
to
, 
·ylßd
, 
£g_off
);

654 
m
 !ğ
NULL
) {

657 
	`memıy
(
to
 + 
£g_off
,

658 
	`¹e_pktmbuf_mtod
(
m
, 
ušt8_t
 *),

659 
m
->
d©a_Ën
);

660 
£g_off
 +ğ
m
->
d©a_Ën
;

661 
m
 = m->
Ãxt
;

665 
PKT_TX_TCPIP_CSUM
:

666 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_IPV4_CKSUM
) == 0)

667 
dev_ioùl_”r
;

668 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_TCP_CKSUM
) == 0)

669 
dev_ioùl_”r
;

670 
m
 = 
dpc
->
wmbufs
[
nif
].
m_bË
[
Ën_of_mbuf
 - 1];

671 
h
 = 
	`¹e_pktmbuf_mtod_off£t
(
m
, 
hdr
 *, (
‘h”_hdr
));

672 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
ihl
<<2));

673 
m
->
l2_Ën
 = (
‘h”_hdr
);

674 
m
->
l3_Ën
 = (
h
->
ihl
<<2);

675 
m
->
l4_Ën
 = (
tıh
->
doff
<<2);

676 
m
->
Ş_æags
 = 
PKT_TX_TCP_CKSUM
 | 
PKT_TX_IP_CKSUM
 | 
PKT_TX_IPV4
;

677 
tıh
->
check
 = 
	`¹e_v4_phdr_cksum
((
v4_hdr
 *)
h
, 
m
->
Ş_æags
);

679 
PKT_RX_IP_CSUM
:

680 ià((
dev_šfo
[
nif
].
rx_ofæßd_ÿ·
 & 
DEV_RX_OFFLOAD_IPV4_CKSUM
) == 0)

681 
dev_ioùl_”r
;

683 
PKT_RX_TCP_CSUM
:

684 ià((
dev_šfo
[
nif
].
rx_ofæßd_ÿ·
 & 
DEV_RX_OFFLOAD_TCP_CKSUM
) == 0)

685 
dev_ioùl_”r
;

687 
PKT_TX_TCPIP_CSUM_PEEK
:

688 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_IPV4_CKSUM
) == 0)

689 
dev_ioùl_”r
;

690 ià((
dev_šfo
[
nif
].
tx_ofæßd_ÿ·
 & 
DEV_TX_OFFLOAD_TCP_CKSUM
) == 0)

691 
dev_ioùl_”r
;

694 
dev_ioùl_”r
;

697 
dev_ioùl_”r
:

699 
	}
}

701 
io_moduË_func
 
	gdpdk_moduË_func
 = {

702 .
lßd_moduË
 = 
dpdk_lßd_moduË
,

703 .
	gš™_hªdË
 = 
dpdk_š™_hªdË
,

704 .
	glšk_deviûs
 = 
dpdk_lšk_deviûs
,

705 .
	g»Ëa£_pkt
 = 
dpdk_»Ëa£_pkt
,

706 .
	g£nd_pkts
 = 
dpdk_£nd_pkts
,

707 .
	gg‘_w±r
 = 
dpdk_g‘_w±r
,

708 .
	g»cv_pkts
 = 
dpdk_»cv_pkts
,

709 .
	gg‘_½Œ
 = 
dpdk_g‘_½Œ
,

710 .
	g£Ëù
 = 
dpdk_£Ëù
,

711 .
	gde¡roy_hªdË
 = 
dpdk_de¡roy_hªdË
,

712 .
	gdev_ioùl
 = 
dpdk_dev_ioùl


716 
io_moduË_func
 
	gdpdk_moduË_func
 = {

717 .
lßd_moduË
 = 
NULL
,

718 .
	gš™_hªdË
 = 
NULL
,

719 .
	glšk_deviûs
 = 
NULL
,

720 .
	g»Ëa£_pkt
 = 
NULL
,

721 .
	g£nd_pkts
 = 
NULL
,

722 .
	gg‘_w±r
 = 
NULL
,

723 .
	g»cv_pkts
 = 
NULL
,

724 .
	gg‘_½Œ
 = 
NULL
,

725 .
	g£Ëù
 = 
NULL
,

726 .
	gde¡roy_hªdË
 = 
NULL
,

727 .
	gdev_ioùl
 = 
NULL


	@eth_in.cpp

1 
	~"ps.h
"

2 
	~"_š.h
"

3 
	~"‘h_š.h
"

4 
	~"¬p.h
"

5 
	~"debug.h
"

9 
	$ProûssPack‘
(
mtı_mªag”_t
 
mtı
, cÚ¡ 
ifidx
,

10 
ušt32_t
 
cur_ts
, *
pkt_d©a
, 
Ën
)

28 
i
;

29 
i
 = 0; i < 6; i ++) {

30 ià(
‘hh
->
h_de¡
[
i
] !ğ
CONFIG
.
‘hs
[
ifidx
].
haddr
[i]) {

31  
FALSE
;

35 
»t
 = 
	`ProûssIPv4Pack‘
(
mtı
, 
cur_ts
, 
ifidx
, 
pkt_d©a
, 
Ën
);

56  
»t
;

57 
	}
}

	@eth_out.cpp

1 
	~<¡dio.h
>

3 
	~<¡dšt.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<as£¹.h
>

8 
	~<lšux/if_‘h”.h
>

9 
	~<lšux/tı.h
>

10 
	~<Ãtš‘/.h
>

12 
	~"mtı.h
"

13 
	~"¬p.h
"

14 
	~"‘h_out.h
"

15 
	~"debug.h
"

17 #iâdeà
TRUE


18 
	#TRUE
 (1)

	)

21 #iâdeà
FALSE


22 
	#FALSE
 (0)

	)

25 #iâdeà
ERROR


26 
	#ERROR
 (-1)

	)

29 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

30 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

32 
	#MAX_WINDOW_SIZE
 65535

	)

35 
ušt8_t
 *

36 
	$Eth”ÃtOuut
(
mtı_mªag”
 *
mtı
, 
ušt16_t
 
h_´Ùo
,

37 
nif
, * 
d¡_haddr
, 
ušt16_t
 
Ën
)

39 
ušt8_t
 *
buf
;

40 
‘hhdr
 *
‘hh
;

41 
i
;

47 ià(
nif
 < 0) {

48 
	`TRACE_INFO
("No interface set!\n");

49  
NULL
;

52 
buf
 = 
mtı
->
iom
->
	`g‘_w±r
(mtı->
ùx
, 
nif
, 
Ën
 + 
ETHERNET_HEADER_LEN
);

53 ià(!
buf
) {

55  
NULL
;

57  
buf
;

77 
	}
}

	@eventpoll.cpp

1 
	~<sys/queue.h
>

2 
	~<uni¡d.h
>

3 
	~<time.h
>

4 
	~<sigÇl.h
>

5 
	~<as£¹.h
>

7 
	~"mtı.h
"

8 
	~"tı_¡»am.h
"

9 
	~"ev’Şl.h
"

10 
	~"tı_š.h
"

11 
	~"pe.h
"

12 
	~"debug.h
"

14 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

15 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

17 
	#SPIN_BEFORE_SLEEP
 
FALSE


	)

18 
	#SPIN_THRESH
 10000000

	)

21 *
	gev’t_¡r
[] = {"NONE", "IN", "PRI", "OUT", "ERR", "HUP", "RDHUP"};

24 
	$Ev’tToSŒšg
(
ušt32_t
 
ev’t
)

26 
ev’t
) {

27 
MTCP_EPOLLNONE
:

28  
ev’t_¡r
[0];

30 
MTCP_EPOLLIN
:

31  
ev’t_¡r
[1];

33 
MTCP_EPOLLPRI
:

34  
ev’t_¡r
[2];

36 
MTCP_EPOLLOUT
:

37  
ev’t_¡r
[3];

39 
MTCP_EPOLLERR
:

40  
ev’t_¡r
[4];

42 
MTCP_EPOLLHUP
:

43  
ev’t_¡r
[5];

45 
MTCP_EPOLLRDHUP
:

46  
ev’t_¡r
[6];

49 
	`as£¹
(0);

52 
	`as£¹
(0);

53  
NULL
;

54 
	}
}

56 
ev’t_queue
 *

57 
	$C»©eEv’tQueue
(
size
)

59 
ev’t_queue
 *
eq
;

61 
eq
 = (
ev’t_queue
 *)
	`ÿÎoc
(1, (event_queue));

62 ià(!
eq
)

63  
NULL
;

65 
eq
->
¡¬t
 = 0;

66 
eq
->
’d
 = 0;

67 
eq
->
size
 = size;

68 
eq
->
ev’ts
 = (
mtı_•Şl_ev’t_št
 *)

69 
	`ÿÎoc
(
size
, (
mtı_•Şl_ev’t_št
));

70 ià(!
eq
->
ev’ts
) {

71 
	`ä“
(
eq
);

72  
NULL
;

74 
eq
->
num_ev’ts
 = 0;

76  
eq
;

77 
	}
}

80 
	$De¡royEv’tQueue
(
ev’t_queue
 *
eq
)

82 ià(
eq
->
ev’ts
)

83 
	`ä“
(
eq
->
ev’ts
);

85 
	`ä“
(
eq
);

86 
	}
}

89 
	$mtı_•Şl_ü—‹
(
mùx_t
 
mùx
, 
size
)

91 
mtı_mªag”_t
 
mtı
 = 
g_mtı
[
mùx
->
ıu
];

92 
mtı_•Şl
 *
•
;

93 
sock‘_m­_t
 
•sock‘
;

95 ià(
size
 <= 0) {

96 
”ºo
 = 
EINVAL
;

100 
•sock‘
 = 
	`AÎoÿ‹Sock‘
(
mùx
, 
MTCP_SOCK_EPOLL
, 
FALSE
);

101 ià(!
•sock‘
) {

102 
”ºo
 = 
ENFILE
;

106 
•
 = (
mtı_•Şl
 *)
	`ÿÎoc
(1, (mtcp_epoll));

107 ià(!
•
) {

108 
	`F»eSock‘
(
mùx
, 
•sock‘
->
id
, 
FALSE
);

113 
•
->
u¤_queue
 = 
	`C»©eEv’tQueue
(
size
);

114 ià(!
•
->
u¤_queue
)

117 
•
->
u¤_shadow_queue
 = 
	`C»©eEv’tQueue
(
size
);

118 ià(!
•
->
u¤_shadow_queue
) {

119 
	`De¡royEv’tQueue
(
•
->
u¤_queue
);

123 
•
->
mtı_queue
 = 
	`C»©eEv’tQueue
(
size
);

124 ià(!
•
->
mtı_queue
) {

125 
	`De¡royEv’tQueue
(
•
->
u¤_queue
);

126 
	`De¡royEv’tQueue
(
•
->
u¤_shadow_queue
);

130 
	`TRACE_EPOLL
("•ŞÈ¡ruùu» oàsiz%d c»©ed.\n", 
size
);

132 
mtı
->
•
 =ƒp;

133 
•sock‘
->
•
 =ƒp;

135 ià(
	`±h»ad_mu‹x_š™
(&
•
->
•Şl_lock
, 
NULL
)) {

138 ià(
	`±h»ad_cÚd_š™
(&
•
->
•Şl_cÚd
, 
NULL
)) {

142  
•sock‘
->
id
;

143 
	}
}

146 
	$Clo£EpŞlSock‘
(
mùx_t
 
mùx
, 
•id
)

148 
mtı_mªag”_t
 
mtı
;

149 
mtı_•Şl
 *
•
;

151 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

152 ià(!
mtı
) {

156 
•
 = 
mtı
->
sm­
[
•id
].ep;

157 ià(!
•
) {

158 
”ºo
 = 
EINVAL
;

162 
	`De¡royEv’tQueue
(
•
->
u¤_queue
);

163 
	`De¡royEv’tQueue
(
•
->
u¤_shadow_queue
);

164 
	`De¡royEv’tQueue
(
•
->
mtı_queue
);

165 
	`ä“
(
•
);

167 
	`±h»ad_mu‹x_lock
(&
•
->
•Şl_lock
);

168 
mtı
->
•
 = 
NULL
;

169 
mtı
->
sm­
[
•id
].
•
 = 
NULL
;

170 
	`±h»ad_cÚd_sigÇl
(&
•
->
•Şl_cÚd
);

171 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

173 
	`±h»ad_cÚd_de¡roy
(&
•
->
•Şl_cÚd
);

174 
	`±h»ad_mu‹x_de¡roy
(&
•
->
•Şl_lock
);

177 
	}
}

180 
	$Rai£P’dšgSŒ—mEv’ts
(
mtı_mªag”_t
 
mtı
,

181 
mtı_•Şl
 *
•
, 
sock‘_m­_t
 
sock‘
)

183 
tı_¡»am
 *
¡»am
 = 
sock‘
->stream;

185 ià(!
¡»am
)

187 ià(
¡»am
->
¡©e
 < 
TCP_ST_ESTABLISHED
)

190 
	`TRACE_EPOLL
("Stream %d‡t state %s\n",

191 
¡»am
->
id
, 
	`TCPS‹ToSŒšg
(stream));

194 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

195 
tı_»cv_v¬s
 *
rcvv¬
 = 
¡»am
->rcvvar;

196 ià(
rcvv¬
->
rcvbuf
 &&„cvv¬->rcvbuf->
m”ged_Ën
 > 0) {

197 
	`TRACE_EPOLL
("Sock‘ %d: Ha exi¡šg…aylßds\n", 
sock‘
->
id
);

198 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

199 } ià(
¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

200 
	`TRACE_EPOLL
("Sock‘ %d: Wa™šg fÜ clo£\n", 
sock‘
->
id
);

201 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

206 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
) {

207 
tı_£nd_v¬s
 *
¢dv¬
 = 
¡»am
->sndvar;

208 ià(!
¢dv¬
->
¢dbuf
 ||

209 (
¢dv¬
->
¢dbuf
 && sndv¬->¢dbuf->
Ën
 < sndv¬->
¢d_wnd
)) {

210 ià(!(
sock‘
->
ev’ts
 & 
MTCP_EPOLLOUT
)) {

211 
	`TRACE_EPOLL
("Sock‘ %d: Addšg wr™ev’t\n", 
sock‘
->
id
);

212 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLOUT
);

218 
	}
}

221 
	$mtı_•Şl_ùl
(
mùx_t
 
mùx
, 
•id
,

222 
İ
, 
sockid
, 
mtı_•Şl_ev’t
 *
ev’t
)

224 
mtı_mªag”_t
 
mtı
;

225 
mtı_•Şl
 *
•
;

226 
sock‘_m­_t
 
sock‘
;

227 
ušt32_t
 
ev’ts
;

229 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

230 ià(!
mtı
) {

234 ià(
•id
 < 0 ||ƒpid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

235 
	`TRACE_API
("EpŞÈid %d ouˆoà¿nge.\n", 
•id
);

236 
”ºo
 = 
EBADF
;

240 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

241 
	`TRACE_API
("Sock‘ id %d ouˆoà¿nge.\n", 
sockid
);

242 
”ºo
 = 
EBADF
;

246 ià(
mtı
->
sm­
[
•id
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

247 
”ºo
 = 
EBADF
;

251 ià(
mtı
->
sm­
[
•id
].
sockty³
 !ğ
MTCP_SOCK_EPOLL
) {

252 
”ºo
 = 
EINVAL
;

256 
•
 = 
mtı
->
sm­
[
•id
].ep;

257 ià(!
•
 || (!
ev’t
 && 
İ
 !ğ
MTCP_EPOLL_CTL_DEL
)) {

258 
”ºo
 = 
EINVAL
;

261 
sock‘
 = &
mtı
->
sm­
[
sockid
];

263 ià(
İ
 =ğ
MTCP_EPOLL_CTL_ADD
) {

264 ià(
sock‘
->
•Şl
) {

265 
”ºo
 = 
EEXIST
;

270 
ev’ts
 = 
ev’t
->events;

271 
ev’ts
 |ğ(
MTCP_EPOLLERR
 | 
MTCP_EPOLLHUP
);

272 
sock‘
->
•_d©a
 = 
ev’t
->
d©a
;

273 
sock‘
->
•Şl
 = 
ev’ts
;

275 
	`TRACE_EPOLL
("Addingƒpoll socket %d(type %d) ET: %u, IN: %u, OUT: %u\n",

276 
sock‘
->
id
, sock‘->
sockty³
, sock‘->
•Şl
 & 
MTCP_EPOLLET
,

277 
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
, sock‘->•ŞÈ& 
MTCP_EPOLLOUT
);

279 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_STREAM
) {

280 
	`Rai£P’dšgSŒ—mEv’ts
(
mtı
, 
•
, 
sock‘
);

281 } ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_PIPE
) {

282 
	`Rai£P’dšgPeEv’ts
(
mùx
, 
•id
, 
sockid
);

285 } ià(
İ
 =ğ
MTCP_EPOLL_CTL_MOD
) {

286 ià(!
sock‘
->
•Şl
) {

287 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

288 
”ºo
 = 
ENOENT
;

292 
ev’ts
 = 
ev’t
->events;

293 
ev’ts
 |ğ(
MTCP_EPOLLERR
 | 
MTCP_EPOLLHUP
);

294 
sock‘
->
•_d©a
 = 
ev’t
->
d©a
;

295 
sock‘
->
•Şl
 = 
ev’ts
;

297 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_STREAM
) {

298 
	`Rai£P’dšgSŒ—mEv’ts
(
mtı
, 
•
, 
sock‘
);

299 } ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_PIPE
) {

300 
	`Rai£P’dšgPeEv’ts
(
mùx
, 
•id
, 
sockid
);

303 } ià(
İ
 =ğ
MTCP_EPOLL_CTL_DEL
) {

304 ià(!
sock‘
->
•Şl
) {

305 
”ºo
 = 
ENOENT
;

309 
sock‘
->
•Şl
 = 
MTCP_EPOLLNONE
;

313 
	}
}

316 
	$mtı_•Şl_wa™
(
mùx_t
 
mùx
, 
•id
,

317 
mtı_•Şl_ev’t
 *
ev’ts
, 
maxev’ts
, 
timeout
)

319 
mtı_mªag”_t
 
mtı
;

320 
mtı_•Şl
 *
•
;

321 
ev’t_queue
 *
eq
;

322 
ev’t_queue
 *
eq_shadow
;

323 
sock‘_m­_t
 
ev’t_sock‘
;

324 
v®id™y
;

325 
i
, 
út
, 
»t
;

326 
num_ev’ts
;

328 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

329 ià(!
mtı
) {

333 ià(
•id
 < 0 ||ƒpid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

334 
	`TRACE_API
("EpŞÈid %d ouˆoà¿nge.\n", 
•id
);

335 
”ºo
 = 
EBADF
;

339 ià(
mtı
->
sm­
[
•id
].
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

340 
”ºo
 = 
EBADF
;

344 ià(
mtı
->
sm­
[
•id
].
sockty³
 !ğ
MTCP_SOCK_EPOLL
) {

345 
”ºo
 = 
EINVAL
;

349 
•
 = 
mtı
->
sm­
[
•id
].ep;

350 ià(!
•
 || !
ev’ts
 || 
maxev’ts
 <= 0) {

351 
”ºo
 = 
EINVAL
;

355 
•
->
¡©
.
ÿÎs
++;

357 #ià
SPIN_BEFORE_SLEEP


358 
¥š
 = 0;

359 
•
->
num_ev’ts
 =ğ0 && 
¥š
 < 
SPIN_THRESH
) {

360 
¥š
++;

364 ià(
	`±h»ad_mu‹x_lock
(&
•
->
•Şl_lock
)) {

365 ià(
”ºo
 =ğ
EDEADLK
)

366 
	`³¼Ü
("mtcp_epoll_wait:ƒpoll_lock blocked\n");

367 
	`as£¹
(0);

370 
wa™
:

371 
eq
 = 
•
->
u¤_queue
;

372 
eq_shadow
 = 
•
->
u¤_shadow_queue
;

375 
eq
->
num_ev’ts
 =ğ0 && 
eq_shadow
->num_ev’t =ğ0 && 
timeout
 != 0) {

377 #ià
INTR_SLEEPING_MTCP


379 ià(
mtı
->
wakeup_æag
 && mtı->
is_¦“pšg
) {

380 
	`±h»ad_kl
(
mtı
->
ùx
->
th»ad
, 
SIGUSR1
);

383 
•
->
¡©
.
wa™s
++;

384 
•
->
wa™šg
 = 
TRUE
;

385 ià(
timeout
 > 0) {

386 
time¥ec
 
d—dlše
;

388 
	`şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
);

389 ià(
timeout
 >= 1000) {

390 
£c
;

391 
£c
 = 
timeout
 / 1000;

392 
d—dlše
.
tv_£c
 +ğ
£c
;

393 
timeout
 -ğ
£c
 * 1000;

396 
d—dlše
.
tv_n£c
 +ğ
timeout
 * 1000000;

398 ià(
d—dlše
.
tv_n£c
 >= 1000000000) {

399 
d—dlše
.
tv_£c
++;

400 
d—dlše
.
tv_n£c
 -= 1000000000;

405 
»t
 = 
	`±h»ad_cÚd_timedwa™
(&
•
->
•Şl_cÚd
,

406 &
•
->
•Şl_lock
, &
d—dlše
);

407 ià(
»t
 &&„‘ !ğ
ETIMEDOUT
) {

409 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

410 
	`TRACE_ERROR
("pthread_cond_timedwait failed.„et: %d,ƒrror: %s\n",

411 
»t
, 
	`¡»¼Ü
(
”ºo
));

414 
timeout
 = 0;

415 } ià(
timeout
 < 0) {

416 
»t
 = 
	`±h»ad_cÚd_wa™
(&
•
->
•Şl_cÚd
, &•->
•Şl_lock
);

417 ià(
»t
) {

419 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

420 
	`TRACE_ERROR
("pthread_cond_wait failed.„et: %d,ƒrror: %s\n",

421 
»t
, 
	`¡»¼Ü
(
”ºo
));

425 
•
->
wa™šg
 = 
FALSE
;

427 ià(
mtı
->
ùx
->
dÚe
 || mtı->ùx->
ex™
 || mtı->ùx->
š‹¼u±
) {

428 
mtı
->
ùx
->
š‹¼u±
 = 
FALSE
;

430 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

431 
”ºo
 = 
EINTR
;

438 
út
 = 0;

439 
num_ev’ts
 = 
eq
->num_events;

440 
i
 = 0; i < 
num_ev’ts
 && 
út
 < 
maxev’ts
; i++) {

441 
ev’t_sock‘
 = &
mtı
->
sm­
[
eq
->
ev’ts
[eq->
¡¬t
].
sockid
];

442 
v®id™y
 = 
TRUE
;

443 ià(
ev’t_sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
)

444 
v®id™y
 = 
FALSE
;

445 ià(!(
ev’t_sock‘
->
•Şl
 & 
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events))

446 
v®id™y
 = 
FALSE
;

447 ià(!(
ev’t_sock‘
->
ev’ts
 & 
eq
->ev’ts[eq->
¡¬t
].
ev
.events))

448 
v®id™y
 = 
FALSE
;

450 ià(
v®id™y
) {

451 
ev’ts
[
út
++] = 
eq
->ev’ts[eq->
¡¬t
].
ev
;

452 
	`as£¹
(
eq
->
ev’ts
[eq->
¡¬t
].
sockid
 >= 0);

454 
	`TRACE_EPOLL
("Socket %d: Handledƒvent.ƒvent: %s, "

456 
ev’t_sock‘
->
id
,

457 
	`Ev’tToSŒšg
(
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events),

458 
eq
->
¡¬t
,ƒq->
’d
,ƒq->
num_ev’ts
);

459 
•
->
¡©
.
hªdËd
++;

461 
	`TRACE_EPOLL
("Socket %d:ƒvent %s invalidated.\n",

462 
eq
->
ev’ts
[eq->
¡¬t
].
sockid
,

463 
	`Ev’tToSŒšg
(
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events));

464 
•
->
¡©
.
šv®id©ed
++;

466 
ev’t_sock‘
->
ev’ts
 &ğ(~
eq
->ev’ts[eq->
¡¬t
].
ev
.events);

468 
eq
->
¡¬t
++;

469 
eq
->
num_ev’ts
--;

470 ià(
eq
->
¡¬t
 >ğeq->
size
) {

471 
eq
->
¡¬t
 = 0;

476 
eq
 = 
•
->
u¤_shadow_queue
;

477 
num_ev’ts
 = 
eq
->num_events;

478 
i
 = 0; i < 
num_ev’ts
 && 
út
 < 
maxev’ts
; i++) {

479 
ev’t_sock‘
 = &
mtı
->
sm­
[
eq
->
ev’ts
[eq->
¡¬t
].
sockid
];

480 
v®id™y
 = 
TRUE
;

481 ià(
ev’t_sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
)

482 
v®id™y
 = 
FALSE
;

483 ià(!(
ev’t_sock‘
->
•Şl
 & 
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events))

484 
v®id™y
 = 
FALSE
;

485 ià(!(
ev’t_sock‘
->
ev’ts
 & 
eq
->ev’ts[eq->
¡¬t
].
ev
.events))

486 
v®id™y
 = 
FALSE
;

488 ià(
v®id™y
) {

489 
ev’ts
[
út
++] = 
eq
->ev’ts[eq->
¡¬t
].
ev
;

490 
	`as£¹
(
eq
->
ev’ts
[eq->
¡¬t
].
sockid
 >= 0);

492 
	`TRACE_EPOLL
("Socket %d: Handledƒvent.ƒvent: %s, "

494 
ev’t_sock‘
->
id
,

495 
	`Ev’tToSŒšg
(
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events),

496 
eq
->
¡¬t
,ƒq->
’d
,ƒq->
num_ev’ts
);

497 
•
->
¡©
.
hªdËd
++;

499 
	`TRACE_EPOLL
("Socket %d:ƒvent %s invalidated.\n",

500 
eq
->
ev’ts
[eq->
¡¬t
].
sockid
,

501 
	`Ev’tToSŒšg
(
eq
->
ev’ts
[eq->
¡¬t
].
ev
.events));

502 
•
->
¡©
.
šv®id©ed
++;

504 
ev’t_sock‘
->
ev’ts
 &ğ(~
eq
->ev’ts[eq->
¡¬t
].
ev
.events);

506 
eq
->
¡¬t
++;

507 
eq
->
num_ev’ts
--;

508 ià(
eq
->
¡¬t
 >ğeq->
size
) {

509 
eq
->
¡¬t
 = 0;

513 ià(
út
 =ğ0 && 
timeout
 != 0)

514 
wa™
;

516 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

518  
út
;

519 
	}
}

522 
	$AddEpŞlEv’t
(
mtı_•Şl
 *
•
,

523 
queue_ty³
, 
sock‘_m­_t
 
sock‘
, 
ušt32_t
 
ev’t
)

525 
ev’t_queue
 *
eq
;

526 
šdex
;

528 ià(!
•
 || !
sock‘
 || !
ev’t
)

531 
•
->
¡©
.
issued
++;

533 ià(
sock‘
->
ev’ts
 & 
ev’t
) {

537 ià(
queue_ty³
 =ğ
MTCP_EVENT_QUEUE
) {

538 
eq
 = 
•
->
mtı_queue
;

539 } ià(
queue_ty³
 =ğ
USR_EVENT_QUEUE
) {

540 
eq
 = 
•
->
u¤_queue
;

541 
	`±h»ad_mu‹x_lock
(&
•
->
•Şl_lock
);

542 } ià(
queue_ty³
 =ğ
USR_SHADOW_EVENT_QUEUE
) {

543 
eq
 = 
•
->
u¤_shadow_queue
;

545 
	`TRACE_ERROR
("Non-existingƒvent queueype!\n");

549 ià(
eq
->
num_ev’ts
 >ğeq->
size
) {

550 
	`TRACE_ERROR
("Exceededƒpollƒvent queue!‚um_events: %d, size: %d\n",

551 
eq
->
num_ev’ts
,ƒq->
size
);

552 ià(
queue_ty³
 =ğ
USR_EVENT_QUEUE
)

553 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

557 
šdex
 = 
eq
->
’d
++;

559 
sock‘
->
ev’ts
 |ğ
ev’t
;

560 
eq
->
ev’ts
[
šdex
].
sockid
 = 
sock‘
->
id
;

561 
eq
->
ev’ts
[
šdex
].
ev
.ev’t ğ
ev’t
;

562 
eq
->
ev’ts
[
šdex
].
ev
.
d©a
 = 
sock‘
->
•_d©a
;

564 ià(
eq
->
’d
 >ğeq->
size
) {

565 
eq
->
’d
 = 0;

567 
eq
->
num_ev’ts
++;

570 
	`TRACE_EPOLL
("Socket %d Newƒvent: %s, start: %u,ƒnd: %u,‚um: %u\n",

571 
•
->
ev’ts
[
šdex
].
sockid
,

572 
	`Ev’tToSŒšg
(
•
->
ev’ts
[
šdex
].
ev
.events),

573 
•
->
¡¬t
,ƒp->
’d
,ƒp->
num_ev’ts
);

576 ià(
queue_ty³
 =ğ
USR_EVENT_QUEUE
)

577 
	`±h»ad_mu‹x_uÆock
(&
•
->
•Şl_lock
);

579 
•
->
¡©
.
»gi¡”ed
++;

582 
	}
}

	@fhash.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<as£¹.h
>

5 
	~<m©h.h
>

6 
	~<Ãtš‘/š.h
>

7 
	~<¬·/š‘.h
>

8 
	~<sys/queue.h
>

10 
	~"debug.h
"

11 
	~"fhash.h
"

13 
	#IS_FLOW_TABLE
(
x
è(x =ğ
HashFlow
)

	)

14 
	#IS_LISTEN_TABLE
(
x
è(x =ğ
HashLi¡’”
)

	)

16 
hashbË
 *

17 
C»©eHashbË
((*
hashâ
) (const *),

18 (*
eqâ
) (const *, const *),

19 
bšs
)

21 
i
;

22 
hashbË
* 
ht
 = 
	`ÿÎoc
(1, (hashtable));

23 ià(!
ht
){

24 
	`TRACE_ERROR
("calloc: CreateHashtable");

28 
ht
->
hashâ
 = hashfn;

29 
ht
->
eqâ
 =ƒqfn;

30 
ht
->
bšs
 = bins;

33 ià(
	`IS_FLOW_TABLE
(
hashâ
)) {

34 
ht
->
ht_bË
 = 
	`ÿÎoc
(
bšs
, (
hash_buck‘_h—d
));

35 ià(!
ht
->
ht_bË
) {

36 
	`TRACE_ERROR
("calloc: CreateHashtable bins!\n");

37 
	`ä“
(
ht
);

41 
i
 = 0; i < 
bšs
; i++)

42 
	`TAILQ_INIT
(&
ht
->
ht_bË
[
i
]);

43 } ià(
	`IS_LISTEN_TABLE
(
hashâ
)) {

44 
ht
->
É_bË
 = 
	`ÿÎoc
(
bšs
, (
li¡_buck‘_h—d
));

45 ià(!
ht
->
É_bË
) {

46 
	`TRACE_ERROR
("calloc: CreateHashtable bins!\n");

47 
	`ä“
(
ht
);

51 
i
 = 0; i < 
bšs
; i++)

52 
	`TAILQ_INIT
(&
ht
->
É_bË
[
i
]);

55  
ht
;

56 
	}
}

59 
	$De¡royHashbË
(
hashbË
 *
ht
)

61 ià(
	`IS_FLOW_TABLE
(
ht
->
hashâ
))

62 
	`ä“
(
ht
->
ht_bË
);

64 
	`ä“
(
ht
->
É_bË
);

65 
	`ä“
(
ht
);

66 
	}
}

69 
	$SŒ—mHTIn£¹
(
hashbË
 *
ht
, *
™
)

72 
idx
;

73 
tı_¡»am
 *
™em
 = (tı_¡»am *)
™
;

75 
	`as£¹
(
ht
);

76 
	`as£¹
(
ht
->
ht_couÁ
 <= 65535);

78 
idx
 = 
ht
->
	`hashâ
(
™em
);

79 
	`as£¹
(
idx
 >=0 && idx < 
NUM_BINS_FLOWS
);

81 
	`TAILQ_INSERT_TAIL
(&
ht
->
ht_bË
[
idx
], 
™em
, 
rcvv¬
->
he_lšk
);

83 
™em
->
ht_idx
 = 
TCP_AR_CNT
;

84 
ht
->
ht_couÁ
++;

87 
	}
}

90 
	$SŒ—mHTRemove
(
hashbË
 *
ht
, *
™
)

92 
hash_buck‘_h—d
 *
h—d
;

93 
tı_¡»am
 *
™em
 = (tı_¡»am *)
™
;

94 
idx
 = 
ht
->
	`hashâ
(
™em
);

96 
h—d
 = &
ht
->
ht_bË
[
idx
];

97 
	`TAILQ_REMOVE
(
h—d
, 
™em
, 
rcvv¬
->
he_lšk
);

99 
ht
->
ht_couÁ
--;

100  (
™em
);

101 
	}
}

104 
	$SŒ—mHTS—rch
(
hashbË
 *
ht
, cÚ¡ *
™
)

106 
idx
;

107 cÚ¡ 
tı_¡»am
 *
™em
 = (cÚ¡ı_¡»am *)
™
;

108 
tı_¡»am
 *
w®k
;

109 
hash_buck‘_h—d
 *
h—d
;

111 
idx
 = 
ht
->
	`hashâ
(
™em
);

113 
h—d
 = &
ht
->
ht_bË
[ht->
	`hashâ
(
™em
)];

114 
	`TAILQ_FOREACH
(
w®k
, 
h—d
, 
rcvv¬
->
he_lšk
) {

115 ià(
ht
->
	`eqâ
(
w®k
, 
™em
))

116  
w®k
;

119 
	`UNUSED
(
idx
);

120  
NULL
;

121 
	}
}

124 
	$HashLi¡’”
(cÚ¡ *
l
)

126 
tı_li¡’”
 *
li¡’”
 = (tı_li¡’” *)
l
;

128  
li¡’”
->
sock‘
->
§ddr
.
sš_pÜt
 & (
NUM_BINS_LISTENERS
 - 1);

129 
	}
}

132 
	$Equ®Li¡’”
(cÚ¡ *
l1
, cÚ¡ *
l2
)

134 
tı_li¡’”
 *
li¡’”1
 = (tı_li¡’” *)
l1
;

135 
tı_li¡’”
 *
li¡’”2
 = (tı_li¡’” *)
l2
;

137  (
li¡’”1
->
sock‘
->
§ddr
.
sš_pÜt
 =ğ
li¡’”2
->socket->saddr.sin_port);

138 
	}
}

141 
	$Li¡’”HTIn£¹
(
hashbË
 *
ht
, *
™
)

144 
idx
;

145 
tı_li¡’”
 *
™em
 = (tı_li¡’” *)
™
;

147 
	`as£¹
(
ht
);

148 
	`as£¹
(
ht
->
ht_couÁ
 <= 65535);

150 
idx
 = 
ht
->
	`hashâ
(
™em
);

151 
	`as£¹
(
idx
 >=0 && idx < 
NUM_BINS_LISTENERS
);

153 
	`TAILQ_INSERT_TAIL
(&
ht
->
É_bË
[
idx
], 
™em
, 
he_lšk
);

154 
ht
->
ht_couÁ
++;

157 
	}
}

160 
	$Li¡’”HTRemove
(
hashbË
 *
ht
, *
™
)

162 
li¡_buck‘_h—d
 *
h—d
;

163 
tı_li¡’”
 *
™em
 = (tı_li¡’” *)
™
;

164 
idx
 = 
ht
->
	`hashâ
(
™em
);

166 
h—d
 = &
ht
->
É_bË
[
idx
];

167 
	`TAILQ_REMOVE
(
h—d
, 
™em
, 
he_lšk
);

169 
ht
->
ht_couÁ
--;

170  (
™em
);

171 
	}
}

174 
	$Li¡’”HTS—rch
(
hashbË
 *
ht
, cÚ¡ *
™
)

176 
idx
;

177 
tı_li¡’”
 
™em
;

178 
ušt16_t
 
pÜt
 = *((ušt16_ˆ*)
™
);

179 
tı_li¡’”
 *
w®k
;

180 
li¡_buck‘_h—d
 *
h—d
;

181 
sock‘_m­
 
s
;

183 
s
.
§ddr
.
sš_pÜt
 = 
pÜt
;

184 
™em
.
sock‘
 = &
s
;

186 
idx
 = 
ht
->
	`hashâ
(&
™em
);

188 
h—d
 = &
ht
->
É_bË
[
idx
];

189 
	`TAILQ_FOREACH
(
w®k
, 
h—d
, 
he_lšk
) {

190 ià(
ht
->
	`eqâ
(
w®k
, &
™em
))

191  
w®k
;

194  
NULL
;

195 
	}
}

	@icmp.cpp

1 
	~<¡dšt.h
>

2 
	~<sys/ty³s.h
>

3 
	~<Ãtš‘/.h
>

5 
	~"mtı.h
"

6 
	~"icmp.h
"

7 
	~"‘h_out.h
"

8 
	~"_š.h
"

9 
	~"_out.h
"

10 
	~"debug.h
"

11 
	~"¬p.h
"

13 
	#IP_NEXT_PTR
(
h
è((
ušt8_t
 *)h + (h->
ihl
 << 2))

	)

16 
DumpICMPPack‘
(
icmphdr
 *
icmph
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
);

18 
ušt16_t


19 
	$ICMPChecksum
(
ušt16_t
 *
icmph
, 
Ën
)

21 
	`as£¹
(
Ën
 >= 0);

23 
ušt16_t
 
»t
 = 0;

24 
ušt32_t
 
sum
 = 0;

25 
ušt16_t
 
odd_by‹
;

27 
Ën
 > 1) {

28 
sum
 +ğ*
icmph
++;

29 
Ën
 -= 2;

32 ià(
Ën
 == 1) {

33 *(
ušt8_t
*)(&
odd_by‹
èğ* (ušt8_t*)
icmph
;

34 
sum
 +ğ
odd_by‹
;

37 
sum
 = (sum >> 16) + (sum & 0xffff);

38 
sum
 += (sum >> 16);

39 
»t
 = ~
sum
;

41  
»t
;

42 
	}
}

45 
	$ICMPOuut
(
mtı_mªag”
 *
mtı
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
,

46 
ušt8_t
 
icmp_ty³
, ušt8_ˆ
icmp_code
, 
ušt16_t
 
icmp_id
, ušt16_ˆ
icmp_£q
,

47 
ušt8_t
 *
icmpd
, 
ušt16_t
 
Ën
)

49 
icmphdr
 *
icmph
;

51 
icmph
 = (
icmphdr
 *)
	`IPOuutSnd®Úe
(
mtı
,

52 
IPPROTO_ICMP
, 0, 
§ddr
, 
daddr
, (
icmphdr
è+ 
Ën
);

53 ià(!
icmph
)

57 
icmph
->
icmp_ty³
 = icmp_type;

58 
icmph
->
icmp_code
 = icmp_code;

59 
icmph
->
icmp_checksum
 = 0;

60 
	`ICMP_ECHO_SET_ID
(
icmph
, 
	`htÚs
(
icmp_id
));

61 
	`ICMP_ECHO_SET_SEQ
(
icmph
, 
	`htÚs
(
icmp_£q
));

64 ià(
Ën
 > 0)

65 
	`memıy
((*)(
icmph
 + 1), 
icmpd
, 
Ën
);

68 
icmph
->
icmp_checksum
 =

69 
	`ICMPChecksum
((
ušt16_t
 *)
icmph
, (
icmphdr
è+ 
Ën
);

71 #ià
DBGMSG


72 
	`DumpICMPPack‘
(
icmph
, 
§ddr
, 
daddr
);

75 
	}
}

78 
	$Reque¡ICMP
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
,

79 
ušt16_t
 
icmp_id
, ušt16_ˆ
icmp_£qu’û
,

80 
ušt8_t
 *
icmpd
, 
ušt16_t
 
Ën
)

83 
	`ICMPOuut
(
mtı
, 
§ddr
, 
daddr
, 
ICMP_ECHO
, 0, 
	`Áohs
(
icmp_id
),‚tohs(
icmp_£qu’û
),

84 
icmpd
, 
Ën
);

85 
	}
}

88 
	$ProûssICMPECHOReque¡
(
mtı_mªag”_t
 
mtı
, 
hdr
 *
h
, 
Ën
)

90 
»t
 = 0;

91 
icmphdr
 *
icmph
 = (icmphd¸*è
	`IP_NEXT_PTR
(
h
);

94 ià(
	`ICMPChecksum
((
ušt16_t
 *è
icmph
, 
Ën
 - (
h
->
ihl
 << 2)) )

95 
»t
 = 
ERROR
;

97 
	`ICMPOuut
(
mtı
, 
h
->
daddr
, iph->
§ddr
, 
ICMP_ECHOREPLY
, 0,

98 
	`Áohs
(
	`ICMP_ECHO_GET_ID
(
icmph
)),‚tohs(
	`ICMP_ECHO_GET_SEQ
(icmph)),

99 (
ušt8_t
 *è(
icmph
 + 1),

100 (
ušt16_t
è(
Ën
 - (
h
->
ihl
 << 2è- (
icmphdr
)) );

102  
»t
;

103 
	}
}

106 
	$ProûssICMPPack‘
(
mtı_mªag”_t
 
mtı
, 
hdr
 *
h
, 
Ën
)

108 
icmphdr
 *
icmph
 = (icmphd¸*è
	`IP_NEXT_PTR
(
h
);

109 
i
;

110 
to_me
 = 
FALSE
;

113 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

114 ià(
h
->
daddr
 =ğ
CONFIG
.
‘hs
[
i
].
_addr
) {

115 
to_me
 = 
TRUE
;

119 ià(!
to_me
)

120  
TRUE
;

122 
icmph
->
icmp_ty³
) {

123 
ICMP_ECHO
:

124 
	`ProûssICMPECHOReque¡
(
mtı
, 
h
, 
Ën
);

127 
ICMP_DEST_UNREACH
:

128 
	`TRACE_INFO
("[INFO] ICMP Destination Unreachable message„eceived\n");

131 
ICMP_TIME_EXCEEDED
:

132 
	`TRACE_INFO
("[INFO] ICMP Time Exceeded message„eceived\n");

136 
	`TRACE_INFO
("[INFO] Unsupported ICMP messageype %x„eceived\n",

137 
icmph
->
icmp_ty³
);

141  
TRUE
;

142 
	}
}

145 
	$DumpICMPPack‘
(
icmphdr
 *
icmph
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
)

147 
ušt8_t
 *
t
;

149 
	`årštf
(
¡d”r
, "ICMP header: \n");

150 
	`årštf
(
¡d”r
, "Type: %d, "

152 
icmph
->
icmp_ty³
, icmph->
icmp_code
,

153 
	`Áohs
(
	`ICMP_ECHO_GET_ID
(
icmph
)),‚tohs(
	`ICMP_ECHO_GET_SEQ
(icmph)));

155 
t
 = (
ušt8_t
 *)&
§ddr
;

156 
	`årštf
(
¡d”r
, "Sender IP: %u.%u.%u.%u\n",

157 
t
[0],[1],[2],[3]);

159 
t
 = (
ušt8_t
 *)&
daddr
;

160 
	`årštf
(
¡d”r
, "Target IP: %u.%u.%u.%u\n",

161 
t
[0],[1],[2],[3]);

162 
	}
}

164 #undeà
IP_NEXT_PTR


	@include/addr_pool.h

1 #iâdeà
__ADDR_POOL_H_


2 
	#__ADDR_POOL_H_


	)

4 
	~<Ãtš‘/š.h
>

5 
	~<sys/queue.h
>

7 
	#MIN_PORT
 (1025)

	)

8 
	#MAX_PORT
 (65535 + 1)

	)

10 
addr_poŞ
 *
	taddr_poŞ_t
;

17 
addr_poŞ_t


18 
C»©eAdd»ssPoŞ
(
š_addr_t
 
addr_ba£
, 
num_addr
);

24 
addr_poŞ_t


25 
C»©eAdd»ssPoŞP”CÜe
(
cÜe
, 
num_queues
,

26 
š_addr_t
 
§ddr_ba£
, 
num_addr
, in_addr_ˆ
daddr
, 
š_pÜt_t
 
dpÜt
);

29 
De¡royAdd»ssPoŞ
(
addr_poŞ_t
 
­
);

32 
F‘chAdd»ss
(
addr_poŞ_t
 
­
, 
cÜe
, 
num_queues
,

33 cÚ¡ 
sockaddr_š
 *
daddr
, sockaddr_š *
§ddr
);

36 
F»eAdd»ss
(
addr_poŞ_t
 
­
, cÚ¡ 
sockaddr_š
 *
addr
);

	@include/arp.h

1 #iâdeà
__ARP_H_


2 
	#__ARP_H_


	)

4 
	#MAX_ARPENTRY
 1024

	)

7 
In™ARPTabË
();

10 
G‘HWaddr
(
ušt32_t
 

);

13 
G‘De¡š©iÚHWaddr
(
ušt32_t
 
d
);

16 
Reque¡ARP
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 

, 
nif
, ušt32_ˆ
cur_ts
);

19 
ProûssARPPack‘
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

20 cÚ¡ 
ifidx
, * 
pkt_d©a
, 
Ën
);

23 
ARPTim”
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
);

26 
PrštARPTabË
();

	@include/config.h

1 #iâdeà
__CONFIG_H_


2 
	#__CONFIG_H_


	)

4 
	~"ps.h
"

6 
num_ıus
;

7 
num_queues
;

8 
num_deviûs
;

10 
num_deviûs_©ched
;

11 
deviûs_©ched
[
MAX_DEVICES
];

14 
LßdCÚfigu¿tiÚ
(cÚ¡ *
âame
);

19 
S‘IÁ”çûInfo
();

23 
S‘RoutšgTabË
();

26 
LßdARPTabË
();

30 
PrštCÚfigu¿tiÚ
();

33 
PrštIÁ”çûInfo
();

36 
PrštRoutšgTabË
();

40 
S‘Sock‘Mode
(
št8_t
 
sock‘_mode
);

43 
ušt32_t


44 
MaskFromP»fix
(
´efix
);

47 
P¬£MACAdd»ss
(*
haddr
, *
haddr_¡r
);

50 
P¬£IPAdd»ss
(
ušt32_t
 *
_addr
, *
_¡r
);

	@include/cpu.h

1 #iâdeà
__CPU_H_


2 
	#__CPU_H_


	)

4 
G‘NumCPUs
();

	@include/ctrs.h

1 #iâdeà
CTRS_H_


2 
	#CTRS_H_


	)

4 
	~<sys/time.h
>

7 
	smy_ùrs
 {

8 
ušt64_t
 
	mpkts
, 
	mby‹s
, 
	mev’ts
, 
	mdrİ
;

9 
ušt64_t
 
	mmš_¥aû
;

10 
timev®
 
	mt
;

17 
	$nÜm2
(*
buf
, 
v®
, cÚ¡ *
fmt
)

19 cÚ¡ *
un™s
[] = { "", "K", "M", "G", "T" };

20 
u_št
 
i
;

22 
i
 = 0; 
v®
 >=1000 && i < (
un™s
)/(*) - 1; i++)

23 
v®
 /= 1000;

24 
	`¥rštf
(
buf
, 
fmt
, 
v®
, 
un™s
[
i
]);

25  
buf
;

26 
	}
}

28 
__šlše
 const *

29 
	$nÜm
(*
buf
, 
v®
)

31  
	`nÜm2
(
buf
, 
v®
, "%.3f %s");

32 
	}
}

34 
__šlše
 

35 
	$time¥ec_ge
(cÚ¡ 
time¥ec
 *
a
, cÚ¡ time¥eø*
b
)

38 ià(
a
->
tv_£c
 > 
b
->tv_sec)

40 ià(
a
->
tv_£c
 < 
b
->tv_sec)

42 ià(
a
->
tv_n£c
 >ğ
b
->tv_nsec)

45 
	}
}

47 
__šlše
 
time¥ec


48 
	$timev®2¥ec
(cÚ¡ 
timev®
 *
a
)

50 
time¥ec
 
ts
 = {

51 .
tv_£c
 = 
a
->tv_sec,

52 .
tv_n£c
 = 
a
->
tv_u£c
 * 1000

54  
ts
;

55 
	}
}

57 
__šlše
 
timev®


58 
	$time¥ec2v®
(cÚ¡ 
time¥ec
 *
a
)

60 
timev®
 
tv
 = {

61 .
tv_£c
 = 
a
->tv_sec,

62 .
tv_u£c
 = 
a
->
tv_n£c
 / 1000

64  
tv
;

65 
	}
}

68 
__šlše
 
time¥ec


69 
	$time¥ec_add
(
time¥ec
 
a
, time¥eø
b
)

71 
time¥ec
 
»t
 = { 
a
.
tv_£c
 + 
b
.tv_£c,‡.
tv_n£c
 + b.tv_nsec };

72 ià(
»t
.
tv_n£c
 >= 1000000000) {

73 
»t
.
tv_£c
++;

74 
»t
.
tv_n£c
 -= 1000000000;

76  
»t
;

77 
	}
}

79 
__šlše
 
time¥ec


80 
	$time¥ec_sub
(
time¥ec
 
a
, time¥eø
b
)

82 
time¥ec
 
»t
 = { 
a
.
tv_£c
 - 
b
.tv_£c,‡.
tv_n£c
 - b.tv_nsec };

83 ià(
»t
.
tv_n£c
 < 0) {

84 
»t
.
tv_£c
--;

85 
»t
.
tv_n£c
 += 1000000000;

87  
»t
;

88 
	}
}

90 
ušt64_t


91 
	$wa™_fÜ_Ãxt_»pÜt
(
timev®
 *
´ev
, timev® *
cur
, 
»pÜt_š‹rv®
)

93 
timev®
 
d–
;

95 
d–
.
tv_£c
 = 
»pÜt_š‹rv®
/1000;

96 
d–
.
tv_u£c
 = (
»pÜt_š‹rv®
%1000)*1000;

97 ià(
	`£Ëù
(0, 
NULL
, NULL, NULL, &
d–
è< 0 && 
”ºo
 !ğ
EINTR
) {

98 
	`³¼Ü
("select");

99 
	`abÜt
();

101 
	`g‘timeofday
(
cur
, 
NULL
);

102 
	`tim”sub
(
cur
, 
´ev
, &
d–
);

103  
d–
.
tv_£c
* 1000000 + d–.
tv_u£c
;

105 
	}
}

	@include/debug.h

1 #iâdeà
__DEBUG_H_


2 
	#__DEBUG_H_


	)

4 
	~<”ºo.h
>

5 
	~<¡dio.h
>

6 
	~<as£¹.h
>

7 
	~"mtı.h
"

8 
	~"tı_š.h
"

10 #ifdeà
DBGTEMP


12 
	#TRACE_TEMP
(
f
, 
m
...) { \

13 
	`årštf
(
¡d”r
, "[CPU %d][%10s:%4d] " 
f
, 
mtı
->
ùx
->
ıu
, \

14 
__FUNCTION__
, 
__LINE__
, ##
m
); \

15 }

	)

19 
	#TRACE_TEMP
(
f
, 
m
...è()0

	)

23 #ifdeà
DBGERR


25 
	#TRACE_ERROR
(
f
, 
m
...) { \

26 
	`årštf
(
¡d”r
, "[%10s:%4d] " 
f
, 
__FUNCTION__
, 
__LINE__
, ##
m
); \

27 }

	)

31 
	#TRACE_ERROR
(
f
, 
m
...è()0

	)

35 #ifdeà
DBGCERR


37 
	#CTRACE_ERROR
(
f
, 
m
...) { \

38 
	`årštf
(
¡d”r
, "[CPU %d][%10s:%4d] " 
f
, 
mtı
->
ùx
->
ıu
, 
__FUNCTION__
, 
__LINE__
, ##
m
); \

39 }

	)

43 
	#CTRACE_ERROR
(
f
, 
m
...è()0

	)

47 #ifdeà
DBGMSG


49 
	#TRACE_DBG
(
f
, 
m
...) {\

50 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "[%10s:%4d] " \

51 
f
, 
__FUNCTION__
, 
__LINE__
, ##
m
); \

52 }

	)

56 
	#TRACE_DBG
(
f
, 
m
...è()0

	)

60 #ifdeà
INFO


62 
	#TRACE_INFO
(
f
, 
m
...) { \

63 
	`årštf
(
¡d”r
, "[%10s:%4d] " 
f
,
__FUNCTION__
, 
__LINE__
, ##
m
); \

64 }

	)

68 
	#TRACE_INFO
(
f
, 
m
...è()0

	)

72 
	#TRACE_CONFIG
(
f
, 
m
...è
	`årštf
(
¡d”r
, f, ##m)

	)

74 #ifdeà
DBGLOG


75 
	#TRACE_LOG
(
f
, 
m
...è
	`TRACE_INFO
(f, ##m)

	)

77 
	#TRACE_LOG
(
f
, 
m
...è()0

	)

80 #ifdeà
STREAM


81 
	#TRACE_STREAM
(
f
, 
m
...è
	`TRACE_FUNC
("STREAM", f, ##m)

	)

83 
	#TRACE_STREAM
(
f
, 
m
...è()0

	)

86 #ifdeà
STATE


87 
	#TRACE_STATE
(
f
, 
m
...è
	`TRACE_FUNC
("STATE", f, ##m)

	)

89 
	#TRACE_STATE
(
f
, 
m
...è()0

	)

92 #ifdeà
SNDBUF


93 
	#TRACE_SNDBUF
(
f
, 
m
...è
	`TRACE_FUNC
("SNDBUF", f, ##m)

	)

95 
	#TRACE_SNDBUF
(
f
, 
m
...è()0

	)

98 #ifdeà
RCVBUF


99 
	#TRACE_RCVBUF
(
f
, 
m
...è
	`TRACE_FUNC
("RCVBUF", f, ##m)

	)

101 
	#TRACE_RCVBUF
(
f
, 
m
...è()0

	)

104 #ifdeà
CLWND


105 
	#TRACE_CLWND
(
f
, 
m
...è
	`TRACE_FUNC
("CLWND", f, ##m)

	)

107 
	#TRACE_CLWND
(
f
, 
m
...è()0

	)

110 #ifdeà
LOSS


111 
	#TRACE_LOSS
(
f
, 
m
...è
	`TRACE_FUNC
("LOSS", f, ##m)

	)

113 
	#TRACE_LOSS
(
f
, 
m
...è()0

	)

116 #ifdeà
SACK


117 
	#TRACE_SACK
(
f
, 
m
...è
	`TRACE_FUNC
("SACK", f, ##m)

	)

119 
	#TRACE_SACK
(
f
, 
m
...è()0

	)

122 #ifdeà
TSTAMP


123 
	#TRACE_TSTAMP
(
f
, 
m
...è
	`TRACE_FUNC
("TSTAMP", f, ##m)

	)

125 
	#TRACE_TSTAMP
(
f
, 
m
...è()0

	)

128 #ifdeà
RTT


129 
	#TRACE_RTT
(
f
, 
m
...è
	`TRACE_FUNC
("RTT", f, ##m)

	)

131 
	#TRACE_RTT
(
f
, 
m
...è()0

	)

134 #ifdeà
RTO


135 
	#TRACE_RTO
(
f
, 
m
...è
	`TRACE_FUNC
("RTO", f, ##m)

	)

137 
	#TRACE_RTO
(
f
, 
m
...è()0

	)

140 #ifdeà
CONG


141 
	#TRACE_CONG
(
f
, 
m
...è
	`TRACE_FUNC
("CONG", f, ##m)

	)

143 
	#TRACE_CONG
(
f
, 
m
...è()0

	)

146 #ifdeà
EPOLL


147 
	#TRACE_EPOLL
(
f
, 
m
...è
	`TRACE_FUNC
("EPOLL", f, ##m)

	)

149 
	#TRACE_EPOLL
(
f
, 
m
...è()0

	)

152 #ifdeà
FSTAT


153 
	#TRACE_FSTAT
(
f
, 
m
...è
	`TRACE_FUNC
("FSTAT", f, ##m)

	)

155 
	#TRACE_FSTAT
(
f
, 
m
...è()0

	)

158 #ifdeà
APP


159 
	#TRACE_APP
(
f
, 
m
...è
	`TRACE_FUNC
("APP", f, ##m)

	)

161 
	#TRACE_APP
(
f
, 
m
...è()0

	)

164 #ifdeà
DBGFIN


165 
	#TRACE_FIN
(
f
, 
m
...è
	`TRACE_FUNC
("FIN", f, ##m)

	)

167 
	#TRACE_FIN
(
f
, 
m
...è()0

	)

170 #ifdeà
TSTAT


171 
	#TRACE_TSTAT
(
f
, 
m
...è
	`TRACE_FUNC
("TSTAT", f, ##m)

	)

173 
	#TRACE_TSTAT
(
f
, 
m
...è()0

	)

176 #ifdeà
LOOP


177 
	#TRACE_LOOP
(
f
, 
m
...è
	`TRACE_FUNC
("LOOP", "ts: %u, "f, 
cur_ts
, ##m)

	)

179 
	#TRACE_LOOP
(
f
, 
m
...è()0

	)

182 #ifdeà
ROUND


183 
	#TRACE_ROUND
(
f
, 
m
...è
	`TRACE_FUNC
("ROUND", f, ##m)

	)

185 
	#TRACE_ROUND
(
f
, 
m
...è()0

	)

188 #ifdeà
SELECT


189 
	#TRACE_SELECT
(
f
, 
m
...è
	`TRACE_FUNC
("SELECT", f, ##m)

	)

191 
	#TRACE_SELECT
(
f
, 
m
...è()0

	)

194 #ifdeà
API


195 
	#TRACE_API
(
f
, 
m
...è
	`TRACE_FUNC
("API", f, ##m)

	)

197 
	#TRACE_API
(
f
, 
m
...è()0

	)

200 #ifdeà
DBGFUNC


202 
	#TRACE_FUNC
(
n
, 
f
, 
m
...) { \

203 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "[%6s: %10s:%4d] " \

204 
f
, 
n
, 
__FUNCTION__
, 
__LINE__
, ##
m
); \

205 }

	)

209 
	#TRACE_FUNC
(
f
, 
m
...è()0

	)

214 
DumpPack‘
(
mtı_mªag”_t
 
mtı
, *
buf
, 
Ën
, *
¡•
, 
ifšdex
);

217 
DumpIPPack‘
(
mtı_mªag”_t
 
mtı
, cÚ¡ 
hdr
 *
h
, 
Ën
);

220 
DumpIPPack‘ToFe
(
FILE
 *
fout
, cÚ¡ 
hdr
 *
h
, 
Ën
);

223 
æush_log_d©a
(
mtı_mªag”_t
 
mtı
);

226 
th»ad_´štf
(
mtı_mªag”_t
 
mtı
, 
FILE
* 
f_idx
, cÚ¡ * 
_FÜm©
, ...);

	@include/eth_in.h

1 #iâdeà
__ETH_IN_H_


2 
	#__ETH_IN_H_


	)

4 
	~"mtı.h
"

7 
ProûssPack‘
(
mtı_mªag”_t
 
mtı
, cÚ¡ 
ifidx
,

8 
ušt32_t
 
cur_ts
, *
pkt_d©a
, 
Ën
);

	@include/eth_out.h

1 #iâdeà
__ETH_OUT_H_


2 
	#__ETH_OUT_H_


	)

4 
	~<¡dšt.h
>

6 
	~"mtı.h
"

7 
	~"tı_¡»am.h
"

8 
	~"ps.h
"

10 
	#MAX_SEND_PCK_CHUNK
 64

	)

12 
ušt8_t
 *

13 
Eth”ÃtOuut
(
mtı_mªag”
 *
mtı
, 
ušt16_t
 
h_´Ùo
,

14 
nif
, * 
d¡_haddr
, 
ušt16_t
 
Ën
);

	@include/eventpoll.h

1 #iâdeà
__EVENTPOLL_H_


2 
	#__EVENTPOLL_H_


	)

4 
	~"mtı_­i.h
"

5 
	~"mtı_•Şl.h
"

8 
	smtı_•Şl_¡©


10 
ušt64_t
 
	mÿÎs
;

11 
ušt64_t
 
	mwa™s
;

12 
ušt64_t
 
	mwakes
;

14 
ušt64_t
 
	missued
;

15 
ušt64_t
 
	m»gi¡”ed
;

16 
ušt64_t
 
	mšv®id©ed
;

17 
ušt64_t
 
	mhªdËd
;

20 
	smtı_•Şl_ev’t_št


22 
mtı_•Şl_ev’t
 
	mev
;

23 
	msockid
;

26 
	eev’t_queue_ty³


28 
	mUSR_EVENT_QUEUE
 = 0,

29 
	mUSR_SHADOW_EVENT_QUEUE
 = 1,

30 
	mMTCP_EVENT_QUEUE
 = 2

33 
	sev’t_queue


35 
mtı_•Şl_ev’t_št
 *
	mev’ts
;

36 
	m¡¬t
;

37 
	m’d
;

39 
	msize
;

40 
	mnum_ev’ts
;

43 
	smtı_•Şl


45 
ev’t_queue
 *
	mu¤_queue
;

46 
ev’t_queue
 *
	mu¤_shadow_queue
;

47 
ev’t_queue
 *
	mmtı_queue
;

49 
ušt8_t
 
	mwa™šg
;

50 
mtı_•Şl_¡©
 
	m¡©
;

52 
±h»ad_cÚd_t
 
	m•Şl_cÚd
;

53 
±h»ad_mu‹x_t
 
	m•Şl_lock
;

58 
Clo£EpŞlSock‘
(
mùx_t
 
mùx
, 
•id
);

	@include/fhash.h

1 #iâdeà
__FHASH_H_


2 
	#__FHASH_H_


	)

4 
	~<sys/queue.h
>

5 
	~"tı_¡»am.h
"

7 
	#NUM_BINS_FLOWS
 (131072è

	)

8 
	#NUM_BINS_LISTENERS
 (1024è

	)

9 
	#TCP_AR_CNT
 (3)

	)

11 
	shash_buck‘_h—d
 {

12 
tı_¡»am
 *
	mtqh_fœ¡
;

13 
tı_¡»am
 **
	mtqh_Ï¡
;

14 } 
	thash_buck‘_h—d
;

16 
	sli¡_buck‘_h—d
 {

17 
tı_li¡’”
 *
	mtqh_fœ¡
;

18 
tı_li¡’”
 **
	mtqh_Ï¡
;

19 } 
	tli¡_buck‘_h—d
;

22 
	shashbË
 {

23 
ušt8_t
 
	mht_couÁ
 ;

24 
ušt32_t
 
	mbšs
;

27 
hash_buck‘_h—d
 *
	mht_bË
;

28 
li¡_buck‘_h—d
 *
	mÉ_bË
;

32 (*
	mhashâ
) (const *);

33 (*
	meqâ
) (const *, const *);

37 
hashbË
 *
C»©eHashbË
((*
hashâ
) (const *),

38 (*
eqâ
) (const *,

40 
bšs
);

41 
	`De¡royHashbË
(
hashbË
 *
ht
);

44 
	`SŒ—mHTIn£¹
(
hashbË
 *
ht
, *);

45 * 
	`SŒ—mHTRemove
(
hashbË
 *
ht
, *);

46 *
	`SŒ—mHTS—rch
(
hashbË
 *
ht
, const *);

47 
	`HashLi¡’”
(cÚ¡ *
hbo_pÜt_±r
);

48 
	`Equ®Li¡’”
(cÚ¡ *
hbo_pÜt_±r1
, cÚ¡ *
hbo_pÜt_±r2
);

49 
	`Li¡’”HTIn£¹
(
hashbË
 *
ht
, *);

50 *
	`Li¡’”HTRemove
(
hashbË
 *
ht
, *);

51 *
	`Li¡’”HTS—rch
(
hashbË
 *
ht
, const *);

	@include/icmp.h

1 #iâdeà
__ICMP_H_


2 
	#__ICMP_H_


	)

4 
	sicmphdr
 {

5 
ušt8_t
 
	micmp_ty³
;

6 
ušt8_t
 
	micmp_code
;

7 
ušt16_t
 
	micmp_checksum
;

10 
ušt16_t
 
	micmp_id
;

11 
ušt16_t
 
	micmp_£qu’û
;

12 } 
	mecho
;

14 
ušt16_t
 
	munu£d
;

15 
ušt16_t
 
	mnhİ_mtu
;

16 } 
	mde¡
;

17 } 
	mun
;

21 
	#ICMP_ECHO_GET_ID
(
icmph
è(icmph->
un
.
echo
.
icmp_id
)

	)

22 
	#ICMP_ECHO_GET_SEQ
(
icmph
è(icmph->
un
.
echo
.
icmp_£qu’û
)

	)

23 
	#ICMP_DEST_UNREACH_GET_MTU
(
icmph
è(icmph->
un
.
de¡
.
nhİ_mtu
)

	)

25 
	#ICMP_ECHO_SET_ID
(
icmph
, 
id
è(icmph->
un
.
echo
.
icmp_id
 = id)

	)

26 
	#ICMP_ECHO_SET_SEQ
(
icmph
, 
£q
è(icmph->
un
.
echo
.
icmp_£qu’û
 = seq)

	)

29 
Reque¡ICMP
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
,

30 
ušt16_t
 
icmp_id
, ušt16_ˆ
icmp_£q
,

31 
ušt8_t
 *
icmpd
, 
ušt16_t
 
Ën
);

34 
ProûssICMPPack‘
(
mtı_mªag”_t
 
mtı
, 
hdr
 *
h
, 
Ën
);

37 
	#ICMP_ECHOREPLY
 0

	)

38 
	#ICMP_DEST_UNREACH
 3

	)

39 
	#ICMP_SOURCE_QUENCH
 4

	)

40 
	#ICMP_REDIRECT
 5

	)

41 
	#ICMP_ECHO
 8

	)

42 
	#ICMP_TIME_EXCEEDED
 11

	)

43 
	#ICMP_PARAMETERPROB
 12

	)

44 
	#ICMP_TIMESTAMP
 13

	)

45 
	#ICMP_TIMESTAMPREPLY
 14

	)

46 
	#ICMP_INFO_REQUEST
 15

	)

47 
	#ICMP_INFO_REPLY
 16

	)

48 
	#ICMP_ADDRESS
 17

	)

49 
	#ICMP_ADDRESSREPLY
 18

	)

	@include/io_module.h

1 #iâdeà
__IO_MODULE_H__


2 
	#__IO_MODULE_H__


	)

5 
	~<¡dšt.h
>

7 
	~"ps.h
"

12 
	gmtı_th»ad_cÚ‹xt
;

56 
	sio_moduË_func
 {

57 (*
	mlßd_moduË
)();

58 (*
	mš™_hªdË
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
);

59 
št32_t
 (*
lšk_deviûs
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
);

60 (*
	m»Ëa£_pkt
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mifidx
, *
	mpkt_d©a
, 
	mËn
);

61 
	mušt8_t
 * (*
	mg‘_w±r
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mifidx
, 
ušt16_t
 
	mËn
);

62 
št32_t
 (*
£nd_pkts
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mnif
);

63 
	mušt8_t
 * (*
	mg‘_½Œ
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mifidx
, 
	mšdex
, 
ušt16_t
 *
	mËn
);

64 
št32_t
 (*
»cv_pkts
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mifidx
);

65 
št32_t
 (*
£Ëù
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
);

66 (*
	mde¡roy_hªdË
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
);

67 
št32_t
 (*
dev_ioùl
)(
mtı_th»ad_cÚ‹xt
 *
	mùx
, 
	mnif
, 
	mcmd
, *
	m¬gp
);

68 } 
	tio_moduË_func
 
	t__©Œibu‹__
((
	t®igÃd
(
	t__WORDSIZE
)));

71 
S‘IÁ”çûInfo
(*);

74 
io_moduË_func
 *
cu¼’t_iomoduË_func
;

77 
	#PKT_TX_IP_CSUM
 0x01

	)

78 
	#PKT_TX_TCP_CSUM
 0x02

	)

79 
	#PKT_RX_TCP_LROSEG
 0x03

	)

80 
	#PKT_TX_TCPIP_CSUM
 0x04

	)

81 
	#PKT_RX_IP_CSUM
 0x05

	)

82 
	#PKT_RX_TCP_CSUM
 0x06

	)

83 
	#PKT_TX_TCPIP_CSUM_PEEK
 0x07

	)

84 
	#DISABLE_DPDK
 1

	)

86 #ifdeà
DISABLE_PSIO


87 
	#ps_li¡_deviûs
(
x
è0

	)

89 
io_moduË_func
 
ps_moduË_func
;

90 
ps_deviû
 
deviûs
[
MAX_DEVICES
];

93 
io_moduË_func
 
dpdk_moduË_func
;

96 
io_moduË_func
 
Ãtm­_moduË_func
;

99 
	#AssignIOModuË
(
m
) { \

100 ià(!
	`¡rcmp
(
m
, "psio")) \

101 
cu¼’t_iomoduË_func
 = &
ps_moduË_func
; \

102 ià(!
	`¡rcmp
(
m
, "dpdk")) \

103 
cu¼’t_iomoduË_func
 = &
dpdk_moduË_func
; \

104 ià(!
	`¡rcmp
(
m
, "netmap")) \

105 
cu¼’t_iomoduË_func
 = &
Ãtm­_moduË_func
; \

107 
	`as£¹
(0); \

108 }

	)

	@include/ip_in.h

1 #iâdeà
__IP_IN_H_


2 
	#__IP_IN_H_


	)

4 
	~"mtı.h
"

7 
ProûssIPv4Pack‘
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

8 cÚ¡ 
ifidx
, * 
pkt_d©a
, 
Ën
);

	@include/ip_out.h

1 #iâdeà
__IP_OUT_H_


2 
	#__IP_OUT_H_


	)

4 
	~<¡dšt.h
>

5 
	~"tı_¡»am.h
"

8 
G‘OuutIÁ”çû
(
ušt32_t
 
daddr
);

11 
FÜw¬dIPv4Pack‘
(
mtı_mªag”_t
 
mtı
, 
nif_š
, *
buf
, 
Ën
);

13 
ušt8_t
 *

14 
IPOuutSnd®Úe
(
mtı_mªag”
 *
mtı
, 
ušt8_t
 
´ÙocŞ
,

15 
ušt16_t
 
_id
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
, ušt16_ˆ
tıËn
);

17 
ušt8_t
 *

18 
IPOuut
(
mtı_mªag”
 *
mtı
, 
tı_¡»am
 *
¡»am
, 
ušt16_t
 
tıËn
);

	@include/logger.h

1 #iâdeà
__LOGGER_H_


2 
	#__LOGGER_H_


	)

4 
	~<¡dšt.h
>

6 
	#LOG_BUFF_SIZE
 (256*1024)

	)

7 
	#NUM_LOG_BUFF
 (100)

	)

10 
	mIDLE_LOGT
,

11 
	mACTIVE_LOGT


12 } 
	glog_th»ad_¡©e
;

14 
	slog_buff


16 
	mtid
;

17 
FILE
* 
	mfid
;

18 
	mbuff_Ën
;

19 
	mbuff
[
LOG_BUFF_SIZE
];

20 
TAILQ_ENTRY
(
log_buff
è
	mbuff_lšk
;

21 } 
	tlog_buff
;

23 
	slog_th»ad_cÚ‹xt
 {

24 
±h»ad_t
 
	mth»ad
;

25 
	mıu
;

26 
	mdÚe
;

27 
	m¥_fd
;

28 
	m·œ_¥_fd
;

29 
	mä“_buff_út
;

30 
	mjob_buff_út
;

32 
ušt8_t
 
	m¡©e
;

34 
±h»ad_mu‹x_t
 
	mmu‹x
;

35 
±h»ad_mu‹x_t
 
	mä“_mu‹x
;

37 
TAILQ_HEAD
(, 
log_buff
è
	mwÜkšg_queue
;

38 
TAILQ_HEAD
(, 
log_buff
è
	mä“_queue
;

40 } 
	tlog_th»ad_cÚ‹xt
;

42 
log_buff
* 
DequeueF»eBufãr
 (
log_th»ad_cÚ‹xt
 *
ùx
);

43 
EnqueueJobBufãr
(
log_th»ad_cÚ‹xt
 *
ùx
, 
log_buff
* 
wÜkšg_bp
);

44 
In™LogTh»adCÚ‹xt
 (
log_th»ad_cÚ‹xt
 *
ùx
, 
ıu
);

45 *
Th»adLogMaš
(* 
¬g
);

	@include/memory_mgt.h

1 #iâdeà
__MEMORY_MGT_H_


2 
	#__MEMORY_MGT_H_


	)

4 
	gmem_poŞ
;

5 
mem_poŞ
* 
	tmem_poŞ_t
;

9 
mem_poŞ_t
 
MPC»©e
(
chunk_size
, 
size_t
 
tÙ®_size
, 
is_hug•age
);

12 *
MPAÎoÿ‹Chunk
(
mem_poŞ_t
 
mp
);

15 
MPF»eChunk
(
mem_poŞ_t
 
mp
, *
p
);

18 
MPDe¡roy
(
mem_poŞ_t
 
mp
);

21 
MPG‘F»eChunks
(
mem_poŞ_t
 
mp
);

	@include/mtcp.h

1 #iâdeà
__MTCP_H_


2 
	#__MTCP_H_


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<sys/time.h
>

7 
	~<sys/queue.h
>

8 
	~<±h»ad.h
>

10 
	~"memÜy_mgt.h
"

11 
	~"tı_ršg_bufãr.h
"

12 
	~"tı_£nd_bufãr.h
"

13 
	~"tı_¡»am_queue.h
"

14 
	~"sock‘.h
"

15 
	~"mtı_­i.h
"

16 
	~"ev’Şl.h
"

17 
	~"addr_poŞ.h
"

18 
	~"ps.h
"

19 
	~"logg”.h
"

20 
	~"¡©.h
"

21 
	~"io_moduË.h
"

23 #iâdeà
TRUE


24 
	#TRUE
 (1)

	)

27 #iâdeà
FALSE


28 
	#FALSE
 (0)

	)

31 #iâdeà
ERROR


32 
	#ERROR
 (-1)

	)

35 
	#MAX_CPUS
 16

	)

37 
	#ETHERNET_HEADER_LEN
 14

38 
	#IP_HEADER_LEN
 20

39 
	#TCP_HEADER_LEN
 20

40 
	#TOTAL_TCP_HEADER_LEN
 54

41 

	)

43 
	#BACKLOG_SIZE
 (10*1024)

	)

44 
	#MAX_PKT_SIZE
 (2*1024)

	)

45 
	#ETH_NUM
 4

	)

47 
	#TCP_OPT_TIMESTAMP_ENABLED
 
TRUE


	)

48 
	#TCP_OPT_SACK_ENABLED
 
FALSE


	)

50 
	#LOCK_STREAM_QUEUE
 
FALSE


	)

51 
	#USE_SPIN_LOCK
 
TRUE


	)

52 
	#INTR_SLEEPING_MTCP
 
TRUE


	)

53 
	#PROMISCUOUS_MODE
 
TRUE


	)

56 
	#BLOCKING_SUPPORT
 
FALSE


	)

60 #ifdeà
NETSTAT


61 
	#NETSTAT_PERTHREAD
 
TRUE


	)

62 
	#NETSTAT_TOTAL
 
TRUE


	)

64 
	#RTM_STAT
 
FALSE


	)

67 #ià
USE_SPIN_LOCK


68 
	#SBUF_LOCK_INIT
(
lock
, 
”rmsg
, 
aùiÚ
); \

69 ià(
	`±h»ad_¥š_š™
(
lock
, 
PTHREAD_PROCESS_PRIVATE
)) { \

70 
	`³¼Ü
("±h»ad_¥š_š™" 
”rmsg
); \

71 
aùiÚ
; \

72 }

	)

73 
	#SBUF_LOCK_DESTROY
(
lock
è
	`±h»ad_¥š_de¡roy
Öock)

	)

74 
	#SBUF_LOCK
(
lock
è
	`±h»ad_¥š_lock
Öock)

	)

75 
	#SBUF_UNLOCK
(
lock
è
	`±h»ad_¥š_uÆock
Öock)

	)

77 
	#SBUF_LOCK_INIT
(
lock
, 
”rmsg
, 
aùiÚ
); \

78 ià(
	`±h»ad_mu‹x_š™
(
lock
, 
NULL
)) { \

79 
	`³¼Ü
("±h»ad_mu‹x_š™" 
”rmsg
); \

80 
aùiÚ
; \

81 }

	)

82 
	#SBUF_LOCK_DESTROY
(
lock
è
	`±h»ad_mu‹x_de¡roy
Öock)

	)

83 
	#SBUF_LOCK
(
lock
è
	`±h»ad_mu‹x_lock
Öock)

	)

84 
	#SBUF_UNLOCK
(
lock
è
	`±h»ad_mu‹x_uÆock
Öock)

	)

87 
	s‘h_bË


89 
	mdev_Çme
[128];

90 
	mifšdex
;

91 
	m¡©_´št
;

92 
	mhaddr
[
ETH_ALEN
];

93 
ušt32_t
 
	mÃtmask
;

95 
ušt32_t
 
	m_addr
;

98 
	srou‹_bË


100 
ušt32_t
 
	mdaddr
;

101 
ušt32_t
 
	mmask
;

102 
ušt32_t
 
	mmasked
;

103 
	m´efix
;

104 
	mnif
;

107 
	s¬p_’Œy


109 
ušt32_t
 
	m
;

110 
št8_t
 
	m´efix
;

111 
ušt32_t
 
	m_mask
;

112 
ušt32_t
 
	m_masked
;

113 
	mhaddr
[
ETH_ALEN
];

116 
	s¬p_bË


118 
¬p_’Œy
 *
	m’Œy
;

119 
	m’Œ›s
;

122 
	smtı_cÚfig


125 
št8_t
 
	msock‘_mode
;

128 
‘h_bË
 *
	m‘hs
;

129 
	m‘hs_num
;

132 
rou‹_bË
 *
	m¹abË
;

133 
	mrou‹s
;

136 
¬p_bË
 
	m¬p
;

138 
	mnum_cÜes
;

139 
	mnum_mem_ch
;

140 
	mmax_cÚcu¼’cy
;

142 
	mmax_num_bufãrs
;

143 
	mrcvbuf_size
;

144 
	m¢dbuf_size
;

146 
	mtı_timewa™
;

147 
	mtı_timeout
;

150 
ušt8_t
 
	mmuÉi_´oûss
;

151 
ušt8_t
 
	mmuÉi_´oûss_is_ma¡”
;

152 
ušt8_t
 
	mmuÉi_´oûss_cu¼_cÜe
;

155 
	smtı_cÚ‹xt


157 
	mıu
;

160 
	smtı_£nd”


162 
	mifidx
;

165 
TAILQ_HEAD
 (
cÚŒŞ_h—d
, 
tı_¡»am
è
	mcÚŒŞ_li¡
;

166 
TAILQ_HEAD
 (
£nd_h—d
, 
tı_¡»am
è
	m£nd_li¡
;

167 
TAILQ_HEAD
 (
ack_h—d
, 
tı_¡»am
è
	mack_li¡
;

169 
	mcÚŒŞ_li¡_út
;

170 
	m£nd_li¡_út
;

171 
	mack_li¡_út
;

174 
	smtı_mªag”


176 
mem_poŞ_t
 
	mæow_poŞ
;

177 
mem_poŞ_t
 
	mrv_poŞ
;

178 
mem_poŞ_t
 
	msv_poŞ
;

179 
mem_poŞ_t
 
	mmv_poŞ
;

182 
sb_mªag”_t
 
	mrbm_¢d
;

183 
rb_mªag”_t
 
	mrbm_rcv
;

184 
hashbË
 *
	mtı_æow_bË
;

186 
ušt32_t
 
	ms_šdex
:24;

187 
sock‘_m­_t
 
	msm­
;

188 
TAILQ_HEAD
 (, 
sock‘_m­
è
	mä“_sm­
;

190 
addr_poŞ_t
 
	m­
;

192 
ušt32_t
 
	mg_id
;

193 
ušt32_t
 
	mæow_út
;

195 
mtı_th»ad_cÚ‹xt
* 
	mùx
;

198 
	m¥_fd
;

199 
log_th»ad_cÚ‹xt
* 
	mlogg”
;

200 
log_buff
* 
	mw_bufãr
;

201 
FILE
 *
	mlog_å
;

204 
mtı_•Şl
 *
	m•
;

205 
ušt32_t
 
	mts_Ï¡_ev’t
;

207 
hashbË
 *
	mli¡’”s
;

209 
¡»am_queue_t
 
	mcÚÃùq
;

210 
¡»am_queue_t
 
	m£ndq
;

211 
¡»am_queue_t
 
	mackq
;

213 
¡»am_queue_t
 
	mşo£q
;

214 
¡»am_queue_št
 *
	mşo£q_št
;

215 
¡»am_queue_t
 
	m»£tq
;

216 
¡»am_queue_št
 *
	m»£tq_št
;

218 
¡»am_queue_t
 
	mde¡royq
;

220 
mtı_£nd”
 *
	mg_£nd”
;

221 
mtı_£nd”
 *
	mn_£nd”
[
ETH_NUM
];

224 
¹o_hash¡Üe
* 
	m¹o_¡Üe
;

225 
TAILQ_HEAD
 (
timewa™_h—d
, 
tı_¡»am
è
	mtimewa™_li¡
;

226 
TAILQ_HEAD
 (
timeout_h—d
, 
tı_¡»am
è
	mtimeout_li¡
;

228 
	m¹o_li¡_út
;

229 
	mtimewa™_li¡_út
;

230 
	mtimeout_li¡_út
;

232 #ià
BLOCKING_SUPPORT


233 
TAILQ_HEAD
 (
rcv_br_h—d
, 
tı_¡»am
è
	mrcv_br_li¡
;

234 
TAILQ_HEAD
 (
¢d_br_h—d
, 
tı_¡»am
è
	m¢d_br_li¡
;

235 
	mrcv_br_li¡_út
;

236 
	m¢d_br_li¡_út
;

239 
ušt32_t
 
	mcur_ts
;

241 
	mwakeup_æag
;

242 
	mis_¦“pšg
;

245 
bÿ¡_¡©
 
	mb¡©
;

246 
timeout_¡©
 
	mt¡©
;

247 #ifdeà
NETSTAT


248 
Ãt_¡©
 
	mn¡©
;

249 
Ãt_¡©
 
	mp_n¡©
;

250 
ušt32_t
 
	mp_n¡©_ts
;

252 
run_¡©
 
	mrun¡©
;

253 
run_¡©
 
	mp_run¡©
;

255 
time_¡©
 
	m¹¡©
;

257 
io_moduË_func
 *
	miom
;

260 
mtı_mªag”
* 
	tmtı_mªag”_t
;

262 
mtı_mªag”_t


263 
G‘MTCPMªag”
(
mùx_t
 
mùx
);

265 
	smtı_th»ad_cÚ‹xt


267 
	mıu
;

268 
±h»ad_t
 
	mth»ad
;

269 
ušt8_t
 
	mdÚe
:1,

270 
	mex™
:1,

271 
	mš‹¼u±
:1;

273 
mtı_mªag”
* 
	mmtı_mªag”
;

275 *
	mio_´iv©e_cÚ‹xt
;

276 
±h»ad_mu‹x_t
 
	msm­_lock
;

277 
±h»ad_mu‹x_t
 
	mæow_poŞ_lock
;

278 
±h»ad_mu‹x_t
 
	msock‘_poŞ_lock
;

280 #ià
LOCK_STREAM_QUEUE


281 #ià
USE_SPIN_LOCK


282 
±h»ad_¥šlock_t
 
	mcÚÃù_lock
;

283 
±h»ad_¥šlock_t
 
	mşo£_lock
;

284 
±h»ad_¥šlock_t
 
	m»£t_lock
;

285 
±h»ad_¥šlock_t
 
	m£ndq_lock
;

286 
±h»ad_¥šlock_t
 
	mackq_lock
;

287 
±h»ad_¥šlock_t
 
	mde¡royq_lock
;

289 
±h»ad_mu‹x_t
 
	mcÚÃù_lock
;

290 
±h»ad_mu‹x_t
 
	mşo£_lock
;

291 
±h»ad_mu‹x_t
 
	m»£t_lock
;

292 
±h»ad_mu‹x_t
 
	m£ndq_lock
;

293 
±h»ad_mu‹x_t
 
	mackq_lock
;

294 
±h»ad_mu‹x_t
 
	mde¡royq_lock
;

299 
mtı_th»ad_cÚ‹xt
* 
	tmtı_th»ad_cÚ‹xt_t
;

301 
mtı_mªag”
 *
g_mtı
[
MAX_CPUS
];

302 
mtı_cÚfig
 
CONFIG
;

303 
addr_poŞ_t
 
­
[
ETH_NUM
];

	@include/mtcp_api.h

1 #iâdeà
__MTCP_API_H_


2 
	#__MTCP_API_H_


	)

4 
	~<¡dšt.h
>

5 
	~<Ãtš‘/š.h
>

6 
	~<sys/uio.h
>

8 #iâdeà
UNUSED


9 
	#UNUSED
(
x
è()
	)
x

12 #iâdeà
INPORT_ANY


13 
	#INPORT_ANY
 (
ušt16_t
)0

	)

16 #ifdeà
__ılu¥lus


20 
	esock‘_ty³


22 
MTCP_SOCK_UNUSED
,

23 
MTCP_SOCK_STREAM
,

24 
MTCP_SOCK_PROXY
,

25 
MTCP_SOCK_LISTENER
,

26 
MTCP_SOCK_EPOLL
,

27 
MTCP_SOCK_PIPE
,

30 
	smtı_cÚf


32 
num_cÜes
;

33 
max_cÚcu¼’cy
;

35 
max_num_bufãrs
;

36 
rcvbuf_size
;

37 
¢dbuf_size
;

39 
tı_timewa™
;

40 
tı_timeout
;

43 
mtı_cÚ‹xt
 *
	tmùx_t
;

46 
mtı_š™
(cÚ¡ *
cÚfig_fe
);

49 
mtı_de¡roy
();

52 
mtı_g‘cÚf
(
mtı_cÚf
 *
cÚf
);

55 
mtı_£tcÚf
(cÚ¡ 
mtı_cÚf
 *
cÚf
);

58 
mtı_cÜe_affš™ize
(
ıu
);

60 
mùx_t


61 
mtı_ü—‹_cÚ‹xt
(
ıu
);

64 
mtı_de¡roy_cÚ‹xt
(
mùx_t
 
mùx
);

66 (*
mtı_sighªdËr_t
)();

68 
mtı_sighªdËr_t


69 
mtı_»gi¡”_sigÇl
(
signum
, 
mtı_sighªdËr_t
 
hªdËr
);

72 
mtı_pe
(
mùx_t
 
mùx
, 
peid
[2]);

75 
mtı_g‘sockİt
(
mùx_t
 
mùx
, 
sockid
, 
Ëv–
,

76 
İŠame
, *
İtv®
, 
sockËn_t
 *
İ’
);

79 
mtı_£tsockİt
(
mùx_t
 
mùx
, 
sockid
, 
Ëv–
,

80 
İŠame
, cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
);

83 
mtı_£tsock_nÚblock
(
mùx_t
 
mùx
, 
sockid
);

88 
mtı_sock‘_ioùl
(
mùx_t
 
mùx
, 
sockid
, 
»que¡
, *
¬gp
);

91 
mtı_sock‘
(
mùx_t
 
mùx
, 
domaš
, 
ty³
, 
´ÙocŞ
);

94 
mtı_bšd
(
mùx_t
 
mùx
, 
sockid
,

95 cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

98 
mtı_li¡’
(
mùx_t
 
mùx
, 
sockid
, 
backlog
);

101 
mtı_acû±
(
mùx_t
 
mùx
, 
sockid
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

104 
mtı_š™_rss
(
mùx_t
 
mùx
, 
š_addr_t
 
§ddr_ba£
, 
num_addr
,

105 
š_addr_t
 
daddr
, in_addr_ˆ
dpÜt
);

108 
mtı_cÚÃù
(
mùx_t
 
mùx
, 
sockid
,

109 cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

112 
mtı_şo£
(
mùx_t
 
mùx
, 
sockid
);

121 
mtı_g‘sockÇme
(
mùx_t
 
mùx
, 
sock
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

124 
mtı_g‘³”Çme
(
mùx_t
 
mùx
, 
sockid
, 
sockaddr
 *
addr
,

125 
sockËn_t
 *
add¾’
);

127 
ssize_t


128 
mtı_»ad
(
mùx_t
 
mùx
, 
sockid
, *
buf
, 
size_t
 
Ën
);

130 
ssize_t


131 
mtı_»cv
(
mùx_t
 
mùx
, 
sockid
, *
buf
, 
size_t
 
Ën
, 
æags
);

135 
mtı_»adv
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ 
iovec
 *
iov
, 
numIOV
);

137 
ssize_t


138 
mtı_wr™e
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ *
buf
, 
size_t
 
Ën
);

142 
mtı_wr™ev
(
mùx_t
 
mùx
, 
sockid
, cÚ¡ 
iovec
 *
iov
, 
numIOV
);

144 #ifdeà
__ılu¥lus


	@include/mtcp_epoll.h

1 #iâdeà
__MTCP_EPOLL_H_


2 
	#__MTCP_EPOLL_H_


	)

4 
	~"mtı_­i.h
"

6 #ifdeà
__ılu¥lus


11 
	emtı_•Şl_İ


13 
MTCP_EPOLL_CTL_ADD
 = 1,

14 
MTCP_EPOLL_CTL_DEL
 = 2,

15 
MTCP_EPOLL_CTL_MOD
 = 3,

18 
	emtı_ev’t_ty³


20 
MTCP_EPOLLNONE
 = 0x000,

21 
MTCP_EPOLLIN
 = 0x001,

22 
MTCP_EPOLLPRI
 = 0x002,

23 
MTCP_EPOLLOUT
 = 0x004,

24 
MTCP_EPOLLRDNORM
 = 0x040,

25 
MTCP_EPOLLRDBAND
 = 0x080,

26 
MTCP_EPOLLWRNORM
 = 0x100,

27 
MTCP_EPOLLWRBAND
 = 0x200,

28 
MTCP_EPOLLMSG
 = 0x400,

29 
MTCP_EPOLLERR
 = 0x008,

30 
MTCP_EPOLLHUP
 = 0x010,

31 
MTCP_EPOLLRDHUP
 = 0x2000,

32 
MTCP_EPOLLONESHOT
 = (1 << 30),

33 
MTCP_EPOLLET
 = (1 << 31)

36 
	umtı_•Şl_d©a


38 *
±r
;

39 
sockid
;

40 
ušt32_t
 
u32
;

41 
ušt64_t
 
u64
;

42 } 
	tmtı_•Şl_d©a_t
;

44 
	smtı_•Şl_ev’t


46 
ušt32_t
 
ev’ts
;

47 
mtı_•Şl_d©a_t
 
d©a
;

51 
mtı_•Şl_ü—‹
(
mùx_t
 
mùx
, 
size
);

54 
mtı_•Şl_ùl
(
mùx_t
 
mùx
, 
•id
,

55 
İ
, 
sockid
, 
mtı_•Şl_ev’t
 *
ev’t
);

58 
mtı_•Şl_wa™
(
mùx_t
 
mùx
, 
•id
,

59 
mtı_•Şl_ev’t
 *
ev’ts
, 
maxev’ts
, 
timeout
);

62 
Ev’tToSŒšg
(
ušt32_t
 
ev’t
);

65 #ifdeà
__ılu¥lus


	@include/netmap.h

39 #iâdeà
_NET_NETMAP_H_


40 
	#_NET_NETMAP_H_


	)

42 
	#NETMAP_API
 11

	)

44 
	#NETMAP_MIN_API
 11

	)

45 
	#NETMAP_MAX_API
 15

	)

52 
	#NM_CACHE_ALIGN
 128

	)

145 
	sÃtm­_¦Ù
 {

146 
ušt32_t
 
	mbuf_idx
;

147 
ušt16_t
 
	mËn
;

148 
ušt16_t
 
	mæags
;

149 
ušt64_t
 
	m±r
;

156 
	#NS_BUF_CHANGED
 0x0001

	)

167 
	#NS_REPORT
 0x0002

	)

175 
	#NS_FORWARD
 0x0004

	)

184 
	#NS_NO_LEARN
 0x0008

	)

190 
	#NS_INDIRECT
 0x0010

	)

196 
	#NS_MOREFRAG
 0x0020

	)

203 
	#NS_PORT_SHIFT
 8

	)

204 
	#NS_PORT_MASK
 (0xfà<< 
NS_PORT_SHIFT
)

	)

211 
	#NS_RFRAGS
(
_¦Ù
èĞ((_¦Ù)->
æags
 >> 8è& 0xff)

	)

259 
	sÃtm­_ršg
 {

265 cÚ¡ 
št64_t
 
	mbuf_ofs
;

266 cÚ¡ 
ušt32_t
 
	mnum_¦Ùs
;

267 cÚ¡ 
ušt32_t
 
	mÄ_buf_size
;

268 cÚ¡ 
ušt16_t
 
	mršgid
;

269 cÚ¡ 
ušt16_t
 
	mdœ
;

271 
ušt32_t
 
	mh—d
;

272 
ušt32_t
 
	mcur
;

273 
ušt32_t
 
	m
;

275 
ušt32_t
 
	mæags
;

277 
timev®
 
	mts
;

280 #ià!
defšed
(
_WIN32
è|| defšed(
__CYGWIN__
)

281 
ušt8_t
 
__©Œibu‹__
((
__®igÃd__
(
NM_CACHE_ALIGN
))è
	m£m
[128];

283 
ušt8_t
 
__deş¥ec
(
®ign
(
NM_CACHE_ALIGN
)è
	m£m
[128];

287 
Ãtm­_¦Ù
 
	m¦Ù
[0];

294 
	#NR_TIMESTAMP
 0x0002

	)

301 
	#NR_FORWARD
 0x0004

	)

318 
	sÃtm­_if
 {

319 
	mni_Çme
[
IFNAMSIZ
];

320 cÚ¡ 
ušt32_t
 
	mni_v”siÚ
;

321 cÚ¡ 
ušt32_t
 
	mni_æags
;

322 
	#NI_PRIV_MEM
 0x1

	)

331 cÚ¡ 
ušt32_t
 
	mni_tx_ršgs
;

332 cÚ¡ 
ušt32_t
 
	mni_rx_ršgs
;

334 
ušt32_t
 
	mni_bufs_h—d
;

335 
ušt32_t
 
	mni_¥¬e1
[5];

345 cÚ¡ 
ssize_t
 
	mršg_ofs
[0];

349 #iâdeà
NIOCREGIF


474 
	snm»q
 {

475 
	mÄ_Çme
[
IFNAMSIZ
];

476 
ušt32_t
 
	mÄ_v”siÚ
;

477 
ušt32_t
 
	mÄ_off£t
;

478 
ušt32_t
 
	mÄ_memsize
;

479 
ušt32_t
 
	mÄ_tx_¦Ùs
;

480 
ušt32_t
 
	mÄ_rx_¦Ùs
;

481 
ušt16_t
 
	mÄ_tx_ršgs
;

482 
ušt16_t
 
	mÄ_rx_ršgs
;

484 
ušt16_t
 
	mÄ_ršgid
;

485 
	#NETMAP_HW_RING
 0x4000

	)

486 
	#NETMAP_SW_RING
 0x2000

	)

488 
	#NETMAP_RING_MASK
 0x0ffà

	)

490 
	#NETMAP_NO_TX_POLL
 0x1000

	)

492 
	#NETMAP_DO_RX_POLL
 0x8000

	)

494 
ušt16_t
 
	mÄ_cmd
;

495 
	#NETMAP_BDG_ATTACH
 1

	)

496 
	#NETMAP_BDG_DETACH
 2

	)

497 
	#NETMAP_BDG_REGOPS
 3

	)

498 
	#NETMAP_BDG_LIST
 4

	)

499 
	#NETMAP_BDG_VNET_HDR
 5

	)

500 
	#NETMAP_BDG_OFFSET
 
NETMAP_BDG_VNET_HDR


	)

501 
	#NETMAP_BDG_NEWIF
 6

	)

502 
	#NETMAP_BDG_DELIF
 7

	)

503 
	#NETMAP_PT_HOST_CREATE
 8

	)

504 
	#NETMAP_PT_HOST_DELETE
 9

	)

505 
	#NETMAP_BDG_POLLING_ON
 10

	)

506 
	#NETMAP_BDG_POLLING_OFF
 11

	)

507 
	#NETMAP_VNET_HDR_GET
 12

	)

508 
ušt16_t
 
	mÄ_¬g1
;

509 
	#NETMAP_BDG_HOST
 1

	)

511 
ušt16_t
 
	mÄ_¬g2
;

512 
ušt32_t
 
	mÄ_¬g3
;

513 
ušt32_t
 
	mÄ_æags
;

515 
ušt32_t
 
	m¥¬e2
[1];

518 
	#NR_REG_MASK
 0xà

	)

519 ’um { 
	mNR_REG_DEFAULT
 = 0,

520 
	mNR_REG_ALL_NIC
 = 1,

521 
	mNR_REG_SW
 = 2,

522 
	mNR_REG_NIC_SW
 = 3,

523 
	mNR_REG_ONE_NIC
 = 4,

524 
	mNR_REG_PIPE_MASTER
 = 5,

525 
	mNR_REG_PIPE_SLAVE
 = 6,

528 
	#NR_MONITOR_TX
 0x100

	)

529 
	#NR_MONITOR_RX
 0x200

	)

530 
	#NR_ZCOPY_MON
 0x400

	)

532 
	#NR_EXCLUSIVE
 0x800

	)

534 
	#NR_PASSTHROUGH_HOST
 
NR_PTNETMAP_HOST


	)

535 
	#NR_PTNETMAP_HOST
 0x1000

	)

536 
	#NR_RX_RINGS_ONLY
 0x2000

	)

537 
	#NR_TX_RINGS_ONLY
 0x4000

	)

543 
	#NR_ACCEPT_VNET_HDR
 0x8000

	)

552 #ifdeà
_WIN32


553 #undeà
_IO


554 
	#_WIN_NM_IOCTL_TYPE
 40000

	)

555 
	#_IO
(
_c
, 
_n
è
	`CTL_CODE
(
_WIN_NM_IOCTL_TYPE
, ((_n) + 0x800) , \

556 
METHOD_BUFFERED
, 
FILE_ANY_ACCESS
 )

	)

557 
	#_IO_dœeù
(
_c
, 
_n
è
	`CTL_CODE
(
_WIN_NM_IOCTL_TYPE
, ((_n) + 0x800) , \

558 
METHOD_OUT_DIRECT
, 
FILE_ANY_ACCESS
 )

	)

560 
	#_IOWR
(
_c
, 
_n
, 
_s
è
	`_IO
(_c, _n)

	)

563 
	#NETMAP_MMAP
 
	`_IO_dœeù
('i', 160)

564 
	#NETMAP_POLL
 
	`_IO
('i', 162)

	)

567 
	#NETMAP_SETSOCKOPT
 
	`_IO
('i', 140)

	)

568 
	#NETMAP_GETSOCKOPT
 
	`_IO
('i', 141)

	)

572 
	#NETMAP_NT_DEVICE_NAME
 
L
"\\Deviû\\NETMAP"

	)

573 
	#NETMAP_DOS_DEVICE_NAME
 
L
"\\DosDeviûs\\Ãtm­"

	)

576 
	s_MEMORY_ENTRY
 {

577 
PVOID
 
	mpU£rmodeVœtu®Add»ss
;

578 } 
	tMEMORY_ENTRY
, *
	tPMEMORY_ENTRY
;

580 
	s_POLL_REQUEST_DATA
 {

581 
	mev’ts
;

582 
	mtimeout
;

583 
	m»v’ts
;

584 } 
	tPOLL_REQUEST_DATA
;

594 
	#NIOCGINFO
 
	`_IOWR
('i', 145, 
nm»q
è

	)

595 
	#NIOCREGIF
 
	`_IOWR
('i', 146, 
nm»q
è

	)

596 
	#NIOCTXSYNC
 
	`_IO
('i', 148è

	)

597 
	#NIOCRXSYNC
 
	`_IO
('i', 149è

	)

598 
	#NIOCCONFIG
 
	`_IOWR
('i',150, 
nm_iäeq
è

	)

609 
šlše
 

610 
	$nm_ršg_em±y
(
Ãtm­_ršg
 *
ršg
)

612  (
ršg
->
cur
 =ğršg->

);

613 
	}
}

620 
	#NM_IFRDATA_LEN
 256

	)

621 
	snm_iäeq
 {

622 
	mniä_Çme
[
IFNAMSIZ
];

623 
	md©a
[
NM_IFRDATA_LEN
];

630 
	s±n_vmm_ioùl_msix
 {

631 
ušt64_t
 
	mmsg
;

632 
ušt64_t
 
	maddr
;

636 
	snm_kth_ioùl
 {

637 
u_lÚg
 
	mcom
;

640 
±n_vmm_ioùl_msix
 
	mmsix
;

641 } 
	md©a
;

645 
	s±Ãt_ršg_cfg
 {

646 
ušt64_t
 
	miÛv’tfd
;

647 
ušt64_t
 
	mœqfd
;

648 
nm_kth_ioùl
 
	mioùl
;

	@include/netmap_api.h

1 #iâdeà
__NETMAP_API_H_


2 
	#__NETMAP_API_H_


	)

4 
	~<¡dio.h
>

5 
	#NETMAP_WITH_LIBS


	)

6 
	~<Ãt/Ãtm­_u£r.h
>

7 
	~<©omic
>

8 
	~<ùy³.h
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~<m­
>

11 
	~<mu‹x
>

12 
	~<±h»ad.h
>

13 
	~<¡ršg
>

14 
	~<th»ad
>

15 
	~<queue
>

16 
	~<li¡
>

17 
	~<¡dboŞ.h
>

18 
	~<š‰y³s.h
>

19 
	~<sy¦og.h
>

21 
	~<¥¬£hash/d’£_hash_m­
>

22 
	~<¥¬£hash/d’£_hash_£t
>

23 
	~<cÚcu¼’tqueue.h
>

24 
	~<unÜd”ed_m­
>

26 
usšg
 
Çme¥aû
 
	g¡d
;

27 
usšg
 
	ggoogË
::
d’£_hash_m­
;

28 
usšg
 
	ggoogË
::
d’£_hash_£t
;

31 
	~<uni¡d.h
>

32 
	~<içddrs.h
>

33 
	~<sys/ioùl.h
>

34 
	~<sys/pŞl.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/ty³s.h
>

37 
	~<¬·/š‘.h
>

38 
	~<Ãt/‘h”Ãt.h
>

39 
	~<Ãt/if.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<time.h
>

42 
	~<sys/time.h
>

43 
	~<lšux/udp.h
>

44 
	~<lšux/tı.h
>

45 
	~<Ãtš‘/.h
>

46 
	~<Ãtš‘/‘h”.h
>

47 
	~<libcuckoo/cuckoohash_m­.hh
>

49 #ifdeà
lšux


50 
	#ıu£t_t
 
ıu_£t_t


	)

53 
usšg
 
Çme¥aû
 
	g¡d
;

55 
	#MAX_BODYSIZE
 2048

	)

56 
	#MAX_IFNAMELEN
 32

	)

57 
	#SEND_PIPES_IFNAME
 "v®e0:1"

	)

58 
	#RECV_PIPES_IFNAME
 "v®e1:1"

	)

61 
	#MAX_BATCH_SEND
 4

	)

62 
	#MAX_BATCH_RECV
 128

	)

63 
	#DATA_LEN
 1448

	)

64 
	#NO_OF_SAFE_ITR
 20000

	)

66 
	#IFNAME
 "Ãtm­:‘h4"

	)

67 
	#N_MINUS_1_CONFIG
 0

	)

68 
	#N_MINUS_2_CONFIG
 1

	)

74 #iâdeà
ETH_ALEN


75 
	#ETH_ALEN
 6

	)

78 
	#BUF_REVOKE
 100

	)

79 #iâdeà
__PKT_HASH__


80 
	#__PKT_HASH__


	)

89 
	~<¡dšt.h
>

91 #ifdeà
__GNUC__


92 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

93 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

95 
	#lik–y
(
x
è(x)

	)

96 
	#uÆik–y
(
x
è(x)

	)

99 
	#HTONS
(
n
) ((((()(n) & 0xFF)) << 8) | \

100 ((()(
n
è& 0xFF00è>> 8))

	)

101 
	#NTOHS
(
n
) ((((()(n) & 0xFF)) << 8) | \

102 ((()(
n
è& 0xFF00è>> 8))

	)

104 
	#HTONL
(
n
) ((((()(n) & 0xFF)) << 24) | \

105 (((()(
n
) & 0xFF00)) << 8) | \

106 (((()(
n
) & 0xFF0000)) >> 8) | \

107 (((()(
n
è& 0xFF000000)è>> 24))

	)

109 
	#NTOHL
(
n
) ((((()(n) & 0xFF)) << 24) | \

110 (((()(
n
) & 0xFF00)) << 8) | \

111 (((()(
n
) & 0xFF0000)) >> 8) | \

112 (((()(
n
è& 0xFF000000)è>> 24))

	)

116 
_¬p_hdr
 
	t¬p_hdr
;

117 
	s_¬p_hdr
 {

118 
ušt16_t
 
	mhty³
;

119 
ušt16_t
 
	m±y³
;

120 
ušt8_t
 
	mhËn
;

121 
ušt8_t
 
	m¶’
;

122 
ušt16_t
 
	mİcode
;

123 
ušt8_t
 
	m£nd”_mac
[6];

124 
ušt32_t
 
	m£nd”_
;

125 
ušt8_t
 
	mrg‘_mac
[6];

126 
ušt32_t
 
	mrg‘_
;

127 } 
__©Œibu‹__
((
__·cked__
));

129 
	svÏnhdr
 {

130 
ušt16_t
 
	m´i_cfi_vÏn
;

131 
ušt16_t
 
	m´Ùo
;

132 } 
	tvÏnhdr
;

138 
ušt32_t


139 
pkt_hdr_hash
(cÚ¡ *
bufãr
,

140 
ušt8_t
 
hash_¥l™
,

141 
ušt8_t
 
£ed
);

146 
	spkthdr
 {

147 
‘h”_h—d”
 
	meh
;

148 

 
	m
;

149 } 
__©Œibu‹__
((
__·cked__
));

152 
	s¬p_pkt
 {

153 
‘h”_h—d”
 
	meh
;

154 
¬p_hdr
 
	mah
;

155 } 
__©Œibu‹__
((
__·cked__
));

158 
	sudp_pkt
 {

159 
pkthdr
 
	mpkthdr
;

160 
udphdr
 
	mudp
;

161 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
udphdr
)];

162 } 
__©Œibu‹__
((
__·cked__
));

165 
	stı_pkt
 {

166 
pkthdr
 
	mpkthdr
;

167 
tıhdr
 
	mtı
;

168 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
tıhdr
)];

169 } 
__©Œibu‹__
((
__·cked__
));

172 
	scom·ù_‘h_hdr
 {

173 
	mh_de¡
[
ETH_ALEN
];

174 
	mh_sourû
[
ETH_ALEN
];

175 
u_št16_t
 
	mh_´Ùo
;

181 
	sov”æow_queue
 {

182 
	mÇme
[
MAX_IFNAMELEN
];

183 
	mqueue
<
	mÃtm­_¦Ù
> 
	m¦Ùs
;

187 
	spÜt_des
 {

188 
nm_desc
 *
	mnmd
;

189 
Ãtm­_ršg
 *
	mršg
;

190 
ov”æow_queue
 *
	moq
;

194 
	scompu‹_¡©s
 {

195 
ušt64_t
 
	mdrİ³d
;

196 
ušt64_t
 
	mfÜw¬ded
;

200 
	s_mac_·œ
 {

201 
ušt32_t
 
	m
;

202 
‘h”_addr
 
	mmac
;

205 
ušt16_t
 
checksum
(cÚ¡ *
d©a
, ušt16_ˆ
Ën
, 
ušt32_t
 
sum
);

206 
u_št16_t
 
w¿psum
(
u_št32_t
 
sum
);

208 #ifdef 
OPT_FOR_SINGLE_CORE


210 şas 
	cN‘m­U£
 {

211 
	m´iv©e
:

212 
¤c_‘h_addr
[20];

213 
š_addr
 
	m¤c_
;

215 
	mcuckoohash_m­
 < 
	mušt32_t
, 
	m‘h”_addr
 > 
	m¬±abË
;

217 
	mveùÜ
 < 
	md’£_hash_£t
 < 
	mušt32_t
 >* > 
	m³ndšg_¬p_»q
;

218 
	mveùÜ
 < 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ>* > 
	m³ndšg_¬p_»q_»Œ›s
;

219 
	mveùÜ
 < 
	mli¡
 < 
	mtı_pkt
 >* > 
	mdeã¼ed_·ck‘s
;

221 
ušt32_t
 
	mcÜes_avaabË
;

223 
timev®
 
	mbegš_time_£nd
;

224 
timev®
 
	mbegš_time_»cv
;

225 
timev®
 
	m’d_time
;

227 
ušt16_t
 
	m£nd_ouut_ršgs
;

229 
ušt16_t
 
	m»cv_ouut_ršgs
;

231 
ušt64_t
 
	m£nd_™”
;

232 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

233 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

234 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

236 
ušt64_t
 
	m»cv_™”
;

237 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

238 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

239 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

241 
u_št
 
	mvœt_hdr_Ën
;

242 
	mpublic
:

243 
u_št
 
do_abÜt
;

245 
N‘m­U£
();

246 ~
N‘m­U£
();

248 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

249 
sourû_hwaddr
(cÚ¡ *
iâame
);

250 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

252 
š™Ÿlize_£nd_»cv
();

253 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

255 
´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
);

257 * 
g‘_bufãr_tx
(
cÜeid
);

258 
syncbuáx
(
cÜeid
);

260 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

261 
syncbuäx
(
cÜeid
);

266 şas 
	cN‘m­U£
 {

267 
	m´iv©e
:

268 
¤c__addr
[20];

269 
	m¤c_‘h_addr
[20];

270 
š_addr
 
	m¤c_
;

272 
	md’£_hash_m­
 < 
	mušt32_t
, 
	m‘h”_addr
 > 
	m¬±abË
;

274 
	md’£_hash_£t
 < 
	mušt32_t
 > 
	m³ndšg_¬p_»q_th
;

275 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ> 
	m³ndšg_¬p_»q_»Œ›s_th
;

276 
	mli¡
 < 
	mtı_pkt
 > 
	mdeã¼ed_·ck‘s_th
;

278 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
_mac_·œ
> 
Ãw_¬p_’Œ›s_th
;

279 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
ušt32_t
> 
’queued_¬p_»q_th
;

281 
ušt32_t
 
	mcÜes_avaabË
;

283 
timev®
 
	mbegš_time_£nd
;

284 
timev®
 
	mbegš_time_»cv
;

285 
timev®
 
	m’d_time
;

287 
ušt16_t
 
	m£nd_ouut_ršgs
;

289 
ušt16_t
 
	m»cv_ouut_ršgs
;

291 
ušt32_t
 
	m»cv_exŒa_bufs
;

293 
nm_desc
 *
	m£nd_ma¡”_nmd
;

294 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

295 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

296 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

298 
nm_desc
 *
	m»cv_ma¡”_nmd
;

299 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

300 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

301 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

303 
u_št
 
	mvœt_hdr_Ën
;

305 
th»ad
 
	m£nd_th»ad
;

306 
th»ad
 
	m»cv_th»ad
;

308 
	mpublic
:

309 
u_št
 
do_abÜt
;

311 
N‘m­U£
();

312 ~
N‘m­U£
();

314 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

315 
sourû_hwaddr
(cÚ¡ *
iâame
);

316 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

318 
š™Ÿlize_£nd_»cv
();

319 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

321 
´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
);

323 * 
g‘_bufãr_tx
(
cÜeid
);

324 
syncbuáx
(
cÜeid
);

326 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

327 
syncbuäx
(
cÜeid
);

329 *
£nd_pkts_to_içû
();

330 *
»ûive_pkts_äom_içû
();

333 
N‘m­U£
 
Ãtm­u£
;

	@include/netmap_api_arp_tested.h

1 #iâdeà
__NETMAP_API_H_


2 
	#__NETMAP_API_H_


	)

4 
	~<¡dio.h
>

5 
	#NETMAP_WITH_LIBS


	)

6 
	~<Ãt/Ãtm­_u£r.h
>

7 
	~<©omic
>

8 
	~<ùy³.h
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~<m­
>

11 
	~<mu‹x
>

12 
	~<±h»ad.h
>

13 
	~<¡ršg
>

14 
	~<th»ad
>

15 
	~<queue
>

16 
	~<li¡
>

17 
	~<¡dboŞ.h
>

18 
	~<š‰y³s.h
>

19 
	~<sy¦og.h
>

21 
	~<¥¬£hash/d’£_hash_m­
>

22 
	~<¥¬£hash/d’£_hash_£t
>

23 
	~<cÚcu¼’tqueue.h
>

24 
	~<unÜd”ed_m­
>

26 
usšg
 
Çme¥aû
 
	g¡d
;

27 
usšg
 
	ggoogË
::
d’£_hash_m­
;

28 
usšg
 
	ggoogË
::
d’£_hash_£t
;

31 
	~<uni¡d.h
>

32 
	~<içddrs.h
>

33 
	~<sys/ioùl.h
>

34 
	~<sys/pŞl.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/ty³s.h
>

37 
	~<¬·/š‘.h
>

38 
	~<Ãt/‘h”Ãt.h
>

39 
	~<Ãt/if.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<time.h
>

42 
	~<sys/time.h
>

44 
	~<lšux/udp.h
>

45 
	~<lšux/tı.h
>

46 
	~<Ãtš‘/.h
>

47 
	~<Ãtš‘/‘h”.h
>

49 #ifdeà
lšux


50 
	#ıu£t_t
 
ıu_£t_t


	)

54 
	~"ùrs.h
"

55 
usšg
 
Çme¥aû
 
	g¡d
;

57 
	#SKIP_PAYLOAD
 1

	)

58 
	#MAX_QUEUE_SIZE
 10000

	)

59 
	#MAX_BODYSIZE
 2048

	)

60 
	#MAX_IFNAMELEN
 64

	)

61 
	#MAX_BURST
 1000

	)

62 
	#RECV_THREAD_COUNT
 1

	)

63 
	#MAX_BATCH_SEND
 5

	)

64 
	#MAX_BATCH_CORE_SEND
 5

	)

65 
	#MAX_BATCH_RECV
 160

	)

66 
	#MAX_BATCH_CORE_RECV
 160

	)

67 
	#DATA_LEN
 1448

	)

68 
	#MAX_BUF_COUNT
 500000

	)

69 
	#NO_OF_SAFE_ITR
 20000

	)

71 
	#OPT_FOR_SINGLE_CORE


	)

74 
	#ARP_ENABLED
 0

	)

75 
	#DEST_MAC
 "00:¯:bb:cc:dd:07"

	)

77 
	#APP_BASED_HASH


	)

79 
	#N_MINUS_1_CONFIG
 0

	)

80 
	#N_MINUS_2_CONFIG
 0

	)

81 
	#STAT_ON_SEND_CORE
 0

	)

82 
	#STAT_ON_RECV_CORE
 0

	)

88 #iâdeà
ETH_ALEN


89 
	#ETH_ALEN
 6

	)

91 
	#MAX_BODYSIZE
 2048

	)

93 
	#MAX_IFNAMELEN
 64

	)

94 
	#DEF_OUT_PIPES
 2

	)

95 
	#DEF_EXTRA_BUFS
 0

	)

96 
	#DEF_BATCH
 2048

	)

97 
	#DEF_SYSLOG_INT
 600

	)

98 
	#BUF_REVOKE
 100

	)

99 #iâdeà
__PKT_HASH__


100 
	#__PKT_HASH__


	)

109 
	~<¡dšt.h
>

111 #ifdeà
__GNUC__


112 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

113 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

115 
	#lik–y
(
x
è(x)

	)

116 
	#uÆik–y
(
x
è(x)

	)

119 
	#HTONS
(
n
) ((((()(n) & 0xFF)) << 8) | \

120 ((()(
n
è& 0xFF00è>> 8))

	)

121 
	#NTOHS
(
n
) ((((()(n) & 0xFF)) << 8) | \

122 ((()(
n
è& 0xFF00è>> 8))

	)

124 
	#HTONL
(
n
) ((((()(n) & 0xFF)) << 24) | \

125 (((()(
n
) & 0xFF00)) << 8) | \

126 (((()(
n
) & 0xFF0000)) >> 8) | \

127 (((()(
n
è& 0xFF000000)è>> 24))

	)

129 
	#NTOHL
(
n
) ((((()(n) & 0xFF)) << 24) | \

130 (((()(
n
) & 0xFF00)) << 8) | \

131 (((()(
n
) & 0xFF0000)) >> 8) | \

132 (((()(
n
è& 0xFF000000)è>> 24))

	)

136 
_¬p_hdr
 
	t¬p_hdr
;

137 
	s_¬p_hdr
 {

138 
ušt16_t
 
	mhty³
;

139 
ušt16_t
 
	m±y³
;

140 
ušt8_t
 
	mhËn
;

141 
ušt8_t
 
	m¶’
;

142 
ušt16_t
 
	mİcode
;

143 
ušt8_t
 
	m£nd”_mac
[6];

144 
ušt32_t
 
	m£nd”_
;

145 
ušt8_t
 
	mrg‘_mac
[6];

146 
ušt32_t
 
	mrg‘_
;

147 } 
__©Œibu‹__
((
__·cked__
));

149 
	svÏnhdr
 {

150 
ušt16_t
 
	m´i_cfi_vÏn
;

151 
ušt16_t
 
	m´Ùo
;

152 } 
	tvÏnhdr
;

158 
ušt32_t


159 
pkt_hdr_hash
(cÚ¡ *
bufãr
,

160 
ušt8_t
 
hash_¥l™
,

161 
ušt8_t
 
£ed
);

164 
	spkthdr
 {

165 
‘h”_h—d”
 
	meh
;

166 

 
	m
;

167 } 
__©Œibu‹__
((
__·cked__
));

169 
	s¬p_pkt
 {

170 
‘h”_h—d”
 
	meh
;

171 
¬p_hdr
 
	mah
;

172 } 
__©Œibu‹__
((
__·cked__
));

175 
	sudp_pkt
 {

176 
pkthdr
 
	mpkthdr
;

177 
udphdr
 
	mudp
;

178 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
udphdr
)];

179 } 
__©Œibu‹__
((
__·cked__
));

181 
	stı_pkt
 {

182 
pkthdr
 
	mpkthdr
;

183 
tıhdr
 
	mtı
;

184 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
tıhdr
)];

185 } 
__©Œibu‹__
((
__·cked__
));

187 
	scom·ù_‘h_hdr
 {

188 
	mh_de¡
[
ETH_ALEN
];

189 
	mh_sourû
[
ETH_ALEN
];

190 
u_št16_t
 
	mh_´Ùo
;

193 
	sd©a_¡ruù
 {

194 
ušt32_t
 
	mimsi
;

195 
	md©a
[
DATA_LEN
];

198 
	scom·ù__hdr
 {

199 
u_št8_t
 
	mihl
:4, 
	mv”siÚ
:4;

200 
u_št8_t
 
	mtos
;

201 
u_št16_t
 
	mtÙ_Ën
;

202 
u_št16_t
 
	mid
;

203 
u_št16_t
 
	mäag_off
;

204 
u_št8_t
 
	m‰l
;

205 
u_št8_t
 
	m´ÙocŞ
;

206 
u_št16_t
 
	mcheck
;

207 
u_št32_t
 
	m§ddr
;

208 
u_št32_t
 
	mdaddr
;

211 
	scom·ù_v6_hdr
 {

212 
u_št8_t
 
	m´iÜ™y
:4, 
	mv”siÚ
:4;

213 
u_št8_t
 
	mæow_lbl
[3];

214 
u_št16_t
 
	m·ylßd_Ën
;

215 
u_št8_t
 
	mÃxthdr
;

216 
u_št8_t
 
	mhİ_lim™
;

217 
š6_addr
 
	m§ddr
;

218 
š6_addr
 
	mdaddr
;

224 
	sov”æow_queue
 {

225 
	mÇme
[
MAX_IFNAMELEN
];

226 
	mqueue
<
	mÃtm­_¦Ù
> 
	m¦Ùs
;

229 #ifdef 
PRINT_STATS


230 
	spÜt_des
 {

231 
my_ùrs
 
	mùr
;

232 
nm_desc
 *
	mnmd
;

233 
Ãtm­_ršg
 *
	mršg
;

234 
ov”æow_queue
 *
	moq
;

237 
	spÜt_des
 {

238 
nm_desc
 *
	mnmd
;

239 
Ãtm­_ršg
 *
	mršg
;

240 
ov”æow_queue
 *
	moq
;

244 
	sCom·»
 {

245 
boŞ
 
İ”©Ü
(è(cÚ¡ 
	mš_addr
 &
	ma
, cÚ¡ š_add¸&
	mb
) const {

246  
	ma
.
	ms_addr
 < 
	mb
.s_addr;

250 
	scompu‹_¡©s
 {

251 
ušt64_t
 
	mdrİ³d
;

252 
ušt64_t
 
	mfÜw¬ded
;

254 
ušt16_t
 
checksum
(cÚ¡ *
d©a
, ušt16_ˆ
Ën
, 
ušt32_t
 
sum
);

255 
u_št16_t
 
w¿psum
(
u_št32_t
 
sum
);

257 
	s_mac_·œ
 {

258 
ušt32_t
 
	m
;

259 
‘h”_addr
 
	mmac
;

264 
dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
);

266 şas 
	cN‘m­U£
 {

267 
	m´iv©e
:

268 
¤c__addr
[20];

269 
	m¤c_‘h_addr
[20];

270 
š_addr
 
	m¤c_
;

271 
	md’£_hash_m­
 < 
	mušt32_t
, 
	m‘h”_addr
 > 
	m¬±abË
;

274 
	mveùÜ
 < 
	md’£_hash_£t
 < 
	mušt32_t
 >* > 
	m³ndšg_¬p_»q
;

275 
	mveùÜ
 < 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ>* > 
	m³ndšg_¬p_»q_»Œ›s
;

276 
	mveùÜ
 < 
	mli¡
 < 
	mtı_pkt
 >* > 
	mdeã¼ed_·ck‘s
;

286 
	md’£_hash_£t
 < 
	mušt32_t
 > 
	m³ndšg_¬p_»q_th
;

287 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ> 
	m³ndšg_¬p_»q_»Œ›s_th
;

288 
	mli¡
 < 
	mtı_pkt
 > 
	mdeã¼ed_·ck‘s_th
;

290 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
_mac_·œ
> 
Ãw_¬p_’Œ›s_th
;

291 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
ušt32_t
> 
’queued_¬p_»q_th
;

294 
	msy¦og_š‹rv®
;

295 
ušt32_t
 
	mcÜes_avaabË
;

297 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

298 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

300 
time_t
 
	m¡¬t_time_£nd
;

301 
time_t
 
	m¡¬t_time_»cv
;

303 
	m¿‹_time
;

304 
	mdiff_time
;

306 
timev®
 
	mbegš_time_£nd
;

307 
timev®
 
	mbegš_time_»cv
;

308 
timev®
 
	m’d_time
;

310 #ifdef 
OPT_FOR_SINGLE_CORE


312 
ušt64_t
 
	m£nd_™”
;

313 
ušt64_t
 
	m»cv_™”
;

315 
nm_desc
 *
	mmq_nmd
;

318 
	miâame
[
MAX_IFNAMELEN
];

320 
	m£nd_iâame
[
MAX_IFNAMELEN
];

321 
	m£nd_pes_iâame
[
MAX_IFNAMELEN
];

322 
ušt16_t
 
	m£nd_ouut_ršgs
;

323 
ušt32_t
 
	m£nd_exŒa_bufs
;

324 
ušt16_t
 
	m£nd_b©ch
;

325 
	mveùÜ
<
	mušt16_t
> 
	m£nd_b©ch_cÜe
;

327 
	m»cv_iâame
[
MAX_IFNAMELEN
];

328 
	m»cv_pes_iâame
[
MAX_IFNAMELEN
];

329 
ušt16_t
 
	m»cv_ouut_ršgs
;

330 
ušt32_t
 
	m»cv_exŒa_bufs
;

331 
ušt16_t
 
	m»cv_b©ch
;

332 
	mveùÜ
<
	mušt16_t
> 
	m»cv_b©ch_cÜe
;

334 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

335 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

337 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

338 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

340 
th»ad
 
	m¡©_th»ad
;

341 
u_št
 
	mvœt_hdr_Ën
;

342 
boŞ
 
	m§ã_to_¡¬t_£nd
;

343 
boŞ
 
	m§ã_to_¡¬t_»cv
;

345 
nm_desc
 *
	m£nd_ma¡”_nmd
;

346 
nm_desc
 *
	m»cv_ma¡”_nmd
;

349 
th»ad
 
	m£nd_th»ad
;

350 
th»ad
 
	m»cv_th»ad
;

352 
	mpublic
:

354 
ušt32_t
 
šc_bur¡
;

355 
u_št
 
	mdo_abÜt
;

356 
Ãtm­_ršg
 *
	mtxršg
;

358 
š™_Ãtm­
();

359 
İ’_Ãtm­_dev
(*
iâame
);

361 * 
g‘_bufãr_tx
(
cÜeid
);

362 
syncbuáx
(
cÜeid
);

364 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

365 
syncbuäx
(
cÜeid
);

367 
sourû_hwaddr
(*
iâame
);

368 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

372 
ušt32_t
 
fšd_¡©_th»ad_cÜe
();

374 
š™Ÿlize_£nd_»cv
();

375 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

376 
´št_¡©s
(
pÜt_des
 *
pÜts
);

377 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

379 #iâdef 
OPT_FOR_SINGLE_CORE


380 *
£nd_pkts_to_içû
();

381 *
»ûive_pkts_äom_içû
();

384 
´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
);

386 
N‘m­U£
();

387 ~
N‘m­U£
();

390 
N‘m­U£
 
Ãtm­u£
;

	@include/netmap_api_cache_friendly.h

1 #iâdeà
__NETMAP_API_H_


2 
	#__NETMAP_API_H_


	)

4 
	~<¡dio.h
>

5 
	#NETMAP_WITH_LIBS


	)

6 
	~<Ãt/Ãtm­_u£r.h
>

7 
	~<©omic
>

8 
	~<ùy³.h
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~<m­
>

11 
	~<mu‹x
>

12 
	~<±h»ad.h
>

13 
	~<¡ršg
>

14 
	~<th»ad
>

15 
	~<queue
>

16 
	~<¡dboŞ.h
>

17 
	~<š‰y³s.h
>

18 
	~<sy¦og.h
>

19 
usšg
 
Çme¥aû
 
	g¡d
;

22 
	~<uni¡d.h
>

23 
	~<içddrs.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/pŞl.h
>

26 
	~<sys/sock‘.h
>

27 
	~<sys/ty³s.h
>

28 
	~<¬·/š‘.h
>

29 
	~<Ãt/‘h”Ãt.h
>

30 
	~<Ãt/if.h
>

31 
	~<Ãtš‘/š.h
>

32 
	~<time.h
>

33 
	~<sys/time.h
>

35 
	~<lšux/udp.h
>

36 
	~<lšux/tı.h
>

37 
	~<Ãtš‘/.h
>

38 
	~<Ãtš‘/‘h”.h
>

40 #ifdeà
lšux


41 
	#ıu£t_t
 
ıu_£t_t


	)

45 
	~"ùrs.h
"

46 
usšg
 
Çme¥aû
 
	g¡d
;

48 
	#SKIP_PAYLOAD
 1

	)

49 
	#MAX_QUEUE_SIZE
 10000

	)

50 
	#MAX_BODYSIZE
 2048

	)

51 
	#MAX_IFNAMELEN
 64

	)

52 
	#MAX_BURST
 1000

	)

53 
	#RECV_THREAD_COUNT
 1

	)

54 
	#MAX_BATCH_SEND
 4

	)

55 
	#MAX_BATCH_CORE_SEND
 4

	)

56 
	#MAX_BATCH_RECV
 128

	)

57 
	#MAX_BATCH_CORE_RECV
 128

	)

58 
	#DATA_LEN
 64

	)

59 
	#MAX_BUF_COUNT
 500000

	)

60 
	#NO_OF_SAFE_ITR
 20000

	)

62 
	#OPT_FOR_SINGLE_CORE


	)

65 
	#ARP_ENABLED
 0

	)

66 
	#DEST_MAC
 "a0:36:9f:3e:eb:70"

	)

68 
	#APP_BASED_HASH


	)

70 
	#N_MINUS_1_CONFIG
 0

	)

71 
	#N_MINUS_2_CONFIG
 0

	)

72 
	#STAT_ON_SEND_CORE
 0

	)

73 
	#STAT_ON_RECV_CORE
 0

	)

79 #iâdeà
ETH_ALEN


80 
	#ETH_ALEN
 6

	)

82 
	#MAX_BODYSIZE
 2048

	)

84 
	#MAX_IFNAMELEN
 64

	)

85 
	#DEF_OUT_PIPES
 2

	)

86 
	#DEF_EXTRA_BUFS
 0

	)

87 
	#DEF_BATCH
 2048

	)

88 
	#DEF_SYSLOG_INT
 600

	)

89 
	#BUF_REVOKE
 100

	)

90 #iâdeà
__PKT_HASH__


91 
	#__PKT_HASH__


	)

100 
	~<¡dšt.h
>

102 #ifdeà
__GNUC__


103 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

104 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

106 
	#lik–y
(
x
è(x)

	)

107 
	#uÆik–y
(
x
è(x)

	)

110 
	#HTONS
(
n
) ((((()(n) & 0xFF)) << 8) | \

111 ((()(
n
è& 0xFF00è>> 8))

	)

112 
	#NTOHS
(
n
) ((((()(n) & 0xFF)) << 8) | \

113 ((()(
n
è& 0xFF00è>> 8))

	)

115 
	#HTONL
(
n
) ((((()(n) & 0xFF)) << 24) | \

116 (((()(
n
) & 0xFF00)) << 8) | \

117 (((()(
n
) & 0xFF0000)) >> 8) | \

118 (((()(
n
è& 0xFF000000)è>> 24))

	)

120 
	#NTOHL
(
n
) ((((()(n) & 0xFF)) << 24) | \

121 (((()(
n
) & 0xFF00)) << 8) | \

122 (((()(
n
) & 0xFF0000)) >> 8) | \

123 (((()(
n
è& 0xFF000000)è>> 24))

	)

125 
	svÏnhdr
 {

126 
ušt16_t
 
	m´i_cfi_vÏn
;

127 
ušt16_t
 
	m´Ùo
;

128 } 
	tvÏnhdr
;

134 
ušt32_t


135 
pkt_hdr_hash
(cÚ¡ *
bufãr
,

136 
ušt8_t
 
hash_¥l™
,

137 
ušt8_t
 
£ed
);

140 
	spkthdr
 {

141 
‘h”_h—d”
 
	meh
;

142 

 
	m
;

143 } 
__©Œibu‹__
((
__·cked__
));

145 
	sudp_pkt
 {

146 
pkthdr
 
	mpkthdr
;

147 
udphdr
 
	mudp
;

148 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
udphdr
)];

149 } 
__©Œibu‹__
((
__·cked__
));

151 
	stı_pkt
 {

152 
pkthdr
 
	mpkthdr
;

153 
tıhdr
 
	mtı
;

154 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
tıhdr
)];

155 } 
__©Œibu‹__
((
__·cked__
));

157 
	scom·ù_‘h_hdr
 {

158 
	mh_de¡
[
ETH_ALEN
];

159 
	mh_sourû
[
ETH_ALEN
];

160 
u_št16_t
 
	mh_´Ùo
;

163 
	sd©a_¡ruù
 {

164 
ušt32_t
 
	mimsi
;

165 
	md©a
[
DATA_LEN
];

168 
	scom·ù__hdr
 {

169 
u_št8_t
 
	mihl
:4, 
	mv”siÚ
:4;

170 
u_št8_t
 
	mtos
;

171 
u_št16_t
 
	mtÙ_Ën
;

172 
u_št16_t
 
	mid
;

173 
u_št16_t
 
	mäag_off
;

174 
u_št8_t
 
	m‰l
;

175 
u_št8_t
 
	m´ÙocŞ
;

176 
u_št16_t
 
	mcheck
;

177 
u_št32_t
 
	m§ddr
;

178 
u_št32_t
 
	mdaddr
;

181 
	scom·ù_v6_hdr
 {

182 
u_št8_t
 
	m´iÜ™y
:4, 
	mv”siÚ
:4;

183 
u_št8_t
 
	mæow_lbl
[3];

184 
u_št16_t
 
	m·ylßd_Ën
;

185 
u_št8_t
 
	mÃxthdr
;

186 
u_št8_t
 
	mhİ_lim™
;

187 
š6_addr
 
	m§ddr
;

188 
š6_addr
 
	mdaddr
;

194 
	sov”æow_queue
 {

195 
	mÇme
[
MAX_IFNAMELEN
];

196 
	mqueue
<
	mÃtm­_¦Ù
> 
	m¦Ùs
;

199 #ifdef 
PRINT_STATS


200 
	spÜt_des
 {

201 
my_ùrs
 
	mùr
;

202 
nm_desc
 *
	mnmd
;

203 
Ãtm­_ršg
 *
	mršg
;

204 
ov”æow_queue
 *
	moq
;

207 
	spÜt_des
 {

208 
nm_desc
 *
	mnmd
;

209 
Ãtm­_ršg
 *
	mršg
;

210 
ov”æow_queue
 *
	moq
;

214 
	sCom·»
 {

215 
boŞ
 
İ”©Ü
(è(cÚ¡ 
	mš_addr
 &
	ma
, cÚ¡ š_add¸&
	mb
) const {

216  
	ma
.
	ms_addr
 < 
	mb
.s_addr;

220 
	scompu‹_¡©s
 {

221 
ušt64_t
 
	mdrİ³d
;

222 
ušt64_t
 
	mfÜw¬ded
;

224 
ušt16_t
 
checksum
(cÚ¡ *
d©a
, ušt16_ˆ
Ën
, 
ušt32_t
 
sum
);

225 
u_št16_t
 
w¿psum
(
u_št32_t
 
sum
);

229 
dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
);

231 şas 
	cN‘m­U£
 {

232 
	m´iv©e
:

233 
¤c__addr
[20];

234 
	m¤c_‘h_addr
[20];

235 
š_addr
 
	m¤c_
;

236 
	mm­
 < 
	mš_addr
, 
	m‘h”_addr
, 
	mCom·»
 > 
	m¬±abË
;

238 
	msy¦og_š‹rv®
;

239 
ušt32_t
 
	mcÜes_avaabË
;

241 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

242 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

244 
time_t
 
	m¡¬t_time_£nd
;

245 
time_t
 
	m¡¬t_time_»cv
;

247 
	m¿‹_time
;

248 
	mdiff_time
;

250 
timev®
 
	mbegš_time_£nd
;

251 
timev®
 
	mbegš_time_»cv
;

252 
timev®
 
	m’d_time
;

254 #ifdef 
OPT_FOR_SINGLE_CORE


256 
ušt64_t
 
	m£nd_™”
;

257 
ušt64_t
 
	m»cv_™”
;

259 
nm_desc
 *
	mmq_nmd
;

262 
	miâame
[
MAX_IFNAMELEN
];

264 
	m£nd_iâame
[
MAX_IFNAMELEN
];

265 
	m£nd_pes_iâame
[
MAX_IFNAMELEN
];

266 
ušt16_t
 
	m£nd_ouut_ršgs
;

267 
ušt32_t
 
	m£nd_exŒa_bufs
;

268 
ušt16_t
 
	m£nd_b©ch
;

269 
	mveùÜ
<
	mušt16_t
> 
	m£nd_b©ch_cÜe
;

271 
	m»cv_iâame
[
MAX_IFNAMELEN
];

272 
	m»cv_pes_iâame
[
MAX_IFNAMELEN
];

273 
ušt16_t
 
	m»cv_ouut_ršgs
;

274 
ušt32_t
 
	m»cv_exŒa_bufs
;

275 
ušt16_t
 
	m»cv_b©ch
;

276 
	mveùÜ
<
	mušt16_t
> 
	m»cv_b©ch_cÜe
;

278 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

279 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

281 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

282 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

284 
th»ad
 
	m¡©_th»ad
;

285 
u_št
 
	mvœt_hdr_Ën
;

286 
boŞ
 
	m§ã_to_¡¬t_£nd
;

287 
boŞ
 
	m§ã_to_¡¬t_»cv
;

289 
nm_desc
 *
	m£nd_ma¡”_nmd
;

290 
nm_desc
 *
	m»cv_ma¡”_nmd
;

293 
th»ad
 
	m£nd_th»ad
;

294 
th»ad
 
	m»cv_th»ad
;

296 
	mpublic
:

298 
ušt32_t
 
šc_bur¡
;

299 
u_št
 
	mdo_abÜt
;

300 
Ãtm­_ršg
 *
	mtxršg
;

302 
š™_Ãtm­
();

303 
İ’_Ãtm­_dev
(*
iâame
);

305 * 
g‘_bufãr_tx
(
cÜeid
);

306 
syncbuáx
(
cÜeid
);

308 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

309 
syncbuäx
(
cÜeid
);

311 
sourû_hwaddr
(*
iâame
);

312 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

316 
ušt32_t
 
fšd_¡©_th»ad_cÜe
();

318 
š™Ÿlize_£nd_»cv
();

319 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

320 
´št_¡©s
(
pÜt_des
 *
pÜts
);

321 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

322 *
£nd_pkts_to_içû
();

323 *
»ûive_pkts_äom_içû
();

325 
N‘m­U£
();

326 ~
N‘m­U£
();

329 
N‘m­U£
 
Ãtm­u£
;

	@include/netmap_api_cache_unfriendly.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

393 
ušt32_t
 
th»ad_cÜe
 = 0;

395 #if 
N_MINUS_2_CONFIG


396 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

397 if(
STAT_ON_SEND_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

399 } if(
STAT_ON_RECV_CORE
) {

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

402 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

404 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

405 
th»ad_cÜe
 = 1;

407 
th»ad_cÜe
 = 0;

409 #–if 
N_MINUS_1_CONFIG


410 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

411 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

414 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

417 
th»ad_cÜe
 = 0;

420 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

421 if(
STAT_ON_SEND_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

423 } if(
STAT_ON_RECV_CORE
) {

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

426 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

429 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

430 
th»ad_cÜe
 = 1;

432 
th»ad_cÜe
 = 0;

437  
th»ad_cÜe
;

439 
	}
}

441 
	gN‘m­U£
::
	$N‘m­U£
() {

442 *
‹mp
;

443 
u_št
 
i
;

444 
‹¡couÁ
=0;

446 
num_»cv
 = 1;

447 
wa™_lšk
 = 2;

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

457 
	`sourû_hwaddr
(
iâame
);

463 
	`š™Ÿlize_£nd_»cv
();

465 #ifdef 
OPT_FOR_SINGLE_CORE


468 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

469 
»cv_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

471 
ušt8_t
 
i
; i<
£nd_ouut_ršgs
; i++) {

472 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

473 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

476 
£nd_™”
 = 
»cv_™”
 = 0;

479 
§ã_to_¡¬t_»cv
 = 
Œue
;

480 
	}
}

486 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

488 
buf
[128];

489 
i
, 
j
, 
i0
;

490 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

498 
i
 = 0; i < 
Ën
; ) {

499 
	`mem£t
(
buf
, (buf), ' ');

500 
	`¥rštf
(
buf
, "%5d: ", 
i
);

501 
i0
 = 
i
;

502 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

503 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

504 
i
 = 
i0
;

505 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

506 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

507 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

508 
	`´štf
("%s\n", 
buf
);

510 
	}
}

512 
	gN‘m­U£
::~
	$N‘m­U£
() {

513 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

514 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

517 #iâdeà
OPT_FOR_SINGLE_CORE


518 
£nd_th»ad
.
	`još
();

519 
»cv_th»ad
.
	`još
();

524 
	`g‘timeofday
(&
’d_time
, 
NULL
);

526  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

527 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

528 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

531 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

532 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

533 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

534 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

537 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

538 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

539 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

540 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

545 
	`¦“p
(5);

546 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

552 
cout
<<"Com¶‘ed"<<
’dl
;

553 
	}
}

556 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

558 
nm»q
 
»q
;

559 
”r
;

561 
	`mem£t
(&
»q
, 0, (req));

562 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

563 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

564 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

565 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

566 ià(
”r
) {

567 
	`D
("Unableo get virtio-net header†ength");

571 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

572 ià(
vœt_hdr_Ën
) {

573 
	`D
("Port„equires virtio-net header,†ength = %d",

574 
vœt_hdr_Ën
);

576 
	}
}

579 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

581 
th»ad_cÜe
 = 0;

583 #iâdef 
OPT_FOR_SINGLE_CORE


585 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

593 
Åes
 = 
»cv_ouut_ršgs
;

594 
sys_št
 = 0;

595 
my_ùrs
 
cur
, 
´ev
;

596 
b1
[40], 
b2
[40];

597 
my_ùrs
 *
pe_´ev
;

599 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

600 ià(
pe_´ev
 =ğ
NULL
) {

601 
	`D
("out of memory");

602 
	`ex™
(1);

605 
	`mem£t
(&
´ev
, 0, (prev));

606 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

607 !
do_abÜt
) {

608 
j
, 
dosy¦og
 = 0;

609 
ušt64_t
 
µs
, 
dps
, 
u£c
;

610 
my_ùrs
 
x
;

612 
	`mem£t
(&
cur
, 0, (cur));

613 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

615 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

616 
dosy¦og
 = 1;

617 
sys_št
 = 0;

620 
j
 = 0; j < 
Åes
; ++j) {

621 
pÜt_des
 *
p
 = &
pÜts
[
j
];

623 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

624 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

626 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

627 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

628 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

629 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

630 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

631 
pe_´ev
[
j
] = 
p
->
ùr
;

633 ià(
dosy¦og
) {

634 
	`sy¦og
(
LOG_INFO
,

639 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

642 
	`´štf
("\n");

652 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

653 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

654 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

655 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

656 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

657 
´ev
 = 
cur
;

660 
	`ä“
(
pe_´ev
);

661 
	`D
("Done");

663 
	}
}

666 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

667 
i
, 
	gtÙ
 = 0;

668 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

671 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

672 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

673 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

675 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

678 !
	gq
->
	g¦Ùs
.
em±y
()) {

679 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

680 
	gq
->
	g¦Ùs
.
pİ
();

681 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

683 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

684 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

685 
	gtÙ
++;

688 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

692 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

693 
ušt16_t
 
i
,
j
;

695 
£nd_ma¡”_nmd
 = 
NULL
;

696 
»cv_ma¡”_nmd
 = 
NULL
;

698 
§ã_to_¡¬t_»cv
 = 
çl£
;

699 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

700 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

701 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

702 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

704 #if 
N_MINUS_2_CONFIG


705 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

706 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

708 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

711 #–if 
N_MINUS_1_CONFIG


712 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

713 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

715 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

718 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

722 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

723 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

724 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

727 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

728 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

729 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

730 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

731 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

738 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

739 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

740 
³r_cÜe_couÁs
[
i
] = 0;

742 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

743 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

744 
³r_cÜe_couÁr
[
i
] = 0;

747 #iâdeà
OPT_FOR_SINGLE_CORE


748 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

776 
ıu_£t_t
 
ıu_£t
;

778 
th»ad_cÜe1
, 
th»ad_cÜe2
;

780 #if 
N_MINUS_2_CONFIG


781 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

782 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

783 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

784 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

785 
th»ad_cÜe1
 = 1;

786 
th»ad_cÜe2
 = 1;

788 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

790 #–if 
N_MINUS_1_CONFIG


791 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

792 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

793 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

795 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

798 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

799 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

800 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

802 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

806 
	`CPU_ZERO
(&
ıu_£t
);

807 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

808 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

809 if(
rc
!=0) {

810 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

813 
j
 = 0; j < 
CPU_SETSIZE
; j++)

814 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

815 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

819 
	`¦“p
(2);

821 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

823 
	`CPU_ZERO
(&
ıu_£t
);

824 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

825 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

826 if(
rc
!=0) {

827 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

830 
j
 = 0; j < 
CPU_SETSIZE
; j++)

831 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

832 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

836 
	}
}

914 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

915 #iâdeà
OPT_FOR_SINGLE_CORE


916 !
£nd_ma¡”_nmd
) {

917 
this_th»ad
::
	`y›ld
();

920 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

921 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

922 
nm»q
 
ba£_»q
;

923 
š‹rçû
[25];

924 
	`mem£t
(&
ba£_»q
, 0, (base_req));

925 #ifdeà
OPT_FOR_SINGLE_CORE


926 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

927 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

929 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

930 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

932 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

933 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

934  
NULL
;

936 
	`D
("successfully opened core #%d %s (tx slots: %d)",

937 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

938 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

940 ià(
cÜeid
==0) {

941 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

942 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

945 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

946 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

947 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

949 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

950 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

951  
NULL
;

953 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

954 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

955 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

957 
	`D
("zerocopy %s",

958 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

964 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

968 
ušt16_t
 
n
;

969 
²
;

970 
pŞlfd
 
pfd
;

971 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

972 
pfd
.
ev’ts
 = 
POLLOUT
;

973 
pfd
.
»v’ts
 = 0;

974 #ifdeà
BUSY_WAIT


975 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

976 
	`D
("ioctlƒrror on queue %d: %s", 0,

977 
	`¡»¼Ü
(
”ºo
));

978  
NULL
;

982 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

985 if(
do_abÜt
) {

986  
NULL
;

990 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

991 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

992 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

993  
NULL
;

997 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

999 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

1000 if(
šc_bur¡
) {

1001 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

1002 
	`D
("Burst increased");

1005 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

1006 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

1008 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

1011 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1013  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

1014 
	}
}

1016 
	gcouÁ·ck‘ss
 = 0;

1018 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

1019 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1020 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1024 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

1026 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

1027 
¦Ù
->
æags
 = 0;

1032 #ifdeà
OPT_FOR_SINGLE_CORE


1033 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1035 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1037 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1040 if(
cÜeid
 == 0) {

1041 
£nd_™”
++;

1044 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1045 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1048 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1049 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1051 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1053 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1058 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1059 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1061 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1064 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1065 
ršg
->
h—d
 =„šg->
cur
;

1066 
pŞlfd
 
pfd
;

1067 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1068 
pfd
.
ev’ts
 = 
POLLOUT
;

1069 
pfd
.
»v’ts
 = 0;

1070 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1074 
	}
}

1076 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1077 #iâdeà
OPT_FOR_SINGLE_CORE


1078 !
»cv_ma¡”_nmd
) {

1079 
this_th»ad
::
	`y›ld
();

1082 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1083 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1084 
nm»q
 
ba£_»q
;

1085 
š‹rçû
[25];

1086 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1088 #ifdeà
OPT_FOR_SINGLE_CORE


1089 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1090 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1092 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1093 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1095 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1096 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1097  
NULL
;

1099 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1100 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1101 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1103 ià(
cÜeid
==0) {

1104 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1105 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1108 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1109 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1110 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1112 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1113 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1114  
NULL
;

1116 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1117 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1118 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1120 
	`D
("zerocopy %s",

1121 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1128 
¡¬t
:

1129 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1133 
ušt16_t
 
n
;

1134 
²
;

1135 
pŞlfd
 
pfd
;

1136 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1137 
pfd
.
ev’ts
 = 
POLLIN
;

1138 
pfd
.
»v’ts
 = 0;

1139 #ifdeà
BUSY_WAIT


1140 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1141 
	`D
("ioctlƒrror on queue %d: %s", 0,

1142 
	`¡»¼Ü
(
”ºo
));

1143  
NULL
;

1147 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1150 if(
do_abÜt
) {

1151  
NULL
;

1155 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1156 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1157 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1158  
NULL
;

1162 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1169 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1170 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1172 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1174 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1176 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1178 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1179 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1182 #ifdeà
OPT_FOR_SINGLE_CORE


1183 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1184 if(
ARP_ENABLED
) {

1185 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1188 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1189 
³r_cÜe_couÁr
[
cÜeid
]--;

1190 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1191 
ršg
->
h—d
 =„šg->
cur
;

1192 
pŞlfd
 
pfd
;

1193 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1194 
pfd
.
ev’ts
 = 
POLLIN
;

1195 
pfd
.
»v’ts
 = 0;

1196 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1199 
¡¬t
;

1203  (*)((*)
pkt
+(
‘h”_h—d”
));

1205  
NULL
;

1207 
	}
}

1209 
	gcouÁ·ck‘¤
 = 0;

1211 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1215 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1217 #ifdeà
OPT_FOR_SINGLE_CORE


1218 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1219 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1221 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1224 if(
cÜeid
 == 0) {

1225 
»cv_™”
++;

1228 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1229 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1233 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1234 
³r_cÜe_couÁr
[
cÜeid
]--;

1235 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1236 
ršg
->
h—d
 =„šg->
cur
;

1237 
pŞlfd
 
pfd
;

1238 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1239 
pfd
.
ev’ts
 = 
POLLIN
;

1240 
pfd
.
»v’ts
 = 0;

1244 
	}
}

1247 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1249 
£nd_th»ad_cÜe
;

1251 
time_t
 
¡¬t_t
, 
’d_t
;

1252 
¿‹_t
, 
diff_t
;

1253 
timev®
 
begš
, 
’d
;

1255 #if 
N_MINUS_2_CONFIG


1256 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1257 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1258 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1259 
£nd_th»ad_cÜe
 = 1;

1261 
£nd_th»ad_cÜe
 = 0;

1263 #–if 
N_MINUS_1_CONFIG


1264 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1265 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1267 
£nd_th»ad_cÜe
 = 0;

1270 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1271 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1273 
£nd_th»ad_cÜe
 = 0;

1277 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1278 
this_th»ad
::
	`y›ld
();

1280 
ch
;

1281 
ušt32_t
 
i
,
j
;

1282 
rv
;

1283 
veùÜ
<
pÜt_des
> 
pÜts
;

1284 
ušt64_t
 
™”
 = 0;

1285 
ušt32_t
 
Åes
;

1286 
pÜt_des
 *
rxpÜt
;

1287 
pÜt_des
 *
txpÜt
;

1289 
nm»q
 
ba£_»q
;

1290 
ušt32_t
 
exŒa_bufs
;

1291 
ušt32_t
 
sÿn
;

1293 
u_št
 
couÁs
;

1294 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1295 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1296 
Ãtm­_ršg
 *
txršg
;

1299 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1300 
Åes
 = 
£nd_ouut_ršgs
;

1302 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1303 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1305 
	`D
("Åes:%u",
Åes
);

1307 
pÜts
.
	`»size
(
Åes
+2);

1309 
£nd_¡©s
.
	`»size
(
Åes
+1);

1311 
i
=0;i<=
Åes
;i++) {

1312 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

1315 
txpÜt
 = &
pÜts
[
Åes
];

1316 
rxpÜt
 = &
pÜts
[
Åes
+1];

1320 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1321 
	`D
("failedo‡llocatehe stats‡rray");

1322  
NULL
;

1325 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1327 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1328 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1330 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1331 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1332  
NULL
;

1334 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1335 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1338 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1339 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1342 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1344 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1345 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1346 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1347 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1349 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1350 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1351  
NULL
;

1353 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1354 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1358 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1359 
txršg
 = 
txpÜt
->
ršg
;

1360 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1362 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1364 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1366 
i
 = 0; i < 
Åes
; ++i) {

1367 
š‹rçû
[25];

1368 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1369 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1370 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1372 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1373 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1374  
NULL
;

1376 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1377 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1378 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1380 
	`D
("zerocopy %s",

1381 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1384 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1385 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1387 
	`¦“p
(2);

1389 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1390 
ušt64_t
 
times
=0;

1392 
i
 = 0; i < 
Åes
+2; ++i) {

1393 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1416 !
do_abÜt
) {

1417 
u_št
 
pŞlo
 = 0;

1419 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1421 
	`g‘timeofday
(&
begš
, 
NULL
);

1424 
™”
++;

1426 
i
 = 0; i < 
Åes
; ++i) {

1427 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1428 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1432 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1433 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1434 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1435 
úts
[
pŞlo
] = 
i
;

1436 ++
pŞlo
;

1438 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1439 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1440 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1442 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1443 ià(
rv
 <= 0) {

1444 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1445 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1449 
b©ch_cur
 = 0,
™emp
;

1450 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1451 
i
 = 
úts
[
™emp
];

1452 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1455 
Ãxt_cur
 = 
ršg
->
cur
;

1456 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1457 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1458 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1459 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1460 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1462 
»cvcouÁ
--) {

1463 
n
;

1464 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1465 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1466 if(
šc_bur¡
) {

1467 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1468 
	`D
("Burst increased");

1471 
b©ch_cur
 = 
£nd_b©ch
;

1475 #ifdeà
BUSY_WAIT


1476 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1477 
	`D
("ioctlƒrror on queue %d: %s", 0,

1478 
	`¡»¼Ü
(
”ºo
));

1479  
NULL
;

1482 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1483 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1484 
	`¡»¼Ü
(
”ºo
));

1485  
NULL
;

1487 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1488 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1489 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1490  
NULL
;

1493 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1494 ià(
n
 < 
b©ch_cur
)

1495 
b©ch_cur
 = 
n
;

1499 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1500 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1501 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1502 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1503 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1504 
	`__butš_´eãtch
(
Ãxt_buf
);

1506 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1507 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1508 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1513 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1516 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1522 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1523 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1529 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1531 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1538 
tx¦Ù
->
Ën
=
rs
->len;

1543 
tx¦Ù
->
æags
 = 0;

1544 
b©ch_cur
--;

1545 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1546 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1547 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1548 
£nd_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1550 ià(
b©ch_cur
==0) {

1551 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1553 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1554 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1555 
b©ch_cur
 = 0;

1556 
txršg
->
h—d
 =xršg->
cur
;

1557 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1561 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1568 
	`g‘timeofday
(&
’d
, 
NULL
);

1569 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

1570 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

1571 
¿‹_t
 = (
£nd_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

1572 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

1574 
	`¦“p
(5);

1575 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1576 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1582  
NULL
;

1583 
	}
}

1586 
ušt64_t
 
	gnumbuf
=0;

1588 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1590 
»cv_th»ad_cÜe
;

1592 
time_t
 
¡¬t_t
, 
’d_t
;

1593 
¿‹_t
, 
diff_t
;

1594 
timev®
 
begš
, 
’d
;

1596 #if 
N_MINUS_2_CONFIG


1597 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1598 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1599 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1600 
»cv_th»ad_cÜe
 = 1;

1602 
»cv_th»ad_cÜe
 = 0;

1604 #–if 
N_MINUS_1_CONFIG


1605 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1606 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1608 
»cv_th»ad_cÜe
 = 0;

1611 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1612 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1614 
»cv_th»ad_cÜe
 = 0;

1618 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1619 
this_th»ad
::
	`y›ld
();

1621 
	`D
("CÜ%d:",
»cv_th»ad_cÜe
);

1623 
ch
;

1624 
ušt32_t
 
i
,
j
;

1625 
rv
;

1626 
veùÜ
<
pÜt_des
> 
pÜts
;

1627 
™”
 = 0;

1628 
ušt32_t
 
Åes
;

1629 
ov”æow_queue
 *
ä“q
;

1630 
pÜt_des
 *
rxpÜt
;

1631 
pÜt_des
 *
txpÜt
;

1633 
nm»q
 
ba£_»q
;

1634 
ušt32_t
 
exŒa_bufs
;

1635 
ušt32_t
 
sÿn
;

1636 
veùÜ
<
ov”æow_queue
> 
oq
;

1638 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1641 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1642 
Åes
 = 
»cv_ouut_ršgs
;

1643 
ä“q
 = 
NULL
;

1645 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1646 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1648 
	`D
("Åes:%u",
Åes
);

1650 
pÜts
.
	`»size
(
Åes
+2);

1652 
»cv_¡©s
.
	`»size
(
Åes
+1);

1654 
i
=0;i<=
Åes
;i++) {

1655 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

1662 
oq
.
	`»size
(
Åes
+1);

1663 ià(
oq
.
	`size
()!=
Åes
+1) {

1664 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1665  
NULL
;

1668 
rxpÜt
 = &
pÜts
[
Åes
];

1669 
txpÜt
 = &
pÜts
[
Åes
+1];

1673 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1674 
	`D
("failedo‡llocatehe stats‡rray");

1675  
NULL
;

1678 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1680 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1681 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1683 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1684 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1685  
NULL
;

1687 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1688 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1691 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1692 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1695 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1697 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1698 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1699 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1700 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1702 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1703 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1704  
NULL
;

1706 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1707 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1711 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1712 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1714 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1716 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1717 ià(!
exŒa_bufs
)

1718 
run
;

1720 
ä“q
 = &
oq
[
Åes
];

1721 
rxpÜt
->
oq
 = 
NULL
;

1722 
txpÜt
->
oq
 = 
ä“q
;

1724 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1730 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1731 
sÿn
;

1732 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1734 
Ãtm­_¦Ù
 
s
;

1735 
s
.
buf_idx
 = 
sÿn
;

1736 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1737 
ä“q
->
¦Ùs
.
	`push
(
s
);

1740 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1741 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1742 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1743  
NULL
;

1745 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1747 
run
:

1748 
i
 = 0; i < 
Åes
; ++i) {

1749 
š‹rçû
[25];

1750 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1751 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1752 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1754 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1755 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1756  
NULL
;

1758 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1759 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1760 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1762 
	`D
("zerocopy %s",

1763 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1765 ià(
exŒa_bufs
) {

1766 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1767 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1768 
pÜts
[
i
].
oq
 = 
q
;

1772 ià(!
exŒa_bufs
) {

1773 ià(!
oq
.
	`em±y
()) {

1774 
i
 = 0; i < 
Åes
 + 1; i++) {

1775 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1776 
oq
[
i
].
¦Ùs
.
	`pİ
();

1778 
pÜts
[
i
].
oq
 = 
NULL
;

1780 
pÜts
[
i
].
oq
 = 
NULL
;

1781 
oq
.
	`ş—r
();

1783 
	`D
("*** overflow queues disabled ***");

1786 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1787 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1789 
	`¦“p
(2);

1791 !
§ã_to_¡¬t_»cv
) {

1792 
this_th»ad
::
	`y›ld
();

1795 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1796 
ušt64_t
 
times
=0;

1798 
i
 = 0; i < 
Åes
+2; ++i) {

1799 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1822 !
do_abÜt
) {

1823 
u_št
 
pŞli
 = 0;

1825 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1827 
	`g‘timeofday
(&
begš
, 
NULL
);

1830 
™”
++;

1831 
i
 = 0; i < 
Åes
; ++i) {

1832 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1833 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1837 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1838 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1839 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1840 ++
pŞli
;

1842 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1843 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1844 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1845 ++
pŞli
;

1847 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1848 ià(
rv
 <= 0) {

1849 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1850 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1854 ià(!
oq
.
	`em±y
()) {

1858 
i
 = 0; i < 
Åes
; i++) {

1859 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1860 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1861 
ušt32_t
 
j
, 
lim
;

1862 
Ãtm­_ršg
 *
ršg
;

1863 
Ãtm­_¦Ù
 *
¦Ù
;

1865 ià(
q
->
¦Ùs
.
	`em±y
())

1867 
ršg
 = 
p
->ring;

1868 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1869 ià(!
lim
)

1871 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1872 
lim
 = 
q
->
¦Ùs
.
	`size
();

1873 
j
 = 0; j < 
lim
; j++) {

1874 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1875 
q
->
¦Ùs
.
	`pİ
();

1876 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1877 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1878 *
¦Ù
 = 
s
;

1879 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1880 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1881 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1882 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1884 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1885 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1887 
ršg
->
h—d
 =„šg->
cur
;

1892 
b©ch_cur
 = 0;

1893 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1894 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1897 
Ãxt_cur
 = 
rxršg
->
cur
;

1898 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1899 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1900 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1901 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1902 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1904 
ršg¥aû
--) {

1905 
ov”æow_queue
 *
q
;

1906 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1907 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1908 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1915 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1916 if(
ARP_ENABLED
) {

1917 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1920 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1921 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1922 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1923 
	`__butš_´eãtch
(
Ãxt_buf
);

1924 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1926 
b©ch_cur
++;

1927 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1928 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1934 
b©ch_cur
 = 0;

1943 
ušt32_t
 
ouut_pÜt
 = 0;

1944 if(
»cv_th»ad_cÜe
) {

1945 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1947 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1954 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1955 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1956 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1957 
	`__butš_´eãtch
(
Ãxt_buf
);

1961 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1962 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1963 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1966 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1967 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1968 *
cİy_buf
;

1969 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1970 
ts
->
Ën
 = 
rs
->len;

1971 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1973 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1975 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

1976 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1977 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1978 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1981 
fÜw¬d
;

1985 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1986 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

1987 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1988 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1989 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1991 
Ãxt
;

1994 
q
 = &
oq
[
ouut_pÜt
];

1996 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1998 
ušt32_t
 
j
;

1999 
pÜt_des
 *
Í
 = &
pÜts
[0];

2000 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2002 
j
 = 1; j < 
Åes
; j++) {

2003 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2004 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2005 
Í
 = 
ı
;

2006 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2011 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2012 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2014 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2015 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2016 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2017 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2020 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2021 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2024 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2027 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2028 
ä“q
->
¦Ùs
.
	`pİ
();

2030 *
‹mp_buf
;

2031 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2032 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2033 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2034 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2036 
fÜw¬d
:

2038 
Ãxt
:

2039 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2041 
b©ch_cur
++;

2042 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2043 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2049 
b©ch_cur
 = 0;

2060 ià(
exŒa_bufs
) {

2061 
	`ä“_bufãrs
(
pÜts
);

2070 
	`g‘timeofday
(&
’d
, 
NULL
);

2071 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

2072 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

2073 
¿‹_t
 = (
»cv_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

2074 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

2076 
	`¦“p
(5);

2077 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2078 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2084  
NULL
;

2085 
	}
}

2088 
u_št16_t


2089 
	$w¿psum
(
u_št32_t
 
sum
)

2091 
sum
 = ~sum & 0xFFFF;

2092  (
	`htÚs
(
sum
));

2093 
	}
}

2096 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2098 
s
;

2099 
iäeq
 
bufãr
;

2100 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2102 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2103 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2105 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2107 
	`şo£
(
s
);

2108 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2109 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2110 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2111 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2112 
fd
;

2113 
iäeq
 
iä
;

2115 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2118 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2121 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2123 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2125 
	`şo£
(
fd
);

2128 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2129 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2130 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2133 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2134 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2135 
	`D
("Hurray 1");

2138 
š_addr
 
©t
;

2139 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2141 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

2142 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2143 
	`D
("Hurray 2");

2144 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2147 
	}
}

	@include/netmap_api_cache_unfriendly.h

1 #iâdeà
__NETMAP_API_H_


2 
	#__NETMAP_API_H_


	)

4 
	~<¡dio.h
>

5 
	#NETMAP_WITH_LIBS


	)

6 
	~<Ãt/Ãtm­_u£r.h
>

7 
	~<©omic
>

8 
	~<ùy³.h
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~<m­
>

11 
	~<mu‹x
>

12 
	~<±h»ad.h
>

13 
	~<¡ršg
>

14 
	~<th»ad
>

15 
	~<queue
>

16 
	~<¡dboŞ.h
>

17 
	~<š‰y³s.h
>

18 
	~<sy¦og.h
>

19 
usšg
 
Çme¥aû
 
	g¡d
;

22 
	~<uni¡d.h
>

23 
	~<içddrs.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/pŞl.h
>

26 
	~<sys/sock‘.h
>

27 
	~<sys/ty³s.h
>

28 
	~<¬·/š‘.h
>

29 
	~<Ãt/‘h”Ãt.h
>

30 
	~<Ãt/if.h
>

31 
	~<Ãtš‘/š.h
>

32 
	~<time.h
>

33 
	~<sys/time.h
>

35 
	~<lšux/udp.h
>

36 
	~<lšux/tı.h
>

37 
	~<Ãtš‘/.h
>

38 
	~<Ãtš‘/‘h”.h
>

40 #ifdeà
lšux


41 
	#ıu£t_t
 
ıu_£t_t


	)

45 
	~"ùrs.h
"

46 
usšg
 
Çme¥aû
 
	g¡d
;

48 
	#SKIP_PAYLOAD
 1

	)

49 
	#MAX_QUEUE_SIZE
 10000

	)

50 
	#MAX_BODYSIZE
 2048

	)

51 
	#MAX_IFNAMELEN
 64

	)

52 
	#MAX_BURST
 1000

	)

53 
	#RECV_THREAD_COUNT
 1

	)

54 
	#MAX_BATCH_SEND
 4

	)

55 
	#MAX_BATCH_CORE_SEND
 4

	)

56 
	#MAX_BATCH_RECV
 128

	)

57 
	#MAX_BATCH_CORE_RECV
 128

	)

58 
	#DATA_LEN
 64

	)

59 
	#MAX_BUF_COUNT
 500000

	)

60 
	#NO_OF_SAFE_ITR
 20000

	)

62 
	#OPT_FOR_SINGLE_CORE


	)

65 
	#ARP_ENABLED
 0

	)

66 
	#DEST_MAC
 "a0:36:9f:3e:eb:70"

	)

68 
	#APP_BASED_HASH


	)

69 
	#N_MINUS_1_CONFIG
 0

	)

70 
	#N_MINUS_2_CONFIG
 0

	)

71 
	#STAT_ON_SEND_CORE
 0

	)

72 
	#STAT_ON_RECV_CORE
 0

	)

78 #iâdeà
ETH_ALEN


79 
	#ETH_ALEN
 6

	)

81 
	#MAX_BODYSIZE
 2048

	)

83 
	#MAX_IFNAMELEN
 64

	)

84 
	#DEF_OUT_PIPES
 2

	)

85 
	#DEF_EXTRA_BUFS
 0

	)

86 
	#DEF_BATCH
 2048

	)

87 
	#DEF_SYSLOG_INT
 600

	)

88 
	#BUF_REVOKE
 100

	)

89 #iâdeà
__PKT_HASH__


90 
	#__PKT_HASH__


	)

99 
	~<¡dšt.h
>

101 #ifdeà
__GNUC__


102 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

103 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

105 
	#lik–y
(
x
è(x)

	)

106 
	#uÆik–y
(
x
è(x)

	)

109 
	#HTONS
(
n
) ((((()(n) & 0xFF)) << 8) | \

110 ((()(
n
è& 0xFF00è>> 8))

	)

111 
	#NTOHS
(
n
) ((((()(n) & 0xFF)) << 8) | \

112 ((()(
n
è& 0xFF00è>> 8))

	)

114 
	#HTONL
(
n
) ((((()(n) & 0xFF)) << 24) | \

115 (((()(
n
) & 0xFF00)) << 8) | \

116 (((()(
n
) & 0xFF0000)) >> 8) | \

117 (((()(
n
è& 0xFF000000)è>> 24))

	)

119 
	#NTOHL
(
n
) ((((()(n) & 0xFF)) << 24) | \

120 (((()(
n
) & 0xFF00)) << 8) | \

121 (((()(
n
) & 0xFF0000)) >> 8) | \

122 (((()(
n
è& 0xFF000000)è>> 24))

	)

124 
	svÏnhdr
 {

125 
ušt16_t
 
	m´i_cfi_vÏn
;

126 
ušt16_t
 
	m´Ùo
;

127 } 
	tvÏnhdr
;

133 
ušt32_t


134 
pkt_hdr_hash
(cÚ¡ *
bufãr
,

135 
ušt8_t
 
hash_¥l™
,

136 
ušt8_t
 
£ed
);

139 
	spkthdr
 {

140 
‘h”_h—d”
 
	meh
;

141 

 
	m
;

142 } 
__©Œibu‹__
((
__·cked__
));

144 
	sudp_pkt
 {

145 
pkthdr
 
	mpkthdr
;

146 
udphdr
 
	mudp
;

147 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
udphdr
)];

148 } 
__©Œibu‹__
((
__·cked__
));

150 
	stı_pkt
 {

151 
pkthdr
 
	mpkthdr
;

152 
tıhdr
 
	mtı
;

153 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
tıhdr
)];

154 } 
__©Œibu‹__
((
__·cked__
));

156 
	sth»ad_¦Ù
 {

157 
ušt32_t
 
	mcur
;

158 
ušt32_t
 
	mÃxt
;

159 
Ãtm­_¦Ù
 *
	mtx¦Ù
;

162 
	scom·ù_‘h_hdr
 {

163 
	mh_de¡
[
ETH_ALEN
];

164 
	mh_sourû
[
ETH_ALEN
];

165 
u_št16_t
 
	mh_´Ùo
;

168 
	sd©a_¡ruù
 {

169 
ušt32_t
 
	mimsi
;

170 
	md©a
[
DATA_LEN
];

173 
	scom·ù__hdr
 {

174 
u_št8_t
 
	mihl
:4, 
	mv”siÚ
:4;

175 
u_št8_t
 
	mtos
;

176 
u_št16_t
 
	mtÙ_Ën
;

177 
u_št16_t
 
	mid
;

178 
u_št16_t
 
	mäag_off
;

179 
u_št8_t
 
	m‰l
;

180 
u_št8_t
 
	m´ÙocŞ
;

181 
u_št16_t
 
	mcheck
;

182 
u_št32_t
 
	m§ddr
;

183 
u_št32_t
 
	mdaddr
;

186 
	scom·ù_v6_hdr
 {

187 
u_št8_t
 
	m´iÜ™y
:4, 
	mv”siÚ
:4;

188 
u_št8_t
 
	mæow_lbl
[3];

189 
u_št16_t
 
	m·ylßd_Ën
;

190 
u_št8_t
 
	mÃxthdr
;

191 
u_št8_t
 
	mhİ_lim™
;

192 
š6_addr
 
	m§ddr
;

193 
š6_addr
 
	mdaddr
;

197 } 
	gglob_¬g
;

202 
	sov”æow_queue
 {

203 
	mÇme
[
MAX_IFNAMELEN
];

204 
	mqueue
<
	mÃtm­_¦Ù
> 
	m¦Ùs
;

207 
	spÜt_des
 {

208 
my_ùrs
 
	mùr
;

209 
	mÏ¡_sync
;

210 
ov”æow_queue
 *
	moq
;

211 
nm_desc
 *
	mnmd
;

212 
Ãtm­_ršg
 *
	mršg
;

215 
	s»cv_th»ad_¬g
 {

216 
u_št
 
	mid
;

217 *
	miâame
;

218 
nm_desc
 *
	m·»Á_nmd
;

221 
	sCom·»
 {

222 
boŞ
 
İ”©Ü
(è(cÚ¡ 
	mš_addr
 &
	ma
, cÚ¡ š_add¸&
	mb
) const {

223  
	ma
.
	ms_addr
 < 
	mb
.s_addr;

227 
	scompu‹_¡©s
 {

228 
ušt64_t
 
	mdrİ³d
;

229 
ušt64_t
 
	mfÜw¬ded
;

231 
ušt16_t
 
checksum
(cÚ¡ *
d©a
, ušt16_ˆ
Ën
, 
ušt32_t
 
sum
);

232 
u_št16_t
 
w¿psum
(
u_št32_t
 
sum
);

236 
dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
);

238 şas 
	cN‘m­U£
 {

239 
	m´iv©e
:

240 
nm_desc
 *
nmd
;

241 
	mwa™_lšk
;

243 
th»ad
 
	mth»ad_v¬_rx
;

244 
th»ad
 
	m»ûiv”_th»ads
[
MAX_BURST
];

245 
u_št
 
	mbur¡s
;

246 
u_št
 
	mbur¡r
;

247 
pŞlfd
 
	mpfdi
;

248 
pŞlfd
 
	mpfdo
;

249 
Ãtm­_ršg
 *
	mrxršg
;

250 
Ãtm­_¦Ù
 *
	mtx¦Ù
;

252 
size_t
 
	mnum_»cv
;

254 
ušt8_t
 
	mvœt_h—d”
;

256 
	m¤c__addr
[20];

257 
	m¤c_‘h_addr
[20];

258 
š_addr
 
	m¤c_
;

260 
mu‹x
 
	mcs_Ãtm­_sync
;

261 
mu‹x
 
	mcs_Ãtm­_g‘_rx_bufãr
;

263 
u_št
 
	m‹¡couÁ
;

266 
	mm­
 < 
	mš_addr
, 
	m‘h”_addr
, 
	mCom·»
 > 
	m¬±abË
;

268 
	msy¦og_š‹rv®
;

271 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

272 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

274 #ifdef 
OPT_FOR_SINGLE_CORE


275 
time_t
 
	m¡¬t_time_£nd
;

276 
time_t
 
	m¡¬t_time_»cv
;

278 
	m¿‹_time
;

279 
	mdiff_time
;

281 
timev®
 
	mbegš_time_£nd
;

282 
timev®
 
	mbegš_time_»cv
;

283 
timev®
 
	m’d_time
;

285 
ušt64_t
 
	m£nd_™”
;

286 
ušt64_t
 
	m»cv_™”
;

288 
nm_desc
 *
	mmq_nmd
;

291 
	miâame
[
MAX_IFNAMELEN
];

293 
	m£nd_iâame
[
MAX_IFNAMELEN
];

294 
	m£nd_pes_iâame
[
MAX_IFNAMELEN
];

295 
ušt16_t
 
	m£nd_ouut_ršgs
;

296 
ušt32_t
 
	m£nd_exŒa_bufs
;

297 
ušt16_t
 
	m£nd_b©ch
;

298 
	mveùÜ
<
	mušt16_t
> 
	m£nd_b©ch_cÜe
;

300 
	m»cv_iâame
[
MAX_IFNAMELEN
];

301 
	m»cv_pes_iâame
[
MAX_IFNAMELEN
];

302 
ušt16_t
 
	m»cv_ouut_ršgs
;

303 
ušt32_t
 
	m»cv_exŒa_bufs
;

304 
ušt16_t
 
	m»cv_b©ch
;

305 
	mveùÜ
<
	mušt16_t
> 
	m»cv_b©ch_cÜe
;

307 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

308 
	mveùÜ
<
	mpŞlfd
> 
	m³r_cÜe_£nd_pfd
;

309 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

311 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

312 
	mveùÜ
<
	mpŞlfd
> 
	m³r_cÜe_»cv_pfd
;

313 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

315 
pÜt_des
 
	mpÜt_¡©
[100];

317 
th»ad
 
	m¡©_th»ad
;

318 
u_št
 
	mvœt_hdr_Ën
;

319 
boŞ
 
	m§ã_to_¡¬t_£nd
;

320 
boŞ
 
	m§ã_to_¡¬t_»cv
;

322 
nm_desc
 *
	m£nd_ma¡”_nmd
;

323 
nm_desc
 *
	m»cv_ma¡”_nmd
;

326 
th»ad
 
	m£nd_th»ad
;

327 
th»ad
 
	m»cv_th»ad
;

329 
	mpublic
:

331 
ušt32_t
 
šc_bur¡
;

332 
u_št
 
	mdo_abÜt
;

333 
Ãtm­_ršg
 *
	mtxršg
;

335 
š™_Ãtm­
();

336 
İ’_Ãtm­_dev
(*
iâame
);

338 * 
g‘_bufãr_tx
();

339 
syncbuáx
(
udp_pkt
 *);

340 * 
g‘_bufãr_tx
(
cÜeid
);

341 
syncbuáx
(
cÜeid
);

344 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

345 
syncbuäx
(
cÜeid
);

350 
th»ad_func_tx
();

351 *
³r_cÜe_£nd_·ck‘
(
cÜeid
);

353 
sourû_hwaddr
(*
iâame
);

354 
£ffš™y
(
±h»ad_t
 
me
, 
i
);

355 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

359 
ušt32_t
 
fšd_¡©_th»ad_cÜe
();

361 
š™Ÿlize_£nd_»cv
();

362 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

364 
³r_cÜe_»cv_funcc
(
»cv_th»ad_¬g
 
¹a
);

365 
³r_cÜe_»cv_func
(
cÜeid
);

366 
´št_¡©s
(
pÜt_des
 *
pÜts
);

367 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

368 *
£nd_pkts_to_içû
();

369 *
»ûive_pkts_äom_içû
();

371 
N‘m­U£
();

372 ~
N‘m­U£
();

376 
š™Ÿlize_·ck‘
(
udp_pkt
 *
pkt
);

379 
N‘m­U£
 
Ãtm­u£
;

	@include/netmap_api_original.h

1 #iâdeà
__NETMAP_API_H_


2 
	#__NETMAP_API_H_


	)

4 
	~<¡dio.h
>

5 
	#NETMAP_WITH_LIBS


	)

6 
	~<Ãt/Ãtm­_u£r.h
>

7 
	~<©omic
>

8 
	~<ùy³.h
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~<m­
>

11 
	~<mu‹x
>

12 
	~<±h»ad.h
>

13 
	~<¡ršg
>

14 
	~<th»ad
>

15 
	~<queue
>

16 
	~<li¡
>

17 
	~<¡dboŞ.h
>

18 
	~<š‰y³s.h
>

19 
	~<sy¦og.h
>

21 
	~<¥¬£hash/d’£_hash_m­
>

22 
	~<¥¬£hash/d’£_hash_£t
>

23 
	~<cÚcu¼’tqueue.h
>

24 
	~<unÜd”ed_m­
>

26 
usšg
 
Çme¥aû
 
	g¡d
;

27 
usšg
 
	ggoogË
::
d’£_hash_m­
;

28 
usšg
 
	ggoogË
::
d’£_hash_£t
;

31 
	~<uni¡d.h
>

32 
	~<içddrs.h
>

33 
	~<sys/ioùl.h
>

34 
	~<sys/pŞl.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/ty³s.h
>

37 
	~<¬·/š‘.h
>

38 
	~<Ãt/‘h”Ãt.h
>

39 
	~<Ãt/if.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<time.h
>

42 
	~<sys/time.h
>

44 
	~<lšux/udp.h
>

45 
	~<lšux/tı.h
>

46 
	~<Ãtš‘/.h
>

47 
	~<Ãtš‘/‘h”.h
>

48 
	~<libcuckoo/cuckoohash_m­.hh
>

50 #ifdeà
lšux


51 
	#ıu£t_t
 
ıu_£t_t


	)

55 
	~"ùrs.h
"

56 
usšg
 
Çme¥aû
 
	g¡d
;

58 
	#SKIP_PAYLOAD
 1

	)

59 
	#MAX_QUEUE_SIZE
 10000

	)

60 
	#MAX_BODYSIZE
 2048

	)

61 
	#MAX_IFNAMELEN
 64

	)

62 
	#MAX_BURST
 1000

	)

63 
	#RECV_THREAD_COUNT
 1

	)

64 
	#MAX_BATCH_SEND
 5

	)

65 
	#MAX_BATCH_CORE_SEND
 5

	)

66 
	#MAX_BATCH_RECV
 128

	)

67 
	#MAX_BATCH_CORE_RECV
 128

	)

68 
	#DATA_LEN
 1448

	)

69 
	#MAX_BUF_COUNT
 500000

	)

70 
	#NO_OF_SAFE_ITR
 20000

	)

74 
	#ARP_ENABLED
 0

	)

75 
	#DEST_MAC
 "00:¯:bb:cc:dd:07"

	)

77 
	#APP_BASED_HASH


	)

79 
	#N_MINUS_1_CONFIG
 0

	)

80 
	#N_MINUS_2_CONFIG
 1

	)

81 
	#STAT_ON_SEND_CORE
 0

	)

82 
	#STAT_ON_RECV_CORE
 0

	)

88 #iâdeà
ETH_ALEN


89 
	#ETH_ALEN
 6

	)

91 
	#MAX_BODYSIZE
 2048

	)

93 
	#MAX_IFNAMELEN
 64

	)

94 
	#DEF_OUT_PIPES
 2

	)

95 
	#DEF_EXTRA_BUFS
 0

	)

96 
	#DEF_BATCH
 2048

	)

97 
	#DEF_SYSLOG_INT
 600

	)

98 
	#BUF_REVOKE
 100

	)

99 #iâdeà
__PKT_HASH__


100 
	#__PKT_HASH__


	)

109 
	~<¡dšt.h
>

111 #ifdeà
__GNUC__


112 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

113 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

115 
	#lik–y
(
x
è(x)

	)

116 
	#uÆik–y
(
x
è(x)

	)

119 
	#HTONS
(
n
) ((((()(n) & 0xFF)) << 8) | \

120 ((()(
n
è& 0xFF00è>> 8))

	)

121 
	#NTOHS
(
n
) ((((()(n) & 0xFF)) << 8) | \

122 ((()(
n
è& 0xFF00è>> 8))

	)

124 
	#HTONL
(
n
) ((((()(n) & 0xFF)) << 24) | \

125 (((()(
n
) & 0xFF00)) << 8) | \

126 (((()(
n
) & 0xFF0000)) >> 8) | \

127 (((()(
n
è& 0xFF000000)è>> 24))

	)

129 
	#NTOHL
(
n
) ((((()(n) & 0xFF)) << 24) | \

130 (((()(
n
) & 0xFF00)) << 8) | \

131 (((()(
n
) & 0xFF0000)) >> 8) | \

132 (((()(
n
è& 0xFF000000)è>> 24))

	)

136 
_¬p_hdr
 
	t¬p_hdr
;

137 
	s_¬p_hdr
 {

138 
ušt16_t
 
	mhty³
;

139 
ušt16_t
 
	m±y³
;

140 
ušt8_t
 
	mhËn
;

141 
ušt8_t
 
	m¶’
;

142 
ušt16_t
 
	mİcode
;

143 
ušt8_t
 
	m£nd”_mac
[6];

144 
ušt32_t
 
	m£nd”_
;

145 
ušt8_t
 
	mrg‘_mac
[6];

146 
ušt32_t
 
	mrg‘_
;

147 } 
__©Œibu‹__
((
__·cked__
));

149 
	svÏnhdr
 {

150 
ušt16_t
 
	m´i_cfi_vÏn
;

151 
ušt16_t
 
	m´Ùo
;

152 } 
	tvÏnhdr
;

158 
ušt32_t


159 
pkt_hdr_hash
(cÚ¡ *
bufãr
,

160 
ušt8_t
 
hash_¥l™
,

161 
ušt8_t
 
£ed
);

164 
	spkthdr
 {

165 
‘h”_h—d”
 
	meh
;

166 

 
	m
;

167 } 
__©Œibu‹__
((
__·cked__
));

169 
	s¬p_pkt
 {

170 
‘h”_h—d”
 
	meh
;

171 
¬p_hdr
 
	mah
;

172 } 
__©Œibu‹__
((
__·cked__
));

174 
	sudp_pkt
 {

175 
pkthdr
 
	mpkthdr
;

176 
udphdr
 
	mudp
;

177 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
udphdr
)];

178 } 
__©Œibu‹__
((
__·cked__
));

180 
	stı_pkt
 {

181 
pkthdr
 
	mpkthdr
;

182 
tıhdr
 
	mtı
;

183 
ušt8_t
 
	mbody
[
MAX_BODYSIZE
 - (
pkthdr
è- (
tıhdr
)];

184 } 
__©Œibu‹__
((
__·cked__
));

186 
	sth»ad_¦Ù
 {

187 
ušt32_t
 
	mcur
;

188 
ušt32_t
 
	mÃxt
;

189 
Ãtm­_¦Ù
 *
	mtx¦Ù
;

192 
	scom·ù_‘h_hdr
 {

193 
	mh_de¡
[
ETH_ALEN
];

194 
	mh_sourû
[
ETH_ALEN
];

195 
u_št16_t
 
	mh_´Ùo
;

198 
	sd©a_¡ruù
 {

199 
ušt32_t
 
	mimsi
;

200 
	md©a
[
DATA_LEN
];

203 
	scom·ù__hdr
 {

204 
u_št8_t
 
	mihl
:4, 
	mv”siÚ
:4;

205 
u_št8_t
 
	mtos
;

206 
u_št16_t
 
	mtÙ_Ën
;

207 
u_št16_t
 
	mid
;

208 
u_št16_t
 
	mäag_off
;

209 
u_št8_t
 
	m‰l
;

210 
u_št8_t
 
	m´ÙocŞ
;

211 
u_št16_t
 
	mcheck
;

212 
u_št32_t
 
	m§ddr
;

213 
u_št32_t
 
	mdaddr
;

216 
	scom·ù_v6_hdr
 {

217 
u_št8_t
 
	m´iÜ™y
:4, 
	mv”siÚ
:4;

218 
u_št8_t
 
	mæow_lbl
[3];

219 
u_št16_t
 
	m·ylßd_Ën
;

220 
u_št8_t
 
	mÃxthdr
;

221 
u_št8_t
 
	mhİ_lim™
;

222 
š6_addr
 
	m§ddr
;

223 
š6_addr
 
	mdaddr
;

229 
	sov”æow_queue
 {

230 
	mÇme
[
MAX_IFNAMELEN
];

231 
	mqueue
<
	mÃtm­_¦Ù
> 
	m¦Ùs
;

234 #ifdef 
PRINT_STATS


235 
	spÜt_des
 {

236 
my_ùrs
 
	mùr
;

237 
nm_desc
 *
	mnmd
;

238 
Ãtm­_ršg
 *
	mršg
;

239 
ov”æow_queue
 *
	moq
;

242 
	spÜt_des
 {

243 
nm_desc
 *
	mnmd
;

244 
Ãtm­_ršg
 *
	mršg
;

245 
ov”æow_queue
 *
	moq
;

249 
	sCom·»
 {

250 
boŞ
 
İ”©Ü
(è(cÚ¡ 
	mš_addr
 &
	ma
, cÚ¡ š_add¸&
	mb
) const {

251  
	ma
.
	ms_addr
 < 
	mb
.s_addr;

255 
	scompu‹_¡©s
 {

256 
ušt64_t
 
	mdrİ³d
;

257 
ušt64_t
 
	mfÜw¬ded
;

260 
	s_mac_·œ
 {

261 
ušt32_t
 
	m
;

262 
‘h”_addr
 
	mmac
;

265 
ušt16_t
 
checksum
(cÚ¡ *
d©a
, ušt16_ˆ
Ën
, 
ušt32_t
 
sum
);

266 
u_št16_t
 
w¿psum
(
u_št32_t
 
sum
);

268 #ifdef 
OPT_FOR_SINGLE_CORE


269 şas 
	cN‘m­U£
 {

270 
	m´iv©e
:

271 
¤c__addr
[20];

272 
	m¤c_‘h_addr
[20];

273 
š_addr
 
	m¤c_
;

274 
	mcuckoohash_m­
 < 
	mušt32_t
, 
	m‘h”_addr
 > 
	m¬±abË
;

276 
	mveùÜ
 < 
	md’£_hash_£t
 < 
	mušt32_t
 >* > 
	m³ndšg_¬p_»q
;

277 
	mveùÜ
 < 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ>* > 
	m³ndšg_¬p_»q_»Œ›s
;

278 
	mveùÜ
 < 
	mli¡
 < 
	mtı_pkt
 >* > 
	mdeã¼ed_·ck‘s
;

281 
	msy¦og_š‹rv®
;

282 
ušt32_t
 
	mcÜes_avaabË
;

284 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

285 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

287 
time_t
 
	m¡¬t_time_£nd
;

288 
time_t
 
	m¡¬t_time_»cv
;

290 
	m¿‹_time
;

291 
	mdiff_time
;

293 
timev®
 
	mbegš_time_£nd
;

294 
timev®
 
	mbegš_time_»cv
;

295 
timev®
 
	m’d_time
;

297 
ušt64_t
 
	m£nd_™”
;

298 
ušt64_t
 
	m»cv_™”
;

300 
nm_desc
 *
	mmq_nmd
;

302 
	miâame
[
MAX_IFNAMELEN
];

304 
	m£nd_iâame
[
MAX_IFNAMELEN
];

305 
	m£nd_pes_iâame
[
MAX_IFNAMELEN
];

306 
ušt16_t
 
	m£nd_ouut_ršgs
;

307 
ušt32_t
 
	m£nd_exŒa_bufs
;

308 
ušt16_t
 
	m£nd_b©ch
;

309 
	mveùÜ
<
	mušt16_t
> 
	m£nd_b©ch_cÜe
;

311 
	m»cv_iâame
[
MAX_IFNAMELEN
];

312 
	m»cv_pes_iâame
[
MAX_IFNAMELEN
];

313 
ušt16_t
 
	m»cv_ouut_ršgs
;

314 
ušt32_t
 
	m»cv_exŒa_bufs
;

315 
ušt16_t
 
	m»cv_b©ch
;

316 
	mveùÜ
<
	mušt16_t
> 
	m»cv_b©ch_cÜe
;

318 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

319 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

321 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

322 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

324 
th»ad
 
	m¡©_th»ad
;

325 
u_št
 
	mvœt_hdr_Ën
;

326 
boŞ
 
	m§ã_to_¡¬t_£nd
;

327 
boŞ
 
	m§ã_to_¡¬t_»cv
;

329 
nm_desc
 *
	m£nd_ma¡”_nmd
;

330 
nm_desc
 *
	m»cv_ma¡”_nmd
;

333 
th»ad
 
	m£nd_th»ad
;

334 
th»ad
 
	m»cv_th»ad
;

336 
	mpublic
:

338 
ušt32_t
 
šc_bur¡
;

339 
u_št
 
	mdo_abÜt
;

340 
Ãtm­_ršg
 *
	mtxršg
;

342 
š™_Ãtm­
();

343 
İ’_Ãtm­_dev
(*
iâame
);

345 * 
g‘_bufãr_tx
(
cÜeid
);

346 
syncbuáx
(
cÜeid
);

348 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

349 
syncbuäx
(
cÜeid
);

351 
sourû_hwaddr
(*
iâame
);

352 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

356 
ušt32_t
 
fšd_¡©_th»ad_cÜe
();

358 
š™Ÿlize_£nd_»cv
();

359 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

360 
´št_¡©s
(
pÜt_des
 *
pÜts
);

361 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

363 
´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
);

365 
N‘m­U£
();

366 ~
N‘m­U£
();

370 şas 
	cN‘m­U£
 {

371 
	m´iv©e
:

372 
¤c__addr
[20];

373 
	m¤c_‘h_addr
[20];

374 
š_addr
 
	m¤c_
;

376 
	md’£_hash_m­
 < 
	mušt32_t
, 
	m‘h”_addr
 > 
	m¬±abË
;

378 
	md’£_hash_£t
 < 
	mušt32_t
 > 
	m³ndšg_¬p_»q_th
;

379 
	md’£_hash_m­
 < 
	mušt32_t
, ušt32_ˆ> 
	m³ndšg_¬p_»q_»Œ›s_th
;

380 
	mli¡
 < 
	mtı_pkt
 > 
	mdeã¼ed_·ck‘s_th
;

382 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
_mac_·œ
> 
Ãw_¬p_’Œ›s_th
;

383 
	mmoodyÿm–
::
CÚcu¼’tQueue
 <
ušt32_t
> 
’queued_¬p_»q_th
;

386 
	msy¦og_š‹rv®
;

387 
ušt32_t
 
	mcÜes_avaabË
;

389 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m£nd_¡©s
;

390 
	mveùÜ
 < 
	mcompu‹_¡©s
 > 
	m»cv_¡©s
;

392 
time_t
 
	m¡¬t_time_£nd
;

393 
time_t
 
	m¡¬t_time_»cv
;

395 
	m¿‹_time
;

396 
	mdiff_time
;

398 
timev®
 
	mbegš_time_£nd
;

399 
timev®
 
	mbegš_time_»cv
;

400 
timev®
 
	m’d_time
;

402 
	miâame
[
MAX_IFNAMELEN
];

404 
	m£nd_iâame
[
MAX_IFNAMELEN
];

405 
	m£nd_pes_iâame
[
MAX_IFNAMELEN
];

406 
ušt16_t
 
	m£nd_ouut_ršgs
;

407 
ušt32_t
 
	m£nd_exŒa_bufs
;

408 
ušt16_t
 
	m£nd_b©ch
;

409 
	mveùÜ
<
	mušt16_t
> 
	m£nd_b©ch_cÜe
;

411 
	m»cv_iâame
[
MAX_IFNAMELEN
];

412 
	m»cv_pes_iâame
[
MAX_IFNAMELEN
];

413 
ušt16_t
 
	m»cv_ouut_ršgs
;

414 
ušt32_t
 
	m»cv_exŒa_bufs
;

415 
ušt16_t
 
	m»cv_b©ch
;

416 
	mveùÜ
<
	mušt16_t
> 
	m»cv_b©ch_cÜe
;

418 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_£nd_pÜt
;

419 
	mveùÜ
<> 
	m³r_cÜe_couÁs
;

421 
	mveùÜ
<
	mpÜt_des
> 
	m³r_cÜe_»cv_pÜt
;

422 
	mveùÜ
<> 
	m³r_cÜe_couÁr
;

424 
th»ad
 
	m¡©_th»ad
;

425 
u_št
 
	mvœt_hdr_Ën
;

426 
boŞ
 
	m§ã_to_¡¬t_£nd
;

427 
boŞ
 
	m§ã_to_¡¬t_»cv
;

429 
nm_desc
 *
	m£nd_ma¡”_nmd
;

430 
nm_desc
 *
	m»cv_ma¡”_nmd
;

433 
th»ad
 
	m£nd_th»ad
;

434 
th»ad
 
	m»cv_th»ad
;

436 
	mpublic
:

438 
ušt32_t
 
šc_bur¡
;

439 
u_št
 
	mdo_abÜt
;

440 
Ãtm­_ršg
 *
	mtxršg
;

442 
š™_Ãtm­
();

443 
İ’_Ãtm­_dev
(*
iâame
);

445 * 
g‘_bufãr_tx
(
cÜeid
);

446 
syncbuáx
(
cÜeid
);

448 * 
g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
);

449 
syncbuäx
(
cÜeid
);

451 
sourû_hwaddr
(*
iâame
);

452 *
‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
);

456 
ušt32_t
 
fšd_¡©_th»ad_cÜe
();

458 
š™Ÿlize_£nd_»cv
();

459 
g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
);

460 
´št_¡©s
(
pÜt_des
 *
pÜts
);

461 
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
);

463 
´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
);

466 *
£nd_pkts_to_içû
();

467 *
»ûive_pkts_äom_içû
();

469 
N‘m­U£
();

470 ~
N‘m­U£
();

473 
N‘m­U£
 
Ãtm­u£
;

	@include/netmap_user.h

65 #iâdeà
_NET_NETMAP_USER_H_


66 
	#_NET_NETMAP_USER_H_


	)

68 
	#NETMAP_DEVICE_NAME
 "/dev/Ãtm­"

	)

69 #ifdeà
__CYGWIN__


74 #iâdeà
_WIN32


75 
	#_WIN32


	)

80 #ifdeà
_WIN32


81 #undeà
NETMAP_DEVICE_NAME


82 
	#NETMAP_DEVICE_NAME
 "/´oc/sys/DosDeviûs/Glob®/Ãtm­"

	)

83 
	~<wšdows.h
>

84 
	~<WšDef.h
>

85 
	~<sys/cygwš.h
>

91 
	~<¡dšt.h
>

92 
	~<sys/sock‘.h
>

93 
	~<Ãt/if.h
>

95 #iâdeà
lik–y


96 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

97 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

100 
	~"Ãtm­.h
"

103 
	#_NETMAP_OFFSET
(
ty³
, 
±r
, 
off£t
) \

104 ((
ty³
)(*)((*)(
±r
è+ (
off£t
)))

	)

106 
	#NETMAP_IF
(
_ba£
, 
_ofs
è
	`_NETMAP_OFFSET
(
Ãtm­_if
 *, _ba£, _ofs)

	)

108 
	#NETMAP_TXRING
(
niå
, 
šdex
è
	`_NETMAP_OFFSET
(
Ãtm­_ršg
 *, \

109 
niå
, (niå)->
ršg_ofs
[
šdex
] )

	)

111 
	#NETMAP_RXRING
(
niå
, 
šdex
è
	`_NETMAP_OFFSET
(
Ãtm­_ršg
 *, \

112 
niå
, (niå)->
ršg_ofs
[
šdex
 + (niå)->
ni_tx_ršgs
 + 1] )

	)

114 
	#NETMAP_BUF
(
ršg
, 
šdex
) \

115 ((*)(
ršg
è+ (ršg)->
buf_ofs
 + ((
šdex
)*Ôšg)->
Ä_buf_size
))

	)

117 
	#NETMAP_BUF_IDX
(
ršg
, 
buf
) \

118 Ğ((*)(
buf
è- ((*)(
ršg
è+ (ršg)->
buf_ofs
) ) / \

119 (
ršg
)->
Ä_buf_size
 )

	)

122 
šlše
 
ušt32_t


123 
	$nm_ršg_Ãxt
(
Ãtm­_ršg
 *
r
, 
ušt32_t
 
i
)

125  ( 
	`uÆik–y
(
i
 + 1 =ğ
r
->
num_¦Ùs
) ? 0 : i + 1);

126 
	}
}

133 
šlše
 

134 
	$nm_tx_³ndšg
(
Ãtm­_ršg
 *
r
)

136  
	`nm_ršg_Ãxt
(
r
,„->

è!ğr->
h—d
;

137 
	}
}

140 
šlše
 
ušt32_t


141 
	$nm_ršg_¥aû
(
Ãtm­_ršg
 *
ršg
)

143 
»t
 = 
ršg
->

 -„šg->
cur
;

144 ià(
»t
 < 0)

145 
»t
 +ğ
ršg
->
num_¦Ùs
;

146  
»t
;

147 
	}
}

150 #ifdeà
NETMAP_WITH_LIBS


156 #iâdeà
HAVE_NETMAP_WITH_LIBS


157 
	#HAVE_NETMAP_WITH_LIBS


	)

159 
	~<¡dio.h
>

160 
	~<sys/time.h
>

161 
	~<sys/mmª.h
>

162 
	~<¡ršg.h
>

163 
	~<sys/ioùl.h
>

164 
	~<sys/”ºo.h
>

165 
	~<fú.h
>

166 
	~<uni¡d.h
>

167 
	~<sigÇl.h
>

168 
	~<¡dlib.h
>

170 #iâdeà
ND


172 
	#ND
(
_fmt
, ...èdØ{} 0)

	)

173 
	#D
(
_fmt
, ...) \

175 
timev®
 
_t0
; \

176 
	`g‘timeofday
(&
_t0
, 
NULL
); \

177 
	`årštf
(
¡d”r
, "%03d.%06d % [%d] " 
_fmt
 "\n", \

178 ()(
_t0
.
tv_£c
 % 1000), ()_t0.
tv_u£c
, \

179 
__FUNCTION__
, 
__LINE__
, ##
__VA_ARGS__
); \

180 } 0)

	)

183 
	#RD
(
Ís
, 
fÜm©
, ...) \

185 
__t0
, 
__út
; \

186 
timev®
 
__xxts
; \

187 
	`g‘timeofday
(&
__xxts
, 
NULL
); \

188 ià(
__t0
 !ğ
__xxts
.
tv_£c
) { \

189 
__t0
 = 
__xxts
.
tv_£c
; \

190 
__út
 = 0; \

192 ià(
__út
++ < 
Ís
) { \

193 
	`D
(
fÜm©
, ##
__VA_ARGS__
); \

195 } 0)

	)

198 
	snm_pkthdr
 {

199 
timev®
 
	mts
;

200 
ušt32_t
 
	mÿ¶’
;

201 
ušt32_t
 
	mËn
;

204 
	snm_¡©
 {

205 
u_št
 
	mps_»cv
;

206 
u_št
 
	mps_drİ
;

207 
u_št
 
	mps_ifdrİ
;

208 #ifdeà
WIN32


209 
u_št
 
	mbs_ÿ±
;

213 
	#NM_ERRBUF_SIZE
 512

	)

215 
	snm_desc
 {

216 
nm_desc
 *
	m£lf
;

217 
	mfd
;

218 *
	mmem
;

219 
ušt32_t
 
	mmemsize
;

220 
	mdÚe_mm­
;

221 
Ãtm­_if
 * cÚ¡ 
	mniå
;

222 
ušt16_t
 
	mfœ¡_tx_ršg
, 
	mÏ¡_tx_ršg
, 
	mcur_tx_ršg
;

223 
ušt16_t
 
	mfœ¡_rx_ršg
, 
	mÏ¡_rx_ršg
, 
	mcur_rx_ršg
;

224 
nm»q
 
	m»q
;

225 
nm_pkthdr
 
	mhdr
;

235 
Ãtm­_ršg
 * cÚ¡ 
	msome_ršg
;

236 * cÚ¡ 
	mbuf_¡¬t
;

237 * cÚ¡ 
	mbuf_’d
;

239 
	m¢­Ën
;

240 
	m´omisc
;

241 
	mto_ms
;

242 *
	m”rbuf
;

245 
ušt32_t
 
	mif_æags
;

246 
ušt32_t
 
	mif_»qÿp
;

247 
ušt32_t
 
	mif_curÿp
;

249 
nm_¡©
 
	m¡
;

250 
	mmsg
[
NM_ERRBUF_SIZE
];

257 
	#P2NMD
(
p
è((
nm_desc
 *)Õ))

	)

258 
	#IS_NETMAP_DESC
(
d
è((dè&& 
	`P2NMD
(d)->
£lf
 =ğP2NMD(d))

	)

259 
	#NETMAP_FD
(
d
è(
	`P2NMD
(d)->
fd
)

	)

270 
šlše
 

271 
	$nm_pkt_cİy
(cÚ¡ *
_¤c
, *
_d¡
, 
l
)

273 cÚ¡ 
ušt64_t
 *
¤c
 = (cÚ¡ ušt64_ˆ*)
_¤c
;

274 
ušt64_t
 *
d¡
 = (ušt64_ˆ*)
_d¡
;

276 ià(
	`uÆik–y
(
l
 >= 1024)) {

277 
	`memıy
(
d¡
, 
¤c
, 
l
);

280 ; 
	`lik–y
(
l
 > 0);†-=64) {

281 *
d¡
++ = *
¤c
++;

282 *
d¡
++ = *
¤c
++;

283 *
d¡
++ = *
¤c
++;

284 *
d¡
++ = *
¤c
++;

285 *
d¡
++ = *
¤c
++;

286 *
d¡
++ = *
¤c
++;

287 *
d¡
++ = *
¤c
++;

288 *
d¡
++ = *
¤c
++;

290 
	}
}

296 (*
	tnm_cb_t
)(
	tu_ch¬
 *, cÚ¡ 
	tnm_pkthdr
 *, cÚ¡ u_ch¬ *
	td
);

329 
nm_desc
 *
	`nm_İ’
(cÚ¡ *
iâame
, cÚ¡ 
nm»q
 *
»q
,

330 
ušt64_t
 
æags
, cÚ¡ 
nm_desc
 *
¬g
);

341 
NM_OPEN_NO_MMAP
 = 0x040000,

342 
NM_OPEN_IFNAME
 = 0x080000,

343 
NM_OPEN_ARG1
 = 0x100000,

344 
NM_OPEN_ARG2
 = 0x200000,

345 
NM_OPEN_ARG3
 = 0x400000,

346 
NM_OPEN_RING_CFG
 = 0x800000,

354 
	`nm_şo£
(
nm_desc
 *);

361 
	`nm_mm­
(
nm_desc
 *, const nm_desc *);

369 
	`nm_šjeù
(
nm_desc
 *, cÚ¡ *, 
size_t
);

370 
	`nm_di¥©ch
(
nm_desc
 *, , 
nm_cb_t
, 
u_ch¬
 *);

371 
u_ch¬
 *
	`nm_Ãxkt
(
nm_desc
 *, 
nm_pkthdr
 *);

373 #ifdeà
_WIN32


375 
šŒ_t
 
	`_g‘_osfhªdË
();

382 
	swš_Ãtm­_fd_li¡
 {

383 
wš_Ãtm­_fd_li¡
 *
Ãxt
;

384 
wš_Ãtm­_fd
;

385 
HANDLE
 
wš_Ãtm­_hªdË
;

392 
wš_Ãtm­_fd_li¡
 *
wš_Ãtm­_fd_li¡_h—d
;

395 
	$wš_š£¹_fd_»cÜd
(
fd
)

397 
wš_Ãtm­_fd_li¡
 *
cu¼
;

399 
cu¼
 = 
wš_Ãtm­_fd_li¡_h—d
; cu¼; cu¼ = cu¼->
Ãxt
) {

400 ià(
fd
 =ğ
cu¼
->
wš_Ãtm­_fd
) {

404 
cu¼
 = 
	`ÿÎoc
(1, (*curr));

405 
cu¼
->
Ãxt
 = 
wš_Ãtm­_fd_li¡_h—d
;

406 
cu¼
->
wš_Ãtm­_fd
 = 
fd
;

407 
cu¼
->
wš_Ãtm­_hªdË
 = 
	`IÁToPŒ
(
	`_g‘_osfhªdË
(
fd
));

408 
wš_Ãtm­_fd_li¡_h—d
 = 
cu¼
;

409 
	}
}

412 
	$wš_»move_fd_»cÜd
(
fd
)

414 
wš_Ãtm­_fd_li¡
 *
cu¼
 = 
wš_Ãtm­_fd_li¡_h—d
;

415 
wš_Ãtm­_fd_li¡
 *
´ev
 = 
NULL
;

416 ; 
cu¼
 ; 
´ev
 = cu¼, cu¼ = cu¼->
Ãxt
) {

417 ià(
fd
 !ğ
cu¼
->
wš_Ãtm­_fd
)

420 ià(
´ev
 =ğ
NULL
) {

421 
wš_Ãtm­_fd_li¡_h—d
 = 
cu¼
->
Ãxt
;

423 
´ev
->
Ãxt
 = 
cu¼
->next;

425 
	`ä“
(
cu¼
);

428 
	}
}

431 
HANDLE


432 
	$wš_g‘_Ãtm­_hªdË
(
fd
)

434 
wš_Ãtm­_fd_li¡
 *
cu¼
;

436 
cu¼
 = 
wš_Ãtm­_fd_li¡_h—d
; cu¼; cu¼ = cu¼->
Ãxt
) {

437 ià(
fd
 =ğ
cu¼
->
wš_Ãtm­_fd
) {

438  
cu¼
->
wš_Ãtm­_hªdË
;

441  
NULL
;

442 
	}
}

453 
	$wš_nm_ioùl_š‹º®
(
HANDLE
 
h
, 
št32_t
 
ùlCode
, *
¬g
)

455 
DWORD
 
bR‘uº
 = 0, 
szIn
, 
szOut
;

456 
BOOL
 
ioùlR‘uºStus
;

457 *
šP¬am
 = 
¬g
, *
outP¬am
 =‡rg;

459 
ùlCode
) {

460 
NETMAP_POLL
:

461 
szIn
 = (
POLL_REQUEST_DATA
);

462 
szOut
 = (
POLL_REQUEST_DATA
);

464 
NETMAP_MMAP
:

465 
szIn
 = 0;

466 
szOut
 = (*);

467 
šP¬am
 = 
NULL
;

469 
NIOCTXSYNC
:

470 
NIOCRXSYNC
:

471 
szIn
 = 0;

472 
szOut
 = 0;

474 
NIOCREGIF
:

475 
szIn
 = (
nm»q
);

476 
szOut
 = (
nm»q
);

478 
NIOCCONFIG
:

479 
	`D
("unsupported NIOCCONFIG!");

483 
	`D
("šv®id ioùÈ%x oÀÃtm­ fd", 
ùlCode
);

487 
ioùlR‘uºStus
 = 
	`DeviûIoCÚŒŞ
(
h
,

488 
ùlCode
, 
šP¬am
, 
szIn
,

489 
outP¬am
, 
szOut
,

490 &
bR‘uº
, 
NULL
);

493  
ioùlR‘uºStus
 ? 0 : -1;

494 
	}
}

501 
	$wš_nm_ioùl
(
fd
, 
št32_t
 
ùlCode
, *
¬g
)

503 
HANDLE
 
h
 = 
	`wš_g‘_Ãtm­_hªdË
(
fd
);

505 ià(
h
 =ğ
NULL
) {

506  
	`ioùl
(
fd
, 
ùlCode
, 
¬g
);

508  
	`wš_nm_ioùl_š‹º®
(
h
, 
ùlCode
, 
¬g
);

510 
	}
}

512 
	#ioùl
 
wš_nm_ioùl


	)

520 
	$wš32_mm­_emuÏ‹d
(*
addr
, 
size_t
 
Ëngth
, 
´Ù
, 
æags
, 
fd
, 
št32_t
 
off£t
)

522 
HANDLE
 
h
 = 
	`wš_g‘_Ãtm­_hªdË
(
fd
);

524 ià(
h
 =ğ
NULL
) {

525  
	`mm­
(
addr
, 
Ëngth
, 
´Ù
, 
æags
, 
fd
, 
off£t
);

527 
MEMORY_ENTRY
 
»t
;

529  
	`wš_nm_ioùl_š‹º®
(
h
, 
NETMAP_MMAP
, &
»t
) ?

530 
NULL
 : 
»t
.
pU£rmodeVœtu®Add»ss
;

532 
	}
}

534 
	#mm­
 
wš32_mm­_emuÏ‹d


	)

536 
	~<sys/pŞl.h
>

539 
	$wš_nm_pŞl
(
pŞlfd
 *
fds
, 
nfds
, 
timeout
)

541 
HANDLE
 
h
;

543 ià(
nfds
 !ğ1 || 
fds
 =ğ
NULL
 || (
h
 = 
	`wš_g‘_Ãtm­_hªdË
(fds->
fd
)) == NULL) {;

544  
	`pŞl
(
fds
, 
nfds
, 
timeout
);

546 
POLL_REQUEST_DATA
 
´d
;

548 
´d
.
timeout
 =imeout;

549 
´d
.
ev’ts
 = 
fds
->events;

551 
	`wš_nm_ioùl_š‹º®
(
h
, 
NETMAP_POLL
, &
´d
);

552 ià((
´d
.
»v’ts
 =ğ
POLLERR
è|| (´d.»v’t =ğ
STATUS_TIMEOUT
)) {

557 
	}
}

559 
	#pŞl
 
wš_nm_pŞl


	)

562 
	$wš_nm_İ’
(* 
·thÇme
, 
æags
){

564 ià(
	`¡rcmp
(
·thÇme
, 
NETMAP_DEVICE_NAME
) == 0){

565 
fd
 = 
	`İ’
(
NETMAP_DEVICE_NAME
, 
O_RDWR
);

566 ià(
fd
 < 0) {

570 
	`wš_š£¹_fd_»cÜd
(
fd
);

571  
fd
;

575  
	`İ’
(
·thÇme
, 
æags
);

577 
	}
}

579 
	#İ’
 
wš_nm_İ’


	)

582 
	$wš_nm_şo£
(
fd
){

583 ià(
fd
 != -1){

584 
	`şo£
(
fd
);

585 ià(
	`wš_g‘_Ãtm­_hªdË
(
fd
è!ğ
NULL
){

586 
	`wš_»move_fd_»cÜd
(
fd
);

590 
	}
}

592 
	#şo£
 
wš_nm_şo£


	)

607 
nm_desc
 *

608 
	$nm_İ’
(cÚ¡ *
iâame
, cÚ¡ 
nm»q
 *
»q
,

609 
ušt64_t
 
Ãw_æags
, cÚ¡ 
nm_desc
 *
¬g
)

611 
nm_desc
 *
d
 = 
NULL
;

612 cÚ¡ 
nm_desc
 *
·»Á
 = 
¬g
;

613 
u_št
 
Çm–’
;

614 
ušt32_t
 
Ä_ršgid
 = 0, 
Ä_æags
, 
Ä_»g
;

615 cÚ¡ *
pÜt
 = 
NULL
;

616 
	#MAXERRMSG
 80

	)

617 
”rmsg
[
MAXERRMSG
] = "";

618 ’um { 
P_START
, 
P_RNGSFXOK
, 
P_GETNUM
, 
P_FLAGS
, 
P_FLAGSOK
 } 
p_¡©e
;

619 
num
;

621 ià(
	`¡ºcmp
(
iâame
, "netmap:", 7) && strncmp(ifname, "vale", 4)) {

622 
”ºo
 = 0;

623  
NULL
;

625 ià(
iâame
[0] == 'n')

626 
iâame
 += 7;

628 
pÜt
 = 
iâame
; *pÜˆ&& !
	`šdex
("-*^{}/", *port);…ort++)

630 
Çm–’
 = 
pÜt
 - 
iâame
;

631 ià(
Çm–’
 >ğ(
d
->
»q
.
Ä_Çme
)) {

632 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "nameoo†ong");

633 
ç
;

635 
p_¡©e
 = 
P_START
;

636 
Ä_æags
 = 
NR_REG_ALL_NIC
;

637 *
pÜt
) {

638 
p_¡©e
) {

639 
P_START
:

640 *
pÜt
) {

642 
Ä_æags
 = 
NR_REG_SW
;

643 
p_¡©e
 = 
P_RNGSFXOK
;

646 
Ä_æags
 = 
NR_REG_NIC_SW
;

647 
p_¡©e
 = 
P_RNGSFXOK
;

650 
Ä_æags
 = 
NR_REG_ONE_NIC
;

651 
p_¡©e
 = 
P_GETNUM
;

654 
Ä_æags
 = 
NR_REG_PIPE_MASTER
;

655 
p_¡©e
 = 
P_GETNUM
;

658 
Ä_æags
 = 
NR_REG_PIPE_SLAVE
;

659 
p_¡©e
 = 
P_GETNUM
;

662 
p_¡©e
 = 
P_FLAGS
;

665 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "unknowÀmodif›r: '%c'", *
pÜt
);

666 
ç
;

668 
pÜt
++;

670 
P_RNGSFXOK
:

671 *
pÜt
) {

673 
p_¡©e
 = 
P_FLAGS
;

676 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "uÃx³ùed ch¬aù”: '%c'", *
pÜt
);

677 
ç
;

679 
pÜt
++;

681 
P_GETNUM
:

682 
num
 = 
	`¡¹Ş
(
pÜt
, (**)&port, 10);

683 ià(
num
 < 0 ||‚um >ğ
NETMAP_RING_MASK
) {

684 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "'%ld' out of„ange [0, %d)",

685 
num
, 
NETMAP_RING_MASK
);

686 
ç
;

688 
Ä_ršgid
 = 
num
 & 
NETMAP_RING_MASK
;

689 
p_¡©e
 = 
P_RNGSFXOK
;

691 
P_FLAGS
:

692 
P_FLAGSOK
:

693 *
pÜt
) {

695 
Ä_æags
 |ğ
NR_EXCLUSIVE
;

698 
Ä_æags
 |ğ
NR_ZCOPY_MON
;

701 
Ä_æags
 |ğ
NR_MONITOR_TX
;

704 
Ä_æags
 |ğ
NR_MONITOR_RX
;

707 
Ä_æags
 |ğ
NR_RX_RINGS_ONLY
;

710 
Ä_æags
 |ğ
NR_TX_RINGS_ONLY
;

713 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "uÄecognized fÏg: '%c'", *
pÜt
);

714 
ç
;

716 
pÜt
++;

717 
p_¡©e
 = 
P_FLAGSOK
;

721 ià(
p_¡©e
 !ğ
P_START
 &&…_¡©!ğ
P_RNGSFXOK
 &&…_¡©!ğ
P_FLAGSOK
) {

722 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "unexpectedƒnd of…ort‚ame");

723 
ç
;

725 
	`ND
("flags: %s %s %s %s",

726 (
Ä_æags
 & 
NR_EXCLUSIVE
) ? "EXCLUSIVE" : "",

727 (
Ä_æags
 & 
NR_ZCOPY_MON
) ? "ZCOPY_MON" : "",

728 (
Ä_æags
 & 
NR_MONITOR_TX
) ? "MONITOR_TX" : "",

729 (
Ä_æags
 & 
NR_MONITOR_RX
) ? "MONITOR_RX" : "");

730 
d
 = (
nm_desc
 *)
	`ÿÎoc
(1, (*d));

731 ià(
d
 =ğ
NULL
) {

732 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "nm_desc‡lloc failure");

733 
”ºo
 = 
ENOMEM
;

734  
NULL
;

736 
d
->
£lf
 = d;

737 
d
->
fd
 = 
	`İ’
(
NETMAP_DEVICE_NAME
, 
O_RDWR
);

738 ià(
d
->
fd
 < 0) {

739 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "ÿÂÙ o³À/dev/Ãtm­: %s", 
	`¡»¼Ü
(
”ºo
));

740 
ç
;

743 ià(
»q
)

744 
d
->
»q
 = *req;

745 
d
->
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

746 
d
->
»q
.
Ä_ršgid
 &ğ~
NETMAP_RING_MASK
;

749 
d
->
»q
.
Ä_ršgid
 |=‚r_ringid;

750 
d
->
»q
.
Ä_æags
 |=‚r_flags;

751 
	`memıy
(
d
->
»q
.
Ä_Çme
, 
iâame
, 
Çm–’
);

752 
d
->
»q
.
Ä_Çme
[
Çm–’
] = '\0';

754 ià(
	`IS_NETMAP_DESC
(
·»Á
è&& 
Ãw_æags
) {

755 ià(
Ãw_æags
 & 
NM_OPEN_ARG1
)

756 
	`D
("ov”ridšg ARG1 %d", 
·»Á
->
»q
.
Ä_¬g1
);

757 
d
->
»q
.
Ä_¬g1
 = 
Ãw_æags
 & 
NM_OPEN_ARG1
 ?

758 
·»Á
->
»q
.
Ä_¬g1
 : 4;

759 ià(
Ãw_æags
 & 
NM_OPEN_ARG2
)

760 
	`D
("ov”ridšg ARG2 %d", 
·»Á
->
»q
.
Ä_¬g2
);

761 
d
->
»q
.
Ä_¬g2
 = 
Ãw_æags
 & 
NM_OPEN_ARG2
 ?

762 
·»Á
->
»q
.
Ä_¬g2
 : 0;

763 ià(
Ãw_æags
 & 
NM_OPEN_ARG3
)

764 
	`D
("ov”ridšg ARG3 %d", 
·»Á
->
»q
.
Ä_¬g3
);

765 
d
->
»q
.
Ä_¬g3
 = 
Ãw_æags
 & 
NM_OPEN_ARG3
 ?

766 
·»Á
->
»q
.
Ä_¬g3
 : 0;

767 ià(
Ãw_æags
 & 
NM_OPEN_RING_CFG
) {

768 
	`D
("overriding RING_CFG");

769 
d
->
»q
.
Ä_tx_¦Ùs
 = 
·»Á
->req.nr_tx_slots;

770 
d
->
»q
.
Ä_rx_¦Ùs
 = 
·»Á
->req.nr_rx_slots;

771 
d
->
»q
.
Ä_tx_ršgs
 = 
·»Á
->req.nr_tx_rings;

772 
d
->
»q
.
Ä_rx_ršgs
 = 
·»Á
->req.nr_rx_rings;

774 ià(
Ãw_æags
 & 
NM_OPEN_IFNAME
) {

775 
	`D
("overriding ifname %s„ingid 0x%x flags 0x%x",

776 
·»Á
->
»q
.
Ä_Çme
,…¬’t->»q.
Ä_ršgid
,

777 
·»Á
->
»q
.
Ä_æags
);

778 
	`memıy
(
d
->
»q
.
Ä_Çme
, 
·»Á
->req.nr_name,

779 (
d
->
»q
.
Ä_Çme
));

780 
d
->
»q
.
Ä_ršgid
 = 
·»Á
->req.nr_ringid;

781 
d
->
»q
.
Ä_æags
 = 
·»Á
->req.nr_flags;

785 
d
->
»q
.
Ä_ršgid
 |ğ
Ãw_æags
 & (
NETMAP_NO_TX_POLL
 | 
NETMAP_DO_RX_POLL
);

787 ià(
	`ioùl
(
d
->
fd
, 
NIOCREGIF
, &d->
»q
)) {

788 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "NIOCREGIF faed: %s", 
	`¡»¼Ü
(
”ºo
));

789 
ç
;

793 ià((!(
Ãw_æags
 & 
NM_OPEN_NO_MMAP
è|| 
·»Á
è&& 
	`nm_mm­
(
d
,…arent)) {

794 
	`¢´štf
(
”rmsg
, 
MAXERRMSG
, "mm­ faed: %s", 
	`¡»¼Ü
(
”ºo
));

795 
ç
;

798 
Ä_»g
 = 
d
->
»q
.
Ä_æags
 & 
NR_REG_MASK
;

800 ià(
Ä_»g
 =ğ
NR_REG_SW
) {

801 
d
->
fœ¡_tx_ršg
 = d->
Ï¡_tx_ršg
 = d->
»q
.
Ä_tx_ršgs
;

802 
d
->
fœ¡_rx_ršg
 = d->
Ï¡_rx_ršg
 = d->
»q
.
Ä_rx_ršgs
;

803 } ià(
Ä_»g
 =ğ
NR_REG_ALL_NIC
) {

804 
d
->
fœ¡_tx_ršg
 = 0;

805 
d
->
fœ¡_rx_ršg
 = 0;

806 
d
->
Ï¡_tx_ršg
 = d->
»q
.
Ä_tx_ršgs
 - 1;

807 
d
->
Ï¡_rx_ršg
 = d->
»q
.
Ä_rx_ršgs
 - 1;

808 } ià(
Ä_»g
 =ğ
NR_REG_NIC_SW
) {

809 
d
->
fœ¡_tx_ršg
 = 0;

810 
d
->
fœ¡_rx_ršg
 = 0;

811 
d
->
Ï¡_tx_ršg
 = d->
»q
.
Ä_tx_ršgs
;

812 
d
->
Ï¡_rx_ršg
 = d->
»q
.
Ä_rx_ršgs
;

813 } ià(
Ä_»g
 =ğ
NR_REG_ONE_NIC
) {

815 
d
->
fœ¡_tx_ršg
 = d->
Ï¡_tx_ršg
 =

816 
d
->
fœ¡_rx_ršg
 = d->
Ï¡_rx_ršg
 = d->
»q
.
Ä_ršgid
 & 
NETMAP_RING_MASK
;

818 
d
->
fœ¡_tx_ršg
 = d->
Ï¡_tx_ršg
 = 0;

819 
d
->
fœ¡_rx_ršg
 = d->
Ï¡_rx_ršg
 = 0;

822 #ifdeà
DEBUG_NETMAP_USER


824 
i
;

826 
	`D
("% tx %d .. %d %d„x %d .. %d %d", 
iâame
,

827 
d
->
fœ¡_tx_ršg
, d->
Ï¡_tx_ršg
, d->
»q
.
Ä_tx_ršgs
,

828 
d
->
fœ¡_rx_ršg
, d->
Ï¡_rx_ršg
, d->
»q
.
Ä_rx_ršgs
);

829 
i
 = 0; i <ğ
d
->
»q
.
Ä_tx_ršgs
; i++) {

830 
Ãtm­_ršg
 *
r
 = 
	`NETMAP_TXRING
(
d
->
niå
, 
i
);

831 
	`D
("TX%d %°h %d c %d %d", 
i
, 
r
,„->
h—d
,„->
cur
,„->

);

833 
i
 = 0; i <ğ
d
->
»q
.
Ä_rx_ršgs
; i++) {

834 
Ãtm­_ršg
 *
r
 = 
	`NETMAP_RXRING
(
d
->
niå
, 
i
);

835 
	`D
("RX%d %°h %d c %d %d", 
i
, 
r
,„->
h—d
,„->
cur
,„->

);

840 
d
->
cur_tx_ršg
 = d->
fœ¡_tx_ršg
;

841 
d
->
cur_rx_ršg
 = d->
fœ¡_rx_ršg
;

842  
d
;

844 
ç
:

845 
	`nm_şo£
(
d
);

846 ià(
”rmsg
[0])

847 
	`D
("% %s", 
”rmsg
, 
iâame
);

848 ià(
”ºo
 == 0)

849 
”ºo
 = 
EINVAL
;

850  
NULL
;

851 
	}
}

855 
	$nm_şo£
(
nm_desc
 *
d
)

860 *
__xxzt
[] 
	`__©Œibu‹__
 ((
unu£d
)) =

861 { (*)
nm_İ’
, (*)
nm_šjeù
,

862 (*)
nm_di¥©ch
, (*)
nm_Ãxkt
 } ;

864 ià(
d
 =ğ
NULL
 || d->
£lf
 != d)

865  
EINVAL
;

866 ià(
d
->
dÚe_mm­
 && d->
mem
)

867 
	`munm­
(
d
->
mem
, d->
memsize
);

868 ià(
d
->
fd
 != -1){

869 
	`şo£
(
d
->
fd
);

872 
	`bz”o
(
d
, (*d));

873 
	`ä“
(
d
);

875 
	}
}

879 
	$nm_mm­
(
nm_desc
 *
d
, cÚ¡ nm_desø*
·»Á
)

883 ià(
	`IS_NETMAP_DESC
(
·»Á
è&&…¬’t->
mem
 &&

884 
·»Á
->
»q
.
Ä_¬g2
 =ğ
d
->req.nr_arg2) {

886 
	`D
("do‚ot mmap, inherit from…arent");

887 
d
->
memsize
 = 
·»Á
->memsize;

888 
d
->
mem
 = 
·»Á
->mem;

891 
d
->
memsize
 = d->
»q
.
Ä_memsize
;

892 
d
->
mem
 = 
	`mm­
(0, d->
memsize
, 
PROT_WRITE
 | 
PROT_READ
, 
MAP_SHARED
,

893 
d
->
fd
, 0);

894 ià(
d
->
mem
 =ğ
MAP_FAILED
) {

895 
ç
;

897 
d
->
dÚe_mm­
 = 1;

900 
Ãtm­_if
 *
niå
 = 
	`NETMAP_IF
(
d
->
mem
, d->
»q
.
Ä_off£t
);

901 
Ãtm­_ršg
 *
r
 = 
	`NETMAP_RXRING
(
niå
, );

903 *(
Ãtm­_if
 **)(
ušŒ_t
)&(
d
->
niå
) =‚ifp;

904 *(
Ãtm­_ršg
 **)(
ušŒ_t
)&
d
->
some_ršg
 = 
r
;

905 *(**)(
ušŒ_t
)&
d
->
buf_¡¬t
 = 
	`NETMAP_BUF
(
r
, 0);

906 *(**)(
ušŒ_t
)&
d
->
buf_’d
 =

907 (*)
d
->
mem
 + d->
memsize
;

912 
ç
:

913  
EINVAL
;

914 
	}
}

920 
	$nm_šjeù
(
nm_desc
 *
d
, cÚ¡ *
buf
, 
size_t
 
size
)

922 
u_št
 
c
, 
n
 = 
d
->
Ï¡_tx_ršg
 - d->
fœ¡_tx_ršg
 + 1;

924 
c
 = 0; c < 
n
 ; c++) {

926 
Ãtm­_ršg
 *
ršg
;

927 
ušt32_t
 
i
, 
idx
;

928 
ušt32_t
 
ri
 = 
d
->
cur_tx_ršg
 + 
c
;

930 ià(
ri
 > 
d
->
Ï¡_tx_ršg
)

931 
ri
 = 
d
->
fœ¡_tx_ršg
;

932 
ršg
 = 
	`NETMAP_TXRING
(
d
->
niå
, 
ri
);

933 ià(
	`nm_ršg_em±y
(
ršg
)) {

936 
i
 = 
ršg
->
cur
;

937 
idx
 = 
ršg
->
¦Ù
[
i
].
buf_idx
;

938 
ršg
->
¦Ù
[
i
].
Ën
 = 
size
;

939 
	`nm_pkt_cİy
(
buf
, 
	`NETMAP_BUF
(
ršg
, 
idx
), 
size
);

940 
d
->
cur_tx_ršg
 = 
ri
;

941 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
Ôšg, 
i
);

942  
size
;

945 
	}
}

952 
	$nm_di¥©ch
(
nm_desc
 *
d
, 
út
, 
nm_cb_t
 
cb
, 
u_ch¬
 *
¬g
)

954 
n
 = 
d
->
Ï¡_rx_ršg
 - d->
fœ¡_rx_ršg
 + 1;

955 
c
, 
gÙ
 = 0, 
ri
 = 
d
->
cur_rx_ršg
;

957 ià(
út
 == 0)

958 
út
 = -1;

963 
c
=0; c < 
n
 && 
út
 !ğ
gÙ
; c++) {

965 
Ãtm­_ršg
 *
ršg
;

967 
ri
 = 
d
->
cur_rx_ršg
 + 
c
;

968 ià(
ri
 > 
d
->
Ï¡_rx_ršg
)

969 
ri
 = 
d
->
fœ¡_rx_ršg
;

970 
ršg
 = 
	`NETMAP_RXRING
(
d
->
niå
, 
ri
);

971  ; !
	`nm_ršg_em±y
(
ršg
è&& 
út
 !ğ
gÙ
; got++) {

972 
u_št
 
i
 = 
ršg
->
cur
;

973 
u_št
 
idx
 = 
ršg
->
¦Ù
[
i
].
buf_idx
;

974 
u_ch¬
 *
buf
 = (u_ch¬ *)
	`NETMAP_BUF
(
ršg
, 
idx
);

977 
d
->
hdr
.
Ën
 = d->hdr.
ÿ¶’
 = 
ršg
->
¦Ù
[
i
].len;

978 
d
->
hdr
.
ts
 = 
ršg
->ts;

979 
	`cb
(
¬g
, &
d
->
hdr
, 
buf
);

980 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
Ôšg, 
i
);

983 
d
->
cur_rx_ršg
 = 
ri
;

984  
gÙ
;

985 
	}
}

987 
u_ch¬
 *

988 
	$nm_Ãxkt
(
nm_desc
 *
d
, 
nm_pkthdr
 *
hdr
)

990 
ri
 = 
d
->
cur_rx_ršg
;

994 
Ãtm­_ršg
 *
ršg
 = 
	`NETMAP_RXRING
(
d
->
niå
, 
ri
);

995 ià(!
	`nm_ršg_em±y
(
ršg
)) {

996 
u_št
 
i
 = 
ršg
->
cur
;

997 
u_št
 
idx
 = 
ršg
->
¦Ù
[
i
].
buf_idx
;

998 
u_ch¬
 *
buf
 = (u_ch¬ *)
	`NETMAP_BUF
(
ršg
, 
idx
);

1001 
hdr
->
ts
 = 
ršg
->ts;

1002 
hdr
->
Ën
 = hdr->
ÿ¶’
 = 
ršg
->
¦Ù
[
i
].len;

1003 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
Ôšg, 
i
);

1008 
ršg
->
h—d
 =„šg->
cur
;

1009 
d
->
cur_rx_ršg
 = 
ri
;

1010  
buf
;

1012 
ri
++;

1013 ià(
ri
 > 
d
->
Ï¡_rx_ršg
)

1014 
ri
 = 
d
->
fœ¡_rx_ršg
;

1015 } 
ri
 !ğ
d
->
cur_rx_ršg
);

1016  
NULL
;

1017 
	}
}

	@include/pipe.h

1 #iâdeà
__MTCP_PIPE_H_


2 
	#__MTCP_PIPE_H_


	)

4 
	~<mtı_­i.h
>

7 
PeR—d
(
mùx_t
 
mùx
, 
peid
, *
buf
, 
Ën
);

10 
PeWr™e
(
mùx_t
 
mùx
, 
peid
, cÚ¡ *
buf
, 
Ën
);

13 
Rai£P’dšgPeEv’ts
(
mùx_t
 
mùx
, 
•id
, 
peid
);

16 
PeClo£
(
mùx_t
 
mùx
, 
peid
);

	@include/ps.h

1 #iâdeà
_PS_H_


2 
	#_PS_H_


	)

4 
	#MAX_DEVICES
 16

	)

5 
	#MAX_RINGS
 64

	)

8 
	#PS_CTL_IN
 0x1

	)

9 
	#PS_CTL_OUT
 0x2

	)

11 
	#PS_CTL_INOUT
 (
PS_CTL_IN
 | 
PS_CTL_OUT
)

	)

14 
	#PS_SEND_AVAILABLE
 0x1

	)

15 
	#PS_RECEIVE_AVAILABLE
 0x2

	)

17 
	#PS_ALL_AVAILABLE
 (
PS_SEND_AVAILABLE
 | 
PS_RECEIVE_AVAILABLE
)

	)

19 
	#PS_SEND_MIN
 256

	)

21 #ifdeà
__KERNEL__


23 
	#PS_MAJOR
 1010

	)

24 
	#PS_NAME
 "·ck‘_shad”"

	)

26 
	#MAX_BUFS
 (12*4)

	)

28 
____ÿch–še_®igÃd
 
	gps_cÚ‹xt
 {

29 
£m­hÜe
 
	g£m
;

31 
wa™_queue_h—d_t
 
	gwq
;

33 
	gnum_©ched
;

34 
ixgbe_ršg
 *
	grx_ršgs
[
MAX_RINGS
];

35 
	gÃxt_ršg
;

37 
ps_pkt_šfo
 *
	gšfo
;

40 
	gnum_bufs
;

41 
	gbuf_»fút
[
MAX_BUFS
];

42 *
	gkbufs
[
MAX_BUFS
];

43 
__u£r
 *
	gubufs
[
MAX_BUFS
];

48 
	~<¡ršg.h
>

49 
	~<¡dšt.h
>

50 
	~<±h»ad.h
>

51 
	~<lšux/ty³s.h
>

53 
	#__u£r


	)

55 #iâdeà
IFNAMSIZ


56 
	#IFNAMSIZ
 16

	)

59 #iâdeà
ETH_ALEN


60 
	#ETH_ALEN
 6

	)

63 
	#ALIGN
(
x
,
a
è
	`__ALIGN_MASK
(x,(
	`ty³of
(x))×)-1)

	)

64 
	#__ALIGN_MASK
(
x
,
mask
è(((x)+(mask))&~(mask))

	)

66 
šlše
 
__sum16
 
	$_ç¡_csum
(cÚ¡ *
h
, 
ihl
)

68 
sum
;

70 
	`asm
(" movl (%1), %0\n"

90 : "ô" (
sum
), "ô" (
h
), "ô" (
ihl
)

91 : "1" (
h
), "2" (
ihl
)

93  (
__sum16
)
sum
;

94 
	}
}

98 
	sps_deviû
 {

99 
	mÇme
[
IFNAMSIZ
];

100 
	mdev_addr
[
ETH_ALEN
];

101 
ušt32_t
 
	m_addr
;

104 
	mifšdex
;

107 
	mkifšdex
;

109 
	mnum_rx_queues
;

110 
	mnum_tx_queues
;

113 
	sps_queue
 {

114 
	mifšdex
;

115 
	mqidx
;

118 
	#MAX_PACKET_SIZE
 2048

	)

119 
	#MAX_CHUNK_SIZE
 4096

	)

120 
	#ENTRY_CNT
 4096

	)

122 
	#PS_CHECKSUM_RX_UNKNOWN
 0

	)

123 
	#PS_CHECKSUM_RX_GOOD
 1

	)

124 
	#PS_CHECKSUM_RX_BAD
 2

	)

126 
	sps_pkt_šfo
 {

127 
ušt32_t
 
	moff£t
;

128 
ušt16_t
 
	mËn
;

129 
ušt8_t
 
	mchecksum_rx
;

132 
	sps_chunk
 {

134 
	mút
;

135 
	m»cv_blockšg
;

141 
ps_queue
 
	mqueue
;

143 
ps_pkt_šfo
 
__u£r
 *
	mšfo
;

144 
__u£r
 *
	mbuf
;

147 
	sps_chunk_buf
 {

149 
ušt16_t
 
	mút
;

150 
ušt16_t
 
	mÃxt_to_u£
;

151 
ušt16_t
 
	mÃxt_to_£nd
;

152 
ušt32_t
 
	mÃxt_off£t
;

154 
ps_queue
 
	mqueue
;

155 
__u£r
 *
	mlock
;

156 
ps_pkt_šfo
 
__u£r
 *
	mšfo
;

157 
__u£r
 *
	mbuf
;

160 
	sps_·ck‘
 {

161 
	mifšdex
;

162 
	mËn
;

163 
__u£r
 *
	mbuf
;

166 
	#NID_ZERO
(
i¥
è(i¥ = 0)

	)

167 
	#NID_SET
(
id
, 
i¥
è(i¥ |ğ1 << id)

	)

168 
	#NID_CLR
(
id
, 
i¥
è(i¥ &ğ~(1 << id))

	)

169 
	#NID_ISSET
(
id
, 
i¥
è(i¥ & (1 << id))

	)

172 
ušt16_t
 
	tnids_£t
;

173 
	sps_ev’t
 {

174 
	mtimeout
;

175 
	mqidx
;

177 
nids_£t
 
	mrx_nids
;

178 
nids_£t
 
	mtx_nids
;

181 
šlše
 
	$´eãtcht0
(*
p
)

183 
asm
 volatile("prefetcht0 (%0)\n\t"

185 : "r" (
p
)

187 
	}
}

189 
šlše
 
	$´eãtchÁa
(*
p
)

191 
asm
 volatile("prefetchnta (%0)\n\t"

193 : "r" (
p
)

195 
	}
}

197 
šlše
 
	$memıy_®igÃd
(*
to
, cÚ¡ *
äom
, 
size_t
 
Ën
)

199 ià(
Ën
 <= 64) {

200 
	`memıy
(
to
, 
äom
, 64);

201 } ià(
Ën
 <= 128) {

202 
	`memıy
(
to
, 
äom
, 64);

203 
	`memıy
((
ušt8_t
 *)
to
 + 64, (ušt8_ˆ*)
äom
 + 64, 64);

205 
size_t
 
off£t
;

207 
off£t
 = 0; off£ˆ< 
Ën
; offset += 64)

208 
	`memıy
((
ušt8_t
 *)
to
 + 
off£t
,

209 (
ušt8_t
 *)
äom
 + 
off£t
,

212 
	}
}

214 
	#PS_IOC_LIST_DEVICES
 0

	)

215 
	#PS_IOC_ATTACH_RX_DEVICE
 1

	)

216 
	#PS_IOC_DETACH_RX_DEVICE
 2

	)

217 
	#PS_IOC_RECV_CHUNK
 3

	)

218 
	#PS_IOC_SEND_CHUNK
 4

	)

219 
	#PS_IOC_SLOWPATH_PACKET
 5

	)

220 
	#PS_IOC_RECV_CHUNK_IFIDX
 6

	)

221 
	#PS_IOC_SEND_CHUNK_BUF
 7

	)

222 
	#PS_IOC_GET_TXENTRY
 8

	)

223 
	#PS_IOC_SELECT
 9

	)

225 #iâdeà
__KERNEL__


227 
	sps_hªdË
 {

228 
	mfd
;

230 
ušt64_t
 
	mrx_chunks
[
MAX_DEVICES
];

231 
ušt64_t
 
	mrx_·ck‘s
[
MAX_DEVICES
];

232 
ušt64_t
 
	mrx_by‹s
[
MAX_DEVICES
];

234 
ušt64_t
 
	mtx_chunks
[
MAX_DEVICES
];

235 
ušt64_t
 
	mtx_·ck‘s
[
MAX_DEVICES
];

236 
ušt64_t
 
	mtx_by‹s
[
MAX_DEVICES
];

238 *
	m´iv
;

241 
ps_li¡_deviûs
(
ps_deviû
 *
deviûs
);

242 
ps_š™_hªdË
(
ps_hªdË
 *
hªdË
);

243 
ps_şo£_hªdË
(
ps_hªdË
 *
hªdË
);

244 
ps_©ch_rx_deviû
(
ps_hªdË
 *
hªdË
, 
ps_queue
 *
queue
);

245 
ps_d‘ach_rx_deviû
(
ps_hªdË
 *
hªdË
, 
ps_queue
 *
queue
);

246 
ps_®loc_chunk
(
ps_hªdË
 *
hªdË
, 
ps_chunk
 *
chunk
);

247 
ps_ä“_chunk
(
ps_chunk
 *
chunk
);

248 
ps_®loc_chunk_buf
(
ps_hªdË
 *
hªdË
,

249 
ifidx
, 
qidx
, 
ps_chunk_buf
 *
c_buf
);

250 
ps_ä“_chunk_buf
(
ps_chunk_buf
 *
c_buf
);

251 * 
ps_assign_chunk_buf
(
ps_chunk_buf
 *
c_buf
, 
Ën
);

252 
ps_»cv_chunk
(
ps_hªdË
 *
hªdË
, 
ps_chunk
 *
chunk
);

253 
ps_»cv_chunk_ifidx
(
ps_hªdË
 *
hªdË
, 
ps_chunk
 *
chunk
, 
ifidx
);

254 
ps_£nd_chunk
(
ps_hªdË
 *
hªdË
, 
ps_chunk
 *
chunk
);

255 
ps_£nd_chunk_buf
(
ps_hªdË
 *
hªdË
, 
ps_chunk_buf
 *
chunk
);

256 
ps_£Ëù
(
ps_hªdË
 *
hªdË
, 
ps_ev’t
 * 
ev’t
);

257 
ps_g‘_tx’Œy
(
ps_hªdË
 *
hªdË
, 
ps_queue
 * 
queue
);

258 
ps_¦ow·th_·ck‘
(
ps_hªdË
 *
hªdË
, 
ps_·ck‘
 *
·ck‘
);

260 
dump_·ck‘
(*
buf
, 
Ën
);

261 
dump_chunk
(
ps_chunk
 *
chunk
);

263 
g‘_num_ıus
();

264 
bšd_ıu
(
ıu
);

265 
ušt64_t
 
rdtsc
();

	@include/rss.h

1 #iâdeà
__RSS_H_


2 
	#__RSS_H_


	)

4 
	~<Ãtš‘/š.h
>

7 
G‘RSSCPUCÜe
(
š_addr_t
 
s
, in_addr_ˆ
d
,

8 
š_pÜt_t
 
¥
, in_pÜt_ˆ
dp
, 
num_queues
,

9 
ušt8_t
 
’dŸn_check
);

	@include/socket.h

1 #iâdeà
__SOCKET_H_


2 
	#__SOCKET_H_


	)

4 
	~"mtı_­i.h
"

5 
	~"mtı_•Şl.h
"

8 
	esock‘_İts


10 
	mMTCP_NONBLOCK
 = 0x01,

11 
	mMTCP_ADDR_BIND
 = 0x02,

14 
	ssock‘_m­


16 
	mid
;

17 
	msockty³
;

18 
ušt32_t
 
	mİts
;

20 
sockaddr_š
 
	m§ddr
;

23 
tı_¡»am
 *
	m¡»am
;

24 
tı_li¡’”
 *
	mli¡’”
;

25 
mtı_•Şl
 *
	m•
;

26 
pe
 *
	mµ
;

29 
ušt32_t
 
	m•Şl
;

30 
ušt32_t
 
	mev’ts
;

31 
mtı_•Şl_d©a_t
 
	m•_d©a
;

33 
TAILQ_ENTRY
 (
sock‘_m­
è
	mä“_sm­_lšk
;

37 
sock‘_m­
 * 
	tsock‘_m­_t
;

39 
sock‘_m­_t


40 
AÎoÿ‹Sock‘
(
mùx_t
 
mùx
, 
sockty³
, 
Ãed_lock
);

43 
F»eSock‘
(
mùx_t
 
mùx
, 
sockid
, 
Ãed_lock
);

45 
sock‘_m­_t


46 
G‘Sock‘
(
mùx_t
 
mùx
, 
sockid
);

48 
	stı_li¡’”


50 
	msockid
;

51 
sock‘_m­_t
 
	msock‘
;

53 
	mbacklog
;

54 
¡»am_queue_t
 
	macû±q
;

56 
±h»ad_mu‹x_t
 
	macû±_lock
;

57 
±h»ad_cÚd_t
 
	macû±_cÚd
;

59 
TAILQ_ENTRY
(
tı_li¡’”
è
	mhe_lšk
;

	@include/stat.h

1 #iâdeà
__STAT_H_


2 
	#__STAT_H_


	)

4 
	srun_¡©


6 
ušt64_t
 
	mrounds
;

7 
ušt64_t
 
	mrounds_rx
;

8 
ušt64_t
 
	mrounds_rx_Œy
;

9 
ušt64_t
 
	mrounds_tx
;

10 
ušt64_t
 
	mrounds_tx_Œy
;

11 
ušt64_t
 
	mrounds_£Ëù
;

12 
ušt64_t
 
	mrounds_£Ëù_rx
;

13 
ušt64_t
 
	mrounds_£Ëù_tx
;

14 
ušt64_t
 
	mrounds_£Ëù_šŒ
;

16 
ušt64_t
 
	mrounds_acû±
;

17 
ušt64_t
 
	mrounds_»ad
;

18 
ušt64_t
 
	mrounds_wr™e
;

19 
ušt64_t
 
	mrounds_•Şl
;

20 
ušt64_t
 
	mrounds_wndadv
;

22 
ušt64_t
 
	mrounds_¹ocheck
;

23 
ušt64_t
 
	mrounds_twcheck
;

24 
ušt64_t
 
	mrounds_tocheck
;

27 
	s¡©_couÁ”


29 
ušt64_t
 
	mút
;

30 
ušt64_t
 
	msum
;

31 
ušt64_t
 
	mmax
;

32 
ušt64_t
 
	mmš
;

35 
	stime_¡©


37 
¡©_couÁ”
 
	mround
;

38 
¡©_couÁ”
 
	m´oûssšg
;

39 
¡©_couÁ”
 
	mtcheck
;

40 
¡©_couÁ”
 
	m•Şl
;

41 
¡©_couÁ”
 
	mhªdË
;

42 
¡©_couÁ”
 
	mxm™
;

43 
¡©_couÁ”
 
	m£Ëù
;

46 
	sÃt_¡©


48 
ušt64_t
 
	mtx_·ck‘s
[
MAX_DEVICES
];

49 
ušt64_t
 
	mtx_by‹s
[
MAX_DEVICES
];

50 
ušt64_t
 
	mtx_drİs
[
MAX_DEVICES
];

51 
ušt64_t
 
	mrx_·ck‘s
[
MAX_DEVICES
];

52 
ušt64_t
 
	mrx_by‹s
[
MAX_DEVICES
];

53 
ušt64_t
 
	mrx_”rÜs
[
MAX_DEVICES
];

54 #ifdeà
ENABLELRO


55 
ušt64_t
 
	mtx_gd±by‹s
;

56 
ušt64_t
 
	mrx_gd±by‹s
;

60 
	sbÿ¡_¡©


62 
ušt64_t
 
	mcyşes
;

63 
ušt64_t
 
	mwr™e
;

64 
ušt64_t
 
	m»ad
;

65 
ušt64_t
 
	m•Şl
;

66 
ušt64_t
 
	mwnd_adv
;

67 
ušt64_t
 
	mack
;

70 
	stimeout_¡©


72 
ušt64_t
 
	mcyşes
;

73 
ušt64_t
 
	m¹o_Œy
;

74 
ušt64_t
 
	m¹o
;

75 
ušt64_t
 
	mtimewa™_Œy
;

76 
ušt64_t
 
	mtimewa™
;

79 #ifdeà
NETSTAT


80 
	#STAT_COUNT
(
¡©
è¡©++

	)

82 
	#STAT_COUNT
(
¡©
)

	)

	@include/tcp_in.h

1 #iâdeà
__TCP_IN_H_


2 
	#__TCP_IN_H_


	)

4 
	~<lšux/if_‘h”.h
>

5 
	~<lšux/tı.h
>

6 
	~<lšux/udp.h
>

7 
	~<Ãtš‘/.h
>

9 
	~"mtı.h
"

10 
	~"fhash.h
"

12 
	#TCP_FLAG_FIN
 0x01

13 
	#TCP_FLAG_SYN
 0x02

14 
	#TCP_FLAG_RST
 0x04

15 
	#TCP_FLAG_PSH
 0x08

16 
	#TCP_FLAG_ACK
 0x10

17 
	#TCP_FLAG_URG
 0x20

18 
	#TCP_FLAG_SACK
 0x40

19 
	#TCP_FLAG_WACK
 0x80

20 

	)

21 
	#TCP_OPT_FLAG_MSS
 0x02

22 
	#TCP_OPT_FLAG_WSCALE
 0x04

23 
	#TCP_OPT_FLAG_SACK_PERMIT
 0x08

24 
	#TCP_OPT_FLAG_SACK
 0x10

25 
	#TCP_OPT_FLAG_TIMESTAMP
 0x20

26 

	)

27 
	#TCP_OPT_MSS_LEN
 4

	)

28 
	#TCP_OPT_WSCALE_LEN
 3

	)

29 
	#TCP_OPT_SACK_PERMIT_LEN
 2

	)

30 
	#TCP_OPT_SACK_LEN
 10

	)

31 
	#TCP_OPT_TIMESTAMP_LEN
 10

	)

33 
	#TCP_DEFAULT_MSS
 1460

	)

34 
	#TCP_DEFAULT_WSCALE
 7

	)

35 
	#TCP_INITIAL_WINDOW
 14600

36 

	)

37 
	#TCP_SEQ_LT
(
a
,
b
è((
št32_t
)(×)-(b)è< 0)

	)

38 
	#TCP_SEQ_LEQ
(
a
,
b
è((
št32_t
)(×)-(b)è<ğ0)

	)

39 
	#TCP_SEQ_GT
(
a
,
b
è((
št32_t
)(×)-(b)è> 0)

	)

40 
	#TCP_SEQ_GEQ
(
a
,
b
è((
št32_t
)(×)-(b)è>ğ0)

	)

41 
	#TCP_SEQ_BETWEEN
(
a
,
b
,
c
è(
	`TCP_SEQ_GEQ
×,bè&& 
	`TCP_SEQ_LEQ
×,c))

	)

44 
	#HZ
 1000

	)

45 
	#TIME_TICK
 (1000000/
HZ
)

46 
	#TIMEVAL_TO_TS
(
t
è(
ušt32_t
)(Ñ)->
tv_£c
 * 
HZ
 + \

47 ((
t
)->
tv_u£c
 / 
TIME_TICK
))

	)

49 
	#TS_TO_USEC
(
t
è(Ñè* 
TIME_TICK
)

	)

50 
	#TS_TO_MSEC
(
t
è(
	`TS_TO_USEC
Ñè/ 1000)

	)

52 
	#USEC_TO_TS
(
t
è(Ñè/ 
TIME_TICK
)

	)

53 
	#MSEC_TO_TS
(
t
è(
	`USEC_TO_TS
(Ñè* 1000))

	)

54 
	#SEC_TO_TS
(
t
èÑ * 
HZ
)

	)

56 
	#SEC_TO_USEC
(
t
è(Ñè* 1000000)

	)

57 
	#SEC_TO_MSEC
(
t
è(Ñè* 1000)

	)

58 
	#MSEC_TO_USEC
(
t
è(Ñè* 1000)

	)

59 
	#USEC_TO_SEC
(
t
è(Ñè/ 1000000)

	)

61 
	#TCP_TIMEWAIT
 0

	)

62 
	#TCP_INITIAL_RTO
 (
	`MSEC_TO_USEC
(500è/ 
TIME_TICK
)

63 
	#TCP_FIN_RTO
 (
	`MSEC_TO_USEC
(500è/ 
TIME_TICK
)

64 
	#TCP_TIMEOUT
 (
	`MSEC_TO_USEC
(30000è/ 
TIME_TICK
)

65 

	)

66 
	#TCP_MAX_RTX
 16

	)

67 
	#TCP_MAX_SYN_RETRY
 7

	)

68 
	#TCP_MAX_BACKOFF
 7

	)

70 
	etı_¡©e


72 
	mTCP_ST_CLOSED
 = 0,

73 
	mTCP_ST_LISTEN
 = 1,

74 
	mTCP_ST_SYN_SENT
 = 2,

75 
	mTCP_ST_SYN_RCVD
 = 3,

76 
	mTCP_ST_ESTABLISHED
 = 4,

77 
	mTCP_ST_FIN_WAIT_1
 = 5,

78 
	mTCP_ST_FIN_WAIT_2
 = 6,

79 
	mTCP_ST_CLOSE_WAIT
 = 7,

80 
	mTCP_ST_CLOSING
 = 8,

81 
	mTCP_ST_LAST_ACK
 = 9,

82 
	mTCP_ST_TIME_WAIT
 = 10

85 
	etı_İtiÚ


87 
	mTCP_OPT_END
 = 0,

88 
	mTCP_OPT_NOP
 = 1,

89 
	mTCP_OPT_MSS
 = 2,

90 
	mTCP_OPT_WSCALE
 = 3,

91 
	mTCP_OPT_SACK_PERMIT
 = 4,

92 
	mTCP_OPT_SACK
 = 5,

93 
	mTCP_OPT_TIMESTAMP
 = 8

96 
	etı_şo£_»asÚ


98 
	mTCP_NOT_CLOSED
 = 0,

99 
	mTCP_ACTIVE_CLOSE
 = 1,

100 
	mTCP_PASSIVE_CLOSE
 = 2,

101 
	mTCP_CONN_FAIL
 = 3,

102 
	mTCP_CONN_LOST
 = 4,

103 
	mTCP_RESET
 = 5,

104 
	mTCP_NO_MEM
 = 6,

105 
	mTCP_NOT_ACCEPTED
 = 7,

106 
	mTCP_TIMEDOUT
 = 8

110 
P¬£TCPO±iÚs
(
tı_¡»am
 *
cur_¡»am
,

111 
ušt32_t
 
cur_ts
, 
ušt8_t
 *
tıİt
, 
Ën
);

113 
šlše
 

114 
ProûssTCPU¶šk
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
tı_¡»am
 *
cur_¡»am
,

115 cÚ¡ 
tıhdr
 *
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

116 
ušt8_t
 *
·ylßd
, 
·ylßdËn
, 
ušt32_t
 
wšdow
);

119 
ProûssTCPPack‘
(
mtı_mªag”
 *
mtı
, 
ušt32_t
 
cur_ts
, cÚ¡ 
ifidx
,

120 cÚ¡ 
hdr
* 
h
, 
_Ën
);

121 
ušt16_t


122 
TCPC®cChecksum
(
ušt16_t
 *
buf
, ušt16_ˆ
Ën
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
);

	@include/tcp_out.h

1 #iâdeà
__TCP_OUT_H_


2 
	#__TCP_OUT_H_


	)

4 
	~"mtı.h
"

5 
	~"tı_¡»am.h
"

7 
	eack_İt


9 
	mACK_OPT_NOW
,

10 
	mACK_OPT_AGGREGATE
,

11 
	mACK_OPT_WACK


15 
S’dTCPPack‘Snd®Úe
(
mtı_mªag”
 *
mtı
,

16 
ušt32_t
 
§ddr
, 
ušt16_t
 
¥Üt
, ušt32_ˆ
daddr
, ušt16_ˆ
dpÜt
,

17 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
ušt16_t
 
wšdow
, 
ušt8_t
 
æags
,

18 
ušt8_t
 *
·ylßd
, 
ušt16_t
 
·ylßdËn
,

19 
ušt32_t
 
cur_ts
, ušt32_ˆ
echo_ts
);

22 
S’dTCPPack‘
(
mtı_mªag”
 *
mtı
, 
tı_¡»am
 *
cur_¡»am
,

23 
ušt32_t
 
cur_ts
, 
ušt8_t
 
æags
, ušt8_ˆ*
·ylßd
, 
ušt16_t
 
·ylßdËn
);

26 
Wr™eTCPCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
,

27 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
);

30 
Wr™eTCPD©aLi¡
(
mtı_mªag”_t
 
mtı
,

31 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
);

34 
Wr™eTCPACKLi¡
(
mtı_mªag”_t
 
mtı
,

35 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
);

38 
AddtoCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
);

41 
AddtoS’dLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

44 
RemoveFromCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

47 
RemoveFromS’dLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

50 
RemoveFromACKLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

53 
EnqueueACK
(
mtı_mªag”_t
 
mtı
,

54 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
, 
ušt8_t
 
İt
);

57 
DumpCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
mtı_£nd”
 *
£nd”
);

	@include/tcp_rb_frag_queue.h

1 #iâdeà
__TCP_RB_FRAG_QUEUE_


2 
	#__TCP_RB_FRAG_QUEUE_


	)

4 
	~"tı_ršg_bufãr.h
"

7 
rb_äag_queue
* 
	trb_äag_queue_t
;

9 
rb_äag_queue_t


10 
C»©eRBF¿gQueue
(
ÿ·c™y
);

13 
De¡royRBF¿gQueue
(
rb_äag_queue_t
 
rb_äagq
);

16 
RBF¿gEnqueue
(
rb_äag_queue_t
 
rb_äagq
, 
äagm’t_ùx
 *
äag
);

18 
äagm’t_ùx
 *

19 
RBF¿gDequeue
(
rb_äag_queue_t
 
rb_äagq
);

	@include/tcp_ring_buffer.h

15 #iâdeà
__NRE_RING_BUFFER_


16 
	#__NRE_RING_BUFFER_


	)

18 
	~<¡dšt.h
>

19 
	~<sys/ty³s.h
>

22 
	erb_ÿÎ”


24 
	mAT_APP
,

25 
	mAT_MTCP


28 #ifdeà
ENABLELRO


29 
mtı_mªag”
* 
	tmtı_mªag”_t
;

31 
rb_mªag”
* 
	trb_mªag”_t
;

33 
	säagm’t_ùx


35 
ušt32_t
 
	m£q
;

36 
ušt32_t
 
	mËn
 : 31;

37 
ušt32_t
 
	mis_ÿÎoc
 : 1;

38 
äagm’t_ùx
 *
	mÃxt
;

41 
	stı_ršg_bufãr


43 
u_ch¬
* 
	md©a
;

44 
u_ch¬
* 
	mh—d
;

46 
ušt32_t
 
	mh—d_off£t
;

47 
ušt32_t
 
	m_off£t
;

49 
	mm”ged_Ën
;

50 
ušt64_t
 
	mcum_Ën
;

51 
	mÏ¡_Ën
;

52 
	msize
;

55 
ušt32_t
 
	mh—d_£q
;

56 
ušt32_t
 
	mš™_£q
;

58 
äagm’t_ùx
* 
	mfùx
;

61 
ušt32_t
 
RBG‘Cuºum
(
rb_mªag”_t
 
rbm
);

62 
RBPrštInfo
(
tı_ršg_bufãr
* 
buff
);

63 
RBPrštSŒ
(
tı_ršg_bufãr
* 
buff
);

64 
RBPrštHex
(
tı_ršg_bufãr
* 
buff
);

66 #ifdeà
ENABLELRO


67 
rb_mªag”_t
 
RBMªag”C»©e
(
mtı_mªag”_t
 
mtı
, 
size_t
 
chunk_size
, 
ušt32_t
 
úum
);

69 
rb_mªag”_t
 
RBMªag”C»©e
(
size_t
 
chunk_size
, 
ušt32_t
 
úum
);

72 
tı_ršg_bufãr
* 
RBIn™
(
rb_mªag”_t
 
rbm
, 
ušt32_t
 
š™_£q
);

73 
RBF»e
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
);

74 
ušt32_t
 
RBIsDªg”
(
rb_mªag”_t
 
rbm
);

77 
RBPut
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
,

78 * 
d©a
, 
ušt32_t
 
Ën
 , ušt32_ˆ
£q
);

79 
size_t
 
RBG‘
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
, size_ˆ
Ën
);

80 
size_t
 
RBRemove
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
,

81 
size_t
 
Ën
, 
İtiÚ
);

	@include/tcp_sb_queue.h

1 #iâdeà
__TCP_SB_QUEUE_


2 
	#__TCP_SB_QUEUE_


	)

4 
	~"tı_£nd_bufãr.h
"

7 
sb_queue
* 
	tsb_queue_t
;

9 
sb_queue_t


10 
C»©eSBQueue
(
ÿ·c™y
);

13 
De¡roySBQueue
(
sb_queue_t
 
sq
);

16 
SBEnqueue
(
sb_queue_t
 
sq
, 
tı_£nd_bufãr
 *
buf
);

18 
tı_£nd_bufãr
 *

19 
SBDequeue
(
sb_queue_t
 
sq
);

	@include/tcp_send_buffer.h

1 #iâdeà
__TCP_SEND_BUFFER_H_


2 
	#__TCP_SEND_BUFFER_H_


	)

4 
	~<¡dlib.h
>

5 
	~<¡dšt.h
>

8 
sb_mªag”
* 
	tsb_mªag”_t
;

10 
	stı_£nd_bufãr


12 *
	md©a
;

13 *
	mh—d
;

15 
ušt32_t
 
	mh—d_off
;

16 
ušt32_t
 
	m_off
;

17 
ušt32_t
 
	mËn
;

18 
ušt64_t
 
	mcum_Ën
;

19 
ušt32_t
 
	msize
;

21 
ušt32_t
 
	mh—d_£q
;

22 
ušt32_t
 
	mš™_£q
;

25 
ušt32_t


26 
SBG‘Cuºum
(
sb_mªag”_t
 
sbm
);

28 
sb_mªag”_t


29 
SBMªag”C»©e
(
size_t
 
chunk_size
, 
ušt32_t
 
úum
);

31 
tı_£nd_bufãr
 *

32 
SBIn™
(
sb_mªag”_t
 
sbm
, 
ušt32_t
 
š™_£q
);

35 
SBF»e
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
);

37 
size_t


38 
SBPut
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

40 
size_t


41 
SBRemove
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
, 
size_t
 
Ën
);

	@include/tcp_stream.h

1 #iâdeà
__TCP_STREAM_H_


2 
	#__TCP_STREAM_H_


	)

4 
	~<Ãtš‘/.h
>

5 
	~<lšux/tı.h
>

6 
	~<sys/queue.h
>

8 
	~"mtı.h
"

10 
	s¹m_¡©


12 
ušt32_t
 
	mtdp_ack_út
;

13 
ušt32_t
 
	mtdp_ack_by‹s
;

14 
ušt32_t
 
	mack_upd_út
;

15 
ušt32_t
 
	mack_upd_by‹s
;

16 #ià
TCP_OPT_SACK_ENABLED


17 
ušt32_t
 
	m§ck_út
;

18 
ušt32_t
 
	m§ck_by‹s
;

19 
ušt32_t
 
	mtdp_§ck_út
;

20 
ušt32_t
 
	mtdp_§ck_by‹s
;

22 
ušt32_t
 
	m¹o_út
;

23 
ušt32_t
 
	m¹o_by‹s
;

26 #ià
TCP_OPT_SACK_ENABLED


27 
	s§ck_’Œy


29 
ušt32_t
 
	mËá_edge
;

30 
ušt32_t
 
	mright_edge
;

31 
ušt32_t
 
	mexpœe
;

35 
	stı_»cv_v¬s


38 
ušt32_t
 
	mrcv_wnd
;

40 
ušt32_t
 
	mœs
;

41 
ušt32_t
 
	m¢d_wl1
;

42 
ušt32_t
 
	m¢d_wl2
;

45 
ušt8_t
 
	mdup_acks
;

46 
ušt32_t
 
	mÏ¡_ack_£q
;

49 
ušt32_t
 
	mts_»ûÁ
;

50 
ušt32_t
 
	mts_Ï¡ack_rcvd
;

51 
ušt32_t
 
	mts_Ï¡_ts_upd
;

52 
ušt32_t
 
	mts_tw_expœe
;

55 
ušt32_t
 
	m¤‰
;

56 
ušt32_t
 
	mmdev
;

57 
ušt32_t
 
	mmdev_max
;

58 
ušt32_t
 
	m¹tv¬
;

59 
ušt32_t
 
	m¹t_£q
;

61 #ià
TCP_OPT_SACK_ENABLED


62 
	#MAX_SACK_ENTRY
 8

	)

63 
§ck_’Œy
 
	m§ck_bË
[
MAX_SACK_ENTRY
];

64 
ušt8_t
 
	m§cks
:3;

67 
tı_ršg_bufãr
 *
	mrcvbuf
;

68 #ià
USE_SPIN_LOCK


69 
±h»ad_¥šlock_t
 
	m»ad_lock
;

71 
±h»ad_mu‹x_t
 
	m»ad_lock
;

74 
TAILQ_ENTRY
(
tı_¡»am
è
	mhe_lšk
;

76 #ià
BLOCKING_SUPPORT


77 
TAILQ_ENTRY
(
tı_¡»am
è
	mrcv_br_lšk
;

78 
±h»ad_cÚd_t
 
	m»ad_cÚd
;

82 
	stı_£nd_v¬s


85 
ušt16_t
 
	m_id
;

87 
ušt16_t
 
	mmss
;

88 
ušt16_t
 
	meff_mss
;

90 
ušt8_t
 
	mwsÿË_mše
;

91 
ušt8_t
 
	mwsÿË_³”
;

92 
št8_t
 
	mnif_out
;

93 *
	md_haddr
;

96 
ušt32_t
 
	m¢d_uÇ
;

97 
ušt32_t
 
	m¢d_wnd
;

98 
ušt32_t
 
	m³”_wnd
;

100 
ušt32_t
 
	miss
;

101 
ušt32_t
 
	mfss
;

104 
ušt8_t
 
	mÄtx
;

105 
ušt8_t
 
	mmax_Ätx
;

106 
ušt32_t
 
	m¹o
;

107 
ušt32_t
 
	mts_¹o
;

110 
ušt32_t
 
	mcwnd
;

111 
ušt32_t
 
	ms¡h»sh
;

114 
ušt32_t
 
	mts_Ï¡ack_£Á
;

116 
ušt8_t
 
	mis_wack
:1,

117 
	mack_út
:6;

119 
ušt8_t
 
	mÚ_cÚŒŞ_li¡
;

120 
ušt8_t
 
	mÚ_£nd_li¡
;

121 
ušt8_t
 
	mÚ_ack_li¡
;

122 
ušt8_t
 
	mÚ_£ndq
;

123 
ušt8_t
 
	mÚ_ackq
;

124 
ušt8_t
 
	mÚ_şo£q
;

125 
ušt8_t
 
	mÚ_»£tq
;

127 
ušt8_t
 
	mÚ_şo£q_št
:1,

128 
	mÚ_»£tq_št
:1,

129 
	mis_fš_£Á
:1,

130 
	mis_fš_ackd
:1;

132 
TAILQ_ENTRY
(
tı_¡»am
è
	mcÚŒŞ_lšk
;

133 
TAILQ_ENTRY
(
tı_¡»am
è
	m£nd_lšk
;

134 
TAILQ_ENTRY
(
tı_¡»am
è
	mack_lšk
;

136 
TAILQ_ENTRY
(
tı_¡»am
è
	mtim”_lšk
;

137 
TAILQ_ENTRY
(
tı_¡»am
è
	mtimeout_lšk
;

139 
tı_£nd_bufãr
 *
	m¢dbuf
;

140 #ià
USE_SPIN_LOCK


141 
±h»ad_¥šlock_t
 
	mwr™e_lock
;

143 
±h»ad_mu‹x_t
 
	mwr™e_lock
;

146 #ià
RTM_STAT


147 
¹m_¡©
 
	mr¡©
;

150 #ià
BLOCKING_SUPPORT


151 
TAILQ_ENTRY
(
tı_¡»am
è
	m¢d_br_lšk
;

152 
±h»ad_cÚd_t
 
	mwr™e_cÚd
;

156 
	stı_¡»am


158 
sock‘_m­_t
 
	msock‘
;

160 
ušt32_t
 
	mid
:24,

161 
	m¡»am_ty³
:8;

163 
ušt32_t
 
	m§ddr
;

164 
ušt32_t
 
	mdaddr
;

165 
ušt16_t
 
	m¥Üt
;

166 
ušt16_t
 
	mdpÜt
;

168 
ušt8_t
 
	m¡©e
;

169 
ušt8_t
 
	mşo£_»asÚ
;

170 
ušt8_t
 
	mÚ_hash_bË
;

171 
ušt8_t
 
	mÚ_timewa™_li¡
;

172 
ušt8_t
 
	mht_idx
;

173 
ušt8_t
 
	mşo£d
;

174 
ušt8_t
 
	mis_bound_addr
;

175 
ušt8_t
 
	mÃed_wnd_adv
;

176 
št16_t
 
	mÚ_¹o_idx
;

178 
ušt16_t
 
	mÚ_timeout_li¡
:1,

179 
	mÚ_rcv_br_li¡
:1,

180 
	mÚ_¢d_br_li¡
:1,

181 
	m§w_time¡amp
:1,

182 
	m§ck_³rm™
:1,

183 
	mcÚŒŞ_li¡_wa™šg
:1,

184 
	mhave_»£t
:1;

186 
ušt32_t
 
	m¢d_nxt
;

187 
ušt32_t
 
	mrcv_nxt
;

189 
tı_»cv_v¬s
 *
	mrcvv¬
;

190 
tı_£nd_v¬s
 *
	m¢dv¬
;

192 
ušt32_t
 
	mÏ¡_aùive_ts
;

194 } 
	ttı_¡»am
;

197 
TCPS‹ToSŒšg
(cÚ¡ 
tı_¡»am
 *
cur_¡»am
);

200 
HashFlow
(cÚ¡ *
æow
);

203 
Equ®Flow
(cÚ¡ *
æow1
, cÚ¡ *
æow2
);

206 
AddEpŞlEv’t
(
mtı_•Şl
 *
•
,

207 
queue_ty³
, 
sock‘_m­_t
 
sock‘
, 
ušt32_t
 
ev’t
);

210 
Rai£R—dEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

213 
Rai£Wr™eEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

216 
Rai£Clo£Ev’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

219 
Rai£E¼ÜEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

221 
tı_¡»am
 *

222 
C»©eTCPSŒ—m
(
mtı_mªag”_t
 
mtı
, 
sock‘_m­_t
 
sock‘
, 
ty³
,

223 
ušt32_t
 
§ddr
, 
ušt16_t
 
¥Üt
, ušt32_ˆ
daddr
, ušt16_ˆ
dpÜt
);

226 
De¡royTCPSŒ—m
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

229 
DumpSŒ—m
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
);

232 
In™ŸlizeTCPSŒ—mMªag”
();

	@include/tcp_stream_queue.h

1 #iâdeà
__TCP_STREAM_QUEUE_


2 
	#__TCP_STREAM_QUEUE_


	)

4 
	~<¡dšt.h
>

7 #ià
LOCK_STREAM_QUEUE


9 #ià
USE_SPIN_LOCK


10 
	#SQ_LOCK_INIT
(
lock
, 
”rmsg
, 
aùiÚ
); \

11 ià(
	`±h»ad_¥š_š™
(
lock
, 
PTHREAD_PROCESS_PRIVATE
)) { \

12 
	`³¼Ü
("±h»ad_¥š_š™" 
”rmsg
); \

13 
aùiÚ
; \

14 }

	)

15 
	#SQ_LOCK_DESTROY
(
lock
è
	`±h»ad_¥š_de¡roy
Öock)

	)

16 
	#SQ_LOCK
(
lock
è
	`±h»ad_¥š_lock
Öock)

	)

17 
	#SQ_UNLOCK
(
lock
è
	`±h»ad_¥š_uÆock
Öock)

	)

19 
	#SQ_LOCK_INIT
(
lock
, 
”rmsg
, 
aùiÚ
); \

20 ià(
	`±h»ad_mu‹x_š™
(
lock
, 
NULL
)) { \

21 
	`³¼Ü
("±h»ad_mu‹x_š™" 
”rmsg
); \

22 
aùiÚ
; \

23 }

	)

24 
	#SQ_LOCK_DESTROY
(
lock
è
	`±h»ad_mu‹x_de¡roy
Öock)

	)

25 
	#SQ_LOCK
(
lock
è
	`±h»ad_mu‹x_lock
Öock)

	)

26 
	#SQ_UNLOCK
(
lock
è
	`±h»ad_mu‹x_uÆock
Öock)

	)

30 
	#SQ_LOCK_INIT
(
lock
, 
”rmsg
, 
aùiÚ
è(è0

	)

31 
	#SQ_LOCK_DESTROY
(
lock
è(è0

	)

32 
	#SQ_LOCK
(
lock
è(è0

	)

33 
	#SQ_UNLOCK
(
lock
è(è0

	)

37 
¡»am_queue
* 
	t¡»am_queue_t
;

39 
	s¡»am_queue_št


41 
tı_¡»am
 **
	m¬¿y
;

42 
	msize
;

44 
	mfœ¡
;

45 
	mÏ¡
;

46 
	mcouÁ
;

48 } 
	t¡»am_queue_št
;

50 
¡»am_queue_št
 *

51 
C»©eIÁ”ÇlSŒ—mQueue
(
size
);

54 
De¡royIÁ”ÇlSŒ—mQueue
(
¡»am_queue_št
 *
sq
);

57 
SŒ—mIÁ”ÇlEnqueue
(
¡»am_queue_št
 *
sq
, 
tı_¡»am
 *
¡»am
);

59 
tı_¡»am
 *

60 
SŒ—mIÁ”ÇlDequeue
(
¡»am_queue_št
 *
sq
);

62 
¡»am_queue_t


63 
C»©eSŒ—mQueue
(
size
);

66 
De¡roySŒ—mQueue
(
¡»am_queue_t
 
sq
);

69 
SŒ—mEnqueue
(
¡»am_queue_t
 
sq
, 
tı_¡»am
 *
¡»am
);

71 
tı_¡»am
 *

72 
SŒ—mDequeue
(
¡»am_queue_t
 
sq
);

75 
SŒ—mQueueIsEm±y
(
¡»am_queue_t
 
sq
);

	@include/tcp_util.h

1 #iâdeà
__TCP_UTIL_H_


2 
	#__TCP_UTIL_H_


	)

4 
	~"mtı.h
"

5 
	~"tı_¡»am.h
"

7 
	stı_time¡amp


9 
ušt32_t
 
	mts_v®
;

10 
ušt32_t
 
	mts_»f
;

13 
P¬£TCPO±iÚs
(
tı_¡»am
 *
cur_¡»am
,

14 
ušt32_t
 
cur_ts
, 
ušt8_t
 *
tıİt
, 
Ën
);

17 
P¬£TCPTime¡amp
(
tı_¡»am
 *
cur_¡»am
,

18 
tı_time¡amp
 *
ts
, 
ušt8_t
 *
tıİt
, 
Ën
);

20 #ià
TCP_OPT_SACK_ENABLED


22 
P¬£SACKO±iÚ
(
tı_¡»am
 *
cur_¡»am
,

23 
ušt32_t
 
ack_£q
, 
ušt8_t
 *
tıİt
, 
Ën
);

26 
ušt16_t


27 
TCPC®cChecksum
(
ušt16_t
 *
buf
, ušt16_ˆ
Ën
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
);

30 
PrštTCPO±iÚs
(
ušt8_t
 *
tıİt
, 
Ën
);

	@include/timer.h

1 #iâdeà
__TIMER_H_


2 
	#__TIMER_H_


	)

4 
	~"mtı.h
"

5 
	~"tı_¡»am.h
"

7 
	#RTO_HASH
 3000

	)

9 
	s¹o_hash¡Üe


11 
ušt32_t
 
	m¹o_now_idx
;

12 
ušt32_t
 
	m¹o_now_ts
;

14 
TAILQ_HEAD
(
¹o_h—d
 , 
tı_¡»am
è
	m¹o_li¡
[
RTO_HASH
+1];

17 
¹o_hash¡Üe
*

18 
In™RTOHash¡Üe
();

21 
AddtoRTOLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

24 
RemoveFromRTOLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

27 
AddtoTimewa™Li¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
);

30 
RemoveFromTimewa™Li¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

33 
AddtoTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

36 
RemoveFromTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

39 
Upd©eTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
);

42 
Upd©eR‘¿nsmissiÚTim”
(
mtı_mªag”_t
 
mtı
,

43 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
);

46 
CheckRtmTimeout
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
);

49 
CheckTimewa™Expœe
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
);

52 
CheckCÚÃùiÚTimeout
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
);

	@io_module.cpp

2 
	~"io_moduË.h
"

4 
	~"cÚfig.h
"

6 
	~<¡dlib.h
>

8 
	~<¡dio.h
>

10 
	~<¡ršg.h
>

12 
	~<Ãt/if.h
>

14 
	~<sys/ioùl.h
>

15 #iâdeà
DISABLE_DPDK


17 
	~<¹e_‘hdev.h
>

20 
	~"debug.h
"

22 
	~<sys/sock‘.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<¬·/š‘.h
>

26 
	~<uni¡d.h
>

28 
	~<sys/ty³s.h
>

29 
	~<içddrs.h
>

30 
	~<io¡»am
>

31 
usšg
 
Çme¥aû
 
	g¡d
;

34 
io_moduË_func
 
	gdpdk_moduË_func
,
	gps_moduË_func
;

35 
io_moduË_func
 *
	gcu¼’t_iomoduË_func
 = &
Ãtm­_moduË_func
;

36 
ps_deviû
 
	gdeviûs
[
MAX_DEVICES
];

37 
	#ALL_STRING
 "®l"

	)

38 
	#MAX_PROCLINE_LEN
 1024

	)

39 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

40 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

43 
	$G‘NumQueues
()

45 
FILE
 *
å
;

46 
buf
[
MAX_PROCLINE_LEN
];

47 
queue_út
;

49 
å
 = 
	`fİ’
("/proc/interrupts", "r");

50 ià(!
å
) {

51 
	`TRACE_CONFIG
("Failedo„ead data from /proc/interrupts!\n");

56 
queue_út
 = 0;

57 !
	`ãof
(
å
)) {

58 ià(
	`fg‘s
(
buf
, 
MAX_PROCLINE_LEN
, 
å
è=ğ
NULL
)

62 ià(
	`¡r¡r
(
buf
, "xge0-rx")) {

63 
queue_út
++;

66 
	`fşo£
(
å
);

68  
queue_út
;

69 
	}
}

72 
	$S‘IÁ”çûInfo
(* 
dev_Çme_li¡
)

74 
iäeq
 
iä
;

75 
eidx
 = 0;

76 
i
, 
j
;

78 
£t_®l_šf
 = (
	`¡ºcmp
(
dev_Çme_li¡
, 
ALL_STRING
, (ALL_STRING))==0);

80 
	`TRACE_CONFIG
("Loading interface setting\n");

82 
CONFIG
.
‘hs
 = (
‘h_bË
 *)

83 
	`ÿÎoc
(
MAX_DEVICES
, (
‘h_bË
));

84 ià(!
CONFIG
.
‘hs
)

85 
	`ex™
(
EXIT_FAILURE
);

156  ià(
cu¼’t_iomoduË_func
 =ğ&
dpdk_moduË_func
) {

157 #iâdeà
DISABLE_DPDK


158 
ıu
 = 
CONFIG
.
num_cÜes
;

159 
ušt32_t
 
ıumask
 = 0;

160 
ıumaskbuf
[10];

161 
mem_chªÃls
[5];

162 
»t
;

163 
‘h”_addr
 
pÜts_‘h_addr
[
RTE_MAX_ETHPORTS
];

166 
»t
 = 0;„‘ < 
ıu
;„et++)

167 
ıumask
 = (ıumask | (1 << 
»t
));

168 
	`¥rštf
(
ıumaskbuf
, "%X", 
ıumask
);

171 ià(
CONFIG
.
num_mem_ch
 == 0) {

172 
	`TRACE_ERROR
("DPDK module„equires # of memory channels "

174 
	`ex™
(
EXIT_FAILURE
);

176 
	`¥rštf
(
mem_chªÃls
, "%d", 
CONFIG
.
num_mem_ch
);

179 *
¬gv
[] = {"",

181 
ıumaskbuf
,

183 
mem_chªÃls
,

187 cÚ¡ 
¬gc
 = 6;

198 
İtšd
 = 0;

201 
»t
 = 
	`¹e_—l_š™
(
¬gc
, 
¬gv
);

202 ià(
»t
 < 0)

203 
	`¹e_ex™
(
EXIT_FAILURE
, "Invalid EAL‡rgs!\n");

205 
num_deviûs
 = 
	`¹e_‘h_dev_couÁ
();

206 ià(
num_deviûs
 == 0) {

207 
	`¹e_ex™
(
EXIT_FAILURE
, "No Ethernet…ort!\n");

211 
»t
 = 0;„‘ < 
num_deviûs
;„et++)

212 
	`¹e_‘h_maÿddr_g‘
(
»t
, &
pÜts_‘h_addr
[ret]);

214 
num_queues
 = 
	`MIN
(
CONFIG
.
num_cÜes
, 
MAX_CPUS
);

216 
içddrs
 *
içp
;

217 
içddrs
 *
™”_if
;

218 *
£ek
;

220 ià(
	`g‘içddrs
(&
içp
) != 0) {

221 
	`³¼Ü
("getifaddrs: ");

222 
	`ex™
(
EXIT_FAILURE
);

225 
™”_if
 = 
içp
;

227 ià(
™”_if
->
iç_addr
->
§_çmy
 =ğ
AF_INET
 &&

228 !
£t_®l_šf
 &&

229 (
£ek
=
	`¡r¡r
(
dev_Çme_li¡
, 
™”_if
->
iç_Çme
)è!ğ
NULL
 &&

231 *(
£ek
 + 
	`¡¾’
(
™”_if
->
iç_Çme
)) != ':') {

232 
iäeq
 
iä
;

235 
eidx
 = 
CONFIG
.
‘hs_num
++;

236 
	`¡rıy
(
CONFIG
.
‘hs
[
eidx
].
dev_Çme
, 
™”_if
->
iç_Çme
);

237 
	`¡rıy
(
iä
.
iä_Çme
, 
™”_if
->
iç_Çme
);

240 
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_IP
);

241 ià(
sock
 == -1) {

242 
	`³¼Ü
("socket");

246 ià(
	`ioùl
(
sock
, 
SIOCGIFADDR
, &
iä
) == 0 ) {

247 
š_addr
 
sš
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

248 
CONFIG
.
‘hs
[
eidx
].
_addr
 = *(
ušt32_t
 *)&
sš
;

251 ià(
	`ioùl
(
sock
, 
SIOCGIFHWADDR
, &
iä
) == 0 ) {

252 
j
 = 0; j < 
ETH_ALEN
; j ++) {

253 
CONFIG
.
‘hs
[
eidx
].
haddr
[
j
] = 
iä
.
iä_addr
.
§_d©a
[j];

258 ià(
	`ioùl
(
sock
, 
SIOCGIFNETMASK
, &
iä
) == 0) {

259 
š_addr
 
sš
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

260 
CONFIG
.
‘hs
[
eidx
].
Ãtmask
 = *(
ušt32_t
 *)&
sš
;

262 
	`şo£
(
sock
);

264 
j
 = 0; j < 
num_deviûs
; j++) {

265 ià(!
	`memcmp
(&
CONFIG
.
‘hs
[
eidx
].
haddr
[0], &
pÜts_‘h_addr
[
j
],

266 
ETH_ALEN
))

267 
CONFIG
.
‘hs
[
eidx
].
ifšdex
 = 
j
;

271 
j
 = 0; j < 
num_deviûs_©ched
; j++) {

272 ià(
deviûs_©ched
[
j
] =ğ
CONFIG
.
‘hs
[
eidx
].
ifšdex
) {

276 
deviûs_©ched
[
num_deviûs_©ched
] = 
CONFIG
.
‘hs
[
eidx
].
ifšdex
;

277 
num_deviûs_©ched
++;

278 
	`årštf
(
¡d”r
, "Total‚umber of‡ttached devices: %d\n",

279 
num_deviûs_©ched
);

280 
	`årštf
(
¡d”r
, "Interface‚ame: %s\n",

281 
™”_if
->
iç_Çme
);

283 
™”_if
 = i‹r_if->
iç_Ãxt
;

284 } 
™”_if
 !ğ
NULL
);

286 
	`ä“içddrs
(
içp
);

288 } ià(
cu¼’t_iomoduË_func
 =ğ&
Ãtm­_moduË_func
) {

289 #iâdeà
DISABLE_NETMAP


290 
içddrs
 *
içp
;

291 
içddrs
 *
™”_if
;

292 *
£ek
;

293 
cout
 << "IN‹rçû" << 
’dl
;

295 
num_queues
 = 
	`MIN
(
CONFIG
.
num_cÜes
, 
MAX_CPUS
);

297 ià(
	`g‘içddrs
(&
içp
) != 0) {

298 
	`³¼Ü
("getifaddrs: ");

299 
	`ex™
(
EXIT_FAILURE
);

302 
™”_if
 = 
içp
;

304 ià(
™”_if
->
iç_addr
->
§_çmy
 =ğ
AF_INET
 &&

305 !
£t_®l_šf
 &&

306 (
£ek
=
	`¡r¡r
(
dev_Çme_li¡
, 
™”_if
->
iç_Çme
)è!ğ
NULL
 &&

308 *(
£ek
 + 
	`¡¾’
(
™”_if
->
iç_Çme
)) != ':') {

309 
iäeq
 
iä
;

312 
eidx
 = 
CONFIG
.
‘hs_num
++;

313 
	`¡rıy
(
CONFIG
.
‘hs
[
eidx
].
dev_Çme
, 
™”_if
->
iç_Çme
);

314 
	`¡rıy
(
iä
.
iä_Çme
, 
™”_if
->
iç_Çme
);

317 
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_IP
);

318 ià(
sock
 == -1) {

319 
	`³¼Ü
("socket");

323 ià(
	`ioùl
(
sock
, 
SIOCGIFADDR
, &
iä
) == 0 ) {

324 
š_addr
 
sš
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

325 
CONFIG
.
‘hs
[
eidx
].
_addr
 = *(
ušt32_t
 *)&
sš
;

328 ià(
	`ioùl
(
sock
, 
SIOCGIFHWADDR
, &
iä
) == 0 ) {

329 
j
 = 0; j < 
ETH_ALEN
; j ++) {

330 
CONFIG
.
‘hs
[
eidx
].
haddr
[
j
] = 
iä
.
iä_addr
.
§_d©a
[j];

335 ià(
	`ioùl
(
sock
, 
SIOCGIFNETMASK
, &
iä
) == 0) {

336 
š_addr
 
sš
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

337 
CONFIG
.
‘hs
[
eidx
].
Ãtmask
 = *(
ušt32_t
 *)&
sš
;

339 
	`şo£
(
sock
);

341 
j
 = 0; j < 
num_deviûs
; j++) {

342 ià(!
	`memcmp
(&
CONFIG
.
‘hs
[
eidx
].
haddr
[0], &
pÜts_‘h_addr
[
j
],

343 
ETH_ALEN
))

344 
CONFIG
.
‘hs
[
eidx
].
ifšdex
 = 
iä
.
iä_ifšdex
;

346 
CONFIG
.
‘hs
[
eidx
].
ifšdex
 =ƒidx;

347 
	`TRACE_INFO
("Ifindex of interface %s is: %d\n",

348 
iä
.
iä_Çme
, 
CONFIG
.
‘hs
[
eidx
].
ifšdex
);

354 
j
 = 0; j < 
num_deviûs_©ched
; j++) {

355 ià(
deviûs_©ched
[
j
] =ğ
CONFIG
.
‘hs
[
eidx
].
ifšdex
) {

359 
deviûs_©ched
[
num_deviûs_©ched
] = 
	`if_Çm‘ošdex
(
iä
.
iä_Çme
);

360 
num_deviûs_©ched
++;

361 
	`årštf
(
¡d”r
, "Total‚umber of‡ttached devices: %d\n",

362 
num_deviûs_©ched
);

363 
	`årštf
(
¡d”r
, "Interface‚ame: %s\n",

364 
™”_if
->
iç_Çme
);

366 
™”_if
 = i‹r_if->
iç_Ãxt
;

367 } 
™”_if
 !ğ
NULL
);

369 
	`ä“içddrs
(
içp
);

373 
	}
}

	@ip_check.cpp

1 
	~<io¡»am
>

2 
	~<as£¹.h
>

5 
	#__FAVOR_BSD


	)

8 
	~<sys/ty³s.h
>

10 
	~<Ãtš‘/š.h
>

12 
	~<Ãtš‘/.h
>

14 
	~<Ãtš‘/6.h
>

19 
	~<lšux/udp.h
>

21 
	~<Ãt/‘h”Ãt.h
>

23 
	~<¡ršg.h
>

24 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/š.h
>

26 
	~<uni¡d.h
>

27 
	~<içddrs.h
>

28 
	~<sys/ioùl.h
>

29 
	~<sys/pŞl.h
>

30 
	~<sys/sock‘.h
>

31 
	~<sys/ty³s.h
>

32 
	~<¬·/š‘.h
>

33 
	~<Ãt/‘h”Ãt.h
>

34 
	~<Ãt/if.h
>

35 
	~<Ãtš‘/š.h
>

37 
	~<lšux/udp.h
>

38 
	~<lšux/tı.h
>

39 
	~<Ãtš‘/.h
>

40 
	~<Ãtš‘/‘h”.h
>

42 
usšg
 
Çme¥aû
 
	g¡d
;

44 
	#MSB32
 0x80000000

	)

45 
	#MSB16
 0x8000

	)

46 
	#KEY_CACHE_LEN
 96

	)

47 
	#SEED
 'B'

	)

48 
	#CLIENT_IP
 "169.254.9.3"

	)

49 
	#SERVER_IP
 "169.254.9.8"

	)

50 
	#SERVER_PORT
 9999

	)

51 
	#CLIENT_START_PORT
 5900

	)

52 
	#ITERATIONS
 100

	)

53 
	#NUM_CORES
 4

	)

61 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

63 cÚ¡ 
ušt8_t
 
key
[] = {

75 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

76 (((
ušt32_t
)
key
[1]) << 16) |

77 (((
ušt32_t
)
key
[2]) << 8) |

78 ((
ušt32_t
)
key
[3]);

80 
ušt32_t
 
idx
 = 32;

81 
i
;

83 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

84 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

85 
ušt32_t
 
b™
;

87 
ÿche
[
i
] = 
»suÉ
;

88 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

90 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

92 
	}
}

98 
ušt32_t


99 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

102 
ušt32_t
 
rc
 = 0;

103 
i
;

104 
fœ¡_time
 = 1;

105 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

107 ià(
fœ¡_time
) {

108 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

109 
fœ¡_time
 = 0;

112 
i
 = 0; i < 32; i++) {

113 ià(
s
 & 
MSB32
)

114 
rc
 ^ğ
key_ÿche
[
i
];

115 
s
 <<= 1;

117 
i
 = 0; i < 32; i++) {

118 ià(
d
 & 
MSB32
)

119 
rc
 ^ğ
key_ÿche
[32+
i
];

120 
d
 <<= 1;

122 
i
 = 0; i < 16; i++) {

123 ià(
¥
 & 
MSB16
)

124 
rc
 ^ğ
key_ÿche
[64+
i
];

125 
¥
 <<= 1;

127 
i
 = 0; i < 16; i++) {

128 ià(
dp
 & 
MSB16
)

129 
rc
 ^ğ
key_ÿche
[80+
i
];

130 
dp
 <<= 1;

133  
rc
;

134 
	}
}

136 
	$maš
() {

137 
i
, 
pÜŠo
;

138 
š_addr
 
¤c
,
de¡
;

139 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

140 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

141 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

142 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

143 
ušt16_t
 
¥Üt
 = 
CLIENT_START_PORT
;

144 
ušt32_t
 
dpÜt
 = 
SERVER_PORT
;

145 
i
=0;i<100;i++) {

146 
cout
<<"M­ Cl›Á…Üˆ"<<
¥Üt
+
i
<<"ØcÜ"<<
	`sym_hash_â
(
s
,
d
,¥Üt+i+
SEED
,
dpÜt
+SEED)%
NUM_CORES
<<
’dl
;

150 
	}
}

	@ip_in.cpp

1 
	~<¡ršg.h
>

2 
	~<Ãtš‘/.h
>

4 
	~"_š.h
"

5 
	~"tı_š.h
"

6 
	~"mtı_­i.h
"

7 
	~"ps.h
"

8 
	~"debug.h
"

9 
	~"icmp.h
"

11 
	#ETH_P_IP_FRAG
 0xF800

	)

12 
	#ETH_P_IPV6_FRAG
 0xF6DD

	)

16 
	$ProûssIPv4Pack‘
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

17 cÚ¡ 
ifidx
, * 
pkt_d©a
, 
Ën
)

20 
hdr
* 
h
 = (hd¸*)(
pkt_d©a
);

21 
_Ën
 = 
	`Áohs
(
h
->
tÙ_Ën
);

22 
rc
 = -1;

25 ià(
_Ën
 < (
hdr
))

26  
ERROR
;

28 #iâdeà
DISABLE_HWCSUM


29 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

30 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
ifidx
, 
PKT_RX_IP_CSUM
, 
h
);

31 ià(
rc
 =ğ-1 && 
	`_ç¡_csum
(
h
, iph->
ihl
))

32  
ERROR
;

34 
	`UNUSED
(
rc
);

35 ià(
	`_ç¡_csum
(
h
, iph->
ihl
))

36  
ERROR
;

39 #ià!
PROMISCUOUS_MODE


41 ià(
h
->
daddr
 !ğ
CONFIG
.
‘hs
[
ifidx
].
_addr
)

43  
TRUE
;

47 ià(
h
->
v”siÚ
 != 0x4 ) {

48 
mtı
->
iom
->
	`»Ëa£_pkt
(mtı->
ùx
, 
ifidx
, 
pkt_d©a
, 
Ën
);

49  
FALSE
;

52 
h
->
´ÙocŞ
) {

53 
IPPROTO_TCP
:

56  
	`ProûssTCPPack‘
(
mtı
, 
cur_ts
, 
ifidx
, 
h
, 
_Ën
);

57 
IPPROTO_ICMP
:

58  
	`ProûssICMPPack‘
(
mtı
, 
h
, 
_Ën
);

61  
FALSE
;

63  
FALSE
;

64 
	}
}

	@ip_out.cpp

1 
	~"_out.h
"

2 
	~"_š.h
"

3 
	~"‘h_out.h
"

4 
	~"¬p.h
"

5 
	~"debug.h
"

9 
	$G‘OuutIÁ”çû
(
ušt32_t
 
daddr
)

11 
nif
 = -1;

12 
i
;

13 
´efix
 = 0;

16 
i
 = 0; i < 
CONFIG
.
rou‹s
; i++) {

17 ià((
daddr
 & 
CONFIG
.
¹abË
[
i
].
mask
è=ğCONFIG.¹abË[i].
masked
) {

18 ià(
CONFIG
.
¹abË
[
i
].
´efix
 >…refix) {

19 
nif
 = 
CONFIG
.
¹abË
[
i
].nif;

20 
´efix
 = 
CONFIG
.
¹abË
[
i
].prefix;

25 ià(
nif
 < 0) {

26 
ušt8_t
 *
da
 = (ušt8_ˆ*)&
daddr
;

27 
	`TRACE_ERROR
("[WARNING] No„outeo %u.%u.%u.%u\n",

28 
da
[0], da[1], da[2], da[3]);

29 
	`as£¹
(0);

32  
nif
;

33 
	}
}

35 
ušt8_t
 *

36 
	$IPOuutSnd®Úe
(
mtı_mªag”
 *
mtı
, 
ušt8_t
 
´ÙocŞ
,

37 
ušt16_t
 
_id
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
, ušt16_ˆ
·ylßdËn
)

39 
hdr
 *
h
;

40 
nif
;

41 * 
haddr
;

42 
rc
 = -1;

61 
h
 = (
hdr
 *)
	`Eth”ÃtOuut
(
mtı
,

62 
ETH_P_IP
, 
nif
, 
haddr
, 
·ylßdËn
 + 
IP_HEADER_LEN
);

63 ià(!
h
) {

64  
NULL
;

67 
h
->
ihl
 = 
IP_HEADER_LEN
 >> 2;

68 
h
->
v”siÚ
 = 4;

69 
h
->
tos
 = 0;

70 
h
->
tÙ_Ën
 = 
	`htÚs
(
IP_HEADER_LEN
 + 
·ylßdËn
);

71 
h
->
id
 = 
	`htÚs
(
_id
);

72 
h
->
äag_off
 = 
	`htÚs
(
IP_DF
);

73 
h
->
‰l
 = 64;

74 
h
->
´ÙocŞ
 =…rotocol;

75 
h
->
§ddr
 = saddr;

76 
h
->
daddr
 = daddr;

77 
h
->
check
 = 0;

79 #iâdeà
DISABLE_HWCSUM


80 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

81 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
nif
, 
PKT_TX_TCPIP_CSUM_PEEK
, 
h
);

83 ià(
rc
 == -1)

84 
h
->
check
 = 
	`_ç¡_csum
(h, iph->
ihl
);

86 
	`UNUSED
(
rc
);

87 
h
->
check
 = 
	`_ç¡_csum
(h, iph->
ihl
);

90  (
ušt8_t
 *)(
h
 + 1);

91 
	}
}

93 
ušt8_t
 *

94 
	$IPOuut
(
mtı_mªag”
 *
mtı
, 
tı_¡»am
 *
¡»am
, 
ušt16_t
 
tıËn
)

96 
hdr
 *
h
;

97 
nif
;

98 *
haddr
;

99 
rc
 = -1;

122 
h
 = (
hdr
 *)
	`Eth”ÃtOuut
(
mtı
, 
ETH_P_IP
,

123 
¡»am
->
¢dv¬
->
nif_out
, 
haddr
, 
tıËn
 + 
IP_HEADER_LEN
);

124 ià(!
h
) {

125  
NULL
;

128 
h
->
ihl
 = 
IP_HEADER_LEN
 >> 2;

129 
h
->
v”siÚ
 = 4;

130 
h
->
tos
 = 0;

131 
h
->
tÙ_Ën
 = 
	`htÚs
(
IP_HEADER_LEN
 + 
tıËn
);

132 
h
->
id
 = 
	`htÚs
(
¡»am
->
¢dv¬
->
_id
++);

133 
h
->
äag_off
 = 
	`htÚs
(0x4000);

134 
h
->
‰l
 = 64;

135 
h
->
´ÙocŞ
 = 
IPPROTO_TCP
;

136 
h
->
§ddr
 = 
¡»am
->saddr;

137 
h
->
daddr
 = 
¡»am
->daddr;

138 
h
->
check
 = 0;

140 #iâdeà
DISABLE_HWCSUM


142 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

143 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
nif
, 
PKT_TX_TCPIP_CSUM_PEEK
, 
h
);

145 ià(
rc
 == -1)

146 
h
->
check
 = 
	`_ç¡_csum
(h, iph->
ihl
);

148 
	`UNUSED
(
rc
);

149 
h
->
check
 = 
	`_ç¡_csum
(h, iph->
ihl
);

151  (
ušt8_t
 *)(
h
 + 1);

152 
	}
}

	@logger.cpp

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<¡ršg.h
>

4 
	~<¡dlib.h
>

5 
	~<as£¹.h
>

6 
	~<”ºo.h
>

7 
	~<sys/queue.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sys/sock‘.h
>

10 
	~<±h»ad.h
>

11 
	~"ıu.h
"

12 
	~"debug.h
"

13 
	~"logg”.h
"

17 
	$EnqueueF»eBufãr
(
log_th»ad_cÚ‹xt
 *
ùx
, 
log_buff
 *
ä“_bp
)

19 
	`±h»ad_mu‹x_lock
(&
ùx
->
ä“_mu‹x
);

20 
	`TAILQ_INSERT_TAIL
(&
ùx
->
ä“_queue
, 
ä“_bp
, 
buff_lšk
);

21 
ùx
->
ä“_buff_út
++;

23 
	`as£¹
(
ùx
->
ä“_buff_út
 <ğ
NUM_LOG_BUFF
);

24 
	`as£¹
(
ùx
->
ä“_buff_út
 + ctx->
job_buff_út
 <ğ
NUM_LOG_BUFF
);

25 
	`±h»ad_mu‹x_uÆock
(&
ùx
->
ä“_mu‹x
);

26 
	}
}

28 
log_buff
*

29 
	$DequeueF»eBufãr
(
log_th»ad_cÚ‹xt
 *
ùx
)

31 
	`±h»ad_mu‹x_lock
(&
ùx
->
ä“_mu‹x
);

32 
log_buff
 *
ä“_bp
 = 
	`TAILQ_FIRST
(&
ùx
->
ä“_queue
);

33 ià(
ä“_bp
) {

34 
	`TAILQ_REMOVE
(&
ùx
->
ä“_queue
, 
ä“_bp
, 
buff_lšk
);

35 
ùx
->
ä“_buff_út
--;

38 
	`as£¹
(
ùx
->
ä“_buff_út
 >= 0);

39 
	`as£¹
(
ùx
->
ä“_buff_út
 + ctx->
job_buff_út
 <ğ
NUM_LOG_BUFF
);

40 
	`±h»ad_mu‹x_uÆock
(&
ùx
->
ä“_mu‹x
);

41  (
ä“_bp
);

42 
	}
}

45 
	$EnqueueJobBufãr
(
log_th»ad_cÚ‹xt
 *
ùx
, 
log_buff
 *
wÜkšg_bp
)

47 
	`TAILQ_INSERT_TAIL
(&
ùx
->
wÜkšg_queue
, 
wÜkšg_bp
, 
buff_lšk
);

48 
ùx
->
job_buff_út
++;

49 
ùx
->
¡©e
 = 
ACTIVE_LOGT
;

50 
	`as£¹
(
ùx
->
job_buff_út
 <ğ
NUM_LOG_BUFF
);

51 ià(
ùx
->
ä“_buff_út
 + ctx->
job_buff_út
 > 
NUM_LOG_BUFF
) {

52 
	`TRACE_ERROR
("free_buff_cnt(%d) + job_buff_cnt(%d) > NUM_LOG_BUFF(%d)\n",

53 
ùx
->
ä“_buff_út
, ctx->
job_buff_út
, 
NUM_LOG_BUFF
);

55 
	`as£¹
(
ùx
->
ä“_buff_út
 + ctx->
job_buff_út
 <ğ
NUM_LOG_BUFF
);

56 
	}
}

58 
log_buff
*

59 
	$DequeueJobBufãr
(
log_th»ad_cÚ‹xt
 *
ùx
)

61 
	`±h»ad_mu‹x_lock
(&
ùx
->
mu‹x
);

62 
log_buff
 *
wÜkšg_bp
 = 
	`TAILQ_FIRST
(&
ùx
->
wÜkšg_queue
);

63 ià(
wÜkšg_bp
) {

64 
	`TAILQ_REMOVE
(&
ùx
->
wÜkšg_queue
, 
wÜkšg_bp
, 
buff_lšk
);

65 
ùx
->
job_buff_út
--;

67 
ùx
->
¡©e
 = 
IDLE_LOGT
;

70 
	`as£¹
(
ùx
->
job_buff_út
 >= 0);

71 
	`as£¹
(
ùx
->
ä“_buff_út
 + ctx->
job_buff_út
 <ğ
NUM_LOG_BUFF
);

72 
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

73  (
wÜkšg_bp
);

74 
	}
}

77 
	$In™LogTh»adCÚ‹xt
(
log_th»ad_cÚ‹xt
 *
ùx
, 
ıu
)

79 
i
;

80 
sv
[2];

83 
	`mem£t
(
ùx
, 0, (
log_th»ad_cÚ‹xt
));

84 
ùx
->
ıu
 = cpu;

85 
ùx
->
¡©e
 = 
IDLE_LOGT
;

86 
ùx
->
dÚe
 = 0;

88 ià(
	`pe
(
sv
)) {

89 
	`årštf
(
¡d”r
, "pipe() failed,ƒrrno=%d,ƒrrstr=%s\n",

90 
”ºo
, 
	`¡»¼Ü
(errno));

91 
	`ex™
(1);

93 
ùx
->
¥_fd
 = 
sv
[0];

94 
ùx
->
·œ_¥_fd
 = 
sv
[1];

96 
	`±h»ad_mu‹x_š™
(&
ùx
->
mu‹x
, 
NULL
);

97 
	`±h»ad_mu‹x_š™
(&
ùx
->
ä“_mu‹x
, 
NULL
);

99 
	`TAILQ_INIT
(&
ùx
->
wÜkšg_queue
);

100 
	`TAILQ_INIT
(&
ùx
->
ä“_queue
);

103 
log_buff
 *
w_buff
 = 
	`m®loc
(Öog_buffè* 
NUM_LOG_BUFF
);

104 
	`as£¹
(
w_buff
);

105 
i
 = 0; i < 
NUM_LOG_BUFF
; i++) {

106 
	`EnqueueF»eBufãr
(
ùx
, &
w_buff
[
i
]);

108 
	}
}

111 
	$Th»adLogMaš
(* 
¬g
)

113 
size_t
 
Ën
;

114 
log_th»ad_cÚ‹xt
* 
ùx
 = (log_th»ad_cÚ‹xˆ*è
¬g
;

115 
log_buff
* 
w_buff
;

116 
út
;

118 
	`mtı_cÜe_affš™ize
(
ùx
->
ıu
);

122 
	`TRACE_LOG
("Logh»ad %d i ¡¬tšg.\n", 
ùx
->
ıu
);

124 !
ùx
->
dÚe
) {

126 
út
 = 0;

127 (
w_buff
 = 
	`DequeueJobBufãr
(
ùx
))){

128 ià(++
út
 > 
NUM_LOG_BUFF
) {

129 
	`TRACE_ERROR
("CPU %d: Exceed NUM_LOG_BUFF %d.\n",

130 
ùx
->
ıu
, 
út
);

133 
Ën
 = 
	`fwr™e
(
w_buff
->
buff
, 1, w_buff->
buff_Ën
, w_buff->
fid
);

134 ià(
Ën
 !ğ
w_buff
->
buff_Ën
) {

135 
	`TRACE_ERROR
("CPU %d: Triedo write %d, but only write %ld\n",

136 
ùx
->
ıu
, 
w_buff
->
buff_Ën
, 
Ën
);

139 
	`EnqueueF»eBufãr
(
ùx
, 
w_buff
);

143 
ùx
->
¡©e
 =ğ
IDLE_LOGT
 && !ùx->
dÚe
) {

144 
‹mp
[1];

145 
»t
 = 
	`»ad
(
ùx
->
¥_fd
, 
‹mp
, 1);

146 ià(
»t
)

151 
	`TRACE_LOG
("Logh»ad %d ouˆoàfœ¡†oİ.\n", 
ùx
->
ıu
);

153 
út
 = 0;

154 (
w_buff
 = 
	`DequeueJobBufãr
(
ùx
))){

155 ià(++
út
 > 
NUM_LOG_BUFF
) {

156 
	`TRACE_ERROR
("CPU %d: "

157 "Exûed NUM_LOG_BUFF %d iÀfš®†oİ.\n", 
ùx
->
ıu
, 
út
);

160 
Ën
 = 
	`fwr™e
(
w_buff
->
buff
, 1, w_buff->
buff_Ën
, w_buff->
fid
);

161 
	`as£¹
(
Ën
 =ğ
w_buff
->
buff_Ën
);

162 
	`EnqueueF»eBufãr
(
ùx
, 
w_buff
);

165 
	`TRACE_LOG
("Logh»ad %d fšished.\n", 
ùx
->
ıu
);

166 
	`±h»ad_ex™
(
NULL
);

168  
NULL
;

169 
	}
}

	@memory_mgt.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

6 
	~<sys/mmª.h
>

7 
	~<uni¡d.h
>

8 #ifdeà
HUGETABLE


9 
	~<hug‘lbfs.h
>

11 
	~"debug.h
"

12 
	~"memÜy_mgt.h
"

14 
	sg_mem_chunk


16 
	mmc_ä“_chunks
;

17 
g_mem_chunk
 *
	mmc_Ãxt
;

18 } 
	tmem_chunk
;

20 
mem_chunk
 *
	tmem_chunk_t
;

21 #ifdeà
HUGETABLE


22 ’um { 
	mMEM_NORMAL
, 
	mMEM_HUGEPAGE
};

25 
	smem_poŞ


27 
u_ch¬
 *
	mmp_¡¬Œ
;

28 
mem_chunk_t
 
	mmp_ä“±r
;

29 
	mmp_ä“_chunks
;

30 
	mmp_tÙ®_chunks
;

31 
	mmp_chunk_size
;

32 
	mmp_ty³
;

34 } 
	tmem_poŞ
;

36 
mem_poŞ
 *

37 
	$MPC»©e
(
chunk_size
, 
size_t
 
tÙ®_size
, 
is_hug•age
)

39 
mem_poŞ_t
 
mp
;

41 ià(
chunk_size
 < (
mem_chunk
)) {

42 
	`TRACE_ERROR
("The chunk size should be†argerhan %lu. current: %d\n",

43 (
mem_chunk
), 
chunk_size
);

44  
NULL
;

46 ià(
chunk_size
 % 4 != 0) {

47 
	`TRACE_ERROR
("The chunk size should be multiply of 4!\n");

48  
NULL
;

53 ià((
mp
 = 
	`ÿÎoc
(1, (
mem_poŞ
))è=ğ
NULL
) {

54 
	`³¼Ü
("calloc failed");

55 
	`ex™
(0);

57 
mp
->
mp_ty³
 = 
is_hug•age
;

58 
mp
->
mp_chunk_size
 = 
chunk_size
;

59 
mp
->
mp_ä“_chunks
 = ((
tÙ®_size
 + (
chunk_size
 -1))/chunk_size);

60 
mp
->
mp_tÙ®_chunks
 = mp->
mp_ä“_chunks
;

61 
tÙ®_size
 = 
chunk_size
 * ((
size_t
)
mp
->
mp_ä“_chunks
);

64 #ifdeà
HUGETABLE


65 ià(
is_hug•age
 =ğ
MEM_HUGEPAGE
) {

66 
mp
->
mp_¡¬Œ
 = 
	`g‘_huge_·ges
(
tÙ®_size
, 
NULL
);

67 ià(!
mp
->
mp_¡¬Œ
) {

68 
	`TRACE_ERROR
("posix_mem®igÀçed, size=%ld\n", 
tÙ®_size
);

69 
	`as£¹
(0);

70 ià(
mp
è
	`ä“
(mp);

71  (
NULL
);

75 
»s
 = 
	`posix_mem®ign
((**)&
mp
->
mp_¡¬Œ
, 
	`g‘·gesize
(), 
tÙ®_size
);

76 ià(
»s
 != 0) {

77 
	`TRACE_ERROR
("posix_mem®igÀçed, size=%ld\n", 
tÙ®_size
);

78 
	`as£¹
(0);

79 ià(
mp
è
	`ä“
(mp);

80  (
NULL
);

82 #ifdeà
HUGETABLE


87 ià(
	`g‘euid
() == 0) {

88 ià(
	`mlock
(
mp
->
mp_¡¬Œ
, 
tÙ®_size
) < 0)

89 
	`TRACE_ERROR
("m_lock faed, size=%ld\n", 
tÙ®_size
);

92 
mp
->
mp_ä“±r
 = (
mem_chunk_t
)mp->
mp_¡¬Œ
;

93 
mp
->
mp_ä“±r
->
mc_ä“_chunks
 = mp->
mp_ä“_chunks
;

94 
mp
->
mp_ä“±r
->
mc_Ãxt
 = 
NULL
;

96  
mp
;

97 
	}
}

100 
	$MPAÎoÿ‹Chunk
(
mem_poŞ_t
 
mp
)

102 
mem_chunk_t
 
p
 = 
mp
->
mp_ä“±r
;

104 ià(
mp
->
mp_ä“_chunks
 == 0)

105  (
NULL
);

106 
	`as£¹
(
p
->
mc_ä“_chunks
 > 0 &&…->mc_free_chunks <=…->mc_free_chunks);

108 
p
->
mc_ä“_chunks
--;

109 
mp
->
mp_ä“_chunks
--;

110 ià(
p
->
mc_ä“_chunks
) {

112 
mp
->
mp_ä“±r
 = (
mem_chunk_t
)((
u_ch¬
 *)
p
 + mp->
mp_chunk_size
);

113 
mp
->
mp_ä“±r
->
mc_ä“_chunks
 = 
p
->mc_free_chunks;

114 
mp
->
mp_ä“±r
->
mc_Ãxt
 = 
p
->mc_next;

117 
mp
->
mp_ä“±r
 = 
p
->
mc_Ãxt
;

120  
p
;

121 
	}
}

124 
	$MPF»eChunk
(
mem_poŞ_t
 
mp
, *
p
)

126 
mem_chunk_t
 
mı
 = (mem_chunk_t)
p
;

130 
	`as£¹
(((
u_ch¬
 *)
p
 - 
mp
->
mp_¡¬Œ
è% mp->
mp_chunk_size
 == 0);

134 
mı
->
mc_ä“_chunks
 = 1;

135 
mı
->
mc_Ãxt
 = 
mp
->
mp_ä“±r
;

136 
mp
->
mp_ä“±r
 = 
mı
;

137 
mp
->
mp_ä“_chunks
++;

138 
	}
}

141 
	$MPDe¡roy
(
mem_poŞ_t
 
mp
)

143 #ifdeà
HUGETABLE


144 if(
mp
->
mp_ty³
 =ğ
MEM_HUGEPAGE
) {

145 
	`ä“_huge_·ges
(
mp
->
mp_¡¬Œ
);

148 
	`ä“
(
mp
->
mp_¡¬Œ
);

149 #ifdeà
HUGETABLE


152 
	`ä“
(
mp
);

153 
	}
}

156 
	$MPG‘F»eChunks
(
mem_poŞ_t
 
mp
)

158  
mp
->
mp_ä“_chunks
;

159 
	}
}

161 
ušt32_t


162 
	$MPIsDªg”
(
mem_poŞ_t
 
mp
)

164 
	#DANGER_THREASHOLD
 0.95

	)

165 
	#SAFE_THREASHOLD
 0.90

	)

166 
ušt32_t
 
dªg”_num
 = 
mp
->
mp_tÙ®_chunks
 * 
DANGER_THREASHOLD
;

167 
ušt32_t
 
§ã_num
 = 
mp
->
mp_tÙ®_chunks
 * 
SAFE_THREASHOLD
;

168 ià(
dªg”_num
 < 
mp
->
mp_tÙ®_chunks
 - mp->
mp_ä“_chunks
) {

169  
mp
->
mp_tÙ®_chunks
 - mp->
mp_ä“_chunks
 - 
§ã_num
;

172 
	}
}

174 
ušt32_t


175 
	$MPIsOv”Saãlše
(
mem_poŞ_t
 
mp
)

177 
	#SAFELINE
 0.90

	)

178 
ušt32_t
 
§ã_num
 = 
mp
->
mp_tÙ®_chunks
 * 
SAFELINE
;

179 ià(
§ã_num
 < 
mp
->
mp_tÙ®_chunks
 - mp->
mp_ä“_chunks
) {

183 
	}
}

	@netmap_api.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

40 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

42 cÚ¡ 
ušt8_t
 
key
[] = {

54 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

55 (((
ušt32_t
)
key
[1]) << 16) |

56 (((
ušt32_t
)
key
[2]) << 8) |

57 ((
ušt32_t
)
key
[3]);

59 
ušt32_t
 
idx
 = 32;

60 
i
;

62 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

63 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

64 
ušt32_t
 
b™
;

66 
ÿche
[
i
] = 
»suÉ
;

67 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

69 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

71 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

122 
ušt32_t


123 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

125 
ušt32_t
 
rc
 = 0;

127 ià(
hash_¥l™
 == 2) {

128 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

129 
	`Áohl
(
h
->
_d¡
.
s_addr
),

130 
	`Áohs
(0xFFFDè+ 
£ed
,

131 
	`Áohs
(0xFFFEè+ 
£ed
);

133 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

144 
IPPROTO_IPIP
:

146 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

147 
hash_¥l™
, 
£ed
);

155  
rc
;

156 
	}
}

162 
ušt32_t


163 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

165 
ušt32_t
 
§ddr
, 
daddr
;

166 
ušt32_t
 
rc
 = 0;

169 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

170 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

171 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

172 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

173 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

174 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

175 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

176 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

178 ià(
hash_¥l™
 == 2) {

179 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

180 
	`Áohl
(
daddr
),

181 
	`Áohs
(0xFFFDè+ 
£ed
,

182 
	`Áohs
(0xFFFEè+ 
£ed
);

184 
tıhdr
 *
tıh
 = 
NULL
;

186 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

187 
IPPROTO_UDP
:

188 
IPPROTO_TCP
:

189 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

190 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

191 
	`Áohl
(
daddr
),

192 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

193 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

195 
IPPROTO_IPIP
:

197 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

198 
hash_¥l™
, 
£ed
);

200 
IPPROTO_IPV6
:

202 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

203 
hash_¥l™
, 
£ed
);

205 
IPPROTO_ICMP
:

206 
IPPROTO_GRE
:

207 
IPPROTO_ESP
:

208 
IPPROTO_PIM
:

209 
IPPROTO_IGMP
:

215 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

216 
	`Áohl
(
daddr
),

217 
	`Áohs
(0xFFFDè+ 
£ed
,

218 
	`Áohs
(0xFFFEè+ 
£ed
);

221  
rc
;

222 
	}
}

229 
ušt32_t


230 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

232 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

234 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

235 (
‘hh
->
‘h”_sho¡
[4] << 8) |

236 (
‘hh
->
‘h”_sho¡
[3] << 16) |

237 (
‘hh
->
‘h”_sho¡
[2] << 24);

238 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

239 (
‘hh
->
‘h”_dho¡
[4] << 8) |

240 (
‘hh
->
‘h”_dho¡
[3] << 16) |

241 (
‘hh
->
‘h”_dho¡
[2] << 24);

243 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

244 
	`Áohl
(
daddr
),

245 
	`Áohs
(0xFFFDè+ 
£ed
,

246 
	`Áohs
(0xFFFEè+ 
£ed
);

248  
rc
;

249 
	}
}

255 
šlše
 
ušt32_t


256 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

258 
ušt32_t
 
rc
 = 0;

259 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

261 
	`Áohs
(
vhdr
->
´Ùo
)) {

262 
ETHERTYPE_IP
:

263 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

264 
hash_¥l™
, 
£ed
);

266 
ETHERTYPE_IPV6
:

267 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

268 
hash_¥l™
, 
£ed
);

270 
ETHERTYPE_ARP
:

273 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

276  
rc
;

277 
	}
}

283 
ušt32_t


284 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

286 
rc
 = 0;

287 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

289 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

290 
ETHERTYPE_IP
:

291 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_IPV6
:

295 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

296 
hash_¥l™
, 
£ed
);

298 
ETHERTYPE_VLAN
:

299 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

301 
ETHERTYPE_ARP
:

304 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

308  
rc
;

309 
	}
}

313 
ušt16_t


314 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

316 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

317 
ušt32_t
 
i
;

320 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

321 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

322 ià(
sum
 > 0xFFFF)

323 
sum
 -= 0xFFFF;

330 ià(
i
 < 
Ën
) {

331 
sum
 +ğ
addr
[
i
] << 8;

332 ià(
sum
 > 0xFFFF)

333 
sum
 -= 0xFFFF;

335  
sum
;

336 
	}
}

338 
u_št16_t


339 
	$w¿psum
(
u_št32_t
 
sum
)

341 
sum
 = ~sum & 0xFFFF;

342  (
	`htÚs
(
sum
));

343 
	}
}

351 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

353 
i
;

354 
a
[18];

356 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

357 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

358 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

359  (
i
 < 17 ? 
NULL
 : (*)&
a
);

360 
	}
}

366 
	gN‘m­U£
::
	$N‘m­U£
() {

368 #iâdef 
OPT_FOR_SINGLE_CORE


370 
¬±abË
.
	`£t_em±y_key
(0);

371 
¬±abË
.
	`£t_d–‘ed_key
(1);

373 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

374 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

375 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

376 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

380 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

383 
	`sourû_hwaddr
(
IFNAME
);

387 
	`š™Ÿlize_£nd_»cv
();

390 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

391 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

393 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

394 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

397 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

398 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

400 
	}
}

407 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

409 
buf
[128];

410 
i
, 
j
, 
i0
;

411 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

415 
	`´štf
("ring %p cur %5d [len %5d]\n",

416 
ršg
, 
cur
, 
Ën
);

418 
i
 = 0; i < 
Ën
; ) {

419 
	`mem£t
(
buf
, (buf), ' ');

420 
	`¥rštf
(
buf
, "%5d: ", 
i
);

421 
i0
 = 
i
;

422 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

423 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

424 
i
 = 
i0
;

425 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

426 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

427 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

428 
	`´štf
("%s\n", 
buf
);

430 
	}
}

437 
	gN‘m­U£
::~
	$N‘m­U£
() {

438 
¿‹_time
;

439 
diff_time
;

440 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

441 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

442 
	`g‘timeofday
(&
’d_time
, 
NULL
);

444  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

445 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

448  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

449 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

453 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

454 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

455 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

456 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

458 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

459 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

460 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

461 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

463 #iâdeà
OPT_FOR_SINGLE_CORE


465 
£nd_th»ad
.
	`još
();

466 
»cv_th»ad
.
	`još
();

469 
	`¦“p
(5);

472 
cout
<<"Com¶‘ed"<<
’dl
;

473 
	}
}

480 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

482 
nm»q
 
»q
;

483 
”r
;

485 
	`mem£t
(&
»q
, 0, (req));

486 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

487 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

488 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

489 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

490 ià(
”r
) {

491 
	`D
("Unableo get virtio-net header†ength");

495 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

496 ià(
vœt_hdr_Ën
) {

497 
	`D
("Port„equires virtio-net header,†ength = %d",

498 
vœt_hdr_Ën
);

500 
	}
}

508 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

509 
i
, 
	gtÙ
 = 0;

510 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

513 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

514 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

515 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

517 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

520 !
	gq
->
	g¦Ùs
.
em±y
()) {

521 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

522 
	gq
->
	g¦Ùs
.
pİ
();

523 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

525 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

526 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

527 
	gtÙ
++;

531 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

539 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

540 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

541 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

542 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

544 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

545 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

546 
¬p_pkt
->
ah
.
hËn
 = 6;

547 
¬p_pkt
->
ah
.
¶’
 = 4;

548 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

550 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

551 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

553 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

554 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

555 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

557 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

559 
	}
}

569 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

570 
ušt16_t
 
i
;

572 #iâdef 
OPT_FOR_SINGLE_CORE


573 
£nd_ma¡”_nmd
 = 
NULL
;

574 
»cv_ma¡”_nmd
 = 
NULL
;

578 #if 
N_MINUS_2_CONFIG


579 if(
cÜes_avaabË
>=3) {

580 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

582 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

585 #–if 
N_MINUS_1_CONFIG


586 if(
cÜes_avaabË
>=2) {

587 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

589 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

592 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

596 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

597 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

599 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

600 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

602 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

603 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

604 
³r_cÜe_couÁs
[
i
] = 0;

606 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

607 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

608 
³r_cÜe_couÁr
[
i
] = 0;

611 #ifdef 
OPT_FOR_SINGLE_CORE


614 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

615 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

616 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

618 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

620 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

621 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

622 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

623 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

629 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

631 
ıu_£t_t
 
ıu_£t
;

633 
th»ad_cÜe1
, 
th»ad_cÜe2
;

634 
ušt16_t
 
j
;

636 #if 
N_MINUS_2_CONFIG


637 if(
cÜes_avaabË
 > 2) {

638 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

639 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

640 } if(
cÜes_avaabË
 == 2) {

641 
th»ad_cÜe1
 = 1;

642 
th»ad_cÜe2
 = 1;

644 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

646 #–if 
N_MINUS_1_CONFIG


647 if(
cÜes_avaabË
 > 1) {

648 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

649 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

651 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

654 if(
cÜes_avaabË
 > 1) {

655 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

656 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

658 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

662 
	`CPU_ZERO
(&
ıu_£t
);

663 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

664 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

665 if(
rc
!=0) {

666 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

669 
j
 = 0; j < 
CPU_SETSIZE
; j++)

670 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

671 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

675 
	`¦“p
(2);

677 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

679 
	`CPU_ZERO
(&
ıu_£t
);

680 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

681 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

682 if(
rc
!=0) {

683 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

686 
j
 = 0; j < 
CPU_SETSIZE
; j++)

687 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

688 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

692 
	}
}

699 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

700 #iâdeà
OPT_FOR_SINGLE_CORE


702 !
£nd_ma¡”_nmd
) {

703 
this_th»ad
::
	`y›ld
();

706 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

707 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

708 
nm»q
 
ba£_»q
;

709 
š‹rçû
[32];

710 
	`mem£t
(&
ba£_»q
, 0, (base_req));

711 #ifdeà
OPT_FOR_SINGLE_CORE


713 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
IFNAME
, 
cÜeid
);

714 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

716 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

717 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

719 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

720 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

721  
NULL
;

723 
	`D
("successfully opened core #%d %s (tx slots: %d)",

724 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

725 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

727 ià(
cÜeid
==0) {

728 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

729 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

733 
	`¥rštf
(
š‹rçû
, "%s}%d", 
SEND_PIPES_IFNAME
, 
cÜeid
);

734 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

735 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

737 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

738 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

739  
NULL
;

741 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

742 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

743 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

745 
	`D
("zerocopy %s",

746 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

750 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

755 
ušt16_t
 
n
;

756 
pŞlfd
 
pfd
;

757 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

758 
pfd
.
ev’ts
 = 
POLLOUT
;

759 
pfd
.
»v’ts
 = 0;

760 #ifdeà
BUSY_WAIT


761 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

762 
	`D
("ioctlƒrror on queue %d: %s", 0,

763 
	`¡»¼Ü
(
”ºo
));

764  
NULL
;

767 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

770 if(
do_abÜt
) {

771  
NULL
;

775 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

776 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

777 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

778  
NULL
;

781 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

782 ià(
n
 <ğ
MAX_BATCH_SEND
) {

783 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

785 
³r_cÜe_couÁs
[
cÜeid
] = 
MAX_BATCH_SEND
;

790 ià(
	`uÆik–y
(
do_abÜt
)) {

791  
NULL
;

793 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

794  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

796 
	}
}

808 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

809 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

810 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

811 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

812 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

814 #ifdeà
OPT_FOR_SINGLE_CORE


816 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

817 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

818 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

820 
‘h”_addr
 
‹mp_‘h_addr
;

822 ià(
	`lik–y
(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
))) {

824 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

826 
tı_pkt
 
t_p
;

827 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

828 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

830 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

832 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

833 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
));

834 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

836 ià(
‹mp__dp
 =ğ
‹mp_
) {

837 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

841 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

843 ià(
	`uÆik–y
(!
tx_buf
)) {

844 
	`D
("TXƒrror occurred");

847 
tx_buf
 -ğ(
‘h”_h—d”
);

849 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

850 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

852 
¦Ù
->
Ën
 = 
‹m¶’
;

854 
¦Ù
->
æags
 = 0;

855 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

857 --
³r_cÜe_couÁs
[
cÜeid
];

858 
¦Ù
->
æags
 |ğ
NS_REPORT
;

859 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

861 
ršg
->
h—d
 =„šg->
cur
;

862 
pŞlfd
 
pfd
;

863 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

864 
pfd
.
ev’ts
 = 
POLLOUT
;

865 
pfd
.
»v’ts
 = 0;

866 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

868 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

871 
™_dp
++;

874 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

875 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

876 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

877 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

878 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

879 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

880 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

882 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

885 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)(
tx_buf
 + 
vœt_hdr_Ën
));

886 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

887 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

888 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

889 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

890 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

891 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

892 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

894 
£nd_¬p_»q
 = 
çl£
;

898 ià(
	`lik–y
(
£nd_¬p_»q
)) {

899 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

900 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

901 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

903 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

904 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

905 
¦Ù
->
æags
 = 0;

906 
³r_cÜe_couÁs
[
cÜeid
] = 0;

908 
¦Ù
->
æags
 |ğ
NS_REPORT
;

910 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

912 
ršg
->
h—d
 =„šg->
cur
;

913 
pŞlfd
 
pfd
;

914 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

915 
pfd
.
ev’ts
 = 
POLLOUT
;

916 
pfd
.
»v’ts
 = 0;

917 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

923 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

924 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

927 if(
cÜeid
 == 0) {

928 
£nd_™”
++;

931 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

932 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

937 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

939 
¦Ù
->
æags
 = 0;

940 --
³r_cÜe_couÁs
[
cÜeid
];

941 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

942 
¦Ù
->
æags
 |ğ
NS_REPORT
;

944 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

946 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

947 
ršg
->
h—d
 =„šg->
cur
;

948 
pŞlfd
 
pfd
;

949 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

950 
pfd
.
ev’ts
 = 
POLLOUT
;

951 
pfd
.
»v’ts
 = 0;

952 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

954 
	}
}

966 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

967 #iâdeà
OPT_FOR_SINGLE_CORE


969 !
»cv_ma¡”_nmd
) {

970 
this_th»ad
::
	`y›ld
();

973 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

974 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

975 
nm»q
 
ba£_»q
;

976 
š‹rçû
[32];

977 
	`mem£t
(&
ba£_»q
, 0, (base_req));

979 #ifdeà
OPT_FOR_SINGLE_CORE


981 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
IFNAME
, 
cÜeid
);

982 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

984 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

985 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

987 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

988 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

989  
NULL
;

991 
	`D
("successfully opened core #%d %s (rx slots: %d)",

992 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

993 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

995 ià(
cÜeid
==0) {

996 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

997 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1001 
	`¥rštf
(
š‹rçû
, "%s}%d", 
RECV_PIPES_IFNAME
, 
cÜeid
);

1002 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1003 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1005 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1006 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1007  
NULL
;

1009 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1010 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1011 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1013 
	`D
("zerocopy %s",

1014 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1018 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

1020 #ifdeà
OPT_FOR_SINGLE_CORE


1023 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

1024 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

1026 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

1027 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1028 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1029 
‘h”_addr
 
‹mp_‘h_addr
;

1031 ià(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
)) {

1032 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1035 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1037 ià(
	`uÆik–y
(!
tx_buf
)) {

1038 
	`D
("TXƒrror occurred");

1041 
tx_buf
 =x_buà- (
‘h”_h—d”
);

1043 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1044 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1045 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1046 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1048 
¦Ù
->
Ën
 = 
‹m¶’
;

1050 
¦Ù
->
æags
 = 0;

1051 --
³r_cÜe_couÁs
[
cÜeid
];

1052 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1053 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1055 
ršg
->
h—d
 =„šg->
cur
;

1056 
pŞlfd
 
pfd
;

1057 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1058 
pfd
.
ev’ts
 = 
POLLOUT
;

1059 
pfd
.
»v’ts
 = 0;

1060 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1062 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1065 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

1066 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1067 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1069 
™
++;

1072 
	`g‘_bufãr_tx
(
cÜeid
);

1074 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1075 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1085 
ušt16_t
 
n
;

1086 
pŞlfd
 
pfd
;

1087 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1088 
pfd
.
ev’ts
 = 
POLLIN
;

1089 
pfd
.
»v’ts
 = 0;

1091 if(
	`uÆik–y
(
do_abÜt
)) {

1092  
NULL
;

1095 
ršg
->
h—d
 =„šg->
cur
;

1096 #ifdeà
BUSY_WAIT


1097 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1098 
	`D
("ioctlƒrror on queue %d: %s", 0,

1099 
	`¡»¼Ü
(
”ºo
));

1100  
NULL
;

1103 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1106 if(
	`uÆik–y
(
do_abÜt
)) {

1107  
NULL
;

1111 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1112 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1113 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1114  
NULL
;

1117 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1118 ià(
n
 <ğ
MAX_BATCH_RECV
) {

1119 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1121 
³r_cÜe_couÁr
[
cÜeid
] = 
MAX_BATCH_RECV
;

1123 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1124  
NULL
;

1127 #ifdeà
OPT_FOR_SINGLE_CORE


1128 
¡¬t
:

1130 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1132 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1133 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1134 #ifdeà
OPT_FOR_SINGLE_CORE


1137 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1138 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1140 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1141 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1142 
‘h”_addr
 
‹mp_eh
;

1143 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1144 
ušt32_t
 
£nd_
 = 
¬µkt
->
ah
.
£nd”_
;

1145 
¬±abË
.
	`š£¹
(
£nd_
, 
‹mp_eh
);

1146 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1150 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1152 ià(
	`uÆik–y
(!
tx_buf
)) {

1153 
	`D
("TXƒrror occurred");

1155 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1156 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1158 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1159 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1161 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1163 
¦Ù
->
æags
 = 0;

1164 --
³r_cÜe_couÁs
[
cÜeid
];

1165 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1166 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1168 
ršg
->
h—d
 =„šg->
cur
;

1169 
pŞlfd
 
pfd
;

1170 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1171 
pfd
.
ev’ts
 = 
POLLOUT
;

1172 
pfd
.
»v’ts
 = 0;

1173 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1179 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1180 
³r_cÜe_couÁr
[
cÜeid
]--;

1181 
pktcouÁ
++;

1182 
¡¬t
;

1186  (*)((*)
pkt
+(
‘h”_h—d”
));

1189  
NULL
;

1191 
	}
}

1198 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1200 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1202 #ifdeà
OPT_FOR_SINGLE_CORE


1203 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1204 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1207 if(
cÜeid
 == 0) {

1208 
»cv_™”
++;

1211 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1212 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1216 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1217 
³r_cÜe_couÁr
[
cÜeid
]--;

1218 
	}
}

1220 #iâdef 
OPT_FOR_SINGLE_CORE


1227 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1229 
£nd_th»ad_cÜe
;

1232 #if 
N_MINUS_2_CONFIG


1233 if(
cÜes_avaabË
 > 2) {

1234 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1235 } if(
cÜes_avaabË
 == 2) {

1236 
£nd_th»ad_cÜe
 = 1;

1238 
£nd_th»ad_cÜe
 = 0;

1240 #–if 
N_MINUS_1_CONFIG


1241 if(
cÜes_avaabË
 > 1) {

1242 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1244 
£nd_th»ad_cÜe
 = 0;

1247 if(
cÜes_avaabË
 > 1) {

1248 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1250 
£nd_th»ad_cÜe
 = 0;

1255 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1256 
this_th»ad
::
	`y›ld
();

1259 
ušt32_t
 
i
;

1260 
rv
;

1261 
veùÜ
<
pÜt_des
> 
pÜts
;

1262 
ušt64_t
 
™”
 = 0;

1263 
ušt32_t
 
Åes
;

1264 
pÜt_des
 *
rxpÜt
;

1265 
pÜt_des
 *
txpÜt
;

1267 
nm»q
 
ba£_»q
;

1268 
ušt32_t
 
exŒa_bufs
;

1269 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1270 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1271 
Ãtm­_ršg
 *
txršg
;

1272 
£nd_iâame
[
MAX_IFNAMELEN
];

1274 
	`¥rštf
(
£nd_iâame
, "%s/T", 
IFNAME
);

1276 
Åes
 = 
£nd_ouut_ršgs
;

1278 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1279 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1281 
	`D
("Åes:%u",
Åes
);

1283 
pÜts
.
	`»size
(
Åes
+2);

1285 
txpÜt
 = &
pÜts
[
Åes
];

1286 
rxpÜt
 = &
pÜts
[
Åes
+1];

1288 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1289 
	`D
("failedo‡llocatehe stats‡rray");

1290  
NULL
;

1293 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1296 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1297 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1299 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1300 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1301  
NULL
;

1303 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1304 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1307 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1309 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1310 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
SEND_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1312 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1313 
	`D
("ÿÂÙ o³À%s", 
SEND_PIPES_IFNAME
);

1314  
NULL
;

1316 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
SEND_PIPES_IFNAME
,

1317 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1321 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1322 
txršg
 = 
txpÜt
->
ršg
;

1323 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1325 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1327 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1330 
i
 = 0; i < 
Åes
; ++i) {

1331 
š‹rçû
[32];

1332 
	`¥rštf
(
š‹rçû
, "%s{%d", 
SEND_PIPES_IFNAME
, 
i
);

1333 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1334 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1336 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1337 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1338  
NULL
;

1340 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1341 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1342 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1344 
	`D
("zerocopy %s",

1345 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1348 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1350 
	`¦“p
(2);

1352 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1354 !
do_abÜt
) {

1355 
u_št
 
pŞlo
 = 0;

1357 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1358 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1361 
™”
++;

1364 
i
 = 0; i < 
Åes
; ++i) {

1365 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1366 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1370 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1371 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1372 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1373 
úts
[
pŞlo
] = 
i
;

1374 ++
pŞlo
;

1376 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1377 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1378 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1380 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1382 
‹mp_couÁ
;

1383 
boŞ
 
Ãed_æush
 = 
çl£
;

1384 
u_št
 
b©ch_cur
 = 0,
™emp
;

1388 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1390 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1391 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1392 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1393 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1394 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1398 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1403 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1404 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1405 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1406 
Ãed_æush
 = 
Œue
;

1408 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1412 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1413 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1414 
txršg
->
h—d
 =xršg->
cur
;

1418 #ifdeà
BUSY_WAIT


1419 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1420 
	`D
("ioctlƒrror on queue %d: %s", 0,

1421 
	`¡»¼Ü
(
”ºo
));

1422  
NULL
;

1425 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1426 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1427 
	`¡»¼Ü
(
”ºo
));

1428  
NULL
;

1430 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1431 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1432 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1433  
NULL
;

1436 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1437 ià(
n
 < 
b©ch_cur
)

1438 
b©ch_cur
 = 
n
;

1441 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1442 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1443 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1445 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1446 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1447 
tx¦Ù
->
æags
 = 0;

1448 
b©ch_cur
--;

1450 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1458 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1459 
Ãed_æush
 = 
Œue
;

1460 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1461 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1462 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1463 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1464 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1466 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1467 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1470 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1471 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1472 
txršg
->
h—d
 =xršg->
cur
;

1476 #ifdeà
BUSY_WAIT


1477 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1478 
	`D
("ioctlƒrror on queue %d: %s", 0,

1479 
	`¡»¼Ü
(
”ºo
));

1480  
NULL
;

1483 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1484 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1485 
	`¡»¼Ü
(
”ºo
));

1486  
NULL
;

1488 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1489 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1490 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1491  
NULL
;

1494 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1495 ià(
n
 < 
b©ch_cur
)

1496 
b©ch_cur
 = 
n
;

1499 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1500 *
tx_buf
 = (*è
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
è+ 
vœt_hdr_Ën
;

1502 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1503 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1504 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1505 
tx¦Ù
->
æags
 = 0;

1506 
b©ch_cur
--;

1508 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1510 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1511 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1513 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1515 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1516 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1517 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1519 
™
++;

1523 ià(
	`uÆik–y
(
Ãed_æush
)) {

1524 
b©ch_cur
 = 0;

1525 
txršg
->
h—d
 =xršg->
cur
;

1526 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1529 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1530 
³ndšg_¬p_»q_th
.
	`ş—r
();

1533 ià(
rv
 <= 0) {

1534 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1535 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1540 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1541 
i
 = 
úts
[
™emp
];

1542 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1543 
Ãxt_cur
 = 
ršg
->
cur
;

1544 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1545 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1546 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1547 if(
»cvcouÁ
>=
MAX_BATCH_RECV
) {

1548 
»cvcouÁ
 = 
MAX_BATCH_RECV
;

1550 
»cvcouÁ
--) {

1551 
u_št
 
n
;

1552 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1553 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1557 #ifdeà
BUSY_WAIT


1558 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1559 
	`D
("ioctlƒrror on queue %d: %s", 0,

1560 
	`¡»¼Ü
(
”ºo
));

1561  
NULL
;

1564 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1565 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1566 
	`¡»¼Ü
(
”ºo
));

1567  
NULL
;

1569 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1570 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1571 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1572  
NULL
;

1575 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1576 ià(
n
 < 
b©ch_cur
)

1577 
b©ch_cur
 = 
n
;

1580 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1581 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1582 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1583 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1584 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1585 
	`__butš_´eãtch
(
Ãxt_buf
);

1587 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1588 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1589 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1590 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1591 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1592 
pkthdr_rxpkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1596 
tx¦Ù
->
Ën
=
rs
->len;

1607 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1608 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1609 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1610 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1611 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1613 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)(
‹mpbuf
+
vœt_hdr_Ën
));

1614 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1615 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1616 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1618 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1619 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1620 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1621 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1623 
£nd_¬p_»q
 = 
çl£
;

1626 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1627 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1628 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1629 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1630 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1631 
tx¦Ù
->
æags
 = 0;

1633 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1635 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1637 
b©ch_cur
 = 0;

1638 
txršg
->
h—d
 =xršg->
cur
;

1639 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1645 
tx¦Ù
->
æags
 = 0;

1646 
b©ch_cur
--;

1648 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1649 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1651 ià(
b©ch_cur
==0 || 
tx¦Ù
->
Ën
 < 256) {

1652 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1654 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1655 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1656 
b©ch_cur
 = 0;

1657 
txršg
->
h—d
 =xršg->
cur
;

1658 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1661 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1666 
	`D
("Send 2");

1667 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1668 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1670 
	`D
("Send 3");

1672  
NULL
;

1673 
	}
}

1680 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1682 
»cv_th»ad_cÜe
;

1685 #if 
N_MINUS_2_CONFIG


1686 if(
cÜes_avaabË
 > 2) {

1687 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1688 } if(
cÜes_avaabË
 == 2) {

1689 
»cv_th»ad_cÜe
 = 1;

1691 
»cv_th»ad_cÜe
 = 0;

1693 #–if 
N_MINUS_1_CONFIG


1694 if(
cÜes_avaabË
 > 1) {

1695 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1697 
»cv_th»ad_cÜe
 = 0;

1700 if(
cÜes_avaabË
 > 1) {

1701 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1703 
»cv_th»ad_cÜe
 = 0;

1708 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1709 
this_th»ad
::
	`y›ld
();

1712 
ušt32_t
 
i
;

1713 
rv
;

1714 
veùÜ
<
pÜt_des
> 
pÜts
;

1715 
™”
 = 0;

1716 
ušt32_t
 
Åes
;

1717 
ov”æow_queue
 *
ä“q
;

1718 
pÜt_des
 *
rxpÜt
;

1719 
pÜt_des
 *
txpÜt
;

1721 
nm»q
 
ba£_»q
;

1722 
ušt32_t
 
exŒa_bufs
;

1723 
veùÜ
<
ov”æow_queue
> 
oq
;

1724 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1725 
»cv_iâame
[
MAX_IFNAMELEN
];

1727 
	`¥rštf
(
»cv_iâame
, "%s/R", 
IFNAME
);

1729 
Åes
 = 
»cv_ouut_ršgs
;

1730 
ä“q
 = 
NULL
;

1732 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1733 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1735 
	`D
("Åes:%u",
Åes
);

1737 
pÜts
.
	`»size
(
Åes
+2);

1742 
oq
.
	`»size
(
Åes
+1);

1743 ià(
oq
.
	`size
()!=
Åes
+1) {

1744 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1745  
NULL
;

1748 
rxpÜt
 = &
pÜts
[
Åes
];

1749 
txpÜt
 = &
pÜts
[
Åes
+1];

1751 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1752 
	`D
("failedo‡llocatehe stats‡rray");

1753  
NULL
;

1756 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1759 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1760 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1762 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1763 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1764  
NULL
;

1766 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1767 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1770 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1771 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1773 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1774 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1775 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1776 
txpÜt
->
nmd
 = 
	`nm_İ’
(
RECV_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1778 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1779 
	`D
("ÿÂÙ o³À%s", 
RECV_PIPES_IFNAME
);

1780  
NULL
;

1782 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
RECV_PIPES_IFNAME
,

1783 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1787 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1788 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1790 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1792 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1793 ià(!
exŒa_bufs
)

1794 
run
;

1796 
ä“q
 = &
oq
[
Åes
];

1797 
rxpÜt
->
oq
 = 
NULL
;

1798 
txpÜt
->
oq
 = 
ä“q
;

1800 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1807 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1808 
rv
;

1809 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1811 
Ãtm­_¦Ù
 
s
;

1812 
s
.
buf_idx
 = 
rv
;

1813 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1814 
ä“q
->
¦Ùs
.
	`push
(
s
);

1816 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1817 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1818 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1819  
NULL
;

1821 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1823 
run
:

1825 
i
 = 0; i < 
Åes
; ++i) {

1826 
š‹rçû
[32];

1827 
	`¥rštf
(
š‹rçû
, "%s{%d", 
RECV_PIPES_IFNAME
, 
i
);

1828 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1829 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1831 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1832 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1833  
NULL
;

1835 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1836 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1837 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1839 
	`D
("zerocopy %s",

1840 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1842 ià(
exŒa_bufs
) {

1843 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1844 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1845 
pÜts
[
i
].
oq
 = 
q
;

1849 ià(!
exŒa_bufs
) {

1850 ià(!
oq
.
	`em±y
()) {

1851 
i
 = 0; i < 
Åes
 + 1; i++) {

1852 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1853 
oq
[
i
].
¦Ùs
.
	`pİ
();

1855 
pÜts
[
i
].
oq
 = 
NULL
;

1857 
pÜts
[
i
].
oq
 = 
NULL
;

1858 
oq
.
	`ş—r
();

1860 
	`D
("*** overflow queues disabled ***");

1863 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1864 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1866 
	`¦“p
(2);

1868 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1870 !
do_abÜt
) {

1871 
u_št
 
pŞli
 = 0;

1873 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1874 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1877 
™”
++;

1880 
i
 = 0; i < 
Åes
; ++i) {

1881 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1882 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1886 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1887 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1888 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1889 ++
pŞli
;

1891 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1892 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1893 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1894 ++
pŞli
;

1896 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1897 ià(
rv
 <= 0) {

1898 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1899 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1903 ià(!
oq
.
	`em±y
()) {

1907 
i
 = 0; i < 
Åes
; i++) {

1908 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1909 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1910 
ušt32_t
 
j
, 
lim
;

1911 
Ãtm­_ršg
 *
ršg
;

1912 
Ãtm­_¦Ù
 *
¦Ù
;

1914 ià(
q
->
¦Ùs
.
	`em±y
())

1916 
ršg
 = 
p
->ring;

1917 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1918 ià(!
lim
)

1920 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1921 
lim
 = 
q
->
¦Ùs
.
	`size
();

1922 
j
 = 0; j < 
lim
; j++) {

1923 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1924 
q
->
¦Ùs
.
	`pİ
();

1925 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1926 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1927 *
¦Ù
 = 
s
;

1929 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1930 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1933 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1934 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1936 
ršg
->
h—d
 =„šg->
cur
;

1940 
b©ch_cur
 = 0;

1943 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1944 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1946 
Ãxt_cur
 = 
rxršg
->
cur
;

1947 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1948 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1949 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1950 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1951 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1953 
ršg¥aû
--) {

1954 
ov”æow_queue
 *
q
;

1955 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1956 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1957 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1959 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1960 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1962 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1963 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1964 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1967 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

1969 
_mac_·œ
 
‹mp_·œ
;

1970 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

1971 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1972 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

1975 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1976 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1977 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1978 
	`__butš_´eãtch
(
Ãxt_buf
);

1979 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1981 
b©ch_cur
++;

1982 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

1983 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1984 
b©ch_cur
 = 0;

1990 
ušt32_t
 
ouut_pÜt
 = 0;

1991 if(
»cv_th»ad_cÜe
) {

1992 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1993 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1997 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1998 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1999 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2000 
	`__butš_´eãtch
(
Ãxt_buf
);

2001 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

2002 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

2003 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

2006 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2007 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2008 *
cİy_buf
;

2009 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2010 
ts
->
Ën
 = 
rs
->len;

2011 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2013 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2015 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2016 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2019 
fÜw¬d
;

2023 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2024 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2025 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2027 
Ãxt
;

2030 
q
 = &
oq
[
ouut_pÜt
];

2032 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2034 
ušt32_t
 
j
;

2035 
pÜt_des
 *
Í
 = &
pÜts
[0];

2036 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2038 
j
 = 1; j < 
Åes
; j++) {

2039 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2040 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2041 
Í
 = 
ı
;

2042 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2047 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2048 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2049 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2050 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2053 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2054 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2057 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2060 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2061 
ä“q
->
¦Ùs
.
	`pİ
();

2064 *
‹mp_buf
;

2065 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2066 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2067 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2068 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2070 
fÜw¬d
:

2072 
Ãxt
:

2073 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2075 
b©ch_cur
++;

2076 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

2077 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2078 
b©ch_cur
 = 0;

2085 ià(
exŒa_bufs
) {

2086 
	`ä“_bufãrs
(
pÜts
);

2088 
	`D
("Recv 2");

2089 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2090 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2092 
	`D
("Recv 3");

2093  
NULL
;

2094 
	}
}

2104 
	gN‘m­U£
::
	$sourû_hwaddr
(cÚ¡ *
iâame
)

2106 
s
;

2107 
¤c__addr
[20];

2108 
iäeq
 
bufãr
;

2109 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2111 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2112 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2114 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2116 
	`şo£
(
s
);

2117 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2118 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2119 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2120 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2121 
fd
;

2122 
iäeq
 
iä
;

2124 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2127 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2130 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2132 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2134 
	`şo£
(
fd
);

2137 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2138 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2139 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2145 #iâdef 
OPT_FOR_SINGLE_CORE


2155 
	}
}

	@netmap_api_arp_alt.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

440 
¬±abË
.
	`£t_em±y_key
(0);

441 
¬±abË
.
	`£t_d–‘ed_key
(1);

443 #iâdef 
OPT_FOR_SINGLE_CORE


445 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

446 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

447 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

448 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

451 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

452 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

453 
	`sourû_hwaddr
(
iâame
);

454 
	`š™Ÿlize_£nd_»cv
();

456 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

457 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

459 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

460 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

463 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

464 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

467 #ifdef 
OPT_FOR_SINGLE_CORE


470 
£nd_™”
 = 
»cv_™”
 = 0;

473 
§ã_to_¡¬t_»cv
 = 
Œue
;

474 
	}
}

480 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

482 
buf
[128];

483 
i
, 
j
, 
i0
;

484 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

488 
	`´štf
("ring %p cur %5d [len %5d]\n",

489 
ršg
, 
cur
, 
Ën
);

491 
i
 = 0; i < 
Ën
; ) {

492 
	`mem£t
(
buf
, (buf), ' ');

493 
	`¥rštf
(
buf
, "%5d: ", 
i
);

494 
i0
 = 
i
;

495 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

496 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

497 
i
 = 
i0
;

498 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

499 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

500 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

501 
	`´štf
("%s\n", 
buf
);

503 
	}
}

505 
	gN‘m­U£
::~
	$N‘m­U£
() {

506 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

507 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

508 
	`g‘timeofday
(&
’d_time
, 
NULL
);

510  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

511 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

514  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

515 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

518 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

519 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

520 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

521 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

523 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

524 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

525 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

526 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

528 #iâdeà
OPT_FOR_SINGLE_CORE


529 
£nd_th»ad
.
	`još
();

530 
»cv_th»ad
.
	`još
();

536 
	`¦“p
(5);

542 
cout
<<"Com¶‘ed"<<
’dl
;

543 
	}
}

546 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

548 
nm»q
 
»q
;

549 
”r
;

551 
	`mem£t
(&
»q
, 0, (req));

552 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

553 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

554 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

555 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

556 ià(
”r
) {

557 
	`D
("Unableo get virtio-net header†ength");

561 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

562 ià(
vœt_hdr_Ën
) {

563 
	`D
("Port„equires virtio-net header,†ength = %d",

564 
vœt_hdr_Ën
);

566 
	}
}

569 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

571 #ifdef 
PRINT_STATS


572 #iâdef 
OPT_FOR_SINGLE_CORE


574 
ušt32_t
 
th»ad_cÜe
;

575 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

583 
Åes
 = 
»cv_ouut_ršgs
;

584 
sys_št
 = 0;

585 
my_ùrs
 
cur
, 
´ev
;

586 
b1
[40], 
b2
[40];

587 
my_ùrs
 *
pe_´ev
;

589 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

590 ià(
pe_´ev
 =ğ
NULL
) {

591 
	`D
("out of memory");

592 
	`ex™
(1);

595 
	`mem£t
(&
´ev
, 0, (prev));

596 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

597 !
do_abÜt
) {

598 
j
, 
dosy¦og
 = 0;

599 
ušt64_t
 
µs
, 
dps
, 
u£c
;

600 
my_ùrs
 
x
;

602 
	`mem£t
(&
cur
, 0, (cur));

603 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

605 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

606 
dosy¦og
 = 1;

607 
sys_št
 = 0;

610 
j
 = 0; j < 
Åes
; ++j) {

611 
pÜt_des
 *
p
 = &
pÜts
[
j
];

613 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

614 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

616 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

617 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

618 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

619 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

620 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

621 
pe_´ev
[
j
] = 
p
->
ùr
;

623 ià(
dosy¦og
) {

624 
	`sy¦og
(
LOG_INFO
,

629 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

632 
	`´štf
("\n");

642 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

643 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

644 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

645 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

646 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

647 
´ev
 = 
cur
;

650 
	`ä“
(
pe_´ev
);

651 
	`D
("Done");

654 
	}
}

657 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

658 
i
, 
	gtÙ
 = 0;

659 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

662 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

663 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

664 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

666 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

669 !
	gq
->
	g¦Ùs
.
em±y
()) {

670 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

671 
	gq
->
	g¦Ùs
.
pİ
();

672 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

674 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

675 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

676 
	gtÙ
++;

679 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

683 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

684 
ušt16_t
 
i
,
j
;

686 #ifdef 
PRINT_STATS


687 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

689 
£nd_ma¡”_nmd
 = 
NULL
;

690 
»cv_ma¡”_nmd
 = 
NULL
;

691 
§ã_to_¡¬t_»cv
 = 
çl£
;

692 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

693 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

694 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

695 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

697 #if 
N_MINUS_2_CONFIG


698 if(
cÜes_avaabË
>=3) {

699 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

701 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

704 #–if 
N_MINUS_1_CONFIG


705 if(
cÜes_avaabË
>=2) {

706 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

708 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

711 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

714 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

715 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

717 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

718 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

719 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

720 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

722 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

723 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

724 
³r_cÜe_couÁs
[
i
] = 0;

726 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

727 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

728 
³r_cÜe_couÁr
[
i
] = 0;

730 #iâdeà
OPT_FOR_SINGLE_CORE


731 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

733 
ıu_£t_t
 
ıu_£t
;

735 
th»ad_cÜe1
, 
th»ad_cÜe2
;

737 #if 
N_MINUS_2_CONFIG


738 if(
cÜes_avaabË
 > 2) {

739 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

740 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

741 } if(
cÜes_avaabË
 == 2) {

742 
th»ad_cÜe1
 = 1;

743 
th»ad_cÜe2
 = 1;

745 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

747 #–if 
N_MINUS_1_CONFIG


748 if(
cÜes_avaabË
 > 1) {

749 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

750 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

752 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

755 if(
cÜes_avaabË
 > 1) {

756 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

757 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

759 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

763 
	`CPU_ZERO
(&
ıu_£t
);

764 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

765 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

766 if(
rc
!=0) {

767 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

770 
j
 = 0; j < 
CPU_SETSIZE
; j++)

771 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

772 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

776 
	`¦“p
(2);

778 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

780 
	`CPU_ZERO
(&
ıu_£t
);

781 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

782 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

783 if(
rc
!=0) {

784 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

787 
j
 = 0; j < 
CPU_SETSIZE
; j++)

788 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

789 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

793 
	}
}

796 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

797 #iâdeà
OPT_FOR_SINGLE_CORE


798 !
£nd_ma¡”_nmd
) {

799 
this_th»ad
::
	`y›ld
();

802 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

803 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

804 
nm»q
 
ba£_»q
;

805 
š‹rçû
[32];

806 
	`mem£t
(&
ba£_»q
, 0, (base_req));

807 #ifdeà
OPT_FOR_SINGLE_CORE


808 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

809 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

811 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

812 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

814 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

815 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

816  
NULL
;

818 
	`D
("successfully opened core #%d %s (tx slots: %d)",

819 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

820 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

822 ià(
cÜeid
==0) {

823 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

824 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

827 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

828 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

829 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

831 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

832 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

833  
NULL
;

835 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

836 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

837 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

839 
	`D
("zerocopy %s",

840 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

843 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

847 
ušt16_t
 
n
;

848 
pŞlfd
 
pfd
;

849 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

850 
pfd
.
ev’ts
 = 
POLLOUT
;

851 
pfd
.
»v’ts
 = 0;

852 #ifdeà
BUSY_WAIT


853 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

854 
	`D
("ioctlƒrror on queue %d: %s", 0,

855 
	`¡»¼Ü
(
”ºo
));

856  
NULL
;

860 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

863 if(
do_abÜt
) {

864  
NULL
;

868 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

869 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

870 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

871  
NULL
;

874 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

875 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

876 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

878 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

881 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

882  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

883 
	}
}

886 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

887 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

888 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

889 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

891 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

892 
¦Ù
->
æags
 = 0;

894 #ifdeà
OPT_FOR_SINGLE_CORE


896 #ifdef 
PRINT_STATS


897 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

900 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

901 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

904 if(
cÜeid
 == 0) {

905 
£nd_™”
++;

908 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

909 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

912 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
.
s_addr
)!÷½bË.
	`’d
()) {

913 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
.
s_addr
], 6);

915 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

917 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

921 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

922 
¦Ù
->
æags
 |ğ
NS_REPORT
;

924 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

926 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

927 
ršg
->
h—d
 =„šg->
cur
;

928 
pŞlfd
 
pfd
;

929 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

930 
pfd
.
ev’ts
 = 
POLLOUT
;

931 
pfd
.
»v’ts
 = 0;

932 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

934 
	}
}

937 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

938 #iâdeà
OPT_FOR_SINGLE_CORE


939 !
»cv_ma¡”_nmd
) {

940 
this_th»ad
::
	`y›ld
();

943 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

944 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

945 
nm»q
 
ba£_»q
;

946 
š‹rçû
[32];

947 
	`mem£t
(&
ba£_»q
, 0, (base_req));

949 #ifdeà
OPT_FOR_SINGLE_CORE


950 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

951 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

953 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

954 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

956 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

957 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

958  
NULL
;

960 
	`D
("successfully opened core #%d %s (rx slots: %d)",

961 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

962 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

964 ià(
cÜeid
==0) {

965 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

966 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

969 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

970 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

971 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

973 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

974 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

975  
NULL
;

977 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

978 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

979 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

981 
	`D
("zerocopy %s",

982 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

986 
¡¬t
:

987 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

991 
ušt16_t
 
n
;

992 
pŞlfd
 
pfd
;

993 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

994 
pfd
.
ev’ts
 = 
POLLIN
;

995 
pfd
.
»v’ts
 = 0;

996 
ršg
->
h—d
 =„šg->
cur
;

997 #ifdeà
BUSY_WAIT


998 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

999 
	`D
("ioctlƒrror on queue %d: %s", 0,

1000 
	`¡»¼Ü
(
”ºo
));

1001  
NULL
;

1004 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1007 if(
do_abÜt
) {

1008  
NULL
;

1012 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1013 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1014 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1015  
NULL
;

1018 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1019 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1020 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1022 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1024 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1026 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1027 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1028 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1030 #ifdeà
OPT_FOR_SINGLE_CORE


1031 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1032 if(
ARP_ENABLED
) {

1033 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
.
s_addr
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1036 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1037 
³r_cÜe_couÁr
[
cÜeid
]--;

1038 
¡¬t
;

1041  (*)((*)
pkt
+(
‘h”_h—d”
));

1043  
NULL
;

1045 
	}
}

1048 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1050 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1052 #ifdeà
OPT_FOR_SINGLE_CORE


1054 #ifdef 
PRINT_STATS


1055 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1057 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1058 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1061 if(
cÜeid
 == 0) {

1062 
»cv_™”
++;

1065 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1066 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1070 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1071 
³r_cÜe_couÁr
[
cÜeid
]--;

1072 
	}
}

1074 #iâdef 
OPT_FOR_SINGLE_CORE


1077 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1079 
£nd_th»ad_cÜe
;

1081 #if 
N_MINUS_2_CONFIG


1082 if(
cÜes_avaabË
 > 2) {

1083 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1084 } if(
cÜes_avaabË
 == 2) {

1085 
£nd_th»ad_cÜe
 = 1;

1087 
£nd_th»ad_cÜe
 = 0;

1089 #–if 
N_MINUS_1_CONFIG


1090 if(
cÜes_avaabË
 > 1) {

1091 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1093 
£nd_th»ad_cÜe
 = 0;

1096 if(
cÜes_avaabË
 > 1) {

1097 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1099 
£nd_th»ad_cÜe
 = 0;

1103 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1104 
this_th»ad
::
	`y›ld
();

1107 
ušt32_t
 
i
;

1108 
rv
;

1109 
veùÜ
<
pÜt_des
> 
pÜts
;

1110 
ušt64_t
 
™”
 = 0;

1111 
ušt32_t
 
Åes
;

1112 
pÜt_des
 *
rxpÜt
;

1113 
pÜt_des
 *
txpÜt
;

1115 
nm»q
 
ba£_»q
;

1116 
ušt32_t
 
exŒa_bufs
;

1117 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1118 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1119 
Ãtm­_ršg
 *
txršg
;

1121 
Åes
 = 
£nd_ouut_ršgs
;

1123 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1124 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1126 
	`D
("Åes:%u",
Åes
);

1128 
pÜts
.
	`»size
(
Åes
+2);

1130 
txpÜt
 = &
pÜts
[
Åes
];

1131 
rxpÜt
 = &
pÜts
[
Åes
+1];

1133 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1134 
	`D
("failedo‡llocatehe stats‡rray");

1135  
NULL
;

1138 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1140 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1141 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1143 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1144 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1145  
NULL
;

1147 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1148 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1151 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1152 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1153 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1155 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1156 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1157 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1158 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1160 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1161 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1162  
NULL
;

1164 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1165 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1169 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1170 
txršg
 = 
txpÜt
->
ršg
;

1171 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1173 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1175 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1177 
i
 = 0; i < 
Åes
; ++i) {

1178 
š‹rçû
[32];

1179 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1180 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1181 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1183 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1184 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1185  
NULL
;

1187 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1188 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1189 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1191 
	`D
("zerocopy %s",

1192 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1195 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1196 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1198 
	`¦“p
(2);

1200 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1202 #ifdef 
PRINT_STATS


1203 
i
 = 0; i < 
Åes
+2; ++i) {

1204 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1227 
¬p_pkt
 
­_»q
, 
­_»s
;

1229 
	`memıy
(
­_»q
.
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1230 
	`memıy
(
­_»q
.
eh
.
‘h”_dho¡
, 
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

1231 
­_»q
.
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

1233 
	`memıy
(
­_»s
.
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1234 
­_»s
.
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

1236 
­_»q
.
ah
.
hty³
 = 
	`htÚs
 (1);

1237 
­_»q
.
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

1238 
­_»q
.
ah
.
hËn
 = 6;

1239 
­_»q
.
ah
.
¶’
 = 4;

1240 
­_»q
.
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REQUEST
);

1241 
	`memıy
(
­_»q
.
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1242 
­_»q
.
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

1243 
	`mem£t
 (
­_»q
.
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

1245 
­_»s
.
ah
.
hty³
 = 
	`htÚs
 (1);

1246 
­_»s
.
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

1247 
­_»s
.
ah
.
hËn
 = 6;

1248 
­_»s
.
ah
.
¶’
 = 4;

1249 
­_»s
.
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REPLY
);

1250 
	`memıy
(
­_»s
.
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1251 
­_»s
.
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

1253 !
do_abÜt
) {

1254 
u_št
 
pŞlo
 = 0;

1256 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1257 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1260 
™”
++;

1262 
i
 = 0; i < 
Åes
; ++i) {

1263 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1264 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1268 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1269 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1270 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1271 
úts
[
pŞlo
] = 
i
;

1272 ++
pŞlo
;

1274 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1275 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1276 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1278 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1290 
‹mp_couÁ
;

1291 
boŞ
 
Ãed_æush
 = 
çl£
;

1292 
b©ch_cur
 = 0,
™emp
;

1294 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1296 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1297 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1298 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1299 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1300 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1310 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1312 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1313 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1314 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1315 
Ãed_æush
 = 
Œue
;

1318 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1319 
­_»s
.
ah
.
rg‘_
 = 
’queued_¬p_»qs
[
i
];

1320 
	`memıy
(
­_»s
.
ah
.
rg‘_mac
, &
¬±abË
[
’queued_¬p_»qs
[
i
]], 6);

1321 
	`memıy
(
­_»s
.
eh
.
‘h”_dho¡
,‡p_»s.
ah
.
rg‘_mac
, 6);

1325 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1326 
b©ch_cur
 = 
£nd_b©ch
;

1327 
txršg
->
h—d
 =xršg->
cur
;

1331 #ifdeà
BUSY_WAIT


1332 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1333 
	`D
("ioctlƒrror on queue %d: %s", 0,

1334 
	`¡»¼Ü
(
”ºo
));

1335  
NULL
;

1338 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1339 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1340 
	`¡»¼Ü
(
”ºo
));

1341  
NULL
;

1343 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1344 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1345 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1346  
NULL
;

1349 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1350 ià(
n
 < 
b©ch_cur
)

1351 
b©ch_cur
 = 
n
;

1354 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1355 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1357 
	`nm_pkt_cİy
(&
­_»s
, 
tx_buf
 + 
vœt_hdr_Ën
, (
¬p_pkt
));

1359 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1360 
tx¦Ù
->
æags
 = 0;

1361 
b©ch_cur
--;

1367 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1377 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1378 
Ãed_æush
 = 
Œue
;

1379 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1381 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1384 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
è+ 
vœt_hdr_Ën
);

1385 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1386 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1388 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1389 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1392 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1393 
b©ch_cur
 = 
£nd_b©ch
;

1394 
txršg
->
h—d
 =xršg->
cur
;

1398 #ifdeà
BUSY_WAIT


1399 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1400 
	`D
("ioctlƒrror on queue %d: %s", 0,

1401 
	`¡»¼Ü
(
”ºo
));

1402  
NULL
;

1405 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1406 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1407 
	`¡»¼Ü
(
”ºo
));

1408  
NULL
;

1410 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1411 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1412 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1413  
NULL
;

1416 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1417 ià(
n
 < 
b©ch_cur
)

1418 
b©ch_cur
 = 
n
;

1421 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1422 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1424 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1425 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
);

1426 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1428 
tx¦Ù
->
æags
 = 0;

1429 
b©ch_cur
--;

1431 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1433 #ifdef 
PRINT_STATS


1434 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1436 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1437 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1442 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1448 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1449 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1450 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1452 
™
++;

1456 ià(
	`uÆik–y
(
Ãed_æush
)) {

1458 
b©ch_cur
 = 0;

1459 
txršg
->
h—d
 =xršg->
cur
;

1460 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1463 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1465 
³ndšg_¬p_»q_th
.
	`ş—r
();

1470 ià(
rv
 <= 0) {

1471 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1472 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1477 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1478 
i
 = 
úts
[
™emp
];

1479 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1481 
Ãxt_cur
 = 
ršg
->
cur
;

1482 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1483 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1484 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1485 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1486 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1489 
»cvcouÁ
--) {

1490 
tİ
:

1491 
n
;

1492 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1493 
b©ch_cur
 = 
£nd_b©ch
;

1497 #ifdeà
BUSY_WAIT


1498 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1499 
	`D
("ioctlƒrror on queue %d: %s", 0,

1500 
	`¡»¼Ü
(
”ºo
));

1501  
NULL
;

1504 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1505 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1506 
	`¡»¼Ü
(
”ºo
));

1507  
NULL
;

1509 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1510 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1511 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1512  
NULL
;

1515 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1516 ià(
n
 < 
b©ch_cur
)

1517 
b©ch_cur
 = 
n
;

1520 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1521 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1522 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1523 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1524 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1525 
	`__butš_´eãtch
(
Ãxt_buf
);

1527 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1528 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1529 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1530 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1531 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1532 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1536 
tx¦Ù
->
Ën
=
rs
->len;

1556 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1557 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1559 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1561 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1562 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1567 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)
‹mpbuf
);

1568 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1571 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1572 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1575 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1576 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1577 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1578 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1580 
£nd_¬p_»q
 = 
çl£
;

1583 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1584 
­_»q
.
ah
.
rg‘_
 = 
‹mp_
;

1585 
	`nm_pkt_cİy
(&
­_»q
, 
tx_buf
 + 
vœt_hdr_Ën
, (
¬p_pkt
));

1586 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1588 
tx¦Ù
->
æags
 = 0;

1590 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1592 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1594 
b©ch_cur
 = 0;

1595 
txršg
->
h—d
 =xršg->
cur
;

1596 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1605 
tx¦Ù
->
æags
 = 0;

1606 
b©ch_cur
--;

1607 #ifdef 
PRINT_STATS


1608 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1610 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1611 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1613 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1614 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1616 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1617 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1619 
txršg
->
h—d
 =xršg->
cur
;

1620 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1623 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1628 
	`¦“p
(5);

1629 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1630 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1633  
NULL
;

1634 
	}
}

1637 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1639 
»cv_th»ad_cÜe
;

1641 #if 
N_MINUS_2_CONFIG


1642 if(
cÜes_avaabË
 > 2) {

1643 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1644 } if(
cÜes_avaabË
 == 2) {

1645 
»cv_th»ad_cÜe
 = 1;

1647 
»cv_th»ad_cÜe
 = 0;

1649 #–if 
N_MINUS_1_CONFIG


1650 if(
cÜes_avaabË
 > 1) {

1651 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1653 
»cv_th»ad_cÜe
 = 0;

1656 if(
cÜes_avaabË
 > 1) {

1657 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1659 
»cv_th»ad_cÜe
 = 0;

1663 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1664 
this_th»ad
::
	`y›ld
();

1667 
ušt32_t
 
i
;

1668 
rv
;

1669 
veùÜ
<
pÜt_des
> 
pÜts
;

1670 
™”
 = 0;

1671 
ušt32_t
 
Åes
;

1672 
ov”æow_queue
 *
ä“q
;

1673 
pÜt_des
 *
rxpÜt
;

1674 
pÜt_des
 *
txpÜt
;

1676 
nm»q
 
ba£_»q
;

1677 
ušt32_t
 
exŒa_bufs
;

1678 
veùÜ
<
ov”æow_queue
> 
oq
;

1679 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1681 
Åes
 = 
»cv_ouut_ršgs
;

1682 
ä“q
 = 
NULL
;

1684 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1685 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1687 
	`D
("Åes:%u",
Åes
);

1689 
pÜts
.
	`»size
(
Åes
+2);

1694 
oq
.
	`»size
(
Åes
+1);

1695 ià(
oq
.
	`size
()!=
Åes
+1) {

1696 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1697  
NULL
;

1700 
rxpÜt
 = &
pÜts
[
Åes
];

1701 
txpÜt
 = &
pÜts
[
Åes
+1];

1703 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1704 
	`D
("failedo‡llocatehe stats‡rray");

1705  
NULL
;

1708 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1710 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1711 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1713 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1714 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1715  
NULL
;

1717 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1718 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1721 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1722 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1723 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1725 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1726 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1727 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1728 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1730 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1731 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1732  
NULL
;

1734 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1735 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1739 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1740 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1742 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1744 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1745 ià(!
exŒa_bufs
)

1746 
run
;

1748 
ä“q
 = &
oq
[
Åes
];

1749 
rxpÜt
->
oq
 = 
NULL
;

1750 
txpÜt
->
oq
 = 
ä“q
;

1752 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1758 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1759 
rv
;

1760 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1762 
Ãtm­_¦Ù
 
s
;

1763 
s
.
buf_idx
 = 
rv
;

1764 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1765 
ä“q
->
¦Ùs
.
	`push
(
s
);

1767 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1768 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1769 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1770  
NULL
;

1772 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1774 
run
:

1775 
i
 = 0; i < 
Åes
; ++i) {

1776 
š‹rçû
[32];

1777 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1778 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1779 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1781 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1782 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1783  
NULL
;

1785 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1786 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1787 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1789 
	`D
("zerocopy %s",

1790 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1792 ià(
exŒa_bufs
) {

1793 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1794 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1795 
pÜts
[
i
].
oq
 = 
q
;

1799 ià(!
exŒa_bufs
) {

1800 ià(!
oq
.
	`em±y
()) {

1801 
i
 = 0; i < 
Åes
 + 1; i++) {

1802 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1803 
oq
[
i
].
¦Ùs
.
	`pİ
();

1805 
pÜts
[
i
].
oq
 = 
NULL
;

1807 
pÜts
[
i
].
oq
 = 
NULL
;

1808 
oq
.
	`ş—r
();

1810 
	`D
("*** overflow queues disabled ***");

1813 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1814 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1816 
	`¦“p
(2);

1818 !
§ã_to_¡¬t_»cv
) {

1819 
this_th»ad
::
	`y›ld
();

1822 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1824 #ifdef 
PRINT_STATS


1825 
i
 = 0; i < 
Åes
+2; ++i) {

1826 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1849 !
do_abÜt
) {

1850 
u_št
 
pŞli
 = 0;

1852 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1853 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1856 
™”
++;

1857 
i
 = 0; i < 
Åes
; ++i) {

1858 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1859 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1863 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1864 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1865 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1866 ++
pŞli
;

1868 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1869 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1870 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1871 ++
pŞli
;

1873 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1874 ià(
rv
 <= 0) {

1875 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1876 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1880 ià(!
oq
.
	`em±y
()) {

1884 
i
 = 0; i < 
Åes
; i++) {

1885 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1886 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1887 
ušt32_t
 
j
, 
lim
;

1888 
Ãtm­_ršg
 *
ršg
;

1889 
Ãtm­_¦Ù
 *
¦Ù
;

1891 ià(
q
->
¦Ùs
.
	`em±y
())

1893 
ršg
 = 
p
->ring;

1894 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1895 ià(!
lim
)

1897 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1898 
lim
 = 
q
->
¦Ùs
.
	`size
();

1899 
j
 = 0; j < 
lim
; j++) {

1900 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1901 
q
->
¦Ùs
.
	`pİ
();

1902 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1903 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1904 *
¦Ù
 = 
s
;

1905 #ifdef 
PRINT_STATS


1906 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1908 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1909 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1911 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1912 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1914 
ršg
->
h—d
 =„šg->
cur
;

1918 
b©ch_cur
 = 0;

1919 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1920 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1922 
Ãxt_cur
 = 
rxršg
->
cur
;

1923 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1924 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1925 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1926 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1927 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1929 
ršg¥aû
--) {

1930 
ov”æow_queue
 *
q
;

1931 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1932 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1933 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1935 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1937 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1938 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1940 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1942 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1944 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

1946 
_mac_·œ
 
‹mp_·œ
;

1947 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

1948 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1949 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

1952 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1953 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1954 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1955 
	`__butš_´eãtch
(
Ãxt_buf
);

1956 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1958 
b©ch_cur
++;

1959 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1960 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1961 
b©ch_cur
 = 0;

1984 
ušt32_t
 
ouut_pÜt
 = 0;

1985 if(
»cv_th»ad_cÜe
) {

1986 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1987 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1990 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1991 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1992 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1993 
	`__butš_´eãtch
(
Ãxt_buf
);

1994 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1995 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1996 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1999 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2000 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2001 *
cİy_buf
;

2002 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2003 
ts
->
Ën
 = 
rs
->len;

2004 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2006 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2008 #ifdef 
PRINT_STATS


2009 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2012 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2013 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2016 
fÜw¬d
;

2020 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2021 #ifdef 
PRINT_STATS


2022 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2024 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2025 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2027 
Ãxt
;

2030 
q
 = &
oq
[
ouut_pÜt
];

2032 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2034 
ušt32_t
 
j
;

2035 
pÜt_des
 *
Í
 = &
pÜts
[0];

2036 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2038 
j
 = 1; j < 
Åes
; j++) {

2039 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2040 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2041 
Í
 = 
ı
;

2042 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2047 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2048 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2049 #ifdef 
PRINT_STATS


2050 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2052 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2053 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2056 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2057 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2060 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2063 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2064 
ä“q
->
¦Ùs
.
	`pİ
();

2066 *
‹mp_buf
;

2067 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2068 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2069 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2070 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2072 
fÜw¬d
:

2074 
Ãxt
:

2075 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2077 
b©ch_cur
++;

2078 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2079 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2080 
b©ch_cur
 = 0;

2087 ià(
exŒa_bufs
) {

2088 
	`ä“_bufãrs
(
pÜts
);

2090 
	`¦“p
(5);

2091 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2092 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2095  
NULL
;

2096 
	}
}

2102 
u_št16_t


2103 
	$w¿psum
(
u_št32_t
 
sum
)

2105 
sum
 = ~sum & 0xFFFF;

2106  (
	`htÚs
(
sum
));

2107 
	}
}

2110 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2112 
s
;

2113 
iäeq
 
bufãr
;

2114 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2116 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2117 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2119 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2121 
	`şo£
(
s
);

2122 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2123 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2124 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2125 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2126 
fd
;

2127 
iäeq
 
iä
;

2129 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2132 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2135 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2137 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2139 
	`şo£
(
fd
);

2142 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2143 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2144 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2147 
¬±abË
[
¤c_
.
s_addr
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2148 if(
¬±abË
.
	`fšd
(
¤c_
.
s_addr
)!÷½bË.
	`’d
()) {

2149 
	`D
("Hurray 1");

2152 
š_addr
 
©t
;

2153 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2156 if(
¬±abË
.
	`fšd
(
©t
.
s_addr
)!÷½bË.
	`’d
()) {

2157 
	`D
("Hurray 2");

2158 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
.
s_addr
]));

2161 
	}
}

	@netmap_api_arp_tested.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

440 
¬±abË
.
	`£t_em±y_key
(0);

441 
¬±abË
.
	`£t_d–‘ed_key
(1);

443 #iâdef 
OPT_FOR_SINGLE_CORE


445 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

446 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

447 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

448 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth4");

453 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

454 
	`sourû_hwaddr
(
iâame
);

455 
	`š™Ÿlize_£nd_»cv
();

457 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

458 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

460 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

461 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

464 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

465 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

468 #ifdef 
OPT_FOR_SINGLE_CORE


471 
£nd_™”
 = 
»cv_™”
 = 0;

474 
§ã_to_¡¬t_»cv
 = 
Œue
;

475 
	}
}

481 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

483 
buf
[128];

484 
i
, 
j
, 
i0
;

485 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

489 
	`´štf
("ring %p cur %5d [len %5d]\n",

490 
ršg
, 
cur
, 
Ën
);

492 
i
 = 0; i < 
Ën
; ) {

493 
	`mem£t
(
buf
, (buf), ' ');

494 
	`¥rštf
(
buf
, "%5d: ", 
i
);

495 
i0
 = 
i
;

496 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

497 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

498 
i
 = 
i0
;

499 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

500 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

501 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

502 
	`´štf
("%s\n", 
buf
);

504 
	}
}

506 
	gN‘m­U£
::~
	$N‘m­U£
() {

507 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

508 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

509 
	`g‘timeofday
(&
’d_time
, 
NULL
);

511  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

512 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

515  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

516 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

519 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

520 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

521 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

522 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

524 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

525 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

526 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

527 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

529 #iâdeà
OPT_FOR_SINGLE_CORE


530 
£nd_th»ad
.
	`još
();

531 
»cv_th»ad
.
	`još
();

537 
	`¦“p
(5);

543 
cout
<<"Com¶‘ed"<<
’dl
;

544 
	}
}

547 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

549 
nm»q
 
»q
;

550 
”r
;

552 
	`mem£t
(&
»q
, 0, (req));

553 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

554 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

555 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

556 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

557 ià(
”r
) {

558 
	`D
("Unableo get virtio-net header†ength");

562 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

563 ià(
vœt_hdr_Ën
) {

564 
	`D
("Port„equires virtio-net header,†ength = %d",

565 
vœt_hdr_Ën
);

567 
	}
}

570 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

572 #ifdef 
PRINT_STATS


573 #iâdef 
OPT_FOR_SINGLE_CORE


575 
ušt32_t
 
th»ad_cÜe
;

576 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

584 
Åes
 = 
»cv_ouut_ršgs
;

585 
sys_št
 = 0;

586 
my_ùrs
 
cur
, 
´ev
;

587 
b1
[40], 
b2
[40];

588 
my_ùrs
 *
pe_´ev
;

590 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

591 ià(
pe_´ev
 =ğ
NULL
) {

592 
	`D
("out of memory");

593 
	`ex™
(1);

596 
	`mem£t
(&
´ev
, 0, (prev));

597 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

598 !
do_abÜt
) {

599 
j
, 
dosy¦og
 = 0;

600 
ušt64_t
 
µs
, 
dps
, 
u£c
;

601 
my_ùrs
 
x
;

603 
	`mem£t
(&
cur
, 0, (cur));

604 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

606 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

607 
dosy¦og
 = 1;

608 
sys_št
 = 0;

611 
j
 = 0; j < 
Åes
; ++j) {

612 
pÜt_des
 *
p
 = &
pÜts
[
j
];

614 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

615 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

617 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

618 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

619 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

620 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

621 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

622 
pe_´ev
[
j
] = 
p
->
ùr
;

624 ià(
dosy¦og
) {

625 
	`sy¦og
(
LOG_INFO
,

630 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

633 
	`´štf
("\n");

643 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

644 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

645 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

646 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

647 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

648 
´ev
 = 
cur
;

651 
	`ä“
(
pe_´ev
);

652 
	`D
("Done");

655 
	}
}

658 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

659 
i
, 
	gtÙ
 = 0;

660 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

663 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

664 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

665 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

667 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

670 !
	gq
->
	g¦Ùs
.
em±y
()) {

671 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

672 
	gq
->
	g¦Ùs
.
pİ
();

673 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

675 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

676 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

677 
	gtÙ
++;

680 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

684 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

685 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

686 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

687 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

689 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

690 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

691 
¬p_pkt
->
ah
.
hËn
 = 6;

692 
¬p_pkt
->
ah
.
¶’
 = 4;

693 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

695 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

696 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

698 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

699 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

700 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

702 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

704 
	}
}

707 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

708 
ušt16_t
 
i
,
j
;

710 #ifdef 
PRINT_STATS


711 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

713 
£nd_ma¡”_nmd
 = 
NULL
;

714 
»cv_ma¡”_nmd
 = 
NULL
;

715 
§ã_to_¡¬t_»cv
 = 
çl£
;

716 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

717 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

718 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

719 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

721 #if 
N_MINUS_2_CONFIG


722 if(
cÜes_avaabË
>=3) {

723 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

725 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

728 #–if 
N_MINUS_1_CONFIG


729 if(
cÜes_avaabË
>=2) {

730 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

732 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

735 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

738 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

739 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

741 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

742 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

743 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

744 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

746 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

747 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

748 
³r_cÜe_couÁs
[
i
] = 0;

750 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

751 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

752 
³r_cÜe_couÁr
[
i
] = 0;

755 #ifdef 
OPT_FOR_SINGLE_CORE


757 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

758 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

759 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

761 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

763 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

764 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

765 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

766 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

772 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

774 
ıu_£t_t
 
ıu_£t
;

776 
th»ad_cÜe1
, 
th»ad_cÜe2
;

778 #if 
N_MINUS_2_CONFIG


779 if(
cÜes_avaabË
 > 2) {

780 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

781 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

782 } if(
cÜes_avaabË
 == 2) {

783 
th»ad_cÜe1
 = 1;

784 
th»ad_cÜe2
 = 1;

786 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

788 #–if 
N_MINUS_1_CONFIG


789 if(
cÜes_avaabË
 > 1) {

790 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

791 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

793 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

796 if(
cÜes_avaabË
 > 1) {

797 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

798 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

800 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

804 
	`CPU_ZERO
(&
ıu_£t
);

805 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

806 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

807 if(
rc
!=0) {

808 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

811 
j
 = 0; j < 
CPU_SETSIZE
; j++)

812 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

813 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

817 
	`¦“p
(2);

819 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

821 
	`CPU_ZERO
(&
ıu_£t
);

822 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

823 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

824 if(
rc
!=0) {

825 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

828 
j
 = 0; j < 
CPU_SETSIZE
; j++)

829 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

830 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

834 
	}
}

839 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

840 #iâdeà
OPT_FOR_SINGLE_CORE


841 !
£nd_ma¡”_nmd
) {

842 
this_th»ad
::
	`y›ld
();

845 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

846 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

847 
nm»q
 
ba£_»q
;

848 
š‹rçû
[32];

849 
	`mem£t
(&
ba£_»q
, 0, (base_req));

850 #ifdeà
OPT_FOR_SINGLE_CORE


851 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

852 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

854 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

855 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

857 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

858 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

859  
NULL
;

861 
	`D
("successfully opened core #%d %s (tx slots: %d)",

862 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

863 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

865 ià(
cÜeid
==0) {

866 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

867 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

870 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

871 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

872 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

874 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

875 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

876  
NULL
;

878 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

879 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

880 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

882 
	`D
("zerocopy %s",

883 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

887 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

891 
ušt16_t
 
n
;

892 
pŞlfd
 
pfd
;

893 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

894 
pfd
.
ev’ts
 = 
POLLOUT
;

895 
pfd
.
»v’ts
 = 0;

896 #ifdeà
BUSY_WAIT


897 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

898 
	`D
("ioctlƒrror on queue %d: %s", 0,

899 
	`¡»¼Ü
(
”ºo
));

900  
NULL
;

904 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

907 if(
do_abÜt
) {

908  
NULL
;

912 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

913 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

914 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

915  
NULL
;

918 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

919 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

920 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

922 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

926 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

927  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

928 
	}
}

931 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

932 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

933 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

934 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

935 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

938 #ifdeà
OPT_FOR_SINGLE_CORE


940 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

941 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

942 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

944 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

947 ià(
	`lik–y
(
™
 !ğ
¬±abË
.
	`’d
())) {

948 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

950 
tı_pkt
 
t_p
;

951 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

952 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

954 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

958 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

961 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
è+ 
vœt_hdr_Ën
);

962 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

964 ià(
‹mp__dp
 =ğ
‹mp_
) {

965 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

968 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

970 ià(
	`uÆik–y
(!
tx_buf
)) {

971 
	`D
("TXƒrror occurred");

974 
tx_buf
 -ğ((
‘h”_h—d”
)+
vœt_hdr_Ën
);

976 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

977 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
);

980 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

982 
¦Ù
->
æags
 = 0;

985 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

987 --
³r_cÜe_couÁs
[
cÜeid
];

988 
¦Ù
->
æags
 |ğ
NS_REPORT
;

989 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

991 
ršg
->
h—d
 =„šg->
cur
;

992 
pŞlfd
 
pfd
;

993 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

994 
pfd
.
ev’ts
 = 
POLLOUT
;

995 
pfd
.
»v’ts
 = 0;

996 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

998 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

1001 
™_dp
++;

1003 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

1004 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1005 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1006 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1007 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1008 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

1009 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

1012 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1015 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)
tx_buf
);

1016 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

1018 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1019 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

1020 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

1021 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

1022 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

1023 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

1025 
£nd_¬p_»q
 = 
çl£
;

1028 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1031 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

1032 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1033 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1035 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1036 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1038 
¦Ù
->
æags
 = 0;

1039 
³r_cÜe_couÁs
[
cÜeid
] = 0;

1041 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1043 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1045 
ršg
->
h—d
 =„šg->
cur
;

1046 
pŞlfd
 
pfd
;

1047 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1048 
pfd
.
ev’ts
 = 
POLLOUT
;

1049 
pfd
.
»v’ts
 = 0;

1050 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1059 #ifdef 
PRINT_STATS


1060 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1063 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1064 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1067 if(
cÜeid
 == 0) {

1068 
£nd_™”
++;

1071 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1072 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1080 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1082 
¦Ù
->
æags
 = 0;

1085 --
³r_cÜe_couÁs
[
cÜeid
];

1086 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1087 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1089 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1091 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1092 
ršg
->
h—d
 =„šg->
cur
;

1093 
pŞlfd
 
pfd
;

1094 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1095 
pfd
.
ev’ts
 = 
POLLOUT
;

1096 
pfd
.
»v’ts
 = 0;

1097 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1099 
	}
}

1102 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1103 #iâdeà
OPT_FOR_SINGLE_CORE


1104 !
»cv_ma¡”_nmd
) {

1105 
this_th»ad
::
	`y›ld
();

1108 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1109 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1110 
nm»q
 
ba£_»q
;

1111 
š‹rçû
[32];

1112 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1114 #ifdeà
OPT_FOR_SINGLE_CORE


1115 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1116 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1118 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1119 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1121 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1122 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1123  
NULL
;

1125 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1126 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1127 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1129 ià(
cÜeid
==0) {

1130 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1131 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1134 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1135 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1136 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1138 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1139 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1140  
NULL
;

1142 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1143 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1144 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1146 
	`D
("zerocopy %s",

1147 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1151 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

1153 #ifdeà
OPT_FOR_SINGLE_CORE


1155 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

1157 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

1161 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

1164 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
è+ 
vœt_hdr_Ën
);

1165 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1166 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1168 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1169 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1172 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1174 ià(
	`uÆik–y
(!
tx_buf
)) {

1175 
	`D
("TXƒrror occurred");

1178 
tx_buf
 =x_buà- (
‘h”_h—d”
è- 
vœt_hdr_Ën
;

1180 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1181 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
);

1186 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1187 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1189 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1191 
¦Ù
->
æags
 = 0;

1194 --
³r_cÜe_couÁs
[
cÜeid
];

1195 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1196 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1198 
ršg
->
h—d
 =„šg->
cur
;

1199 
pŞlfd
 
pfd
;

1200 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1201 
pfd
.
ev’ts
 = 
POLLOUT
;

1202 
pfd
.
»v’ts
 = 0;

1203 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1205 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1208 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

1209 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1210 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1212 
™
++;

1215 
	`g‘_bufãr_tx
(
cÜeid
);

1219 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1220 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1232 
ušt16_t
 
n
;

1233 
pŞlfd
 
pfd
;

1234 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1235 
pfd
.
ev’ts
 = 
POLLIN
;

1236 
pfd
.
»v’ts
 = 0;

1237 
ršg
->
h—d
 =„šg->
cur
;

1238 #ifdeà
BUSY_WAIT


1239 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1240 
	`D
("ioctlƒrror on queue %d: %s", 0,

1241 
	`¡»¼Ü
(
”ºo
));

1242  
NULL
;

1245 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1248 if(
do_abÜt
) {

1249  
NULL
;

1253 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1254 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1255 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1256  
NULL
;

1259 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1260 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1261 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1263 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1265 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1266  
NULL
;

1269 
¡¬t
:

1270 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1271 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1273 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1275 #ifdeà
OPT_FOR_SINGLE_CORE


1277 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1279 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1281 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1282 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1283 
‘h”_addr
 
‹mp_eh
;

1284 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1285 
¬±abË
[
¬µkt
->
ah
.
£nd”_
] = 
‹mp_eh
;

1286 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1297 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1299 ià(
	`uÆik–y
(!
tx_buf
)) {

1300 
	`D
("TXƒrror occurred");

1303 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1304 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1310 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1311 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1313 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1315 
¦Ù
->
æags
 = 0;

1318 --
³r_cÜe_couÁs
[
cÜeid
];

1319 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1320 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1322 
ršg
->
h—d
 =„šg->
cur
;

1323 
pŞlfd
 
pfd
;

1324 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1325 
pfd
.
ev’ts
 = 
POLLOUT
;

1326 
pfd
.
»v’ts
 = 0;

1327 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1337 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1338 
³r_cÜe_couÁr
[
cÜeid
]--;

1339 
pktcouÁ
++;

1340 
¡¬t
;

1344  (*)((*)
pkt
+(
‘h”_h—d”
));

1347  
NULL
;

1349 
	}
}

1352 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1354 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1356 #ifdeà
OPT_FOR_SINGLE_CORE


1358 #ifdef 
PRINT_STATS


1359 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1361 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1362 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1365 if(
cÜeid
 == 0) {

1366 
»cv_™”
++;

1369 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1370 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1374 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1375 
³r_cÜe_couÁr
[
cÜeid
]--;

1376 
	}
}

1377 #iâdef 
OPT_FOR_SINGLE_CORE


1380 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1382 
£nd_th»ad_cÜe
;

1384 #if 
N_MINUS_2_CONFIG


1385 if(
cÜes_avaabË
 > 2) {

1386 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1387 } if(
cÜes_avaabË
 == 2) {

1388 
£nd_th»ad_cÜe
 = 1;

1390 
£nd_th»ad_cÜe
 = 0;

1392 #–if 
N_MINUS_1_CONFIG


1393 if(
cÜes_avaabË
 > 1) {

1394 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1396 
£nd_th»ad_cÜe
 = 0;

1399 if(
cÜes_avaabË
 > 1) {

1400 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1402 
£nd_th»ad_cÜe
 = 0;

1406 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1407 
this_th»ad
::
	`y›ld
();

1410 
ušt32_t
 
i
;

1411 
rv
;

1412 
veùÜ
<
pÜt_des
> 
pÜts
;

1413 
ušt64_t
 
™”
 = 0;

1414 
ušt32_t
 
Åes
;

1415 
pÜt_des
 *
rxpÜt
;

1416 
pÜt_des
 *
txpÜt
;

1418 
nm»q
 
ba£_»q
;

1419 
ušt32_t
 
exŒa_bufs
;

1420 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1421 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1422 
Ãtm­_ršg
 *
txršg
;

1424 
Åes
 = 
£nd_ouut_ršgs
;

1426 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1427 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1429 
	`D
("Åes:%u",
Åes
);

1431 
pÜts
.
	`»size
(
Åes
+2);

1433 
txpÜt
 = &
pÜts
[
Åes
];

1434 
rxpÜt
 = &
pÜts
[
Åes
+1];

1436 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1437 
	`D
("failedo‡llocatehe stats‡rray");

1438  
NULL
;

1441 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1443 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1444 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1446 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1447 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1448  
NULL
;

1450 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1451 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1454 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1455 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1456 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1458 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1459 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1460 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1461 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1463 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1464 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1465  
NULL
;

1467 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1468 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1472 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1473 
txršg
 = 
txpÜt
->
ršg
;

1474 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1476 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1478 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1480 
i
 = 0; i < 
Åes
; ++i) {

1481 
š‹rçû
[32];

1482 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1483 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1484 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1486 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1487 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1488  
NULL
;

1490 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1491 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1492 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1494 
	`D
("zerocopy %s",

1495 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1498 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1499 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1501 
	`¦“p
(2);

1503 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1505 #ifdef 
PRINT_STATS


1506 
i
 = 0; i < 
Åes
+2; ++i) {

1507 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1530 !
do_abÜt
) {

1531 
u_št
 
pŞlo
 = 0;

1533 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1534 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1537 
™”
++;

1539 
i
 = 0; i < 
Åes
; ++i) {

1540 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1541 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1545 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1546 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1547 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1548 
úts
[
pŞlo
] = 
i
;

1549 ++
pŞlo
;

1551 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1552 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1553 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1555 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1567 
‹mp_couÁ
;

1568 
boŞ
 
Ãed_æush
 = 
çl£
;

1569 
b©ch_cur
 = 0,
™emp
;

1571 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1573 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1574 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1575 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1576 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1577 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1587 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1589 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1590 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1591 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1592 
Ãed_æush
 = 
Œue
;

1595 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1602 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1603 
b©ch_cur
 = 
£nd_b©ch
;

1604 
txršg
->
h—d
 =xršg->
cur
;

1608 #ifdeà
BUSY_WAIT


1609 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1610 
	`D
("ioctlƒrror on queue %d: %s", 0,

1611 
	`¡»¼Ü
(
”ºo
));

1612  
NULL
;

1615 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1616 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1617 
	`¡»¼Ü
(
”ºo
));

1618  
NULL
;

1620 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1621 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1622 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1623  
NULL
;

1626 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1627 ià(
n
 < 
b©ch_cur
)

1628 
b©ch_cur
 = 
n
;

1631 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1632 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1633 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1635 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1638 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1639 
tx¦Ù
->
æags
 = 0;

1640 
b©ch_cur
--;

1646 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1656 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1657 
Ãed_æush
 = 
Œue
;

1658 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1660 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1663 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
è+ 
vœt_hdr_Ën
);

1664 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1665 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1667 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1668 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1671 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1672 
b©ch_cur
 = 
£nd_b©ch
;

1673 
txršg
->
h—d
 =xršg->
cur
;

1677 #ifdeà
BUSY_WAIT


1678 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1679 
	`D
("ioctlƒrror on queue %d: %s", 0,

1680 
	`¡»¼Ü
(
”ºo
));

1681  
NULL
;

1684 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1685 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1686 
	`¡»¼Ü
(
”ºo
));

1687  
NULL
;

1689 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1690 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1691 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1692  
NULL
;

1695 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1696 ià(
n
 < 
b©ch_cur
)

1697 
b©ch_cur
 = 
n
;

1700 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1701 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1703 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1704 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
);

1705 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1707 
tx¦Ù
->
æags
 = 0;

1708 
b©ch_cur
--;

1710 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1712 #ifdef 
PRINT_STATS


1713 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1715 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1716 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1721 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1727 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1728 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1729 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1731 
™
++;

1735 ià(
	`uÆik–y
(
Ãed_æush
)) {

1737 
b©ch_cur
 = 0;

1738 
txršg
->
h—d
 =xršg->
cur
;

1739 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1742 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1744 
³ndšg_¬p_»q_th
.
	`ş—r
();

1749 ià(
rv
 <= 0) {

1750 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1751 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1756 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1757 
i
 = 
úts
[
™emp
];

1758 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1760 
Ãxt_cur
 = 
ršg
->
cur
;

1761 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1762 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1763 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1764 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1765 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1768 
»cvcouÁ
--) {

1769 
tİ
:

1770 
n
;

1771 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1772 
b©ch_cur
 = 
£nd_b©ch
;

1776 #ifdeà
BUSY_WAIT


1777 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1778 
	`D
("ioctlƒrror on queue %d: %s", 0,

1779 
	`¡»¼Ü
(
”ºo
));

1780  
NULL
;

1783 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1784 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1785 
	`¡»¼Ü
(
”ºo
));

1786  
NULL
;

1788 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1789 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1790 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1791  
NULL
;

1794 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1795 ià(
n
 < 
b©ch_cur
)

1796 
b©ch_cur
 = 
n
;

1799 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1800 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1801 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1802 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1803 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1804 
	`__butš_´eãtch
(
Ãxt_buf
);

1806 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1807 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1808 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1809 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1810 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1811 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1815 
tx¦Ù
->
Ën
=
rs
->len;

1835 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1836 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1838 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1840 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1841 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1846 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)
‹mpbuf
);

1847 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1850 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1851 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1854 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1855 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1856 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1857 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1859 
£nd_¬p_»q
 = 
çl£
;

1862 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1864 
‘h”_addr
 
¤c_mac
 = 
	`‘h”_©Ú
(
¤c_‘h_addr
);

1865 
‘h”_addr
 
de¡_mac
 = 
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1866 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1868 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1870 
tx¦Ù
->
æags
 = 0;

1872 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1874 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1876 
b©ch_cur
 = 0;

1877 
txršg
->
h—d
 =xršg->
cur
;

1878 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1887 
tx¦Ù
->
æags
 = 0;

1888 
b©ch_cur
--;

1889 #ifdef 
PRINT_STATS


1890 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1892 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1893 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1895 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1896 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1898 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1899 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1901 
txršg
->
h—d
 =xršg->
cur
;

1902 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1905 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1910 
	`¦“p
(5);

1911 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1912 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1915  
NULL
;

1916 
	}
}

1919 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1921 
»cv_th»ad_cÜe
;

1923 #if 
N_MINUS_2_CONFIG


1924 if(
cÜes_avaabË
 > 2) {

1925 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1926 } if(
cÜes_avaabË
 == 2) {

1927 
»cv_th»ad_cÜe
 = 1;

1929 
»cv_th»ad_cÜe
 = 0;

1931 #–if 
N_MINUS_1_CONFIG


1932 if(
cÜes_avaabË
 > 1) {

1933 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1935 
»cv_th»ad_cÜe
 = 0;

1938 if(
cÜes_avaabË
 > 1) {

1939 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1941 
»cv_th»ad_cÜe
 = 0;

1945 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1946 
this_th»ad
::
	`y›ld
();

1949 
ušt32_t
 
i
;

1950 
rv
;

1951 
veùÜ
<
pÜt_des
> 
pÜts
;

1952 
™”
 = 0;

1953 
ušt32_t
 
Åes
;

1954 
ov”æow_queue
 *
ä“q
;

1955 
pÜt_des
 *
rxpÜt
;

1956 
pÜt_des
 *
txpÜt
;

1958 
nm»q
 
ba£_»q
;

1959 
ušt32_t
 
exŒa_bufs
;

1960 
veùÜ
<
ov”æow_queue
> 
oq
;

1961 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1963 
Åes
 = 
»cv_ouut_ršgs
;

1964 
ä“q
 = 
NULL
;

1966 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1967 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1969 
	`D
("Åes:%u",
Åes
);

1971 
pÜts
.
	`»size
(
Åes
+2);

1976 
oq
.
	`»size
(
Åes
+1);

1977 ià(
oq
.
	`size
()!=
Åes
+1) {

1978 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1979  
NULL
;

1982 
rxpÜt
 = &
pÜts
[
Åes
];

1983 
txpÜt
 = &
pÜts
[
Åes
+1];

1985 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1986 
	`D
("failedo‡llocatehe stats‡rray");

1987  
NULL
;

1990 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1992 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1993 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1995 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1996 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1997  
NULL
;

1999 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

2000 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

2003 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

2004 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

2005 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

2007 
	`mem£t
(&
ba£_»q
, 0, (base_req));

2008 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

2009 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

2010 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

2012 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

2013 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

2014  
NULL
;

2016 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

2017 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

2021 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

2022 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

2024 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

2026 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

2027 ià(!
exŒa_bufs
)

2028 
run
;

2030 
ä“q
 = &
oq
[
Åes
];

2031 
rxpÜt
->
oq
 = 
NULL
;

2032 
txpÜt
->
oq
 = 
ä“q
;

2034 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

2040 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

2041 
rv
;

2042 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

2044 
Ãtm­_¦Ù
 
s
;

2045 
s
.
buf_idx
 = 
rv
;

2046 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

2047 
ä“q
->
¦Ùs
.
	`push
(
s
);

2049 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

2050 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

2051 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

2052  
NULL
;

2054 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

2056 
run
:

2057 
i
 = 0; i < 
Åes
; ++i) {

2058 
š‹rçû
[32];

2059 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

2060 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

2061 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

2063 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

2064 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

2065  
NULL
;

2067 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

2068 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

2069 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

2071 
	`D
("zerocopy %s",

2072 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

2074 ià(
exŒa_bufs
) {

2075 
ov”æow_queue
 *
q
 = &
oq
[
i
];

2076 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

2077 
pÜts
[
i
].
oq
 = 
q
;

2081 ià(!
exŒa_bufs
) {

2082 ià(!
oq
.
	`em±y
()) {

2083 
i
 = 0; i < 
Åes
 + 1; i++) {

2084 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

2085 
oq
[
i
].
¦Ùs
.
	`pİ
();

2087 
pÜts
[
i
].
oq
 = 
NULL
;

2089 
pÜts
[
i
].
oq
 = 
NULL
;

2090 
oq
.
	`ş—r
();

2092 
	`D
("*** overflow queues disabled ***");

2095 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

2096 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

2098 
	`¦“p
(2);

2100 !
§ã_to_¡¬t_»cv
) {

2101 
this_th»ad
::
	`y›ld
();

2104 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

2106 #ifdef 
PRINT_STATS


2107 
i
 = 0; i < 
Åes
+2; ++i) {

2108 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

2131 !
do_abÜt
) {

2132 
u_št
 
pŞli
 = 0;

2134 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

2135 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

2138 
™”
++;

2139 
i
 = 0; i < 
Åes
; ++i) {

2140 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

2141 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

2145 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

2146 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

2147 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2148 ++
pŞli
;

2150 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

2151 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

2152 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2153 ++
pŞli
;

2155 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

2156 ià(
rv
 <= 0) {

2157 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

2158 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

2162 ià(!
oq
.
	`em±y
()) {

2166 
i
 = 0; i < 
Åes
; i++) {

2167 
pÜt_des
 *
p
 = &
pÜts
[
i
];

2168 
ov”æow_queue
 *
q
 = 
p
->
oq
;

2169 
ušt32_t
 
j
, 
lim
;

2170 
Ãtm­_ršg
 *
ršg
;

2171 
Ãtm­_¦Ù
 *
¦Ù
;

2173 ià(
q
->
¦Ùs
.
	`em±y
())

2175 
ršg
 = 
p
->ring;

2176 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

2177 ià(!
lim
)

2179 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

2180 
lim
 = 
q
->
¦Ùs
.
	`size
();

2181 
j
 = 0; j < 
lim
; j++) {

2182 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

2183 
q
->
¦Ùs
.
	`pİ
();

2184 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

2185 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

2186 *
¦Ù
 = 
s
;

2187 #ifdef 
PRINT_STATS


2188 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

2190 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2191 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

2193 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

2194 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2196 
ršg
->
h—d
 =„šg->
cur
;

2200 
b©ch_cur
 = 0;

2201 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

2202 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

2204 
Ãxt_cur
 = 
rxršg
->
cur
;

2205 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2206 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2207 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

2208 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

2209 
ršg¥aû
 = 
MAX_BATCH_RECV
;

2211 
ršg¥aû
--) {

2212 
ov”æow_queue
 *
q
;

2213 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

2214 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

2215 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

2217 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2219 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2220 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

2222 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

2224 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

2226 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

2228 
_mac_·œ
 
‹mp_·œ
;

2229 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

2230 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

2231 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

2234 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2235 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2236 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2237 
	`__butš_´eãtch
(
Ãxt_buf
);

2238 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2240 
b©ch_cur
++;

2241 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2242 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2243 
b©ch_cur
 = 0;

2266 
ušt32_t
 
ouut_pÜt
 = 0;

2267 if(
»cv_th»ad_cÜe
) {

2268 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

2269 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

2272 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2273 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2274 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2275 
	`__butš_´eãtch
(
Ãxt_buf
);

2276 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

2277 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

2278 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

2281 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2282 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2283 *
cİy_buf
;

2284 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2285 
ts
->
Ën
 = 
rs
->len;

2286 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2288 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2290 #ifdef 
PRINT_STATS


2291 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2294 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2295 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2298 
fÜw¬d
;

2302 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2303 #ifdef 
PRINT_STATS


2304 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2306 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2307 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2309 
Ãxt
;

2312 
q
 = &
oq
[
ouut_pÜt
];

2314 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2316 
ušt32_t
 
j
;

2317 
pÜt_des
 *
Í
 = &
pÜts
[0];

2318 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2320 
j
 = 1; j < 
Åes
; j++) {

2321 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2322 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2323 
Í
 = 
ı
;

2324 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2329 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2330 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2331 #ifdef 
PRINT_STATS


2332 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2334 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2335 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2338 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2339 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2342 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2345 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2346 
ä“q
->
¦Ùs
.
	`pİ
();

2348 *
‹mp_buf
;

2349 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2350 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2351 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2352 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2354 
fÜw¬d
:

2356 
Ãxt
:

2357 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2359 
b©ch_cur
++;

2360 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2361 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2362 
b©ch_cur
 = 0;

2369 ià(
exŒa_bufs
) {

2370 
	`ä“_bufãrs
(
pÜts
);

2372 
	`¦“p
(5);

2373 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2374 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2377  
NULL
;

2378 
	}
}

2382 
u_št16_t


2383 
	$w¿psum
(
u_št32_t
 
sum
)

2385 
sum
 = ~sum & 0xFFFF;

2386  (
	`htÚs
(
sum
));

2387 
	}
}

2390 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2392 
s
;

2393 
iäeq
 
bufãr
;

2394 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2396 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2397 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2399 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2401 
	`şo£
(
s
);

2402 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2403 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2404 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2405 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2406 
fd
;

2407 
iäeq
 
iä
;

2409 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2412 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2415 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2417 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2419 
	`şo£
(
fd
);

2422 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2423 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2424 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2427 
¬±abË
[
¤c_
.
s_addr
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2428 if(
¬±abË
.
	`fšd
(
¤c_
.
s_addr
)!÷½bË.
	`’d
()) {

2429 
	`D
("Hurray 1");

2432 
š_addr
 
©t
;

2433 
	`š‘_©Ú
("169.254.9.28", &
©t
);

2436 if(
¬±abË
.
	`fšd
(
©t
.
s_addr
)!÷½bË.
	`’d
()) {

2437 
	`D
("Hurray 2");

2438 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
.
s_addr
]));

2441 
	}
}

	@netmap_api_bak.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

393 
ušt32_t
 
th»ad_cÜe
 = 0;

395 #if 
N_MINUS_2_CONFIG


396 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

397 if(
STAT_ON_SEND_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

399 } if(
STAT_ON_RECV_CORE
) {

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

402 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

404 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

405 
th»ad_cÜe
 = 1;

407 
th»ad_cÜe
 = 0;

409 #–if 
N_MINUS_1_CONFIG


410 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

411 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

414 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

417 
th»ad_cÜe
 = 0;

420 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

421 if(
STAT_ON_SEND_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

423 } if(
STAT_ON_RECV_CORE
) {

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

426 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

429 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

430 
th»ad_cÜe
 = 1;

432 
th»ad_cÜe
 = 0;

437  
th»ad_cÜe
;

439 
	}
}

441 
	gN‘m­U£
::
	$N‘m­U£
() {

442 *
‹mp
;

443 
u_št
 
i
;

444 
‹¡couÁ
=0;

446 
num_»cv
 = 1;

447 
wa™_lšk
 = 2;

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

457 
	`sourû_hwaddr
(
iâame
);

463 
	`š™Ÿlize_£nd_»cv
();

465 #ifdef 
OPT_FOR_SINGLE_CORE


466 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
³r_cÜe_£nd_pÜt
[0]);

468 
£nd_¡©s
.
	`»size
(1);

469 
»cv_¡©s
.
	`»size
(1);

471 
	`mem£t
(&
£nd_¡©s
[0], 0, (
compu‹_¡©s
));

472 
	`mem£t
(&
»cv_¡©s
[0], 0, (
compu‹_¡©s
));

474 
£nd_™”
 = 
»cv_™”
 = 0;

477 
§ã_to_¡¬t_»cv
 = 
Œue
;

478 
	}
}

484 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

486 
buf
[128];

487 
i
, 
j
, 
i0
;

488 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

492 
	`´štf
("ring %p cur %5d [buf %6d flags 0x%04x†en %5d]\n",

493 
ršg
, 
cur
,„šg->
¦Ù
[cur].
buf_idx
,

494 
ršg
->
¦Ù
[
cur
].
æags
, 
Ën
);

496 
i
 = 0; i < 
Ën
; ) {

497 
	`mem£t
(
buf
, (buf), ' ');

498 
	`¥rštf
(
buf
, "%5d: ", 
i
);

499 
i0
 = 
i
;

500 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

501 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

502 
i
 = 
i0
;

503 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

504 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

505 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

506 
	`´štf
("%s\n", 
buf
);

508 
	}
}

510 
	gN‘m­U£
::~
	$N‘m­U£
() {

511 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

514 #iâdeà
OPT_FOR_SINGLE_CORE


515 
£nd_th»ad
.
	`još
();

516 
»cv_th»ad
.
	`još
();

521 
	`g‘timeofday
(&
’d_time
, 
NULL
);

523 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

524 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

525 
¿‹_time
 = (
£nd_¡©s
[0].
fÜw¬ded
*8è/ (
diff_time
*1024*1024*1024);

526 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

529 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

530 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

531 
¿‹_time
 = (
»cv_¡©s
[0].
fÜw¬ded
*8è/ (
diff_time
*1024*1024*1024);

532 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

534 
¡©_th»ad
.
	`još
();

537 
	`¦“p
(5);

538 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

544 
cout
<<"Com¶‘ed"<<
’dl
;

545 
	}
}

548 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

550 
nm»q
 
»q
;

551 
”r
;

553 
	`mem£t
(&
»q
, 0, (req));

554 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

555 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

556 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

557 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

558 ià(
”r
) {

559 
	`D
("Unableo get virtio-net header†ength");

563 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

564 ià(
vœt_hdr_Ën
) {

565 
	`D
("Port„equires virtio-net header,†ength = %d",

566 
vœt_hdr_Ën
);

568 
	}
}

571 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

573 
th»ad_cÜe
 = 0;

575 #iâdef 
OPT_FOR_SINGLE_CORE


577 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

581 
	`sched_g‘ıu
()!=
th»ad_cÜe
) {

582 
this_th»ad
::
	`y›ld
();

584 
	`D
("CÜ%d:",
th»ad_cÜe
);

585 
Åes
 = 
»cv_ouut_ršgs
;

586 
sys_št
 = 0;

587 
my_ùrs
 
cur
, 
´ev
;

588 
b1
[40], 
b2
[40];

589 
my_ùrs
 *
pe_´ev
;

591 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

592 ià(
pe_´ev
 =ğ
NULL
) {

593 
	`D
("out of memory");

594 
	`ex™
(1);

597 
	`mem£t
(&
´ev
, 0, (prev));

598 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

599 !
do_abÜt
) {

600 
j
, 
dosy¦og
 = 0;

601 
ušt64_t
 
µs
, 
dps
, 
u£c
;

602 
my_ùrs
 
x
;

604 
	`mem£t
(&
cur
, 0, (cur));

605 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

607 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

608 
dosy¦og
 = 1;

609 
sys_št
 = 0;

612 
j
 = 0; j < 
Åes
; ++j) {

613 
pÜt_des
 *
p
 = &
pÜts
[
j
];

615 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

616 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

618 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

619 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

620 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

621 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

622 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

623 
pe_´ev
[
j
] = 
p
->
ùr
;

625 ià(
dosy¦og
) {

626 
	`sy¦og
(
LOG_INFO
,

631 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

634 
	`´štf
("\n");

644 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

645 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

646 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

647 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

648 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

649 
´ev
 = 
cur
;

652 
	`ä“
(
pe_´ev
);

653 
	`D
("Done");

655 
	}
}

658 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

659 
i
, 
	gtÙ
 = 0;

660 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

663 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

664 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

665 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

667 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

670 !
	gq
->
	g¦Ùs
.
em±y
()) {

671 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

672 
	gq
->
	g¦Ùs
.
pİ
();

673 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

675 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

676 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

677 
	gtÙ
++;

680 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

684 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

685 
ušt16_t
 
i
,
j
;

687 
£nd_ma¡”_nmd
 = 
NULL
;

688 
»cv_ma¡”_nmd
 = 
NULL
;

690 
§ã_to_¡¬t_»cv
 = 
çl£
;

691 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

692 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

693 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

694 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

696 #if 
N_MINUS_2_CONFIG


697 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

698 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

700 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

703 #–if 
N_MINUS_1_CONFIG


704 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

705 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

707 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

710 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

714 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

715 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

716 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

719 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

720 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

721 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

722 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

723 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

730 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

731 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

732 
³r_cÜe_couÁs
[
i
] = 0;

734 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

735 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

736 
³r_cÜe_couÁr
[
i
] = 0;

739 #iâdeà
OPT_FOR_SINGLE_CORE


740 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

768 
ıu_£t_t
 
ıu_£t
;

770 
th»ad_cÜe1
, 
th»ad_cÜe2
;

772 #if 
N_MINUS_2_CONFIG


773 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

774 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

775 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

776 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

777 
th»ad_cÜe1
 = 1;

778 
th»ad_cÜe2
 = 1;

780 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

782 #–if 
N_MINUS_1_CONFIG


783 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

784 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

785 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

787 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

790 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

791 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

792 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

794 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

798 
	`CPU_ZERO
(&
ıu_£t
);

799 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

800 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

801 if(
rc
!=0) {

802 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

805 
j
 = 0; j < 
CPU_SETSIZE
; j++)

806 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

807 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

811 
	`¦“p
(2);

813 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

815 
	`CPU_ZERO
(&
ıu_£t
);

816 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

817 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

818 if(
rc
!=0) {

819 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

822 
j
 = 0; j < 
CPU_SETSIZE
; j++)

823 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

824 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

828 
	}
}

906 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

907 #iâdeà
OPT_FOR_SINGLE_CORE


908 !
£nd_ma¡”_nmd
) {

909 
this_th»ad
::
	`y›ld
();

912 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

913 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

914 
nm»q
 
ba£_»q
;

915 
š‹rçû
[25];

916 
	`mem£t
(&
ba£_»q
, 0, (base_req));

917 #ifdeà
OPT_FOR_SINGLE_CORE


918 
	`D
("İ’šg iÁ”çû‚amed %s", 
£nd_iâame
);

920 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

921 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

923 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

924 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

925  
NULL
;

927 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

928 
cÜeid
 + 1, 
£nd_iâame
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

929 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

932 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

933 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

934 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

936 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

937 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

938  
NULL
;

940 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

941 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

942 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

944 
	`D
("zerocopy %s",

945 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

951 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

955 
ušt16_t
 
n
;

956 
²
;

957 
pŞlfd
 
pfd
;

958 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

959 
pfd
.
ev’ts
 = 
POLLOUT
;

960 
pfd
.
»v’ts
 = 0;

961 #ifdeà
BUSY_WAIT


962 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

963 
	`D
("ioctlƒrror on queue %d: %s", 0,

964 
	`¡»¼Ü
(
”ºo
));

965  
NULL
;

969 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

972 if(
do_abÜt
) {

973  
NULL
;

977 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

978 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

979 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

980  
NULL
;

984 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

986 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

987 if(
šc_bur¡
) {

988 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

989 
	`D
("Burst increased");

992 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

993 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

995 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

998 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1000  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

1001 
	}
}

1003 
	gcouÁ·ck‘ss
 = 0;

1005 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

1006 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1007 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1011 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

1012 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

1013 
¦Ù
->
æags
 = 0;

1018 #ifdeà
OPT_FOR_SINGLE_CORE


1019 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1021 if(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
) {

1023 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1026 
£nd_™”
++;

1028 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1029 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1032 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1033 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1035 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1037 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1042 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1043 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1045 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1048 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1049 
ršg
->
h—d
 =„šg->
cur
;

1050 
pŞlfd
 
pfd
;

1051 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1052 
pfd
.
ev’ts
 = 
POLLOUT
;

1053 
pfd
.
»v’ts
 = 0;

1054 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1058 
	}
}

1060 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1061 #iâdeà
OPT_FOR_SINGLE_CORE


1062 !
»cv_ma¡”_nmd
) {

1063 
this_th»ad
::
	`y›ld
();

1066 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1067 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1068 
nm»q
 
ba£_»q
;

1069 
š‹rçû
[25];

1070 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1072 #ifdeà
OPT_FOR_SINGLE_CORE


1073 
	`D
("İ’šg iÁ”çû‚amed %s", 
»cv_iâame
);

1075 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1076 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1078 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1079 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1080  
NULL
;

1082 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1083 
cÜeid
 + 1, 
»cv_iâame
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1084 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1087 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1088 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1089 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1091 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1092 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1093  
NULL
;

1095 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1096 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1097 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1099 
	`D
("zerocopy %s",

1100 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1107 
¡¬t
:

1108 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1112 
ušt16_t
 
n
;

1113 
²
;

1114 
pŞlfd
 
pfd
;

1115 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1116 
pfd
.
ev’ts
 = 
POLLIN
;

1117 
pfd
.
»v’ts
 = 0;

1118 #ifdeà
BUSY_WAIT


1119 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1120 
	`D
("ioctlƒrror on queue %d: %s", 0,

1121 
	`¡»¼Ü
(
”ºo
));

1122  
NULL
;

1126 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1129 if(
do_abÜt
) {

1130  
NULL
;

1134 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1135 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1136 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1137  
NULL
;

1141 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1148 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1149 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1151 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1153 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1155 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1157 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1158 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1161 #ifdeà
OPT_FOR_SINGLE_CORE


1162 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1163 if(
ARP_ENABLED
) {

1164 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1167 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1168 
³r_cÜe_couÁr
[
cÜeid
]--;

1169 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1170 
ršg
->
h—d
 =„šg->
cur
;

1171 
pŞlfd
 
pfd
;

1172 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1173 
pfd
.
ev’ts
 = 
POLLIN
;

1174 
pfd
.
»v’ts
 = 0;

1175 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1178 
¡¬t
;

1182  (*)((*)
pkt
+(
‘h”_h—d”
));

1184  
NULL
;

1186 
	}
}

1188 
	gcouÁ·ck‘¤
 = 0;

1190 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1194 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1196 #ifdeà
OPT_FOR_SINGLE_CORE


1197 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1198 if(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
) {

1200 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1203 
»cv_™”
++;

1205 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1206 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1210 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1211 
³r_cÜe_couÁr
[
cÜeid
]--;

1212 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1213 
ršg
->
h—d
 =„šg->
cur
;

1214 
pŞlfd
 
pfd
;

1215 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1216 
pfd
.
ev’ts
 = 
POLLIN
;

1217 
pfd
.
»v’ts
 = 0;

1221 
	}
}

1224 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1226 
£nd_th»ad_cÜe
;

1228 
time_t
 
¡¬t_t
, 
’d_t
;

1229 
¿‹_t
, 
diff_t
;

1230 
timev®
 
begš
, 
’d
;

1232 #if 
N_MINUS_2_CONFIG


1233 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1234 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1235 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1236 
£nd_th»ad_cÜe
 = 1;

1238 
£nd_th»ad_cÜe
 = 0;

1240 #–if 
N_MINUS_1_CONFIG


1241 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1242 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1244 
£nd_th»ad_cÜe
 = 0;

1247 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1248 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1250 
£nd_th»ad_cÜe
 = 0;

1254 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1255 
this_th»ad
::
	`y›ld
();

1257 
ch
;

1258 
ušt32_t
 
i
,
j
;

1259 
rv
;

1260 
veùÜ
<
pÜt_des
> 
pÜts
;

1261 
ušt64_t
 
™”
 = 0;

1262 
ušt32_t
 
Åes
;

1263 
pÜt_des
 *
rxpÜt
;

1264 
pÜt_des
 *
txpÜt
;

1266 
nm»q
 
ba£_»q
;

1267 
ušt32_t
 
exŒa_bufs
;

1268 
ušt32_t
 
sÿn
;

1270 
u_št
 
couÁs
;

1271 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1272 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1273 
Ãtm­_ršg
 *
txršg
;

1276 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1277 
Åes
 = 
£nd_ouut_ršgs
;

1279 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1280 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1282 
	`D
("Åes:%u",
Åes
);

1284 
pÜts
.
	`»size
(
Åes
+2);

1286 
£nd_¡©s
.
	`»size
(
Åes
+1);

1288 
i
=0;i<=
Åes
;i++) {

1289 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

1292 
txpÜt
 = &
pÜts
[
Åes
];

1293 
rxpÜt
 = &
pÜts
[
Åes
+1];

1297 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1298 
	`D
("failedo‡llocatehe stats‡rray");

1299  
NULL
;

1302 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1304 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1305 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1307 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1308 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1309  
NULL
;

1311 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1312 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1315 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1316 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1319 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1321 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1322 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1323 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1324 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1326 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1327 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1328  
NULL
;

1330 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1331 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1335 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1336 
txršg
 = 
txpÜt
->
ršg
;

1337 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1339 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1341 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1343 
i
 = 0; i < 
Åes
; ++i) {

1344 
š‹rçû
[25];

1345 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1346 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1347 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1349 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1350 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1351  
NULL
;

1353 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1354 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1355 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1357 
	`D
("zerocopy %s",

1358 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1361 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1362 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1364 
	`¦“p
(2);

1366 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1367 
ušt64_t
 
times
=0;

1369 
i
 = 0; i < 
Åes
+2; ++i) {

1370 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1393 !
do_abÜt
) {

1394 
u_št
 
pŞlo
 = 0;

1396 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1398 
	`g‘timeofday
(&
begš
, 
NULL
);

1401 
™”
++;

1403 
i
 = 0; i < 
Åes
; ++i) {

1404 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1405 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1409 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1410 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1411 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1412 
úts
[
pŞlo
] = 
i
;

1413 ++
pŞlo
;

1415 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1416 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1417 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1419 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1420 ià(
rv
 <= 0) {

1421 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1422 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1426 
b©ch_cur
 = 0,
™emp
;

1427 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1428 
i
 = 
úts
[
™emp
];

1429 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1432 
Ãxt_cur
 = 
ršg
->
cur
;

1433 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1434 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1435 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1436 
»cvcouÁ
--) {

1437 
n
;

1438 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1439 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1440 if(
šc_bur¡
) {

1441 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1442 
	`D
("Burst increased");

1445 
b©ch_cur
 = 
£nd_b©ch
;

1449 #ifdeà
BUSY_WAIT


1450 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1451 
	`D
("ioctlƒrror on queue %d: %s", 0,

1452 
	`¡»¼Ü
(
”ºo
));

1453  
NULL
;

1456 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1457 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1458 
	`¡»¼Ü
(
”ºo
));

1459  
NULL
;

1461 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1462 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1463 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1464  
NULL
;

1467 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1468 ià(
n
 < 
b©ch_cur
)

1469 
b©ch_cur
 = 
n
;

1473 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1474 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1475 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1476 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1477 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1478 
	`__butš_´eãtch
(
Ãxt_buf
);

1480 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1481 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1482 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1487 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1490 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1496 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1497 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1503 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1505 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1512 
tx¦Ù
->
Ën
=
rs
->len;

1517 
tx¦Ù
->
æags
 = 0;

1518 
b©ch_cur
--;

1519 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1520 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1521 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1522 
£nd_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1524 ià(
b©ch_cur
==0) {

1525 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1527 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1528 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1529 
b©ch_cur
 = 0;

1530 
txršg
->
h—d
 =xršg->
cur
;

1531 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1535 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1542 
	`g‘timeofday
(&
’d
, 
NULL
);

1543 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

1544 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

1545 
¿‹_t
 = (
£nd_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

1546 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

1548 
	`¦“p
(5);

1549 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1550 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1556  
NULL
;

1557 
	}
}

1560 
ušt64_t
 
	gnumbuf
=0;

1562 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1564 
»cv_th»ad_cÜe
;

1566 
time_t
 
¡¬t_t
, 
’d_t
;

1567 
¿‹_t
, 
diff_t
;

1568 
timev®
 
begš
, 
’d
;

1570 #if 
N_MINUS_2_CONFIG


1571 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1572 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1573 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1574 
»cv_th»ad_cÜe
 = 1;

1576 
»cv_th»ad_cÜe
 = 0;

1578 #–if 
N_MINUS_1_CONFIG


1579 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1580 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1582 
»cv_th»ad_cÜe
 = 0;

1585 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1586 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1588 
»cv_th»ad_cÜe
 = 0;

1592 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1593 
this_th»ad
::
	`y›ld
();

1595 
	`D
("CÜ%d:",
»cv_th»ad_cÜe
);

1597 
ch
;

1598 
ušt32_t
 
i
,
j
;

1599 
rv
;

1600 
veùÜ
<
pÜt_des
> 
pÜts
;

1601 
™”
 = 0;

1602 
ušt32_t
 
Åes
;

1603 
ov”æow_queue
 *
ä“q
;

1604 
pÜt_des
 *
rxpÜt
;

1605 
pÜt_des
 *
txpÜt
;

1607 
nm»q
 
ba£_»q
;

1608 
ušt32_t
 
exŒa_bufs
;

1609 
ušt32_t
 
sÿn
;

1610 
veùÜ
<
ov”æow_queue
> 
oq
;

1612 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1615 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1616 
Åes
 = 
»cv_ouut_ršgs
;

1617 
ä“q
 = 
NULL
;

1619 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1620 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1622 
	`D
("Åes:%u",
Åes
);

1624 
pÜts
.
	`»size
(
Åes
+2);

1626 
»cv_¡©s
.
	`»size
(
Åes
+1);

1628 
i
=0;i<=
Åes
;i++) {

1629 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

1636 
oq
.
	`»size
(
Åes
+1);

1637 ià(
oq
.
	`size
()!=
Åes
+1) {

1638 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1639  
NULL
;

1642 
rxpÜt
 = &
pÜts
[
Åes
];

1643 
txpÜt
 = &
pÜts
[
Åes
+1];

1647 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1648 
	`D
("failedo‡llocatehe stats‡rray");

1649  
NULL
;

1652 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1654 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1655 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1657 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1658 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1659  
NULL
;

1661 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1662 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1665 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1666 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1669 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1671 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1672 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1673 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1674 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1676 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1677 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1678  
NULL
;

1680 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1681 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1685 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1686 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1688 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1690 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1691 ià(!
exŒa_bufs
)

1692 
run
;

1694 
ä“q
 = &
oq
[
Åes
];

1695 
rxpÜt
->
oq
 = 
NULL
;

1696 
txpÜt
->
oq
 = 
ä“q
;

1698 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1704 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1705 
sÿn
;

1706 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1708 
Ãtm­_¦Ù
 
s
;

1709 
s
.
buf_idx
 = 
sÿn
;

1710 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1711 
ä“q
->
¦Ùs
.
	`push
(
s
);

1714 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1715 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1716 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1717  
NULL
;

1719 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1721 
run
:

1722 
i
 = 0; i < 
Åes
; ++i) {

1723 
š‹rçû
[25];

1724 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1725 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1726 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1728 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1729 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1730  
NULL
;

1732 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1733 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1734 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1736 
	`D
("zerocopy %s",

1737 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1739 ià(
exŒa_bufs
) {

1740 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1741 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1742 
pÜts
[
i
].
oq
 = 
q
;

1746 ià(!
exŒa_bufs
) {

1747 ià(!
oq
.
	`em±y
()) {

1748 
i
 = 0; i < 
Åes
 + 1; i++) {

1749 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1750 
oq
[
i
].
¦Ùs
.
	`pİ
();

1752 
pÜts
[
i
].
oq
 = 
NULL
;

1754 
pÜts
[
i
].
oq
 = 
NULL
;

1755 
oq
.
	`ş—r
();

1757 
	`D
("*** overflow queues disabled ***");

1760 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1761 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1763 
	`¦“p
(2);

1765 !
§ã_to_¡¬t_»cv
) {

1766 
this_th»ad
::
	`y›ld
();

1769 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1770 
ušt64_t
 
times
=0;

1772 
i
 = 0; i < 
Åes
+2; ++i) {

1773 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1796 !
do_abÜt
) {

1797 
u_št
 
pŞli
 = 0;

1799 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1801 
	`g‘timeofday
(&
begš
, 
NULL
);

1804 
™”
++;

1805 
i
 = 0; i < 
Åes
; ++i) {

1806 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1807 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1811 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1812 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1813 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1814 ++
pŞli
;

1816 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1817 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1818 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1819 ++
pŞli
;

1821 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1822 ià(
rv
 <= 0) {

1823 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1824 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1828 ià(!
oq
.
	`em±y
()) {

1832 
i
 = 0; i < 
Åes
; i++) {

1833 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1834 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1835 
ušt32_t
 
j
, 
lim
;

1836 
Ãtm­_ršg
 *
ršg
;

1837 
Ãtm­_¦Ù
 *
¦Ù
;

1839 ià(
q
->
¦Ùs
.
	`em±y
())

1841 
ršg
 = 
p
->ring;

1842 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1843 ià(!
lim
)

1845 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1846 
lim
 = 
q
->
¦Ùs
.
	`size
();

1847 
j
 = 0; j < 
lim
; j++) {

1848 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1849 
q
->
¦Ùs
.
	`pİ
();

1850 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1851 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1852 *
¦Ù
 = 
s
;

1853 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1854 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1855 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1856 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1858 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1859 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1861 
ršg
->
h—d
 =„šg->
cur
;

1866 
b©ch_cur
 = 0;

1867 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1868 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1871 
Ãxt_cur
 = 
rxršg
->
cur
;

1872 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1873 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1874 !
	`nm_ršg_em±y
(
rxršg
)) {

1875 
ov”æow_queue
 *
q
;

1876 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1877 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1878 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1885 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1886 if(
ARP_ENABLED
) {

1887 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1890 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1891 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1892 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1893 
	`__butš_´eãtch
(
Ãxt_buf
);

1894 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1896 
b©ch_cur
++;

1897 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1898 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1904 
b©ch_cur
 = 0;

1913 
ušt32_t
 
ouut_pÜt
 = 0;

1914 if(
»cv_th»ad_cÜe
) {

1915 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1917 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1924 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1925 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1926 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1927 
	`__butš_´eãtch
(
Ãxt_buf
);

1931 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1932 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1933 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1936 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1937 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1938 *
cİy_buf
;

1939 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1940 
ts
->
Ën
 = 
rs
->len;

1941 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1943 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1945 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

1946 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1947 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1948 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1951 
fÜw¬d
;

1955 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1956 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

1957 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1958 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1959 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1961 
Ãxt
;

1964 
q
 = &
oq
[
ouut_pÜt
];

1966 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1968 
ušt32_t
 
j
;

1969 
pÜt_des
 *
Í
 = &
pÜts
[0];

1970 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1972 
j
 = 1; j < 
Åes
; j++) {

1973 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1974 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1975 
Í
 = 
ı
;

1976 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

1981 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

1982 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

1984 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

1985 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1986 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

1987 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

1990 
Í
->
oq
->
¦Ùs
.
	`pİ
();

1991 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

1994 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

1997 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

1998 
ä“q
->
¦Ùs
.
	`pİ
();

2000 *
‹mp_buf
;

2001 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2002 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2003 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2004 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2006 
fÜw¬d
:

2008 
Ãxt
:

2009 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2011 
b©ch_cur
++;

2012 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2013 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2019 
b©ch_cur
 = 0;

2030 ià(
exŒa_bufs
) {

2031 
	`ä“_bufãrs
(
pÜts
);

2040 
	`g‘timeofday
(&
’d
, 
NULL
);

2041 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

2042 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

2043 
¿‹_t
 = (
»cv_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

2044 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

2046 
	`¦“p
(5);

2047 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2048 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2054  
NULL
;

2055 
	}
}

2058 
u_št16_t


2059 
	$w¿psum
(
u_št32_t
 
sum
)

2061 
sum
 = ~sum & 0xFFFF;

2062  (
	`htÚs
(
sum
));

2063 
	}
}

2066 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2068 
s
;

2069 
iäeq
 
bufãr
;

2070 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2072 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2073 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2075 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2077 
	`şo£
(
s
);

2078 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2079 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2080 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2081 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2082 
fd
;

2083 
iäeq
 
iä
;

2085 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2088 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2091 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2093 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2095 
	`şo£
(
fd
);

2098 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2099 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2100 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2103 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2104 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2105 
	`D
("Hurray 1");

2108 
š_addr
 
©t
;

2109 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2111 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

2112 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2113 
	`D
("Hurray 2");

2114 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2117 
	}
}

	@netmap_api_bak_new.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

441 #iâdef 
OPT_FOR_SINGLE_CORE


442 
¬±abË
.
	`£t_em±y_key
(0);

443 
¬±abË
.
	`£t_d–‘ed_key
(1);

445 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

446 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

447 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

448 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth4");

453 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

454 
	`sourû_hwaddr
(
iâame
);

455 
	`š™Ÿlize_£nd_»cv
();

457 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

458 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

460 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

461 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

464 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

465 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

468 #ifdef 
OPT_FOR_SINGLE_CORE


471 
£nd_™”
 = 
»cv_™”
 = 0;

474 
§ã_to_¡¬t_»cv
 = 
Œue
;

475 
	}
}

481 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

483 
buf
[128];

484 
i
, 
j
, 
i0
;

485 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

489 
	`´štf
("ring %p cur %5d [len %5d]\n",

490 
ršg
, 
cur
, 
Ën
);

492 
i
 = 0; i < 
Ën
; ) {

493 
	`mem£t
(
buf
, (buf), ' ');

494 
	`¥rštf
(
buf
, "%5d: ", 
i
);

495 
i0
 = 
i
;

496 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

497 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

498 
i
 = 
i0
;

499 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

500 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

501 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

502 
	`´štf
("%s\n", 
buf
);

504 
	}
}

506 
	gN‘m­U£
::~
	$N‘m­U£
() {

507 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

508 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

509 
	`g‘timeofday
(&
’d_time
, 
NULL
);

511  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

512 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

515  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

516 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

519 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

520 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

521 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

522 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

524 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

525 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

526 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

527 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

529 #iâdeà
OPT_FOR_SINGLE_CORE


530 
£nd_th»ad
.
	`još
();

531 
»cv_th»ad
.
	`još
();

537 
	`¦“p
(5);

543 
cout
<<"Com¶‘ed"<<
’dl
;

544 
	}
}

547 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

549 
nm»q
 
»q
;

550 
”r
;

552 
	`mem£t
(&
»q
, 0, (req));

553 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

554 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

555 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

556 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

557 ià(
”r
) {

558 
	`D
("Unableo get virtio-net header†ength");

562 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

563 ià(
vœt_hdr_Ën
) {

564 
	`D
("Port„equires virtio-net header,†ength = %d",

565 
vœt_hdr_Ën
);

567 
	}
}

570 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

572 #ifdef 
PRINT_STATS


573 #iâdef 
OPT_FOR_SINGLE_CORE


575 
ušt32_t
 
th»ad_cÜe
;

576 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

584 
Åes
 = 
»cv_ouut_ršgs
;

585 
sys_št
 = 0;

586 
my_ùrs
 
cur
, 
´ev
;

587 
b1
[40], 
b2
[40];

588 
my_ùrs
 *
pe_´ev
;

590 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

591 ià(
pe_´ev
 =ğ
NULL
) {

592 
	`D
("out of memory");

593 
	`ex™
(1);

596 
	`mem£t
(&
´ev
, 0, (prev));

597 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

598 !
do_abÜt
) {

599 
j
, 
dosy¦og
 = 0;

600 
ušt64_t
 
µs
, 
dps
, 
u£c
;

601 
my_ùrs
 
x
;

603 
	`mem£t
(&
cur
, 0, (cur));

604 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

606 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

607 
dosy¦og
 = 1;

608 
sys_št
 = 0;

611 
j
 = 0; j < 
Åes
; ++j) {

612 
pÜt_des
 *
p
 = &
pÜts
[
j
];

614 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

615 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

617 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

618 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

619 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

620 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

621 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

622 
pe_´ev
[
j
] = 
p
->
ùr
;

624 ià(
dosy¦og
) {

625 
	`sy¦og
(
LOG_INFO
,

630 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

633 
	`´štf
("\n");

643 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

644 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

645 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

646 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

647 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

648 
´ev
 = 
cur
;

651 
	`ä“
(
pe_´ev
);

652 
	`D
("Done");

655 
	}
}

658 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

659 
i
, 
	gtÙ
 = 0;

660 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

663 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

664 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

665 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

667 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

670 !
	gq
->
	g¦Ùs
.
em±y
()) {

671 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

672 
	gq
->
	g¦Ùs
.
pİ
();

673 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

675 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

676 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

677 
	gtÙ
++;

680 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

684 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

685 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

686 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

687 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

689 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

690 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

691 
¬p_pkt
->
ah
.
hËn
 = 6;

692 
¬p_pkt
->
ah
.
¶’
 = 4;

693 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

695 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

696 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

698 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

699 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

700 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

702 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

704 
	}
}

707 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

708 
ušt16_t
 
i
,
j
;

710 #ifdef 
PRINT_STATS


711 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

713 
£nd_ma¡”_nmd
 = 
NULL
;

714 
»cv_ma¡”_nmd
 = 
NULL
;

715 
§ã_to_¡¬t_»cv
 = 
çl£
;

716 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

717 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

718 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

719 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

721 #if 
N_MINUS_2_CONFIG


722 if(
cÜes_avaabË
>=3) {

723 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

725 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

728 #–if 
N_MINUS_1_CONFIG


729 if(
cÜes_avaabË
>=2) {

730 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

732 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

735 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

738 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

739 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

741 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

742 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

743 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

744 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

746 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

747 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

748 
³r_cÜe_couÁs
[
i
] = 0;

750 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

751 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

752 
³r_cÜe_couÁr
[
i
] = 0;

755 #ifdef 
OPT_FOR_SINGLE_CORE


757 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

758 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

759 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

761 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

763 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

764 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

765 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

766 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

772 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

774 
ıu_£t_t
 
ıu_£t
;

776 
th»ad_cÜe1
, 
th»ad_cÜe2
;

778 #if 
N_MINUS_2_CONFIG


779 if(
cÜes_avaabË
 > 2) {

780 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

781 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

782 } if(
cÜes_avaabË
 == 2) {

783 
th»ad_cÜe1
 = 1;

784 
th»ad_cÜe2
 = 1;

786 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

788 #–if 
N_MINUS_1_CONFIG


789 if(
cÜes_avaabË
 > 1) {

790 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

791 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

793 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

796 if(
cÜes_avaabË
 > 1) {

797 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

798 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

800 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

804 
	`CPU_ZERO
(&
ıu_£t
);

805 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

806 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

807 if(
rc
!=0) {

808 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

811 
j
 = 0; j < 
CPU_SETSIZE
; j++)

812 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

813 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

817 
	`¦“p
(2);

819 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

821 
	`CPU_ZERO
(&
ıu_£t
);

822 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

823 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

824 if(
rc
!=0) {

825 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

828 
j
 = 0; j < 
CPU_SETSIZE
; j++)

829 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

830 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

834 
	}
}

839 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

840 #iâdeà
OPT_FOR_SINGLE_CORE


841 !
£nd_ma¡”_nmd
) {

842 
this_th»ad
::
	`y›ld
();

845 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

846 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

847 
nm»q
 
ba£_»q
;

848 
š‹rçû
[32];

849 
	`mem£t
(&
ba£_»q
, 0, (base_req));

850 #ifdeà
OPT_FOR_SINGLE_CORE


851 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

852 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

854 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

855 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

857 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

858 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

859  
NULL
;

861 
	`D
("successfully opened core #%d %s (tx slots: %d)",

862 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

863 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

865 ià(
cÜeid
==0) {

866 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

867 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

870 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

871 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

872 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

874 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

875 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

876  
NULL
;

878 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

879 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

880 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

882 
	`D
("zerocopy %s",

883 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

887 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

891 
ušt16_t
 
n
;

892 
pŞlfd
 
pfd
;

893 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

894 
pfd
.
ev’ts
 = 
POLLOUT
;

895 
pfd
.
»v’ts
 = 0;

896 #ifdeà
BUSY_WAIT


897 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

898 
	`D
("ioctlƒrror on queue %d: %s", 0,

899 
	`¡»¼Ü
(
”ºo
));

900  
NULL
;

904 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

907 if(
do_abÜt
) {

908  
NULL
;

912 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

913 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

914 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

915  
NULL
;

918 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

919 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

920 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

922 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

926 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

927  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

928 
	}
}

931 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

932 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

933 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

934 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

935 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

938 #ifdeà
OPT_FOR_SINGLE_CORE


940 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

941 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

942 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

944 
‘h”_addr
 
‹mp_‘h_addr
;

947 ià(
	`lik–y
(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
))) {

948 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

950 
tı_pkt
 
t_p
;

951 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

952 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

954 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

958 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

961 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
));

962 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

964 ià(
‹mp__dp
 =ğ
‹mp_
) {

965 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

968 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

970 ià(
	`uÆik–y
(!
tx_buf
)) {

971 
	`D
("TXƒrror occurred");

974 
tx_buf
 -ğ(
‘h”_h—d”
);

976 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

977 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

980 
¦Ù
->
Ën
 = 
‹m¶’
;

982 
¦Ù
->
æags
 = 0;

985 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

987 --
³r_cÜe_couÁs
[
cÜeid
];

988 
¦Ù
->
æags
 |ğ
NS_REPORT
;

989 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

991 
ršg
->
h—d
 =„šg->
cur
;

992 
pŞlfd
 
pfd
;

993 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

994 
pfd
.
ev’ts
 = 
POLLOUT
;

995 
pfd
.
»v’ts
 = 0;

996 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

998 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

1001 
™_dp
++;

1003 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

1004 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1005 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1006 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1007 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1008 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

1009 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

1012 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1015 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)(
tx_buf
 + 
vœt_hdr_Ën
));

1016 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

1018 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1019 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

1020 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

1021 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

1022 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

1023 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

1025 
£nd_¬p_»q
 = 
çl£
;

1028 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1031 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

1032 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1033 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1035 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1036 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1038 
¦Ù
->
æags
 = 0;

1039 
³r_cÜe_couÁs
[
cÜeid
] = 0;

1041 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1043 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1045 
ršg
->
h—d
 =„šg->
cur
;

1046 
pŞlfd
 
pfd
;

1047 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1048 
pfd
.
ev’ts
 = 
POLLOUT
;

1049 
pfd
.
»v’ts
 = 0;

1050 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1059 #ifdef 
PRINT_STATS


1060 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1063 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1064 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1067 if(
cÜeid
 == 0) {

1068 
£nd_™”
++;

1071 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1072 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1080 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1082 
¦Ù
->
æags
 = 0;

1085 --
³r_cÜe_couÁs
[
cÜeid
];

1086 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1087 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1089 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1091 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1092 
ršg
->
h—d
 =„šg->
cur
;

1093 
pŞlfd
 
pfd
;

1094 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1095 
pfd
.
ev’ts
 = 
POLLOUT
;

1096 
pfd
.
»v’ts
 = 0;

1097 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1099 
	}
}

1102 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1103 #iâdeà
OPT_FOR_SINGLE_CORE


1104 !
»cv_ma¡”_nmd
) {

1105 
this_th»ad
::
	`y›ld
();

1108 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1109 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1110 
nm»q
 
ba£_»q
;

1111 
š‹rçû
[32];

1112 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1114 #ifdeà
OPT_FOR_SINGLE_CORE


1115 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1116 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1118 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1119 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1121 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1122 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1123  
NULL
;

1125 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1126 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1127 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1129 ià(
cÜeid
==0) {

1130 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1131 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1134 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1135 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1136 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1138 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1139 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1140  
NULL
;

1142 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1143 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1144 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1146 
	`D
("zerocopy %s",

1147 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1151 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

1153 #ifdeà
OPT_FOR_SINGLE_CORE


1155 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

1157 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

1161 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

1164 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1165 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1166 
‘h”_addr
 
‹mp_‘h_addr
;

1168 ià(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
)) {

1169 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1172 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1174 ià(
	`uÆik–y
(!
tx_buf
)) {

1175 
	`D
("TXƒrror occurred");

1178 
tx_buf
 =x_buà- (
‘h”_h—d”
);

1180 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1181 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1186 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1187 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1189 
¦Ù
->
Ën
 = 
‹m¶’
;

1191 
¦Ù
->
æags
 = 0;

1194 --
³r_cÜe_couÁs
[
cÜeid
];

1195 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1196 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1198 
ršg
->
h—d
 =„šg->
cur
;

1199 
pŞlfd
 
pfd
;

1200 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1201 
pfd
.
ev’ts
 = 
POLLOUT
;

1202 
pfd
.
»v’ts
 = 0;

1203 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1205 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1208 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

1209 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1210 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1212 
™
++;

1215 
	`g‘_bufãr_tx
(
cÜeid
);

1219 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1220 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1232 
ušt16_t
 
n
;

1233 
pŞlfd
 
pfd
;

1234 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1235 
pfd
.
ev’ts
 = 
POLLIN
;

1236 
pfd
.
»v’ts
 = 0;

1237 
ršg
->
h—d
 =„šg->
cur
;

1238 #ifdeà
BUSY_WAIT


1239 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1240 
	`D
("ioctlƒrror on queue %d: %s", 0,

1241 
	`¡»¼Ü
(
”ºo
));

1242  
NULL
;

1245 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1248 if(
do_abÜt
) {

1249  
NULL
;

1253 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1254 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1255 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1256  
NULL
;

1259 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1260 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1261 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1263 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1265 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1266  
NULL
;

1269 
¡¬t
:

1270 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1271 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1273 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1275 #ifdeà
OPT_FOR_SINGLE_CORE


1277 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1279 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1281 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1282 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1283 
‘h”_addr
 
‹mp_eh
;

1284 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1285 
ušt32_t
 
£nd_
 = 
¬µkt
->
ah
.
£nd”_
;

1286 
¬±abË
.
	`š£¹
(
£nd_
, 
‹mp_eh
);

1287 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1298 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1300 ià(
	`uÆik–y
(!
tx_buf
)) {

1301 
	`D
("TXƒrror occurred");

1304 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1305 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1311 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1312 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1314 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1316 
¦Ù
->
æags
 = 0;

1319 --
³r_cÜe_couÁs
[
cÜeid
];

1320 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1321 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1323 
ršg
->
h—d
 =„šg->
cur
;

1324 
pŞlfd
 
pfd
;

1325 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1326 
pfd
.
ev’ts
 = 
POLLOUT
;

1327 
pfd
.
»v’ts
 = 0;

1328 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1338 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1339 
³r_cÜe_couÁr
[
cÜeid
]--;

1340 
pktcouÁ
++;

1341 
¡¬t
;

1345  (*)((*)
pkt
+(
‘h”_h—d”
));

1348  
NULL
;

1350 
	}
}

1353 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1355 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1357 #ifdeà
OPT_FOR_SINGLE_CORE


1359 #ifdef 
PRINT_STATS


1360 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1362 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1363 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1366 if(
cÜeid
 == 0) {

1367 
»cv_™”
++;

1370 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1371 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1375 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1376 
³r_cÜe_couÁr
[
cÜeid
]--;

1377 
	}
}

1378 #iâdef 
OPT_FOR_SINGLE_CORE


1381 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1383 
£nd_th»ad_cÜe
;

1385 #if 
N_MINUS_2_CONFIG


1386 if(
cÜes_avaabË
 > 2) {

1387 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1388 } if(
cÜes_avaabË
 == 2) {

1389 
£nd_th»ad_cÜe
 = 1;

1391 
£nd_th»ad_cÜe
 = 0;

1393 #–if 
N_MINUS_1_CONFIG


1394 if(
cÜes_avaabË
 > 1) {

1395 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1397 
£nd_th»ad_cÜe
 = 0;

1400 if(
cÜes_avaabË
 > 1) {

1401 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1403 
£nd_th»ad_cÜe
 = 0;

1407 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1408 
this_th»ad
::
	`y›ld
();

1411 
ušt32_t
 
i
;

1412 
rv
;

1413 
veùÜ
<
pÜt_des
> 
pÜts
;

1414 
ušt64_t
 
™”
 = 0;

1415 
ušt32_t
 
Åes
;

1416 
pÜt_des
 *
rxpÜt
;

1417 
pÜt_des
 *
txpÜt
;

1419 
nm»q
 
ba£_»q
;

1420 
ušt32_t
 
exŒa_bufs
;

1421 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1422 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1423 
Ãtm­_ršg
 *
txršg
;

1425 
Åes
 = 
£nd_ouut_ršgs
;

1427 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1428 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1430 
	`D
("Åes:%u",
Åes
);

1432 
pÜts
.
	`»size
(
Åes
+2);

1434 
txpÜt
 = &
pÜts
[
Åes
];

1435 
rxpÜt
 = &
pÜts
[
Åes
+1];

1437 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1438 
	`D
("failedo‡llocatehe stats‡rray");

1439  
NULL
;

1442 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1444 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1445 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1447 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1448 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1449  
NULL
;

1451 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1452 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1455 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1456 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1457 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1459 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1460 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1461 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1462 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1464 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1465 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1466  
NULL
;

1468 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1469 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1473 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1474 
txršg
 = 
txpÜt
->
ršg
;

1475 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1477 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1479 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1481 
i
 = 0; i < 
Åes
; ++i) {

1482 
š‹rçû
[32];

1483 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1484 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1485 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1487 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1488 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1489  
NULL
;

1491 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1492 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1493 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1495 
	`D
("zerocopy %s",

1496 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1499 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1500 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1502 
	`¦“p
(2);

1504 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1506 #ifdef 
PRINT_STATS


1507 
i
 = 0; i < 
Åes
+2; ++i) {

1508 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1531 !
do_abÜt
) {

1532 
u_št
 
pŞlo
 = 0;

1534 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1535 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1538 
™”
++;

1540 
i
 = 0; i < 
Åes
; ++i) {

1541 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1542 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1546 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1547 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1548 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1549 
úts
[
pŞlo
] = 
i
;

1550 ++
pŞlo
;

1552 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1553 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1554 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1556 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1568 
‹mp_couÁ
;

1569 
boŞ
 
Ãed_æush
 = 
çl£
;

1570 
b©ch_cur
 = 0,
™emp
;

1572 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1574 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1575 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1576 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1577 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1578 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1588 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1590 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1591 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1592 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1593 
Ãed_æush
 = 
Œue
;

1596 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1603 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1604 
b©ch_cur
 = 
£nd_b©ch
;

1605 
txršg
->
h—d
 =xršg->
cur
;

1609 #ifdeà
BUSY_WAIT


1610 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1611 
	`D
("ioctlƒrror on queue %d: %s", 0,

1612 
	`¡»¼Ü
(
”ºo
));

1613  
NULL
;

1616 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1617 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1618 
	`¡»¼Ü
(
”ºo
));

1619  
NULL
;

1621 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1622 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1623 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1624  
NULL
;

1627 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1628 ià(
n
 < 
b©ch_cur
)

1629 
b©ch_cur
 = 
n
;

1632 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1633 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1634 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1636 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1639 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1640 
tx¦Ù
->
æags
 = 0;

1641 
b©ch_cur
--;

1647 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1657 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1658 
Ãed_æush
 = 
Œue
;

1659 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1661 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1664 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1665 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1666 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1668 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1669 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1672 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1673 
b©ch_cur
 = 
£nd_b©ch
;

1674 
txršg
->
h—d
 =xršg->
cur
;

1678 #ifdeà
BUSY_WAIT


1679 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1680 
	`D
("ioctlƒrror on queue %d: %s", 0,

1681 
	`¡»¼Ü
(
”ºo
));

1682  
NULL
;

1685 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1686 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1687 
	`¡»¼Ü
(
”ºo
));

1688  
NULL
;

1690 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1691 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1692 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1693  
NULL
;

1696 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1697 ià(
n
 < 
b©ch_cur
)

1698 
b©ch_cur
 = 
n
;

1701 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1702 *
tx_buf
 = (*è
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
è+ 
vœt_hdr_Ën
;

1704 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1705 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1706 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1708 
tx¦Ù
->
æags
 = 0;

1709 
b©ch_cur
--;

1711 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1713 #ifdef 
PRINT_STATS


1714 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1716 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1717 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1722 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1728 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1729 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1730 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1732 
™
++;

1736 ià(
	`uÆik–y
(
Ãed_æush
)) {

1738 
b©ch_cur
 = 0;

1739 
txršg
->
h—d
 =xršg->
cur
;

1740 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1743 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1745 
³ndšg_¬p_»q_th
.
	`ş—r
();

1750 ià(
rv
 <= 0) {

1751 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1752 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1757 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1758 
i
 = 
úts
[
™emp
];

1759 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1763 
Ãxt_cur
 = 
ršg
->
cur
;

1764 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1765 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1766 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1767 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1768 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1771 
»cvcouÁ
--) {

1773 
tİ
:

1774 
n
;

1775 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1776 
b©ch_cur
 = 
£nd_b©ch
;

1780 #ifdeà
BUSY_WAIT


1781 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1782 
	`D
("ioctlƒrror on queue %d: %s", 0,

1783 
	`¡»¼Ü
(
”ºo
));

1784  
NULL
;

1787 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1788 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1789 
	`¡»¼Ü
(
”ºo
));

1790  
NULL
;

1792 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1793 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1794 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1795  
NULL
;

1798 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1799 ià(
n
 < 
b©ch_cur
)

1800 
b©ch_cur
 = 
n
;

1803 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1804 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1805 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1806 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1807 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1808 
	`__butš_´eãtch
(
Ãxt_buf
);

1810 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1811 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1812 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1813 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1814 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1815 
pkthdr_rxpkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1819 
tx¦Ù
->
Ën
=
rs
->len;

1839 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1840 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1842 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1844 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1845 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1850 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)(
‹mpbuf
+
vœt_hdr_Ën
));

1851 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1854 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1855 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1858 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1859 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1860 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1861 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1863 
£nd_¬p_»q
 = 
çl£
;

1866 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1868 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1869 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1870 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1872 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1874 
tx¦Ù
->
æags
 = 0;

1876 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1878 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1880 
b©ch_cur
 = 0;

1881 
txršg
->
h—d
 =xršg->
cur
;

1882 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1891 
tx¦Ù
->
æags
 = 0;

1892 
b©ch_cur
--;

1893 #ifdef 
PRINT_STATS


1894 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1896 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1897 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1899 ià(
b©ch_cur
==0 || 
tx¦Ù
->
Ën
 < 256) {

1900 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1902 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1903 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1904 
b©ch_cur
 = 0;

1905 
txršg
->
h—d
 =xršg->
cur
;

1906 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1909 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1914 
	`¦“p
(5);

1915 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1916 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1919  
NULL
;

1920 
	}
}

1923 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1925 
»cv_th»ad_cÜe
;

1927 #if 
N_MINUS_2_CONFIG


1928 if(
cÜes_avaabË
 > 2) {

1929 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1930 } if(
cÜes_avaabË
 == 2) {

1931 
»cv_th»ad_cÜe
 = 1;

1933 
»cv_th»ad_cÜe
 = 0;

1935 #–if 
N_MINUS_1_CONFIG


1936 if(
cÜes_avaabË
 > 1) {

1937 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1939 
»cv_th»ad_cÜe
 = 0;

1942 if(
cÜes_avaabË
 > 1) {

1943 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1945 
»cv_th»ad_cÜe
 = 0;

1949 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1950 
this_th»ad
::
	`y›ld
();

1953 
ušt32_t
 
i
;

1954 
rv
;

1955 
veùÜ
<
pÜt_des
> 
pÜts
;

1956 
™”
 = 0;

1957 
ušt32_t
 
Åes
;

1958 
ov”æow_queue
 *
ä“q
;

1959 
pÜt_des
 *
rxpÜt
;

1960 
pÜt_des
 *
txpÜt
;

1962 
nm»q
 
ba£_»q
;

1963 
ušt32_t
 
exŒa_bufs
;

1964 
veùÜ
<
ov”æow_queue
> 
oq
;

1965 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1967 
Åes
 = 
»cv_ouut_ršgs
;

1968 
ä“q
 = 
NULL
;

1970 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1971 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1973 
	`D
("Åes:%u",
Åes
);

1975 
pÜts
.
	`»size
(
Åes
+2);

1980 
oq
.
	`»size
(
Åes
+1);

1981 ià(
oq
.
	`size
()!=
Åes
+1) {

1982 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1983  
NULL
;

1986 
rxpÜt
 = &
pÜts
[
Åes
];

1987 
txpÜt
 = &
pÜts
[
Åes
+1];

1989 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1990 
	`D
("failedo‡llocatehe stats‡rray");

1991  
NULL
;

1994 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1996 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1997 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1999 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

2000 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

2001  
NULL
;

2003 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

2004 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

2007 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

2008 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

2009 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

2011 
	`mem£t
(&
ba£_»q
, 0, (base_req));

2012 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

2013 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

2014 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

2016 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

2017 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

2018  
NULL
;

2020 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

2021 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

2025 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

2026 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

2028 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

2030 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

2031 ià(!
exŒa_bufs
)

2032 
run
;

2034 
ä“q
 = &
oq
[
Åes
];

2035 
rxpÜt
->
oq
 = 
NULL
;

2036 
txpÜt
->
oq
 = 
ä“q
;

2038 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

2044 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

2045 
rv
;

2046 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

2048 
Ãtm­_¦Ù
 
s
;

2049 
s
.
buf_idx
 = 
rv
;

2050 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

2051 
ä“q
->
¦Ùs
.
	`push
(
s
);

2053 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

2054 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

2055 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

2056  
NULL
;

2058 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

2060 
run
:

2061 
i
 = 0; i < 
Åes
; ++i) {

2062 
š‹rçû
[32];

2063 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

2064 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

2065 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

2067 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

2068 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

2069  
NULL
;

2071 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

2072 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

2073 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

2075 
	`D
("zerocopy %s",

2076 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

2078 ià(
exŒa_bufs
) {

2079 
ov”æow_queue
 *
q
 = &
oq
[
i
];

2080 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

2081 
pÜts
[
i
].
oq
 = 
q
;

2085 ià(!
exŒa_bufs
) {

2086 ià(!
oq
.
	`em±y
()) {

2087 
i
 = 0; i < 
Åes
 + 1; i++) {

2088 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

2089 
oq
[
i
].
¦Ùs
.
	`pİ
();

2091 
pÜts
[
i
].
oq
 = 
NULL
;

2093 
pÜts
[
i
].
oq
 = 
NULL
;

2094 
oq
.
	`ş—r
();

2096 
	`D
("*** overflow queues disabled ***");

2099 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

2100 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

2102 
	`¦“p
(2);

2104 !
§ã_to_¡¬t_»cv
) {

2105 
this_th»ad
::
	`y›ld
();

2108 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

2110 #ifdef 
PRINT_STATS


2111 
i
 = 0; i < 
Åes
+2; ++i) {

2112 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

2135 !
do_abÜt
) {

2136 
u_št
 
pŞli
 = 0;

2138 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

2139 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

2142 
™”
++;

2143 
i
 = 0; i < 
Åes
; ++i) {

2144 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

2145 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

2149 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

2150 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

2151 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2152 ++
pŞli
;

2154 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

2155 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

2156 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2157 ++
pŞli
;

2159 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

2160 ià(
rv
 <= 0) {

2161 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

2162 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

2166 ià(!
oq
.
	`em±y
()) {

2170 
i
 = 0; i < 
Åes
; i++) {

2171 
pÜt_des
 *
p
 = &
pÜts
[
i
];

2172 
ov”æow_queue
 *
q
 = 
p
->
oq
;

2173 
ušt32_t
 
j
, 
lim
;

2174 
Ãtm­_ršg
 *
ršg
;

2175 
Ãtm­_¦Ù
 *
¦Ù
;

2177 ià(
q
->
¦Ùs
.
	`em±y
())

2179 
ršg
 = 
p
->ring;

2180 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

2181 ià(!
lim
)

2183 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

2184 
lim
 = 
q
->
¦Ùs
.
	`size
();

2185 
j
 = 0; j < 
lim
; j++) {

2186 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

2187 
q
->
¦Ùs
.
	`pİ
();

2188 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

2189 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

2190 *
¦Ù
 = 
s
;

2191 #ifdef 
PRINT_STATS


2192 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

2194 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2195 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

2197 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

2198 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2200 
ršg
->
h—d
 =„šg->
cur
;

2204 
b©ch_cur
 = 0;

2205 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

2206 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

2208 
Ãxt_cur
 = 
rxršg
->
cur
;

2209 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2210 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2211 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

2212 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

2213 
ršg¥aû
 = 
MAX_BATCH_RECV
;

2215 
ršg¥aû
--) {

2216 
ov”æow_queue
 *
q
;

2217 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

2218 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

2219 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

2221 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2223 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2224 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

2226 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

2228 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

2230 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

2232 
_mac_·œ
 
‹mp_·œ
;

2233 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

2234 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

2235 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

2238 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2239 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2240 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2241 
	`__butš_´eãtch
(
Ãxt_buf
);

2242 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2244 
b©ch_cur
++;

2245 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2246 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2247 
b©ch_cur
 = 0;

2270 
ušt32_t
 
ouut_pÜt
 = 0;

2271 if(
»cv_th»ad_cÜe
) {

2272 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

2273 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

2276 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2277 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2278 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2279 
	`__butš_´eãtch
(
Ãxt_buf
);

2280 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

2281 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

2282 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

2285 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2286 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2287 *
cİy_buf
;

2288 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2289 
ts
->
Ën
 = 
rs
->len;

2290 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2292 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2294 #ifdef 
PRINT_STATS


2295 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2298 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2299 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2302 
fÜw¬d
;

2306 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2307 #ifdef 
PRINT_STATS


2308 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2310 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2311 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2313 
Ãxt
;

2316 
q
 = &
oq
[
ouut_pÜt
];

2318 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2320 
ušt32_t
 
j
;

2321 
pÜt_des
 *
Í
 = &
pÜts
[0];

2322 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2324 
j
 = 1; j < 
Åes
; j++) {

2325 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2326 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2327 
Í
 = 
ı
;

2328 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2333 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2334 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2335 #ifdef 
PRINT_STATS


2336 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2338 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2339 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2342 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2343 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2346 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2349 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2350 
ä“q
->
¦Ùs
.
	`pİ
();

2352 *
‹mp_buf
;

2353 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2354 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2355 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2356 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2358 
fÜw¬d
:

2360 
Ãxt
:

2361 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2363 
b©ch_cur
++;

2364 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2365 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2366 
b©ch_cur
 = 0;

2373 ià(
exŒa_bufs
) {

2374 
	`ä“_bufãrs
(
pÜts
);

2376 
	`¦“p
(5);

2377 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2378 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2381  
NULL
;

2382 
	}
}

2386 
u_št16_t


2387 
	$w¿psum
(
u_št32_t
 
sum
)

2389 
sum
 = ~sum & 0xFFFF;

2390  (
	`htÚs
(
sum
));

2391 
	}
}

2394 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2396 
s
;

2397 
iäeq
 
bufãr
;

2398 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2400 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2401 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2403 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2405 
	`şo£
(
s
);

2406 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2407 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2408 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2409 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2410 
fd
;

2411 
iäeq
 
iä
;

2413 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2416 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2419 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2421 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2423 
	`şo£
(
fd
);

2426 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2427 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2428 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2435 #iâdef 
OPT_FOR_SINGLE_CORE


2436 
š_addr
 
©t
;

2437 
	`š‘_©Ú
("169.254.9.28", &
©t
);

2440 if(
¬±abË
.
	`fšd
(
©t
.
s_addr
)!÷½bË.
	`’d
()) {

2441 
	`D
("Hurray 2");

2442 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
.
s_addr
]));

2446 
	}
}

	@netmap_api_cache_friendly.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

440 
	`¥rštf
(
iâame
, "netmap:%s", "eth3");

441 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

442 
	`sourû_hwaddr
(
iâame
);

443 
	`š™Ÿlize_£nd_»cv
();

445 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

446 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

448 
ušt8_t
 
i
; i<
£nd_ouut_ršgs
; i++) {

449 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

452 
ušt8_t
 
i
; i<
»cv_ouut_ršgs
; i++) {

453 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

456 #ifdef 
OPT_FOR_SINGLE_CORE


459 
£nd_™”
 = 
»cv_™”
 = 0;

462 
§ã_to_¡¬t_»cv
 = 
Œue
;

463 
	}
}

469 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

471 
buf
[128];

472 
i
, 
j
, 
i0
;

473 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

481 
i
 = 0; i < 
Ën
; ) {

482 
	`mem£t
(
buf
, (buf), ' ');

483 
	`¥rštf
(
buf
, "%5d: ", 
i
);

484 
i0
 = 
i
;

485 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

486 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

487 
i
 = 
i0
;

488 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

489 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

490 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

491 
	`´štf
("%s\n", 
buf
);

493 
	}
}

495 
	gN‘m­U£
::~
	$N‘m­U£
() {

496 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

497 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

498 
	`g‘timeofday
(&
’d_time
, 
NULL
);

500  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

501 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

504  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

505 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

508 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

509 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

510 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

511 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

513 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

514 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

515 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

516 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

518 #iâdeà
OPT_FOR_SINGLE_CORE


519 
£nd_th»ad
.
	`još
();

520 
»cv_th»ad
.
	`još
();

526 
	`¦“p
(5);

532 
cout
<<"Com¶‘ed"<<
’dl
;

533 
	}
}

536 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

538 
nm»q
 
»q
;

539 
”r
;

541 
	`mem£t
(&
»q
, 0, (req));

542 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

543 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

544 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

545 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

546 ià(
”r
) {

547 
	`D
("Unableo get virtio-net header†ength");

551 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

552 ià(
vœt_hdr_Ën
) {

553 
	`D
("Port„equires virtio-net header,†ength = %d",

554 
vœt_hdr_Ën
);

556 
	}
}

559 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

561 #ifdef 
PRINT_STATS


562 #iâdef 
OPT_FOR_SINGLE_CORE


564 
ušt32_t
 
th»ad_cÜe
;

565 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

573 
Åes
 = 
»cv_ouut_ršgs
;

574 
sys_št
 = 0;

575 
my_ùrs
 
cur
, 
´ev
;

576 
b1
[40], 
b2
[40];

577 
my_ùrs
 *
pe_´ev
;

579 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

580 ià(
pe_´ev
 =ğ
NULL
) {

581 
	`D
("out of memory");

582 
	`ex™
(1);

585 
	`mem£t
(&
´ev
, 0, (prev));

586 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

587 !
do_abÜt
) {

588 
j
, 
dosy¦og
 = 0;

589 
ušt64_t
 
µs
, 
dps
, 
u£c
;

590 
my_ùrs
 
x
;

592 
	`mem£t
(&
cur
, 0, (cur));

593 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

595 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

596 
dosy¦og
 = 1;

597 
sys_št
 = 0;

600 
j
 = 0; j < 
Åes
; ++j) {

601 
pÜt_des
 *
p
 = &
pÜts
[
j
];

603 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

604 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

606 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

607 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

608 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

609 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

610 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

611 
pe_´ev
[
j
] = 
p
->
ùr
;

613 ià(
dosy¦og
) {

614 
	`sy¦og
(
LOG_INFO
,

619 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

622 
	`´štf
("\n");

632 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

633 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

634 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

635 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

636 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

637 
´ev
 = 
cur
;

640 
	`ä“
(
pe_´ev
);

641 
	`D
("Done");

644 
	}
}

647 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

648 
i
, 
	gtÙ
 = 0;

649 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

652 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

653 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

654 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

656 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

659 !
	gq
->
	g¦Ùs
.
em±y
()) {

660 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

661 
	gq
->
	g¦Ùs
.
pİ
();

662 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

664 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

665 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

666 
	gtÙ
++;

669 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

673 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

674 
ušt16_t
 
i
,
j
;

676 #ifdef 
PRINT_STATS


677 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

679 
£nd_ma¡”_nmd
 = 
NULL
;

680 
»cv_ma¡”_nmd
 = 
NULL
;

681 
§ã_to_¡¬t_»cv
 = 
çl£
;

682 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

683 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

684 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

685 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

687 #if 
N_MINUS_2_CONFIG


688 if(
cÜes_avaabË
>=3) {

689 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

691 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

694 #–if 
N_MINUS_1_CONFIG


695 if(
cÜes_avaabË
>=2) {

696 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

698 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

701 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

704 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

705 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

707 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

708 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

709 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

710 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

712 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

713 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

714 
³r_cÜe_couÁs
[
i
] = 0;

716 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

717 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

718 
³r_cÜe_couÁr
[
i
] = 0;

720 #iâdeà
OPT_FOR_SINGLE_CORE


721 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

723 
ıu_£t_t
 
ıu_£t
;

725 
th»ad_cÜe1
, 
th»ad_cÜe2
;

727 #if 
N_MINUS_2_CONFIG


728 if(
cÜes_avaabË
 > 2) {

729 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

730 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

731 } if(
cÜes_avaabË
 == 2) {

732 
th»ad_cÜe1
 = 1;

733 
th»ad_cÜe2
 = 1;

735 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

737 #–if 
N_MINUS_1_CONFIG


738 if(
cÜes_avaabË
 > 1) {

739 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

740 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

742 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

745 if(
cÜes_avaabË
 > 1) {

746 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

747 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

749 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

753 
	`CPU_ZERO
(&
ıu_£t
);

754 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

755 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

756 if(
rc
!=0) {

757 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

760 
j
 = 0; j < 
CPU_SETSIZE
; j++)

761 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

762 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

766 
	`¦“p
(2);

768 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

770 
	`CPU_ZERO
(&
ıu_£t
);

771 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

772 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

773 if(
rc
!=0) {

774 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

777 
j
 = 0; j < 
CPU_SETSIZE
; j++)

778 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

779 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

783 
	}
}

786 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

787 #iâdeà
OPT_FOR_SINGLE_CORE


788 !
£nd_ma¡”_nmd
) {

789 
this_th»ad
::
	`y›ld
();

792 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

793 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

794 
nm»q
 
ba£_»q
;

795 
š‹rçû
[32];

796 
	`mem£t
(&
ba£_»q
, 0, (base_req));

797 #ifdeà
OPT_FOR_SINGLE_CORE


798 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

799 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

801 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

802 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

804 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

805 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

806  
NULL
;

808 
	`D
("successfully opened core #%d %s (tx slots: %d)",

809 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

810 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

812 ià(
cÜeid
==0) {

813 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

814 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

817 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

818 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

819 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

821 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

822 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

823  
NULL
;

825 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

826 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

827 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

829 
	`D
("zerocopy %s",

830 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

833 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

837 
ušt16_t
 
n
;

838 
pŞlfd
 
pfd
;

839 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

840 
pfd
.
ev’ts
 = 
POLLOUT
;

841 
pfd
.
»v’ts
 = 0;

842 #ifdeà
BUSY_WAIT


843 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

844 
	`D
("ioctlƒrror on queue %d: %s", 0,

845 
	`¡»¼Ü
(
”ºo
));

846  
NULL
;

850 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

853 if(
do_abÜt
) {

854  
NULL
;

858 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

859 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

860 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

861  
NULL
;

864 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

865 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

866 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

868 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

871 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

872  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

873 
	}
}

876 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

877 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

878 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

879 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

881 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

882 
¦Ù
->
æags
 = 0;

884 #ifdeà
OPT_FOR_SINGLE_CORE


886 #ifdef 
PRINT_STATS


887 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

890 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

891 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

894 if(
cÜeid
 == 0) {

895 
£nd_™”
++;

898 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

899 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

902 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

903 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

905 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

907 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

911 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

912 
¦Ù
->
æags
 |ğ
NS_REPORT
;

914 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

916 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

917 
ršg
->
h—d
 =„šg->
cur
;

918 
pŞlfd
 
pfd
;

919 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

920 
pfd
.
ev’ts
 = 
POLLOUT
;

921 
pfd
.
»v’ts
 = 0;

922 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

924 
	}
}

927 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

928 #iâdeà
OPT_FOR_SINGLE_CORE


929 !
»cv_ma¡”_nmd
) {

930 
this_th»ad
::
	`y›ld
();

933 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

934 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

935 
nm»q
 
ba£_»q
;

936 
š‹rçû
[32];

937 
	`mem£t
(&
ba£_»q
, 0, (base_req));

939 #ifdeà
OPT_FOR_SINGLE_CORE


940 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

941 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

943 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

944 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

946 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

947 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

948  
NULL
;

950 
	`D
("successfully opened core #%d %s (rx slots: %d)",

951 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

952 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

954 ià(
cÜeid
==0) {

955 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

956 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

959 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

960 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

961 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

963 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

964 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

965  
NULL
;

967 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

968 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

969 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

971 
	`D
("zerocopy %s",

972 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

976 
¡¬t
:

977 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

981 
ušt16_t
 
n
;

982 
pŞlfd
 
pfd
;

983 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

984 
pfd
.
ev’ts
 = 
POLLIN
;

985 
pfd
.
»v’ts
 = 0;

986 
ršg
->
h—d
 =„šg->
cur
;

987 #ifdeà
BUSY_WAIT


988 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

989 
	`D
("ioctlƒrror on queue %d: %s", 0,

990 
	`¡»¼Ü
(
”ºo
));

991  
NULL
;

994 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

997 if(
do_abÜt
) {

998  
NULL
;

1002 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1003 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1004 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1005  
NULL
;

1008 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1009 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1010 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1012 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1014 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1016 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1017 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1018 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1020 #ifdeà
OPT_FOR_SINGLE_CORE


1021 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1022 if(
ARP_ENABLED
) {

1023 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1026 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1027 
³r_cÜe_couÁr
[
cÜeid
]--;

1028 
¡¬t
;

1031  (*)((*)
pkt
+(
‘h”_h—d”
));

1033  
NULL
;

1035 
	}
}

1038 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1040 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1042 #ifdeà
OPT_FOR_SINGLE_CORE


1044 #ifdef 
PRINT_STATS


1045 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1047 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1048 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1051 if(
cÜeid
 == 0) {

1052 
»cv_™”
++;

1055 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1056 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1060 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1061 
³r_cÜe_couÁr
[
cÜeid
]--;

1062 
	}
}

1065 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1067 
£nd_th»ad_cÜe
;

1069 #if 
N_MINUS_2_CONFIG


1070 if(
cÜes_avaabË
 > 2) {

1071 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1072 } if(
cÜes_avaabË
 == 2) {

1073 
£nd_th»ad_cÜe
 = 1;

1075 
£nd_th»ad_cÜe
 = 0;

1077 #–if 
N_MINUS_1_CONFIG


1078 if(
cÜes_avaabË
 > 1) {

1079 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1081 
£nd_th»ad_cÜe
 = 0;

1084 if(
cÜes_avaabË
 > 1) {

1085 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1087 
£nd_th»ad_cÜe
 = 0;

1091 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1092 
this_th»ad
::
	`y›ld
();

1095 
ušt32_t
 
i
;

1096 
rv
;

1097 
veùÜ
<
pÜt_des
> 
pÜts
;

1098 
ušt64_t
 
™”
 = 0;

1099 
ušt32_t
 
Åes
;

1100 
pÜt_des
 *
rxpÜt
;

1101 
pÜt_des
 *
txpÜt
;

1103 
nm»q
 
ba£_»q
;

1104 
ušt32_t
 
exŒa_bufs
;

1105 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1106 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1107 
Ãtm­_ršg
 *
txršg
;

1109 
Åes
 = 
£nd_ouut_ršgs
;

1111 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1112 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1114 
	`D
("Åes:%u",
Åes
);

1116 
pÜts
.
	`»size
(
Åes
+2);

1118 
txpÜt
 = &
pÜts
[
Åes
];

1119 
rxpÜt
 = &
pÜts
[
Åes
+1];

1121 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1122 
	`D
("failedo‡llocatehe stats‡rray");

1123  
NULL
;

1126 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1128 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1129 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1131 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1132 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1133  
NULL
;

1135 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1136 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1139 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1140 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1141 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1143 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1144 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1145 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1146 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1148 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1149 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1150  
NULL
;

1152 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1153 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1157 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1158 
txršg
 = 
txpÜt
->
ršg
;

1159 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1161 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1163 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1165 
i
 = 0; i < 
Åes
; ++i) {

1166 
š‹rçû
[32];

1167 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1168 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1169 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1171 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1172 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1173  
NULL
;

1175 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1176 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1177 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1179 
	`D
("zerocopy %s",

1180 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1183 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1184 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1186 
	`¦“p
(2);

1188 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1190 #ifdef 
PRINT_STATS


1191 
i
 = 0; i < 
Åes
+2; ++i) {

1192 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1215 !
do_abÜt
) {

1216 
u_št
 
pŞlo
 = 0;

1218 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1219 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1222 
™”
++;

1224 
i
 = 0; i < 
Åes
; ++i) {

1225 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1226 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1230 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1231 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1232 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1233 
úts
[
pŞlo
] = 
i
;

1234 ++
pŞlo
;

1236 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1237 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1238 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1240 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1241 ià(
rv
 <= 0) {

1242 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1243 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1247 
b©ch_cur
 = 0,
™emp
;

1248 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1249 
i
 = 
úts
[
™emp
];

1250 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1252 
Ãxt_cur
 = 
ršg
->
cur
;

1253 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1254 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1255 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1256 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1257 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1259 
»cvcouÁ
--) {

1260 
n
;

1261 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1262 
b©ch_cur
 = 
£nd_b©ch
;

1266 #ifdeà
BUSY_WAIT


1267 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1268 
	`D
("ioctlƒrror on queue %d: %s", 0,

1269 
	`¡»¼Ü
(
”ºo
));

1270  
NULL
;

1273 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1274 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1275 
	`¡»¼Ü
(
”ºo
));

1276  
NULL
;

1278 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1279 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1280 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1281  
NULL
;

1284 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1285 ià(
n
 < 
b©ch_cur
)

1286 
b©ch_cur
 = 
n
;

1289 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1290 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1291 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1292 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1293 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1294 
	`__butš_´eãtch
(
Ãxt_buf
);

1296 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1297 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1298 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1300 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1301 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1302 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1303 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1305 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1307 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1308 
tx¦Ù
->
Ën
=
rs
->len;

1310 
tx¦Ù
->
æags
 = 0;

1311 
b©ch_cur
--;

1312 #ifdef 
PRINT_STATS


1313 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1315 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1316 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1318 ià(
b©ch_cur
==0) {

1319 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1321 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1322 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1323 
b©ch_cur
 = 0;

1324 
txršg
->
h—d
 =xršg->
cur
;

1325 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1328 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1333 
	`¦“p
(5);

1334 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1335 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1338  
NULL
;

1339 
	}
}

1342 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1344 
»cv_th»ad_cÜe
;

1346 #if 
N_MINUS_2_CONFIG


1347 if(
cÜes_avaabË
 > 2) {

1348 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1349 } if(
cÜes_avaabË
 == 2) {

1350 
»cv_th»ad_cÜe
 = 1;

1352 
»cv_th»ad_cÜe
 = 0;

1354 #–if 
N_MINUS_1_CONFIG


1355 if(
cÜes_avaabË
 > 1) {

1356 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1358 
»cv_th»ad_cÜe
 = 0;

1361 if(
cÜes_avaabË
 > 1) {

1362 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1364 
»cv_th»ad_cÜe
 = 0;

1368 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1369 
this_th»ad
::
	`y›ld
();

1372 
ušt32_t
 
i
;

1373 
rv
;

1374 
veùÜ
<
pÜt_des
> 
pÜts
;

1375 
™”
 = 0;

1376 
ušt32_t
 
Åes
;

1377 
ov”æow_queue
 *
ä“q
;

1378 
pÜt_des
 *
rxpÜt
;

1379 
pÜt_des
 *
txpÜt
;

1381 
nm»q
 
ba£_»q
;

1382 
ušt32_t
 
exŒa_bufs
;

1383 
veùÜ
<
ov”æow_queue
> 
oq
;

1384 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1386 
Åes
 = 
»cv_ouut_ršgs
;

1387 
ä“q
 = 
NULL
;

1389 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1390 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1392 
	`D
("Åes:%u",
Åes
);

1394 
pÜts
.
	`»size
(
Åes
+2);

1399 
oq
.
	`»size
(
Åes
+1);

1400 ià(
oq
.
	`size
()!=
Åes
+1) {

1401 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1402  
NULL
;

1405 
rxpÜt
 = &
pÜts
[
Åes
];

1406 
txpÜt
 = &
pÜts
[
Åes
+1];

1408 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1409 
	`D
("failedo‡llocatehe stats‡rray");

1410  
NULL
;

1413 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1415 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1416 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1418 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1419 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1420  
NULL
;

1422 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1423 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1426 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1427 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1428 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1430 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1431 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1432 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1433 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1435 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1436 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1437  
NULL
;

1439 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1440 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1444 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1445 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1447 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1449 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1450 ià(!
exŒa_bufs
)

1451 
run
;

1453 
ä“q
 = &
oq
[
Åes
];

1454 
rxpÜt
->
oq
 = 
NULL
;

1455 
txpÜt
->
oq
 = 
ä“q
;

1457 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1463 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1464 
rv
;

1465 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1467 
Ãtm­_¦Ù
 
s
;

1468 
s
.
buf_idx
 = 
rv
;

1469 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1470 
ä“q
->
¦Ùs
.
	`push
(
s
);

1472 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1473 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1474 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1475  
NULL
;

1477 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1479 
run
:

1480 
i
 = 0; i < 
Åes
; ++i) {

1481 
š‹rçû
[32];

1482 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1483 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1484 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1486 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1487 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1488  
NULL
;

1490 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1491 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1492 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1494 
	`D
("zerocopy %s",

1495 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1497 ià(
exŒa_bufs
) {

1498 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1499 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1500 
pÜts
[
i
].
oq
 = 
q
;

1504 ià(!
exŒa_bufs
) {

1505 ià(!
oq
.
	`em±y
()) {

1506 
i
 = 0; i < 
Åes
 + 1; i++) {

1507 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1508 
oq
[
i
].
¦Ùs
.
	`pİ
();

1510 
pÜts
[
i
].
oq
 = 
NULL
;

1512 
pÜts
[
i
].
oq
 = 
NULL
;

1513 
oq
.
	`ş—r
();

1515 
	`D
("*** overflow queues disabled ***");

1518 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1519 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1521 
	`¦“p
(2);

1523 !
§ã_to_¡¬t_»cv
) {

1524 
this_th»ad
::
	`y›ld
();

1527 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1529 #ifdef 
PRINT_STATS


1530 
i
 = 0; i < 
Åes
+2; ++i) {

1531 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1554 !
do_abÜt
) {

1555 
u_št
 
pŞli
 = 0;

1557 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1558 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1561 
™”
++;

1562 
i
 = 0; i < 
Åes
; ++i) {

1563 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1564 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1568 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1569 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1570 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1571 ++
pŞli
;

1573 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1574 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1575 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1576 ++
pŞli
;

1578 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1579 ià(
rv
 <= 0) {

1580 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1581 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1585 ià(!
oq
.
	`em±y
()) {

1589 
i
 = 0; i < 
Åes
; i++) {

1590 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1591 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1592 
ušt32_t
 
j
, 
lim
;

1593 
Ãtm­_ršg
 *
ršg
;

1594 
Ãtm­_¦Ù
 *
¦Ù
;

1596 ià(
q
->
¦Ùs
.
	`em±y
())

1598 
ršg
 = 
p
->ring;

1599 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1600 ià(!
lim
)

1602 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1603 
lim
 = 
q
->
¦Ùs
.
	`size
();

1604 
j
 = 0; j < 
lim
; j++) {

1605 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1606 
q
->
¦Ùs
.
	`pİ
();

1607 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1608 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1609 *
¦Ù
 = 
s
;

1610 #ifdef 
PRINT_STATS


1611 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1613 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1614 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1616 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1617 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1619 
ršg
->
h—d
 =„šg->
cur
;

1623 
b©ch_cur
 = 0;

1624 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1625 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1627 
Ãxt_cur
 = 
rxršg
->
cur
;

1628 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1629 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1630 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1631 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1632 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1634 
ršg¥aû
--) {

1635 
ov”æow_queue
 *
q
;

1636 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1637 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1638 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1641 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1642 if(
ARP_ENABLED
) {

1643 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1646 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1647 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1648 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1649 
	`__butš_´eãtch
(
Ãxt_buf
);

1650 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1652 
b©ch_cur
++;

1653 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1654 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1655 
b©ch_cur
 = 0;

1660 
ušt32_t
 
ouut_pÜt
 = 0;

1661 if(
»cv_th»ad_cÜe
) {

1662 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1663 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1666 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1667 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1668 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1669 
	`__butš_´eãtch
(
Ãxt_buf
);

1670 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1671 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1672 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1675 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1676 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1677 *
cİy_buf
;

1678 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1679 
ts
->
Ën
 = 
rs
->len;

1680 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1682 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1684 #ifdef 
PRINT_STATS


1685 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

1688 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1689 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1692 
fÜw¬d
;

1696 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1697 #ifdef 
PRINT_STATS


1698 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

1700 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1701 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1703 
Ãxt
;

1706 
q
 = &
oq
[
ouut_pÜt
];

1708 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1710 
ušt32_t
 
j
;

1711 
pÜt_des
 *
Í
 = &
pÜts
[0];

1712 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1714 
j
 = 1; j < 
Åes
; j++) {

1715 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1716 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1717 
Í
 = 
ı
;

1718 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

1723 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

1724 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

1725 #ifdef 
PRINT_STATS


1726 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

1728 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1729 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

1732 
Í
->
oq
->
¦Ùs
.
	`pİ
();

1733 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

1736 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

1739 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

1740 
ä“q
->
¦Ùs
.
	`pİ
();

1742 *
‹mp_buf
;

1743 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

1744 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

1745 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

1746 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

1748 
fÜw¬d
:

1750 
Ãxt
:

1751 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1753 
b©ch_cur
++;

1754 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1755 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1756 
b©ch_cur
 = 0;

1763 ià(
exŒa_bufs
) {

1764 
	`ä“_bufãrs
(
pÜts
);

1766 
	`¦“p
(5);

1767 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

1768 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1771  
NULL
;

1772 
	}
}

1775 
u_št16_t


1776 
	$w¿psum
(
u_št32_t
 
sum
)

1778 
sum
 = ~sum & 0xFFFF;

1779  (
	`htÚs
(
sum
));

1780 
	}
}

1783 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

1785 
s
;

1786 
iäeq
 
bufãr
;

1787 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

1789 
	`mem£t
(&
bufãr
, 0x00, (buffer));

1790 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

1792 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

1794 
	`şo£
(
s
);

1795 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

1796 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

1797 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

1798 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

1799 
fd
;

1800 
iäeq
 
iä
;

1802 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

1805 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

1808 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

1810 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

1812 
	`şo£
(
fd
);

1815 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

1816 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

1817 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

1820 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1821 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

1822 
	`D
("Hurray 1");

1825 
š_addr
 
©t
;

1826 
	`š‘_©Ú
("169.254.9.8", &
©t
);

1828 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

1829 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

1830 
	`D
("Hurray 2");

1831 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

1834 
	}
}

	@netmap_api_cache_unfriendly.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

393 
ušt32_t
 
th»ad_cÜe
 = 0;

395 #if 
N_MINUS_2_CONFIG


396 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

397 if(
STAT_ON_SEND_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

399 } if(
STAT_ON_RECV_CORE
) {

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

402 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

404 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

405 
th»ad_cÜe
 = 1;

407 
th»ad_cÜe
 = 0;

409 #–if 
N_MINUS_1_CONFIG


410 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

411 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

414 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

417 
th»ad_cÜe
 = 0;

420 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

421 if(
STAT_ON_SEND_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

423 } if(
STAT_ON_RECV_CORE
) {

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

426 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

429 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

430 
th»ad_cÜe
 = 1;

432 
th»ad_cÜe
 = 0;

437  
th»ad_cÜe
;

439 
	}
}

441 
	gN‘m­U£
::
	$N‘m­U£
() {

442 *
‹mp
;

443 
u_št
 
i
;

444 
‹¡couÁ
=0;

446 
num_»cv
 = 1;

447 
wa™_lšk
 = 2;

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth3");

457 
	`sourû_hwaddr
(
iâame
);

463 
	`š™Ÿlize_£nd_»cv
();

465 #ifdef 
OPT_FOR_SINGLE_CORE


468 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

469 
»cv_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

471 
ušt8_t
 
i
; i<
£nd_ouut_ršgs
; i++) {

472 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

473 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

476 
£nd_™”
 = 
»cv_™”
 = 0;

479 
§ã_to_¡¬t_»cv
 = 
Œue
;

480 
	}
}

486 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

488 
buf
[128];

489 
i
, 
j
, 
i0
;

490 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

498 
i
 = 0; i < 
Ën
; ) {

499 
	`mem£t
(
buf
, (buf), ' ');

500 
	`¥rštf
(
buf
, "%5d: ", 
i
);

501 
i0
 = 
i
;

502 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

503 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

504 
i
 = 
i0
;

505 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

506 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

507 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

508 
	`´štf
("%s\n", 
buf
);

510 
	}
}

512 
	gN‘m­U£
::~
	$N‘m­U£
() {

513 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

514 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

517 #iâdeà
OPT_FOR_SINGLE_CORE


518 
£nd_th»ad
.
	`još
();

519 
»cv_th»ad
.
	`još
();

524 
	`g‘timeofday
(&
’d_time
, 
NULL
);

526  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

527 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

528 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

531 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

532 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

533 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

534 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

537 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

538 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

539 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

540 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

545 
	`¦“p
(5);

546 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

552 
cout
<<"Com¶‘ed"<<
’dl
;

553 
	}
}

556 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

558 
nm»q
 
»q
;

559 
”r
;

561 
	`mem£t
(&
»q
, 0, (req));

562 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

563 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

564 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

565 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

566 ià(
”r
) {

567 
	`D
("Unableo get virtio-net header†ength");

571 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

572 ià(
vœt_hdr_Ën
) {

573 
	`D
("Port„equires virtio-net header,†ength = %d",

574 
vœt_hdr_Ën
);

576 
	}
}

579 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

581 
th»ad_cÜe
 = 0;

583 #iâdef 
OPT_FOR_SINGLE_CORE


585 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

593 
Åes
 = 
»cv_ouut_ršgs
;

594 
sys_št
 = 0;

595 
my_ùrs
 
cur
, 
´ev
;

596 
b1
[40], 
b2
[40];

597 
my_ùrs
 *
pe_´ev
;

599 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

600 ià(
pe_´ev
 =ğ
NULL
) {

601 
	`D
("out of memory");

602 
	`ex™
(1);

605 
	`mem£t
(&
´ev
, 0, (prev));

606 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

607 !
do_abÜt
) {

608 
j
, 
dosy¦og
 = 0;

609 
ušt64_t
 
µs
, 
dps
, 
u£c
;

610 
my_ùrs
 
x
;

612 
	`mem£t
(&
cur
, 0, (cur));

613 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

615 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

616 
dosy¦og
 = 1;

617 
sys_št
 = 0;

620 
j
 = 0; j < 
Åes
; ++j) {

621 
pÜt_des
 *
p
 = &
pÜts
[
j
];

623 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

624 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

626 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

627 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

628 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

629 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

630 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

631 
pe_´ev
[
j
] = 
p
->
ùr
;

633 ià(
dosy¦og
) {

634 
	`sy¦og
(
LOG_INFO
,

639 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

642 
	`´štf
("\n");

652 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

653 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

654 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

655 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

656 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

657 
´ev
 = 
cur
;

660 
	`ä“
(
pe_´ev
);

661 
	`D
("Done");

663 
	}
}

666 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

667 
i
, 
	gtÙ
 = 0;

668 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

671 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

672 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

673 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

675 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

678 !
	gq
->
	g¦Ùs
.
em±y
()) {

679 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

680 
	gq
->
	g¦Ùs
.
pİ
();

681 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

683 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

684 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

685 
	gtÙ
++;

688 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

692 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

693 
ušt16_t
 
i
,
j
;

695 
£nd_ma¡”_nmd
 = 
NULL
;

696 
»cv_ma¡”_nmd
 = 
NULL
;

698 
§ã_to_¡¬t_»cv
 = 
çl£
;

699 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

700 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

701 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

702 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

704 #if 
N_MINUS_2_CONFIG


705 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

706 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

708 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

711 #–if 
N_MINUS_1_CONFIG


712 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

713 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

715 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

718 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

722 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

723 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

724 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

727 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

728 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

729 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

730 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

731 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

738 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

739 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

740 
³r_cÜe_couÁs
[
i
] = 0;

742 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

743 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

744 
³r_cÜe_couÁr
[
i
] = 0;

747 #iâdeà
OPT_FOR_SINGLE_CORE


748 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

776 
ıu_£t_t
 
ıu_£t
;

778 
th»ad_cÜe1
, 
th»ad_cÜe2
;

780 #if 
N_MINUS_2_CONFIG


781 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

782 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

783 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

784 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

785 
th»ad_cÜe1
 = 1;

786 
th»ad_cÜe2
 = 1;

788 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

790 #–if 
N_MINUS_1_CONFIG


791 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

792 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

793 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

795 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

798 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

799 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

800 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

802 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

806 
	`CPU_ZERO
(&
ıu_£t
);

807 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

808 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

809 if(
rc
!=0) {

810 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

813 
j
 = 0; j < 
CPU_SETSIZE
; j++)

814 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

815 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

819 
	`¦“p
(2);

821 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

823 
	`CPU_ZERO
(&
ıu_£t
);

824 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

825 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

826 if(
rc
!=0) {

827 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

830 
j
 = 0; j < 
CPU_SETSIZE
; j++)

831 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

832 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

836 
	}
}

914 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

915 #iâdeà
OPT_FOR_SINGLE_CORE


916 !
£nd_ma¡”_nmd
) {

917 
this_th»ad
::
	`y›ld
();

920 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

921 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

922 
nm»q
 
ba£_»q
;

923 
š‹rçû
[25];

924 
	`mem£t
(&
ba£_»q
, 0, (base_req));

925 #ifdeà
OPT_FOR_SINGLE_CORE


926 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

927 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

929 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

930 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

932 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

933 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

934  
NULL
;

936 
	`D
("successfully opened core #%d %s (tx slots: %d)",

937 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

938 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

940 ià(
cÜeid
==0) {

941 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

942 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

945 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

946 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

947 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

949 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

950 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

951  
NULL
;

953 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

954 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

955 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

957 
	`D
("zerocopy %s",

958 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

964 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

968 
ušt16_t
 
n
;

969 
²
;

970 
pŞlfd
 
pfd
;

971 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

972 
pfd
.
ev’ts
 = 
POLLOUT
;

973 
pfd
.
»v’ts
 = 0;

974 #ifdeà
BUSY_WAIT


975 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

976 
	`D
("ioctlƒrror on queue %d: %s", 0,

977 
	`¡»¼Ü
(
”ºo
));

978  
NULL
;

982 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

985 if(
do_abÜt
) {

986  
NULL
;

990 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

991 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

992 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

993  
NULL
;

997 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

999 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

1000 if(
šc_bur¡
) {

1001 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

1002 
	`D
("Burst increased");

1005 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

1006 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

1008 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

1011 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1013  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

1014 
	}
}

1016 
	gcouÁ·ck‘ss
 = 0;

1018 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

1019 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1020 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1024 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

1026 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

1027 
¦Ù
->
æags
 = 0;

1032 #ifdeà
OPT_FOR_SINGLE_CORE


1033 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1035 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1037 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1040 if(
cÜeid
 == 0) {

1041 
£nd_™”
++;

1044 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1045 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1048 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1049 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1051 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1053 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1058 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1059 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1061 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1064 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1065 
ršg
->
h—d
 =„šg->
cur
;

1066 
pŞlfd
 
pfd
;

1067 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1068 
pfd
.
ev’ts
 = 
POLLOUT
;

1069 
pfd
.
»v’ts
 = 0;

1070 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1074 
	}
}

1076 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1077 #iâdeà
OPT_FOR_SINGLE_CORE


1078 !
»cv_ma¡”_nmd
) {

1079 
this_th»ad
::
	`y›ld
();

1082 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1083 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1084 
nm»q
 
ba£_»q
;

1085 
š‹rçû
[25];

1086 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1088 #ifdeà
OPT_FOR_SINGLE_CORE


1089 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1090 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1092 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1093 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1095 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1096 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1097  
NULL
;

1099 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1100 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1101 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1103 ià(
cÜeid
==0) {

1104 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1105 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1108 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1109 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1110 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1112 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1113 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1114  
NULL
;

1116 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1117 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1118 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1120 
	`D
("zerocopy %s",

1121 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1128 
¡¬t
:

1129 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1133 
ušt16_t
 
n
;

1134 
²
;

1135 
pŞlfd
 
pfd
;

1136 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1137 
pfd
.
ev’ts
 = 
POLLIN
;

1138 
pfd
.
»v’ts
 = 0;

1139 #ifdeà
BUSY_WAIT


1140 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1141 
	`D
("ioctlƒrror on queue %d: %s", 0,

1142 
	`¡»¼Ü
(
”ºo
));

1143  
NULL
;

1147 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1150 if(
do_abÜt
) {

1151  
NULL
;

1155 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1156 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1157 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1158  
NULL
;

1162 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1169 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1170 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1172 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1174 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1176 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1178 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1179 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1182 #ifdeà
OPT_FOR_SINGLE_CORE


1183 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1184 if(
ARP_ENABLED
) {

1185 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1188 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1189 
³r_cÜe_couÁr
[
cÜeid
]--;

1190 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1191 
ršg
->
h—d
 =„šg->
cur
;

1192 
pŞlfd
 
pfd
;

1193 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1194 
pfd
.
ev’ts
 = 
POLLIN
;

1195 
pfd
.
»v’ts
 = 0;

1196 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1199 
¡¬t
;

1203  (*)((*)
pkt
+(
‘h”_h—d”
));

1205  
NULL
;

1207 
	}
}

1209 
	gcouÁ·ck‘¤
 = 0;

1211 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1215 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1217 #ifdeà
OPT_FOR_SINGLE_CORE


1218 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1219 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1221 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1224 if(
cÜeid
 == 0) {

1225 
»cv_™”
++;

1228 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1229 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1233 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1234 
³r_cÜe_couÁr
[
cÜeid
]--;

1235 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1236 
ršg
->
h—d
 =„šg->
cur
;

1237 
pŞlfd
 
pfd
;

1238 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1239 
pfd
.
ev’ts
 = 
POLLIN
;

1240 
pfd
.
»v’ts
 = 0;

1244 
	}
}

1247 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1249 
£nd_th»ad_cÜe
;

1251 
time_t
 
¡¬t_t
, 
’d_t
;

1252 
¿‹_t
, 
diff_t
;

1253 
timev®
 
begš
, 
’d
;

1255 #if 
N_MINUS_2_CONFIG


1256 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1257 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1258 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1259 
£nd_th»ad_cÜe
 = 1;

1261 
£nd_th»ad_cÜe
 = 0;

1263 #–if 
N_MINUS_1_CONFIG


1264 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1265 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1267 
£nd_th»ad_cÜe
 = 0;

1270 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1271 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1273 
£nd_th»ad_cÜe
 = 0;

1277 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1278 
this_th»ad
::
	`y›ld
();

1280 
ch
;

1281 
ušt32_t
 
i
,
j
;

1282 
rv
;

1283 
veùÜ
<
pÜt_des
> 
pÜts
;

1284 
ušt64_t
 
™”
 = 0;

1285 
ušt32_t
 
Åes
;

1286 
pÜt_des
 *
rxpÜt
;

1287 
pÜt_des
 *
txpÜt
;

1289 
nm»q
 
ba£_»q
;

1290 
ušt32_t
 
exŒa_bufs
;

1291 
ušt32_t
 
sÿn
;

1293 
u_št
 
couÁs
;

1294 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1295 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1296 
Ãtm­_ršg
 *
txršg
;

1299 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1300 
Åes
 = 
£nd_ouut_ršgs
;

1302 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1303 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1305 
	`D
("Åes:%u",
Åes
);

1307 
pÜts
.
	`»size
(
Åes
+2);

1309 
£nd_¡©s
.
	`»size
(
Åes
+1);

1311 
i
=0;i<=
Åes
;i++) {

1312 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

1315 
txpÜt
 = &
pÜts
[
Åes
];

1316 
rxpÜt
 = &
pÜts
[
Åes
+1];

1320 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1321 
	`D
("failedo‡llocatehe stats‡rray");

1322  
NULL
;

1325 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1327 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1328 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1330 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1331 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1332  
NULL
;

1334 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1335 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1338 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1339 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1342 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1344 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1345 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1346 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1347 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1349 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1350 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1351  
NULL
;

1353 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1354 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1358 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1359 
txršg
 = 
txpÜt
->
ršg
;

1360 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1362 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1364 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1366 
i
 = 0; i < 
Åes
; ++i) {

1367 
š‹rçû
[25];

1368 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1369 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1370 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1372 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1373 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1374  
NULL
;

1376 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1377 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1378 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1380 
	`D
("zerocopy %s",

1381 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1384 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1385 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1387 
	`¦“p
(2);

1389 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1390 
ušt64_t
 
times
=0;

1392 
i
 = 0; i < 
Åes
+2; ++i) {

1393 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1416 !
do_abÜt
) {

1417 
u_št
 
pŞlo
 = 0;

1419 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1421 
	`g‘timeofday
(&
begš
, 
NULL
);

1424 
™”
++;

1426 
i
 = 0; i < 
Åes
; ++i) {

1427 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1428 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1432 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1433 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1434 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1435 
úts
[
pŞlo
] = 
i
;

1436 ++
pŞlo
;

1438 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1439 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1440 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1442 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1443 ià(
rv
 <= 0) {

1444 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1445 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1449 
b©ch_cur
 = 0,
™emp
;

1450 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1451 
i
 = 
úts
[
™emp
];

1452 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1455 
Ãxt_cur
 = 
ršg
->
cur
;

1456 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1457 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1458 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1459 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1460 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1462 
»cvcouÁ
--) {

1463 
n
;

1464 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1465 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1466 if(
šc_bur¡
) {

1467 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1468 
	`D
("Burst increased");

1471 
b©ch_cur
 = 
£nd_b©ch
;

1475 #ifdeà
BUSY_WAIT


1476 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1477 
	`D
("ioctlƒrror on queue %d: %s", 0,

1478 
	`¡»¼Ü
(
”ºo
));

1479  
NULL
;

1482 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1483 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1484 
	`¡»¼Ü
(
”ºo
));

1485  
NULL
;

1487 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1488 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1489 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1490  
NULL
;

1493 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1494 ià(
n
 < 
b©ch_cur
)

1495 
b©ch_cur
 = 
n
;

1499 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1500 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1501 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1502 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1503 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1504 
	`__butš_´eãtch
(
Ãxt_buf
);

1506 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1507 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1508 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1513 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1516 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1522 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1523 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1529 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1531 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1538 
tx¦Ù
->
Ën
=
rs
->len;

1543 
tx¦Ù
->
æags
 = 0;

1544 
b©ch_cur
--;

1545 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1546 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1547 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1548 
£nd_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1550 ià(
b©ch_cur
==0) {

1551 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1553 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1554 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1555 
b©ch_cur
 = 0;

1556 
txršg
->
h—d
 =xršg->
cur
;

1557 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1561 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1568 
	`g‘timeofday
(&
’d
, 
NULL
);

1569 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

1570 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

1571 
¿‹_t
 = (
£nd_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

1572 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

1574 
	`¦“p
(5);

1575 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1576 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1582  
NULL
;

1583 
	}
}

1586 
ušt64_t
 
	gnumbuf
=0;

1588 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1590 
»cv_th»ad_cÜe
;

1592 
time_t
 
¡¬t_t
, 
’d_t
;

1593 
¿‹_t
, 
diff_t
;

1594 
timev®
 
begš
, 
’d
;

1596 #if 
N_MINUS_2_CONFIG


1597 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1598 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1599 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1600 
»cv_th»ad_cÜe
 = 1;

1602 
»cv_th»ad_cÜe
 = 0;

1604 #–if 
N_MINUS_1_CONFIG


1605 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1606 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1608 
»cv_th»ad_cÜe
 = 0;

1611 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1612 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1614 
»cv_th»ad_cÜe
 = 0;

1618 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1619 
this_th»ad
::
	`y›ld
();

1621 
	`D
("CÜ%d:",
»cv_th»ad_cÜe
);

1623 
ch
;

1624 
ušt32_t
 
i
,
j
;

1625 
rv
;

1626 
veùÜ
<
pÜt_des
> 
pÜts
;

1627 
™”
 = 0;

1628 
ušt32_t
 
Åes
;

1629 
ov”æow_queue
 *
ä“q
;

1630 
pÜt_des
 *
rxpÜt
;

1631 
pÜt_des
 *
txpÜt
;

1633 
nm»q
 
ba£_»q
;

1634 
ušt32_t
 
exŒa_bufs
;

1635 
ušt32_t
 
sÿn
;

1636 
veùÜ
<
ov”æow_queue
> 
oq
;

1638 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1641 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1642 
Åes
 = 
»cv_ouut_ršgs
;

1643 
ä“q
 = 
NULL
;

1645 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1646 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1648 
	`D
("Åes:%u",
Åes
);

1650 
pÜts
.
	`»size
(
Åes
+2);

1652 
»cv_¡©s
.
	`»size
(
Åes
+1);

1654 
i
=0;i<=
Åes
;i++) {

1655 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

1662 
oq
.
	`»size
(
Åes
+1);

1663 ià(
oq
.
	`size
()!=
Åes
+1) {

1664 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1665  
NULL
;

1668 
rxpÜt
 = &
pÜts
[
Åes
];

1669 
txpÜt
 = &
pÜts
[
Åes
+1];

1673 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1674 
	`D
("failedo‡llocatehe stats‡rray");

1675  
NULL
;

1678 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1680 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1681 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1683 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1684 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1685  
NULL
;

1687 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1688 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1691 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1692 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1695 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1697 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1698 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1699 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1700 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1702 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1703 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1704  
NULL
;

1706 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1707 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1711 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1712 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1714 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1716 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1717 ià(!
exŒa_bufs
)

1718 
run
;

1720 
ä“q
 = &
oq
[
Åes
];

1721 
rxpÜt
->
oq
 = 
NULL
;

1722 
txpÜt
->
oq
 = 
ä“q
;

1724 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1730 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1731 
sÿn
;

1732 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1734 
Ãtm­_¦Ù
 
s
;

1735 
s
.
buf_idx
 = 
sÿn
;

1736 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1737 
ä“q
->
¦Ùs
.
	`push
(
s
);

1740 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1741 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1742 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1743  
NULL
;

1745 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1747 
run
:

1748 
i
 = 0; i < 
Åes
; ++i) {

1749 
š‹rçû
[25];

1750 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1751 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1752 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1754 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1755 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1756  
NULL
;

1758 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1759 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1760 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1762 
	`D
("zerocopy %s",

1763 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1765 ià(
exŒa_bufs
) {

1766 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1767 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1768 
pÜts
[
i
].
oq
 = 
q
;

1772 ià(!
exŒa_bufs
) {

1773 ià(!
oq
.
	`em±y
()) {

1774 
i
 = 0; i < 
Åes
 + 1; i++) {

1775 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1776 
oq
[
i
].
¦Ùs
.
	`pİ
();

1778 
pÜts
[
i
].
oq
 = 
NULL
;

1780 
pÜts
[
i
].
oq
 = 
NULL
;

1781 
oq
.
	`ş—r
();

1783 
	`D
("*** overflow queues disabled ***");

1786 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1787 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1789 
	`¦“p
(2);

1791 !
§ã_to_¡¬t_»cv
) {

1792 
this_th»ad
::
	`y›ld
();

1795 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1796 
ušt64_t
 
times
=0;

1798 
i
 = 0; i < 
Åes
+2; ++i) {

1799 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1822 !
do_abÜt
) {

1823 
u_št
 
pŞli
 = 0;

1825 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1827 
	`g‘timeofday
(&
begš
, 
NULL
);

1830 
™”
++;

1831 
i
 = 0; i < 
Åes
; ++i) {

1832 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1833 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1837 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1838 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1839 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1840 ++
pŞli
;

1842 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1843 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1844 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1845 ++
pŞli
;

1847 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1848 ià(
rv
 <= 0) {

1849 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1850 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1854 ià(!
oq
.
	`em±y
()) {

1858 
i
 = 0; i < 
Åes
; i++) {

1859 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1860 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1861 
ušt32_t
 
j
, 
lim
;

1862 
Ãtm­_ršg
 *
ršg
;

1863 
Ãtm­_¦Ù
 *
¦Ù
;

1865 ià(
q
->
¦Ùs
.
	`em±y
())

1867 
ršg
 = 
p
->ring;

1868 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1869 ià(!
lim
)

1871 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1872 
lim
 = 
q
->
¦Ùs
.
	`size
();

1873 
j
 = 0; j < 
lim
; j++) {

1874 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1875 
q
->
¦Ùs
.
	`pİ
();

1876 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1877 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1878 *
¦Ù
 = 
s
;

1879 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1880 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1881 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1882 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1884 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1885 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1887 
ršg
->
h—d
 =„šg->
cur
;

1892 
b©ch_cur
 = 0;

1893 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1894 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1897 
Ãxt_cur
 = 
rxršg
->
cur
;

1898 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1899 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1900 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1901 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1902 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1904 
ršg¥aû
--) {

1905 
ov”æow_queue
 *
q
;

1906 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1907 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1908 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1915 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1916 if(
ARP_ENABLED
) {

1917 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1920 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1921 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1922 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1923 
	`__butš_´eãtch
(
Ãxt_buf
);

1924 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1926 
b©ch_cur
++;

1927 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1928 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1934 
b©ch_cur
 = 0;

1943 
ušt32_t
 
ouut_pÜt
 = 0;

1944 if(
»cv_th»ad_cÜe
) {

1945 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1947 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1954 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1955 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1956 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1957 
	`__butš_´eãtch
(
Ãxt_buf
);

1961 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1962 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1963 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1966 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1967 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1968 *
cİy_buf
;

1969 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1970 
ts
->
Ën
 = 
rs
->len;

1971 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1973 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1975 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

1976 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1977 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1978 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1981 
fÜw¬d
;

1985 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1986 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

1987 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1988 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1989 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1991 
Ãxt
;

1994 
q
 = &
oq
[
ouut_pÜt
];

1996 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1998 
ušt32_t
 
j
;

1999 
pÜt_des
 *
Í
 = &
pÜts
[0];

2000 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2002 
j
 = 1; j < 
Åes
; j++) {

2003 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2004 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2005 
Í
 = 
ı
;

2006 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2011 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2012 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2014 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2015 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2016 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2017 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2020 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2021 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2024 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2027 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2028 
ä“q
->
¦Ùs
.
	`pİ
();

2030 *
‹mp_buf
;

2031 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2032 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2033 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2034 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2036 
fÜw¬d
:

2038 
Ãxt
:

2039 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2041 
b©ch_cur
++;

2042 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2043 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2049 
b©ch_cur
 = 0;

2060 ià(
exŒa_bufs
) {

2061 
	`ä“_bufãrs
(
pÜts
);

2070 
	`g‘timeofday
(&
’d
, 
NULL
);

2071 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

2072 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

2073 
¿‹_t
 = (
»cv_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

2074 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

2076 
	`¦“p
(5);

2077 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2078 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2084  
NULL
;

2085 
	}
}

2088 
u_št16_t


2089 
	$w¿psum
(
u_št32_t
 
sum
)

2091 
sum
 = ~sum & 0xFFFF;

2092  (
	`htÚs
(
sum
));

2093 
	}
}

2096 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2098 
s
;

2099 
iäeq
 
bufãr
;

2100 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2102 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2103 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2105 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2107 
	`şo£
(
s
);

2108 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2109 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2110 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2111 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2112 
fd
;

2113 
iäeq
 
iä
;

2115 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2118 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2121 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2123 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2125 
	`şo£
(
fd
);

2128 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2129 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2130 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2133 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2134 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2135 
	`D
("Hurray 1");

2138 
š_addr
 
©t
;

2139 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2141 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

2142 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2143 
	`D
("Hurray 2");

2144 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2147 
	}
}

	@netmap_api_hp_bk.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

40 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

42 cÚ¡ 
ušt8_t
 
key
[] = {

54 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

55 (((
ušt32_t
)
key
[1]) << 16) |

56 (((
ušt32_t
)
key
[2]) << 8) |

57 ((
ušt32_t
)
key
[3]);

59 
ušt32_t
 
idx
 = 32;

60 
i
;

62 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

63 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

64 
ušt32_t
 
b™
;

66 
ÿche
[
i
] = 
»suÉ
;

67 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

69 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

71 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

122 
ušt32_t


123 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

125 
ušt32_t
 
rc
 = 0;

127 ià(
hash_¥l™
 == 2) {

128 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

129 
	`Áohl
(
h
->
_d¡
.
s_addr
),

130 
	`Áohs
(0xFFFDè+ 
£ed
,

131 
	`Áohs
(0xFFFEè+ 
£ed
);

133 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

144 
IPPROTO_IPIP
:

146 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

147 
hash_¥l™
, 
£ed
);

155  
rc
;

156 
	}
}

162 
ušt32_t


163 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

165 
ušt32_t
 
§ddr
, 
daddr
;

166 
ušt32_t
 
rc
 = 0;

169 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

170 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

171 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

172 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

173 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

174 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

175 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

176 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

178 ià(
hash_¥l™
 == 2) {

179 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

180 
	`Áohl
(
daddr
),

181 
	`Áohs
(0xFFFDè+ 
£ed
,

182 
	`Áohs
(0xFFFEè+ 
£ed
);

184 
tıhdr
 *
tıh
 = 
NULL
;

186 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

187 
IPPROTO_UDP
:

188 
IPPROTO_TCP
:

189 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

190 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

191 
	`Áohl
(
daddr
),

192 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

193 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

195 
IPPROTO_IPIP
:

197 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

198 
hash_¥l™
, 
£ed
);

200 
IPPROTO_IPV6
:

202 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

203 
hash_¥l™
, 
£ed
);

205 
IPPROTO_ICMP
:

206 
IPPROTO_GRE
:

207 
IPPROTO_ESP
:

208 
IPPROTO_PIM
:

209 
IPPROTO_IGMP
:

215 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

216 
	`Áohl
(
daddr
),

217 
	`Áohs
(0xFFFDè+ 
£ed
,

218 
	`Áohs
(0xFFFEè+ 
£ed
);

221  
rc
;

222 
	}
}

229 
ušt32_t


230 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

232 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

234 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

235 (
‘hh
->
‘h”_sho¡
[4] << 8) |

236 (
‘hh
->
‘h”_sho¡
[3] << 16) |

237 (
‘hh
->
‘h”_sho¡
[2] << 24);

238 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

239 (
‘hh
->
‘h”_dho¡
[4] << 8) |

240 (
‘hh
->
‘h”_dho¡
[3] << 16) |

241 (
‘hh
->
‘h”_dho¡
[2] << 24);

243 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

244 
	`Áohl
(
daddr
),

245 
	`Áohs
(0xFFFDè+ 
£ed
,

246 
	`Áohs
(0xFFFEè+ 
£ed
);

248  
rc
;

249 
	}
}

255 
šlše
 
ušt32_t


256 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

258 
ušt32_t
 
rc
 = 0;

259 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

261 
	`Áohs
(
vhdr
->
´Ùo
)) {

262 
ETHERTYPE_IP
:

263 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

264 
hash_¥l™
, 
£ed
);

266 
ETHERTYPE_IPV6
:

267 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

268 
hash_¥l™
, 
£ed
);

270 
ETHERTYPE_ARP
:

273 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

276  
rc
;

277 
	}
}

283 
ušt32_t


284 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

286 
rc
 = 0;

287 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

289 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

290 
ETHERTYPE_IP
:

291 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_IPV6
:

295 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

296 
hash_¥l™
, 
£ed
);

298 
ETHERTYPE_VLAN
:

299 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

301 
ETHERTYPE_ARP
:

304 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

308  
rc
;

309 
	}
}

313 
ušt16_t


314 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

316 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

317 
ušt32_t
 
i
;

320 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

321 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

322 ià(
sum
 > 0xFFFF)

323 
sum
 -= 0xFFFF;

330 ià(
i
 < 
Ën
) {

331 
sum
 +ğ
addr
[
i
] << 8;

332 ià(
sum
 > 0xFFFF)

333 
sum
 -= 0xFFFF;

335  
sum
;

336 
	}
}

338 
u_št16_t


339 
	$w¿psum
(
u_št32_t
 
sum
)

341 
sum
 = ~sum & 0xFFFF;

342  (
	`htÚs
(
sum
));

343 
	}
}

351 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

353 
i
;

354 
a
[18];

356 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

357 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

358 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

359  (
i
 < 17 ? 
NULL
 : (*)&
a
);

360 
	}
}

366 
	gN‘m­U£
::
	$N‘m­U£
() {

368 #iâdef 
OPT_FOR_SINGLE_CORE


370 
¬±abË
.
	`£t_em±y_key
(0);

371 
¬±abË
.
	`£t_d–‘ed_key
(1);

373 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

374 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

375 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

376 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

380 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

383 
	`sourû_hwaddr
(
IFNAME
);

387 
	`š™Ÿlize_£nd_»cv
();

390 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

391 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

393 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

394 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

397 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

398 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

400 
	}
}

407 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

409 
buf
[128];

410 
i
, 
j
, 
i0
;

411 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

415 
	`´štf
("ring %p cur %5d [len %5d]\n",

416 
ršg
, 
cur
, 
Ën
);

418 
i
 = 0; i < 
Ën
; ) {

419 
	`mem£t
(
buf
, (buf), ' ');

420 
	`¥rštf
(
buf
, "%5d: ", 
i
);

421 
i0
 = 
i
;

422 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

423 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

424 
i
 = 
i0
;

425 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

426 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

427 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

428 
	`´štf
("%s\n", 
buf
);

430 
	}
}

437 
	gN‘m­U£
::~
	$N‘m­U£
() {

438 
¿‹_time
;

439 
diff_time
;

440 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

441 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

442 
	`g‘timeofday
(&
’d_time
, 
NULL
);

444  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

445 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

448  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

449 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

453 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

454 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

455 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

456 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

458 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

459 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

460 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

461 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

463 #iâdeà
OPT_FOR_SINGLE_CORE


465 
£nd_th»ad
.
	`još
();

466 
»cv_th»ad
.
	`još
();

469 
	`¦“p
(5);

472 
cout
<<"Com¶‘ed"<<
’dl
;

473 
	}
}

480 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

482 
nm»q
 
»q
;

483 
”r
;

485 
	`mem£t
(&
»q
, 0, (req));

486 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

487 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

488 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

489 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

490 ià(
”r
) {

491 
	`D
("Unableo get virtio-net header†ength");

495 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

496 ià(
vœt_hdr_Ën
) {

497 
	`D
("Port„equires virtio-net header,†ength = %d",

498 
vœt_hdr_Ën
);

500 
	}
}

508 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

509 
i
, 
	gtÙ
 = 0;

510 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

513 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

514 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

515 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

517 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

520 !
	gq
->
	g¦Ùs
.
em±y
()) {

521 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

522 
	gq
->
	g¦Ùs
.
pİ
();

523 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

525 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

526 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

527 
	gtÙ
++;

531 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

539 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

540 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

541 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

542 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

544 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

545 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

546 
¬p_pkt
->
ah
.
hËn
 = 6;

547 
¬p_pkt
->
ah
.
¶’
 = 4;

548 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

550 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

551 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

553 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

554 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

555 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

557 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

559 
	}
}

569 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

570 
ušt16_t
 
i
;

572 #iâdef 
OPT_FOR_SINGLE_CORE


573 
£nd_ma¡”_nmd
 = 
NULL
;

574 
»cv_ma¡”_nmd
 = 
NULL
;

578 #if 
N_MINUS_2_CONFIG


579 if(
cÜes_avaabË
>=3) {

580 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

582 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

585 #–if 
N_MINUS_1_CONFIG


586 if(
cÜes_avaabË
>=2) {

587 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

589 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

592 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

596 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

597 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

599 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

600 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

602 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

603 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

604 
³r_cÜe_couÁs
[
i
] = 0;

606 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

607 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

608 
³r_cÜe_couÁr
[
i
] = 0;

611 #ifdef 
OPT_FOR_SINGLE_CORE


614 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

615 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

616 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

618 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

620 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

621 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

622 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

623 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

629 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

631 
ıu_£t_t
 
ıu_£t
;

633 
th»ad_cÜe1
, 
th»ad_cÜe2
;

634 
ušt16_t
 
j
;

636 #if 
N_MINUS_2_CONFIG


637 if(
cÜes_avaabË
 > 2) {

638 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

639 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

640 } if(
cÜes_avaabË
 == 2) {

641 
th»ad_cÜe1
 = 1;

642 
th»ad_cÜe2
 = 1;

644 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

646 #–if 
N_MINUS_1_CONFIG


647 if(
cÜes_avaabË
 > 1) {

648 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

649 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

651 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

654 if(
cÜes_avaabË
 > 1) {

655 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

656 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

658 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

662 
	`CPU_ZERO
(&
ıu_£t
);

663 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

664 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

665 if(
rc
!=0) {

666 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

669 
j
 = 0; j < 
CPU_SETSIZE
; j++)

670 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

671 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

675 
	`¦“p
(2);

677 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

679 
	`CPU_ZERO
(&
ıu_£t
);

680 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

681 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

682 if(
rc
!=0) {

683 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

686 
j
 = 0; j < 
CPU_SETSIZE
; j++)

687 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

688 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

692 
	}
}

699 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

700 #iâdeà
OPT_FOR_SINGLE_CORE


702 !
£nd_ma¡”_nmd
) {

703 
this_th»ad
::
	`y›ld
();

706 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

707 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

708 
nm»q
 
ba£_»q
;

709 
š‹rçû
[32];

710 
	`mem£t
(&
ba£_»q
, 0, (base_req));

711 #ifdeà
OPT_FOR_SINGLE_CORE


713 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
IFNAME
, 
cÜeid
);

714 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

716 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

717 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

719 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

720 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

721  
NULL
;

723 
	`D
("successfully opened core #%d %s (tx slots: %d)",

724 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

725 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

727 ià(
cÜeid
==0) {

728 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

729 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

733 
	`¥rštf
(
š‹rçû
, "%s}%d", 
SEND_PIPES_IFNAME
, 
cÜeid
);

734 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

735 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

737 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

738 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

739  
NULL
;

741 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

742 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

743 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

745 
	`D
("zerocopy %s",

746 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

750 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

755 
ušt16_t
 
n
;

756 
pŞlfd
 
pfd
;

757 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

758 
pfd
.
ev’ts
 = 
POLLOUT
;

759 
pfd
.
»v’ts
 = 0;

760 #ifdeà
BUSY_WAIT


761 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

762 
	`D
("ioctlƒrror on queue %d: %s", 0,

763 
	`¡»¼Ü
(
”ºo
));

764  
NULL
;

767 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

770 if(
do_abÜt
) {

771  
NULL
;

775 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

776 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

777 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

778  
NULL
;

781 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

782 ià(
n
 <ğ
MAX_BATCH_SEND
) {

783 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

785 
³r_cÜe_couÁs
[
cÜeid
] = 
MAX_BATCH_SEND
;

790 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

791  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

792 
	}
}

804 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

805 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

806 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

807 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

808 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

810 #ifdeà
OPT_FOR_SINGLE_CORE


812 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

813 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

814 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

816 
‘h”_addr
 
‹mp_‘h_addr
;

818 ià(
	`lik–y
(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
))) {

820 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

822 
tı_pkt
 
t_p
;

823 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

824 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

826 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

828 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

829 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
));

830 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

832 ià(
‹mp__dp
 =ğ
‹mp_
) {

833 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

837 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

839 ià(
	`uÆik–y
(!
tx_buf
)) {

840 
	`D
("TXƒrror occurred");

843 
tx_buf
 -ğ(
‘h”_h—d”
);

845 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

846 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

848 
¦Ù
->
Ën
 = 
‹m¶’
;

850 
¦Ù
->
æags
 = 0;

851 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

853 --
³r_cÜe_couÁs
[
cÜeid
];

854 
¦Ù
->
æags
 |ğ
NS_REPORT
;

855 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

857 
ršg
->
h—d
 =„šg->
cur
;

858 
pŞlfd
 
pfd
;

859 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

860 
pfd
.
ev’ts
 = 
POLLOUT
;

861 
pfd
.
»v’ts
 = 0;

862 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

864 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

867 
™_dp
++;

870 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

871 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

872 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

873 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

874 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

875 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

876 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

878 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

881 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)(
tx_buf
 + 
vœt_hdr_Ën
));

882 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

883 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

884 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

885 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

886 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

887 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

888 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

890 
£nd_¬p_»q
 = 
çl£
;

894 ià(
	`lik–y
(
£nd_¬p_»q
)) {

895 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

896 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

897 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

899 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

900 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

901 
¦Ù
->
æags
 = 0;

902 
³r_cÜe_couÁs
[
cÜeid
] = 0;

904 
¦Ù
->
æags
 |ğ
NS_REPORT
;

906 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

908 
ršg
->
h—d
 =„šg->
cur
;

909 
pŞlfd
 
pfd
;

910 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

911 
pfd
.
ev’ts
 = 
POLLOUT
;

912 
pfd
.
»v’ts
 = 0;

913 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

919 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

920 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

923 if(
cÜeid
 == 0) {

924 
£nd_™”
++;

927 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

928 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

933 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

935 
¦Ù
->
æags
 = 0;

936 --
³r_cÜe_couÁs
[
cÜeid
];

937 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

938 
¦Ù
->
æags
 |ğ
NS_REPORT
;

940 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

942 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

943 
ršg
->
h—d
 =„šg->
cur
;

944 
pŞlfd
 
pfd
;

945 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

946 
pfd
.
ev’ts
 = 
POLLOUT
;

947 
pfd
.
»v’ts
 = 0;

948 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

950 
	}
}

962 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

963 #iâdeà
OPT_FOR_SINGLE_CORE


965 !
»cv_ma¡”_nmd
) {

966 
this_th»ad
::
	`y›ld
();

969 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

970 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

971 
nm»q
 
ba£_»q
;

972 
š‹rçû
[32];

973 
	`mem£t
(&
ba£_»q
, 0, (base_req));

975 #ifdeà
OPT_FOR_SINGLE_CORE


977 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
IFNAME
, 
cÜeid
);

978 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

980 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

981 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

983 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

984 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

985  
NULL
;

987 
	`D
("successfully opened core #%d %s (rx slots: %d)",

988 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

989 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

991 ià(
cÜeid
==0) {

992 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

993 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

997 
	`¥rštf
(
š‹rçû
, "%s}%d", 
RECV_PIPES_IFNAME
, 
cÜeid
);

998 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

999 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1001 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1002 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1003  
NULL
;

1005 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1006 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1007 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1009 
	`D
("zerocopy %s",

1010 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1014 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

1016 #ifdeà
OPT_FOR_SINGLE_CORE


1019 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

1020 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

1022 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

1023 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1024 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1025 
‘h”_addr
 
‹mp_‘h_addr
;

1027 ià(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
)) {

1028 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1031 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1033 ià(
	`uÆik–y
(!
tx_buf
)) {

1034 
	`D
("TXƒrror occurred");

1037 
tx_buf
 =x_buà- (
‘h”_h—d”
);

1039 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1040 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1041 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1042 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1044 
¦Ù
->
Ën
 = 
‹m¶’
;

1046 
¦Ù
->
æags
 = 0;

1047 --
³r_cÜe_couÁs
[
cÜeid
];

1048 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1049 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1051 
ršg
->
h—d
 =„šg->
cur
;

1052 
pŞlfd
 
pfd
;

1053 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1054 
pfd
.
ev’ts
 = 
POLLOUT
;

1055 
pfd
.
»v’ts
 = 0;

1056 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1058 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1061 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

1062 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1063 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1065 
™
++;

1068 
	`g‘_bufãr_tx
(
cÜeid
);

1070 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1071 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1081 
ušt16_t
 
n
;

1082 
pŞlfd
 
pfd
;

1083 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1084 
pfd
.
ev’ts
 = 
POLLIN
;

1085 
pfd
.
»v’ts
 = 0;

1086 
ršg
->
h—d
 =„šg->
cur
;

1087 #ifdeà
BUSY_WAIT


1088 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1089 
	`D
("ioctlƒrror on queue %d: %s", 0,

1090 
	`¡»¼Ü
(
”ºo
));

1091  
NULL
;

1094 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1097 if(
do_abÜt
) {

1098  
NULL
;

1102 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1103 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1104 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1105  
NULL
;

1108 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1109 ià(
n
 <ğ
MAX_BATCH_RECV
) {

1110 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1112 
³r_cÜe_couÁr
[
cÜeid
] = 
MAX_BATCH_RECV
;

1114 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1115  
NULL
;

1118 #ifdeà
OPT_FOR_SINGLE_CORE


1119 
¡¬t
:

1121 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1123 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1124 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1125 #ifdeà
OPT_FOR_SINGLE_CORE


1128 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1129 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1131 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1132 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1133 
‘h”_addr
 
‹mp_eh
;

1134 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1135 
ušt32_t
 
£nd_
 = 
¬µkt
->
ah
.
£nd”_
;

1136 
¬±abË
.
	`š£¹
(
£nd_
, 
‹mp_eh
);

1137 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1141 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1143 ià(
	`uÆik–y
(!
tx_buf
)) {

1144 
	`D
("TXƒrror occurred");

1146 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1147 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1149 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1150 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1152 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1154 
¦Ù
->
æags
 = 0;

1155 --
³r_cÜe_couÁs
[
cÜeid
];

1156 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1157 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1159 
ršg
->
h—d
 =„šg->
cur
;

1160 
pŞlfd
 
pfd
;

1161 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1162 
pfd
.
ev’ts
 = 
POLLOUT
;

1163 
pfd
.
»v’ts
 = 0;

1164 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1170 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1171 
³r_cÜe_couÁr
[
cÜeid
]--;

1172 
pktcouÁ
++;

1173 
¡¬t
;

1177  (*)((*)
pkt
+(
‘h”_h—d”
));

1180  
NULL
;

1182 
	}
}

1189 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1191 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1193 #ifdeà
OPT_FOR_SINGLE_CORE


1194 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1195 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1198 if(
cÜeid
 == 0) {

1199 
»cv_™”
++;

1202 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1203 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1207 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1208 
³r_cÜe_couÁr
[
cÜeid
]--;

1209 
	}
}

1211 #iâdef 
OPT_FOR_SINGLE_CORE


1218 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1220 
£nd_th»ad_cÜe
;

1223 #if 
N_MINUS_2_CONFIG


1224 if(
cÜes_avaabË
 > 2) {

1225 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1226 } if(
cÜes_avaabË
 == 2) {

1227 
£nd_th»ad_cÜe
 = 1;

1229 
£nd_th»ad_cÜe
 = 0;

1231 #–if 
N_MINUS_1_CONFIG


1232 if(
cÜes_avaabË
 > 1) {

1233 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1235 
£nd_th»ad_cÜe
 = 0;

1238 if(
cÜes_avaabË
 > 1) {

1239 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1241 
£nd_th»ad_cÜe
 = 0;

1246 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1247 
this_th»ad
::
	`y›ld
();

1250 
ušt32_t
 
i
;

1251 
rv
;

1252 
veùÜ
<
pÜt_des
> 
pÜts
;

1253 
ušt64_t
 
™”
 = 0;

1254 
ušt32_t
 
Åes
;

1255 
pÜt_des
 *
rxpÜt
;

1256 
pÜt_des
 *
txpÜt
;

1258 
nm»q
 
ba£_»q
;

1259 
ušt32_t
 
exŒa_bufs
;

1260 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1261 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1262 
Ãtm­_ršg
 *
txršg
;

1263 
£nd_iâame
[
MAX_IFNAMELEN
];

1265 
	`¥rštf
(
£nd_iâame
, "%s/T", 
IFNAME
);

1267 
Åes
 = 
£nd_ouut_ršgs
;

1269 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1270 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1272 
	`D
("Åes:%u",
Åes
);

1274 
pÜts
.
	`»size
(
Åes
+2);

1276 
txpÜt
 = &
pÜts
[
Åes
];

1277 
rxpÜt
 = &
pÜts
[
Åes
+1];

1279 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1280 
	`D
("failedo‡llocatehe stats‡rray");

1281  
NULL
;

1284 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1287 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1288 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1290 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1291 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1292  
NULL
;

1294 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1295 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1298 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1300 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1301 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
SEND_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1303 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1304 
	`D
("ÿÂÙ o³À%s", 
SEND_PIPES_IFNAME
);

1305  
NULL
;

1307 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
SEND_PIPES_IFNAME
,

1308 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1312 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1313 
txršg
 = 
txpÜt
->
ršg
;

1314 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1316 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1318 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1321 
i
 = 0; i < 
Åes
; ++i) {

1322 
š‹rçû
[32];

1323 
	`¥rštf
(
š‹rçû
, "%s{%d", 
SEND_PIPES_IFNAME
, 
i
);

1324 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1325 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1327 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1328 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1329  
NULL
;

1331 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1332 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1333 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1335 
	`D
("zerocopy %s",

1336 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1339 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1341 
	`¦“p
(2);

1343 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1345 !
do_abÜt
) {

1346 
u_št
 
pŞlo
 = 0;

1348 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1349 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1352 
™”
++;

1355 
i
 = 0; i < 
Åes
; ++i) {

1356 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1357 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1361 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1362 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1363 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1364 
úts
[
pŞlo
] = 
i
;

1365 ++
pŞlo
;

1367 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1368 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1369 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1371 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1373 
‹mp_couÁ
;

1374 
boŞ
 
Ãed_æush
 = 
çl£
;

1375 
u_št
 
b©ch_cur
 = 0,
™emp
;

1379 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1381 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1382 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1383 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1384 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1385 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1389 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1394 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1395 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1396 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1397 
Ãed_æush
 = 
Œue
;

1399 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1403 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1404 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1405 
txršg
->
h—d
 =xršg->
cur
;

1409 #ifdeà
BUSY_WAIT


1410 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1411 
	`D
("ioctlƒrror on queue %d: %s", 0,

1412 
	`¡»¼Ü
(
”ºo
));

1413  
NULL
;

1416 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1417 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1418 
	`¡»¼Ü
(
”ºo
));

1419  
NULL
;

1421 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1422 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1423 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1424  
NULL
;

1427 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1428 ià(
n
 < 
b©ch_cur
)

1429 
b©ch_cur
 = 
n
;

1432 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1433 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1434 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1436 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1437 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1438 
tx¦Ù
->
æags
 = 0;

1439 
b©ch_cur
--;

1441 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1449 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1450 
Ãed_æush
 = 
Œue
;

1451 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1452 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1453 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1454 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1455 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1457 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1458 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1461 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1462 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1463 
txršg
->
h—d
 =xršg->
cur
;

1467 #ifdeà
BUSY_WAIT


1468 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1469 
	`D
("ioctlƒrror on queue %d: %s", 0,

1470 
	`¡»¼Ü
(
”ºo
));

1471  
NULL
;

1474 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1475 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1476 
	`¡»¼Ü
(
”ºo
));

1477  
NULL
;

1479 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1480 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1481 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1482  
NULL
;

1485 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1486 ià(
n
 < 
b©ch_cur
)

1487 
b©ch_cur
 = 
n
;

1490 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1491 *
tx_buf
 = (*è
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
è+ 
vœt_hdr_Ën
;

1493 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1494 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1495 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1496 
tx¦Ù
->
æags
 = 0;

1497 
b©ch_cur
--;

1499 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1501 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1502 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1504 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1506 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1507 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1508 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1510 
™
++;

1514 ià(
	`uÆik–y
(
Ãed_æush
)) {

1515 
b©ch_cur
 = 0;

1516 
txršg
->
h—d
 =xršg->
cur
;

1517 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1520 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1521 
³ndšg_¬p_»q_th
.
	`ş—r
();

1524 ià(
rv
 <= 0) {

1525 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1526 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1531 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1532 
i
 = 
úts
[
™emp
];

1533 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1534 
Ãxt_cur
 = 
ršg
->
cur
;

1535 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1536 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1537 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1538 if(
»cvcouÁ
>=
MAX_BATCH_RECV
) {

1539 
»cvcouÁ
 = 
MAX_BATCH_RECV
;

1541 
»cvcouÁ
--) {

1542 
u_št
 
n
;

1543 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1544 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1548 #ifdeà
BUSY_WAIT


1549 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1550 
	`D
("ioctlƒrror on queue %d: %s", 0,

1551 
	`¡»¼Ü
(
”ºo
));

1552  
NULL
;

1555 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1556 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1557 
	`¡»¼Ü
(
”ºo
));

1558  
NULL
;

1560 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1561 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1562 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1563  
NULL
;

1566 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1567 ià(
n
 < 
b©ch_cur
)

1568 
b©ch_cur
 = 
n
;

1571 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1572 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1573 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1574 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1575 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1576 
	`__butš_´eãtch
(
Ãxt_buf
);

1578 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1579 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1580 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1581 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1582 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1583 
pkthdr_rxpkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1587 
tx¦Ù
->
Ën
=
rs
->len;

1598 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1599 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1600 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1601 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1602 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1604 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)(
‹mpbuf
+
vœt_hdr_Ën
));

1605 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1606 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1607 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1609 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1610 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1611 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1612 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1614 
£nd_¬p_»q
 = 
çl£
;

1617 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1618 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1619 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1620 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1621 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1622 
tx¦Ù
->
æags
 = 0;

1624 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1626 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1628 
b©ch_cur
 = 0;

1629 
txršg
->
h—d
 =xršg->
cur
;

1630 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1636 
tx¦Ù
->
æags
 = 0;

1637 
b©ch_cur
--;

1639 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1640 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1642 ià(
b©ch_cur
==0 || 
tx¦Ù
->
Ën
 < 256) {

1643 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1645 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1646 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1647 
b©ch_cur
 = 0;

1648 
txršg
->
h—d
 =xršg->
cur
;

1649 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1652 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1657 
	`¦“p
(5);

1658 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1659 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1661  
NULL
;

1662 
	}
}

1669 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1671 
»cv_th»ad_cÜe
;

1674 #if 
N_MINUS_2_CONFIG


1675 if(
cÜes_avaabË
 > 2) {

1676 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1677 } if(
cÜes_avaabË
 == 2) {

1678 
»cv_th»ad_cÜe
 = 1;

1680 
»cv_th»ad_cÜe
 = 0;

1682 #–if 
N_MINUS_1_CONFIG


1683 if(
cÜes_avaabË
 > 1) {

1684 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1686 
»cv_th»ad_cÜe
 = 0;

1689 if(
cÜes_avaabË
 > 1) {

1690 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1692 
»cv_th»ad_cÜe
 = 0;

1697 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1698 
this_th»ad
::
	`y›ld
();

1701 
ušt32_t
 
i
;

1702 
rv
;

1703 
veùÜ
<
pÜt_des
> 
pÜts
;

1704 
™”
 = 0;

1705 
ušt32_t
 
Åes
;

1706 
ov”æow_queue
 *
ä“q
;

1707 
pÜt_des
 *
rxpÜt
;

1708 
pÜt_des
 *
txpÜt
;

1710 
nm»q
 
ba£_»q
;

1711 
ušt32_t
 
exŒa_bufs
;

1712 
veùÜ
<
ov”æow_queue
> 
oq
;

1713 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1714 
»cv_iâame
[
MAX_IFNAMELEN
];

1716 
	`¥rštf
(
»cv_iâame
, "%s/R", 
IFNAME
);

1718 
Åes
 = 
»cv_ouut_ršgs
;

1719 
ä“q
 = 
NULL
;

1721 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1722 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1724 
	`D
("Åes:%u",
Åes
);

1726 
pÜts
.
	`»size
(
Åes
+2);

1731 
oq
.
	`»size
(
Åes
+1);

1732 ià(
oq
.
	`size
()!=
Åes
+1) {

1733 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1734  
NULL
;

1737 
rxpÜt
 = &
pÜts
[
Åes
];

1738 
txpÜt
 = &
pÜts
[
Åes
+1];

1740 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1741 
	`D
("failedo‡llocatehe stats‡rray");

1742  
NULL
;

1745 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1748 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1749 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1751 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1752 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1753  
NULL
;

1755 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1756 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1759 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1760 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1762 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1763 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1764 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1765 
txpÜt
->
nmd
 = 
	`nm_İ’
(
RECV_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1767 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1768 
	`D
("ÿÂÙ o³À%s", 
RECV_PIPES_IFNAME
);

1769  
NULL
;

1771 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
RECV_PIPES_IFNAME
,

1772 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1776 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1777 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1779 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1781 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1782 ià(!
exŒa_bufs
)

1783 
run
;

1785 
ä“q
 = &
oq
[
Åes
];

1786 
rxpÜt
->
oq
 = 
NULL
;

1787 
txpÜt
->
oq
 = 
ä“q
;

1789 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1796 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1797 
rv
;

1798 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1800 
Ãtm­_¦Ù
 
s
;

1801 
s
.
buf_idx
 = 
rv
;

1802 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1803 
ä“q
->
¦Ùs
.
	`push
(
s
);

1805 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1806 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1807 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1808  
NULL
;

1810 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1812 
run
:

1814 
i
 = 0; i < 
Åes
; ++i) {

1815 
š‹rçû
[32];

1816 
	`¥rštf
(
š‹rçû
, "%s{%d", 
RECV_PIPES_IFNAME
, 
i
);

1817 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1818 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1820 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1821 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1822  
NULL
;

1824 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1825 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1826 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1828 
	`D
("zerocopy %s",

1829 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1831 ià(
exŒa_bufs
) {

1832 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1833 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1834 
pÜts
[
i
].
oq
 = 
q
;

1838 ià(!
exŒa_bufs
) {

1839 ià(!
oq
.
	`em±y
()) {

1840 
i
 = 0; i < 
Åes
 + 1; i++) {

1841 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1842 
oq
[
i
].
¦Ùs
.
	`pİ
();

1844 
pÜts
[
i
].
oq
 = 
NULL
;

1846 
pÜts
[
i
].
oq
 = 
NULL
;

1847 
oq
.
	`ş—r
();

1849 
	`D
("*** overflow queues disabled ***");

1852 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1853 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1855 
	`¦“p
(2);

1857 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1859 !
do_abÜt
) {

1860 
u_št
 
pŞli
 = 0;

1862 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1863 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1866 
™”
++;

1869 
i
 = 0; i < 
Åes
; ++i) {

1870 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1871 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1875 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1876 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1877 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1878 ++
pŞli
;

1880 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1881 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1882 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1883 ++
pŞli
;

1885 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1886 ià(
rv
 <= 0) {

1887 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1888 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1892 ià(!
oq
.
	`em±y
()) {

1896 
i
 = 0; i < 
Åes
; i++) {

1897 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1898 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1899 
ušt32_t
 
j
, 
lim
;

1900 
Ãtm­_ršg
 *
ršg
;

1901 
Ãtm­_¦Ù
 *
¦Ù
;

1903 ià(
q
->
¦Ùs
.
	`em±y
())

1905 
ršg
 = 
p
->ring;

1906 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1907 ià(!
lim
)

1909 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1910 
lim
 = 
q
->
¦Ùs
.
	`size
();

1911 
j
 = 0; j < 
lim
; j++) {

1912 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1913 
q
->
¦Ùs
.
	`pİ
();

1914 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1915 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1916 *
¦Ù
 = 
s
;

1918 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1919 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1922 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1923 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1925 
ršg
->
h—d
 =„šg->
cur
;

1929 
b©ch_cur
 = 0;

1932 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1933 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1935 
Ãxt_cur
 = 
rxršg
->
cur
;

1936 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1937 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1938 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1939 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1940 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1942 
ršg¥aû
--) {

1943 
ov”æow_queue
 *
q
;

1944 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1945 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1946 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1948 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1949 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1951 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1952 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1953 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1956 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

1958 
_mac_·œ
 
‹mp_·œ
;

1959 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

1960 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1961 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

1964 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1965 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1966 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1967 
	`__butš_´eãtch
(
Ãxt_buf
);

1968 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1970 
b©ch_cur
++;

1971 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

1972 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1973 
b©ch_cur
 = 0;

1979 
ušt32_t
 
ouut_pÜt
 = 0;

1980 if(
»cv_th»ad_cÜe
) {

1981 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1982 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1986 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1987 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1988 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1989 
	`__butš_´eãtch
(
Ãxt_buf
);

1990 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1991 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1992 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1995 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1996 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1997 *
cİy_buf
;

1998 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1999 
ts
->
Ën
 = 
rs
->len;

2000 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2002 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2004 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2005 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2008 
fÜw¬d
;

2012 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2013 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2014 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2016 
Ãxt
;

2019 
q
 = &
oq
[
ouut_pÜt
];

2021 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2023 
ušt32_t
 
j
;

2024 
pÜt_des
 *
Í
 = &
pÜts
[0];

2025 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2027 
j
 = 1; j < 
Åes
; j++) {

2028 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2029 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2030 
Í
 = 
ı
;

2031 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2036 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2037 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2038 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2039 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2042 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2043 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2046 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2049 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2050 
ä“q
->
¦Ùs
.
	`pİ
();

2053 *
‹mp_buf
;

2054 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2055 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2056 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2057 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2059 
fÜw¬d
:

2061 
Ãxt
:

2062 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2064 
b©ch_cur
++;

2065 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

2066 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2067 
b©ch_cur
 = 0;

2074 ià(
exŒa_bufs
) {

2075 
	`ä“_bufãrs
(
pÜts
);

2077 
	`¦“p
(5);

2078 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2079 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2081  
NULL
;

2082 
	}
}

2092 
	gN‘m­U£
::
	$sourû_hwaddr
(cÚ¡ *
iâame
)

2094 
s
;

2095 
¤c__addr
[20];

2096 
iäeq
 
bufãr
;

2097 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2099 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2100 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2102 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2104 
	`şo£
(
s
);

2105 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2106 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2107 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2108 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2109 
fd
;

2110 
iäeq
 
iä
;

2112 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2115 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2118 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2120 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2122 
	`şo£
(
fd
);

2125 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2126 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2127 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2133 #iâdef 
OPT_FOR_SINGLE_CORE


2143 
	}
}

	@netmap_api_mod.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

6 
N‘m­U£
 
	gÃtm­u£
;

7 
©omic_ušt
 
	gú‰
;

8 vŞ©
	gdo_abÜt
;

17 
	#__FAVOR_BSD


	)

20 
	~<sys/ty³s.h
>

22 
	~<Ãtš‘/š.h
>

24 
	~<Ãtš‘/.h
>

26 
	~<Ãtš‘/6.h
>

31 
	~<lšux/udp.h
>

33 
	~<Ãt/‘h”Ãt.h
>

35 
	~<¡ršg.h
>

44 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

46 cÚ¡ 
ušt8_t
 
key
[] = {

58 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

59 (((
ušt32_t
)
key
[1]) << 16) |

60 (((
ušt32_t
)
key
[2]) << 8) |

61 ((
ušt32_t
)
key
[3]);

63 
ušt32_t
 
idx
 = 32;

64 
i
;

66 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

67 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

68 
ušt32_t
 
b™
;

70 
ÿche
[
i
] = 
»suÉ
;

71 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

73 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

75 
	}
}

80 
ušt32_t


81 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

83 
	#MSB32
 0x80000000

	)

84 
	#MSB16
 0x8000

	)

85 
	#KEY_CACHE_LEN
 96

	)

87 
ušt32_t
 
rc
 = 0;

88 
i
;

89 
fœ¡_time
 = 1;

90 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

92 ià(
fœ¡_time
) {

93 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

94 
fœ¡_time
 = 0;

97 
i
 = 0; i < 32; i++) {

98 ià(
s
 & 
MSB32
)

99 
rc
 ^ğ
key_ÿche
[
i
];

100 
s
 <<= 1;

102 
i
 = 0; i < 32; i++) {

103 ià(
d
 & 
MSB32
)

104 
rc
 ^ğ
key_ÿche
[32+
i
];

105 
d
 <<= 1;

107 
i
 = 0; i < 16; i++) {

108 ià(
¥
 & 
MSB16
)

109 
rc
 ^ğ
key_ÿche
[64+
i
];

110 
¥
 <<= 1;

112 
i
 = 0; i < 16; i++) {

113 ià(
dp
 & 
MSB16
)

114 
rc
 ^ğ
key_ÿche
[80+
i
];

115 
dp
 <<= 1;

118  
rc
;

119 
	}
}

124 
ušt32_t


125 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

127 
ušt32_t
 
rc
 = 0;

129 ià(
hash_¥l™
 == 2) {

130 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

131 
	`Áohl
(
h
->
_d¡
.
s_addr
),

132 
	`Áohs
(0xFFFDè+ 
£ed
,

133 
	`Áohs
(0xFFFEè+ 
£ed
);

135 
tıhdr
 *
tıh
 = 
NULL
;

136 
udphdr
 *
udph
 = 
NULL
;

138 
h
->
_p
) {

139 
IPPROTO_TCP
:

140 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

141 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

142 
	`Áohl
(
h
->
_d¡
.
s_addr
),

143 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

144 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

155 
IPPROTO_IPIP
:

157 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

158 
hash_¥l™
, 
£ed
);

174  
rc
;

175 
	}
}

180 
ušt32_t


181 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

183 
ušt32_t
 
§ddr
, 
daddr
;

184 
ušt32_t
 
rc
 = 0;

187 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

188 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

189 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

190 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

191 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

192 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

193 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

194 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

196 ià(
hash_¥l™
 == 2) {

197 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

198 
	`Áohl
(
daddr
),

199 
	`Áohs
(0xFFFDè+ 
£ed
,

200 
	`Áohs
(0xFFFEè+ 
£ed
);

202 
tıhdr
 *
tıh
 = 
NULL
;

203 
udphdr
 *
udph
 = 
NULL
;

205 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

206 
IPPROTO_TCP
:

207 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

208 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

209 
	`Áohl
(
daddr
),

210 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

211 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

222 
IPPROTO_IPIP
:

224 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

225 
hash_¥l™
, 
£ed
);

227 
IPPROTO_IPV6
:

229 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

230 
hash_¥l™
, 
£ed
);

232 
IPPROTO_ICMP
:

233 
IPPROTO_GRE
:

234 
IPPROTO_ESP
:

235 
IPPROTO_PIM
:

236 
IPPROTO_IGMP
:

242 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

243 
	`Áohl
(
daddr
),

244 
	`Áohs
(0xFFFDè+ 
£ed
,

245 
	`Áohs
(0xFFFEè+ 
£ed
);

248  
rc
;

249 
	}
}

255 
ušt32_t


256 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

258 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

260 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

261 (
‘hh
->
‘h”_sho¡
[4] << 8) |

262 (
‘hh
->
‘h”_sho¡
[3] << 16) |

263 (
‘hh
->
‘h”_sho¡
[2] << 24);

264 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

265 (
‘hh
->
‘h”_dho¡
[4] << 8) |

266 (
‘hh
->
‘h”_dho¡
[3] << 16) |

267 (
‘hh
->
‘h”_dho¡
[2] << 24);

269 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

270 
	`Áohl
(
daddr
),

271 
	`Áohs
(0xFFFDè+ 
£ed
,

272 
	`Áohs
(0xFFFEè+ 
£ed
);

274  
rc
;

275 
	}
}

280 
šlše
 
ušt32_t


281 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

283 
ušt32_t
 
rc
 = 0;

284 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

286 
	`Áohs
(
vhdr
->
´Ùo
)) {

287 
ETHERTYPE_IP
:

288 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

289 
hash_¥l™
, 
£ed
);

291 
ETHERTYPE_IPV6
:

292 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

293 
hash_¥l™
, 
£ed
);

295 
ETHERTYPE_ARP
:

298 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

301  
rc
;

302 
	}
}

307 
ušt32_t


308 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

310 
rc
 = 0;

311 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

313 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

314 
ETHERTYPE_IP
:

315 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

316 
hash_¥l™
, 
£ed
);

318 
ETHERTYPE_IPV6
:

319 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

320 
hash_¥l™
, 
£ed
);

322 
ETHERTYPE_VLAN
:

323 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

325 
ETHERTYPE_ARP
:

328 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

332  
rc
;

333 
	}
}

340 
ušt16_t


341 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

343 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

344 
ušt32_t
 
i
;

347 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

348 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

349 ià(
sum
 > 0xFFFF)

350 
sum
 -= 0xFFFF;

357 ià(
i
 < 
Ën
) {

358 
sum
 +ğ
addr
[
i
] << 8;

359 ià(
sum
 > 0xFFFF)

360 
sum
 -= 0xFFFF;

362  
sum
;

363 
	}
}

370 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

372 
i
;

373 
a
[18];

375 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

376 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

377 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

378  (
i
 < 17 ? 
NULL
 : (*)&
a
);

379 
	}
}

382 
	$sigšt_h
(
sig
)

384 
i
;

386 ()
sig
;

387 
	`D
("Received control-C signal\n");

388 
Ãtm­u£
.
do_abÜt
 = 1;

389 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

390 
	}
}

392 
	gN‘m­U£
::
	$N‘m­U£
() {

393 *
‹mp
;

394 
u_št
 
i
;

395 
‹¡couÁ
=0;

397 
num_»cv
 = 1;

398 
couÁs
=
couÁr
=0;

399 
couÁr_queue1_cur
 = 
couÁr_queue1_cur_sync
 = 
couÁr_queue1
 = 
couÁr_queue2
 = 0;

400 
Ãxt_tuº_»cv
 = 0;

401 
tuº_ov”
 = 
Œue
;

402 
wa™_lšk
 = 2;

407 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

412 
	`sourû_hwaddr
(
iâame
);

416 
	`sigÇl
(
SIGINT
, 
sigšt_h
);

418 
	`š™Ÿlize_£nd_»cv
();

419 
§ã_to_¡¬t_»cv
 = 
Œue
;

420 
	}
}

426 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

428 
buf
[128];

429 
i
, 
j
, 
i0
;

430 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

434 
	`´štf
("ring %p cur %5d [buf %6d flags 0x%04x†en %5d]\n",

435 
ršg
, 
cur
,„šg->
¦Ù
[cur].
buf_idx
,

436 
ršg
->
¦Ù
[
cur
].
æags
, 
Ën
);

438 
i
 = 0; i < 
Ën
; ) {

439 
	`mem£t
(
buf
, (buf), ' ');

440 
	`¥rštf
(
buf
, "%5d: ", 
i
);

441 
i0
 = 
i
;

442 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

443 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

444 
i
 = 
i0
;

445 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

446 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

447 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

448 
	`´štf
("%s\n", 
buf
);

450 
	}
}

452 
	gN‘m­U£
::~
	$N‘m­U£
() {

453 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

456 #iâdeà
OPT_FOR_SINGLE_CORE


457 
£nd_th»ad
.
	`još
();

458 
»cv_th»ad
.
	`još
();

461 
	`¦“p
(5);

462 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

463 
cout
<<"Queu1 size:"<<
couÁr_queue1
<<
’dl
;

464 
cout
<<"Queu2 size:"<<
couÁr_queue2
<<
’dl
;

465 
cout
<<"Num…ckts:"<<
num_pkts
<<
’dl
;

471 
cout
<<"Com¶‘ed"<<
’dl
;

472 
	}
}

475 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

477 
nm»q
 
»q
;

478 
”r
;

480 
	`mem£t
(&
»q
, 0, (req));

481 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

482 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

483 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

484 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

485 ià(
”r
) {

486 
	`D
("Unableo get virtio-net header†ength");

490 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

491 ià(
vœt_hdr_Ën
) {

492 
	`D
("Port„equires virtio-net header,†ength = %d",

493 
vœt_hdr_Ën
);

495 
	}
}

498 
	gN‘m­U£
::
	$³r_cÜe_»cv_funcc
(
»cv_th»ad_¬g
 
¹a
) {

502 
š‹rçû
[25];

503 
nm_desc
 *
nmd
;

504 
Ãtm­_ršg
 *
ršg
;

505 
u_št
 
id
 = 
¹a
.id;

507 
u_št
 
n
, 
bur¡r
=64, 
couÁr
;

508 
udp_pkt
 udp_pkt;

509 
Ãtm­_¦Ù
 *
¦Ù
;

510 
pkthdr
 *
p
;

511 
pŞlfd
 
pfd
;

513 
´ev_cur
, 
Ãxt_cur
;

514 
Ãtm­_¦Ù
 *
´ev_¦Ù
, *
Ãxt_¦Ù
;

515 cÚ¡ *
´ev_buf
, *
Ãxt_buf
;

517 !
do_abÜt
 && (
u_št
)
	`sched_g‘ıu
()!=
id
) {

518 
this_th»ad
::
	`y›ld
();

522 
	`¥rštf
(
š‹rçû
, "%s}%d", 
¹a
.
iâame
, 
id
);

523 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

525 
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
¹a
.
·»Á_nmd
);

527 ià(
nmd
 =ğ
NULL
) {

528 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

531 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

532 
id
 + 1, 
š‹rçû
, 
nmd
->
»q
.
Ä_rx_¦Ùs
);

533 
ršg
 = 
	`NETMAP_RXRING
(
nmd
->
niå
, 0);

535 
	`D
("zerocopy %s",

536 (
¹a
 .
·»Á_nmd
->
mem
 =ğ
nmd
->mem) ? "enabled" : "disabled");

540 
pfd
.
fd
 = 
nmd
->fd;

541 
pfd
.
ev’ts
 = 
POLLIN
;

542 
pfd
.
»v’ts
 = 0;

543 
	`D
("Reûiv”h»ad %u s¹ed\n",
id
);

545 
»cv_¦ave_¡¬t_couÁ
++;

547 !
do_abÜt
) {

548 #ifdeà
BUSY_WAIT


549 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

550 
	`D
("ioùÈ”rÜ oÀqueu%d: %s", 
id
,

551 
	`¡»¼Ü
(
”ºo
));

555 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

558 if(
do_abÜt
) {

562 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

563 
	`D
("pŞÈ”¸Ú queu%d: %s", 
id
,

564 
	`¡»¼Ü
(
”ºo
));

569 
n
 = 
	`nm_ršg_¥aû
(
ršg
);

570 ià(
n
 > 
bur¡r
)

571 
n
 = 
bur¡r
;

573 
Ãxt_cur
 = 
ršg
->
cur
;

574 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

575 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

576 
	`__butš_´eãtch
(
Ãxt_buf
);

578 
n
--) {

579 
‹mp
[
MAX_BODYSIZE
];

580 
´ev_cur
 = 
Ãxt_cur
;

581 
´ev_¦Ù
 = 
Ãxt_¦Ù
;

582 
´ev_buf
 = 
Ãxt_buf
;

583 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

584 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

585 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

586 
	`__butš_´eãtch
(
Ãxt_buf
);

591 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

594 
	}
}

597 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

599 
Åes
 = 
»cv_ouut_ršgs
;

600 
sys_št
 = 0;

601 
my_ùrs
 
cur
, 
´ev
;

602 
b1
[40], 
b2
[40];

603 
my_ùrs
 *
pe_´ev
;

605 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

606 ià(
pe_´ev
 =ğ
NULL
) {

607 
	`D
("out of memory");

608 
	`ex™
(1);

611 
	`mem£t
(&
´ev
, 0, (prev));

612 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

613 !
do_abÜt
) {

614 
j
, 
dosy¦og
 = 0;

615 
ušt64_t
 
µs
, 
dps
, 
u£c
;

616 
my_ùrs
 
x
;

618 
	`mem£t
(&
cur
, 0, (cur));

619 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

621 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

622 
dosy¦og
 = 1;

623 
sys_št
 = 0;

626 
j
 = 0; j < 
Åes
; ++j) {

627 
pÜt_des
 *
p
 = &
pÜts
[
j
];

629 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

630 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

632 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

633 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

634 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

635 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

636 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

637 
pe_´ev
[
j
] = 
p
->
ùr
;

639 ià(
dosy¦og
) {

640 
	`sy¦og
(
LOG_INFO
,

645 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

648 
	`´štf
("\n");

649 ià(
dosy¦og
) {

650 
	`sy¦og
(
LOG_INFO
,

656 "nÚ__·ck‘s:%lu}", 
»cv_iâame
, 
fÜw¬ded
, 
drİ³d
, 
nÚ_
);

658 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

659 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

660 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

661 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

662 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

663 
´ev
 = 
cur
;

666 
	`ä“
(
pe_´ev
);

667 
	`D
("Done");

669 
	}
}

672 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

673 
i
, 
	gtÙ
 = 0;

674 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

677 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

678 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

679 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

681 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

684 !
	gq
->
	g¦Ùs
.
em±y
()) {

685 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

686 
	gq
->
	g¦Ùs
.
pİ
();

687 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

689 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

690 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

691 
	gtÙ
++;

694 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

698 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

699 
ušt16_t
 
i
,
j
;

700 
drİ³d
 = 
fÜw¬ded
 = 
nÚ_
 = 0;

702 
£nd_ma¡”_nmd
 = 
NULL
;

703 
»cv_ma¡”_nmd
 = 
NULL
;

704 
šc_bur¡
 = 0;

705 
»cv_¦ave_¡¬t_couÁ
 = 0;

706 
§ã_to_¡¬t_»cv
 = 
çl£
;

707 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

708 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

709 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

710 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

711 
£nd_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

713 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

714 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

715 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

716 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

718 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

719 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

720 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

721 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
,1);

722 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

729 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

730 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

731 
³r_cÜe_couÁs
[
i
] = 0;

733 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

734 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

735 
³r_cÜe_couÁr
[
i
] = 0;

739 #iâdeà
OPT_FOR_SINGLE_CORE


740 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

768 
	`¦“p
(2);

773 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

775 
	}
}

853 
	gN‘m­U£
::
	$³r_cÜe_»cv_func
(
cÜeid
) {

854 
	`D
("cÜ%d„ecv funø¡¬‹d", 
cÜeid
);

855 
‹mpbuf
[
MAX_BODYSIZE
];

856 *
‹mµŒ
;

857 
pk’
;

859 
	`sched_g‘ıu
()!=
cÜeid
) {

860 
this_th»ad
::
	`y›ld
();

863 !
»cv_ma¡”_nmd
) {

864 
this_th»ad
::
	`y›ld
();

866 !
do_abÜt
) {

867 
‹mµŒ
 = 
	`g‘_bufãr_rx
(
cÜeid
, 
pk’
);

868 if(
‹mµŒ
 =ğ
NULL
) {

869 
	`D
("nØbufã¸avaabË fÜ„eûiv© cÜid %d. AbÜtšg.", 
cÜeid
);

872 
	`nm_pkt_cİy
(
‹mµŒ
, 
‹mpbuf
, 
pk’
);

873 
	`syncbuäx
(
cÜeid
);

876 
	`D
("cÜ%d„ecv funøcom¶‘ed", 
cÜeid
);

877 
	}
}

878 
	g¦owšc
 = 0;

880 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

881 #iâdeà
OPT_FOR_SINGLE_CORE


882 !
£nd_ma¡”_nmd
) {

883 
this_th»ad
::
	`y›ld
();

886 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

887 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

888 
nm»q
 
ba£_»q
;

889 
š‹rçû
[25];

890 
	`mem£t
(&
ba£_»q
, 0, (base_req));

891 #ifdeà
OPT_FOR_SINGLE_CORE


892 
	`D
("İ’šg iÁ”çû‚amed %s", 
£nd_iâame
);

894 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

895 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

897 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

898 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

899  
NULL
;

901 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

902 
cÜeid
 + 1, 
£nd_iâame
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

903 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

906 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

907 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

908 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

910 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

911 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

912  
NULL
;

914 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

915 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

916 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

918 
	`D
("zerocopy %s",

919 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

925 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

929 
ušt16_t
 
n
;

930 
²
;

931 
pŞlfd
 
pfd
;

932 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

933 
pfd
.
ev’ts
 = 
POLLOUT
;

934 
pfd
.
»v’ts
 = 0;

935 #ifdeà
BUSY_WAIT


936 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

937 
	`D
("ioctlƒrror on queue %d: %s", 0,

938 
	`¡»¼Ü
(
”ºo
));

939  
NULL
;

943 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

946 if(
do_abÜt
) {

947  
NULL
;

951 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

952 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

953 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

954  
NULL
;

958 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

960 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

961 if(
¦owšc
 >=1000000 && 
šc_bur¡
) {

962 
£nd_b©ch_cÜe
[
cÜeid
]++;

966 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

967 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

969 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

972 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

974  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

975 
	}
}

977 
	gcouÁ·ck‘ss
 = 0;

979 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

980 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

981 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

982 ++
couÁ·ck‘ss
;

986 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

987 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

988 if(
pkthdr
->

.
_p
 =ğ
IPPROTO_UDP
) {

989 
¦Ù
->
Ën
 +ğ(
udphdr
);

991 
¦Ù
->
Ën
 +ğ(
tıhdr
);

993 
¦Ù
->
æags
 = 0;

998 #ifdeà
OPT_FOR_SINGLE_CORE


999 if(
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1000 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1002 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

1004 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1007 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1008 
ršg
->
¦Ù
[ršg->
cur
].
æags
 |ğ
NS_REPORT
;

1010 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1012 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1013 
ršg
->
h—d
 =„šg->
cur
;

1014 
pŞlfd
 
pfd
;

1015 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1016 
pfd
.
ev’ts
 = 
POLLOUT
;

1017 
pfd
.
»v’ts
 = 0;

1018 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1021 
	}
}

1022 
	gcouÁ·ck‘¤
 = 0;

1024 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pk’
) {

1025 !
»cv_ma¡”_nmd
) {

1026 
this_th»ad
::
	`y›ld
();

1028 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1029 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1030 
nm»q
 
ba£_»q
;

1031 
š‹rçû
[25];

1032 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1034 #ifdeà
OPT_FOR_SINGLE_CORE


1035 
	`D
("İ’šg iÁ”çû‚amed %s", 
»cv_iâame
);

1037 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1038 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1040 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1041 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1042  
NULL
;

1044 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1045 
cÜeid
 + 1, 
»cv_iâame
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1046 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1049 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1050 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1051 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1053 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1054 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1055  
NULL
;

1057 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1058 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1059 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1061 
	`D
("zerocopy %s",

1062 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1069 
¡¬t
:

1070 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1074 
ušt16_t
 
n
;

1075 
²
;

1076 
pŞlfd
 
pfd
;

1077 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1078 
pfd
.
ev’ts
 = 
POLLIN
;

1079 
pfd
.
»v’ts
 = 0;

1080 #ifdeà
BUSY_WAIT


1081 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1082 
	`D
("ioctlƒrror on queue %d: %s", 0,

1083 
	`¡»¼Ü
(
”ºo
));

1084  
NULL
;

1088 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1091 if(
do_abÜt
) {

1092  
NULL
;

1096 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1097 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1098 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1099  
NULL
;

1103 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1110 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1111 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1113 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1116 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1118 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1119 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1121 #ifdeà
OPT_FOR_SINGLE_CORE


1122 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1123 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1125 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1126 
³r_cÜe_couÁr
[
cÜeid
]--;

1127 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1128 
ršg
->
h—d
 =„šg->
cur
;

1129 
pŞlfd
 
pfd
;

1130 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1131 
pfd
.
ev’ts
 = 
POLLIN
;

1132 
pfd
.
»v’ts
 = 0;

1133 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1136 
¡¬t
;

1139 
pk’
 = 
¦Ù
->
Ën
-(
‘h”_h—d”
)-
vœt_hdr_Ën
;

1140  (*)((*)
pkt
+(
‘h”_h—d”
));

1142  
NULL
;

1144 
	}
}

1147 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1148 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1149 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1150 
³r_cÜe_couÁr
[
cÜeid
]--;

1151 ++
couÁ·ck‘¤
;

1153 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1154 
ršg
->
h—d
 =„šg->
cur
;

1155 
pŞlfd
 
pfd
;

1156 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1157 
pfd
.
ev’ts
 = 
POLLIN
;

1158 
pfd
.
»v’ts
 = 0;

1162 
	}
}

1165 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1169 
ch
;

1170 
ušt32_t
 
i
,
j
;

1171 
rv
;

1172 
veùÜ
<
pÜt_des
> 
pÜts
;

1173 
™”
 = 0;

1174 
ušt32_t
 
Åes
;

1175 
pÜt_des
 *
rxpÜt
;

1176 
pÜt_des
 *
txpÜt
;

1178 
nm»q
 
ba£_»q
;

1179 
ušt32_t
 
exŒa_bufs
;

1180 
ušt32_t
 
sÿn
;

1182 
u_št
 
couÁs
;

1183 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1184 
Ãtm­_ršg
 *
txršg
;

1187 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1188 
Åes
 = 
»cv_ouut_ršgs
;

1190 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1191 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1193 
	`D
("Åes:%u",
Åes
);

1195 
pÜts
.
	`»size
(
Åes
+2);

1197 
txpÜt
 = &
pÜts
[
Åes
];

1198 
rxpÜt
 = &
pÜts
[
Åes
+1];

1202 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1203 
	`D
("failedo‡llocatehe stats‡rray");

1204  
NULL
;

1207 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1209 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1210 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1212 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1213 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1214  
NULL
;

1216 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1217 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1220 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1221 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1224 
£nd_b©ch
 = 1;

1226 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1227 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1228 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1229 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1231 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1232 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1233  
NULL
;

1235 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1236 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1240 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1241 
txršg
 = 
txpÜt
->
ršg
;

1242 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1244 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1246 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1248 
i
 = 0; i < 
Åes
; ++i) {

1249 
š‹rçû
[25];

1250 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1251 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1252 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1254 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1255 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1256  
NULL
;

1258 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1259 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1260 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1262 
	`D
("zerocopy %s",

1263 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1266 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1267 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1269 
	`¦“p
(2);

1271 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1272 
ušt64_t
 
times
=0,
time
=0;

1276 !
do_abÜt
) {

1277 
u_št
 
pŞlo
 = 0;

1278 
™”
++;

1279 
i
 = 0; i < 
Åes
; ++i) {

1280 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1281 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1285 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1286 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1287 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1288 ++
pŞlo
;

1290 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1291 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1292 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1294 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1295 ià(
rv
 <= 0) {

1296 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1297 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1301 
b©ch_cur
 = 0;

1302 
i
 = 0; i < 
pŞlo
; i++) {

1303 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1306 
Ãxt_cur
 = 
ršg
->
cur
;

1307 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1308 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1309 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1310 
»cvcouÁ
--) {

1311 
n
;

1312 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1313 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1314 if(
¦owšc
 < 1000000) {

1315 
¦owšc
++;

1316 } if(
šc_bur¡
) {

1317 
£nd_b©ch
++;

1321 
b©ch_cur
 = 
£nd_b©ch
;

1325 #ifdeà
BUSY_WAIT


1326 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1327 
	`D
("ioctlƒrror on queue %d: %s", 0,

1328 
	`¡»¼Ü
(
”ºo
));

1329  
NULL
;

1332 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1333 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1334 
	`¡»¼Ü
(
”ºo
));

1335  
NULL
;

1337 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1338 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1339 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1340  
NULL
;

1343 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1344 ià(
n
 < 
b©ch_cur
)

1345 
b©ch_cur
 = 
n
;

1349 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1350 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1351 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1352 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1353 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1354 
	`__butš_´eãtch
(
Ãxt_buf
);

1356 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1357 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1358 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1363 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1366 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1372 if(
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1373 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1379 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
("00:22:4d:af:ae:42"), 6);

1381 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1388 
tx¦Ù
->
Ën
=
rs
->len;

1391 
tx¦Ù
->
æags
 = 0;

1392 
b©ch_cur
--;

1393 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
*8);

1394 ià(
b©ch_cur
==0) {

1395 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1397 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1398 ià(
b©ch_cur
==0) {

1399 
txršg
->
h—d
 =xršg->
cur
;

1400 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1404 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1409 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1410 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1414 
	`D
("%lu…ack‘ fÜw¬ded. %lu…ack‘ drİ³d. TÙ® %luim%luime %lu\n", 
fÜw¬ded
,

1415 
drİ³d
, 
fÜw¬ded
 + drİ³d, 
time
, 
times
);

1416  
NULL
;

1417 
	}
}

1420 
ušt64_t
 
	gnumbuf
=0;

1422 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1426 
ch
;

1427 
ušt32_t
 
i
,
j
;

1428 
rv
;

1429 
veùÜ
<
pÜt_des
> 
pÜts
;

1430 
™”
 = 0;

1431 
ušt32_t
 
Åes
;

1432 
ov”æow_queue
 *
ä“q
;

1433 
pÜt_des
 *
rxpÜt
;

1434 
pÜt_des
 *
txpÜt
;

1436 
nm»q
 
ba£_»q
;

1437 
ušt32_t
 
exŒa_bufs
;

1438 
ušt32_t
 
sÿn
;

1439 
veùÜ
<
ov”æow_queue
> 
oq
;

1441 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1444 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1445 
Åes
 = 
»cv_ouut_ršgs
;

1446 
ä“q
 = 
NULL
;

1448 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1449 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1451 
	`D
("Åes:%u",
Åes
);

1453 
pÜts
.
	`»size
(
Åes
+2);

1458 
oq
.
	`»size
(
Åes
+1);

1459 ià(
oq
.
	`size
()!=
Åes
+1) {

1460 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1461  
NULL
;

1464 
rxpÜt
 = &
pÜts
[
Åes
];

1465 
txpÜt
 = &
pÜts
[
Åes
+1];

1469 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1470 
	`D
("failedo‡llocatehe stats‡rray");

1471  
NULL
;

1474 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1476 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1477 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1479 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1480 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1481  
NULL
;

1483 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1484 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1487 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1488 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1491 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1493 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1494 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1495 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1496 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1498 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1499 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1500  
NULL
;

1502 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1503 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1507 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1508 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1510 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1512 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1513 ià(!
exŒa_bufs
)

1514 
run
;

1516 
ä“q
 = &
oq
[
Åes
];

1517 
rxpÜt
->
oq
 = 
NULL
;

1518 
txpÜt
->
oq
 = 
ä“q
;

1520 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1526 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1527 
sÿn
;

1528 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1530 
Ãtm­_¦Ù
 
s
;

1531 
s
.
buf_idx
 = 
sÿn
;

1532 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1533 
ä“q
->
¦Ùs
.
	`push
(
s
);

1536 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1537 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1538 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1539  
NULL
;

1541 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1543 
run
:

1544 
i
 = 0; i < 
Åes
; ++i) {

1545 
š‹rçû
[25];

1546 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1547 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1548 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1550 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1551 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1552  
NULL
;

1554 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1555 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1556 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1558 
	`D
("zerocopy %s",

1559 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1561 ià(
exŒa_bufs
) {

1562 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1563 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1564 
pÜts
[
i
].
oq
 = 
q
;

1568 ià(!
exŒa_bufs
) {

1569 ià(!
oq
.
	`em±y
()) {

1570 
i
 = 0; i < 
Åes
 + 1; i++) {

1571 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1572 
oq
[
i
].
¦Ùs
.
	`pİ
();

1574 
pÜts
[
i
].
oq
 = 
NULL
;

1576 
pÜts
[
i
].
oq
 = 
NULL
;

1577 
oq
.
	`ş—r
();

1579 
	`D
("*** overflow queues disabled ***");

1582 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1583 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1585 
	`¦“p
(2);

1587 !
§ã_to_¡¬t_»cv
) {

1588 
this_th»ad
::
	`y›ld
();

1591 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1592 
ušt64_t
 
times
=0,
time
=0;

1594 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
pÜts
[0]);

1596 !
do_abÜt
) {

1597 
u_št
 
pŞli
 = 0;

1598 
™”
++;

1599 
i
 = 0; i < 
Åes
; ++i) {

1600 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1601 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1605 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1606 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1607 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1608 ++
pŞli
;

1610 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1611 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1612 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1613 ++
pŞli
;

1615 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1616 ià(
rv
 <= 0) {

1617 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1618 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1622 ià(!
oq
.
	`em±y
()) {

1626 
i
 = 0; i < 
Åes
; i++) {

1627 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1628 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1629 
ušt32_t
 
j
, 
lim
;

1630 
Ãtm­_ršg
 *
ršg
;

1631 
Ãtm­_¦Ù
 *
¦Ù
;

1633 ià(
q
->
¦Ùs
.
	`em±y
())

1635 
ršg
 = 
p
->ring;

1636 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1637 ià(!
lim
)

1639 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1640 
lim
 = 
q
->
¦Ùs
.
	`size
();

1641 
j
 = 0; j < 
lim
; j++) {

1642 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1643 
q
->
¦Ùs
.
	`pİ
();

1644 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1645 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1646 *
¦Ù
 = 
s
;

1647 
p
->
ùr
.
pkts
 +ğ
s
.
Ën
*8;

1648 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1649 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1651 
ršg
->
h—d
 =„šg->
cur
;

1652 
fÜw¬ded
 +ğ
lim
;

1657 
b©ch_cur
 = 0;

1658 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1659 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1662 
Ãxt_cur
 = 
rxršg
->
cur
;

1663 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1664 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1665 !
	`nm_ršg_em±y
(
rxršg
)) {

1666 
ov”æow_queue
 *
q
;

1667 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1668 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1669 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1676 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1677 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1679 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1680 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1681 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1682 
	`__butš_´eãtch
(
Ãxt_buf
);

1683 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1685 
b©ch_cur
++;

1686 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1687 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1693 
b©ch_cur
 = 0;

1702 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1704 ià(
hash
 == 0)

1705 
nÚ_
++;

1707 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1708 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1709 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1710 
	`__butš_´eãtch
(
Ãxt_buf
);

1712 
ušt32_t
 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1714 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1715 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1716 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1719 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1720 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1721 *
cİy_buf
;

1722 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1723 
ts
->
Ën
 = 
rs
->len;

1724 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1726 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1727 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
*8);

1728 
fÜw¬ded
++;

1729 
fÜw¬d
;

1733 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1734 
drİ³d
++;

1735 
pÜt
->
ùr
.
drİ
+=
rs
->
Ën
*8;

1736 
Ãxt
;

1739 
q
 = &
oq
[
ouut_pÜt
];

1741 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1743 
ušt32_t
 
j
;

1744 
pÜt_des
 *
Í
 = &
pÜts
[0];

1745 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1747 
j
 = 1; j < 
Åes
; j++) {

1748 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1749 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1750 
Í
 = 
ı
;

1751 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

1756 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

1757 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

1758 
Í
->
ùr
.
drİ
 +ğ
tmp
.
Ën
*8;

1759 
Í
->
oq
->
¦Ùs
.
	`pİ
();

1760 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

1763 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

1764 
drİ³d
 +ğ
j
;

1767 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

1768 
ä“q
->
¦Ùs
.
	`pİ
();

1770 *
‹mp_buf
;

1771 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

1772 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

1773 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

1774 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

1776 
fÜw¬d
:

1778 
Ãxt
:

1779 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1781 
b©ch_cur
++;

1782 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1783 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1789 
b©ch_cur
 = 0;

1800 ià(
exŒa_bufs
) {

1801 
	`ä“_bufãrs
(
pÜts
);

1807 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

1808 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1810 
¡©_th»ad
.
	`još
();

1812 
	`D
("%lu…ack‘ fÜw¬ded. %lu…ack‘ drİ³d. TÙ® %luim%luime %lu\n", 
fÜw¬ded
,

1813 
drİ³d
, 
fÜw¬ded
 + drİ³d, 
time
, 
times
);

1814  
NULL
;

1815 
	}
}

1818 
u_št16_t


1819 
	$w¿psum
(
u_št32_t
 
sum
)

1821 
sum
 = ~sum & 0xFFFF;

1822  (
	`htÚs
(
sum
));

1823 
	}
}

1826 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

1828 
s
;

1829 
iäeq
 
bufãr
;

1830 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

1832 
	`mem£t
(&
bufãr
, 0x00, (buffer));

1833 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

1835 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

1837 
	`şo£
(
s
);

1838 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

1839 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

1840 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

1841 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

1842 
fd
;

1843 
iäeq
 
iä
;

1845 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

1848 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

1851 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

1853 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

1855 
	`şo£
(
fd
);

1858 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

1859 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

1860 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

1863 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1864 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

1865 
	`D
("Hurray 1");

1868 
š_addr
 
©t
;

1869 
	`š‘_©Ú
("169.254.9.8", &
©t
);

1871 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

1872 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

1873 
	`D
("Hurray 2");

1874 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

1877 
	}
}

1880 
	gN‘m­U£
::
	$š™_Ãtm­
()

1882 
pfdo
 = (
pŞlfd
){ .
fd
 = 
nmd
->fd, .
ev’ts
 = 
POLLOUT
 };

1883 
pfdi
 = (
pŞlfd
){ .
fd
 = 
nmd
->fd, .
ev’ts
 = 
POLLIN
 };

1884 
couÁs
 = 0;

1885 
couÁr
 = 0;

1886 
num_pkts
 = 1800001;

1887 
txršg
 = 
	`NETMAP_TXRING
(
nmd
->
niå
,‚md->
fœ¡_tx_ršg
);

1888 
rxršg
 = 
	`NETMAP_RXRING
(
nmd
->
niå
,‚md->
fœ¡_rx_ršg
);

1889 
txršg
->
h—d
!ñxršg->
cur
) {

1893 
txršg
->
h—d
 = 
	`nm_ršg_Ãxt
(txring,txring->head);

1895 
	}
}

1898 
	gN‘m­U£
::
	$İ’_Ãtm­_dev
(*
iâame
) {

1900 
i
;

1901 
devqueues
 = 1;

1903 
nm»q
 
ba£_nmd
;

1905 
	`bz”o
(&
ba£_nmd
, (base_nmd));

1913 
ba£_nmd
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1914 
nmd
 = 
	`nm_İ’
(
iâame
, &
ba£_nmd
, 0, 
NULL
);

1915 ià(
nmd
 =ğ
NULL
) {

1916 
	`D
("UÇbËØİ’ %s: %s", 
iâame
, 
	`¡»¼Ü
(
”ºo
));

1918 ià(
nmd
->
fd
 < 0) {

1919 
	`D
("aborting");

1920 
	`ex™
(0);

1923 
	`´štf
("m­³d %dKB‡ˆ%p", 
nmd
->
»q
.
Ä_memsize
>>10,‚md->
mem
);

1925 
Ãtm­_if
 *
niå
 = 
nmd
->nifp;

1926 
nm»q
 *
»q
 = &
nmd
->req;

1928 
	`´štf
("nifp‡t offset %d, %dx %d„x„egion %d",

1929 
»q
->
Ä_off£t
,„eq->
Ä_tx_ršgs
,„eq->
Ä_rx_ršgs
,

1930 
»q
->
Ä_¬g2
);

1931 
i
 = 0; i <ğ
»q
->
Ä_tx_ršgs
; i++) {

1932 
Ãtm­_ršg
 *
ršg
 = 
	`NETMAP_TXRING
(
niå
, 
i
);

1933 
	`´štf
(" TX%d‡ˆ0x%°¦Ù %d", 
i
,

1934 (*)((*)
ršg
 - (*)
niå
),„šg->
num_¦Ùs
);

1936 
i
 = 0; i <ğ
»q
->
Ä_rx_ršgs
; i++) {

1937 
Ãtm­_ršg
 *
ršg
 = 
	`NETMAP_RXRING
(
niå
, 
i
);

1938 
	`´štf
(" RX%d‡ˆ0x%°¦Ù %d", 
i
,

1939 (*)((*)
ršg
 - (*)
niå
),„šg->
num_¦Ùs
);

1942 
devqueues
 = 
nmd
->
»q
.
Ä_tx_ršgs
;

1943 
devqueues
 +ğ
nmd
->
»q
.
Ä_rx_ršgs
;

1945 
	`š™_Ãtm­
();

1946 
	`¦“p
(5);

1948 
	`årštf
(
¡dout
,

1950 
iâame
,

1951 
devqueues
);

1952 
	`´štf
("Netmap device opened.\n");

1953 
	`¦“p
(5);

1954 
couÁr_th»ad
 = 1;

1956 
	}
}

1960 
	gN‘m­U£
::
	$th»ad_func_tx
() {

1961 
u_št
 
n
;

1962 *
pkt
;

1963 
cout
<< "Th»adx s¹ed"<<
’dl
;

1965 
cout
<< "loİ begš"<<
’dl
;

1966 
couÁs_th»ad
==0 && !
do_abÜt
) {

1967 
this_th»ad
::
	`y›ld
();

1969 if(
do_abÜt
) {

1972 
couÁs_th»ad
=0;

1973 
cout
<< "couÁs_th»ad mad0" <<
’dl
;

1977 #ifdeà
BUSY_WAIT


1978 ià(
	`ioùl
(
pfdo
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1979 
	`D
("ioctlƒrror on queue %d: %s", 0,

1980 
	`¡»¼Ü
(
”ºo
));

1984 ià(
	`pŞl
(&(
pfdo
), 1, -1) <= 0) {

1985 
	`´štf
("pollƒrror/timeout on queue %d: %s", 0,

1986 
	`¡»¼Ü
(
”ºo
));

1989 ià(
pfdo
.
»v’ts
 & 
POLLERR
) {

1990 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1991 
nmd
->
fœ¡_tx_ršg
,‚md->
Ï¡_tx_ršg
);

1995 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1996 
cout
<<"S’d”‚: "<<
n
<<
’dl
;

2000 ià(
n
 <ğ
bur¡s
) {

2001 
couÁs
 = 
n
;

2003 
couÁs
 = 
bur¡s
;

2006 
cout
<< "th»adxƒnd"<<
’dl
;

2008 
	}
}

2010 *
	gN‘m­U£
::
	$g‘_bufãr_tx
() {

2011  
	`m®loc
(
MAX_BODYSIZE
);

2012 
	}
}

2015 
	gN‘m­U£
::
	$syncbuáx
(
udp_pkt
 *udp_pkt) {

2017 
u_št
 
n
;

2018 
Ãtm­_¦Ù
 *
tx¦Ù
;

2020 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
	`lk
(
cs_Ãtm­_sync
);

2022 
pkthdr
*…kthd¸ğ(pkthdr*)
udp_pkt
;

2023 
¡ršg
 
¡r
 = 
	`š‘_Áß
(
pkthdr
->

.
_d¡
);

2024 
cout
<<"De¡š©iÚ is:"<<
¡r
<<
’dl
;

2025 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

2029 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, 
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

2042 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

2043 *
±r
;

2044 if(
couÁs
 == 0) {

2049 #ifdeà
BUSY_WAIT


2050 ià(
	`ioùl
(
pfdo
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

2051 
	`D
("ioctlƒrror on queue %d: %s", 0,

2052 
	`¡»¼Ü
(
”ºo
));

2056 ià(
	`pŞl
(&(
pfdo
), 1, -1) <= 0) {

2057 
	`´štf
("pollƒrror/timeout on queue %d: %s", 0,

2058 
	`¡»¼Ü
(
”ºo
));

2061 ià(
pfdo
.
»v’ts
 & 
POLLERR
) {

2062 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

2063 
nmd
->
fœ¡_tx_ršg
,‚md->
Ï¡_tx_ršg
);

2067 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

2072 ià(
n
 <ğ
bur¡s
) {

2073 
couÁs
 = 
n
;

2075 
couÁs
 = 
bur¡s
;

2079 
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

2080 
tx¦Ù
->
æags
 = 0;

2081 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

2082 
tx¦Ù
->
Ën
 = 
	`Áohs
((
udp_pkt
)->
pkthdr
.

.
_Ën
è+ (
‘h”_h—d”
);

2083 ià(
couÁs
==1) {

2085 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

2087 
±r
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

2088 
	`nm_pkt_cİy
((*)(
udp_pkt
), 
±r
, 
tx¦Ù
->
Ën
);

2092 
couÁs
--;

2093 
txršg
->
h—d
 =xršg->
cur
 = 
	`nm_ršg_Ãxt
(txring,xring->cur);

2095 
	}
}

	@netmap_api_newbak1.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

393 
ušt32_t
 
th»ad_cÜe
 = 0;

395 #if 
N_MINUS_2_CONFIG


396 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

397 if(
STAT_ON_SEND_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

399 } if(
STAT_ON_RECV_CORE
) {

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

402 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

404 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

405 
th»ad_cÜe
 = 1;

407 
th»ad_cÜe
 = 0;

409 #–if 
N_MINUS_1_CONFIG


410 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

411 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

414 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

417 
th»ad_cÜe
 = 0;

420 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

421 if(
STAT_ON_SEND_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

423 } if(
STAT_ON_RECV_CORE
) {

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

426 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

429 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

430 
th»ad_cÜe
 = 1;

432 
th»ad_cÜe
 = 0;

437  
th»ad_cÜe
;

439 
	}
}

441 
	gN‘m­U£
::
	$N‘m­U£
() {

442 *
‹mp
;

443 
u_št
 
i
;

444 
‹¡couÁ
=0;

446 
num_»cv
 = 1;

447 
wa™_lšk
 = 2;

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

457 
	`sourû_hwaddr
(
iâame
);

463 
	`š™Ÿlize_£nd_»cv
();

465 #ifdef 
OPT_FOR_SINGLE_CORE


466 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
³r_cÜe_»cv_pÜt
[0]);

468 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

469 
»cv_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

471 
ušt8_t
 
i
; i<
£nd_ouut_ršgs
; i++) {

472 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

473 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

476 
£nd_™”
 = 
»cv_™”
 = 0;

479 
§ã_to_¡¬t_»cv
 = 
Œue
;

480 
	}
}

486 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

488 
buf
[128];

489 
i
, 
j
, 
i0
;

490 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

498 
i
 = 0; i < 
Ën
; ) {

499 
	`mem£t
(
buf
, (buf), ' ');

500 
	`¥rštf
(
buf
, "%5d: ", 
i
);

501 
i0
 = 
i
;

502 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

503 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

504 
i
 = 
i0
;

505 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

506 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

507 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

508 
	`´štf
("%s\n", 
buf
);

510 
	}
}

512 
	gN‘m­U£
::~
	$N‘m­U£
() {

513 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

514 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

517 #iâdeà
OPT_FOR_SINGLE_CORE


518 
£nd_th»ad
.
	`još
();

519 
»cv_th»ad
.
	`još
();

524 
	`g‘timeofday
(&
’d_time
, 
NULL
);

526  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

527 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

528 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

531 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

532 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

533 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

534 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

537 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

538 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

539 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

540 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

542 
¡©_th»ad
.
	`još
();

545 
	`¦“p
(5);

546 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

552 
cout
<<"Com¶‘ed"<<
’dl
;

553 
	}
}

556 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

558 
nm»q
 
»q
;

559 
”r
;

561 
	`mem£t
(&
»q
, 0, (req));

562 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

563 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

564 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

565 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

566 ià(
”r
) {

567 
	`D
("Unableo get virtio-net header†ength");

571 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

572 ià(
vœt_hdr_Ën
) {

573 
	`D
("Port„equires virtio-net header,†ength = %d",

574 
vœt_hdr_Ën
);

576 
	}
}

579 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

581 
th»ad_cÜe
 = 0;

583 #iâdef 
OPT_FOR_SINGLE_CORE


585 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

593 
Åes
 = 
»cv_ouut_ršgs
;

594 
sys_št
 = 0;

595 
my_ùrs
 
cur
, 
´ev
;

596 
b1
[40], 
b2
[40];

597 
my_ùrs
 *
pe_´ev
;

599 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

600 ià(
pe_´ev
 =ğ
NULL
) {

601 
	`D
("out of memory");

602 
	`ex™
(1);

605 
	`mem£t
(&
´ev
, 0, (prev));

606 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

607 !
do_abÜt
) {

608 
j
, 
dosy¦og
 = 0;

609 
ušt64_t
 
µs
, 
dps
, 
u£c
;

610 
my_ùrs
 
x
;

612 
	`mem£t
(&
cur
, 0, (cur));

613 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

615 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

616 
dosy¦og
 = 1;

617 
sys_št
 = 0;

620 
j
 = 0; j < 
Åes
; ++j) {

621 
pÜt_des
 *
p
 = &
pÜts
[
j
];

623 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

624 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

626 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

627 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

628 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

629 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

630 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

631 
pe_´ev
[
j
] = 
p
->
ùr
;

633 ià(
dosy¦og
) {

634 
	`sy¦og
(
LOG_INFO
,

639 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

642 
	`´štf
("\n");

652 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

653 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

654 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

655 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

656 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

657 
´ev
 = 
cur
;

660 
	`ä“
(
pe_´ev
);

661 
	`D
("Done");

663 
	}
}

666 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

667 
i
, 
	gtÙ
 = 0;

668 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

671 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

672 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

673 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

675 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

678 !
	gq
->
	g¦Ùs
.
em±y
()) {

679 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

680 
	gq
->
	g¦Ùs
.
pİ
();

681 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

683 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

684 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

685 
	gtÙ
++;

688 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

692 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

693 
ušt16_t
 
i
,
j
;

695 
£nd_ma¡”_nmd
 = 
NULL
;

696 
»cv_ma¡”_nmd
 = 
NULL
;

698 
§ã_to_¡¬t_»cv
 = 
çl£
;

699 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

700 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

701 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

702 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

704 #if 
N_MINUS_2_CONFIG


705 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

706 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

708 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

711 #–if 
N_MINUS_1_CONFIG


712 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

713 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

715 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

718 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

722 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

723 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

724 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

727 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

728 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

729 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

730 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

731 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

738 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

739 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

740 
³r_cÜe_couÁs
[
i
] = 0;

742 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

743 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

744 
³r_cÜe_couÁr
[
i
] = 0;

747 #iâdeà
OPT_FOR_SINGLE_CORE


748 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

776 
ıu_£t_t
 
ıu_£t
;

778 
th»ad_cÜe1
, 
th»ad_cÜe2
;

780 #if 
N_MINUS_2_CONFIG


781 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

782 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

783 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

784 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

785 
th»ad_cÜe1
 = 1;

786 
th»ad_cÜe2
 = 1;

788 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

790 #–if 
N_MINUS_1_CONFIG


791 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

792 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

793 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

795 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

798 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

799 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

800 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

802 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

806 
	`CPU_ZERO
(&
ıu_£t
);

807 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

808 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

809 if(
rc
!=0) {

810 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

813 
j
 = 0; j < 
CPU_SETSIZE
; j++)

814 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

815 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

819 
	`¦“p
(2);

821 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

823 
	`CPU_ZERO
(&
ıu_£t
);

824 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

825 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

826 if(
rc
!=0) {

827 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

830 
j
 = 0; j < 
CPU_SETSIZE
; j++)

831 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

832 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

836 
	}
}

914 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

915 #iâdeà
OPT_FOR_SINGLE_CORE


916 !
£nd_ma¡”_nmd
) {

917 
this_th»ad
::
	`y›ld
();

920 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

921 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

922 
nm»q
 
ba£_»q
;

923 
š‹rçû
[25];

924 
	`mem£t
(&
ba£_»q
, 0, (base_req));

925 #ifdeà
OPT_FOR_SINGLE_CORE


926 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

927 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

929 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

930 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

932 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

933 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

934  
NULL
;

936 
	`D
("successfully opened core #%d %s (tx slots: %d)",

937 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

938 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

941 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

942 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

943 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

945 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

946 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

947  
NULL
;

949 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

950 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

951 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

953 
	`D
("zerocopy %s",

954 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

960 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

964 
ušt16_t
 
n
;

965 
²
;

966 
pŞlfd
 
pfd
;

967 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

968 
pfd
.
ev’ts
 = 
POLLOUT
;

969 
pfd
.
»v’ts
 = 0;

970 #ifdeà
BUSY_WAIT


971 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

972 
	`D
("ioctlƒrror on queue %d: %s", 0,

973 
	`¡»¼Ü
(
”ºo
));

974  
NULL
;

978 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

981 if(
do_abÜt
) {

982  
NULL
;

986 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

987 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

988 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

989  
NULL
;

993 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

995 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

996 if(
šc_bur¡
) {

997 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

998 
	`D
("Burst increased");

1001 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

1002 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

1004 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

1007 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1009  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

1010 
	}
}

1012 
	gcouÁ·ck‘ss
 = 0;

1014 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

1015 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1016 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1020 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

1022 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

1023 
¦Ù
->
æags
 = 0;

1028 #ifdeà
OPT_FOR_SINGLE_CORE


1029 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1031 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1033 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1036 if(
cÜeid
 == 0) {

1037 
£nd_™”
++;

1040 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1041 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1044 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1045 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1047 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1049 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1054 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1055 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1057 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1060 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1061 
ršg
->
h—d
 =„šg->
cur
;

1062 
pŞlfd
 
pfd
;

1063 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1064 
pfd
.
ev’ts
 = 
POLLOUT
;

1065 
pfd
.
»v’ts
 = 0;

1066 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1070 
	}
}

1072 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1073 #iâdeà
OPT_FOR_SINGLE_CORE


1074 !
»cv_ma¡”_nmd
) {

1075 
this_th»ad
::
	`y›ld
();

1078 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1079 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1080 
nm»q
 
ba£_»q
;

1081 
š‹rçû
[25];

1082 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1084 #ifdeà
OPT_FOR_SINGLE_CORE


1085 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1086 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1088 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1089 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1091 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1092 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1093  
NULL
;

1095 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1096 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1097 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1100 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1101 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1102 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1104 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1105 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1106  
NULL
;

1108 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1109 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1110 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1112 
	`D
("zerocopy %s",

1113 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1120 
¡¬t
:

1121 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1125 
ušt16_t
 
n
;

1126 
²
;

1127 
pŞlfd
 
pfd
;

1128 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1129 
pfd
.
ev’ts
 = 
POLLIN
;

1130 
pfd
.
»v’ts
 = 0;

1131 #ifdeà
BUSY_WAIT


1132 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1133 
	`D
("ioctlƒrror on queue %d: %s", 0,

1134 
	`¡»¼Ü
(
”ºo
));

1135  
NULL
;

1139 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1142 if(
do_abÜt
) {

1143  
NULL
;

1147 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1148 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1149 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1150  
NULL
;

1154 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1161 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1162 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1164 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1166 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1168 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1170 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1171 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1174 #ifdeà
OPT_FOR_SINGLE_CORE


1175 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1176 if(
ARP_ENABLED
) {

1177 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1180 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1181 
³r_cÜe_couÁr
[
cÜeid
]--;

1182 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1183 
ršg
->
h—d
 =„šg->
cur
;

1184 
pŞlfd
 
pfd
;

1185 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1186 
pfd
.
ev’ts
 = 
POLLIN
;

1187 
pfd
.
»v’ts
 = 0;

1188 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1191 
¡¬t
;

1195  (*)((*)
pkt
+(
‘h”_h—d”
));

1197  
NULL
;

1199 
	}
}

1201 
	gcouÁ·ck‘¤
 = 0;

1203 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1207 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1209 #ifdeà
OPT_FOR_SINGLE_CORE


1210 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1211 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1213 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1216 if(
cÜeid
 == 0) {

1217 
»cv_™”
++;

1220 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1221 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1225 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1226 
³r_cÜe_couÁr
[
cÜeid
]--;

1227 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1228 
ršg
->
h—d
 =„šg->
cur
;

1229 
pŞlfd
 
pfd
;

1230 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1231 
pfd
.
ev’ts
 = 
POLLIN
;

1232 
pfd
.
»v’ts
 = 0;

1236 
	}
}

1239 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1241 
£nd_th»ad_cÜe
;

1243 
time_t
 
¡¬t_t
, 
’d_t
;

1244 
¿‹_t
, 
diff_t
;

1245 
timev®
 
begš
, 
’d
;

1247 #if 
N_MINUS_2_CONFIG


1248 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1249 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1250 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1251 
£nd_th»ad_cÜe
 = 1;

1253 
£nd_th»ad_cÜe
 = 0;

1255 #–if 
N_MINUS_1_CONFIG


1256 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1257 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1259 
£nd_th»ad_cÜe
 = 0;

1262 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1263 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1265 
£nd_th»ad_cÜe
 = 0;

1269 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1270 
this_th»ad
::
	`y›ld
();

1272 
ch
;

1273 
ušt32_t
 
i
,
j
;

1274 
rv
;

1275 
veùÜ
<
pÜt_des
> 
pÜts
;

1276 
ušt64_t
 
™”
 = 0;

1277 
ušt32_t
 
Åes
;

1278 
pÜt_des
 *
rxpÜt
;

1279 
pÜt_des
 *
txpÜt
;

1281 
nm»q
 
ba£_»q
;

1282 
ušt32_t
 
exŒa_bufs
;

1283 
ušt32_t
 
sÿn
;

1285 
u_št
 
couÁs
;

1286 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1287 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1288 
Ãtm­_ršg
 *
txršg
;

1291 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1292 
Åes
 = 
£nd_ouut_ršgs
;

1294 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1295 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1297 
	`D
("Åes:%u",
Åes
);

1299 
pÜts
.
	`»size
(
Åes
+2);

1301 
£nd_¡©s
.
	`»size
(
Åes
+1);

1303 
i
=0;i<=
Åes
;i++) {

1304 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

1307 
txpÜt
 = &
pÜts
[
Åes
];

1308 
rxpÜt
 = &
pÜts
[
Åes
+1];

1312 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1313 
	`D
("failedo‡llocatehe stats‡rray");

1314  
NULL
;

1317 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1319 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1320 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1322 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1323 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1324  
NULL
;

1326 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1327 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1330 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1331 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1334 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1336 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1337 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1338 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1339 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1341 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1342 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1343  
NULL
;

1345 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1346 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1350 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1351 
txršg
 = 
txpÜt
->
ršg
;

1352 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1354 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1356 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1358 
i
 = 0; i < 
Åes
; ++i) {

1359 
š‹rçû
[25];

1360 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1361 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1362 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1364 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1365 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1366  
NULL
;

1368 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1369 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1370 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1372 
	`D
("zerocopy %s",

1373 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1376 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1377 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1379 
	`¦“p
(2);

1381 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1382 
ušt64_t
 
times
=0;

1384 
i
 = 0; i < 
Åes
+2; ++i) {

1385 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1408 !
do_abÜt
) {

1409 
u_št
 
pŞlo
 = 0;

1411 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1413 
	`g‘timeofday
(&
begš
, 
NULL
);

1416 
™”
++;

1418 
i
 = 0; i < 
Åes
; ++i) {

1419 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1420 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1424 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1425 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1426 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1427 
úts
[
pŞlo
] = 
i
;

1428 ++
pŞlo
;

1430 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1431 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1432 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1434 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1435 ià(
rv
 <= 0) {

1436 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1437 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1441 
b©ch_cur
 = 0,
™emp
;

1442 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1443 
i
 = 
úts
[
™emp
];

1444 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1447 
Ãxt_cur
 = 
ršg
->
cur
;

1448 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1449 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1450 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1451 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1452 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1454 
»cvcouÁ
--) {

1455 
n
;

1456 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1457 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1458 if(
šc_bur¡
) {

1459 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1460 
	`D
("Burst increased");

1463 
b©ch_cur
 = 
£nd_b©ch
;

1467 #ifdeà
BUSY_WAIT


1468 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1469 
	`D
("ioctlƒrror on queue %d: %s", 0,

1470 
	`¡»¼Ü
(
”ºo
));

1471  
NULL
;

1474 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1475 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1476 
	`¡»¼Ü
(
”ºo
));

1477  
NULL
;

1479 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1480 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1481 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1482  
NULL
;

1485 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1486 ià(
n
 < 
b©ch_cur
)

1487 
b©ch_cur
 = 
n
;

1491 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1492 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1493 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1494 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1495 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1496 
	`__butš_´eãtch
(
Ãxt_buf
);

1498 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1499 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1500 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1505 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1508 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1514 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1515 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1521 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1523 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1530 
tx¦Ù
->
Ën
=
rs
->len;

1535 
tx¦Ù
->
æags
 = 0;

1536 
b©ch_cur
--;

1537 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1538 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1539 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1540 
£nd_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1542 ià(
b©ch_cur
==0) {

1543 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1545 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1546 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1547 
b©ch_cur
 = 0;

1548 
txršg
->
h—d
 =xršg->
cur
;

1549 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1553 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1560 
	`g‘timeofday
(&
’d
, 
NULL
);

1561 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

1562 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

1563 
¿‹_t
 = (
£nd_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

1564 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

1566 
	`¦“p
(5);

1567 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1568 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1574  
NULL
;

1575 
	}
}

1578 
ušt64_t
 
	gnumbuf
=0;

1580 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1582 
»cv_th»ad_cÜe
;

1584 
time_t
 
¡¬t_t
, 
’d_t
;

1585 
¿‹_t
, 
diff_t
;

1586 
timev®
 
begš
, 
’d
;

1588 #if 
N_MINUS_2_CONFIG


1589 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1590 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1591 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1592 
»cv_th»ad_cÜe
 = 1;

1594 
»cv_th»ad_cÜe
 = 0;

1596 #–if 
N_MINUS_1_CONFIG


1597 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1598 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1600 
»cv_th»ad_cÜe
 = 0;

1603 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1604 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1606 
»cv_th»ad_cÜe
 = 0;

1610 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1611 
this_th»ad
::
	`y›ld
();

1613 
	`D
("CÜ%d:",
»cv_th»ad_cÜe
);

1615 
ch
;

1616 
ušt32_t
 
i
,
j
;

1617 
rv
;

1618 
veùÜ
<
pÜt_des
> 
pÜts
;

1619 
™”
 = 0;

1620 
ušt32_t
 
Åes
;

1621 
ov”æow_queue
 *
ä“q
;

1622 
pÜt_des
 *
rxpÜt
;

1623 
pÜt_des
 *
txpÜt
;

1625 
nm»q
 
ba£_»q
;

1626 
ušt32_t
 
exŒa_bufs
;

1627 
ušt32_t
 
sÿn
;

1628 
veùÜ
<
ov”æow_queue
> 
oq
;

1630 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1633 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1634 
Åes
 = 
»cv_ouut_ršgs
;

1635 
ä“q
 = 
NULL
;

1637 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1638 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1640 
	`D
("Åes:%u",
Åes
);

1642 
pÜts
.
	`»size
(
Åes
+2);

1644 
»cv_¡©s
.
	`»size
(
Åes
+1);

1646 
i
=0;i<=
Åes
;i++) {

1647 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

1654 
oq
.
	`»size
(
Åes
+1);

1655 ià(
oq
.
	`size
()!=
Åes
+1) {

1656 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1657  
NULL
;

1660 
rxpÜt
 = &
pÜts
[
Åes
];

1661 
txpÜt
 = &
pÜts
[
Åes
+1];

1665 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1666 
	`D
("failedo‡llocatehe stats‡rray");

1667  
NULL
;

1670 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1672 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1673 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1675 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1676 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1677  
NULL
;

1679 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1680 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1683 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1684 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1687 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1689 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1690 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1691 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1692 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1694 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1695 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1696  
NULL
;

1698 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1699 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1703 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1704 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1706 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1708 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1709 ià(!
exŒa_bufs
)

1710 
run
;

1712 
ä“q
 = &
oq
[
Åes
];

1713 
rxpÜt
->
oq
 = 
NULL
;

1714 
txpÜt
->
oq
 = 
ä“q
;

1716 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1722 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1723 
sÿn
;

1724 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1726 
Ãtm­_¦Ù
 
s
;

1727 
s
.
buf_idx
 = 
sÿn
;

1728 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1729 
ä“q
->
¦Ùs
.
	`push
(
s
);

1732 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1733 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1734 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1735  
NULL
;

1737 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1739 
run
:

1740 
i
 = 0; i < 
Åes
; ++i) {

1741 
š‹rçû
[25];

1742 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1743 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1744 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1746 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1747 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1748  
NULL
;

1750 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1751 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1752 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1754 
	`D
("zerocopy %s",

1755 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1757 ià(
exŒa_bufs
) {

1758 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1759 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1760 
pÜts
[
i
].
oq
 = 
q
;

1764 ià(!
exŒa_bufs
) {

1765 ià(!
oq
.
	`em±y
()) {

1766 
i
 = 0; i < 
Åes
 + 1; i++) {

1767 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1768 
oq
[
i
].
¦Ùs
.
	`pİ
();

1770 
pÜts
[
i
].
oq
 = 
NULL
;

1772 
pÜts
[
i
].
oq
 = 
NULL
;

1773 
oq
.
	`ş—r
();

1775 
	`D
("*** overflow queues disabled ***");

1778 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1779 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1781 
	`¦“p
(2);

1783 !
§ã_to_¡¬t_»cv
) {

1784 
this_th»ad
::
	`y›ld
();

1787 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1788 
ušt64_t
 
times
=0;

1790 
i
 = 0; i < 
Åes
+2; ++i) {

1791 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1814 !
do_abÜt
) {

1815 
u_št
 
pŞli
 = 0;

1817 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1819 
	`g‘timeofday
(&
begš
, 
NULL
);

1822 
™”
++;

1823 
i
 = 0; i < 
Åes
; ++i) {

1824 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1825 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1829 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1830 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1831 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1832 ++
pŞli
;

1834 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1835 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1836 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1837 ++
pŞli
;

1839 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1840 ià(
rv
 <= 0) {

1841 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1842 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1846 ià(!
oq
.
	`em±y
()) {

1850 
i
 = 0; i < 
Åes
; i++) {

1851 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1852 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1853 
ušt32_t
 
j
, 
lim
;

1854 
Ãtm­_ršg
 *
ršg
;

1855 
Ãtm­_¦Ù
 *
¦Ù
;

1857 ià(
q
->
¦Ùs
.
	`em±y
())

1859 
ršg
 = 
p
->ring;

1860 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1861 ià(!
lim
)

1863 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1864 
lim
 = 
q
->
¦Ùs
.
	`size
();

1865 
j
 = 0; j < 
lim
; j++) {

1866 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1867 
q
->
¦Ùs
.
	`pİ
();

1868 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1869 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1870 *
¦Ù
 = 
s
;

1871 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1872 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1873 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1874 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1876 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1877 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1879 
ršg
->
h—d
 =„šg->
cur
;

1884 
b©ch_cur
 = 0;

1885 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1886 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1889 
Ãxt_cur
 = 
rxršg
->
cur
;

1890 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1891 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1892 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1893 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1894 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1896 
ršg¥aû
--) {

1897 
ov”æow_queue
 *
q
;

1898 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1899 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1900 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1907 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1908 if(
ARP_ENABLED
) {

1909 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1912 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1913 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1914 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1915 
	`__butš_´eãtch
(
Ãxt_buf
);

1916 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1918 
b©ch_cur
++;

1919 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1920 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1926 
b©ch_cur
 = 0;

1935 
ušt32_t
 
ouut_pÜt
 = 0;

1936 if(
»cv_th»ad_cÜe
) {

1937 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1939 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1946 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1947 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1948 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1949 
	`__butš_´eãtch
(
Ãxt_buf
);

1953 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1954 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1955 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1958 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1959 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1960 *
cİy_buf
;

1961 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1962 
ts
->
Ën
 = 
rs
->len;

1963 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1965 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1967 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

1968 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1969 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1970 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1973 
fÜw¬d
;

1977 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1978 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

1979 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1980 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1981 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1983 
Ãxt
;

1986 
q
 = &
oq
[
ouut_pÜt
];

1988 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1990 
ušt32_t
 
j
;

1991 
pÜt_des
 *
Í
 = &
pÜts
[0];

1992 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1994 
j
 = 1; j < 
Åes
; j++) {

1995 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1996 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1997 
Í
 = 
ı
;

1998 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2003 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2004 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2006 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2007 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2008 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2009 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2012 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2013 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2016 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2019 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2020 
ä“q
->
¦Ùs
.
	`pİ
();

2022 *
‹mp_buf
;

2023 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2024 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2025 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2026 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2028 
fÜw¬d
:

2030 
Ãxt
:

2031 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2033 
b©ch_cur
++;

2034 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2035 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2041 
b©ch_cur
 = 0;

2052 ià(
exŒa_bufs
) {

2053 
	`ä“_bufãrs
(
pÜts
);

2062 
	`g‘timeofday
(&
’d
, 
NULL
);

2063 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

2064 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

2065 
¿‹_t
 = (
»cv_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

2066 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

2068 
	`¦“p
(5);

2069 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2070 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2076  
NULL
;

2077 
	}
}

2080 
u_št16_t


2081 
	$w¿psum
(
u_št32_t
 
sum
)

2083 
sum
 = ~sum & 0xFFFF;

2084  (
	`htÚs
(
sum
));

2085 
	}
}

2088 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2090 
s
;

2091 
iäeq
 
bufãr
;

2092 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2094 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2095 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2097 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2099 
	`şo£
(
s
);

2100 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2101 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2102 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2103 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2104 
fd
;

2105 
iäeq
 
iä
;

2107 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2110 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2113 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2115 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2117 
	`şo£
(
fd
);

2120 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2121 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2122 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2125 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2126 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2127 
	`D
("Hurray 1");

2130 
š_addr
 
©t
;

2131 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2133 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

2134 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2135 
	`D
("Hurray 2");

2136 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2139 
	}
}

	@netmap_api_newbak2.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

393 
ušt32_t
 
th»ad_cÜe
 = 0;

395 #if 
N_MINUS_2_CONFIG


396 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

397 if(
STAT_ON_SEND_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

399 } if(
STAT_ON_RECV_CORE
) {

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

402 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

404 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

405 
th»ad_cÜe
 = 1;

407 
th»ad_cÜe
 = 0;

409 #–if 
N_MINUS_1_CONFIG


410 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

411 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

414 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

417 
th»ad_cÜe
 = 0;

420 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

421 if(
STAT_ON_SEND_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

423 } if(
STAT_ON_RECV_CORE
) {

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

426 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

429 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

430 
th»ad_cÜe
 = 1;

432 
th»ad_cÜe
 = 0;

437  
th»ad_cÜe
;

439 
	}
}

441 
	gN‘m­U£
::
	$N‘m­U£
() {

442 *
‹mp
;

443 
u_št
 
i
;

444 
‹¡couÁ
=0;

445 
wa™_lšk
 = 2;

450 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

455 
	`sourû_hwaddr
(
iâame
);

461 
	`š™Ÿlize_£nd_»cv
();

463 #ifdef 
OPT_FOR_SINGLE_CORE


464 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
³r_cÜe_»cv_pÜt
[0]);

466 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

467 
»cv_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

469 
ušt8_t
 
i
; i<
£nd_ouut_ršgs
; i++) {

470 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

471 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

474 
£nd_™”
 = 
»cv_™”
 = 0;

477 
§ã_to_¡¬t_»cv
 = 
Œue
;

478 
	}
}

484 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

486 
buf
[128];

487 
i
, 
j
, 
i0
;

488 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

492 
	`´štf
("ring %p cur %5d [buf %6d flags 0x%04x†en %5d]\n",

493 
ršg
, 
cur
,„šg->
¦Ù
[cur].
buf_idx
,

494 
ršg
->
¦Ù
[
cur
].
æags
, 
Ën
);

496 
i
 = 0; i < 
Ën
; ) {

497 
	`mem£t
(
buf
, (buf), ' ');

498 
	`¥rštf
(
buf
, "%5d: ", 
i
);

499 
i0
 = 
i
;

500 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

501 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

502 
i
 = 
i0
;

503 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

504 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

505 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

506 
	`´štf
("%s\n", 
buf
);

508 
	}
}

510 
	gN‘m­U£
::~
	$N‘m­U£
() {

511 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

512 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

515 #iâdeà
OPT_FOR_SINGLE_CORE


516 
£nd_th»ad
.
	`još
();

517 
»cv_th»ad
.
	`još
();

521 
	`g‘timeofday
(&
’d_time
, 
NULL
);

523  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

524 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

525 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

528 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

529 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

530 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

531 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

534 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

535 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

536 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

537 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

539 
¡©_th»ad
.
	`još
();

542 
	`¦“p
(5);

543 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

549 
cout
<<"Com¶‘ed"<<
’dl
;

550 
	}
}

553 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

555 
nm»q
 
»q
;

556 
”r
;

558 
	`mem£t
(&
»q
, 0, (req));

559 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

560 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

561 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

562 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

563 ià(
”r
) {

564 
	`D
("Unableo get virtio-net header†ength");

568 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

569 ià(
vœt_hdr_Ën
) {

570 
	`D
("Port„equires virtio-net header,†ength = %d",

571 
vœt_hdr_Ën
);

573 
	}
}

576 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

578 
th»ad_cÜe
 = 0;

580 #iâdef 
OPT_FOR_SINGLE_CORE


582 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

589 
Åes
 = 
»cv_ouut_ršgs
;

590 
sys_št
 = 0;

591 
my_ùrs
 
cur
, 
´ev
;

592 
b1
[40], 
b2
[40];

593 
my_ùrs
 *
pe_´ev
;

595 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

596 ià(
pe_´ev
 =ğ
NULL
) {

597 
	`D
("out of memory");

598 
	`ex™
(1);

601 
	`mem£t
(&
´ev
, 0, (prev));

602 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

603 !
do_abÜt
) {

604 
j
, 
dosy¦og
 = 0;

605 
ušt64_t
 
µs
, 
dps
, 
u£c
;

606 
my_ùrs
 
x
;

608 
	`mem£t
(&
cur
, 0, (cur));

609 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

611 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

612 
dosy¦og
 = 1;

613 
sys_št
 = 0;

616 
j
 = 0; j < 
Åes
; ++j) {

617 
pÜt_des
 *
p
 = &
pÜts
[
j
];

619 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

620 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

622 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

623 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

624 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

625 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

626 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

627 
pe_´ev
[
j
] = 
p
->
ùr
;

629 ià(
dosy¦og
) {

630 
	`sy¦og
(
LOG_INFO
,

635 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

638 
	`´štf
("\n");

648 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

649 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

650 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

651 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

652 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

653 
´ev
 = 
cur
;

656 
	`ä“
(
pe_´ev
);

657 
	`D
("Done");

659 
	}
}

662 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

663 
i
, 
	gtÙ
 = 0;

664 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

667 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

668 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

669 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

671 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

674 !
	gq
->
	g¦Ùs
.
em±y
()) {

675 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

676 
	gq
->
	g¦Ùs
.
pİ
();

677 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

679 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

680 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

681 
	gtÙ
++;

684 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

688 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

689 
ušt16_t
 
i
,
j
;

691 
£nd_ma¡”_nmd
 = 
NULL
;

692 
»cv_ma¡”_nmd
 = 
NULL
;

694 
§ã_to_¡¬t_»cv
 = 
çl£
;

695 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

696 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

697 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

698 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

700 #if 
N_MINUS_2_CONFIG


701 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

702 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

704 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

707 #–if 
N_MINUS_1_CONFIG


708 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

709 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

711 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

714 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

718 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

719 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

720 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

723 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

724 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

725 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

726 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
,
MAX_BATCH_CORE_SEND
);

727 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

734 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

735 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

736 
³r_cÜe_couÁs
[
i
] = 0;

738 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

739 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

740 
³r_cÜe_couÁr
[
i
] = 0;

743 #iâdeà
OPT_FOR_SINGLE_CORE


744 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

772 
ıu_£t_t
 
ıu_£t
;

774 
th»ad_cÜe1
, 
th»ad_cÜe2
;

776 #if 
N_MINUS_2_CONFIG


777 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

778 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

779 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

780 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

781 
th»ad_cÜe1
 = 1;

782 
th»ad_cÜe2
 = 1;

784 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

786 #–if 
N_MINUS_1_CONFIG


787 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

788 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

789 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

791 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

794 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

795 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

796 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

798 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

802 
	`CPU_ZERO
(&
ıu_£t
);

803 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

804 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

805 if(
rc
!=0) {

806 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

809 
j
 = 0; j < 
CPU_SETSIZE
; j++)

810 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

811 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

815 
	`¦“p
(2);

817 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

819 
	`CPU_ZERO
(&
ıu_£t
);

820 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

821 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

822 if(
rc
!=0) {

823 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

826 
j
 = 0; j < 
CPU_SETSIZE
; j++)

827 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

828 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

833 
nm»q
 
ba£_nmd
;

835 
	`bz”o
(&
ba£_nmd
, (base_nmd));

837 
ba£_nmd
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

846 
mq_nmd
 = 
	`nm_İ’
(
iâame
, &
ba£_nmd
, 0, 
NULL
);

847 
	`D
("V1");

848 ià(
£nd_ouut_ršgs
 > 1) {

849 
nm_desc
 
§ved_desc
 = *
mq_nmd
;

851 
§ved_desc
.
£lf
 = &saved_desc;

852 
§ved_desc
.
mem
 = 
NULL
;

853 
	`nm_şo£
(
mq_nmd
);

854 
§ved_desc
.
»q
.
Ä_æags
 &ğ~
NR_REG_MASK
;

855 
§ved_desc
.
»q
.
Ä_æags
 |ğ
NR_REG_ONE_NIC
;

856 
§ved_desc
.
»q
.
Ä_ršgid
 = 0;

857 
³r_cÜe_£nd_pÜt
[0].
nmd
 = 
mq_nmd
 = 
	`nm_İ’
(
iâame
, &
ba£_nmd
, 
NM_OPEN_IFNAME
, &
§ved_desc
);

858 ià(
³r_cÜe_£nd_pÜt
[0].
nmd
 =ğ
NULL
) {

859 
	`D
("UÇbËØİ’ %s: %s", 
iâame
, 
	`¡»¼Ü
(
”ºo
));

862 
³r_cÜe_£nd_pÜt
[0].
ršg
 = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[0].
nmd
->
niå
, 0);

863 
	`D
("TX RINGS %d: %d %d", 0, 
³r_cÜe_£nd_pÜt
[0].
nmd
->
»q
.
Ä_tx_ršgs
,…”_cÜe_£nd_pÜt[0].nmd->»q.
Ä_rx_ršgs
);

867 
	`D
("V2");

868 
i
 = 0; i < 
£nd_ouut_ršgs
; i++) {

869 
nm_desc
 
nmd
 = *
mq_nmd
;

870 
ušt64_t
 
nmd_æags
 = 0;

871 
nmd
.
£lf
 = &nmd;

874 ià(
i
 >= 0) {

878 ià(
£nd_ouut_ršgs
 > 1) {

879 
nmd
.
»q
.
Ä_æags
 =

880 
mq_nmd
->
»q
.
Ä_æags
 & ~
NR_REG_MASK
;

881 
nmd
.
»q
.
Ä_æags
 |ğ
NR_REG_ONE_NIC
;

882 
nmd
.
»q
.
Ä_ršgid
 = 
i
;

885 ià(
i
) {

886 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
	`nm_İ’
(
iâame
, 
NULL
, 
nmd_æags
 | 
NM_OPEN_IFNAME
 | 
NM_OPEN_NO_MMAP
, &nmd);

887 ià(
³r_cÜe_£nd_pÜt
[
i
].
nmd
 =ğ
NULL
) {

888 
	`D
("Unableo open send %s-%d: %s",

889 
iâame
, 
i
, 
	`¡»¼Ü
(
”ºo
));

892 
³r_cÜe_£nd_pÜt
[
i
].
ršg
 = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[i].
nmd
->
niå
, i);

893 
	`D
("TX RINGS %d: %d %d", 
i
, 
³r_cÜe_£nd_pÜt
[i].
nmd
->
»q
.
Ä_tx_ršgs
,…”_cÜe_£nd_pÜt[i].nmd->»q.
Ä_rx_ršgs
);

896 
nmd_æags
 |ğ
NETMAP_NO_TX_POLL
;

899 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
	`nm_İ’
(
iâame
, 
NULL
, 
nmd_æags
 | 
NM_OPEN_IFNAME
 | 
NM_OPEN_NO_MMAP
, &nmd);

900 ià(
³r_cÜe_»cv_pÜt
[
i
].
nmd
 =ğ
NULL
) {

901 
	`D
("Unableo open„ecv %s-%d: %s",

902 
iâame
, 
i
, 
	`¡»¼Ü
(
”ºo
));

905 
³r_cÜe_»cv_pÜt
[
i
].
ršg
 = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[i].
nmd
->
niå
, i);

906 
	`D
("RX RINGS %d: %d %d", 
i
, 
³r_cÜe_»cv_pÜt
[i].
nmd
->
»q
.
Ä_tx_ršgs
,…”_cÜe_»cv_pÜt[i].nmd->»q.
Ä_rx_ršgs
);

909 
	`D
("V3");

911 
	}
}

989 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

990 #iâdeà
OPT_FOR_SINGLE_CORE


991 !
£nd_ma¡”_nmd
) {

992 
this_th»ad
::
	`y›ld
();

995 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

996 #iâdeà
OPT_FOR_SINGLE_CORE


997 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

998 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

999 
nm»q
 
ba£_»q
;

1000 
š‹rçû
[25];

1001 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1002 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

1003 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1004 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

1006 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1007 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1008  
NULL
;

1010 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1011 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1012 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

1014 
	`D
("zerocopy %s",

1015 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1021 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1025 
ušt16_t
 
n
;

1026 
²
;

1027 
pŞlfd
 
pfd
;

1028 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1029 
pfd
.
ev’ts
 = 
POLLOUT
;

1030 
pfd
.
»v’ts
 = 0;

1031 #ifdeà
BUSY_WAIT


1032 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1033 
	`D
("ioctlƒrror on queue %d: %s", 0,

1034 
	`¡»¼Ü
(
”ºo
));

1035  
NULL
;

1039 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1042 if(
do_abÜt
) {

1043  
NULL
;

1047 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1050  
NULL
;

1054 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

1056 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

1057 if(
šc_bur¡
) {

1058 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

1059 
	`D
("Burst increased");

1062 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

1063 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

1065 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

1068 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1070  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

1071 
	}
}

1073 
	gcouÁ·ck‘ss
 = 0;

1075 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

1076 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1077 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1081 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

1082 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

1083 
¦Ù
->
æags
 = 0;

1088 #ifdeà
OPT_FOR_SINGLE_CORE


1089 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1091 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1093 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1096 if(
cÜeid
 == 0) {

1097 
£nd_™”
++;

1100 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1101 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1104 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1105 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1107 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1109 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1113 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1114 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1116 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1118 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1119 
ršg
->
h—d
 =„šg->
cur
;

1120 
pŞlfd
 
pfd
;

1121 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1122 
pfd
.
ev’ts
 = 
POLLOUT
;

1123 
pfd
.
»v’ts
 = 0;

1124 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1128 
	}
}

1130 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1131 #iâdeà
OPT_FOR_SINGLE_CORE


1132 !
»cv_ma¡”_nmd
) {

1133 
this_th»ad
::
	`y›ld
();

1136 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1138 #iâdeà
OPT_FOR_SINGLE_CORE


1139 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1140 
nm»q
 
ba£_»q
;

1141 
š‹rçû
[25];

1142 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1143 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1144 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1145 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1147 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1148 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1149  
NULL
;

1151 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1152 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1153 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1155 
	`D
("zerocopy %s",

1156 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1163 
¡¬t
:

1164 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1168 
ušt16_t
 
n
;

1169 
²
;

1170 
pŞlfd
 
pfd
;

1171 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1172 
pfd
.
ev’ts
 = 
POLLIN
;

1173 
pfd
.
»v’ts
 = 0;

1174 #ifdeà
BUSY_WAIT


1175 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1176 
	`D
("ioctlƒrror on queue %d: %s", 0,

1177 
	`¡»¼Ü
(
”ºo
));

1178  
NULL
;

1182 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1185 if(
do_abÜt
) {

1186  
NULL
;

1190 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1191 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1192 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1193  
NULL
;

1197 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1204 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1205 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1207 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1209 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1211 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1213 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1214 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1217 #ifdeà
OPT_FOR_SINGLE_CORE


1218 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1219 if(
ARP_ENABLED
) {

1220 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1223 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1224 
³r_cÜe_couÁr
[
cÜeid
]--;

1225 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1226 
ršg
->
h—d
 =„šg->
cur
;

1227 
pŞlfd
 
pfd
;

1228 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1229 
pfd
.
ev’ts
 = 
POLLIN
;

1230 
pfd
.
»v’ts
 = 0;

1231 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1234 
¡¬t
;

1238  (*)((*)
pkt
+(
‘h”_h—d”
));

1240  
NULL
;

1242 
	}
}

1244 
	gcouÁ·ck‘¤
 = 0;

1246 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1249 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1251 #ifdeà
OPT_FOR_SINGLE_CORE


1252 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1253 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1255 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1258 if(
cÜeid
 == 0) {

1259 
»cv_™”
++;

1262 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1263 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1267 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1268 
³r_cÜe_couÁr
[
cÜeid
]--;

1269 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1270 
ršg
->
h—d
 =„šg->
cur
;

1271 
pŞlfd
 
pfd
;

1272 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1273 
pfd
.
ev’ts
 = 
POLLIN
;

1274 
pfd
.
»v’ts
 = 0;

1278 
	}
}

1281 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1283 
£nd_th»ad_cÜe
;

1285 
time_t
 
¡¬t_t
, 
’d_t
;

1286 
¿‹_t
, 
diff_t
;

1287 
timev®
 
begš
, 
’d
;

1289 #if 
N_MINUS_2_CONFIG


1290 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1291 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1292 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1293 
£nd_th»ad_cÜe
 = 1;

1295 
£nd_th»ad_cÜe
 = 0;

1297 #–if 
N_MINUS_1_CONFIG


1298 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1299 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1301 
£nd_th»ad_cÜe
 = 0;

1304 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1305 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1307 
£nd_th»ad_cÜe
 = 0;

1311 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1312 
this_th»ad
::
	`y›ld
();

1314 
ch
;

1315 
ušt32_t
 
i
,
j
;

1316 
rv
;

1317 
veùÜ
<
pÜt_des
> 
pÜts
;

1318 
™”
 = 0;

1319 
ušt32_t
 
Åes
;

1320 
pÜt_des
 *
rxpÜt
;

1321 
pÜt_des
 *
txpÜt
;

1323 
nm»q
 
ba£_»q
;

1324 
ušt32_t
 
exŒa_bufs
;

1325 
ušt32_t
 
sÿn
;

1327 
u_št
 
couÁs
;

1328 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1329 
Ãtm­_ršg
 *
txršg
;

1330 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1332 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1333 
Åes
 = 
£nd_ouut_ršgs
;

1335 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1336 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1338 
	`D
("Åes:%u",
Åes
);

1340 
pÜts
.
	`»size
(
Åes
+2);

1342 
£nd_¡©s
.
	`»size
(
Åes
+1);

1344 
i
=0;i<=
Åes
;i++) {

1345 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

1348 
txpÜt
 = &
pÜts
[
Åes
];

1349 
rxpÜt
 = &
pÜts
[
Åes
+1];

1353 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1354 
	`D
("failedo‡llocatehe stats‡rray");

1355  
NULL
;

1358 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1360 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1361 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1363 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1364 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1365  
NULL
;

1367 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1368 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1371 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1372 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1375 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1377 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1378 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1379 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1380 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1382 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1383 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1384  
NULL
;

1386 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1387 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1391 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1392 
txršg
 = 
txpÜt
->
ršg
;

1393 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1395 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1397 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1399 
i
 = 0; i < 
Åes
; ++i) {

1400 
š‹rçû
[25];

1401 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1402 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1403 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1405 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1406 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1407  
NULL
;

1409 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1410 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1411 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1413 
	`D
("zerocopy %s",

1414 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1417 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1418 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1420 
	`¦“p
(2);

1422 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1423 
ušt64_t
 
times
=0;

1425 
i
 = 0; i < 
Åes
+2; ++i) {

1426 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1449 !
do_abÜt
) {

1450 
u_št
 
pŞlo
 = 0;

1452 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1454 
	`g‘timeofday
(&
begš
, 
NULL
);

1457 
™”
++;

1459 
i
 = 0; i < 
Åes
; ++i) {

1460 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1461 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1465 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1466 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1467 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1468 
úts
[
pŞlo
] = 
i
;

1469 ++
pŞlo
;

1471 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1472 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1473 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1475 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1476 ià(
rv
 <= 0) {

1477 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1478 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1482 
b©ch_cur
 = 0,
™emp
;

1483 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1484 
i
 = 
úts
[
™emp
];

1485 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1488 
Ãxt_cur
 = 
ršg
->
cur
;

1489 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1490 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1491 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1492 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1493 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1495 
»cvcouÁ
--) {

1496 
n
;

1497 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1498 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1499 if(
šc_bur¡
) {

1500 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1501 
	`D
("Burst increased");

1504 
b©ch_cur
 = 
£nd_b©ch
;

1508 #ifdeà
BUSY_WAIT


1509 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1510 
	`D
("ioctlƒrror on queue %d: %s", 0,

1511 
	`¡»¼Ü
(
”ºo
));

1512  
NULL
;

1515 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1516 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1517 
	`¡»¼Ü
(
”ºo
));

1518  
NULL
;

1520 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1521 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1522 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1523  
NULL
;

1526 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1527 ià(
n
 < 
b©ch_cur
)

1528 
b©ch_cur
 = 
n
;

1532 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1533 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1534 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1535 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1536 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1537 
	`__butš_´eãtch
(
Ãxt_buf
);

1539 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1540 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1541 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1546 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1549 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1555 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1556 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1562 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

1564 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1571 
tx¦Ù
->
Ën
=
rs
->len;

1575 
tx¦Ù
->
æags
 = 0;

1576 
b©ch_cur
--;

1577 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1578 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1579 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1580 
£nd_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1582 ià(
b©ch_cur
==0) {

1583 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1585 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1586 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1587 
txršg
->
h—d
 =xršg->
cur
;

1588 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1592 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1599 
	`g‘timeofday
(&
’d
, 
NULL
);

1600 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

1601 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

1602 
¿‹_t
 = (
£nd_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

1603 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

1605 
	`¦“p
(5);

1607 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1608 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1614  
NULL
;

1615 
	}
}

1618 
ušt64_t
 
	gnumbuf
=0;

1620 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1622 
»cv_th»ad_cÜe
;

1624 
time_t
 
¡¬t_t
, 
’d_t
;

1625 
¿‹_t
, 
diff_t
;

1626 
timev®
 
begš
, 
’d
;

1628 #if 
N_MINUS_2_CONFIG


1629 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1630 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1631 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1632 
»cv_th»ad_cÜe
 = 1;

1634 
»cv_th»ad_cÜe
 = 0;

1636 #–if 
N_MINUS_1_CONFIG


1637 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1638 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1640 
»cv_th»ad_cÜe
 = 0;

1643 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1644 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1646 
»cv_th»ad_cÜe
 = 0;

1650 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1651 
this_th»ad
::
	`y›ld
();

1654 
ch
;

1655 
ušt32_t
 
i
,
j
;

1656 
rv
;

1657 
veùÜ
<
pÜt_des
> 
pÜts
;

1658 
™”
 = 0;

1659 
ušt32_t
 
Åes
;

1660 
ov”æow_queue
 *
ä“q
;

1661 
pÜt_des
 *
rxpÜt
;

1662 
pÜt_des
 *
txpÜt
;

1664 
nm»q
 
ba£_»q
;

1665 
ušt32_t
 
exŒa_bufs
;

1666 
ušt32_t
 
sÿn
;

1667 
veùÜ
<
ov”æow_queue
> 
oq
;

1669 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1672 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1673 
Åes
 = 
»cv_ouut_ršgs
;

1674 
ä“q
 = 
NULL
;

1676 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1677 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1679 
	`D
("Åes:%u",
Åes
);

1681 
pÜts
.
	`»size
(
Åes
+2);

1683 
»cv_¡©s
.
	`»size
(
Åes
+1);

1685 
i
=0;i<=
Åes
;i++) {

1686 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

1693 
oq
.
	`»size
(
Åes
+1);

1694 ià(
oq
.
	`size
()!=
Åes
+1) {

1695 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1696  
NULL
;

1699 
rxpÜt
 = &
pÜts
[
Åes
];

1700 
txpÜt
 = &
pÜts
[
Åes
+1];

1704 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1705 
	`D
("failedo‡llocatehe stats‡rray");

1706  
NULL
;

1709 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1711 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1712 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1714 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1715 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1716  
NULL
;

1718 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1719 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1722 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1723 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1726 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1728 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1729 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1730 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1731 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1733 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1734 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1735  
NULL
;

1737 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1738 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1742 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1743 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1745 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1747 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1748 ià(!
exŒa_bufs
)

1749 
run
;

1751 
ä“q
 = &
oq
[
Åes
];

1752 
rxpÜt
->
oq
 = 
NULL
;

1753 
txpÜt
->
oq
 = 
ä“q
;

1755 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1761 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1762 
sÿn
;

1763 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1765 
Ãtm­_¦Ù
 
s
;

1766 
s
.
buf_idx
 = 
sÿn
;

1767 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1768 
ä“q
->
¦Ùs
.
	`push
(
s
);

1771 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1772 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1773 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1774  
NULL
;

1776 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1778 
run
:

1779 
i
 = 0; i < 
Åes
; ++i) {

1780 
š‹rçû
[25];

1781 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1782 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1783 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1785 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1786 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1787  
NULL
;

1789 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1790 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1791 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1793 
	`D
("zerocopy %s",

1794 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1796 ià(
exŒa_bufs
) {

1797 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1798 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1799 
pÜts
[
i
].
oq
 = 
q
;

1803 ià(!
exŒa_bufs
) {

1804 ià(!
oq
.
	`em±y
()) {

1805 
i
 = 0; i < 
Åes
 + 1; i++) {

1806 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1807 
oq
[
i
].
¦Ùs
.
	`pİ
();

1809 
pÜts
[
i
].
oq
 = 
NULL
;

1811 
pÜts
[
i
].
oq
 = 
NULL
;

1812 
oq
.
	`ş—r
();

1814 
	`D
("*** overflow queues disabled ***");

1817 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1818 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1820 
	`¦“p
(2);

1822 !
§ã_to_¡¬t_»cv
) {

1823 
this_th»ad
::
	`y›ld
();

1826 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1827 
ušt64_t
 
times
=0;

1829 
i
 = 0; i < 
Åes
+2; ++i) {

1830 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1853 !
do_abÜt
) {

1854 
u_št
 
pŞli
 = 0;

1856 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1858 
	`g‘timeofday
(&
begš
, 
NULL
);

1861 
™”
++;

1862 
i
 = 0; i < 
Åes
; ++i) {

1863 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1864 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1868 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1869 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1870 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1871 ++
pŞli
;

1873 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1874 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1875 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1876 ++
pŞli
;

1878 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1879 ià(
rv
 <= 0) {

1880 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1881 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1885 ià(!
oq
.
	`em±y
()) {

1889 
i
 = 0; i < 
Åes
; i++) {

1890 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1891 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1892 
ušt32_t
 
j
, 
lim
;

1893 
Ãtm­_ršg
 *
ršg
;

1894 
Ãtm­_¦Ù
 *
¦Ù
;

1896 ià(
q
->
¦Ùs
.
	`em±y
())

1898 
ršg
 = 
p
->ring;

1899 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1900 ià(!
lim
)

1902 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1903 
lim
 = 
q
->
¦Ùs
.
	`size
();

1904 
j
 = 0; j < 
lim
; j++) {

1905 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1906 
q
->
¦Ùs
.
	`pİ
();

1907 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1908 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1909 *
¦Ù
 = 
s
;

1910 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1911 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1912 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1913 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1915 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1916 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1918 
ršg
->
h—d
 =„šg->
cur
;

1923 
b©ch_cur
 = 0;

1924 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1925 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1928 
Ãxt_cur
 = 
rxršg
->
cur
;

1929 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1930 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1931 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1932 if(
ršg¥aû
 >ğ
MAX_BATCH_RECV
) {

1933 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1935 
ršg¥aû
--) {

1936 
ov”æow_queue
 *
q
;

1937 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1938 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1939 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1946 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1947 if(
ARP_ENABLED
) {

1948 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1951 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1952 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1953 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1954 
	`__butš_´eãtch
(
Ãxt_buf
);

1955 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1957 
b©ch_cur
++;

1958 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1959 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1965 
b©ch_cur
 = 0;

1974 
ušt32_t
 
ouut_pÜt
 = 0;

1975 if(
»cv_th»ad_cÜe
) {

1976 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1978 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1985 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1986 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1987 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1988 
	`__butš_´eãtch
(
Ãxt_buf
);

1992 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1993 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1994 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1997 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1998 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1999 *
cİy_buf
;

2000 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2001 
ts
->
Ën
 = 
rs
->len;

2002 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2004 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2005 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2006 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2007 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2008 
»cv_¡©s
[
Åes
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2010 
fÜw¬d
;

2014 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2015 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2016 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2017 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2018 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2020 
Ãxt
;

2023 
q
 = &
oq
[
ouut_pÜt
];

2025 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2027 
ušt32_t
 
j
;

2028 
pÜt_des
 *
Í
 = &
pÜts
[0];

2029 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2031 
j
 = 1; j < 
Åes
; j++) {

2032 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2033 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2034 
Í
 = 
ı
;

2035 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2040 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2041 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2042 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2043 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2044 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2045 
»cv_¡©s
[
Åes
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2048 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2049 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2052 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2055 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2056 
ä“q
->
¦Ùs
.
	`pİ
();

2058 *
‹mp_buf
;

2059 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2060 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2061 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2062 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2064 
fÜw¬d
:

2066 
Ãxt
:

2067 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2069 
b©ch_cur
++;

2070 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2071 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2077 
b©ch_cur
 = 0;

2088 ià(
exŒa_bufs
) {

2089 
	`ä“_bufãrs
(
pÜts
);

2098 
	`g‘timeofday
(&
’d
, 
NULL
);

2099 
diff_t
 = (
’d
.
tv_£c
 - 
begš
.tv_sec) +

2100 ((
’d
.
tv_u£c
 - 
begš
.tv_usec)/1000000.0);

2101 
¿‹_t
 = (
»cv_¡©s
[
Åes
].
fÜw¬ded
*8è/ (
diff_t
*1024*1024*1024);

2102 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

2104 
	`¦“p
(5);

2106 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2107 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2113  
NULL
;

2114 
	}
}

2117 
u_št16_t


2118 
	$w¿psum
(
u_št32_t
 
sum
)

2120 
sum
 = ~sum & 0xFFFF;

2121  (
	`htÚs
(
sum
));

2122 
	}
}

2125 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2127 
s
;

2128 
iäeq
 
bufãr
;

2129 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2131 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2132 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2134 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2136 
	`şo£
(
s
);

2137 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2138 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2139 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2140 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2141 
fd
;

2142 
iäeq
 
iä
;

2144 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2147 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2150 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2152 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2154 
	`şo£
(
fd
);

2157 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2158 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2159 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2162 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2163 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2164 
	`D
("Hurray 1");

2167 
š_addr
 
©t
;

2168 
	`š‘_©Ú
("169.254.9.3", &
©t
);

2170 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:02");

2171 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2172 
	`D
("Hurray 2");

2173 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2176 
	}
}

	@netmap_api_old.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

6 
©omic_ušt
 
	gú‰
;

7 vŞ©
	gdo_abÜt
;

16 
	#__FAVOR_BSD


	)

19 
	~<sys/ty³s.h
>

21 
	~<Ãtš‘/š.h
>

23 
	~<Ãtš‘/.h
>

25 
	~<Ãtš‘/6.h
>

30 
	~<lšux/udp.h
>

32 
	~<Ãt/‘h”Ãt.h
>

34 
	~<¡ršg.h
>

43 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

45 cÚ¡ 
ušt8_t
 
key
[] = {

57 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

58 (((
ušt32_t
)
key
[1]) << 16) |

59 (((
ušt32_t
)
key
[2]) << 8) |

60 ((
ušt32_t
)
key
[3]);

62 
ušt32_t
 
idx
 = 32;

63 
i
;

65 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

66 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

67 
ušt32_t
 
b™
;

69 
ÿche
[
i
] = 
»suÉ
;

70 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

72 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

74 
	}
}

79 
ušt32_t


80 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

82 
	#MSB32
 0x80000000

	)

83 
	#MSB16
 0x8000

	)

84 
	#KEY_CACHE_LEN
 96

	)

86 
ušt32_t
 
rc
 = 0;

87 
i
;

88 
fœ¡_time
 = 1;

89 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

91 ià(
fœ¡_time
) {

92 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

93 
fœ¡_time
 = 0;

96 
i
 = 0; i < 32; i++) {

97 ià(
s
 & 
MSB32
)

98 
rc
 ^ğ
key_ÿche
[
i
];

99 
s
 <<= 1;

101 
i
 = 0; i < 32; i++) {

102 ià(
d
 & 
MSB32
)

103 
rc
 ^ğ
key_ÿche
[32+
i
];

104 
d
 <<= 1;

106 
i
 = 0; i < 16; i++) {

107 ià(
¥
 & 
MSB16
)

108 
rc
 ^ğ
key_ÿche
[64+
i
];

109 
¥
 <<= 1;

111 
i
 = 0; i < 16; i++) {

112 ià(
dp
 & 
MSB16
)

113 
rc
 ^ğ
key_ÿche
[80+
i
];

114 
dp
 <<= 1;

117  
rc
;

118 
	}
}

123 
ušt32_t


124 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

126 
ušt32_t
 
rc
 = 0;

128 ià(
hash_¥l™
 == 2) {

129 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

130 
	`Áohl
(
h
->
_d¡
.
s_addr
),

131 
	`Áohs
(0xFFFDè+ 
£ed
,

132 
	`Áohs
(0xFFFEè+ 
£ed
);

134 
tıhdr
 *
tıh
 = 
NULL
;

135 
udphdr
 *
udph
 = 
NULL
;

137 
h
->
_p
) {

138 
IPPROTO_TCP
:

139 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

140 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

141 
	`Áohl
(
h
->
_d¡
.
s_addr
),

142 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

143 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

154 
IPPROTO_IPIP
:

156 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

157 
hash_¥l™
, 
£ed
);

173  
rc
;

174 
	}
}

179 
ušt32_t


180 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

182 
ušt32_t
 
§ddr
, 
daddr
;

183 
ušt32_t
 
rc
 = 0;

186 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

187 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

188 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

189 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

190 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

191 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

192 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

193 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

195 ià(
hash_¥l™
 == 2) {

196 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

197 
	`Áohl
(
daddr
),

198 
	`Áohs
(0xFFFDè+ 
£ed
,

199 
	`Áohs
(0xFFFEè+ 
£ed
);

201 
tıhdr
 *
tıh
 = 
NULL
;

202 
udphdr
 *
udph
 = 
NULL
;

204 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

381 
	$sigšt_h
(
sig
)

383 
i
;

385 ()
sig
;

386 
	`D
("Received control-C signal\n");

387 
Ãtm­u£
.
do_abÜt
 = 1;

388 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

389 
	}
}

391 
	gN‘m­U£
::
	$N‘m­U£
() {

392 *
‹mp
;

393 
u_št
 
i
;

394 
‹¡couÁ
=0;

396 
num_»cv
 = 1;

397 
couÁs
=
couÁr
=0;

398 
couÁr_queue1_cur
 = 
couÁr_queue1_cur_sync
 = 
couÁr_queue1
 = 
couÁr_queue2
 = 0;

399 
Ãxt_tuº_»cv
 = 0;

400 
tuº_ov”
 = 
Œue
;

401 
wa™_lšk
 = 2;

406 
	`¥rštf
(
iâame
, "netmap:%s", "eth1");

411 
	`sourû_hwaddr
(
iâame
);

415 
	`sigÇl
(
SIGINT
, 
sigšt_h
);

417 
	`š™Ÿlize_£nd_»cv
();

419 #ifdef 
OPT_FOR_SINGLE_CORE


420 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
³r_cÜe_»cv_pÜt
[0]);

423 
§ã_to_¡¬t_»cv
 = 
Œue
;

424 
	}
}

430 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

432 
buf
[128];

433 
i
, 
j
, 
i0
;

434 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

438 
	`´štf
("ring %p cur %5d [buf %6d flags 0x%04x†en %5d]\n",

439 
ršg
, 
cur
,„šg->
¦Ù
[cur].
buf_idx
,

440 
ršg
->
¦Ù
[
cur
].
æags
, 
Ën
);

442 
i
 = 0; i < 
Ën
; ) {

443 
	`mem£t
(
buf
, (buf), ' ');

444 
	`¥rštf
(
buf
, "%5d: ", 
i
);

445 
i0
 = 
i
;

446 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

447 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

448 
i
 = 
i0
;

449 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

450 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

451 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

452 
	`´štf
("%s\n", 
buf
);

454 
	}
}

456 
	gN‘m­U£
::~
	$N‘m­U£
() {

457 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

460 #iâdeà
OPT_FOR_SINGLE_CORE


461 
£nd_th»ad
.
	`još
();

462 
»cv_th»ad
.
	`još
();

464 
¡©_th»ad
.
	`još
();

467 
	`¦“p
(5);

468 
cout
<<"‹¡_couÁ:"<<
‹¡couÁ
<<
’dl
;

469 
cout
<<"Queu1 size:"<<
couÁr_queue1
<<
’dl
;

470 
cout
<<"Queu2 size:"<<
couÁr_queue2
<<
’dl
;

471 
cout
<<"Num…ckts:"<<
num_pkts
<<
’dl
;

477 
cout
<<"Com¶‘ed"<<
’dl
;

478 
	}
}

481 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

483 
nm»q
 
»q
;

484 
”r
;

486 
	`mem£t
(&
»q
, 0, (req));

487 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

488 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

489 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

490 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

491 ià(
”r
) {

492 
	`D
("Unableo get virtio-net header†ength");

496 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

497 ià(
vœt_hdr_Ën
) {

498 
	`D
("Port„equires virtio-net header,†ength = %d",

499 
vœt_hdr_Ën
);

501 
	}
}

504 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

506 
th»ad_cÜe
 = 0;

507 #iâdef 
OPT_FOR_SINGLE_CORE


509 #if 
N_MINUS_2_CONFIG


510 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

511 if(
STAT_ON_SEND_CORE
) {

512 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

513 } if(
STAT_ON_RECV_CORE
) {

514 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

516 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

518 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

519 
th»ad_cÜe
 = 1;

521 
th»ad_cÜe
 = 0;

523 #–if 
N_MINUS_1_CONFIG


524 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

525 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

526 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

528 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

531 
th»ad_cÜe
 = 0;

534 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

535 if(
STAT_ON_SEND_CORE
) {

536 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

537 } if(
STAT_ON_RECV_CORE
) {

538 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

540 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

543 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

544 
th»ad_cÜe
 = 1;

546 
th»ad_cÜe
 = 0;

552 
	`sched_g‘ıu
()!=
th»ad_cÜe
) {

553 
this_th»ad
::
	`y›ld
();

555 
	`D
("CÜ%d:",
th»ad_cÜe
);

556 
Åes
 = 
»cv_ouut_ršgs
;

557 
sys_št
 = 0;

558 
my_ùrs
 
cur
, 
´ev
;

559 
b1
[40], 
b2
[40];

560 
my_ùrs
 *
pe_´ev
;

562 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

563 ià(
pe_´ev
 =ğ
NULL
) {

564 
	`D
("out of memory");

565 
	`ex™
(1);

568 
	`mem£t
(&
´ev
, 0, (prev));

569 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

570 !
do_abÜt
) {

571 
j
, 
dosy¦og
 = 0;

572 
ušt64_t
 
µs
, 
dps
, 
u£c
;

573 
my_ùrs
 
x
;

575 
	`mem£t
(&
cur
, 0, (cur));

576 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

578 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

579 
dosy¦og
 = 1;

580 
sys_št
 = 0;

583 
j
 = 0; j < 
Åes
; ++j) {

584 
pÜt_des
 *
p
 = &
pÜts
[
j
];

586 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

587 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

589 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

590 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

591 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

592 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

593 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

594 
pe_´ev
[
j
] = 
p
->
ùr
;

596 ià(
dosy¦og
) {

597 
	`sy¦og
(
LOG_INFO
,

602 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

605 
	`´štf
("\n");

606 ià(
dosy¦og
) {

607 
	`sy¦og
(
LOG_INFO
,

613 "nÚ__·ck‘s:%lu}", 
»cv_iâame
, 
fÜw¬ded
, 
drİ³d
, 
nÚ_
);

615 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

616 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

617 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

618 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

619 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

620 
´ev
 = 
cur
;

623 
	`ä“
(
pe_´ev
);

624 
	`D
("Done");

626 
	}
}

629 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

630 
i
, 
	gtÙ
 = 0;

631 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

634 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

635 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

636 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

638 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

641 !
	gq
->
	g¦Ùs
.
em±y
()) {

642 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

643 
	gq
->
	g¦Ùs
.
pİ
();

644 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

646 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

647 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

648 
	gtÙ
++;

651 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

655 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

656 
ušt16_t
 
i
,
j
;

657 
drİ³d
 = 
fÜw¬ded
 = 
nÚ_
 = 0;

659 
£nd_ma¡”_nmd
 = 
NULL
;

660 
»cv_ma¡”_nmd
 = 
NULL
;

661 
šc_bur¡
 = 0;

662 
»cv_¦ave_¡¬t_couÁ
 = 0;

663 
§ã_to_¡¬t_»cv
 = 
çl£
;

664 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

665 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

666 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

667 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

669 #if 
N_MINUS_2_CONFIG


670 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=3) {

671 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 2;

673 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

676 #–if 
N_MINUS_1_CONFIG


677 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>=2) {

678 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) - 1;

680 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

683 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

687 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

688 
³r_cÜe_£nd_pfd
.
	`»size
(
£nd_ouut_ršgs
);

689 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

692 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

693 
³r_cÜe_»cv_pfd
.
	`»size
(
»cv_ouut_ršgs
);

694 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

695 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
,1);

696 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

703 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

704 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

705 
³r_cÜe_couÁs
[
i
] = 0;

707 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

708 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

709 
³r_cÜe_couÁr
[
i
] = 0;

712 #iâdeà
OPT_FOR_SINGLE_CORE


713 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

741 
ıu_£t_t
 
ıu_£t
;

743 
th»ad_cÜe1
, 
th»ad_cÜe2
;

745 #if 
N_MINUS_2_CONFIG


746 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

747 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

748 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

749 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

750 
th»ad_cÜe1
 = 1;

751 
th»ad_cÜe2
 = 1;

753 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

755 #–if 
N_MINUS_1_CONFIG


756 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

757 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

758 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

760 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

763 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

764 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

765 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

767 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

771 
	`CPU_ZERO
(&
ıu_£t
);

772 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

773 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

774 if(
rc
!=0) {

775 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

778 
j
 = 0; j < 
CPU_SETSIZE
; j++)

779 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

780 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

784 
	`¦“p
(2);

789 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

791 
	`CPU_ZERO
(&
ıu_£t
);

792 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

793 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

794 if(
rc
!=0) {

795 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

798 
j
 = 0; j < 
CPU_SETSIZE
; j++)

799 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

800 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

804 
	}
}

882 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

883 #iâdeà
OPT_FOR_SINGLE_CORE


884 !
£nd_ma¡”_nmd
) {

885 
this_th»ad
::
	`y›ld
();

888 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

889 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

890 
nm»q
 
ba£_»q
;

891 
š‹rçû
[25];

892 
	`mem£t
(&
ba£_»q
, 0, (base_req));

893 #ifdeà
OPT_FOR_SINGLE_CORE


894 
	`D
("İ’šg iÁ”çû‚amed %s", 
£nd_iâame
);

896 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

897 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

899 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

900 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

901  
NULL
;

903 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

904 
cÜeid
 + 1, 
£nd_iâame
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

905 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

908 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

909 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

910 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

912 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

913 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

914  
NULL
;

916 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

917 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

918 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

920 
	`D
("zerocopy %s",

921 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

927 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

931 
ušt16_t
 
n
;

932 
²
;

933 
pŞlfd
 
pfd
;

934 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

935 
pfd
.
ev’ts
 = 
POLLOUT
;

936 
pfd
.
»v’ts
 = 0;

937 #ifdeà
BUSY_WAIT


938 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

939 
	`D
("ioctlƒrror on queue %d: %s", 0,

940 
	`¡»¼Ü
(
”ºo
));

941  
NULL
;

945 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

948 if(
do_abÜt
) {

949  
NULL
;

953 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

954 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

955 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

956  
NULL
;

960 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

962 if(
£nd_b©ch_cÜe
[
cÜeid
]!=
MAX_BATCH_CORE_SEND
) {

963 if(
šc_bur¡
) {

964 
£nd_b©ch_cÜe
[
cÜeid
] = 
MAX_BATCH_CORE_SEND
;

965 
	`D
("Burst increased");

968 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

969 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

971 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

974 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

976  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

977 
	}
}

979 
	gcouÁ·ck‘ss
 = 0;

981 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

982 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

984 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

988 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

989 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

990 
¦Ù
->
æags
 = 0;

995 #ifdeà
OPT_FOR_SINGLE_CORE


996 if(
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

997 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

999 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

1001 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1004 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1005 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1007 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1010 if(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0) {

1011 
ršg
->
h—d
 =„šg->
cur
;

1012 
pŞlfd
 
pfd
;

1013 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1014 
pfd
.
ev’ts
 = 
POLLOUT
;

1015 
pfd
.
»v’ts
 = 0;

1016 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1020 
	}
}

1022 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1023 #iâdeà
OPT_FOR_SINGLE_CORE


1024 !
»cv_ma¡”_nmd
) {

1025 
this_th»ad
::
	`y›ld
();

1028 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1029 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1030 
nm»q
 
ba£_»q
;

1031 
š‹rçû
[25];

1032 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1034 #ifdeà
OPT_FOR_SINGLE_CORE


1035 
	`D
("İ’šg iÁ”çû‚amed %s", 
»cv_iâame
);

1037 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1038 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1040 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1041 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1042  
NULL
;

1044 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1045 
cÜeid
 + 1, 
»cv_iâame
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1046 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1049 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1050 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1051 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1053 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1054 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1055  
NULL
;

1057 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1058 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1059 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1061 
	`D
("zerocopy %s",

1062 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1069 
¡¬t
:

1070 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1074 
ušt16_t
 
n
;

1075 
²
;

1076 
pŞlfd
 
pfd
;

1077 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1078 
pfd
.
ev’ts
 = 
POLLIN
;

1079 
pfd
.
»v’ts
 = 0;

1080 #ifdeà
BUSY_WAIT


1081 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1082 
	`D
("ioctlƒrror on queue %d: %s", 0,

1083 
	`¡»¼Ü
(
”ºo
));

1084  
NULL
;

1088 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1091 if(
do_abÜt
) {

1092  
NULL
;

1096 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1097 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1098 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1099  
NULL
;

1103 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1110 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1111 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1113 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1115 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1117 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1119 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1120 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1123 #ifdeà
OPT_FOR_SINGLE_CORE


1124 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1125 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1127 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1128 
³r_cÜe_couÁr
[
cÜeid
]--;

1129 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1130 
ršg
->
h—d
 =„šg->
cur
;

1131 
pŞlfd
 
pfd
;

1132 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1133 
pfd
.
ev’ts
 = 
POLLIN
;

1134 
pfd
.
»v’ts
 = 0;

1135 
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
);

1138 
¡¬t
;

1142  (*)((*)
pkt
+(
‘h”_h—d”
));

1144  
NULL
;

1146 
	}
}

1148 
	gcouÁ·ck‘¤
 = 0;

1150 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1153 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1154 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
*8);

1155 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1156 
³r_cÜe_couÁr
[
cÜeid
]--;

1157 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1158 
ršg
->
h—d
 =„šg->
cur
;

1159 
pŞlfd
 
pfd
;

1160 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1161 
pfd
.
ev’ts
 = 
POLLIN
;

1162 
pfd
.
»v’ts
 = 0;

1166 
	}
}

1169 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1171 
£nd_th»ad_cÜe
;

1173 #if 
N_MINUS_2_CONFIG


1174 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1175 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1176 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1177 
£nd_th»ad_cÜe
 = 1;

1179 
£nd_th»ad_cÜe
 = 0;

1181 #–if 
N_MINUS_1_CONFIG


1182 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1183 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1185 
£nd_th»ad_cÜe
 = 0;

1188 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1189 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1191 
£nd_th»ad_cÜe
 = 0;

1195 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1196 
this_th»ad
::
	`y›ld
();

1198 
	`D
("CÜ%d:",
£nd_th»ad_cÜe
);

1199 
ch
;

1200 
ušt32_t
 
i
,
j
;

1201 
rv
;

1202 
veùÜ
<
pÜt_des
> 
pÜts
;

1203 
™”
 = 0;

1204 
ušt32_t
 
Åes
;

1205 
pÜt_des
 *
rxpÜt
;

1206 
pÜt_des
 *
txpÜt
;

1208 
nm»q
 
ba£_»q
;

1209 
ušt32_t
 
exŒa_bufs
;

1210 
ušt32_t
 
sÿn
;

1212 
u_št
 
couÁs
;

1213 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1214 
Ãtm­_ršg
 *
txršg
;

1217 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1218 
Åes
 = 
£nd_ouut_ršgs
;

1220 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1221 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1223 
	`D
("Åes:%u",
Åes
);

1225 
pÜts
.
	`»size
(
Åes
+2);

1227 
txpÜt
 = &
pÜts
[
Åes
];

1228 
rxpÜt
 = &
pÜts
[
Åes
+1];

1232 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1233 
	`D
("failedo‡llocatehe stats‡rray");

1234  
NULL
;

1237 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1239 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1240 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1242 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1243 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1244  
NULL
;

1246 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1247 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1250 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1251 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1254 
£nd_b©ch
 = 1;

1256 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1257 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1258 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1259 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1261 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1262 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1263  
NULL
;

1265 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1266 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1270 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1271 
txršg
 = 
txpÜt
->
ršg
;

1272 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1274 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1276 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1278 
i
 = 0; i < 
Åes
; ++i) {

1279 
š‹rçû
[25];

1280 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1281 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1282 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1284 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1285 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1286  
NULL
;

1288 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1289 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1290 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1292 
	`D
("zerocopy %s",

1293 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1296 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1297 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1299 
	`¦“p
(2);

1301 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1302 
ušt64_t
 
times
=0,
time
=0;

1304 
¡©_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
´št_¡©s
, 
this
, &
pÜts
[0]);

1306 
ıu_£t_t
 
ıu_£t
;

1308 
th»ad_cÜe
;

1310 #if 
N_MINUS_2_CONFIG


1311 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1312 if(
STAT_ON_SEND_CORE
) {

1313 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

1314 } if(
STAT_ON_RECV_CORE
) {

1315 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1317 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1319 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

1320 
th»ad_cÜe
 = 1;

1322 
th»ad_cÜe
 = 0;

1324 #–if 
N_MINUS_1_CONFIG


1325 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1326 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

1327 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1329 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1332 
th»ad_cÜe
 = 0;

1335 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1336 if(
STAT_ON_SEND_CORE
) {

1337 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1338 } if(
STAT_ON_RECV_CORE
) {

1339 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

1341 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

1344 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
è=ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

1345 
th»ad_cÜe
 = 1;

1347 
th»ad_cÜe
 = 0;

1352 
	`CPU_ZERO
(&
ıu_£t
);

1353 
	`CPU_SET
(
th»ad_cÜe
, &
ıu_£t
);

1354 
rc
 = 
	`±h»ad_£ffš™y_Å
(
¡©_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

1355 if(
rc
!=0) {

1356 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

1359 
j
 = 0; j < 
CPU_SETSIZE
; j++)

1360 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

1361 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

1365 !
do_abÜt
) {

1366 
u_št
 
pŞlo
 = 0;

1367 
™”
++;

1368 
i
 = 0; i < 
Åes
; ++i) {

1369 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1370 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1374 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1375 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1376 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1377 ++
pŞlo
;

1379 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1380 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1381 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1383 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1384 ià(
rv
 <= 0) {

1385 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1386 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1390 
b©ch_cur
 = 0;

1391 
i
 = 0; i < 
pŞlo
; i++) {

1392 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1395 
Ãxt_cur
 = 
ršg
->
cur
;

1396 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1397 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1398 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1399 
»cvcouÁ
--) {

1400 
n
;

1401 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1402 if(
£nd_b©ch
!=
MAX_BATCH_SEND
) {

1403 if(
šc_bur¡
) {

1404 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1405 
	`D
("Burst increased");

1408 
b©ch_cur
 = 
£nd_b©ch
;

1412 #ifdeà
BUSY_WAIT


1413 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1414 
	`D
("ioctlƒrror on queue %d: %s", 0,

1415 
	`¡»¼Ü
(
”ºo
));

1416  
NULL
;

1419 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1420 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1421 
	`¡»¼Ü
(
”ºo
));

1422  
NULL
;

1424 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1425 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfdo
.
fd
,

1426 
rxpÜt
->
nmd
->
fœ¡_tx_ršg
,„xpÜt->nmd->
Ï¡_tx_ršg
);

1427  
NULL
;

1430 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1431 ià(
n
 < 
b©ch_cur
)

1432 
b©ch_cur
 = 
n
;

1436 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1437 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1438 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1439 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1440 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1441 
	`__butš_´eãtch
(
Ãxt_buf
);

1443 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1444 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1445 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1450 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1453 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1459 if(
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
)!÷½bË.
	`’d
()) {

1460 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
], 6);

1466 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
("00:22:4d:af:ae:42"), 6);

1468 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1475 
tx¦Ù
->
Ën
=
rs
->len;

1480 
tx¦Ù
->
æags
 = 0;

1481 
b©ch_cur
--;

1482 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
*8);

1483 ià(
b©ch_cur
==0) {

1484 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1486 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1487 ià(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0) {

1488 
b©ch_cur
 = 0;

1489 
txršg
->
h—d
 =xršg->
cur
;

1490 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1494 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1499 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1500 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1502 
¡©_th»ad
.
	`još
();

1504 
	`D
("%lu…ack‘ fÜw¬ded. %lu…ack‘ drİ³d. TÙ® %luim%luime %lu\n", 
fÜw¬ded
,

1505 
drİ³d
, 
fÜw¬ded
 + drİ³d, 
time
, 
times
);

1506  
NULL
;

1507 
	}
}

1510 
ušt64_t
 
	gnumbuf
=0;

1512 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1514 
»cv_th»ad_cÜe
;

1515 #if 
N_MINUS_2_CONFIG


1516 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 2) {

1517 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1518 } if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) == 2) {

1519 
»cv_th»ad_cÜe
 = 1;

1521 
»cv_th»ad_cÜe
 = 0;

1523 #–if 
N_MINUS_1_CONFIG


1524 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1525 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1527 
»cv_th»ad_cÜe
 = 0;

1530 if(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
) > 1) {

1531 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1533 
»cv_th»ad_cÜe
 = 0;

1537 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1538 
this_th»ad
::
	`y›ld
();

1540 
	`D
("CÜ%d:",
»cv_th»ad_cÜe
);

1542 
ch
;

1543 
ušt32_t
 
i
,
j
;

1544 
rv
;

1545 
veùÜ
<
pÜt_des
> 
pÜts
;

1546 
™”
 = 0;

1547 
ušt32_t
 
Åes
;

1548 
ov”æow_queue
 *
ä“q
;

1549 
pÜt_des
 *
rxpÜt
;

1550 
pÜt_des
 *
txpÜt
;

1552 
nm»q
 
ba£_»q
;

1553 
ušt32_t
 
exŒa_bufs
;

1554 
ušt32_t
 
sÿn
;

1555 
veùÜ
<
ov”æow_queue
> 
oq
;

1557 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1560 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

1561 
Åes
 = 
»cv_ouut_ršgs
;

1562 
ä“q
 = 
NULL
;

1564 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1565 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1567 
	`D
("Åes:%u",
Åes
);

1569 
pÜts
.
	`»size
(
Åes
+2);

1574 
oq
.
	`»size
(
Åes
+1);

1575 ià(
oq
.
	`size
()!=
Åes
+1) {

1576 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1577  
NULL
;

1580 
rxpÜt
 = &
pÜts
[
Åes
];

1581 
txpÜt
 = &
pÜts
[
Åes
+1];

1585 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1586 
	`D
("failedo‡llocatehe stats‡rray");

1587  
NULL
;

1590 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1592 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1593 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1595 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1596 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1597  
NULL
;

1599 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1600 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1603 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1604 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1607 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1609 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1610 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1611 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1612 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1614 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1615 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1616  
NULL
;

1618 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1619 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1623 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1624 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1626 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1628 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1629 ià(!
exŒa_bufs
)

1630 
run
;

1632 
ä“q
 = &
oq
[
Åes
];

1633 
rxpÜt
->
oq
 = 
NULL
;

1634 
txpÜt
->
oq
 = 
ä“q
;

1636 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1642 
sÿn
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1643 
sÿn
;

1644 
sÿn
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
, scan))

1646 
Ãtm­_¦Ù
 
s
;

1647 
s
.
buf_idx
 = 
sÿn
;

1648 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1649 
ä“q
->
¦Ùs
.
	`push
(
s
);

1652 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1653 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1654 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1655  
NULL
;

1657 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1659 
run
:

1660 
i
 = 0; i < 
Åes
; ++i) {

1661 
š‹rçû
[25];

1662 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1663 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1664 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1666 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1667 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1668  
NULL
;

1670 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1671 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1672 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1674 
	`D
("zerocopy %s",

1675 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1677 ià(
exŒa_bufs
) {

1678 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1679 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1680 
pÜts
[
i
].
oq
 = 
q
;

1684 ià(!
exŒa_bufs
) {

1685 ià(!
oq
.
	`em±y
()) {

1686 
i
 = 0; i < 
Åes
 + 1; i++) {

1687 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1688 
oq
[
i
].
¦Ùs
.
	`pİ
();

1690 
pÜts
[
i
].
oq
 = 
NULL
;

1692 
pÜts
[
i
].
oq
 = 
NULL
;

1693 
oq
.
	`ş—r
();

1695 
	`D
("*** overflow queues disabled ***");

1698 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1699 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1701 
	`¦“p
(2);

1703 !
§ã_to_¡¬t_»cv
) {

1704 
this_th»ad
::
	`y›ld
();

1707 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1708 
ušt64_t
 
times
=0,
time
=0;

1771 !
do_abÜt
) {

1772 
u_št
 
pŞli
 = 0;

1773 
™”
++;

1774 
i
 = 0; i < 
Åes
; ++i) {

1775 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1776 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1780 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1781 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1782 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1783 ++
pŞli
;

1785 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1786 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1787 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1788 ++
pŞli
;

1790 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1791 ià(
rv
 <= 0) {

1792 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1793 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1797 ià(!
oq
.
	`em±y
()) {

1801 
i
 = 0; i < 
Åes
; i++) {

1802 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1803 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1804 
ušt32_t
 
j
, 
lim
;

1805 
Ãtm­_ršg
 *
ršg
;

1806 
Ãtm­_¦Ù
 *
¦Ù
;

1808 ià(
q
->
¦Ùs
.
	`em±y
())

1810 
ršg
 = 
p
->ring;

1811 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1812 ià(!
lim
)

1814 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1815 
lim
 = 
q
->
¦Ùs
.
	`size
();

1816 
j
 = 0; j < 
lim
; j++) {

1817 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1818 
q
->
¦Ùs
.
	`pİ
();

1819 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1820 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1821 *
¦Ù
 = 
s
;

1822 
p
->
ùr
.
pkts
 +ğ
s
.
Ën
*8;

1823 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1824 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1826 
ršg
->
h—d
 =„šg->
cur
;

1827 
fÜw¬ded
 +ğ
lim
;

1832 
b©ch_cur
 = 0;

1833 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1834 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1837 
Ãxt_cur
 = 
rxršg
->
cur
;

1838 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1839 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1840 !
	`nm_ršg_em±y
(
rxršg
)) {

1841 
ov”æow_queue
 *
q
;

1842 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1843 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1844 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1851 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1852 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1854 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1855 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1856 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1857 
	`__butš_´eãtch
(
Ãxt_buf
);

1858 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1860 
b©ch_cur
++;

1861 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1862 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1868 
b©ch_cur
 = 0;

1877 
ušt32_t
 
ouut_pÜt
 = 0;

1878 if(
»cv_th»ad_cÜe
) {

1879 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1881 ià(
hash
 == 0)

1882 
nÚ_
++;

1883 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1890 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1891 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1892 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1893 
	`__butš_´eãtch
(
Ãxt_buf
);

1897 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1898 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1899 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1902 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1903 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1904 *
cİy_buf
;

1905 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1906 
ts
->
Ën
 = 
rs
->len;

1907 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1909 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1910 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
*8);

1911 
fÜw¬ded
++;

1912 
fÜw¬d
;

1916 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1917 
drİ³d
++;

1918 
pÜt
->
ùr
.
drİ
+=
rs
->
Ën
*8;

1919 
Ãxt
;

1922 
q
 = &
oq
[
ouut_pÜt
];

1924 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1926 
ušt32_t
 
j
;

1927 
pÜt_des
 *
Í
 = &
pÜts
[0];

1928 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1930 
j
 = 1; j < 
Åes
; j++) {

1931 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1932 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1933 
Í
 = 
ı
;

1934 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

1939 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

1940 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

1941 
Í
->
ùr
.
drİ
 +ğ
tmp
.
Ën
*8;

1942 
Í
->
oq
->
¦Ùs
.
	`pİ
();

1943 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

1946 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

1947 
drİ³d
 +ğ
j
;

1950 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

1951 
ä“q
->
¦Ùs
.
	`pİ
();

1953 *
‹mp_buf
;

1954 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

1955 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

1956 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

1957 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

1959 
fÜw¬d
:

1961 
Ãxt
:

1962 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1964 
b©ch_cur
++;

1965 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

1966 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1972 
b©ch_cur
 = 0;

1983 ià(
exŒa_bufs
) {

1984 
	`ä“_bufãrs
(
pÜts
);

1990 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

1991 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1995 
	`D
("%lu…ack‘ fÜw¬ded. %lu…ack‘ drİ³d. TÙ® %luim%luime %lu\n", 
fÜw¬ded
,

1996 
drİ³d
, 
fÜw¬ded
 + drİ³d, 
time
, 
times
);

1997  
NULL
;

1998 
	}
}

2001 
u_št16_t


2002 
	$w¿psum
(
u_št32_t
 
sum
)

2004 
sum
 = ~sum & 0xFFFF;

2005  (
	`htÚs
(
sum
));

2006 
	}
}

2009 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2011 
s
;

2012 
iäeq
 
bufãr
;

2013 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2015 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2016 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2018 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2020 
	`şo£
(
s
);

2021 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2022 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2023 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2024 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2025 
fd
;

2026 
iäeq
 
iä
;

2028 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2031 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2034 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2036 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2038 
	`şo£
(
fd
);

2041 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2042 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2043 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2046 
¬±abË
[
¤c_
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2047 if(
¬±abË
.
	`fšd
(
¤c_
)!÷½bË.
	`’d
()) {

2048 
	`D
("Hurray 1");

2051 
š_addr
 
©t
;

2052 
	`š‘_©Ú
("169.254.9.8", &
©t
);

2054 
¬±abË
[
©t
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:03");

2055 if(
¬±abË
.
	`fšd
(
©t
)!÷½bË.
	`’d
()) {

2056 
	`D
("Hurray 2");

2057 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
]));

2060 
	}
}

	@netmap_api_original.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

441 #iâdef 
OPT_FOR_SINGLE_CORE


442 
¬±abË
.
	`£t_em±y_key
(0);

443 
¬±abË
.
	`£t_d–‘ed_key
(1);

445 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

446 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

447 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

448 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth4");

453 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

454 
	`sourû_hwaddr
(
iâame
);

455 
	`š™Ÿlize_£nd_»cv
();

457 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

458 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

460 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

461 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

464 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

465 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

468 #ifdef 
OPT_FOR_SINGLE_CORE


471 
£nd_™”
 = 
»cv_™”
 = 0;

474 
§ã_to_¡¬t_»cv
 = 
Œue
;

475 
	}
}

481 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

483 
buf
[128];

484 
i
, 
j
, 
i0
;

485 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

489 
	`´štf
("ring %p cur %5d [len %5d]\n",

490 
ršg
, 
cur
, 
Ën
);

492 
i
 = 0; i < 
Ën
; ) {

493 
	`mem£t
(
buf
, (buf), ' ');

494 
	`¥rštf
(
buf
, "%5d: ", 
i
);

495 
i0
 = 
i
;

496 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

497 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

498 
i
 = 
i0
;

499 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

500 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

501 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

502 
	`´štf
("%s\n", 
buf
);

504 
	}
}

506 
	gN‘m­U£
::~
	$N‘m­U£
() {

507 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

508 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

509 
	`g‘timeofday
(&
’d_time
, 
NULL
);

511  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

512 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

515  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

516 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

519 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

520 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

521 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

522 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

524 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

525 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

526 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

527 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

529 #iâdeà
OPT_FOR_SINGLE_CORE


530 
£nd_th»ad
.
	`još
();

531 
»cv_th»ad
.
	`još
();

537 
	`¦“p
(5);

543 
cout
<<"Com¶‘ed"<<
’dl
;

544 
	}
}

547 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

549 
nm»q
 
»q
;

550 
”r
;

552 
	`mem£t
(&
»q
, 0, (req));

553 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

554 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

555 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

556 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

557 ià(
”r
) {

558 
	`D
("Unableo get virtio-net header†ength");

562 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

563 ià(
vœt_hdr_Ën
) {

564 
	`D
("Port„equires virtio-net header,†ength = %d",

565 
vœt_hdr_Ën
);

567 
	}
}

570 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

572 #ifdef 
PRINT_STATS


573 #iâdef 
OPT_FOR_SINGLE_CORE


575 
ušt32_t
 
th»ad_cÜe
;

576 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

584 
Åes
 = 
»cv_ouut_ršgs
;

585 
sys_št
 = 0;

586 
my_ùrs
 
cur
, 
´ev
;

587 
b1
[40], 
b2
[40];

588 
my_ùrs
 *
pe_´ev
;

590 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

591 ià(
pe_´ev
 =ğ
NULL
) {

592 
	`D
("out of memory");

593 
	`ex™
(1);

596 
	`mem£t
(&
´ev
, 0, (prev));

597 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

598 !
do_abÜt
) {

599 
j
, 
dosy¦og
 = 0;

600 
ušt64_t
 
µs
, 
dps
, 
u£c
;

601 
my_ùrs
 
x
;

603 
	`mem£t
(&
cur
, 0, (cur));

604 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

606 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

607 
dosy¦og
 = 1;

608 
sys_št
 = 0;

611 
j
 = 0; j < 
Åes
; ++j) {

612 
pÜt_des
 *
p
 = &
pÜts
[
j
];

614 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

615 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

617 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

618 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

619 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

620 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

621 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

622 
pe_´ev
[
j
] = 
p
->
ùr
;

624 ià(
dosy¦og
) {

625 
	`sy¦og
(
LOG_INFO
,

630 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

633 
	`´štf
("\n");

643 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

644 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

645 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

646 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

647 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

648 
´ev
 = 
cur
;

651 
	`ä“
(
pe_´ev
);

652 
	`D
("Done");

655 
	}
}

658 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

659 
i
, 
	gtÙ
 = 0;

660 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

663 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

664 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

665 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

667 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

670 !
	gq
->
	g¦Ùs
.
em±y
()) {

671 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

672 
	gq
->
	g¦Ùs
.
pİ
();

673 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

675 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

676 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

677 
	gtÙ
++;

680 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

684 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

685 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

686 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

687 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

689 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

690 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

691 
¬p_pkt
->
ah
.
hËn
 = 6;

692 
¬p_pkt
->
ah
.
¶’
 = 4;

693 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

695 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

696 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

698 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

699 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

700 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

702 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

704 
	}
}

707 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

708 
ušt16_t
 
i
,
j
;

710 #ifdef 
PRINT_STATS


711 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

713 
£nd_ma¡”_nmd
 = 
NULL
;

714 
»cv_ma¡”_nmd
 = 
NULL
;

715 
§ã_to_¡¬t_»cv
 = 
çl£
;

716 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

717 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

718 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

719 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

721 #if 
N_MINUS_2_CONFIG


722 if(
cÜes_avaabË
>=3) {

723 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

725 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

728 #–if 
N_MINUS_1_CONFIG


729 if(
cÜes_avaabË
>=2) {

730 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

732 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

735 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

738 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

739 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

741 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

742 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

743 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

744 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

746 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

747 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

748 
³r_cÜe_couÁs
[
i
] = 0;

750 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

751 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

752 
³r_cÜe_couÁr
[
i
] = 0;

755 #ifdef 
OPT_FOR_SINGLE_CORE


757 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

758 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

759 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

761 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

763 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

764 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

765 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

766 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

772 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

774 
ıu_£t_t
 
ıu_£t
;

776 
th»ad_cÜe1
, 
th»ad_cÜe2
;

778 #if 
N_MINUS_2_CONFIG


779 if(
cÜes_avaabË
 > 2) {

780 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

781 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

782 } if(
cÜes_avaabË
 == 2) {

783 
th»ad_cÜe1
 = 1;

784 
th»ad_cÜe2
 = 1;

786 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

788 #–if 
N_MINUS_1_CONFIG


789 if(
cÜes_avaabË
 > 1) {

790 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

791 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

793 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

796 if(
cÜes_avaabË
 > 1) {

797 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

798 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

800 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

804 
	`CPU_ZERO
(&
ıu_£t
);

805 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

806 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

807 if(
rc
!=0) {

808 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

811 
j
 = 0; j < 
CPU_SETSIZE
; j++)

812 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

813 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

817 
	`¦“p
(2);

819 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

821 
	`CPU_ZERO
(&
ıu_£t
);

822 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

823 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

824 if(
rc
!=0) {

825 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

828 
j
 = 0; j < 
CPU_SETSIZE
; j++)

829 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

830 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

834 
	}
}

839 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

840 #iâdeà
OPT_FOR_SINGLE_CORE


841 !
£nd_ma¡”_nmd
) {

842 
this_th»ad
::
	`y›ld
();

845 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

846 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

847 
nm»q
 
ba£_»q
;

848 
š‹rçû
[32];

849 
	`mem£t
(&
ba£_»q
, 0, (base_req));

850 #ifdeà
OPT_FOR_SINGLE_CORE


851 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

852 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

854 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

855 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

857 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

858 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

859  
NULL
;

861 
	`D
("successfully opened core #%d %s (tx slots: %d)",

862 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

863 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

865 ià(
cÜeid
==0) {

866 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

867 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

870 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

871 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

872 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

874 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

875 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

876  
NULL
;

878 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

879 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

880 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

882 
	`D
("zerocopy %s",

883 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

887 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

891 
ušt16_t
 
n
;

892 
pŞlfd
 
pfd
;

893 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

894 
pfd
.
ev’ts
 = 
POLLOUT
;

895 
pfd
.
»v’ts
 = 0;

896 #ifdeà
BUSY_WAIT


897 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

898 
	`D
("ioctlƒrror on queue %d: %s", 0,

899 
	`¡»¼Ü
(
”ºo
));

900  
NULL
;

904 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

907 if(
do_abÜt
) {

908  
NULL
;

912 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

913 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

914 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

915  
NULL
;

918 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

919 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

920 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

922 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

926 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

927  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

928 
	}
}

931 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

932 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

933 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

934 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

935 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

938 #ifdeà
OPT_FOR_SINGLE_CORE


940 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

941 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

942 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

944 
‘h”_addr
 
‹mp_‘h_addr
;

947 ià(
	`lik–y
(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
))) {

948 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

950 
tı_pkt
 
t_p
;

951 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

952 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

954 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

958 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

961 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
));

962 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

964 ià(
‹mp__dp
 =ğ
‹mp_
) {

965 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

968 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

970 ià(
	`uÆik–y
(!
tx_buf
)) {

971 
	`D
("TXƒrror occurred");

974 
tx_buf
 -ğ(
‘h”_h—d”
);

976 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

977 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

980 
¦Ù
->
Ën
 = 
‹m¶’
;

982 
¦Ù
->
æags
 = 0;

985 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

987 --
³r_cÜe_couÁs
[
cÜeid
];

988 
¦Ù
->
æags
 |ğ
NS_REPORT
;

989 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

991 
ršg
->
h—d
 =„šg->
cur
;

992 
pŞlfd
 
pfd
;

993 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

994 
pfd
.
ev’ts
 = 
POLLOUT
;

995 
pfd
.
»v’ts
 = 0;

996 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

998 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

1001 
™_dp
++;

1003 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

1004 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1005 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1006 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1007 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1008 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

1009 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

1012 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1015 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)(
tx_buf
 + 
vœt_hdr_Ën
));

1016 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

1018 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1019 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

1020 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

1021 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

1022 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

1023 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

1025 
£nd_¬p_»q
 = 
çl£
;

1028 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1031 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

1032 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1033 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1035 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1036 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1038 
¦Ù
->
æags
 = 0;

1039 
³r_cÜe_couÁs
[
cÜeid
] = 0;

1041 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1043 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1045 
ršg
->
h—d
 =„šg->
cur
;

1046 
pŞlfd
 
pfd
;

1047 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1048 
pfd
.
ev’ts
 = 
POLLOUT
;

1049 
pfd
.
»v’ts
 = 0;

1050 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1059 #ifdef 
PRINT_STATS


1060 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1063 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1064 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1067 if(
cÜeid
 == 0) {

1068 
£nd_™”
++;

1071 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

1072 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1080 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1082 
¦Ù
->
æags
 = 0;

1085 --
³r_cÜe_couÁs
[
cÜeid
];

1086 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

1087 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1089 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1091 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

1092 
ršg
->
h—d
 =„šg->
cur
;

1093 
pŞlfd
 
pfd
;

1094 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1095 
pfd
.
ev’ts
 = 
POLLOUT
;

1096 
pfd
.
»v’ts
 = 0;

1097 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1099 
	}
}

1102 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

1103 #iâdeà
OPT_FOR_SINGLE_CORE


1104 !
»cv_ma¡”_nmd
) {

1105 
this_th»ad
::
	`y›ld
();

1108 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1109 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

1110 
nm»q
 
ba£_»q
;

1111 
š‹rçû
[32];

1112 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1114 #ifdeà
OPT_FOR_SINGLE_CORE


1115 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1116 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1118 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1119 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1121 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1122 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1123  
NULL
;

1125 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1126 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1127 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1129 ià(
cÜeid
==0) {

1130 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1131 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1134 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1135 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1136 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1138 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1139 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1140  
NULL
;

1142 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1143 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1144 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1146 
	`D
("zerocopy %s",

1147 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1151 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

1153 #ifdeà
OPT_FOR_SINGLE_CORE


1155 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

1157 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

1161 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

1164 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1165 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1166 
‘h”_addr
 
‹mp_‘h_addr
;

1168 ià(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
)) {

1169 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1172 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1174 ià(
	`uÆik–y
(!
tx_buf
)) {

1175 
	`D
("TXƒrror occurred");

1178 
tx_buf
 =x_buà- (
‘h”_h—d”
);

1180 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

1181 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1186 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1187 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1189 
¦Ù
->
Ën
 = 
‹m¶’
;

1191 
¦Ù
->
æags
 = 0;

1194 --
³r_cÜe_couÁs
[
cÜeid
];

1195 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1196 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1198 
ršg
->
h—d
 =„šg->
cur
;

1199 
pŞlfd
 
pfd
;

1200 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1201 
pfd
.
ev’ts
 = 
POLLOUT
;

1202 
pfd
.
»v’ts
 = 0;

1203 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1205 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1208 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

1209 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

1210 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

1212 
™
++;

1215 
	`g‘_bufãr_tx
(
cÜeid
);

1219 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1220 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1232 
ušt16_t
 
n
;

1233 
pŞlfd
 
pfd
;

1234 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1235 
pfd
.
ev’ts
 = 
POLLIN
;

1236 
pfd
.
»v’ts
 = 0;

1237 
ršg
->
h—d
 =„šg->
cur
;

1238 #ifdeà
BUSY_WAIT


1239 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1240 
	`D
("ioctlƒrror on queue %d: %s", 0,

1241 
	`¡»¼Ü
(
”ºo
));

1242  
NULL
;

1245 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1248 if(
do_abÜt
) {

1249  
NULL
;

1253 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1254 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1255 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1256  
NULL
;

1259 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1260 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1261 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1263 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1265 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1266  
NULL
;

1269 
¡¬t
:

1270 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1271 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1273 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1275 #ifdeà
OPT_FOR_SINGLE_CORE


1277 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1279 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1281 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1282 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1283 
‘h”_addr
 
‹mp_eh
;

1284 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1285 
ušt32_t
 
£nd_
 = 
¬µkt
->
ah
.
£nd”_
;

1286 
¬±abË
.
	`š£¹
(
£nd_
, 
‹mp_eh
);

1287 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1298 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1300 ià(
	`uÆik–y
(!
tx_buf
)) {

1301 
	`D
("TXƒrror occurred");

1304 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1305 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1311 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1312 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1314 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1316 
¦Ù
->
æags
 = 0;

1319 --
³r_cÜe_couÁs
[
cÜeid
];

1320 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1321 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1323 
ršg
->
h—d
 =„šg->
cur
;

1324 
pŞlfd
 
pfd
;

1325 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1326 
pfd
.
ev’ts
 = 
POLLOUT
;

1327 
pfd
.
»v’ts
 = 0;

1328 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1338 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1339 
³r_cÜe_couÁr
[
cÜeid
]--;

1340 
pktcouÁ
++;

1341 
¡¬t
;

1345  (*)((*)
pkt
+(
‘h”_h—d”
));

1348  
NULL
;

1350 
	}
}

1353 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1355 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1357 #ifdeà
OPT_FOR_SINGLE_CORE


1359 #ifdef 
PRINT_STATS


1360 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1362 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1363 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1366 if(
cÜeid
 == 0) {

1367 
»cv_™”
++;

1370 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1371 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1375 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1376 
³r_cÜe_couÁr
[
cÜeid
]--;

1377 
	}
}

1378 #iâdef 
OPT_FOR_SINGLE_CORE


1381 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1383 
£nd_th»ad_cÜe
;

1385 #if 
N_MINUS_2_CONFIG


1386 if(
cÜes_avaabË
 > 2) {

1387 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1388 } if(
cÜes_avaabË
 == 2) {

1389 
£nd_th»ad_cÜe
 = 1;

1391 
£nd_th»ad_cÜe
 = 0;

1393 #–if 
N_MINUS_1_CONFIG


1394 if(
cÜes_avaabË
 > 1) {

1395 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1397 
£nd_th»ad_cÜe
 = 0;

1400 if(
cÜes_avaabË
 > 1) {

1401 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1403 
£nd_th»ad_cÜe
 = 0;

1407 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1408 
this_th»ad
::
	`y›ld
();

1411 
ušt32_t
 
i
;

1412 
rv
;

1413 
veùÜ
<
pÜt_des
> 
pÜts
;

1414 
ušt64_t
 
™”
 = 0;

1415 
ušt32_t
 
Åes
;

1416 
pÜt_des
 *
rxpÜt
;

1417 
pÜt_des
 *
txpÜt
;

1419 
nm»q
 
ba£_»q
;

1420 
ušt32_t
 
exŒa_bufs
;

1421 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1422 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1423 
Ãtm­_ršg
 *
txršg
;

1425 
Åes
 = 
£nd_ouut_ršgs
;

1427 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1428 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1430 
	`D
("Åes:%u",
Åes
);

1432 
pÜts
.
	`»size
(
Åes
+2);

1434 
txpÜt
 = &
pÜts
[
Åes
];

1435 
rxpÜt
 = &
pÜts
[
Åes
+1];

1437 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1438 
	`D
("failedo‡llocatehe stats‡rray");

1439  
NULL
;

1442 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1444 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1445 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1447 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1448 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1449  
NULL
;

1451 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1452 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1455 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1456 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1457 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1459 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1460 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1461 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1462 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1464 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1465 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1466  
NULL
;

1468 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1469 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1473 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1474 
txršg
 = 
txpÜt
->
ršg
;

1475 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1477 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1479 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1481 
i
 = 0; i < 
Åes
; ++i) {

1482 
š‹rçû
[32];

1483 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1484 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1485 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1487 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1488 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1489  
NULL
;

1491 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1492 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1493 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1495 
	`D
("zerocopy %s",

1496 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1499 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1500 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1502 
	`¦“p
(2);

1504 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1506 #ifdef 
PRINT_STATS


1507 
i
 = 0; i < 
Åes
+2; ++i) {

1508 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1531 !
do_abÜt
) {

1532 
u_št
 
pŞlo
 = 0;

1534 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1535 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1538 
™”
++;

1540 
i
 = 0; i < 
Åes
; ++i) {

1541 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1542 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1546 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1547 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1548 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1549 
úts
[
pŞlo
] = 
i
;

1550 ++
pŞlo
;

1552 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1553 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1554 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1556 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1568 
‹mp_couÁ
;

1569 
boŞ
 
Ãed_æush
 = 
çl£
;

1570 
b©ch_cur
 = 0,
™emp
;

1572 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1574 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1575 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1576 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1577 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1578 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1588 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1590 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1591 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1592 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1593 
Ãed_æush
 = 
Œue
;

1596 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1603 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1604 
b©ch_cur
 = 
£nd_b©ch
;

1605 
txršg
->
h—d
 =xršg->
cur
;

1609 #ifdeà
BUSY_WAIT


1610 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1611 
	`D
("ioctlƒrror on queue %d: %s", 0,

1612 
	`¡»¼Ü
(
”ºo
));

1613  
NULL
;

1616 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1617 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1618 
	`¡»¼Ü
(
”ºo
));

1619  
NULL
;

1621 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1622 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1623 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1624  
NULL
;

1627 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1628 ià(
n
 < 
b©ch_cur
)

1629 
b©ch_cur
 = 
n
;

1632 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1633 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1634 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1636 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1639 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1640 
tx¦Ù
->
æags
 = 0;

1641 
b©ch_cur
--;

1647 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1657 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1658 
Ãed_æush
 = 
Œue
;

1659 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1661 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1664 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1665 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1666 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1668 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1669 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1672 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1673 
b©ch_cur
 = 
£nd_b©ch
;

1674 
txršg
->
h—d
 =xršg->
cur
;

1678 #ifdeà
BUSY_WAIT


1679 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1680 
	`D
("ioctlƒrror on queue %d: %s", 0,

1681 
	`¡»¼Ü
(
”ºo
));

1682  
NULL
;

1685 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1686 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1687 
	`¡»¼Ü
(
”ºo
));

1688  
NULL
;

1690 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1691 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1692 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1693  
NULL
;

1696 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1697 ià(
n
 < 
b©ch_cur
)

1698 
b©ch_cur
 = 
n
;

1701 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1702 *
tx_buf
 = (*è
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
è+ 
vœt_hdr_Ën
;

1704 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1705 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1706 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1708 
tx¦Ù
->
æags
 = 0;

1709 
b©ch_cur
--;

1711 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1713 #ifdef 
PRINT_STATS


1714 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1716 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1717 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1722 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1728 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1729 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1730 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1732 
™
++;

1736 ià(
	`uÆik–y
(
Ãed_æush
)) {

1738 
b©ch_cur
 = 0;

1739 
txršg
->
h—d
 =xršg->
cur
;

1740 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1743 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1745 
³ndšg_¬p_»q_th
.
	`ş—r
();

1750 ià(
rv
 <= 0) {

1751 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1752 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1757 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1758 
i
 = 
úts
[
™emp
];

1759 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1763 
Ãxt_cur
 = 
ršg
->
cur
;

1764 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1765 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1766 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1767 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1768 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1771 
»cvcouÁ
--) {

1773 
tİ
:

1774 
n
;

1775 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1776 
b©ch_cur
 = 
£nd_b©ch
;

1780 #ifdeà
BUSY_WAIT


1781 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1782 
	`D
("ioctlƒrror on queue %d: %s", 0,

1783 
	`¡»¼Ü
(
”ºo
));

1784  
NULL
;

1787 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1788 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1789 
	`¡»¼Ü
(
”ºo
));

1790  
NULL
;

1792 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1793 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1794 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1795  
NULL
;

1798 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1799 ià(
n
 < 
b©ch_cur
)

1800 
b©ch_cur
 = 
n
;

1803 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1804 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1805 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1806 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1807 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1808 
	`__butš_´eãtch
(
Ãxt_buf
);

1810 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1811 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1812 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1813 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1814 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1815 
pkthdr_rxpkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1819 
tx¦Ù
->
Ën
=
rs
->len;

1839 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1840 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1842 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1844 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1845 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1850 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)(
‹mpbuf
+
vœt_hdr_Ën
));

1851 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1854 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1855 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1858 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1859 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1860 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1861 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1863 
£nd_¬p_»q
 = 
çl£
;

1866 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1868 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1869 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1870 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1872 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1874 
tx¦Ù
->
æags
 = 0;

1876 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1878 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1880 
b©ch_cur
 = 0;

1881 
txršg
->
h—d
 =xršg->
cur
;

1882 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1891 
tx¦Ù
->
æags
 = 0;

1892 
b©ch_cur
--;

1893 #ifdef 
PRINT_STATS


1894 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1896 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1897 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1899 ià(
b©ch_cur
==0 || 
tx¦Ù
->
Ën
 < 256) {

1900 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1902 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1903 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1904 
b©ch_cur
 = 0;

1905 
txršg
->
h—d
 =xršg->
cur
;

1906 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1909 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1914 
	`¦“p
(5);

1915 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1916 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1919  
NULL
;

1920 
	}
}

1923 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1925 
»cv_th»ad_cÜe
;

1927 #if 
N_MINUS_2_CONFIG


1928 if(
cÜes_avaabË
 > 2) {

1929 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1930 } if(
cÜes_avaabË
 == 2) {

1931 
»cv_th»ad_cÜe
 = 1;

1933 
»cv_th»ad_cÜe
 = 0;

1935 #–if 
N_MINUS_1_CONFIG


1936 if(
cÜes_avaabË
 > 1) {

1937 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1939 
»cv_th»ad_cÜe
 = 0;

1942 if(
cÜes_avaabË
 > 1) {

1943 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1945 
»cv_th»ad_cÜe
 = 0;

1949 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1950 
this_th»ad
::
	`y›ld
();

1953 
ušt32_t
 
i
;

1954 
rv
;

1955 
veùÜ
<
pÜt_des
> 
pÜts
;

1956 
™”
 = 0;

1957 
ušt32_t
 
Åes
;

1958 
ov”æow_queue
 *
ä“q
;

1959 
pÜt_des
 *
rxpÜt
;

1960 
pÜt_des
 *
txpÜt
;

1962 
nm»q
 
ba£_»q
;

1963 
ušt32_t
 
exŒa_bufs
;

1964 
veùÜ
<
ov”æow_queue
> 
oq
;

1965 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1967 
Åes
 = 
»cv_ouut_ršgs
;

1968 
ä“q
 = 
NULL
;

1970 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1971 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1973 
	`D
("Åes:%u",
Åes
);

1975 
pÜts
.
	`»size
(
Åes
+2);

1980 
oq
.
	`»size
(
Åes
+1);

1981 ià(
oq
.
	`size
()!=
Åes
+1) {

1982 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1983  
NULL
;

1986 
rxpÜt
 = &
pÜts
[
Åes
];

1987 
txpÜt
 = &
pÜts
[
Åes
+1];

1989 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1990 
	`D
("failedo‡llocatehe stats‡rray");

1991  
NULL
;

1994 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1996 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1997 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1999 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

2000 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

2001  
NULL
;

2003 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

2004 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

2007 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

2008 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

2009 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

2011 
	`mem£t
(&
ba£_»q
, 0, (base_req));

2012 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

2013 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

2014 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

2016 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

2017 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

2018  
NULL
;

2020 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

2021 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

2025 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

2026 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

2028 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

2030 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

2031 ià(!
exŒa_bufs
)

2032 
run
;

2034 
ä“q
 = &
oq
[
Åes
];

2035 
rxpÜt
->
oq
 = 
NULL
;

2036 
txpÜt
->
oq
 = 
ä“q
;

2038 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

2044 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

2045 
rv
;

2046 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

2048 
Ãtm­_¦Ù
 
s
;

2049 
s
.
buf_idx
 = 
rv
;

2050 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

2051 
ä“q
->
¦Ùs
.
	`push
(
s
);

2053 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

2054 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

2055 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

2056  
NULL
;

2058 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

2060 
run
:

2061 
i
 = 0; i < 
Åes
; ++i) {

2062 
š‹rçû
[32];

2063 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

2064 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

2065 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

2067 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

2068 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

2069  
NULL
;

2071 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

2072 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

2073 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

2075 
	`D
("zerocopy %s",

2076 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

2078 ià(
exŒa_bufs
) {

2079 
ov”æow_queue
 *
q
 = &
oq
[
i
];

2080 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

2081 
pÜts
[
i
].
oq
 = 
q
;

2085 ià(!
exŒa_bufs
) {

2086 ià(!
oq
.
	`em±y
()) {

2087 
i
 = 0; i < 
Åes
 + 1; i++) {

2088 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

2089 
oq
[
i
].
¦Ùs
.
	`pİ
();

2091 
pÜts
[
i
].
oq
 = 
NULL
;

2093 
pÜts
[
i
].
oq
 = 
NULL
;

2094 
oq
.
	`ş—r
();

2096 
	`D
("*** overflow queues disabled ***");

2099 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

2100 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

2102 
	`¦“p
(2);

2104 !
§ã_to_¡¬t_»cv
) {

2105 
this_th»ad
::
	`y›ld
();

2108 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

2110 #ifdef 
PRINT_STATS


2111 
i
 = 0; i < 
Åes
+2; ++i) {

2112 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

2135 !
do_abÜt
) {

2136 
u_št
 
pŞli
 = 0;

2138 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

2139 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

2142 
™”
++;

2143 
i
 = 0; i < 
Åes
; ++i) {

2144 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

2145 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

2149 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

2150 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

2151 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2152 ++
pŞli
;

2154 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

2155 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

2156 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

2157 ++
pŞli
;

2159 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

2160 ià(
rv
 <= 0) {

2161 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

2162 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

2166 ià(!
oq
.
	`em±y
()) {

2170 
i
 = 0; i < 
Åes
; i++) {

2171 
pÜt_des
 *
p
 = &
pÜts
[
i
];

2172 
ov”æow_queue
 *
q
 = 
p
->
oq
;

2173 
ušt32_t
 
j
, 
lim
;

2174 
Ãtm­_ršg
 *
ršg
;

2175 
Ãtm­_¦Ù
 *
¦Ù
;

2177 ià(
q
->
¦Ùs
.
	`em±y
())

2179 
ršg
 = 
p
->ring;

2180 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

2181 ià(!
lim
)

2183 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

2184 
lim
 = 
q
->
¦Ùs
.
	`size
();

2185 
j
 = 0; j < 
lim
; j++) {

2186 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

2187 
q
->
¦Ùs
.
	`pİ
();

2188 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

2189 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

2190 *
¦Ù
 = 
s
;

2191 #ifdef 
PRINT_STATS


2192 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

2194 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2195 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

2197 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

2198 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2200 
ršg
->
h—d
 =„šg->
cur
;

2204 
b©ch_cur
 = 0;

2205 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

2206 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

2208 
Ãxt_cur
 = 
rxršg
->
cur
;

2209 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2210 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2211 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

2212 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

2213 
ršg¥aû
 = 
MAX_BATCH_RECV
;

2215 
ršg¥aû
--) {

2216 
ov”æow_queue
 *
q
;

2217 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

2218 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

2219 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

2221 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2223 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

2224 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

2226 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

2228 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

2230 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

2232 
_mac_·œ
 
‹mp_·œ
;

2233 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

2234 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

2235 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

2238 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2239 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2240 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2241 
	`__butš_´eãtch
(
Ãxt_buf
);

2242 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2244 
b©ch_cur
++;

2245 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2246 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2247 
b©ch_cur
 = 0;

2270 
ušt32_t
 
ouut_pÜt
 = 0;

2271 if(
»cv_th»ad_cÜe
) {

2272 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

2273 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

2276 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2277 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2278 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2279 
	`__butš_´eãtch
(
Ãxt_buf
);

2280 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

2281 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

2282 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

2285 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2286 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2287 *
cİy_buf
;

2288 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2289 
ts
->
Ën
 = 
rs
->len;

2290 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2292 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2294 #ifdef 
PRINT_STATS


2295 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2298 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2299 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2302 
fÜw¬d
;

2306 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2307 #ifdef 
PRINT_STATS


2308 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2310 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2311 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2313 
Ãxt
;

2316 
q
 = &
oq
[
ouut_pÜt
];

2318 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2320 
ušt32_t
 
j
;

2321 
pÜt_des
 *
Í
 = &
pÜts
[0];

2322 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2324 
j
 = 1; j < 
Åes
; j++) {

2325 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2326 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2327 
Í
 = 
ı
;

2328 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2333 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2334 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2335 #ifdef 
PRINT_STATS


2336 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2338 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2339 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2342 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2343 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2346 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2349 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2350 
ä“q
->
¦Ùs
.
	`pİ
();

2352 *
‹mp_buf
;

2353 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2354 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2355 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2356 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2358 
fÜw¬d
:

2360 
Ãxt
:

2361 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2363 
b©ch_cur
++;

2364 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2365 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2366 
b©ch_cur
 = 0;

2373 ià(
exŒa_bufs
) {

2374 
	`ä“_bufãrs
(
pÜts
);

2376 
	`¦“p
(5);

2377 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2378 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2381  
NULL
;

2382 
	}
}

2386 
u_št16_t


2387 
	$w¿psum
(
u_št32_t
 
sum
)

2389 
sum
 = ~sum & 0xFFFF;

2390  (
	`htÚs
(
sum
));

2391 
	}
}

2394 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2396 
s
;

2397 
iäeq
 
bufãr
;

2398 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2400 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2401 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2403 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2405 
	`şo£
(
s
);

2406 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2407 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2408 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2409 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2410 
fd
;

2411 
iäeq
 
iä
;

2413 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2416 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2419 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2421 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2423 
	`şo£
(
fd
);

2426 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2427 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2428 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2435 #iâdef 
OPT_FOR_SINGLE_CORE


2436 
š_addr
 
©t
;

2437 
	`š‘_©Ú
("169.254.9.28", &
©t
);

2440 if(
¬±abË
.
	`fšd
(
©t
.
s_addr
)!÷½bË.
	`’d
()) {

2441 
	`D
("Hurray 2");

2442 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
.
s_addr
]));

2446 
	}
}

	@netmap_api_parts3.cpp

2 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

3 #iâdeà
OPT_FOR_SINGLE_CORE


4 !
£nd_ma¡”_nmd
) {

5 
this_th»ad
::
	`y›ld
();

8 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

9 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

10 
nm»q
 
ba£_»q
;

11 
š‹rçû
[32];

12 
	`mem£t
(&
ba£_»q
, 0, (base_req));

13 #ifdeà
OPT_FOR_SINGLE_CORE


14 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

15 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

17 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

18 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

20 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

21 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

22  
NULL
;

24 
	`D
("successfully opened core #%d %s (tx slots: %d)",

25 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

26 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

28 ià(
cÜeid
==0) {

29 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

30 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

33 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

34 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

35 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

37 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

38 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

39  
NULL
;

41 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

42 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

43 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

45 
	`D
("zerocopy %s",

46 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

50 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

54 
ušt16_t
 
n
;

55 
pŞlfd
 
pfd
;

56 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

57 
pfd
.
ev’ts
 = 
POLLOUT
;

58 
pfd
.
»v’ts
 = 0;

59 #ifdeà
BUSY_WAIT


60 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

61 
	`D
("ioctlƒrror on queue %d: %s", 0,

62 
	`¡»¼Ü
(
”ºo
));

63  
NULL
;

67 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

70 if(
do_abÜt
) {

71  
NULL
;

75 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

76 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

77 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

78  
NULL
;

81 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

82 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

83 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

85 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

89 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

90  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

91 
	}
}

94 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

95 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

96 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

97 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

98 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

101 #ifdeà
OPT_FOR_SINGLE_CORE


103 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

104 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

105 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

107 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

110 ià(
	`lik–y
(
™
 !ğ
¬±abË
.
	`’d
())) {

111 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

113 
tı_pkt
 
t_p
;

114 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

115 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

117 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

121 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

124 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
è+ 
vœt_hdr_Ën
);

125 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

127 ià(
‹mp__dp
 =ğ
‹mp_
) {

128 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

131 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

133 ià(
	`uÆik–y
(!
tx_buf
)) {

134 
	`D
("TXƒrror occurred");

137 
tx_buf
 -ğ((
‘h”_h—d”
)+
vœt_hdr_Ën
);

139 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

140 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
);

143 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

145 
¦Ù
->
æags
 = 0;

148 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

150 --
³r_cÜe_couÁs
[
cÜeid
];

151 
¦Ù
->
æags
 |ğ
NS_REPORT
;

152 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

154 
ršg
->
h—d
 =„šg->
cur
;

155 
pŞlfd
 
pfd
;

156 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

157 
pfd
.
ev’ts
 = 
POLLOUT
;

158 
pfd
.
»v’ts
 = 0;

159 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

161 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

164 
™_dp
++;

166 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

167 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

168 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

169 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

170 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

171 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

172 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

175 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

178 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)
tx_buf
);

179 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

181 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

182 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

183 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

184 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

185 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

186 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

188 
£nd_¬p_»q
 = 
çl£
;

191 ià(
	`lik–y
(
£nd_¬p_»q
)) {

192 
­_»q
[
cÜeid
].
ah
.
rg‘_
 = 
‹mp_
;

193 
	`nm_pkt_cİy
(&
­_»q
[
cÜeid
], 
tx_buf
 + 
vœt_hdr_Ën
, (
¬p_pkt
));

194 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

196 
¦Ù
->
æags
 = 0;

197 
³r_cÜe_couÁs
[
cÜeid
] = 0;

199 
¦Ù
->
æags
 |ğ
NS_REPORT
;

201 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

203 
ršg
->
h—d
 =„šg->
cur
;

204 
pŞlfd
 
pfd
;

205 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

206 
pfd
.
ev’ts
 = 
POLLOUT
;

207 
pfd
.
»v’ts
 = 0;

208 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

217 #ifdef 
PRINT_STATS


218 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

221 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

222 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

225 if(
cÜeid
 == 0) {

226 
£nd_™”
++;

229 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

230 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

238 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

240 
¦Ù
->
æags
 = 0;

243 --
³r_cÜe_couÁs
[
cÜeid
];

244 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

245 
¦Ù
->
æags
 |ğ
NS_REPORT
;

247 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

249 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

250 
ršg
->
h—d
 =„šg->
cur
;

251 
pŞlfd
 
pfd
;

252 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

253 
pfd
.
ev’ts
 = 
POLLOUT
;

254 
pfd
.
»v’ts
 = 0;

255 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

257 
	}
}

260 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

261 #iâdeà
OPT_FOR_SINGLE_CORE


262 !
»cv_ma¡”_nmd
) {

263 
this_th»ad
::
	`y›ld
();

266 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

267 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

268 
nm»q
 
ba£_»q
;

269 
š‹rçû
[32];

270 
	`mem£t
(&
ba£_»q
, 0, (base_req));

272 #ifdeà
OPT_FOR_SINGLE_CORE


273 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

274 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

276 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

277 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

279 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

280 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

281  
NULL
;

283 
	`D
("successfully opened core #%d %s (rx slots: %d)",

284 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

285 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

287 ià(
cÜeid
==0) {

288 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

289 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

292 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

293 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

294 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

296 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

297 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

298  
NULL
;

300 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

301 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

302 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

304 
	`D
("zerocopy %s",

305 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

309 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

311 #ifdeà
OPT_FOR_SINGLE_CORE


313 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

315 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

319 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

322 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
è+ 
vœt_hdr_Ën
);

323 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

324 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

326 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

327 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

330 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

332 ià(
	`uÆik–y
(!
tx_buf
)) {

333 
	`D
("TXƒrror occurred");

336 
tx_buf
 =x_buà- (
‘h”_h—d”
è- 
vœt_hdr_Ën
;

338 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

339 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
);

344 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

345 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

347 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

349 
¦Ù
->
æags
 = 0;

352 --
³r_cÜe_couÁs
[
cÜeid
];

353 
¦Ù
->
æags
 |ğ
NS_REPORT
;

354 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

356 
ršg
->
h—d
 =„šg->
cur
;

357 
pŞlfd
 
pfd
;

358 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

359 
pfd
.
ev’ts
 = 
POLLOUT
;

360 
pfd
.
»v’ts
 = 0;

361 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

363 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

366 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

367 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

368 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

370 
™
++;

373 
	`g‘_bufãr_tx
(
cÜeid
);

377 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

378 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

390 
ušt16_t
 
n
;

391 
pŞlfd
 
pfd
;

392 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

393 
pfd
.
ev’ts
 = 
POLLIN
;

394 
pfd
.
»v’ts
 = 0;

395 
ršg
->
h—d
 =„šg->
cur
;

396 #ifdeà
BUSY_WAIT


397 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

398 
	`D
("ioctlƒrror on queue %d: %s", 0,

399 
	`¡»¼Ü
(
”ºo
));

400  
NULL
;

403 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

406 if(
do_abÜt
) {

407  
NULL
;

411 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

412 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

413 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

414  
NULL
;

417 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

418 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

419 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

421 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

423 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

424  
NULL
;

427 
¡¬t
:

428 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

429 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

431 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

433 #ifdeà
OPT_FOR_SINGLE_CORE


435 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

437 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

439 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

440 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

441 
‘h”_addr
 
‹mp_eh
;

442 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

443 
¬±abË
[
¬µkt
->
ah
.
£nd”_
] = 
‹mp_eh
;

444 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

447 
­_»s
[
cÜeid
].
ah
.
rg‘_
 = 
¬µkt
->ah.
£nd”_
;

448 
	`memıy
(
­_»s
[
cÜeid
].
ah
.
rg‘_mac
, &
‹mp_eh
, 6);

449 
	`memıy
(
­_»s
[
cÜeid
].
eh
.
‘h”_dho¡
, &
‹mp_eh
, 6);

455 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

457 ià(
	`uÆik–y
(!
tx_buf
)) {

458 
	`D
("TXƒrror occurred");

461 
	`nm_pkt_cİy
(&
­_»s
[
cÜeid
], 
tx_buf
 - (
‘h”_h—d”
), (
¬p_pkt
));

466 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

467 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

469 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

471 
¦Ù
->
æags
 = 0;

474 --
³r_cÜe_couÁs
[
cÜeid
];

475 
¦Ù
->
æags
 |ğ
NS_REPORT
;

476 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

478 
ršg
->
h—d
 =„šg->
cur
;

479 
pŞlfd
 
pfd
;

480 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

481 
pfd
.
ev’ts
 = 
POLLOUT
;

482 
pfd
.
»v’ts
 = 0;

483 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

493 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

494 
³r_cÜe_couÁr
[
cÜeid
]--;

495 
pktcouÁ
++;

496 
¡¬t
;

500  (*)((*)
pkt
+(
‘h”_h—d”
));

503  
NULL
;

505 
	}
}

508 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

510 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

512 #ifdeà
OPT_FOR_SINGLE_CORE


514 #ifdef 
PRINT_STATS


515 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

517 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

518 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

521 if(
cÜeid
 == 0) {

522 
»cv_™”
++;

525 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

526 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

530 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

531 
³r_cÜe_couÁr
[
cÜeid
]--;

532 
	}
}

	@netmap_api_tested_final_uncleaned.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

40 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

42 cÚ¡ 
ušt8_t
 
key
[] = {

54 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

55 (((
ušt32_t
)
key
[1]) << 16) |

56 (((
ušt32_t
)
key
[2]) << 8) |

57 ((
ušt32_t
)
key
[3]);

59 
ušt32_t
 
idx
 = 32;

60 
i
;

62 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

63 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

64 
ušt32_t
 
b™
;

66 
ÿche
[
i
] = 
»suÉ
;

67 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

69 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

71 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

122 
ušt32_t


123 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

125 
ušt32_t
 
rc
 = 0;

127 ià(
hash_¥l™
 == 2) {

128 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

129 
	`Áohl
(
h
->
_d¡
.
s_addr
),

130 
	`Áohs
(0xFFFDè+ 
£ed
,

131 
	`Áohs
(0xFFFEè+ 
£ed
);

133 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

144 
IPPROTO_IPIP
:

146 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

147 
hash_¥l™
, 
£ed
);

155  
rc
;

156 
	}
}

162 
ušt32_t


163 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

165 
ušt32_t
 
§ddr
, 
daddr
;

166 
ušt32_t
 
rc
 = 0;

169 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

170 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

171 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

172 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

173 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

174 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

175 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

176 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

178 ià(
hash_¥l™
 == 2) {

179 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

180 
	`Áohl
(
daddr
),

181 
	`Áohs
(0xFFFDè+ 
£ed
,

182 
	`Áohs
(0xFFFEè+ 
£ed
);

184 
tıhdr
 *
tıh
 = 
NULL
;

186 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

187 
IPPROTO_UDP
:

188 
IPPROTO_TCP
:

189 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

190 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

191 
	`Áohl
(
daddr
),

192 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

193 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

195 
IPPROTO_IPIP
:

197 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

198 
hash_¥l™
, 
£ed
);

200 
IPPROTO_IPV6
:

202 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

203 
hash_¥l™
, 
£ed
);

205 
IPPROTO_ICMP
:

206 
IPPROTO_GRE
:

207 
IPPROTO_ESP
:

208 
IPPROTO_PIM
:

209 
IPPROTO_IGMP
:

215 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

216 
	`Áohl
(
daddr
),

217 
	`Áohs
(0xFFFDè+ 
£ed
,

218 
	`Áohs
(0xFFFEè+ 
£ed
);

221  
rc
;

222 
	}
}

229 
ušt32_t


230 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

232 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

234 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

235 (
‘hh
->
‘h”_sho¡
[4] << 8) |

236 (
‘hh
->
‘h”_sho¡
[3] << 16) |

237 (
‘hh
->
‘h”_sho¡
[2] << 24);

238 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

239 (
‘hh
->
‘h”_dho¡
[4] << 8) |

240 (
‘hh
->
‘h”_dho¡
[3] << 16) |

241 (
‘hh
->
‘h”_dho¡
[2] << 24);

243 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

244 
	`Áohl
(
daddr
),

245 
	`Áohs
(0xFFFDè+ 
£ed
,

246 
	`Áohs
(0xFFFEè+ 
£ed
);

248  
rc
;

249 
	}
}

255 
šlše
 
ušt32_t


256 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

258 
ušt32_t
 
rc
 = 0;

259 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

261 
	`Áohs
(
vhdr
->
´Ùo
)) {

262 
ETHERTYPE_IP
:

263 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

264 
hash_¥l™
, 
£ed
);

266 
ETHERTYPE_IPV6
:

267 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

268 
hash_¥l™
, 
£ed
);

270 
ETHERTYPE_ARP
:

273 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

276  
rc
;

277 
	}
}

283 
ušt32_t


284 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

286 
rc
 = 0;

287 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

289 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

290 
ETHERTYPE_IP
:

291 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_IPV6
:

295 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

296 
hash_¥l™
, 
£ed
);

298 
ETHERTYPE_VLAN
:

299 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

301 
ETHERTYPE_ARP
:

304 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

308  
rc
;

309 
	}
}

313 
ušt16_t


314 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

316 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

317 
ušt32_t
 
i
;

320 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

321 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

322 ià(
sum
 > 0xFFFF)

323 
sum
 -= 0xFFFF;

330 ià(
i
 < 
Ën
) {

331 
sum
 +ğ
addr
[
i
] << 8;

332 ià(
sum
 > 0xFFFF)

333 
sum
 -= 0xFFFF;

335  
sum
;

336 
	}
}

344 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

346 
i
;

347 
a
[18];

349 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

350 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

351 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

352  (
i
 < 17 ? 
NULL
 : (*)&
a
);

353 
	}
}

356 
	gN‘m­U£
::
	$N‘m­U£
() {

358 #iâdef 
OPT_FOR_SINGLE_CORE


359 
¬±abË
.
	`£t_em±y_key
(0);

360 
¬±abË
.
	`£t_d–‘ed_key
(1);

362 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

363 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

364 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

365 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

369 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

370 
	`sourû_hwaddr
(
IFNAME
);

371 
	`š™Ÿlize_£nd_»cv
();

373 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

374 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

376 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

377 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

380 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

381 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

383 
	}
}

389 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

391 
buf
[128];

392 
i
, 
j
, 
i0
;

393 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

397 
	`´štf
("ring %p cur %5d [len %5d]\n",

398 
ršg
, 
cur
, 
Ën
);

400 
i
 = 0; i < 
Ën
; ) {

401 
	`mem£t
(
buf
, (buf), ' ');

402 
	`¥rštf
(
buf
, "%5d: ", 
i
);

403 
i0
 = 
i
;

404 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

405 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

406 
i
 = 
i0
;

407 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

408 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

409 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

410 
	`´štf
("%s\n", 
buf
);

412 
	}
}

414 
	gN‘m­U£
::~
	$N‘m­U£
() {

415 
¿‹_time
;

416 
diff_time
;

417 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

418 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

419 
	`g‘timeofday
(&
’d_time
, 
NULL
);

421  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

422 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

425  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

426 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

429 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

430 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

431 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

432 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

434 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

435 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

436 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

437 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

439 #iâdeà
OPT_FOR_SINGLE_CORE


440 
£nd_th»ad
.
	`još
();

441 
»cv_th»ad
.
	`još
();

444 
	`¦“p
(5);

447 
cout
<<"Com¶‘ed"<<
’dl
;

448 
	}
}

451 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

453 
nm»q
 
»q
;

454 
”r
;

456 
	`mem£t
(&
»q
, 0, (req));

457 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

458 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

459 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

460 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

461 ià(
”r
) {

462 
	`D
("Unableo get virtio-net header†ength");

466 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

467 ià(
vœt_hdr_Ën
) {

468 
	`D
("Port„equires virtio-net header,†ength = %d",

469 
vœt_hdr_Ën
);

471 
	}
}

474 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

475 
i
, 
	gtÙ
 = 0;

476 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

479 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

480 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

481 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

483 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

486 !
	gq
->
	g¦Ùs
.
em±y
()) {

487 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

488 
	gq
->
	g¦Ùs
.
pİ
();

489 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

491 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

492 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

493 
	gtÙ
++;

497 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

501 
	gN‘m­U£
::
	$´•¬e_¬p_·ck‘
(
¬p_pkt
 *¬p_pkt, cÚ¡ 
ušt32_t
 &
¤c_
, cÚ¡ ušt32_ˆ&
de¡_
, 
‘h”_addr
 &
¤c_mac
,ƒth”_add¸&
de¡_mac
, 
ušt16_t
 
hty³
) {

502 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_sho¡
, &
¤c_mac
, 6);

503 
	`memıy
(
¬p_pkt
->
eh
.
‘h”_dho¡
, &
de¡_mac
, 6);

504 
¬p_pkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

506 
¬p_pkt
->
ah
.
hty³
 = 
	`htÚs
 (1);

507 
¬p_pkt
->
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

508 
¬p_pkt
->
ah
.
hËn
 = 6;

509 
¬p_pkt
->
ah
.
¶’
 = 4;

510 
¬p_pkt
->
ah
.
İcode
 = 
hty³
;

512 
¬p_pkt
->
ah
.
£nd”_
 = 
¤c_
;

513 
¬p_pkt
->
ah
.
rg‘_
 = 
de¡_
;

515 
	`memıy
(
¬p_pkt
->
ah
.
£nd”_mac
, &
¤c_mac
, 6);

516 ià(
	`Áohs
(
hty³
è=ğ
ARPOP_REQUEST
) {

517 
	`mem£t
 (
¬p_pkt
->
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

519 
	`memıy
(
¬p_pkt
->
ah
.
rg‘_mac
, &
de¡_mac
, 6);

521 
	}
}

524 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

525 
ušt16_t
 
i
;

527 #iâdef 
OPT_FOR_SINGLE_CORE


528 
£nd_ma¡”_nmd
 = 
NULL
;

529 
»cv_ma¡”_nmd
 = 
NULL
;

532 #if 
N_MINUS_2_CONFIG


533 if(
cÜes_avaabË
>=3) {

534 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

536 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

539 #–if 
N_MINUS_1_CONFIG


540 if(
cÜes_avaabË
>=2) {

541 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

543 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

546 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

549 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

550 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

552 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

553 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

555 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

556 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

557 
³r_cÜe_couÁs
[
i
] = 0;

559 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

560 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

561 
³r_cÜe_couÁr
[
i
] = 0;

564 #ifdef 
OPT_FOR_SINGLE_CORE


566 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

567 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

568 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

570 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

572 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

573 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

574 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

575 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

581 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

583 
ıu_£t_t
 
ıu_£t
;

585 
th»ad_cÜe1
, 
th»ad_cÜe2
;

586 
ušt16_t
 
j
;

588 #if 
N_MINUS_2_CONFIG


589 if(
cÜes_avaabË
 > 2) {

590 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

591 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

592 } if(
cÜes_avaabË
 == 2) {

593 
th»ad_cÜe1
 = 1;

594 
th»ad_cÜe2
 = 1;

596 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

598 #–if 
N_MINUS_1_CONFIG


599 if(
cÜes_avaabË
 > 1) {

600 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

601 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

603 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

606 if(
cÜes_avaabË
 > 1) {

607 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

608 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

610 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

614 
	`CPU_ZERO
(&
ıu_£t
);

615 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

616 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

617 if(
rc
!=0) {

618 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

621 
j
 = 0; j < 
CPU_SETSIZE
; j++)

622 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

623 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

627 
	`¦“p
(2);

629 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

631 
	`CPU_ZERO
(&
ıu_£t
);

632 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

633 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

634 if(
rc
!=0) {

635 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

638 
j
 = 0; j < 
CPU_SETSIZE
; j++)

639 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

640 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

644 
	}
}

649 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

650 #iâdeà
OPT_FOR_SINGLE_CORE


651 !
£nd_ma¡”_nmd
) {

652 
this_th»ad
::
	`y›ld
();

655 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

656 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

657 
nm»q
 
ba£_»q
;

658 
š‹rçû
[32];

659 
	`mem£t
(&
ba£_»q
, 0, (base_req));

660 #ifdeà
OPT_FOR_SINGLE_CORE


661 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
IFNAME
, 
cÜeid
);

662 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

664 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

665 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

667 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

668 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

669  
NULL
;

671 
	`D
("successfully opened core #%d %s (tx slots: %d)",

672 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

673 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

675 ià(
cÜeid
==0) {

676 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

677 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

680 
	`¥rštf
(
š‹rçû
, "%s}%d", 
SEND_PIPES_IFNAME
, 
cÜeid
);

681 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

682 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

684 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

685 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

686  
NULL
;

688 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

689 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

690 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

692 
	`D
("zerocopy %s",

693 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

697 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

701 
ušt16_t
 
n
;

702 
pŞlfd
 
pfd
;

703 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

704 
pfd
.
ev’ts
 = 
POLLOUT
;

705 
pfd
.
»v’ts
 = 0;

706 #ifdeà
BUSY_WAIT


707 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

708 
	`D
("ioctlƒrror on queue %d: %s", 0,

709 
	`¡»¼Ü
(
”ºo
));

710  
NULL
;

713 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

716 if(
do_abÜt
) {

717  
NULL
;

721 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

722 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

723 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

724  
NULL
;

727 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

728 ià(
n
 <ğ
MAX_BATCH_SEND
) {

729 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

731 
³r_cÜe_couÁs
[
cÜeid
] = 
MAX_BATCH_SEND
;

735 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

736  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

737 
	}
}

740 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

741 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

742 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

743 *
tx_buf
 = 
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
);

744 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
 + 
vœt_hdr_Ën
);

747 #ifdeà
OPT_FOR_SINGLE_CORE


749 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

750 
	`memıy
(
pkthdr
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

751 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

753 
‘h”_addr
 
‹mp_‘h_addr
;

756 ià(
	`lik–y
(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
))) {

757 ià(
	`uÆik–y
(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è!ğ³ndšg_¬p_»q[cÜeid]->
	`’d
())) {

759 
tı_pkt
 
t_p
;

760 
ušt32_t
 
‹m¶’g
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
);

761 
	`nm_pkt_cİy
(
pkthdr
, &
t_p
, 
‹m¶’g
);

763 
li¡
 <
tı_pkt
>::
™”©Ü
 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

765 
™_dp
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

766 
pkthdr
* 
pkthdr_dp
 = (pkthdr*è((*)&(*
™_dp
));

767 
ušt32_t
 
‹mp__dp
 = 
pkthdr_dp
->

.
_d¡
.
s_addr
;

769 ià(
‹mp__dp
 =ğ
‹mp_
) {

770 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr_dp
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

774 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

776 ià(
	`uÆik–y
(!
tx_buf
)) {

777 
	`D
("TXƒrror occurred");

780 
tx_buf
 -ğ(
‘h”_h—d”
);

782 
	`memıy
(
pkthdr_dp
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

783 
	`nm_pkt_cİy
(&(*
™_dp
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

786 
¦Ù
->
Ën
 = 
‹m¶’
;

788 
¦Ù
->
æags
 = 0;

791 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

793 --
³r_cÜe_couÁs
[
cÜeid
];

794 
¦Ù
->
æags
 |ğ
NS_REPORT
;

795 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

797 
ršg
->
h—d
 =„šg->
cur
;

798 
pŞlfd
 
pfd
;

799 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

800 
pfd
.
ev’ts
 = 
POLLOUT
;

801 
pfd
.
»v’ts
 = 0;

802 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

804 
™_dp
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it_dp);

807 
™_dp
++;

809 
³ndšg_¬p_»q
[
cÜeid
]->
	`”a£
Õ’dšg_¬p_»q[cÜeid]->
	`fšd
(
‹mp_
));

810 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

811 
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

812 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

813 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

814 
pkthdr
 = (pkthdr*)(
tx_buf
 - ((
‘h”_h—d”
)));

815 
	`nm_pkt_cİy
(&
t_p
, 
pkthdr
, 
‹m¶’g
);

818 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

821 
deã¼ed_·ck‘s
[
cÜeid
]->
	`push_back
(*(
tı_pkt
 *)(
tx_buf
 + 
vœt_hdr_Ën
));

822 ià(
³ndšg_¬p_»q
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q[cÜeid]->
	`’d
()) {

823 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

824 
³ndšg_¬p_»q
[
cÜeid
]->
	`š£¹
(
‹mp_
);

825 ià(
³ndšg_¬p_»q_»Œ›s
[
cÜeid
]->
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s[cÜeid]->
	`’d
() || (*pending_arp_req_retries[coreid])[temp_ip] == 0) {

826 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 1;

827 } ià((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] < 16) {

828 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
]++;

830 
£nd_¬p_»q
 = 
çl£
;

833 ià(
	`lik–y
(
£nd_¬p_»q
)) {

834 
¬p_pkt
 *¬p_pkˆğ(¬p_pkˆ*è(
tx_buf
 + 
vœt_hdr_Ën
);

835 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

836 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

838 
	`´•¬e_¬p_·ck‘
(
¬p_pkt
, 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

839 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

841 
¦Ù
->
æags
 = 0;

842 
³r_cÜe_couÁs
[
cÜeid
] = 0;

844 
¦Ù
->
æags
 |ğ
NS_REPORT
;

846 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

848 
ršg
->
h—d
 =„šg->
cur
;

849 
pŞlfd
 
pfd
;

850 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

851 
pfd
.
ev’ts
 = 
POLLOUT
;

852 
pfd
.
»v’ts
 = 0;

853 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

859 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

860 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

863 if(
cÜeid
 == 0) {

864 
£nd_™”
++;

867 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

868 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

871 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

873 
¦Ù
->
æags
 = 0;

874 --
³r_cÜe_couÁs
[
cÜeid
];

875 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

876 
¦Ù
->
æags
 |ğ
NS_REPORT
;

878 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

880 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

881 
ršg
->
h—d
 =„šg->
cur
;

882 
pŞlfd
 
pfd
;

883 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

884 
pfd
.
ev’ts
 = 
POLLOUT
;

885 
pfd
.
»v’ts
 = 0;

886 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

888 
	}
}

891 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

892 #iâdeà
OPT_FOR_SINGLE_CORE


893 !
»cv_ma¡”_nmd
) {

894 
this_th»ad
::
	`y›ld
();

897 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

898 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

899 
nm»q
 
ba£_»q
;

900 
š‹rçû
[32];

901 
	`mem£t
(&
ba£_»q
, 0, (base_req));

903 #ifdeà
OPT_FOR_SINGLE_CORE


904 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
IFNAME
, 
cÜeid
);

905 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

907 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

908 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

910 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

911 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

912  
NULL
;

914 
	`D
("successfully opened core #%d %s (rx slots: %d)",

915 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

916 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

918 ià(
cÜeid
==0) {

919 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

920 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

923 
	`¥rštf
(
š‹rçû
, "%s}%d", 
RECV_PIPES_IFNAME
, 
cÜeid
);

924 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

925 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

927 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

928 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

929  
NULL
;

931 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

932 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

933 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

935 
	`D
("zerocopy %s",

936 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

940 if(
	`uÆik–y
(
pktcouÁ
 == 0)) {

942 #ifdeà
OPT_FOR_SINGLE_CORE


944 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s
[
cÜeid
]->
	`em±y
())) {

946 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`begš
();

950 
™
 !ğ
deã¼ed_·ck‘s
[
cÜeid
]->
	`’d
()) {

953 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

954 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

955 
‘h”_addr
 
‹mp_‘h_addr
;

957 ià(
¬±abË
.
	`fšd
(
‹mp_
, 
‹mp_‘h_addr
)) {

958 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

961 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

963 ià(
	`uÆik–y
(!
tx_buf
)) {

964 
	`D
("TXƒrror occurred");

967 
tx_buf
 =x_buà- (
‘h”_h—d”
);

969 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
‹mp_‘h_addr
), 6);

970 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

971 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

972 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

974 
¦Ù
->
Ën
 = 
‹m¶’
;

976 
¦Ù
->
æags
 = 0;

979 --
³r_cÜe_couÁs
[
cÜeid
];

980 
¦Ù
->
æags
 |ğ
NS_REPORT
;

981 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

983 
ršg
->
h—d
 =„šg->
cur
;

984 
pŞlfd
 
pfd
;

985 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

986 
pfd
.
ev’ts
 = 
POLLOUT
;

987 
pfd
.
»v’ts
 = 0;

988 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

990 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

993 } if(
	`uÆik–y
((*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] == 0 || (*pending_arp_req_retries[coreid])[temp_ip] == 16)) {

994 (*
³ndšg_¬p_»q_»Œ›s
[
cÜeid
])[
‹mp_
] = 0;

995 
™
 = 
deã¼ed_·ck‘s
[
cÜeid
]->
	`”a£
(it);

997 
™
++;

1000 
	`g‘_bufãr_tx
(
cÜeid
);

1002 ià(
	`uÆik–y
(!
³ndšg_¬p_»q
[
cÜeid
]->
	`em±y
())) {

1003 
³ndšg_¬p_»q
[
cÜeid
]->
	`ş—r
();

1015 
ušt16_t
 
n
;

1016 
pŞlfd
 
pfd
;

1017 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1018 
pfd
.
ev’ts
 = 
POLLIN
;

1019 
pfd
.
»v’ts
 = 0;

1020 
ršg
->
h—d
 =„šg->
cur
;

1021 #ifdeà
BUSY_WAIT


1022 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1023 
	`D
("ioctlƒrror on queue %d: %s", 0,

1024 
	`¡»¼Ü
(
”ºo
));

1025  
NULL
;

1028 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1031 if(
do_abÜt
) {

1032  
NULL
;

1036 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1037 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1038 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1039  
NULL
;

1042 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1043 ià(
n
 <ğ
MAX_BATCH_RECV
) {

1044 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1046 
³r_cÜe_couÁr
[
cÜeid
] = 
MAX_BATCH_RECV
;

1048 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1049  
NULL
;

1052 #ifdeà
OPT_FOR_SINGLE_CORE


1053 
¡¬t
:

1055 if(
	`lik–y
(
³r_cÜe_couÁr
[
cÜeid
])) {

1056 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1058 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1060 #ifdeà
OPT_FOR_SINGLE_CORE


1062 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1064 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1066 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1067 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1068 
‘h”_addr
 
‹mp_eh
;

1069 
	`memıy
(&
‹mp_eh
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1070 
ušt32_t
 
£nd_
 = 
¬µkt
->
ah
.
£nd”_
;

1071 
¬±abË
.
	`š£¹
(
£nd_
, 
‹mp_eh
);

1072 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1075 *
tx_buf
 = (*)
	`g‘_bufãr_tx
(
cÜeid
);

1077 ià(
	`uÆik–y
(!
tx_buf
)) {

1078 
	`D
("TXƒrror occurred");

1080 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1081 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 - (
‘h”_h—d”
)), 
¤c_
.
s_addr
, 
¬µkt
->
ah
.
£nd”_
, 
¤c_mac
, 
‹mp_eh
, 
	`htÚs
(
ARPOP_REPLY
));

1084 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

1085 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1087 
¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1089 
¦Ù
->
æags
 = 0;

1092 --
³r_cÜe_couÁs
[
cÜeid
];

1093 
¦Ù
->
æags
 |ğ
NS_REPORT
;

1094 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1096 
ršg
->
h—d
 =„šg->
cur
;

1097 
pŞlfd
 
pfd
;

1098 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

1099 
pfd
.
ev’ts
 = 
POLLOUT
;

1100 
pfd
.
»v’ts
 = 0;

1101 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

1108 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1109 
³r_cÜe_couÁr
[
cÜeid
]--;

1110 
pktcouÁ
++;

1111 
¡¬t
;

1115  (*)((*)
pkt
+(
‘h”_h—d”
));

1118  
NULL
;

1120 
	}
}

1123 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1125 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1127 #ifdeà
OPT_FOR_SINGLE_CORE


1128 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1129 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1132 if(
cÜeid
 == 0) {

1133 
»cv_™”
++;

1136 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1137 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1141 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1142 
³r_cÜe_couÁr
[
cÜeid
]--;

1143 
	}
}

1144 #iâdef 
OPT_FOR_SINGLE_CORE


1147 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1149 
£nd_th»ad_cÜe
;

1151 #if 
N_MINUS_2_CONFIG


1152 if(
cÜes_avaabË
 > 2) {

1153 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1154 } if(
cÜes_avaabË
 == 2) {

1155 
£nd_th»ad_cÜe
 = 1;

1157 
£nd_th»ad_cÜe
 = 0;

1159 #–if 
N_MINUS_1_CONFIG


1160 if(
cÜes_avaabË
 > 1) {

1161 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1163 
£nd_th»ad_cÜe
 = 0;

1166 if(
cÜes_avaabË
 > 1) {

1167 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1169 
£nd_th»ad_cÜe
 = 0;

1173 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1174 
this_th»ad
::
	`y›ld
();

1177 
ušt32_t
 
i
;

1178 
rv
;

1179 
veùÜ
<
pÜt_des
> 
pÜts
;

1180 
ušt64_t
 
™”
 = 0;

1181 
ušt32_t
 
Åes
;

1182 
pÜt_des
 *
rxpÜt
;

1183 
pÜt_des
 *
txpÜt
;

1185 
nm»q
 
ba£_»q
;

1186 
ušt32_t
 
exŒa_bufs
;

1187 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1188 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1189 
Ãtm­_ršg
 *
txršg
;

1190 
£nd_iâame
[
MAX_IFNAMELEN
];

1192 
	`¥rštf
(
£nd_iâame
, "%s/T", 
IFNAME
);

1194 
Åes
 = 
£nd_ouut_ršgs
;

1196 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1197 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1199 
	`D
("Åes:%u",
Åes
);

1201 
pÜts
.
	`»size
(
Åes
+2);

1203 
txpÜt
 = &
pÜts
[
Åes
];

1204 
rxpÜt
 = &
pÜts
[
Åes
+1];

1206 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1207 
	`D
("failedo‡llocatehe stats‡rray");

1208  
NULL
;

1211 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1213 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1214 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1216 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1217 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1218  
NULL
;

1220 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1221 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1224 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1226 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1227 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
SEND_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1229 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1230 
	`D
("ÿÂÙ o³À%s", 
SEND_PIPES_IFNAME
);

1231  
NULL
;

1233 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
SEND_PIPES_IFNAME
,

1234 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1238 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1239 
txršg
 = 
txpÜt
->
ršg
;

1240 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1242 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1244 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1246 
i
 = 0; i < 
Åes
; ++i) {

1247 
š‹rçû
[32];

1248 
	`¥rštf
(
š‹rçû
, "%s{%d", 
SEND_PIPES_IFNAME
, 
i
);

1249 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1250 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1252 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1253 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1254  
NULL
;

1256 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1257 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1258 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1260 
	`D
("zerocopy %s",

1261 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1264 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1266 
	`¦“p
(2);

1268 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1270 !
do_abÜt
) {

1271 
u_št
 
pŞlo
 = 0;

1273 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1274 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1277 
™”
++;

1279 
i
 = 0; i < 
Åes
; ++i) {

1280 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1281 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1285 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1286 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1287 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1288 
úts
[
pŞlo
] = 
i
;

1289 ++
pŞlo
;

1291 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1292 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1293 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1295 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1305 
‹mp_couÁ
;

1306 
boŞ
 
Ãed_æush
 = 
çl£
;

1307 
u_št
 
b©ch_cur
 = 0,
™emp
;

1309 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1311 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1312 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1313 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1314 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1315 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1320 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1322 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1323 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1324 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1325 
Ãed_æush
 = 
Œue
;

1328 
ušt32_t
 
i
 = 0; ()˜< 
‹mp_couÁ
; i++) {

1332 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1333 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1334 
txršg
->
h—d
 =xršg->
cur
;

1338 #ifdeà
BUSY_WAIT


1339 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1340 
	`D
("ioctlƒrror on queue %d: %s", 0,

1341 
	`¡»¼Ü
(
”ºo
));

1342  
NULL
;

1345 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1346 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1347 
	`¡»¼Ü
(
”ºo
));

1348  
NULL
;

1350 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1351 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1352 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1353  
NULL
;

1356 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1357 ià(
n
 < 
b©ch_cur
)

1358 
b©ch_cur
 = 
n
;

1361 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1362 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1363 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1365 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
’queued_¬p_»qs
[
i
], 
¤c_mac
, 
¬±abË
[’queued_¬p_»qs[i]], 
	`htÚs
(
ARPOP_REPLY
));

1367 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1368 
tx¦Ù
->
æags
 = 0;

1369 
b©ch_cur
--;

1371 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1376 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1377 
Ãed_æush
 = 
Œue
;

1378 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1380 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1381 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
));

1382 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1383 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1385 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1386 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1389 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1390 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1391 
txršg
->
h—d
 =xršg->
cur
;

1395 #ifdeà
BUSY_WAIT


1396 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1397 
	`D
("ioctlƒrror on queue %d: %s", 0,

1398 
	`¡»¼Ü
(
”ºo
));

1399  
NULL
;

1402 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1403 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1404 
	`¡»¼Ü
(
”ºo
));

1405  
NULL
;

1407 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1408 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1409 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1410  
NULL
;

1413 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1414 ià(
n
 < 
b©ch_cur
)

1415 
b©ch_cur
 = 
n
;

1418 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1419 *
tx_buf
 = (*è
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
è+ 
vœt_hdr_Ën
;

1421 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1422 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
 - 
vœt_hdr_Ën
);

1423 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1425 
tx¦Ù
->
æags
 = 0;

1426 
b©ch_cur
--;

1428 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1430 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1431 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1433 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1435 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1436 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1437 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1439 
™
++;

1443 ià(
	`uÆik–y
(
Ãed_æush
)) {

1445 
b©ch_cur
 = 0;

1446 
txršg
->
h—d
 =xršg->
cur
;

1447 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1450 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1452 
³ndšg_¬p_»q_th
.
	`ş—r
();

1457 ià(
rv
 <= 0) {

1458 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1459 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1463 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1464 
i
 = 
úts
[
™emp
];

1465 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1469 
Ãxt_cur
 = 
ršg
->
cur
;

1470 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1471 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1472 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1473 if(
»cvcouÁ
>=
MAX_BATCH_RECV
) {

1474 
»cvcouÁ
 = 
MAX_BATCH_RECV
;

1477 
»cvcouÁ
--) {

1479 
u_št
 
n
;

1480 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1481 
b©ch_cur
 = 
MAX_BATCH_SEND
;

1485 #ifdeà
BUSY_WAIT


1486 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1487 
	`D
("ioctlƒrror on queue %d: %s", 0,

1488 
	`¡»¼Ü
(
”ºo
));

1489  
NULL
;

1492 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1493 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1494 
	`¡»¼Ü
(
”ºo
));

1495  
NULL
;

1497 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1498 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1499 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1500  
NULL
;

1503 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1504 ià(
n
 < 
b©ch_cur
)

1505 
b©ch_cur
 = 
n
;

1508 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1509 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1510 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1511 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1512 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1513 
	`__butš_´eãtch
(
Ãxt_buf
);

1515 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1516 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1517 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1518 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1519 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1520 
pkthdr_rxpkt
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1524 
tx¦Ù
->
Ën
=
rs
->len;

1536 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1537 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1538 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1540 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1541 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1544 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)(
‹mpbuf
+
vœt_hdr_Ën
));

1545 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1547 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1548 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1551 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1552 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1553 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1554 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1556 
£nd_¬p_»q
 = 
çl£
;

1559 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1560 
‘h”_addr
 
¤c_mac
 = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

1561 
‘h”_addr
 
de¡_mac
 = *
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff");

1562 
	`´•¬e_¬p_·ck‘
((
¬p_pkt
*)(
tx_buf
 + 
vœt_hdr_Ën
), 
¤c_
.
s_addr
, 
‹mp_
, 
¤c_mac
, 
de¡_mac
, 
	`htÚs
(
ARPOP_REQUEST
));

1563 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1565 
tx¦Ù
->
æags
 = 0;

1567 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1569 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1571 
b©ch_cur
 = 0;

1572 
txršg
->
h—d
 =xršg->
cur
;

1573 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1580 
tx¦Ù
->
æags
 = 0;

1581 
b©ch_cur
--;

1583 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1584 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1586 ià(
b©ch_cur
==0 || 
tx¦Ù
->
Ën
 < 256) {

1587 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1589 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1590 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1591 
b©ch_cur
 = 0;

1592 
txršg
->
h—d
 =xršg->
cur
;

1593 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1596 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1601 
	`¦“p
(5);

1602 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1603 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1605  
NULL
;

1606 
	}
}

1609 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1611 
»cv_th»ad_cÜe
;

1613 #if 
N_MINUS_2_CONFIG


1614 if(
cÜes_avaabË
 > 2) {

1615 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1616 } if(
cÜes_avaabË
 == 2) {

1617 
»cv_th»ad_cÜe
 = 1;

1619 
»cv_th»ad_cÜe
 = 0;

1621 #–if 
N_MINUS_1_CONFIG


1622 if(
cÜes_avaabË
 > 1) {

1623 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1625 
»cv_th»ad_cÜe
 = 0;

1628 if(
cÜes_avaabË
 > 1) {

1629 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1631 
»cv_th»ad_cÜe
 = 0;

1635 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1636 
this_th»ad
::
	`y›ld
();

1639 
ušt32_t
 
i
;

1640 
rv
;

1641 
veùÜ
<
pÜt_des
> 
pÜts
;

1642 
™”
 = 0;

1643 
ušt32_t
 
Åes
;

1644 
ov”æow_queue
 *
ä“q
;

1645 
pÜt_des
 *
rxpÜt
;

1646 
pÜt_des
 *
txpÜt
;

1648 
nm»q
 
ba£_»q
;

1649 
ušt32_t
 
exŒa_bufs
;

1650 
veùÜ
<
ov”æow_queue
> 
oq
;

1651 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1652 
»cv_iâame
[
MAX_IFNAMELEN
];

1654 
	`¥rštf
(
»cv_iâame
, "%s/R", 
IFNAME
);

1656 
Åes
 = 
»cv_ouut_ršgs
;

1657 
ä“q
 = 
NULL
;

1659 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1660 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1662 
	`D
("Åes:%u",
Åes
);

1664 
pÜts
.
	`»size
(
Åes
+2);

1669 
oq
.
	`»size
(
Åes
+1);

1670 ià(
oq
.
	`size
()!=
Åes
+1) {

1671 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1672  
NULL
;

1675 
rxpÜt
 = &
pÜts
[
Åes
];

1676 
txpÜt
 = &
pÜts
[
Åes
+1];

1678 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1679 
	`D
("failedo‡llocatehe stats‡rray");

1680  
NULL
;

1683 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1685 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1686 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1688 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1689 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1690  
NULL
;

1692 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1693 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1696 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1697 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1699 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1700 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1701 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1702 
txpÜt
->
nmd
 = 
	`nm_İ’
(
RECV_PIPES_IFNAME
, &
ba£_»q
, 0, 
NULL
);

1704 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1705 
	`D
("ÿÂÙ o³À%s", 
RECV_PIPES_IFNAME
);

1706  
NULL
;

1708 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
RECV_PIPES_IFNAME
,

1709 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1713 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1714 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1716 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1718 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1719 ià(!
exŒa_bufs
)

1720 
run
;

1722 
ä“q
 = &
oq
[
Åes
];

1723 
rxpÜt
->
oq
 = 
NULL
;

1724 
txpÜt
->
oq
 = 
ä“q
;

1726 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1732 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1733 
rv
;

1734 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1736 
Ãtm­_¦Ù
 
s
;

1737 
s
.
buf_idx
 = 
rv
;

1738 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1739 
ä“q
->
¦Ùs
.
	`push
(
s
);

1741 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1742 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1743 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1744  
NULL
;

1746 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1748 
run
:

1749 
i
 = 0; i < 
Åes
; ++i) {

1750 
š‹rçû
[32];

1751 
	`¥rštf
(
š‹rçû
, "%s{%d", 
RECV_PIPES_IFNAME
, 
i
);

1752 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1753 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1755 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1756 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1757  
NULL
;

1759 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1760 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1761 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1763 
	`D
("zerocopy %s",

1764 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1766 ià(
exŒa_bufs
) {

1767 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1768 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1769 
pÜts
[
i
].
oq
 = 
q
;

1773 ià(!
exŒa_bufs
) {

1774 ià(!
oq
.
	`em±y
()) {

1775 
i
 = 0; i < 
Åes
 + 1; i++) {

1776 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1777 
oq
[
i
].
¦Ùs
.
	`pİ
();

1779 
pÜts
[
i
].
oq
 = 
NULL
;

1781 
pÜts
[
i
].
oq
 = 
NULL
;

1782 
oq
.
	`ş—r
();

1784 
	`D
("*** overflow queues disabled ***");

1787 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1788 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1790 
	`¦“p
(2);

1792 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1794 !
do_abÜt
) {

1795 
u_št
 
pŞli
 = 0;

1797 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1798 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1801 
™”
++;

1802 
i
 = 0; i < 
Åes
; ++i) {

1803 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1804 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1808 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1809 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1810 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1811 ++
pŞli
;

1813 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1814 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1815 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1816 ++
pŞli
;

1818 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1819 ià(
rv
 <= 0) {

1820 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1821 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1825 ià(!
oq
.
	`em±y
()) {

1829 
i
 = 0; i < 
Åes
; i++) {

1830 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1831 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1832 
ušt32_t
 
j
, 
lim
;

1833 
Ãtm­_ršg
 *
ršg
;

1834 
Ãtm­_¦Ù
 *
¦Ù
;

1836 ià(
q
->
¦Ùs
.
	`em±y
())

1838 
ršg
 = 
p
->ring;

1839 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1840 ià(!
lim
)

1842 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1843 
lim
 = 
q
->
¦Ùs
.
	`size
();

1844 
j
 = 0; j < 
lim
; j++) {

1845 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1846 
q
->
¦Ùs
.
	`pİ
();

1847 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1848 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1849 *
¦Ù
 = 
s
;

1851 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1852 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1855 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1856 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1858 
ršg
->
h—d
 =„šg->
cur
;

1862 
b©ch_cur
 = 0;

1863 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1864 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1866 
Ãxt_cur
 = 
rxršg
->
cur
;

1867 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1868 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1869 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1870 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1871 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1873 
ršg¥aû
--) {

1874 
ov”æow_queue
 *
q
;

1875 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1876 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1877 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1879 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1881 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1882 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1884 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1885 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1887 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

1889 
_mac_·œ
 
‹mp_·œ
;

1890 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

1891 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1892 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

1895 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1896 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1897 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1898 
	`__butš_´eãtch
(
Ãxt_buf
);

1899 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1901 
b©ch_cur
++;

1902 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

1903 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1904 
b©ch_cur
 = 0;

1910 
ušt32_t
 
ouut_pÜt
 = 0;

1911 if(
»cv_th»ad_cÜe
) {

1912 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

1913 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

1916 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

1917 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1918 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1919 
	`__butš_´eãtch
(
Ãxt_buf
);

1920 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

1921 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

1922 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

1925 ià(
	`nm_ršg_¥aû
(
ršg
)) {

1926 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

1927 *
cİy_buf
;

1928 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

1929 
ts
->
Ën
 = 
rs
->len;

1930 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

1932 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1934 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1935 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

1938 
fÜw¬d
;

1942 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

1943 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1944 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

1946 
Ãxt
;

1949 
q
 = &
oq
[
ouut_pÜt
];

1951 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

1953 
ušt32_t
 
j
;

1954 
pÜt_des
 *
Í
 = &
pÜts
[0];

1955 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

1957 
j
 = 1; j < 
Åes
; j++) {

1958 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

1959 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

1960 
Í
 = 
ı
;

1961 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

1966 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

1967 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

1968 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1969 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

1972 
Í
->
oq
->
¦Ùs
.
	`pİ
();

1973 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

1976 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

1979 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

1980 
ä“q
->
¦Ùs
.
	`pİ
();

1982 *
‹mp_buf
;

1983 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

1984 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

1985 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

1986 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

1988 
fÜw¬d
:

1990 
Ãxt
:

1991 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

1993 
b©ch_cur
++;

1994 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
MAX_BATCH_RECV
)) {

1995 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

1996 
b©ch_cur
 = 0;

2003 ià(
exŒa_bufs
) {

2004 
	`ä“_bufãrs
(
pÜts
);

2006 
	`¦“p
(5);

2007 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2008 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2010  
NULL
;

2011 
	}
}

2015 
u_št16_t


2016 
	$w¿psum
(
u_št32_t
 
sum
)

2018 
sum
 = ~sum & 0xFFFF;

2019  (
	`htÚs
(
sum
));

2020 
	}
}

2023 
	gN‘m­U£
::
	$sourû_hwaddr
(cÚ¡ *
iâame
)

2025 
s
;

2026 
¤c__addr
[20];

2027 
iäeq
 
bufãr
;

2028 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2030 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2031 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2033 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2035 
	`şo£
(
s
);

2036 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2037 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2038 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2039 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2040 
fd
;

2041 
iäeq
 
iä
;

2043 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2046 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2049 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2051 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2053 
	`şo£
(
fd
);

2056 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2057 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2058 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2068 #iâdef 
OPT_FOR_SINGLE_CORE


2077 
	}
}

	@netmap_api_working_without_1core.cpp

1 
	~"Ãtm­_­i.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

5 
N‘m­U£
 
	gÃtm­u£
;

14 
	#__FAVOR_BSD


	)

17 
	~<sys/ty³s.h
>

19 
	~<Ãtš‘/š.h
>

21 
	~<Ãtš‘/.h
>

23 
	~<Ãtš‘/6.h
>

28 
	~<lšux/udp.h
>

30 
	~<Ãt/‘h”Ãt.h
>

32 
	~<¡ršg.h
>

41 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

43 cÚ¡ 
ušt8_t
 
key
[] = {

55 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

56 (((
ušt32_t
)
key
[1]) << 16) |

57 (((
ušt32_t
)
key
[2]) << 8) |

58 ((
ušt32_t
)
key
[3]);

60 
ušt32_t
 
idx
 = 32;

61 
i
;

63 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

64 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

65 
ušt32_t
 
b™
;

67 
ÿche
[
i
] = 
»suÉ
;

68 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

70 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

72 
	}
}

77 
ušt32_t


78 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

80 
	#MSB32
 0x80000000

	)

81 
	#MSB16
 0x8000

	)

82 
	#KEY_CACHE_LEN
 96

	)

84 
ušt32_t
 
rc
 = 0;

85 
i
;

86 
fœ¡_time
 = 1;

87 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

89 ià(
fœ¡_time
) {

90 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

91 
fœ¡_time
 = 0;

94 
i
 = 0; i < 32; i++) {

95 ià(
s
 & 
MSB32
)

96 
rc
 ^ğ
key_ÿche
[
i
];

97 
s
 <<= 1;

99 
i
 = 0; i < 32; i++) {

100 ià(
d
 & 
MSB32
)

101 
rc
 ^ğ
key_ÿche
[32+
i
];

102 
d
 <<= 1;

104 
i
 = 0; i < 16; i++) {

105 ià(
¥
 & 
MSB16
)

106 
rc
 ^ğ
key_ÿche
[64+
i
];

107 
¥
 <<= 1;

109 
i
 = 0; i < 16; i++) {

110 ià(
dp
 & 
MSB16
)

111 
rc
 ^ğ
key_ÿche
[80+
i
];

112 
dp
 <<= 1;

115  
rc
;

116 
	}
}

121 
ušt32_t


122 
	$decode__n_hash
(

 *
h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

124 
ušt32_t
 
rc
 = 0;

126 ià(
hash_¥l™
 == 2) {

127 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

128 
	`Áohl
(
h
->
_d¡
.
s_addr
),

129 
	`Áohs
(0xFFFDè+ 
£ed
,

130 
	`Áohs
(0xFFFEè+ 
£ed
);

132 
tıhdr
 *
tıh
 = 
NULL
;

135 
h
->
_p
) {

136 
IPPROTO_UDP
:

137 
IPPROTO_TCP
:

138 
tıh
 = (
tıhdr
 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2));

139 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
h
->
_¤c
.
s_addr
),

140 
	`Áohl
(
h
->
_d¡
.
s_addr
),

141 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

142 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

153 
IPPROTO_IPIP
:

155 
rc
 = 
	`decode__n_hash
((

 *)((
ušt8_t
 *)
h
 + (h->
_hl
<<2)),

156 
hash_¥l™
, 
£ed
);

172  
rc
;

173 
	}
}

178 
ušt32_t


179 
	$decode_v6_n_hash
(
6_hdr
 *
v6h
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

181 
ušt32_t
 
§ddr
, 
daddr
;

182 
ušt32_t
 
rc
 = 0;

185 
§ddr
 = 
v6h
->
6_¤c
.
s6_addr
[0] |

186 (
v6h
->
6_¤c
.
s6_addr
[1] << 8) |

187 (
v6h
->
6_¤c
.
s6_addr
[2] << 16) |

188 (
v6h
->
6_¤c
.
s6_addr
[3] << 24);

189 
daddr
 = 
v6h
->
6_d¡
.
s6_addr
[0] |

190 (
v6h
->
6_d¡
.
s6_addr
[1] << 8) |

191 (
v6h
->
6_d¡
.
s6_addr
[2] << 16) |

192 (
v6h
->
6_d¡
.
s6_addr
[3] << 24);

194 ià(
hash_¥l™
 == 2) {

195 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

196 
	`Áohl
(
daddr
),

197 
	`Áohs
(0xFFFDè+ 
£ed
,

198 
	`Áohs
(0xFFFEè+ 
£ed
);

200 
tıhdr
 *
tıh
 = 
NULL
;

203 
	`Áohs
(
v6h
->
6_ùlun
.
6_un1
.
6_un1_nxt
)) {

204 
IPPROTO_UDP
:

205 
IPPROTO_TCP
:

206 
tıh
 = (
tıhdr
 *)(
v6h
 + 1);

207 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

208 
	`Áohl
(
daddr
),

209 
	`Áohs
(
tıh
->
sourû
è+ 
£ed
,

210 
	`Áohs
(
tıh
->
de¡
è+ 
£ed
);

221 
IPPROTO_IPIP
:

223 
rc
 = 
	`decode__n_hash
((

 *)(
v6h
 + 1),

224 
hash_¥l™
, 
£ed
);

226 
IPPROTO_IPV6
:

228 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
v6h
 + 1),

229 
hash_¥l™
, 
£ed
);

231 
IPPROTO_ICMP
:

232 
IPPROTO_GRE
:

233 
IPPROTO_ESP
:

234 
IPPROTO_PIM
:

235 
IPPROTO_IGMP
:

241 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

242 
	`Áohl
(
daddr
),

243 
	`Áohs
(0xFFFDè+ 
£ed
,

244 
	`Áohs
(0xFFFEè+ 
£ed
);

247  
rc
;

248 
	}
}

254 
ušt32_t


255 
	$decode_Ùh”s_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
£ed
)

257 
ušt32_t
 
§ddr
, 
daddr
, 
rc
;

259 
§ddr
 = 
‘hh
->
‘h”_sho¡
[5] |

260 (
‘hh
->
‘h”_sho¡
[4] << 8) |

261 (
‘hh
->
‘h”_sho¡
[3] << 16) |

262 (
‘hh
->
‘h”_sho¡
[2] << 24);

263 
daddr
 = 
‘hh
->
‘h”_dho¡
[5] |

264 (
‘hh
->
‘h”_dho¡
[4] << 8) |

265 (
‘hh
->
‘h”_dho¡
[3] << 16) |

266 (
‘hh
->
‘h”_dho¡
[2] << 24);

268 
rc
 = 
	`sym_hash_â
(
	`Áohl
(
§ddr
),

269 
	`Áohl
(
daddr
),

270 
	`Áohs
(0xFFFDè+ 
£ed
,

271 
	`Áohs
(0xFFFEè+ 
£ed
);

273  
rc
;

274 
	}
}

279 
šlše
 
ušt32_t


280 
	$decode_vÏn_n_hash
(
‘h”_h—d”
 *
‘hh
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

282 
ušt32_t
 
rc
 = 0;

283 
vÏnhdr
 *
vhdr
 = (vÏnhd¸*)(
‘hh
 + 1);

285 
	`Áohs
(
vhdr
->
´Ùo
)) {

286 
ETHERTYPE_IP
:

287 
rc
 = 
	`decode__n_hash
((

 *)(
vhdr
 + 1),

288 
hash_¥l™
, 
£ed
);

290 
ETHERTYPE_IPV6
:

291 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
vhdr
 + 1),

292 
hash_¥l™
, 
£ed
);

294 
ETHERTYPE_ARP
:

297 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

300  
rc
;

301 
	}
}

306 
ušt32_t


307 
	$pkt_hdr_hash
(cÚ¡ *
bufãr
, 
ušt8_t
 
hash_¥l™
, ušt8_ˆ
£ed
)

309 
rc
 = 0;

310 
‘h”_h—d”
 *
‘hh
 = (‘h”_h—d” *)
bufãr
;

312 
	`Áohs
(
‘hh
->
‘h”_ty³
)) {

313 
ETHERTYPE_IP
:

314 
rc
 = 
	`decode__n_hash
((

 *)(
‘hh
 + 1),

315 
hash_¥l™
, 
£ed
);

317 
ETHERTYPE_IPV6
:

318 
rc
 = 
	`decode_v6_n_hash
((
6_hdr
 *)(
‘hh
 + 1),

319 
hash_¥l™
, 
£ed
);

321 
ETHERTYPE_VLAN
:

322 
rc
 = 
	`decode_vÏn_n_hash
(
‘hh
, 
hash_¥l™
, 
£ed
);

324 
ETHERTYPE_ARP
:

327 
rc
 = 
	`decode_Ùh”s_n_hash
(
‘hh
, 
£ed
);

331  
rc
;

332 
	}
}

339 
ušt16_t


340 
	$checksum
(cÚ¡ *
d©a
, 
ušt16_t
 
Ën
, 
ušt32_t
 
sum
)

342 cÚ¡ 
ušt8_t
 *
addr
 = (ušt8_ˆ*)
d©a
;

343 
ušt32_t
 
i
;

346 
i
 = 0; i < (
Ën
 & ~1U); i += 2) {

347 
sum
 +ğ(
u_št16_t
)
	`Áohs
(*((u_št16_ˆ*)(
addr
 + 
i
)));

348 ià(
sum
 > 0xFFFF)

349 
sum
 -= 0xFFFF;

356 ià(
i
 < 
Ën
) {

357 
sum
 +ğ
addr
[
i
] << 8;

358 ià(
sum
 > 0xFFFF)

359 
sum
 -= 0xFFFF;

361  
sum
;

362 
	}
}

369 
	gN‘m­U£
::
	$‘h”_Áß
(cÚ¡ 
‘h”_addr
 *
n
)

371 
i
;

372 
a
[18];

374 
i
 = 
	`¥rštf
(
a
, "%02x:%02x:%02x:%02x:%02x:%02x",

375 
n
->
‘h”_addr_où‘
[0],‚->ether_addr_octet[1],‚->ether_addr_octet[2],

376 
n
->
‘h”_addr_où‘
[3],‚->ether_addr_octet[4],‚->ether_addr_octet[5]);

377  (
i
 < 17 ? 
NULL
 : (*)&
a
);

378 
	}
}

389 
ušt32_t
 
	gN‘m­U£
::
	$fšd_¡©_th»ad_cÜe
() {

391 
ušt32_t
 
th»ad_cÜe
 = 0;

393 #if 
N_MINUS_2_CONFIG


394 if(
cÜes_avaabË
 > 2) {

395 if(
STAT_ON_SEND_CORE
) {

396 
th»ad_cÜe
 = 
£nd_ouut_ršgs
+1;

397 } if(
STAT_ON_RECV_CORE
) {

398 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

400 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

402 } if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

403 
th»ad_cÜe
 = 1;

405 
th»ad_cÜe
 = 0;

407 #–if 
N_MINUS_1_CONFIG


408 if(
cÜes_avaabË
 > 1) {

409 if(
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
) {

410 
th»ad_cÜe
 = 
£nd_ouut_ršgs
;

412 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

415 
th»ad_cÜe
 = 0;

418 if(
cÜes_avaabË
 > 2) {

419 if(
STAT_ON_SEND_CORE
) {

420 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

421 } if(
STAT_ON_RECV_CORE
) {

422 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-2;

424 
th»ad_cÜe
 = 
£nd_ouut_ršgs
-3;

427 if(
cÜes_avaabË
 =ğ2 && (
STAT_ON_SEND_CORE
 || 
STAT_ON_RECV_CORE
)) {

428 
th»ad_cÜe
 = 1;

430 
th»ad_cÜe
 = 0;

435  
th»ad_cÜe
;

437 
	}
}

439 
	gN‘m­U£
::
	$N‘m­U£
() {

440 
¬±abË
.
	`£t_em±y_key
(0);

441 
¬±abË
.
	`£t_d–‘ed_key
(1);

443 #iâdef 
OPT_FOR_SINGLE_CORE


445 
³ndšg_¬p_»q_th
.
	`£t_em±y_key
(0);

446 
³ndšg_¬p_»q_th
.
	`£t_d–‘ed_key
(1);

447 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_em±y_key
(0);

448 
³ndšg_¬p_»q_»Œ›s_th
.
	`£t_d–‘ed_key
(1);

452 
	`¥rštf
(
iâame
, "netmap:%s", "eth4");

453 
cÜes_avaabË
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

454 
	`sourû_hwaddr
(
iâame
);

455 
	`š™Ÿlize_£nd_»cv
();

457 
£nd_¡©s
.
	`»size
(
£nd_ouut_ršgs
);

458 
»cv_¡©s
.
	`»size
(
»cv_ouut_ršgs
);

460 
ušt8_t
 
i
 = 0; i<
£nd_ouut_ršgs
; i++) {

461 
	`mem£t
(&
£nd_¡©s
[
i
], 0, (
compu‹_¡©s
));

464 
ušt8_t
 
i
 = 0; i<
»cv_ouut_ršgs
; i++) {

465 
	`mem£t
(&
»cv_¡©s
[
i
], 0, (
compu‹_¡©s
));

468 #ifdef 
OPT_FOR_SINGLE_CORE


471 
£nd_™”
 = 
»cv_™”
 = 0;

474 
§ã_to_¡¬t_»cv
 = 
Œue
;

475 
	}
}

481 
	$dump_·ylßd
(cÚ¡ *
_p
, 
Ën
, 
Ãtm­_ršg
 *
ršg
, 
cur
)

483 
buf
[128];

484 
i
, 
j
, 
i0
;

485 cÚ¡ *
p
 = (cÚ¡ *)
_p
;

489 
	`´štf
("ring %p cur %5d [len %5d]\n",

490 
ršg
, 
cur
, 
Ën
);

492 
i
 = 0; i < 
Ën
; ) {

493 
	`mem£t
(
buf
, (buf), ' ');

494 
	`¥rštf
(
buf
, "%5d: ", 
i
);

495 
i0
 = 
i
;

496 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

497 
	`¥rštf
(
buf
+7+
j
*3, "%02x ", (
ušt8_t
)(
p
[
i
]));

498 
i
 = 
i0
;

499 
j
=0; j < 16 && 
i
 < 
Ën
; i++, j++)

500 
	`¥rštf
(
buf
+7+
j
 + 48, "%c",

501 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

502 
	`´štf
("%s\n", 
buf
);

504 
	}
}

506 
	gN‘m­U£
::~
	$N‘m­U£
() {

507 
ušt64_t
 
tÙs
 = 0, 
tÙr
 = 0;

508 
cout
<<"Wa™šg fÜ com¶‘iÚ"<<
’dl
;

509 
	`g‘timeofday
(&
’d_time
, 
NULL
);

511  
ušt8_t
 
i
=0; i < 
£nd_ouut_ršgs
 ; i++ ) {

512 
tÙs
 +ğ
£nd_¡©s
[
i
].
fÜw¬ded
;

515  
ušt8_t
 
i
=0; i < 
»cv_ouut_ršgs
 ; i++ ) {

516 
tÙr
 +ğ
»cv_¡©s
[
i
].
fÜw¬ded
;

519 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_£nd
.tv_sec) +

520 ((
’d_time
.
tv_u£c
 - 
begš_time_£nd
.tv_usec)/1000000.0);

521 
¿‹_time
 = (
tÙs
*8è/ (
diff_time
*1024*1024*1024);

522 
	`D
("R©š Gbp (S’d): %lf", 
¿‹_time
);

524 
diff_time
 = (
’d_time
.
tv_£c
 - 
begš_time_»cv
.tv_sec) +

525 ((
’d_time
.
tv_u£c
 - 
begš_time_»cv
.tv_usec)/1000000.0);

526 
¿‹_time
 = (
tÙr
*8è/ (
diff_time
*1024*1024*1024);

527 
	`D
("R©š Gbp (Rec›ve): %lf", 
¿‹_time
);

529 #iâdeà
OPT_FOR_SINGLE_CORE


530 
£nd_th»ad
.
	`još
();

531 
»cv_th»ad
.
	`još
();

537 
	`¦“p
(5);

543 
cout
<<"Com¶‘ed"<<
’dl
;

544 
	}
}

547 
	gN‘m­U£
::
	$g‘_vÃt_hdr_Ën
(
nm_desc
 *
nmd
)

549 
nm»q
 
»q
;

550 
”r
;

552 
	`mem£t
(&
»q
, 0, (req));

553 
	`bcİy
(
nmd
->
»q
.
Ä_Çme
,„eq.nr_name, (req.nr_name));

554 
»q
.
Ä_v”siÚ
 = 
NETMAP_API
;

555 
»q
.
Ä_cmd
 = 
NETMAP_VNET_HDR_GET
;

556 
”r
 = 
	`ioùl
(
nmd
->
fd
, 
NIOCREGIF
, &
»q
);

557 ià(
”r
) {

558 
	`D
("Unableo get virtio-net header†ength");

562 
vœt_hdr_Ën
 = 
»q
.
Ä_¬g1
;

563 ià(
vœt_hdr_Ën
) {

564 
	`D
("Port„equires virtio-net header,†ength = %d",

565 
vœt_hdr_Ën
);

567 
	}
}

570 
	gN‘m­U£
::
	$´št_¡©s
(
pÜt_des
 *
pÜts
)

572 #ifdef 
PRINT_STATS


573 #iâdef 
OPT_FOR_SINGLE_CORE


575 
ušt32_t
 
th»ad_cÜe
;

576 
th»ad_cÜe
 = 
	`fšd_¡©_th»ad_cÜe
();

584 
Åes
 = 
»cv_ouut_ršgs
;

585 
sys_št
 = 0;

586 
my_ùrs
 
cur
, 
´ev
;

587 
b1
[40], 
b2
[40];

588 
my_ùrs
 *
pe_´ev
;

590 
pe_´ev
 = (
my_ùrs
 *)
	`ÿÎoc
(
Åes
, (my_ctrs));

591 ià(
pe_´ev
 =ğ
NULL
) {

592 
	`D
("out of memory");

593 
	`ex™
(1);

596 
	`mem£t
(&
´ev
, 0, (prev));

597 
	`g‘timeofday
(&
´ev
.
t
, 
NULL
);

598 !
do_abÜt
) {

599 
j
, 
dosy¦og
 = 0;

600 
ušt64_t
 
µs
, 
dps
, 
u£c
;

601 
my_ùrs
 
x
;

603 
	`mem£t
(&
cur
, 0, (cur));

604 
u£c
 = 
	`wa™_fÜ_Ãxt_»pÜt
(&
´ev
.
t
, &
cur
.t, 1000);

606 ià(++
sys_št
 =ğ
sy¦og_š‹rv®
) {

607 
dosy¦og
 = 1;

608 
sys_št
 = 0;

611 
j
 = 0; j < 
Åes
; ++j) {

612 
pÜt_des
 *
p
 = &
pÜts
[
j
];

614 
cur
.
pkts
 +ğ
p
->
ùr
.pkts;

615 
cur
.
drİ
 +ğ
p
->
ùr
.drop;

617 
x
.
pkts
 = 
p
->
ùr
.pkt - 
pe_´ev
[
j
].pkts;

618 
x
.
drİ
 = 
p
->
ùr
.drİ - 
pe_´ev
[
j
].drop;

619 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

620 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

621 
	`´štf
("%s/%s|", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

622 
pe_´ev
[
j
] = 
p
->
ùr
;

624 ià(
dosy¦og
) {

625 
	`sy¦og
(
LOG_INFO
,

630 "·ck‘s_drİ³d:%lu}", 
»cv_iâame
, 
j
, 
p
->
ùr
.
pkts
,…->ùr.
drİ
);

633 
	`´štf
("\n");

643 
x
.
pkts
 = 
cur
.pkt - 
´ev
.pkts;

644 
x
.
drİ
 = 
cur
.drİ - 
´ev
.drop;

645 
µs
 = (
x
.
pkts
*1000000 + 
u£c
/2) / usec;

646 
dps
 = (
x
.
drİ
*1000000 + 
u£c
/2) / usec;

647 
	`´štf
("===>‡gg»g©%¥p %sdps\n", 
	`nÜm
(
b1
, 
µs
),‚Üm(
b2
, 
dps
));

648 
´ev
 = 
cur
;

651 
	`ä“
(
pe_´ev
);

652 
	`D
("Done");

655 
	}
}

658 
	gN‘m­U£
::
ä“_bufãrs
(
veùÜ
<
pÜt_des
> &
pÜts
) {

659 
i
, 
	gtÙ
 = 0;

660 
pÜt_des
 *
	gtxpÜt
 = &
pÜts
[
»cv_ouut_ršgs
+1];

663 
	gi
 = 0; i < 
	g»cv_ouut_ršgs
+2; i++) {

664 
pÜt_des
 *
	gı
 = &
pÜts
[
i
];

665 
ov”æow_queue
 *
	gq
 = 
ı
->
oq
;

667 ià(!
	gq
 || q->
	g¦Ùs
.
em±y
())

670 !
	gq
->
	g¦Ùs
.
em±y
()) {

671 
Ãtm­_¦Ù
 
	gs
 = 
q
->
¦Ùs
.
äÚt
();

672 
	gq
->
	g¦Ùs
.
pİ
();

673 
ušt32_t
 *
	gb
 = (ušt32_ˆ*)
NETMAP_BUF
(
ı
->
ršg
, 
s
.
buf_idx
);

675 *
	gb
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

676 
	gtxpÜt
->
	gnmd
->
	gniå
->
	gni_bufs_h—d
 = 
s
.
buf_idx
;

677 
	gtÙ
++;

680 
D
("\ÀAdded %dƒxŒ¨bufãr back iÀtÙ®.\nDÚ®È:-)",
tÙ
);

684 
	gN‘m­U£
::
	$š™Ÿlize_£nd_»cv
() {

685 
ušt16_t
 
i
,
j
;

687 #ifdef 
PRINT_STATS


688 
sy¦og_š‹rv®
 = 
DEF_SYSLOG_INT
;

690 
£nd_ma¡”_nmd
 = 
NULL
;

691 
»cv_ma¡”_nmd
 = 
NULL
;

692 
§ã_to_¡¬t_»cv
 = 
çl£
;

693 
	`¥rštf
(
£nd_iâame
, "%s/T", 
iâame
);

694 
	`¥rštf
(
»cv_iâame
, "%s/R", 
iâame
);

695 
	`¥rštf
(
£nd_pes_iâame
, "vale0:1");

696 
	`¥rštf
(
»cv_pes_iâame
, "vale1:1");

698 #if 
N_MINUS_2_CONFIG


699 if(
cÜes_avaabË
>=3) {

700 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 2;

702 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

705 #–if 
N_MINUS_1_CONFIG


706 if(
cÜes_avaabË
>=2) {

707 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
 - 1;

709 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 1;

712 
£nd_ouut_ršgs
 = 
»cv_ouut_ršgs
 = 
cÜes_avaabË
;

715 
³r_cÜe_£nd_pÜt
.
	`»size
(
£nd_ouut_ršgs
);

716 
³r_cÜe_couÁs
.
	`»size
(
£nd_ouut_ršgs
);

718 
³r_cÜe_»cv_pÜt
.
	`»size
(
»cv_ouut_ršgs
);

719 
³r_cÜe_couÁr
.
	`»size
(
»cv_ouut_ršgs
);

720 
£nd_b©ch_cÜe
.
	`»size
(
£nd_ouut_ršgs
, 
MAX_BATCH_CORE_SEND
);

721 
»cv_b©ch_cÜe
.
	`»size
(
»cv_ouut_ršgs
,
MAX_BATCH_CORE_RECV
);

723 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

724 
³r_cÜe_£nd_pÜt
[
i
].
nmd
 = 
NULL
;

725 
³r_cÜe_couÁs
[
i
] = 0;

727 
i
 = 0; i < 
»cv_ouut_ršgs
; ++i) {

728 
³r_cÜe_»cv_pÜt
[
i
].
nmd
 = 
NULL
;

729 
³r_cÜe_couÁr
[
i
] = 0;

732 #ifdef 
OPT_FOR_SINGLE_CORE


734 
³ndšg_¬p_»q
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_£t
 < 
ušt32_t
 >());

735 
³ndšg_¬p_»q_»Œ›s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
d’£_hash_m­
 < 
ušt32_t
, uint32_t >());

736 
deã¼ed_·ck‘s
.
	`»size
(
£nd_ouut_ršgs
, 
Ãw
 
li¡
 < 
tı_pkt
 >());

741 
­_»q
.
	`»size
(
£nd_ouut_ršgs
);

742 
­_»s
.
	`»size
(
£nd_ouut_ršgs
);

744 
i
 = 0; i < 
£nd_ouut_ršgs
; ++i) {

746 
³ndšg_¬p_»q
[
i
]->
	`£t_em±y_key
(0);

747 
³ndšg_¬p_»q
[
i
]->
	`£t_d–‘ed_key
(1);

748 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_em±y_key
(0);

749 
³ndšg_¬p_»q_»Œ›s
[
i
]->
	`£t_d–‘ed_key
(1);

751 
	`memıy
(
­_»q
[
i
].
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

752 
	`memıy
(
­_»q
[
i
].
eh
.
‘h”_dho¡
, 
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

753 
­_»q
[
i
].
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

755 
	`memıy
(
­_»s
[
i
].
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

756 
­_»s
[
i
].
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

758 
­_»q
[
i
].
ah
.
hty³
 = 
	`htÚs
 (1);

759 
­_»q
[
i
].
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

760 
­_»q
[
i
].
ah
.
hËn
 = 6;

761 
­_»q
[
i
].
ah
.
¶’
 = 4;

762 
­_»q
[
i
].
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REQUEST
);

763 
	`memıy
(
­_»q
[
i
].
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

764 
­_»q
[
i
].
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

765 
	`mem£t
 (
­_»q
[
i
].
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

767 
­_»s
[
i
].
ah
.
hty³
 = 
	`htÚs
 (1);

768 
­_»s
[
i
].
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

769 
­_»s
[
i
].
ah
.
hËn
 = 6;

770 
­_»s
[
i
].
ah
.
¶’
 = 4;

771 
­_»s
[
i
].
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REPLY
);

772 
	`memıy
(
­_»s
[
i
].
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

773 
­_»s
[
i
].
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

779 
»cv_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
»ûive_pkts_äom_içû
, 
this
);

781 
ıu_£t_t
 
ıu_£t
;

783 
th»ad_cÜe1
, 
th»ad_cÜe2
;

785 #if 
N_MINUS_2_CONFIG


786 if(
cÜes_avaabË
 > 2) {

787 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

788 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
 + 1;

789 } if(
cÜes_avaabË
 == 2) {

790 
th»ad_cÜe1
 = 1;

791 
th»ad_cÜe2
 = 1;

793 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

795 #–if 
N_MINUS_1_CONFIG


796 if(
cÜes_avaabË
 > 1) {

797 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
;

798 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
;

800 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

803 if(
cÜes_avaabË
 > 1) {

804 
th»ad_cÜe1
 = 
»cv_ouut_ršgs
-2;

805 
th»ad_cÜe2
 = 
£nd_ouut_ršgs
-1;

807 
th»ad_cÜe1
 = 
th»ad_cÜe2
 = 0;

811 
	`CPU_ZERO
(&
ıu_£t
);

812 
	`CPU_SET
(
th»ad_cÜe1
, &
ıu_£t
);

813 
rc
 = 
	`±h»ad_£ffš™y_Å
(
»cv_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

814 if(
rc
!=0) {

815 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

818 
j
 = 0; j < 
CPU_SETSIZE
; j++)

819 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

820 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

824 
	`¦“p
(2);

826 
£nd_th»ad
 = 
	`th»ad
(&
N‘m­U£
::
£nd_pkts_to_içû
, 
this
);

828 
	`CPU_ZERO
(&
ıu_£t
);

829 
	`CPU_SET
(
th»ad_cÜe2
, &
ıu_£t
);

830 
rc
 = 
	`±h»ad_£ffš™y_Å
(
£nd_th»ad
.
	`Çtive_hªdË
(), (
ıu_£t_t
), &
ıu_£t
);

831 if(
rc
!=0) {

832 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

835 
j
 = 0; j < 
CPU_SETSIZE
; j++)

836 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

837 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
i
);

841 
	}
}

846 
	gN‘m­U£
::
	$g‘_bufãr_tx
(
cÜeid
) {

847 #iâdeà
OPT_FOR_SINGLE_CORE


848 !
£nd_ma¡”_nmd
) {

849 
this_th»ad
::
	`y›ld
();

852 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

853 if(
	`uÆik–y
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

854 
nm»q
 
ba£_»q
;

855 
š‹rçû
[32];

856 
	`mem£t
(&
ba£_»q
, 0, (base_req));

857 #ifdeà
OPT_FOR_SINGLE_CORE


858 
	`¥rštf
(
š‹rçû
, "%s-%d/T", 
iâame
, 
cÜeid
);

859 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

861 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

862 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

864 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

865 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

866  
NULL
;

868 
	`D
("successfully opened core #%d %s (tx slots: %d)",

869 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

870 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, coreid);

872 ià(
cÜeid
==0) {

873 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
);

874 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

877 
	`¥rštf
(
š‹rçû
, "%s}%d", 
£nd_pes_iâame
, 
cÜeid
);

878 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

879 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
£nd_ma¡”_nmd
);

881 ià(
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

882 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

883  
NULL
;

885 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

886 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_£nd_pÜt
[cÜeid].
nmd
->
»q
.
Ä_tx_¦Ùs
);

887 
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ršg = 
	`NETMAP_TXRING
Õ”_cÜe_£nd_pÜt[cÜeid].
nmd
->
niå
, 0);

889 
	`D
("zerocopy %s",

890 (
£nd_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

893 if(
	`uÆik–y
(
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

897 
ušt16_t
 
n
;

898 
pŞlfd
 
pfd
;

899 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

900 
pfd
.
ev’ts
 = 
POLLOUT
;

901 
pfd
.
»v’ts
 = 0;

902 #ifdeà
BUSY_WAIT


903 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

904 
	`D
("ioctlƒrror on queue %d: %s", 0,

905 
	`¡»¼Ü
(
”ºo
));

906  
NULL
;

910 !
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

913 if(
do_abÜt
) {

914  
NULL
;

918 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

919 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

920 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->
fœ¡_tx_ršg
,…”_cÜe_£nd_pÜt[cÜeid].nmd->
Ï¡_tx_ršg
);

921  
NULL
;

924 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_£nd_pÜt
[
cÜeid
].
ršg
);

925 ià(
n
 <ğ
£nd_b©ch_cÜe
[
cÜeid
]) {

926 
³r_cÜe_couÁs
[
cÜeid
] = 
n
;

928 
³r_cÜe_couÁs
[
cÜeid
] = 
£nd_b©ch_cÜe
[coreid];

931 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

932  
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+(
‘h”_h—d”
)+
vœt_hdr_Ën
;

933 
	}
}

936 
	gN‘m­U£
::
	$syncbuáx
(
cÜeid
) {

937 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].ring;

938 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

939 
pkthdr
*…kthd¸ğ(pkthdr*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
)+
vœt_hdr_Ën
);

941 
¦Ù
->
Ën
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
)+
vœt_hdr_Ën
;

942 
¦Ù
->
æags
 = 0;

944 #ifdeà
OPT_FOR_SINGLE_CORE


946 #ifdef 
PRINT_STATS


947 
³r_cÜe_£nd_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

950 if(
	`uÆik–y
(
£nd_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

951 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

954 if(
cÜeid
 == 0) {

955 
£nd_™”
++;

958 if(
£nd_™”
 >ğ
NO_OF_SAFE_ITR
) {

959 
£nd_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

962 if(
ARP_ENABLED
 && 
¬±abË
.
	`fšd
(
pkthdr
->

.
_d¡
.
s_addr
)!÷½bË.
	`’d
()) {

963 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &
¬±abË
[pkthdr->

.
_d¡
.
s_addr
], 6);

965 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
,
	`‘h”_©Ú
(
DEST_MAC
), 6);

967 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

971 if(
	`uÆik–y
(--
³r_cÜe_couÁs
[
cÜeid
] =ğ0 || 
¦Ù
->
Ën
 < 256)) {

972 
¦Ù
->
æags
 |ğ
NS_REPORT
;

974 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

976 if(
	`uÆik–y
(
¦Ù
->
Ën
 < 256 || 
³r_cÜe_couÁs
[
cÜeid
] == 0)) {

977 
ršg
->
h—d
 =„šg->
cur
;

978 
pŞlfd
 
pfd
;

979 
pfd
.
fd
 = 
³r_cÜe_£nd_pÜt
[
cÜeid
].
nmd
->fd;

980 
pfd
.
ev’ts
 = 
POLLOUT
;

981 
pfd
.
»v’ts
 = 0;

982 
	`ioùl
(
pfd
.
fd
, 
NIOCTXSYNC
, 
NULL
);

984 
	}
}

987 
	gN‘m­U£
::
	$g‘_bufãr_rx
(
cÜeid
, &
pktcouÁ
) {

988 #iâdeà
OPT_FOR_SINGLE_CORE


989 !
»cv_ma¡”_nmd
) {

990 
this_th»ad
::
	`y›ld
();

993 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

994 if(
	`uÆik–y
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
)) {

995 
nm»q
 
ba£_»q
;

996 
š‹rçû
[32];

997 
	`mem£t
(&
ba£_»q
, 0, (base_req));

999 #ifdeà
OPT_FOR_SINGLE_CORE


1000 
	`¥rštf
(
š‹rçû
, "%s-%d/R", 
iâame
, 
cÜeid
);

1001 
	`D
("İ’šg iÁ”çû‚amed %s", 
š‹rçû
);

1003 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1004 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, &
ba£_»q
, 0, 
NULL
);

1006 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1007 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1008  
NULL
;

1010 
	`D
("successfully opened core #%d %s (rx slots: %d)",

1011 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1012 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, coreid);

1014 ià(
cÜeid
==0) {

1015 
	`g‘_vÃt_hdr_Ën
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
);

1016 
	`D
("vœt_hdr_Ën: %d", 
vœt_hdr_Ën
);

1019 
	`¥rštf
(
š‹rçû
, "%s}%d", 
»cv_pes_iâame
, 
cÜeid
);

1020 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1021 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
»cv_ma¡”_nmd
);

1023 ià(
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
 =ğ
NULL
) {

1024 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1025  
NULL
;

1027 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1028 
cÜeid
 + 1, 
š‹rçû
, 
³r_cÜe_»cv_pÜt
[cÜeid].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1029 
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ršg = 
	`NETMAP_RXRING
Õ”_cÜe_»cv_pÜt[cÜeid].
nmd
->
niå
, 0);

1031 
	`D
("zerocopy %s",

1032 (
»cv_ma¡”_nmd
->
mem
 =ğ
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->mem) ? "enabled" : "disabled");

1036 
¡¬t
:

1037 if(
	`uÆik–y
(
³r_cÜe_couÁr
[
cÜeid
] == 0)) {

1041 
ušt16_t
 
n
;

1042 
pŞlfd
 
pfd
;

1043 
pfd
.
fd
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->fd;

1044 
pfd
.
ev’ts
 = 
POLLIN
;

1045 
pfd
.
»v’ts
 = 0;

1046 
ršg
->
h—d
 =„šg->
cur
;

1047 #ifdeà
BUSY_WAIT


1048 ià(
	`ioùl
(
pfd
.
fd
, 
NIOCRXSYNC
, 
NULL
) < 0) {

1049 
	`D
("ioctlƒrror on queue %d: %s", 0,

1050 
	`¡»¼Ü
(
”ºo
));

1051  
NULL
;

1054 ià(!
do_abÜt
 && 
	`pŞl
(&
pfd
, 1, 1 * 1000) == 0) {

1057 if(
do_abÜt
) {

1058  
NULL
;

1062 ià(
pfd
.
»v’ts
 & 
POLLERR
) {

1063 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pfd
.
fd
,

1064 
³r_cÜe_»cv_pÜt
[
cÜeid
].
nmd
->
fœ¡_rx_ršg
,…”_cÜe_»cv_pÜt[cÜeid].nmd->
Ï¡_rx_ršg
);

1065  
NULL
;

1068 
n
 = 
	`nm_ršg_¥aû
(
³r_cÜe_»cv_pÜt
[
cÜeid
].
ršg
);

1069 ià(
n
 <ğ
»cv_b©ch_cÜe
[
cÜeid
]) {

1070 
³r_cÜe_couÁr
[
cÜeid
] = 
n
;

1072 
³r_cÜe_couÁr
[
cÜeid
] = 
»cv_b©ch_cÜe
[coreid];

1074 
pktcouÁ
 = 
³r_cÜe_couÁr
[
cÜeid
];

1076 if(
³r_cÜe_couÁr
[
cÜeid
]) {

1077 
Ãtm­_¦Ù
 *
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1078 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
	`NETMAP_BUF
(
ršg
, 
¦Ù
->
buf_idx
è+
vœt_hdr_Ën
);

1080 #ifdeà
OPT_FOR_SINGLE_CORE


1081 if(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 =ğ
¤c_
.s_addr) {

1082 if(
ARP_ENABLED
) {

1083 
¬±abË
[
pkt
->
pkthdr
.

.
_¤c
.
s_addr
] = *(
‘h”_addr
*íkt->pkthdr.
eh
.
‘h”_sho¡
;

1086 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1087 
³r_cÜe_couÁr
[
cÜeid
]--;

1088 
¡¬t
;

1091  (*)((*)
pkt
+(
‘h”_h—d”
));

1093  
NULL
;

1095 
	}
}

1098 
	gN‘m­U£
::
	$syncbuäx
(
cÜeid
) {

1100 
Ãtm­_ršg
 *
ršg
 = 
³r_cÜe_»cv_pÜt
[
cÜeid
].ring;

1102 #ifdeà
OPT_FOR_SINGLE_CORE


1104 #ifdef 
PRINT_STATS


1105 
³r_cÜe_»cv_pÜt
[
cÜeid
].
ùr
.
pkts
+=(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
)*8;

1107 if(
	`uÆik–y
(
»cv_™”
 =ğ
NO_OF_SAFE_ITR
 && 
cÜeid
 == 0)) {

1108 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1111 if(
cÜeid
 == 0) {

1112 
»cv_™”
++;

1115 if(
»cv_™”
 >ğ
NO_OF_SAFE_ITR
) {

1116 
»cv_¡©s
[
cÜeid
].
fÜw¬ded
 +ğ(
ršg
->
¦Ù
[ršg->
cur
].
Ën
 - 
vœt_hdr_Ën
);

1120 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,ring->cur);

1121 
³r_cÜe_couÁr
[
cÜeid
]--;

1122 
	}
}

1124 #iâdef 
OPT_FOR_SINGLE_CORE


1127 
	gN‘m­U£
::
	$£nd_pkts_to_içû
() {

1129 
£nd_th»ad_cÜe
;

1131 #if 
N_MINUS_2_CONFIG


1132 if(
cÜes_avaabË
 > 2) {

1133 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
 + 1;

1134 } if(
cÜes_avaabË
 == 2) {

1135 
£nd_th»ad_cÜe
 = 1;

1137 
£nd_th»ad_cÜe
 = 0;

1139 #–if 
N_MINUS_1_CONFIG


1140 if(
cÜes_avaabË
 > 1) {

1141 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
;

1143 
£nd_th»ad_cÜe
 = 0;

1146 if(
cÜes_avaabË
 > 1) {

1147 
£nd_th»ad_cÜe
 = 
£nd_ouut_ršgs
-1;

1149 
£nd_th»ad_cÜe
 = 0;

1153 
	`sched_g‘ıu
()!=
£nd_th»ad_cÜe
) {

1154 
this_th»ad
::
	`y›ld
();

1157 
ušt32_t
 
i
;

1158 
rv
;

1159 
veùÜ
<
pÜt_des
> 
pÜts
;

1160 
ušt64_t
 
™”
 = 0;

1161 
ušt32_t
 
Åes
;

1162 
pÜt_des
 *
rxpÜt
;

1163 
pÜt_des
 *
txpÜt
;

1165 
nm»q
 
ba£_»q
;

1166 
ušt32_t
 
exŒa_bufs
;

1167 
pŞlfd
…Şlfd[
£nd_ouut_ršgs
+1];

1168 
veùÜ
<
ušt32_t
> 
	`úts
(
£nd_ouut_ršgs
);

1169 
Ãtm­_ršg
 *
txršg
;

1171 
Åes
 = 
£nd_ouut_ršgs
;

1173 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1174 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1176 
	`D
("Åes:%u",
Åes
);

1178 
pÜts
.
	`»size
(
Åes
+2);

1180 
txpÜt
 = &
pÜts
[
Åes
];

1181 
rxpÜt
 = &
pÜts
[
Åes
+1];

1183 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1184 
	`D
("failedo‡llocatehe stats‡rray");

1185  
NULL
;

1188 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1190 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1191 
txpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_iâame
, &
ba£_»q
, 0, 
NULL
);

1193 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1194 
	`D
("ÿÂÙ o³À%s", 
£nd_iâame
);

1195  
NULL
;

1197 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_iâame
,

1198 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1201 
	`g‘_vÃt_hdr_Ën
(
txpÜt
->
nmd
);

1202 
£nd_exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
;

1203 
£nd_b©ch
 = 
MAX_BATCH_SEND
;

1205 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1206 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1207 
ba£_»q
.
Ä_¬g3
 = 
£nd_exŒa_bufs
;

1208 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
£nd_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1210 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1211 
	`D
("ÿÂÙ o³À%s", 
£nd_pes_iâame
);

1212  
NULL
;

1214 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
£nd_pes_iâame
,

1215 
rxpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1219 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1220 
txršg
 = 
txpÜt
->
ršg
;

1221 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1223 
exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1225 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1227 
i
 = 0; i < 
Åes
; ++i) {

1228 
š‹rçû
[32];

1229 
	`¥rštf
(
š‹rçû
, "%s{%d", 
£nd_pes_iâame
, 
i
);

1230 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1231 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
rxpÜt
->nmd);

1233 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1234 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1235  
NULL
;

1237 
	`D
("successfully opened…ipe #%d %s (rx slots: %d)",

1238 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_rx_¦Ùs
);

1239 
pÜts
[
i
].
ršg
 = 
	`NETMAP_RXRING
ÕÜts[i].
nmd
->
niå
, 0);

1241 
	`D
("zerocopy %s",

1242 (
rxpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1245 
£nd_exŒa_bufs
 = 
exŒa_bufs
;

1246 
£nd_ma¡”_nmd
 = 
rxpÜt
->
nmd
;

1248 
	`¦“p
(2);

1250 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1252 #ifdef 
PRINT_STATS


1253 
i
 = 0; i < 
Åes
+2; ++i) {

1254 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1277 
¬p_pkt
 
­_»q
, 
­_»s
;

1279 
	`memıy
(
­_»q
.
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1280 
	`memıy
(
­_»q
.
eh
.
‘h”_dho¡
, 
	`‘h”_©Ú
("ff:ff:ff:ff:ff:ff"), 6);

1281 
­_»q
.
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

1283 
	`memıy
(
­_»s
.
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1284 
­_»s
.
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_ARP
);

1286 
­_»q
.
ah
.
hty³
 = 
	`htÚs
 (1);

1287 
­_»q
.
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

1288 
­_»q
.
ah
.
hËn
 = 6;

1289 
­_»q
.
ah
.
¶’
 = 4;

1290 
­_»q
.
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REQUEST
);

1291 
	`memıy
(
­_»q
.
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1292 
­_»q
.
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

1293 
	`mem£t
 (
­_»q
.
ah
.
rg‘_mac
, 0, 6 *  (
ušt8_t
));

1295 
­_»s
.
ah
.
hty³
 = 
	`htÚs
 (1);

1296 
­_»s
.
ah
.
±y³
 = 
	`htÚs
 (
ETHERTYPE_IP
);

1297 
­_»s
.
ah
.
hËn
 = 6;

1298 
­_»s
.
ah
.
¶’
 = 4;

1299 
­_»s
.
ah
.
İcode
 = 
	`htÚs
 (
ARPOP_REPLY
);

1300 
	`memıy
(
­_»s
.
ah
.
£nd”_mac
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1301 
­_»s
.
ah
.
£nd”_
 = 
¤c_
.
s_addr
;

1303 !
do_abÜt
) {

1304 
u_št
 
pŞlo
 = 0;

1306 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1307 
	`g‘timeofday
(&
begš_time_£nd
, 
NULL
);

1310 
™”
++;

1312 
i
 = 0; i < 
Åes
; ++i) {

1313 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1314 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1318 
pŞlfd
[
pŞlo
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1319 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLIN
;

1320 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1321 
úts
[
pŞlo
] = 
i
;

1322 ++
pŞlo
;

1324 
pŞlfd
[
pŞlo
].
fd
 = 
txpÜt
->
nmd
->fd;

1325 
pŞlfd
[
pŞlo
].
ev’ts
 = 
POLLOUT
;

1326 
pŞlfd
[
pŞlo
].
»v’ts
 = 0;

1328 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞlo
, 10);

1340 
‹mp_couÁ
;

1341 
boŞ
 
Ãed_æush
 = 
çl£
;

1342 
b©ch_cur
 = 0,
™emp
;

1344 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`size_­´ox
();

1346 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1347 
veùÜ
 <
_mac_·œ
> 
	`_mac_·œs
(
‹mp_couÁ
);

1348 
‹mp_couÁ
 = 
Ãw_¬p_’Œ›s_th
.
	`Œy_dequeue_bulk
(
_mac_·œs
.
	`begš
(),emp_count);

1349 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1350 
¬±abË
[
_mac_·œs
[
i
].

] = ip_mac_·œs[i].
mac
;

1360 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`size_­´ox
();

1362 ià(
	`uÆik–y
(
‹mp_couÁ
 >= 1)) {

1363 
veùÜ
 <
ušt32_t
> 
	`’queued_¬p_»qs
(
‹mp_couÁ
);

1364 
‹mp_couÁ
 = 
’queued_¬p_»q_th
.
	`Œy_dequeue_bulk
(
’queued_¬p_»qs
.
	`begš
(),emp_count);

1365 
Ãed_æush
 = 
Œue
;

1368 
ušt32_t
 
i
 = 0; i < 
‹mp_couÁ
; i++) {

1369 
­_»s
.
ah
.
rg‘_
 = 
’queued_¬p_»qs
[
i
];

1370 
	`memıy
(
­_»s
.
ah
.
rg‘_mac
, &
¬±abË
[
’queued_¬p_»qs
[
i
]], 6);

1371 
	`memıy
(
­_»s
.
eh
.
‘h”_dho¡
,‡p_»s.
ah
.
rg‘_mac
, 6);

1375 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1376 
b©ch_cur
 = 
£nd_b©ch
;

1377 
txršg
->
h—d
 =xršg->
cur
;

1381 #ifdeà
BUSY_WAIT


1382 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1383 
	`D
("ioctlƒrror on queue %d: %s", 0,

1384 
	`¡»¼Ü
(
”ºo
));

1385  
NULL
;

1388 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1389 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1390 
	`¡»¼Ü
(
”ºo
));

1391  
NULL
;

1393 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1394 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1395 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1396  
NULL
;

1399 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1400 ià(
n
 < 
b©ch_cur
)

1401 
b©ch_cur
 = 
n
;

1404 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1405 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1407 
	`nm_pkt_cİy
(&
­_»s
, 
tx_buf
 + 
vœt_hdr_Ën
, (
¬p_pkt
));

1409 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1410 
tx¦Ù
->
æags
 = 0;

1411 
b©ch_cur
--;

1417 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1427 ià(
	`uÆik–y
(!
deã¼ed_·ck‘s_th
.
	`em±y
())) {

1428 
Ãed_æush
 = 
Œue
;

1429 
li¡
 <
tı_pkt
>::
™”©Ü
 
™
 = 
deã¼ed_·ck‘s_th
.
	`begš
();

1431 
™
 !ğ
deã¼ed_·ck‘s_th
.
	`’d
()) {

1434 
pkthdr
*…kthd¸ğ(pkthdr*è((*)&(*
™
è+ 
vœt_hdr_Ën
);

1435 
ušt32_t
 
‹mp_
 = 
pkthdr
->

.
_d¡
.
s_addr
;

1436 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™¬p
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1438 ià(
™¬p
 !ğ
¬±abË
.
	`’d
()) {

1439 
size_t
 
‹m¶’
 = 
	`Áohs
(
pkthdr
->

.
_Ën
è+ (
‘h”_h—d”
è+ 
vœt_hdr_Ën
;

1442 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1443 
b©ch_cur
 = 
£nd_b©ch
;

1444 
txršg
->
h—d
 =xršg->
cur
;

1448 #ifdeà
BUSY_WAIT


1449 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1450 
	`D
("ioctlƒrror on queue %d: %s", 0,

1451 
	`¡»¼Ü
(
”ºo
));

1452  
NULL
;

1455 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1456 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1457 
	`¡»¼Ü
(
”ºo
));

1458  
NULL
;

1460 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1461 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1462 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1463  
NULL
;

1466 
ušt32_t
 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1467 ià(
n
 < 
b©ch_cur
)

1468 
b©ch_cur
 = 
n
;

1471 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1472 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1474 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™¬p
->
£cÚd
), 6);

1475 
	`nm_pkt_cİy
(&(*
™
), 
tx_buf
, 
‹m¶’
);

1476 
tx¦Ù
->
Ën
 = 
‹m¶’
;

1478 
tx¦Ù
->
æags
 = 0;

1479 
b©ch_cur
--;

1481 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1483 #ifdef 
PRINT_STATS


1484 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1486 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1487 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1492 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1498 } ià(
	`uÆik–y
(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] == 0 ||…ending_arp_req_retries_th[temp_ip] == 16)) {

1499 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 0;

1500 
™
 = 
deã¼ed_·ck‘s_th
.
	`”a£
(it);

1502 
™
++;

1506 ià(
	`uÆik–y
(
Ãed_æush
)) {

1508 
b©ch_cur
 = 0;

1509 
txršg
->
h—d
 =xršg->
cur
;

1510 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1513 ià(
	`uÆik–y
(!
³ndšg_¬p_»q_th
.
	`em±y
())) {

1515 
³ndšg_¬p_»q_th
.
	`ş—r
();

1520 ià(
rv
 <= 0) {

1521 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1522 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1527 
™emp
 = 0; i‹m°< 
pŞlo
; itemp++) {

1528 
i
 = 
úts
[
™emp
];

1529 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1531 
Ãxt_cur
 = 
ršg
->
cur
;

1532 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1533 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1534 
»cvcouÁ
 = 
	`nm_ršg_¥aû
(
ršg
);

1535 if(
»cvcouÁ
>=
MAX_BATCH_CORE_RECV
) {

1536 
»cvcouÁ
 = 
MAX_BATCH_CORE_RECV
;

1539 
»cvcouÁ
--) {

1540 
tİ
:

1541 
n
;

1542 if(
	`uÆik–y
(
b©ch_cur
==0)) {

1543 
b©ch_cur
 = 
£nd_b©ch
;

1547 #ifdeà
BUSY_WAIT


1548 ià(
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
) < 0) {

1549 
	`D
("ioctlƒrror on queue %d: %s", 0,

1550 
	`¡»¼Ü
(
”ºo
));

1551  
NULL
;

1554 ià(
	`pŞl
(&(
pŞlfd
[
pŞlo
]), 1, -1) <= 0) {

1555 
	`´štf
("pollƒrror/timeout onransmit queue %d: %s", 0,

1556 
	`¡»¼Ü
(
”ºo
));

1557  
NULL
;

1559 ià(
pŞlfd
[
pŞlo
].
»v’ts
 & 
POLLERR
) {

1560 
	`´štf
("pŞÈ”rÜ oÀ%d„šg %d-%d", 
pŞlfd
[
pŞlo
].
fd
,

1561 
txpÜt
->
nmd
->
fœ¡_tx_ršg
,xpÜt->nmd->
Ï¡_tx_ršg
);

1562  
NULL
;

1565 
n
 = 
	`nm_ršg_¥aû
(
txršg
);

1566 ià(
n
 < 
b©ch_cur
)

1567 
b©ch_cur
 = 
n
;

1570 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1571 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1572 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
ršg
,‚ext_cur);

1573 
Ãxt_¦Ù
 = &
ršg
->
¦Ù
[
Ãxt_cur
];

1574 
Ãxt_buf
 = 
	`NETMAP_BUF
(
ršg
, 
Ãxt_¦Ù
->
buf_idx
);

1575 
	`__butš_´eãtch
(
Ãxt_buf
);

1577 
Ãtm­_¦Ù
 *
tx¦Ù
 = &
txršg
->
¦Ù
[txršg->
cur
];

1578 *
tx_buf
 = 
	`NETMAP_BUF
(
txršg
, 
tx¦Ù
->
buf_idx
);

1579 
pkthdr
*…kthd¸ğ(pkthdr*)(
tx_buf
+
vœt_hdr_Ën
);

1580 
pkthdr
* 
pkthdr_rxpkt
 = (pkthdr*)(
‹mpbuf
+
vœt_hdr_Ën
);

1581 
	`memıy
(
pkthdr_rxpkt
->
eh
.
‘h”_sho¡
, 
	`‘h”_©Ú
(
¤c_‘h_addr
), 6);

1582 
pkthdr
->
eh
.
‘h”_ty³
 = 
	`htÚs
(
ETHERTYPE_IP
);

1586 
tx¦Ù
->
Ën
=
rs
->len;

1606 
ušt32_t
 
‹mp_
 = 
pkthdr_rxpkt
->

.
_d¡
.
s_addr
;

1607 
d’£_hash_m­
 < 
ušt32_t
, 
‘h”_addr
 > :: 
™”©Ü
 
™
 = 
¬±abË
.
	`fšd
(
‹mp_
);

1609 if(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
(è&& 
™
 !ğ
¬±abË
.end()) {

1611 
	`nm_pkt_cİy
(
‹mpbuf
,
tx_buf
,
rs
->
Ën
);

1612 
	`memıy
(
pkthdr
->
eh
.
‘h”_dho¡
, &(
™
->
£cÚd
), 6);

1617 
deã¼ed_·ck‘s_th
.
	`push_back
(*(
tı_pkt
 *)
‹mpbuf
);

1618 ià(
³ndšg_¬p_»q_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_th.
	`’d
()) {

1621 
boŞ
 
£nd_¬p_»q
 = 
Œue
;

1622 
³ndšg_¬p_»q_th
.
	`š£¹
(
‹mp_
);

1625 ià(
³ndšg_¬p_»q_»Œ›s_th
.
	`fšd
(
‹mp_
è=ğ³ndšg_¬p_»q_»Œ›s_th.
	`’d
() ||…ending_arp_req_retries_th[temp_ip] == 0) {

1626 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] = 1;

1627 } ià(
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
] < 16) {

1628 
³ndšg_¬p_»q_»Œ›s_th
[
‹mp_
]++;

1630 
£nd_¬p_»q
 = 
çl£
;

1633 ià(
	`lik–y
(
£nd_¬p_»q
)) {

1634 
­_»q
.
ah
.
rg‘_
 = 
‹mp_
;

1635 
	`nm_pkt_cİy
(&
­_»q
, 
tx_buf
 + 
vœt_hdr_Ën
, (
¬p_pkt
));

1636 
tx¦Ù
->
Ën
 = (
¬p_pkt
è+ 
vœt_hdr_Ën
;

1638 
tx¦Ù
->
æags
 = 0;

1640 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1642 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1644 
b©ch_cur
 = 0;

1645 
txršg
->
h—d
 =xršg->
cur
;

1646 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1655 
tx¦Ù
->
æags
 = 0;

1656 
b©ch_cur
--;

1657 #ifdef 
PRINT_STATS


1658 
pÜts
[
i
].
ùr
.
pkts
+=(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
)*8;

1660 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1661 
£nd_¡©s
[
i
].
fÜw¬ded
 +ğ(
tx¦Ù
->
Ën
 - 
vœt_hdr_Ën
);

1663 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1664 
tx¦Ù
->
æags
 |ğ
NS_REPORT
;

1666 
txršg
->
cur
 = 
	`nm_ršg_Ãxt
(txring,txring->cur);

1667 ià(
	`uÆik–y
(
tx¦Ù
->
Ën
 < 256 || 
b©ch_cur
==0)) {

1669 
txršg
->
h—d
 =xršg->
cur
;

1670 
	`ioùl
(
pŞlfd
[
pŞlo
].
fd
, 
NIOCTXSYNC
, 
NULL
);

1673 
ršg
->
h—d
 =„šg->
cur
 = 
Ãxt_cur
;

1678 
	`¦“p
(5);

1679 
i
 = 0; i < (
u_št
)
£nd_ouut_ršgs
 + 2; ++i) {

1680 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

1683  
NULL
;

1684 
	}
}

1687 
	gN‘m­U£
::
	$»ûive_pkts_äom_içû
() {

1689 
»cv_th»ad_cÜe
;

1691 #if 
N_MINUS_2_CONFIG


1692 if(
cÜes_avaabË
 > 2) {

1693 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1694 } if(
cÜes_avaabË
 == 2) {

1695 
»cv_th»ad_cÜe
 = 1;

1697 
»cv_th»ad_cÜe
 = 0;

1699 #–if 
N_MINUS_1_CONFIG


1700 if(
cÜes_avaabË
 > 1) {

1701 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
;

1703 
»cv_th»ad_cÜe
 = 0;

1706 if(
cÜes_avaabË
 > 1) {

1707 
»cv_th»ad_cÜe
 = 
»cv_ouut_ršgs
-2;

1709 
»cv_th»ad_cÜe
 = 0;

1713 
	`sched_g‘ıu
()!=
»cv_th»ad_cÜe
) {

1714 
this_th»ad
::
	`y›ld
();

1717 
ušt32_t
 
i
;

1718 
rv
;

1719 
veùÜ
<
pÜt_des
> 
pÜts
;

1720 
™”
 = 0;

1721 
ušt32_t
 
Åes
;

1722 
ov”æow_queue
 *
ä“q
;

1723 
pÜt_des
 *
rxpÜt
;

1724 
pÜt_des
 *
txpÜt
;

1726 
nm»q
 
ba£_»q
;

1727 
ušt32_t
 
exŒa_bufs
;

1728 
veùÜ
<
ov”æow_queue
> 
oq
;

1729 
pŞlfd
…Şlfd[
»cv_ouut_ršgs
+1];

1731 
Åes
 = 
»cv_ouut_ršgs
;

1732 
ä“q
 = 
NULL
;

1734 
	`£ogmask
(
	`LOG_UPTO
(
LOG_INFO
));

1735 
	`İ’log
("lb", 
LOG_CONS
 | 
LOG_PID
 | 
LOG_NDELAY
, 
LOG_LOCAL1
);

1737 
	`D
("Åes:%u",
Åes
);

1739 
pÜts
.
	`»size
(
Åes
+2);

1744 
oq
.
	`»size
(
Åes
+1);

1745 ià(
oq
.
	`size
()!=
Åes
+1) {

1746 
	`D
("failedo‡llocatehe core‡ffinity‡rray");

1747  
NULL
;

1750 
rxpÜt
 = &
pÜts
[
Åes
];

1751 
txpÜt
 = &
pÜts
[
Åes
+1];

1753 ià(
pÜts
.
	`size
()!=
Åes
+2) {

1754 
	`D
("failedo‡llocatehe stats‡rray");

1755  
NULL
;

1758 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1760 
ba£_»q
.
Ä_æags
 |ğ
NR_ACCEPT_VNET_HDR
;

1761 
rxpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_iâame
, &
ba£_»q
, 0, 
NULL
);

1763 ià(
rxpÜt
->
nmd
 =ğ
NULL
) {

1764 
	`D
("ÿÂÙ o³À%s", 
»cv_iâame
);

1765  
NULL
;

1767 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_iâame
,

1768 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
);

1771 
	`g‘_vÃt_hdr_Ën
(
rxpÜt
->
nmd
);

1772 
»cv_exŒa_bufs
 = 
rxpÜt
->
nmd
->
»q
.
Ä_rx_¦Ùs
;

1773 
»cv_b©ch
 = 
MAX_BATCH_RECV
;

1775 
	`mem£t
(&
ba£_»q
, 0, (base_req));

1776 
ba£_»q
.
Ä_¬g1
 = 
Åes
;

1777 
ba£_»q
.
Ä_¬g3
 = 
»cv_exŒa_bufs
;

1778 
txpÜt
->
nmd
 = 
	`nm_İ’
(
»cv_pes_iâame
, &
ba£_»q
, 0, 
NULL
);

1780 ià(
txpÜt
->
nmd
 =ğ
NULL
) {

1781 
	`D
("ÿÂÙ o³À%s", 
»cv_pes_iâame
);

1782  
NULL
;

1784 
	`D
("sucûssfuÎy o³Ãd % Ñx„šgs: %u)", 
»cv_pes_iâame
,

1785 
txpÜt
->
nmd
->
»q
.
Ä_tx_¦Ùs
);

1789 
rxpÜt
->
ršg
 = 
	`NETMAP_RXRING
ÔxpÜt->
nmd
->
niå
, 0);

1790 
txpÜt
->
ršg
 = 
	`NETMAP_TXRING
ÑxpÜt->
nmd
->
niå
, 0);

1792 
exŒa_bufs
 = 
txpÜt
->
nmd
->
»q
.
Ä_¬g3
;

1794 
	`D
("obšed %dƒxŒ¨bufãrs", 
exŒa_bufs
);

1795 ià(!
exŒa_bufs
)

1796 
run
;

1798 
ä“q
 = &
oq
[
Åes
];

1799 
rxpÜt
->
oq
 = 
NULL
;

1800 
txpÜt
->
oq
 = 
ä“q
;

1802 
	`¢´štf
(
ä“q
->
Çme
, 
MAX_IFNAMELEN
, "free queue");

1808 
rv
 = 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
;

1809 
rv
;

1810 
rv
 = *(
ušt32_t
 *)
	`NETMAP_BUF
(
txpÜt
->
ršg
,„v))

1812 
Ãtm­_¦Ù
 
s
;

1813 
s
.
buf_idx
 = 
rv
;

1814 
	`ND
("ä“q <- %d", 
s
.
buf_idx
);

1815 
ä“q
->
¦Ùs
.
	`push
(
s
);

1817 ià(
ä“q
->
¦Ùs
.
	`size
(è!ğ
exŒa_bufs
) {

1818 
	`D
("something went wrong:‚etmap„eported %uƒxtra_bufs, buthe free†ist contained %lu",

1819 
exŒa_bufs
, 
ä“q
->
¦Ùs
.
	`size
());

1820  
NULL
;

1822 
txpÜt
->
nmd
->
niå
->
ni_bufs_h—d
 = 0;

1824 
run
:

1825 
i
 = 0; i < 
Åes
; ++i) {

1826 
š‹rçû
[32];

1827 
	`¥rštf
(
š‹rçû
, "%s{%d", 
»cv_pes_iâame
, 
i
);

1828 
	`D
("İ’šg…Çmed %s", 
š‹rçû
);

1829 
pÜts
[
i
].
nmd
 = 
	`nm_İ’
(
š‹rçû
, 
NULL
, 0, 
txpÜt
->nmd);

1831 ià(
pÜts
[
i
].
nmd
 =ğ
NULL
) {

1832 
	`D
("ÿÂÙ o³À%s", 
š‹rçû
);

1833  
NULL
;

1835 
	`D
("successfully opened…ipe #%d %s (tx slots: %d)",

1836 
i
 + 1, 
š‹rçû
, 
pÜts
[i].
nmd
->
»q
.
Ä_tx_¦Ùs
);

1837 
pÜts
[
i
].
ršg
 = 
	`NETMAP_TXRING
ÕÜts[i].
nmd
->
niå
, 0);

1839 
	`D
("zerocopy %s",

1840 (
txpÜt
->
nmd
->
mem
 =ğ
pÜts
[
i
].nmd->mem) ? "enabled" : "disabled");

1842 ià(
exŒa_bufs
) {

1843 
ov”æow_queue
 *
q
 = &
oq
[
i
];

1844 
	`¢´štf
(
q
->
Çme
, 
MAX_IFNAMELEN
, "oq %d", 
i
);

1845 
pÜts
[
i
].
oq
 = 
q
;

1849 ià(!
exŒa_bufs
) {

1850 ià(!
oq
.
	`em±y
()) {

1851 
i
 = 0; i < 
Åes
 + 1; i++) {

1852 !
oq
[
i
].
¦Ùs
.
	`em±y
()) {

1853 
oq
[
i
].
¦Ùs
.
	`pİ
();

1855 
pÜts
[
i
].
oq
 = 
NULL
;

1857 
pÜts
[
i
].
oq
 = 
NULL
;

1858 
oq
.
	`ş—r
();

1860 
	`D
("*** overflow queues disabled ***");

1863 
»cv_exŒa_bufs
 = 
exŒa_bufs
;

1864 
»cv_ma¡”_nmd
 = 
txpÜt
->
nmd
;

1866 
	`¦“p
(2);

1868 !
§ã_to_¡¬t_»cv
) {

1869 
this_th»ad
::
	`y›ld
();

1872 
	`mem£t
(&
pŞlfd
, 0, (pollfd));

1874 #ifdef 
PRINT_STATS


1875 
i
 = 0; i < 
Åes
+2; ++i) {

1876 
	`mem£t
(&
pÜts
[
i
].
ùr
, 0, (
my_ùrs
));

1899 !
do_abÜt
) {

1900 
u_št
 
pŞli
 = 0;

1902 if(
™”
 =ğ
NO_OF_SAFE_ITR
) {

1903 
	`g‘timeofday
(&
begš_time_»cv
, 
NULL
);

1906 
™”
++;

1907 
i
 = 0; i < 
Åes
; ++i) {

1908 
Ãtm­_ršg
 *
ršg
 = 
pÜts
[
i
].ring;

1909 ià(
	`nm_ršg_Ãxt
(
ršg
,„šg->

è=ğršg->
cur
) {

1913 
pŞlfd
[
pŞli
].
fd
 = 
pÜts
[
i
].
nmd
->fd;

1914 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLOUT
;

1915 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1916 ++
pŞli
;

1918 
pŞlfd
[
pŞli
].
fd
 = 
rxpÜt
->
nmd
->fd;

1919 
pŞlfd
[
pŞli
].
ev’ts
 = 
POLLIN
;

1920 
pŞlfd
[
pŞli
].
»v’ts
 = 0;

1921 ++
pŞli
;

1923 
rv
 = 
	`pŞl
(
pŞlfd
, 
pŞli
, 10);

1924 ià(
rv
 <= 0) {

1925 ià(
rv
 < 0 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

1926 
	`RD
(1, "pŞÈ”rÜ %s", 
	`¡»¼Ü
(
”ºo
));

1930 ià(!
oq
.
	`em±y
()) {

1934 
i
 = 0; i < 
Åes
; i++) {

1935 
pÜt_des
 *
p
 = &
pÜts
[
i
];

1936 
ov”æow_queue
 *
q
 = 
p
->
oq
;

1937 
ušt32_t
 
j
, 
lim
;

1938 
Ãtm­_ršg
 *
ršg
;

1939 
Ãtm­_¦Ù
 *
¦Ù
;

1941 ià(
q
->
¦Ùs
.
	`em±y
())

1943 
ršg
 = 
p
->ring;

1944 
lim
 = 
	`nm_ršg_¥aû
(
ršg
);

1945 ià(!
lim
)

1947 ià(
q
->
¦Ùs
.
	`size
(è< 
lim
)

1948 
lim
 = 
q
->
¦Ùs
.
	`size
();

1949 
j
 = 0; j < 
lim
; j++) {

1950 
Ãtm­_¦Ù
 
s
 = 
q
->
¦Ùs
.
	`äÚt
();

1951 
q
->
¦Ùs
.
	`pİ
();

1952 
¦Ù
 = &
ršg
->¦Ù[ršg->
cur
];

1953 
ä“q
->
¦Ùs
.
	`push
(*
¦Ù
);

1954 *
¦Ù
 = 
s
;

1955 #ifdef 
PRINT_STATS


1956 
p
->
ùr
.
pkts
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
)*8;

1958 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

1959 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
s
.
Ën
 - 
vœt_hdr_Ën
);

1961 
¦Ù
->
æags
 |ğ
NS_BUF_CHANGED
;

1962 
ršg
->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

1964 
ršg
->
h—d
 =„šg->
cur
;

1968 
b©ch_cur
 = 0;

1969 
i
 = 
rxpÜt
->
nmd
->
fœ¡_rx_ršg
; i <ğrxpÜt->nmd->
Ï¡_rx_ršg
; i++) {

1970 
Ãtm­_ršg
 *
rxršg
 = 
	`NETMAP_RXRING
(
rxpÜt
->
nmd
->
niå
, 
i
);

1972 
Ãxt_cur
 = 
rxršg
->
cur
;

1973 
Ãtm­_¦Ù
 *
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

1974 cÚ¡ *
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

1975 
ršg¥aû
 = 
	`nm_ršg_¥aû
(
rxršg
);

1976 if(
ršg¥aû
>=
MAX_BATCH_RECV
) {

1977 
ršg¥aû
 = 
MAX_BATCH_RECV
;

1979 
ršg¥aû
--) {

1980 
ov”æow_queue
 *
q
;

1981 
Ãtm­_¦Ù
 *
rs
 = 
Ãxt_¦Ù
;

1982 cÚ¡ *
‹mpbuf
 = 
Ãxt_buf
;

1983 
udp_pkt
 *
pkt
ğ(udp_pkˆ*)(
Ãxt_buf
 + 
vœt_hdr_Ën
);

1985 ià(
	`uÆik–y
(
pkt
->
pkthdr
.

.
_d¡
.
s_addr
 !ğ
¤c_
.s_add¸|| 
	`Áohs
Õkt->pkthdr.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1987 ià(
	`uÆik–y
(
	`Áohs
(
pkt
->
pkthdr
.
eh
.
‘h”_ty³
è=ğ
ETHERTYPE_ARP
)) {

1988 
¬p_pkt
 *
¬µkt
 = (¬p_pkˆ*)
pkt
;

1990 if(
¬µkt
->
ah
.
rg‘_
 =ğ
¤c_
.
s_addr
) {

1992 ià(
	`Áohs
(
¬µkt
->
ah
.
İcode
è=ğ
ARPOP_REQUEST
) {

1994 
’queued_¬p_»q_th
.
	`’queue
(
¬µkt
->
ah
.
£nd”_
);

1996 
_mac_·œ
 
‹mp_·œ
;

1997 
‹mp_·œ
.

 = 
¬µkt
->
ah
.
£nd”_
;

1998 
	`memıy
(&
‹mp_·œ
.
mac
, (
‘h”_addr
 *)
¬µkt
->
ah
.
£nd”_mac
, 6);

1999 
Ãw_¬p_’Œ›s_th
.
	`’queue
(
‹mp_·œ
);

2002 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2003 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2004 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2005 
	`__butš_´eãtch
(
Ãxt_buf
);

2006 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2008 
b©ch_cur
++;

2009 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2010 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2011 
b©ch_cur
 = 0;

2034 
ušt32_t
 
ouut_pÜt
 = 0;

2035 if(
»cv_th»ad_cÜe
) {

2036 
ušt32_t
 
hash
 = 
	`pkt_hdr_hash
((cÚ¡ *)(
Ãxt_buf
+
vœt_hdr_Ën
), 4, 'B');

2037 
ouut_pÜt
 = 
hash
 % 
»cv_ouut_ršgs
;

2040 
Ãxt_cur
 = 
	`nm_ršg_Ãxt
(
rxršg
,‚ext_cur);

2041 
Ãxt_¦Ù
 = &
rxršg
->
¦Ù
[
Ãxt_cur
];

2042 
Ãxt_buf
 = 
	`NETMAP_BUF
(
rxršg
, 
Ãxt_¦Ù
->
buf_idx
);

2043 
	`__butš_´eãtch
(
Ãxt_buf
);

2044 
pÜt_des
 *
pÜt
 = &
pÜts
[
ouut_pÜt
];

2045 
Ãtm­_ršg
 *
ršg
 = 
pÜt
->ring;

2046 
Ãtm­_¦Ù
 
ä“_buf_¦Ù
;

2049 ià(
	`nm_ršg_¥aû
(
ršg
)) {

2050 
Ãtm­_¦Ù
 *
ts
 = &
ršg
->
¦Ù
[ršg->
cur
];

2051 *
cİy_buf
;

2052 
cİy_buf
 = 
	`NETMAP_BUF
(
ršg
, 
ts
->
buf_idx
);

2053 
ts
->
Ën
 = 
rs
->len;

2054 
	`nm_pkt_cİy
(
‹mpbuf
,
cİy_buf
,
ts
->
Ën
);

2056 
ršg
->
h—d
 =„šg->
cur
 = 
	`nm_ršg_Ãxt
(ring,„ing->cur);

2058 #ifdef 
PRINT_STATS


2059 
pÜt
->
ùr
.
pkts
+=(
ts
->
Ën
 - 
vœt_hdr_Ën
)*8;

2062 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2063 
»cv_¡©s
[
i
].
fÜw¬ded
 +ğ(
ts
->
Ën
 - 
vœt_hdr_Ën
);

2066 
fÜw¬d
;

2070 ià(
oq
.
	`em±y
(è|| !
ä“q
->
¦Ùs
.
	`size
()) {

2071 #ifdef 
PRINT_STATS


2072 
pÜt
->
ùr
.
drİ
+=(
rs
->
Ën
 - 
vœt_hdr_Ën
)*8;

2074 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2075 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
rs
->
Ën
 - 
vœt_hdr_Ën
);

2077 
Ãxt
;

2080 
q
 = &
oq
[
ouut_pÜt
];

2082 ià(!
ä“q
->
¦Ùs
.
	`size
()) {

2084 
ušt32_t
 
j
;

2085 
pÜt_des
 *
Í
 = &
pÜts
[0];

2086 
ušt32_t
 
max
 = 
Í
->
oq
->
¦Ùs
.
	`size
();

2088 
j
 = 1; j < 
Åes
; j++) {

2089 
pÜt_des
 *
ı
 = &
pÜts
[
j
];

2090 ià(
ı
->
oq
->
¦Ùs
.
	`size
(è> 
max
) {

2091 
Í
 = 
ı
;

2092 
max
 = 
ı
->
oq
->
¦Ùs
.
	`size
();

2097 
j
 = 0; 
Í
->
oq
->
¦Ùs
.
	`size
(è&& j < 
BUF_REVOKE
; j++) {

2098 
Ãtm­_¦Ù
 
tmp
 = 
Í
->
oq
->
¦Ùs
.
	`äÚt
();

2099 #ifdef 
PRINT_STATS


2100 
Í
->
ùr
.
drİ
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
)*8;

2102 if(
™”
 >ğ
NO_OF_SAFE_ITR
) {

2103 
»cv_¡©s
[
i
].
drİ³d
 +ğ(
tmp
.
Ën
 - 
vœt_hdr_Ën
);

2106 
Í
->
oq
->
¦Ùs
.
	`pİ
();

2107 
ä“q
->
¦Ùs
.
	`push
(
tmp
);

2110 
	`ND
(1, "»voked %d bufãr äom %s", 
j
, 
lq
->
Çme
);

2113 
ä“_buf_¦Ù
 = 
ä“q
->
¦Ùs
.
	`äÚt
();

2114 
ä“q
->
¦Ùs
.
	`pİ
();

2116 *
‹mp_buf
;

2117 
‹mp_buf
 = 
	`NETMAP_BUF
(
txpÜt
->
ršg
, 
ä“_buf_¦Ù
.
buf_idx
);

2118 
ä“_buf_¦Ù
.
Ën
 = 
rs
->len;

2119 
	`nm_pkt_cİy
(
‹mpbuf
,
‹mp_buf
,
ä“_buf_¦Ù
.
Ën
);

2120 
q
->
¦Ùs
.
	`push
(
ä“_buf_¦Ù
);

2122 
fÜw¬d
:

2124 
Ãxt
:

2125 
rxršg
->
h—d
 =„xršg->
cur
 = 
Ãxt_cur
;

2127 
b©ch_cur
++;

2128 ià(
	`uÆik–y
(
b©ch_cur
 >ğ
»cv_b©ch
)) {

2129 
	`ioùl
(
rxpÜt
->
nmd
->
fd
, 
NIOCRXSYNC
, 
NULL
);

2130 
b©ch_cur
 = 0;

2137 ià(
exŒa_bufs
) {

2138 
	`ä“_bufãrs
(
pÜts
);

2140 
	`¦“p
(5);

2141 
i
 = 0; i < (
u_št
)
»cv_ouut_ršgs
 + 2; ++i) {

2142 
	`nm_şo£
(
pÜts
[
i
].
nmd
);

2145  
NULL
;

2146 
	}
}

2150 
u_št16_t


2151 
	$w¿psum
(
u_št32_t
 
sum
)

2153 
sum
 = ~sum & 0xFFFF;

2154  (
	`htÚs
(
sum
));

2155 
	}
}

2158 
	gN‘m­U£
::
	$sourû_hwaddr
(*
iâame
)

2160 
s
;

2161 
iäeq
 
bufãr
;

2162 
s
 = 
	`sock‘
(
PF_INET
, 
SOCK_DGRAM
, 0);

2164 
	`mem£t
(&
bufãr
, 0x00, (buffer));

2165 
	`¡rıy
(
bufãr
.
iä_Çme
, 
iâame
+7);

2167 
	`ioùl
(
s
, 
SIOCGIFHWADDR
, &
bufãr
);

2169 
	`şo£
(
s
);

2170 
	`¥rštf
(
¤c_‘h_addr
, "%02x:%02x:%02x:%02x:%02x:%02x",

2171 ()
bufãr
.
iä_hwaddr
.
§_d©a
[0], ()buffer.ifr_hwaddr.sa_data[1], ()buffer.ifr_hwaddr.sa_data[2],

2172 ()
bufãr
.
iä_hwaddr
.
§_d©a
[3], ()buffer.ifr_hwaddr.sa_data[4], ()buffer.ifr_hwaddr.sa_data[5]);

2173 
	`D
("sourû hwadd¸% %d", 
¤c_‘h_addr
,()
	`¡¾’
(src_eth_addr));

2174 
fd
;

2175 
iäeq
 
iä
;

2177 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

2180 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

2183 
	`¡ºıy
(
iä
.
iä_Çme
, 
iâame
+7, 
IFNAMSIZ
-1);

2185 
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iä
);

2187 
	`şo£
(
fd
);

2190 
¤c_
 = ((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
;

2191 
	`¡rıy
(
¤c__addr
, 
	`š‘_Áß
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
));

2192 
cout
<<"Sourû ip:"<<
¤c__addr
<<
’dl
;

2195 
¬±abË
[
¤c_
.
s_addr
] = *
	`‘h”_©Ú
(
¤c_‘h_addr
);

2196 if(
¬±abË
.
	`fšd
(
¤c_
.
s_addr
)!÷½bË.
	`’d
()) {

2197 
	`D
("Hurray 1");

2200 
š_addr
 
©t
;

2201 
	`š‘_©Ú
("169.254.9.28", &
©t
);

2203 
¬±abË
[
©t
.
s_addr
] = *
	`‘h”_©Ú
("00:aa:bb:cc:dd:07");

2204 if(
¬±abË
.
	`fšd
(
©t
.
s_addr
)!÷½bË.
	`’d
()) {

2205 
	`D
("Hurray 2");

2206 
	`D
("%s",
	`‘h”_Áß
(&
¬±abË
[
©t
.
s_addr
]));

2209 
	}
}

	@netmap_module.cpp

2 
	~"io_moduË.h
"

3 #iâdeà
DISABLE_NETMAP


5 
	~"mtı.h
"

7 
	~<”ºo.h
>

9 
	~"debug.h
"

11 
	~"cÚfig.h
"

15 
	~"Ãtm­_­i.h
"

17 
	~<sys/pŞl.h
>

18 
	~<io¡»am
>

19 
usšg
 
Çme¥aû
 
	g¡d
;

21 
	#MAX_PKT_BURST
 64

	)

22 
	#ETHERNET_FRAME_SIZE
 1514

	)

23 
	#MAX_IFNAMELEN
 (
IF_NAMESIZE
 + 10)

	)

24 
	#EXTRA_BUFS
 512

	)

25 
	#IDLE_POLL_WAIT
 1

	)

26 
	#IDLE_POLL_COUNT
 10

	)

30 
	sÃtm­_´iv©e_cÚ‹xt
 {

31 
nm_desc
 *
	mloÿl_nmd
[
MAX_DEVICES
];

32 
	m¢d_pktbuf
[
MAX_DEVICES
][
ETHERNET_FRAME_SIZE
];

33 *
	mrcv_pktbuf
[
MAX_PKT_BURST
];

34 
ušt16_t
 
	mrcv_pkt_Ën
[
MAX_PKT_BURST
];

35 
ušt16_t
 
	m¢d_pkt_size
[
MAX_DEVICES
];

36 
ušt8_t
 
	mdev_pŞl_æag
[
MAX_DEVICES
];

37 
ušt8_t
 
	midË_pŞl_couÁ
;

38 } 
__©Œibu‹__
((
®igÃd
(
__WORDSIZE
)));

41 
	$Ãtm­_š™_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

43 
Ãtm­_´iv©e_cÚ‹xt
 *
Åc
;

44 
iâame
[
MAX_IFNAMELEN
];

45 
niâame
[
MAX_IFNAMELEN
];

46 
j
;

49 
ùxt
->
io_´iv©e_cÚ‹xt
 = 
	`ÿÎoc
(1, (
Ãtm­_´iv©e_cÚ‹xt
));

50 ià(
ùxt
->
io_´iv©e_cÚ‹xt
 =ğ
NULL
) {

51 
	`TRACE_ERROR
("Failedo initialize ctxt->io_private_context: "

53 
	`ex™
(
EXIT_FAILURE
);

56 
Åc
 = (
Ãtm­_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

87 
	}
}

90 
	$Ãtm­_lšk_deviûs
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

95 
	}
}

98 
	$Ãtm­_»Ëa£_pkt
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, *
pkt_d©a
, 
Ën
)

104 
	}
}

107 
	$Ãtm­_£nd_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
)

109 
pkt_size
, 
idx
;

110 
Ãtm­_´iv©e_cÚ‹xt
 *
Åc
;

111 
mtı_mªag”_t
 
mtı
;

113 
Åc
 = (
Ãtm­_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

114 
idx
 = 
nif
;

115 
pkt_size
 = 
Åc
->
¢d_pkt_size
[
idx
];

116 
mtı
 = 
ùxt
->
mtı_mªag”
;

119 ià(
pkt_size
 == 0)  0;

121 #ifdeà
NETSTAT


122 
mtı
->
n¡©
.
tx_·ck‘s
[
nif
]++;

123 
mtı
->
n¡©
.
tx_by‹s
[
nif
] +ğ
pkt_size
 + 24;

139 
Åc
->
¢d_pkt_size
[
idx
] = 0;

141 
Ãtm­u£
.
	`syncbuáx
(
ùxt
->
ıu
);

144 
	}
}

146 
ušt8_t
 *

147 
	$Ãtm­_g‘_w±r
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
, 
ušt16_t
 
pktsize
)

149 
Ãtm­_´iv©e_cÚ‹xt
 *
Åc
;

150 
idx
 = 
nif
;

152 
Åc
 = (
Ãtm­_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

153 ià(
Åc
->
¢d_pkt_size
[
idx
] != 0)

154 
	`Ãtm­_£nd_pkts
(
ùxt
, 
nif
);

156 
Åc
->
¢d_pkt_size
[
idx
] = 
pktsize
;

158  (
ušt8_t
 *è
Ãtm­u£
.
	`g‘_bufãr_tx
(
ùxt
->
ıu
);

160 
	}
}

162 
št32_t


163 
	$Ãtm­_»cv_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
)

165 
couÁ
 = 0;

166 
Ãtm­u£
.
	`g‘_bufãr_rx
(
ùxt
->
ıu
,
couÁ
);

167  
couÁ
;

168 
	}
}

170 
ušt8_t
 *

171 
	$Ãtm­_g‘_½Œ
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, 
šdex
, 
ušt16_t
 *
Ën
)

173 
Ën_h”e
;

174  (
ušt8_t
 *è
Ãtm­u£
.
	`g‘_bufãr_rx
(
ùxt
->
ıu
,
šdex
);

175 *
Ën
 = (
ušt16_t
 *è
Ën_h”e
;

181 
	}
}

183 
št32_t


184 
	$Ãtm­_£Ëù
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

186 
i
, 
rc
;

187 
pŞlfd
 
pfd
[
MAX_DEVICES
];

188 
Ãtm­_´iv©e_cÚ‹xt
 *
Åc
 =

189 (
Ãtm­_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

192 ià(
Åc
->
loÿl_nmd
[0] =ğ
NULL
)

195 
i
 = 0; i < 
num_deviûs_©ched
; i++) {

196 
pfd
[
i
].
fd
 = 
Åc
->
loÿl_nmd
[i]->fd;

197 
pfd
[
i
].
ev’ts
 = 
POLLIN
;

200 #iâdeà
CONST_POLLING


201 ià(
Åc
->
idË_pŞl_couÁ
 >ğ
IDLE_POLL_COUNT
) {

202 
rc
 = 
	`pŞl
(
pfd
, 
num_deviûs_©ched
, 
IDLE_POLL_WAIT
);

206 
rc
 = 
	`pŞl
(
pfd
, 
num_deviûs_©ched
, 0);

209 
Åc
->
idË_pŞl_couÁ
 = (
rc
 == 0) ? (npc->idle_poll_count + 1) : 0;

211 
i
 = 0; 
rc
 > 0 && i < 
num_deviûs_©ched
; i++)

212 ià(!(
pfd
[
i
].
»v’ts
 & (
POLLERR
)))

213 
Åc
->
dev_pŞl_æag
[
i
] = 1;

215 
	}
}

218 
	$Ãtm­_de¡roy_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

220 
	}
}

223 
	$Ãtm­_lßd_moduË
()

226 
	}
}

230 
io_moduË_func
 
	gÃtm­_moduË_func
 = {

231 
lßd_moduË
 : 
Ãtm­_lßd_moduË
,

232 
š™_hªdË
 : 
Ãtm­_š™_hªdË
,

233 
lšk_deviûs
 : 
Ãtm­_lšk_deviûs
,

234 
»Ëa£_pkt
 : 
Ãtm­_»Ëa£_pkt
,

235 
g‘_w±r
 : 
Ãtm­_g‘_w±r
,

236 
£nd_pkts
 : 
Ãtm­_£nd_pkts
,

237 
g‘_½Œ
 : 
Ãtm­_g‘_½Œ
,

238 
»cv_pkts
 : 
Ãtm­_»cv_pkts
,

239 
£Ëù
 : 
Ãtm­_£Ëù
,

240 
de¡roy_hªdË
 : 
Ãtm­_de¡roy_hªdË
,

241 
dev_ioùl
 : 
NULL


246 
io_moduË_func
 
	gÃtm­_moduË_func
 = {

247 .
lßd_moduË
 = 
NULL
,

248 .
	gš™_hªdË
 = 
NULL
,

249 .
	glšk_deviûs
 = 
NULL
,

250 .
	g»Ëa£_pkt
 = 
NULL
,

251 .
	g£nd_pkts
 = 
NULL
,

252 .
	gg‘_w±r
 = 
NULL
,

253 .
	g»cv_pkts
 = 
NULL
,

254 .
	gg‘_½Œ
 = 
NULL
,

255 .
	g£Ëù
 = 
NULL
,

256 .
	gde¡roy_hªdË
 = 
NULL
,

257 .
	gdev_ioùl
 = 
NULL


	@pipe.cpp

1 
	~<±h»ad.h
>

2 
	~<”ºo.h
>

4 
	~"pe.h
"

5 
	~"ev’Şl.h
"

6 
	~"tı_¡»am.h
"

7 
	~"mtı.h
"

8 
	~"debug.h
"

10 
	#PIPE_BUF_SIZE
 10240

	)

12 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

13 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

16 
	epe_¡©e


18 
	mPIPE_CLOSED
,

19 
	mPIPE_ACTIVE
,

20 
	mPIPE_CLOSE_WAIT
,

23 
	spe


25 
	m¡©e
;

26 
sock‘_m­_t
 
	msock‘
[2];

28 *
	mbuf
;

29 
	mbuf_off
;

30 
	mbuf_
;

31 
	mbuf_Ën
;

32 
	mbuf_size
;

34 
±h»ad_mu‹x_t
 
	mpe_lock
;

35 
±h»ad_cÚd_t
 
	mpe_cÚd
;

39 
	$mtı_pe
(
mùx_t
 
mùx
, 
peid
[2])

41 
sock‘_m­_t
 
sock‘
[2];

42 
pe
 *
µ
;

43 
»t
;

45 
sock‘
[0] = 
	`AÎoÿ‹Sock‘
(
mùx
, 
MTCP_SOCK_PIPE
, 
FALSE
);

46 ià(!
sock‘
[0]) {

47 
”ºo
 = 
ENFILE
;

50 
sock‘
[1] = 
	`AÎoÿ‹Sock‘
(
mùx
, 
MTCP_SOCK_PIPE
, 
FALSE
);

51 ià(!
sock‘
[1]) {

52 
	`F»eSock‘
(
mùx
, 
sock‘
[0]->
id
, 
FALSE
);

53 
”ºo
 = 
ENFILE
;

57 
µ
 = (
pe
 *)
	`ÿÎoc
(1, (pipe));

58 ià(!
µ
) {

60 
	`F»eSock‘
(
mùx
, 
sock‘
[0]->
id
, 
FALSE
);

61 
	`F»eSock‘
(
mùx
, 
sock‘
[1]->
id
, 
FALSE
);

65 
µ
->
buf_size
 = 
PIPE_BUF_SIZE
;

66 
µ
->
buf
 = (*)
	`m®loc
Õp->
buf_size
);

67 ià(!
µ
->
buf
) {

69 
	`F»eSock‘
(
mùx
, 
sock‘
[0]->
id
, 
FALSE
);

70 
	`F»eSock‘
(
mùx
, 
sock‘
[1]->
id
, 
FALSE
);

71 
	`ä“
(
µ
);

75 
»t
 = 
	`±h»ad_mu‹x_š™
(&
µ
->
pe_lock
, 
NULL
);

76 ià(
»t
) {

78 
	`F»eSock‘
(
mùx
, 
sock‘
[0]->
id
, 
FALSE
);

79 
	`F»eSock‘
(
mùx
, 
sock‘
[1]->
id
, 
FALSE
);

80 
	`ä“
(
µ
->
buf
);

81 
	`ä“
(
µ
);

85 
»t
 = 
	`±h»ad_cÚd_š™
(&
µ
->
pe_cÚd
, 
NULL
);

86 ià(
»t
) {

88 
	`F»eSock‘
(
mùx
, 
sock‘
[0]->
id
, 
FALSE
);

89 
	`F»eSock‘
(
mùx
, 
sock‘
[1]->
id
, 
FALSE
);

90 
	`ä“
(
µ
->
buf
);

91 
	`ä“
(
µ
);

92 
	`±h»ad_mu‹x_de¡roy
(&
µ
->
pe_lock
);

96 
µ
->
¡©e
 = 
PIPE_ACTIVE
;

97 
µ
->
sock‘
[0] = socket[0];

98 
µ
->
sock‘
[1] = socket[1];

99 
sock‘
[0]->
µ
 =…p;

100 
sock‘
[1]->
µ
 =…p;

102 
peid
[0] = 
sock‘
[0]->
id
;

103 
peid
[1] = 
sock‘
[1]->
id
;

107 
	}
}

110 
	$Rai£Ev’tToPaœ
(
mtı_mªag”_t
 
mtı
, 
sock‘_m­_t
 
sock‘
, 
ušt32_t
 
ev’t
)

112 
pe
 *
µ
 = 
sock‘
->pp;

113 
sock‘_m­_t
 
·œ_sock‘
;

115 ià(
µ
->
sock‘
[0] == socket)

116 
·œ_sock‘
 = 
µ
->
sock‘
[1];

118 
·œ_sock‘
 = 
µ
->
sock‘
[0];

120 ià(
·œ_sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

121 ià(
·œ_sock‘
->
•Şl
) {

122 
	`AddEpŞlEv’t
(
mtı
->
•
, 
USR_EVENT_QUEUE
, 
·œ_sock‘
, 
ev’t
);

125 
	`±h»ad_cÚd_sigÇl
(&
µ
->
pe_cÚd
);

127 
	}
}

130 
	$PeR—d
(
mùx_t
 
mùx
, 
peid
, *
buf
, 
Ën
)

132 
mtı_mªag”_t
 
mtı
;

133 
sock‘_m­_t
 
sock‘
;

134 
pe
 *
µ
;

135 
to_»ad
;

136 
to_nÙify
;

137 
»t
;

139 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

140 ià(!
mtı
) {

143 
sock‘
 = 
	`G‘Sock‘
(
mùx
, 
peid
);

144 ià(!
sock‘
) {

147 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_PIPE
) {

148 
”ºo
 = 
EBADF
;

151 
µ
 = 
sock‘
->pp;

152 ià(!
µ
) {

153 
”ºo
 = 
EBADF
;

156 ià(
µ
->
¡©e
 =ğ
PIPE_CLOSED
) {

157 
”ºo
 = 
EINVAL
;

160 ià(
µ
->
¡©e
 =ğ
PIPE_CLOSE_WAIT
 &&…p->
buf_Ën
 == 0) {

164 ià(
Ën
 <= 0) {

165 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

166 
”ºo
 = 
EAGAIN
;

173 
	`±h»ad_mu‹x_lock
(&
µ
->
pe_lock
);

174 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

175 
µ
->
buf_Ën
 == 0) {

176 
»t
 = 
	`±h»ad_cÚd_wa™
(&
µ
->
pe_cÚd
, &µ->
pe_lock
);

177 ià(
»t
) {

179 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

185 
to_»ad
 = 
	`MIN
(
Ën
, 
µ
->
buf_Ën
);

186 ià(
to_»ad
 <= 0) {

187 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

188 ià(
µ
->
¡©e
 =ğ
PIPE_ACTIVE
) {

189 
”ºo
 = 
EAGAIN
;

191 } ià(
µ
->
¡©e
 =ğ
PIPE_CLOSE_WAIT
) {

197 
to_nÙify
 = 
FALSE
;

198 ià(
µ
->
buf_Ën
 =ğµ->
buf_size
)

199 
to_nÙify
 = 
TRUE
;

201 ià(
µ
->
buf_off
 + 
to_»ad
 <…p->
buf_size
) {

202 
	`memıy
(
buf
, 
µ
->buà+…p->
buf_off
, 
to_»ad
);

203 
µ
->
buf_off
 +ğ
to_»ad
;

205 
‹mp_»ad
 = 
µ
->
buf_size
 -…p->
buf_off
;

206 
	`memıy
(
buf
, 
µ
->buà+…p->
buf_off
, 
‹mp_»ad
);

207 
	`memıy
(
buf
 + 
‹mp_»ad
, 
µ
->buf, 
to_»ad
 -emp_read);

208 
µ
->
buf_off
 = 
to_»ad
 - 
‹mp_»ad
;

210 
µ
->
buf_Ën
 -ğ
to_»ad
;

213 ià(
to_nÙify
) {

214 
	`Rai£Ev’tToPaœ
(
mtı
, 
sock‘
, 
MTCP_EPOLLOUT
);

217 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

220 ià(
µ
->
buf_Ën
 > 0) {

221 ià((
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
è&& !(sock‘->•ŞÈ& 
MTCP_EPOLLET
)) {

222 
	`AddEpŞlEv’t
(
mtı
->
•
,

223 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

225 } ià(
µ
->
¡©e
 =ğ
PIPE_CLOSE_WAIT
 &&…p->
buf_Ën
 == 0) {

226 
	`AddEpŞlEv’t
(
mtı
->
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

229  
to_»ad
;

230 
	}
}

233 
	$PeWr™e
(
mùx_t
 
mùx
, 
peid
, cÚ¡ *
buf
, 
Ën
)

235 
mtı_mªag”_t
 
mtı
;

236 
sock‘_m­_t
 
sock‘
;

237 
pe
 *
µ
;

238 
to_wr™e
;

239 
to_nÙify
;

240 
»t
;

242 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

243 ià(!
mtı
) {

246 
sock‘
 = 
	`G‘Sock‘
(
mùx
, 
peid
);

247 ià(!
sock‘
) {

250 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_PIPE
) {

251 
”ºo
 = 
EBADF
;

254 
µ
 = 
sock‘
->pp;

255 ià(!
µ
) {

256 
”ºo
 = 
EBADF
;

259 ià(
µ
->
¡©e
 =ğ
PIPE_CLOSED
) {

260 
”ºo
 = 
EINVAL
;

263 ià(
µ
->
¡©e
 =ğ
PIPE_CLOSE_WAIT
) {

264 
”ºo
 = 
EPIPE
;

268 ià(
Ën
 <= 0) {

269 ià(
sock‘
->
İts
 & 
MTCP_NONBLOCK
) {

270 
”ºo
 = 
EAGAIN
;

277 
	`±h»ad_mu‹x_lock
(&
µ
->
pe_lock
);

278 ià(!(
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

279 
µ
->
buf_Ën
 =ğµ->
buf_size
) {

280 
»t
 = 
	`±h»ad_cÚd_wa™
(&
µ
->
pe_cÚd
, &µ->
pe_lock
);

281 ià(
»t
) {

283 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

289 
to_wr™e
 = 
	`MIN
(
Ën
, 
µ
->
buf_size
 -…p->
buf_Ën
);

290 ià(
to_wr™e
 <= 0) {

291 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

292 
”ºo
 = 
EAGAIN
;

297 
to_nÙify
 = 
FALSE
;

298 ià(
µ
->
buf_Ën
 == 0)

299 
to_nÙify
 = 
TRUE
;

301 ià(
µ
->
buf_
 + 
to_wr™e
 <…p->
buf_size
) {

303 
	`memıy
(
µ
->
buf
 +…p->
buf_
, buf, 
to_wr™e
);

304 
µ
->
buf_
 +ğ
to_wr™e
;

307 
‹mp_wr™e
 = 
µ
->
buf_size
 -…p->
buf_
;

308 
	`memıy
(
µ
->
buf
 +…p->
buf_
, buf, 
‹mp_wr™e
);

309 
	`memıy
(
µ
->
buf
, buà+ 
‹mp_wr™e
, 
to_wr™e
 -emp_write);

310 
µ
->
buf_
 = 
to_wr™e
 - 
‹mp_wr™e
;

312 
µ
->
buf_Ën
 +ğ
to_wr™e
;

315 ià(
to_nÙify
) {

316 
	`Rai£Ev’tToPaœ
(
mtı
, 
sock‘
, 
MTCP_EPOLLIN
);

319 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

322 ià(
µ
->
buf_Ën
 <…p->
buf_size
) {

323 ià((
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
è&& !(sock‘->•ŞÈ& 
MTCP_EPOLLET
)) {

324 
	`AddEpŞlEv’t
(
mtı
->
•
,

325 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLOUT
);

329  
to_wr™e
;

330 
	}
}

333 
	$Rai£P’dšgPeEv’ts
(
mùx_t
 
mùx
, 
•id
, 
peid
)

335 
mtı_•Şl
 *
•
 = 
	`G‘Sock‘
(
mùx
, 
•id
)->ep;

336 
sock‘_m­_t
 
sock‘
 = 
	`G‘Sock‘
(
mùx
, 
peid
);

337 
pe
 *
µ
 = 
sock‘
->pp;

339 ià(!
µ
)

341 ià(
µ
->
¡©e
 < 
PIPE_ACTIVE
)

346 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

347 ià(
µ
->
buf_Ën
 > 0) {

348 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

349 } ià(
µ
->
¡©e
 =ğ
PIPE_CLOSE_WAIT
) {

350 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLIN
);

355 ià(
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
) {

356 ià(
µ
->
buf_Ën
 <…p->
buf_size
) {

357 
	`AddEpŞlEv’t
(
•
, 
USR_SHADOW_EVENT_QUEUE
, 
sock‘
, 
MTCP_EPOLLOUT
);

362 
	}
}

365 
	$PeClo£
(
mùx_t
 
mùx
, 
peid
)

367 
mtı_mªag”_t
 
mtı
;

368 
sock‘_m­_t
 
sock‘
;

369 
pe
 *
µ
;

371 
mtı
 = 
	`G‘MTCPMªag”
(
mùx
);

372 ià(!
mtı
) {

375 
sock‘
 = 
	`G‘Sock‘
(
mùx
, 
peid
);

376 ià(!
sock‘
) {

379 ià(
sock‘
->
sockty³
 !ğ
MTCP_SOCK_PIPE
) {

380 
”ºo
 = 
EINVAL
;

383 
µ
 = 
sock‘
->pp;

384 ià(!
µ
) {

388 ià(
µ
->
¡©e
 =ğ
PIPE_CLOSED
) {

392 
	`±h»ad_mu‹x_lock
(&
µ
->
pe_lock
);

393 ià(
µ
->
¡©e
 =ğ
PIPE_ACTIVE
) {

394 
µ
->
¡©e
 = 
PIPE_CLOSE_WAIT
;

395 
	`Rai£Ev’tToPaœ
(
mtı
, 
sock‘
, 
MTCP_EPOLLIN
);

396 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

402 ià(
µ
->
sock‘
[0])

403 
µ
->
sock‘
[0]->µ = 
NULL
;

404 ià(
µ
->
sock‘
[1])

405 
µ
->
sock‘
[1]->µ = 
NULL
;

407 
	`±h»ad_mu‹x_uÆock
(&
µ
->
pe_lock
);

409 
	`±h»ad_mu‹x_de¡roy
(&
µ
->
pe_lock
);

410 
	`±h»ad_cÚd_de¡roy
(&
µ
->
pe_cÚd
);

412 
	`ä“
(
µ
->
buf
);

414 
	`ä“
(
µ
);

417 
	}
}

	@psio_module.cpp

2 
	~"io_moduË.h
"

3 #iâdeà
DISABLE_PSIO


5 
	~"mtı.h
"

7 
	~"ps.h
"

9 
	~<”ºo.h
>

11 
	~"debug.h
"

13 
	~"cÚfig.h
"

15 
	#PS_CHUNK_SIZE
 64

	)

16 
	#PS_SELECT_TIMEOUT
 100

	)

18 
	spsio_´iv©e_cÚ‹xt
 {

19 
ps_hªdË
 
	mhªdË
;

20 
ps_chunk_buf
 
	mw_chunk_buf
[
ETH_NUM
];

21 
ps_chunk
 
	mchunk
;

22 
ps_ev’t
 
	mev’t
;

24 
nids_£t
 
	mrx_ava
;

25 
nids_£t
 
	mtx_ava
;

26 
timev®
 
	mÏ¡_tx_£t
[
ETH_NUM
];

27 } 
__©Œibu‹__
((
®igÃd
(
__WORDSIZE
)));

30 
	$psio_š™_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

32 
i
, 
»t
;

33 
psio_´iv©e_cÚ‹xt
 *
µc
;

34 
timev®
 
cur_ts
;

37 
ùxt
->
io_´iv©e_cÚ‹xt
 = 
	`ÿÎoc
(1, (
psio_´iv©e_cÚ‹xt
));

38 ià(
ùxt
->
io_´iv©e_cÚ‹xt
 =ğ
NULL
) {

39 
	`TRACE_ERROR
("Failedo initialize ctxt->io_private_context: "

41 
	`ex™
(
EXIT_FAILURE
);

44 
µc
 = (
psio_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

45 ià(
	`ps_š™_hªdË
(&
µc
->
hªdË
)) {

46 
	`³¼Ü
("ps_init_handle");

47 
	`TRACE_ERROR
("Failedo initialize…s handle.\n");

48 
	`ex™
(
EXIT_FAILURE
);

52 ià(
	`ps_®loc_chunk
(&
µc
->
hªdË
, &µc->
chunk
) != 0) {

53 
	`³¼Ü
("ps_alloc_chunk");

54 
	`TRACE_ERROR
("Failedo‡llocate…s_chunk\n");

55 
	`ex™
(
EXIT_FAILURE
);

59 
i
 = 0; i < 
num_deviûs_©ched
; i++) {

60 
»t
 = 
	`ps_®loc_chunk_buf
(&
µc
->
hªdË
, 
i
, 
ùxt
->
ıu
, &µc->
w_chunk_buf
[i]);

61 ià(
»t
 != 0) {

62 
	`TRACE_ERROR
("Failedo‡llocate…s_chunk_buf.\n");

63 
	`ex™
(
EXIT_FAILURE
);

67 
	`g‘timeofday
(&
cur_ts
, 
NULL
);

70 
µc
->
chunk
.
»cv_blockšg
 = 0;

71 
µc
->
ev’t
.
timeout
 = 
PS_SELECT_TIMEOUT
;

72 
µc
->
ev’t
.
qidx
 = 
ùxt
->
ıu
;

73 
	`NID_ZERO
(
µc
->
ev’t
.
rx_nids
);

74 
	`NID_ZERO
(
µc
->
ev’t
.
tx_nids
);

75 
	`NID_ZERO
(
µc
->
rx_ava
);

78 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

79 
µc
->
Ï¡_tx_£t
[
i
] = 
cur_ts
;

80 
	`NID_SET
(
i
, 
µc
->
tx_ava
);

82 
	}
}

85 
	$psio_lšk_deviûs
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

87 
psio_´iv©e_cÚ‹xt
 *
µc
;

88 
»t
;

89 
i
, 
wÜkšg
;

91 
µc
 = (
psio_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

92 
wÜkšg
 = -1;

95 
i
 = 0 ; i < 
num_deviûs_©ched
 ; i++) {

96 
ps_queue
 
queue
;

97 
queue
.
ifšdex
 = 
deviûs_©ched
[
i
];

99 ià(
deviûs
[
deviûs_©ched
[
i
]].
num_rx_queues
 <ğ
ùxt
->
ıu
) {

103 
wÜkšg
 = 0;

104 
queue
.
ifšdex
 = 
deviûs_©ched
[
i
];

105 
queue
.
qidx
 = 
ùxt
->
ıu
;

108 
	`TRACE_DBG
("attaching RX queue xge%d:%do CPU%d\n",

109 
queue
.
ifšdex
, queue.
qidx
, 
mtı
->
ùxt
->
ıu
);

111 
»t
 = 
	`ps_©ch_rx_deviû
(&
µc
->
hªdË
, &
queue
);

112 ià(
»t
 != 0) {

113 
	`³¼Ü
("ps_attach_rx_device");

114 
	`ex™
(1);

118  
wÜkšg
;

119 
	}
}

122 
	$psio_»Ëa£_pkt
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, *
pkt_d©a
, 
Ën
)

124 
psio_´iv©e_cÚ‹xt
 *
µc
;

125 
ps_·ck‘
 
·ck‘
;

127 
µc
 = (
psio_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

129 
·ck‘
.
ifšdex
 = 
ifidx
;

130 
·ck‘
.
Ën
 =†en;

131 
·ck‘
.
buf
 = (*)
pkt_d©a
;

132 
	`ps_¦ow·th_·ck‘
(&
µc
->
hªdË
, &
·ck‘
);

133 
	}
}

136 
	$psio_æush_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùx
, 
nif
)

138 
ps_chunk_buf
 *
c_buf
;

139 
mtı_mªag”_t
 
mtı
;

140 
psio_´iv©e_cÚ‹xt
 *
µc
;

141 
£nd_út
, 
to_£nd_út
 = 0;

142 
¡¬t_idx
, 
i
;

144 
µc
 = (
psio_´iv©e_cÚ‹xt
 *)
ùx
->
io_´iv©e_cÚ‹xt
;

145 
c_buf
 = &
µc
->
w_chunk_buf
[
nif
];

146 
mtı
 = 
ùx
->
mtı_mªag”
;

149 ià(!
c_buf
)

152 
to_£nd_út
 = 
c_buf
->
út
;

153 ià(
to_£nd_út
 > 0) {

154 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_tx_Œy
);

155 
¡¬t_idx
 = 
c_buf
->
Ãxt_to_£nd
;

156 
£nd_út
 = 
	`ps_£nd_chunk_buf
(&
µc
->
hªdË
, 
c_buf
);

158 
i
 = 0; i < 
£nd_út
; i++) {

159 #ifdeà
NETSTAT


160 
mtı
->
n¡©
.
tx_by‹s
[
nif
] +ğ
c_buf
->
šfo
[
¡¬t_idx
].
Ën
 + 24;

162 #ià
PKTDUMP


163 
	`DumpPack‘
(
mtı
, 
c_buf
->
buf
 + c_buf->
šfo
[
¡¬t_idx
].
off£t
,

164 
c_buf
->
šfo
[
¡¬t_idx
].
Ën
, "OUT", 
nif
);

167 
¡¬t_idx
 = (¡¬t_idx + 1è% 
ENTRY_CNT
;

169 ià(
£nd_út
 < 0) {

170 
	`TRACE_ERROR
("ps_send_chunk_buf failed. "

171 "»t: %d,ƒ¼Ü: %s\n", 
£nd_út
, 
	`¡»¼Ü
(
”ºo
));

172 #ifdeà
NETSTAT


174 
mtı
->
n¡©
.
tx_·ck‘s
[
nif
] +ğ
£nd_út
;

178  
£nd_út
;

182 
	}
}

185 
	$psio_£nd_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
)

187 
psio_´iv©e_cÚ‹xt
 *
µc
;

188 
mtı_mªag”_t
 
mtı
;

189 
»t
, 
´ev_út
;

191 
µc
 = (
psio_´iv©e_cÚ‹xt
 *)
ùxt
->
io_´iv©e_cÚ‹xt
;

192 
mtı
 = 
ùxt
->
mtı_mªag”
;

196 ià(!
	`NID_ISSET
(
nif
, 
µc
->
tx_ava
)) {

197 
	`NID_SET
(
nif
, 
µc
->
ev’t
.
tx_nids
);

201 (
´ev_út
 = 
µc
->
w_chunk_buf
[
nif
].
út
) > 0) {

202 
»t
 = 
	`psio_æush_pkts
(
ùxt
, 
nif
);

203 ià(
»t
 <= 0) {

204 ià(
»t
 < 0)

205 
	`TRACE_ERROR
("ps_send_chunk_buf failedo send.\n");

206 
	`NID_SET
(
nif
, 
µc
->
ev’t
.
tx_nids
);

207 
	`NID_CLR
(
nif
, 
µc
->
tx_ava
);

209 } ià(
»t
 < 
´ev_út
) {

210 
	`NID_CLR
(
nif
, 
µc
->
tx_ava
);

211 
	`NID_SET
(
nif
, 
µc
->
ev’t
.
tx_nids
);

212 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_tx
);

215 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_tx
);

220 
	}
}

222 
ušt8_t
 *

223 
	$psio_g‘_w±r
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
nif
, 
ušt16_t
 
Ën
)

225 
psio_´iv©e_cÚ‹xt
 *
µc
;

226 
ps_chunk_buf
 *
c_buf
;

228 
µc
 = (
psio_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

229 
c_buf
 = &
µc
->
w_chunk_buf
[
nif
];

232  (
ušt8_t
 *)
	`ps_assign_chunk_buf
(
c_buf
, 
Ën
);

233 
	}
}

235 
št32_t


236 
	$psio_»cv_pkts
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
)

238 
»t
, 
no_rx_·ck‘
;

239 
psio_´iv©e_cÚ‹xt
 *
µc
;

241 
µc
 = (
psio_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

242 
no_rx_·ck‘
 = 0;

244 
µc
->
chunk
.
út
 = 
PS_CHUNK_SIZE
;

246 
»t
 = 
	`ps_»cv_chunk_ifidx
(&
µc
->
hªdË
, &µc->
chunk
, 
ifidx
);

247 ià(
»t
 < 0) {

248 ià(
”ºo
 !ğ
EAGAIN
) {

249 
	`TRACE_ERROR
("ps_recv_chunk_ifidx failedo„ead…ackets.\n");

250 
	`³¼Ü
("ps_recv_chunk_ifidx()");

252 
	`NID_SET
(
ifidx
, 
µc
->
ev’t
.
rx_nids
);

253 
no_rx_·ck‘
 = 1;

254 } ià(
»t
 == 0) {

255 
	`NID_SET
(
ifidx
, 
µc
->
ev’t
.
rx_nids
);

256 
no_rx_·ck‘
 = 1;

259 ià(!
no_rx_·ck‘
)

260 
	`NID_SET
(
ifidx
, 
µc
->
rx_ava
);

262  
»t
;

263 
	}
}

265 
ušt8_t
 *

266 
	$psio_g‘_½Œ
(
mtı_th»ad_cÚ‹xt
 *
ùxt
, 
ifidx
, 
šdex
, 
ušt16_t
 *
Ën
)

268 
psio_´iv©e_cÚ‹xt
 *
µc
;

269 
ušt8_t
 *
pktbuf
;

271 
µc
 = (
psio_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

272 
pktbuf
 = (
ušt8_t
 *)(
µc
->
chunk
.
buf
 +…pc->chunk.
šfo
[
šdex
].
off£t
);

273 *
Ën
 = 
µc
->
chunk
.
šfo
[
šdex
].len;

275 ()(
ifidx
);

276  
pktbuf
;

277 
	}
}

279 
št32_t


280 
	$psio_£Ëù
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

282 
psio_´iv©e_cÚ‹xt
 *
µc
;

283 
mtı_mªag”_t
 
mtı
;

284 
timev®
 
cur_ts
;

285 
i
, 
»t
;

287 
µc
 = (
psio_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

288 
mtı
 = 
ùxt
->
mtı_mªag”
;

289 
	`g‘timeofday
(&
cur_ts
, 
NULL
);

292 ià(!
µc
->
rx_ava
 ||…pc->
ev’t
.
tx_nids
) {

293 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

294 ià(
µc
->
w_chunk_buf
[
i
].
út
 > 0)

295 
	`NID_SET
(
i
, 
µc
->
ev’t
.
tx_nids
);

296 ià(
mtı
->
n_£nd”
[
i
]->
cÚŒŞ_li¡_út
 > 0 ||

297 
mtı
->
n_£nd”
[
i
]->
£nd_li¡_út
 > 0 ||

298 
mtı
->
n_£nd”
[
i
]->
ack_li¡_út
 > 0) {

299 ià(
cur_ts
.
tv_£c
 > 
µc
->
Ï¡_tx_£t
[
i
].tv_sec ||

300 
cur_ts
.
tv_u£c
 > 
µc
->
Ï¡_tx_£t
[
i
].tv_usec) {

301 
	`NID_SET
(
i
, 
µc
->
ev’t
.
tx_nids
);

302 
µc
->
Ï¡_tx_£t
[
i
] = 
cur_ts
;

307 
	`TRACE_SELECT
("BEFORE:„x_avail: %d,x_avail: %d,ƒvent.rx_nids: %0x,ƒvent.tx_nids: %0x\n",

308 
µc
->
rx_ava
,…pc->
tx_ava
,…pc->
ev’t
.
rx_nids
,…pc->ev’t.
tx_nids
);

309 
mtı
->
is_¦“pšg
 = 
TRUE
;

310 
»t
 = 
	`ps_£Ëù
(&
µc
->
hªdË
, &µc->
ev’t
);

311 
mtı
->
is_¦“pšg
 = 
FALSE
;

312 #ià
TIME_STAT


313 
	`g‘timeofday
(&
£Ëù_ts
, 
NULL
);

314 
	`Upd©eStCouÁ”
(&
mtı
->
¹¡©
.
£Ëù
,

315 
	`TimeDiffUs
(&
£Ëù_ts
, &
xm™_ts
));

317 ià(
»t
 < 0) {

318 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

319 
	`³¼Ü
("ps_select");

320 
	`ex™
(
EXIT_FAILURE
);

322 ià(
”ºo
 =ğ
EINTR
) {

323 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_£Ëù_šŒ
);

326 
	`TRACE_SELECT
("ps_select():ƒvent.rx_nids: %0x,ƒvent.tx_nids: %0x\n",

327 
µc
->
ev’t
.
rx_nids
,…pc->ev’t.
tx_nids
);

328 ià(
µc
->
ev’t
.
rx_nids
 != 0) {

329 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_£Ëù_rx
);

331 ià(
µc
->
ev’t
.
tx_nids
 != 0) {

332 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

333 ià(
	`NID_ISSET
(
i
, 
µc
->
ev’t
.
tx_nids
)) {

334 
	`NID_SET
(
i
, 
µc
->
tx_ava
);

337 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_£Ëù_tx
);

340 
	`TRACE_SELECT
("AFTER:„x_avail: %d,x_avail: %d,ƒvent.rx_nids: %d,ƒvent.tx_nids: %d\n",

341 
µc
->
rx_ava
,…pc->
tx_ava
,…pc->
ev’t
.
rx_nids
,…pc->ev’t.
tx_nids
);

342 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_£Ëù
);

346 
µc
->
ev’t
.
timeout
 = 
PS_SELECT_TIMEOUT
;

347 
	`NID_ZERO
(
µc
->
ev’t
.
rx_nids
);

348 
	`NID_ZERO
(
µc
->
ev’t
.
tx_nids
);

349 
	`NID_ZERO
(
µc
->
rx_ava
);

353 
	}
}

356 
	$psio_de¡roy_hªdË
(
mtı_th»ad_cÚ‹xt
 *
ùxt
)

358 
psio_´iv©e_cÚ‹xt
 *
µc
;

360 
µc
 = (
psio_´iv©e_cÚ‹xt
 *è
ùxt
->
io_´iv©e_cÚ‹xt
;

363 
	`ä“
(
µc
);

364 
	}
}

367 
	$psio_lßd_moduË
()

370 ià(
CONFIG
.
muÉi_´oûss
) {

371 
	`TRACE_LOG
("PSIO module does‚ot…rovide multi-process support\n");

372 
	`ex™
(
EXIT_FAILURE
);

374 
	}
}

376 
io_moduË_func
 
	gps_moduË_func
 = {

377 .
lßd_moduË
 = 
psio_lßd_moduË
,

378 .
	gš™_hªdË
 = 
psio_š™_hªdË
,

379 .
	glšk_deviûs
 = 
psio_lšk_deviûs
,

380 .
	g»Ëa£_pkt
 = 
psio_»Ëa£_pkt
,

381 .
	g£nd_pkts
 = 
psio_£nd_pkts
,

382 .
	gg‘_w±r
 = 
psio_g‘_w±r
,

383 .
	g»cv_pkts
 = 
psio_»cv_pkts
,

384 .
	gg‘_½Œ
 = 
psio_g‘_½Œ
,

385 .
	g£Ëù
 = 
psio_£Ëù
,

386 .
	gde¡roy_hªdË
 = 
psio_de¡roy_hªdË
,

387 .
	gdev_ioùl
 = 
NULL


390 
io_moduË_func
 
	gps_moduË_func
 = {

391 .
lßd_moduË
 = 
NULL
,

392 .
	gš™_hªdË
 = 
NULL
,

393 .
	glšk_deviûs
 = 
NULL
,

394 .
	g»Ëa£_pkt
 = 
NULL
,

395 .
	g£nd_pkts
 = 
NULL
,

396 .
	gg‘_w±r
 = 
NULL
,

397 .
	g»cv_pkts
 = 
NULL
,

398 .
	gg‘_½Œ
 = 
NULL
,

399 .
	g£Ëù
 = 
NULL
,

400 .
	gde¡roy_hªdË
 = 
NULL
,

401 .
	gdev_ioùl
 = 
NULL


	@rss.cpp

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dšt.h
>

4 
	~<Ãtš‘/š.h
>

5 
	~<¬·/š‘.h
>

6 
	~<¡dlib.h
>

7 
	~<uni¡d.h
>

9 
	~"rss.h
"

13 
	$BudKeyCache
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

15 
	#NBBY
 8

	)

18 cÚ¡ 
ušt8_t
 
key
[] = {

26 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

27 (((
ušt32_t
)
key
[1]) << 16) |

28 (((
ušt32_t
)
key
[2]) << 8) |

29 ((
ušt32_t
)
key
[3]);

31 
ušt32_t
 
idx
 = 32;

32 
i
;

34 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

35 
ušt8_t
 
shiá
 = (
idx
 % 
NBBY
);

36 
ušt32_t
 
b™
;

38 
ÿche
[
i
] = 
»suÉ
;

39 
b™
 = ((
key
[
idx
/
NBBY
] << 
shiá
) & 0x80) ? 1 : 0;

40 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

42 
	}
}

44 
ušt32_t


45 
	$G‘RSSHash
(
š_addr_t
 
s
, in_addr_ˆ
d
, 
š_pÜt_t
 
¥
, in_pÜt_ˆ
dp
)

47 
	#MSB32
 0x80000000

	)

48 
	#MSB16
 0x8000

	)

49 
	#KEY_CACHE_LEN
 96

	)

51 
ušt32_t
 
»s
 = 0;

52 
i
;

53 
fœ¡
 = 1;

54 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

56 ià(
fœ¡
) {

57 
	`BudKeyCache
(
key_ÿche
, 
KEY_CACHE_LEN
);

58 
fœ¡
 = 0;

61 
i
 = 0; i < 32; i++) {

62 ià(
s
 & 
MSB32
)

63 
»s
 ^ğ
key_ÿche
[
i
];

64 
s
 <<= 1;

66 
i
 = 0; i < 32; i++) {

67 ià(
d
 & 
MSB32
)

68 
»s
 ^ğ
key_ÿche
[32+
i
];

69 
d
 <<= 1;

71 
i
 = 0; i < 16; i++) {

72 ià(
¥
 & 
MSB16
)

73 
»s
 ^ğ
key_ÿche
[64+
i
];

74 
¥
 <<= 1;

76 
i
 = 0; i < 16; i++) {

77 ià(
dp
 & 
MSB16
)

78 
»s
 ^ğ
key_ÿche
[80+
i
];

79 
dp
 <<= 1;

81  
»s
;

82 
	}
}

91 
	$G‘RSSCPUCÜe
(
š_addr_t
 
s
, in_addr_ˆ
d
,

92 
š_pÜt_t
 
¥
, in_pÜt_ˆ
dp
, 
num_queues
, 
ušt8_t
 
’dŸn_check
)

94 
	#RSS_BIT_MASK
 0x0000007F

	)

95 
ušt32_t
 
masked
 = 
	`G‘RSSHash
(
s
, 
d
, 
¥
, 
dp
è& 
RSS_BIT_MASK
;

97 ià(
’dŸn_check
) {

98 cÚ¡ 
ušt32_t
 
off
[4] = {3, 1, -1, -3};

99 
masked
 +ğ
off
[masked & 0x3];

102  (
masked
 % 
num_queues
);

103 
	}
}

	@socket.cpp

1 
	~"mtı.h
"

2 
	~"sock‘.h
"

3 
	~"debug.h
"

6 
sock‘_m­_t


7 
	$AÎoÿ‹Sock‘
(
mùx_t
 
mùx
, 
sockty³
, 
Ãed_lock
)

9 
mtı_mªag”_t
 
mtı
 = 
g_mtı
[
mùx
->
ıu
];

10 
sock‘_m­_t
 
sock‘
 = 
NULL
;

12 ià(
Ãed_lock
)

13 
	`±h»ad_mu‹x_lock
(&
mtı
->
ùx
->
sm­_lock
);

15 
sock‘
 =ğ
NULL
) {

16 
sock‘
 = 
	`TAILQ_FIRST
(&
mtı
->
ä“_sm­
);

17 ià(!
sock‘
) {

18 ià(
Ãed_lock
)

19 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
sm­_lock
);

21 
	`TRACE_ERROR
("The concurrent sockets‡re‡t maximum.\n");

22  
NULL
;

25 
	`TAILQ_REMOVE
(&
mtı
->
ä“_sm­
, 
sock‘
, 
ä“_sm­_lšk
);

29 ià(
sock‘
->
ev’ts
) {

30 
	`TRACE_INFO
("There‡re still‚ot invalidateƒvents„emaining.\n");

31 
	`TRACE_DBG
("There‡re still‚ot invalidateƒvents„emaining.\n");

32 
	`TAILQ_INSERT_TAIL
(&
mtı
->
ä“_sm­
, 
sock‘
, 
ä“_sm­_lšk
);

33 
sock‘
 = 
NULL
;

37 ià(
Ãed_lock
)

38 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
sm­_lock
);

40 
sock‘
->
sockty³
 = socktype;

41 
sock‘
->
İts
 = 0;

42 
sock‘
->
¡»am
 = 
NULL
;

43 
sock‘
->
•Şl
 = 0;

44 
sock‘
->
ev’ts
 = 0;

50 
	`mem£t
(&
sock‘
->
§ddr
, 0, (
sockaddr_š
));

51 
	`mem£t
(&
sock‘
->
•_d©a
, 0, (
mtı_•Şl_d©a_t
));

53  
sock‘
;

54 
	}
}

57 
	$F»eSock‘
(
mùx_t
 
mùx
, 
sockid
, 
Ãed_lock
)

59 
mtı_mªag”_t
 
mtı
 = 
g_mtı
[
mùx
->
ıu
];

60 
sock‘_m­_t
 
sock‘
 = &
mtı
->
sm­
[
sockid
];

62 ià(
sock‘
->
sockty³
 =ğ
MTCP_SOCK_UNUSED
) {

66 
sock‘
->
sockty³
 = 
MTCP_SOCK_UNUSED
;

67 
sock‘
->
•Şl
 = 
MTCP_EPOLLNONE
;

68 
sock‘
->
ev’ts
 = 0;

70 ià(
Ãed_lock
)

71 
	`±h»ad_mu‹x_lock
(&
mtı
->
ùx
->
sm­_lock
);

74 
mtı
->
sm­
[
sockid
].
¡»am
 = 
NULL
;

75 
	`TAILQ_INSERT_TAIL
(&
mtı
->
ä“_sm­
, 
sock‘
, 
ä“_sm­_lšk
);

77 ià(
Ãed_lock
)

78 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
sm­_lock
);

79 
	}
}

81 
sock‘_m­_t


82 
	$G‘Sock‘
(
mùx_t
 
mùx
, 
sockid
)

84 ià(
sockid
 < 0 || sockid >ğ
CONFIG
.
max_cÚcu¼’cy
) {

85 
”ºo
 = 
EBADF
;

86  
NULL
;

89  &
g_mtı
[
mùx
->
ıu
]->
sm­
[
sockid
];

90 
	}
}

	@tcp_in.cpp

1 
	~<as£¹.h
>

3 
	~"tı_ut.h
"

4 
	~"tı_š.h
"

5 
	~"tı_out.h
"

6 
	~"tı_ršg_bufãr.h
"

7 
	~"ev’Şl.h
"

8 
	~"debug.h
"

9 
	~"tim”.h
"

10 
	~"_š.h
"

11 
	~<io¡»am
>

13 
usšg
 
Çme¥aû
 
	g¡d
;

15 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

16 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

18 
	#VERIFY_RX_CHECKSUM
 
FALSE


	)

19 
	#RECOVERY_AFTER_LOSS
 
TRUE


	)

20 
	#SELECTIVE_WRITE_EVENT_NOTIFY
 
TRUE


	)

23 
šlše
 

24 
	$F‹rSYNPack‘
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 

, 
ušt16_t
 
pÜt
)

26 
sockaddr_š
 *
addr
;

27 
tı_li¡’”
 *
li¡’”
;

32 
li¡’”
 = (
tı_li¡’”
 *)
	`Li¡’”HTS—rch
(
mtı
->
li¡’”s
, &
pÜt
);

33 ià(
li¡’”
 =ğ
NULL
è 
FALSE
;

35 
addr
 = &
li¡’”
->
sock‘
->
§ddr
;

37 ià(
addr
->
sš_pÜt
 =ğ
pÜt
) {

38 ià(
addr
->
sš_addr
.
s_addr
 !ğ
INADDR_ANY
) {

39 ià(

 =ğ
addr
->
sš_addr
.
s_addr
) {

40  
TRUE
;

42  
FALSE
;

44 
i
;

46 
i
 = 0; i < 
CONFIG
.
‘hs_num
; i++) {

47 ià(

 =ğ
CONFIG
.
‘hs
[
i
].
_addr
) {

48  
TRUE
;

51  
FALSE
;

55  
FALSE
;

56 
	}
}

58 
šlše
 
tı_¡»am
 *

59 
	$HªdËPassiveO³n
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, cÚ¡ 
hdr
 *
h
,

60 cÚ¡ 
tıhdr
 *
tıh
, 
ušt32_t
 
£q
, 
ušt16_t
 
wšdow
)

62 
tı_¡»am
 *
cur_¡»am
 = 
NULL
;

65 
cur_¡»am
 = 
	`C»©eTCPSŒ—m
(
mtı
, 
NULL
, 
MTCP_SOCK_STREAM
,

66 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
);

67 ià(!
cur_¡»am
) {

68 
	`TRACE_ERROR
("INFO: Could‚ot‡llocatecp_stream!\n");

69  
FALSE
;

71 
cur_¡»am
->
rcvv¬
->
œs
 = 
£q
;

72 
cur_¡»am
->
¢dv¬
->
³”_wnd
 = 
wšdow
;

73 
cur_¡»am
->
rcv_nxt
 = cur_¡»am->
rcvv¬
->
œs
;

74 
cur_¡»am
->
¢dv¬
->
cwnd
 = 1;

75 
	`P¬£TCPO±iÚs
(
cur_¡»am
, 
cur_ts
, (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
,

76 (
tıh
->
doff
 << 2è- 
TCP_HEADER_LEN
);

78  
cur_¡»am
;

79 
	}
}

81 
šlše
 

82 
	$HªdËAùiveO³n
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
,

83 
tıhdr
 *
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
ušt16_t
 
wšdow
)

85 
cur_¡»am
->
rcvv¬
->
œs
 = 
£q
;

86 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

87 
cur_¡»am
->
¢dv¬
->
³”_wnd
 = 
wšdow
;

88 
cur_¡»am
->
rcvv¬
->
¢d_wl1
 = cur_¡»am->rcvv¬->
œs
 - 1;

89 
cur_¡»am
->
rcv_nxt
 = cur_¡»am->
rcvv¬
->
œs
 + 1;

90 
cur_¡»am
->
rcvv¬
->
Ï¡_ack_£q
 = 
ack_£q
;

91 
	`P¬£TCPO±iÚs
(
cur_¡»am
, 
cur_ts
, (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
,

92 (
tıh
->
doff
 << 2è- 
TCP_HEADER_LEN
);

93 
cur_¡»am
->
¢dv¬
->
cwnd
 = ((cur_stream->sndvar->cwnd == 1)?

94 (
cur_¡»am
->
¢dv¬
->
mss
 * 2): cur_stream->sndvar->mss);

95 
cur_¡»am
->
¢dv¬
->
s¡h»sh
 = cur_¡»am->¢dv¬->
mss
 * 10;

96 
	`Upd©eR‘¿nsmissiÚTim”
(
mtı
, 
cur_¡»am
, 
cur_ts
);

98  
TRUE
;

99 
	}
}

104 
šlše
 

105 
	$V®id©eSequ’û
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
,

106 
tıhdr
 *
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
·ylßdËn
)

109 ià(!
tıh
->
r¡
 && 
cur_¡»am
->
§w_time¡amp
) {

110 
tı_time¡amp
 
ts
;

112 ià(!
	`P¬£TCPTime¡amp
(
cur_¡»am
, &
ts
,

113 (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
,

114 (
tıh
->
doff
 << 2è- 
TCP_HEADER_LEN
)) {

117 
	`TRACE_DBG
("Noimestamp found.\n");

118  
FALSE
;

122 ià(
	`TCP_SEQ_LT
(
ts
.
ts_v®
, 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
)) {

125 
	`TRACE_DBG
("PAWS Detect wrongimestamp. "

127 
£q
, 
ts
.
ts_v®
, 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
);

128 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

129  
FALSE
;

132 ià(
	`TCP_SEQ_GT
(
ts
.
ts_v®
, 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
)) {

133 
	`TRACE_TSTAMP
("Timestamp update. cur: %u,…rior: %u "

135 
ts
.
ts_v®
, 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
,

136 
	`TS_TO_USEC
(
cur_ts
 - 
cur_¡»am
->
rcvv¬
->
ts_Ï¡_ts_upd
));

137 
cur_¡»am
->
rcvv¬
->
ts_Ï¡_ts_upd
 = 
cur_ts
;

140 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
 = 
ts
.
ts_v®
;

141 
cur_¡»am
->
rcvv¬
->
ts_Ï¡ack_rcvd
 = 
ts
.
ts_»f
;

146 ià(!
	`TCP_SEQ_BETWEEN
(
£q
 + 
·ylßdËn
, 
cur_¡»am
->
rcv_nxt
,

147 
cur_¡»am
->
rcv_nxt
 + cur_¡»am->
rcvv¬
->
rcv_wnd
)) {

150 ià(
tıh
->
r¡
)

151  
FALSE
;

153 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

155 ià(
£q
 + 1 =ğ
cur_¡»am
->
rcv_nxt
) {

157 
	`TRACE_DBG
("Window update„equest. (seq: %u,„cv_wnd: %u)\n",

158 
£q
, 
cur_¡»am
->
rcvv¬
->
rcv_wnd
);

160 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

161  
FALSE
;

165 ià(
	`TCP_SEQ_LEQ
(
£q
, 
cur_¡»am
->
rcv_nxt
)) {

166 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

168 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

171 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_TIME_WAIT
) {

172 
	`TRACE_DBG
("Stream %d:wƒxpire updateo %u\n",

173 
cur_¡»am
->
id
, cur_¡»am->
rcvv¬
->
ts_tw_expœe
);

174 
	`AddtoTimewa™Li¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

176 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

178  
FALSE
;

181  
TRUE
;

182 
	}
}

184 
šlše
 

185 
	$NÙifyCÚÃùiÚRe£t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

187 
	`TRACE_DBG
("SŒ—m %d: NÙifyšg cÚÃùiÚ„e£t.\n", 
cur_¡»am
->
id
);

190 
	}
}

192 
šlše
 

193 
	$ProûssRST
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
ack_£q
)

199 
	`TRACE_DBG
("Stream %d: TCP RESET (%s)\n",

200 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream));

201 #ià
DUMP_STREAM


202 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

205 ià(
cur_¡»am
->
¡©e
 <ğ
TCP_ST_SYN_SENT
) {

207  
FALSE
;

210 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_RCVD
) {

211 ià(
ack_£q
 =ğ
cur_¡»am
->
¢d_nxt
) {

212 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

213 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_RESET
;

214 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

216  
TRUE
;

221 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

222 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
 ||

223 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
 ||

224 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
 ||

225 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_TIME_WAIT
) {

226 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

227 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

228 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

229  
TRUE
;

232 ià(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
 &&

233 
cur_¡»am
->
¡©e
 <ğ
TCP_ST_CLOSE_WAIT
) {

239 ià(!(
cur_¡»am
->
¢dv¬
->
Ú_şo£q
 || cur_¡»am->¢dv¬->
Ú_şo£q_št
 ||

240 
cur_¡»am
->
¢dv¬
->
Ú_»£tq
 || cur_¡»am->¢dv¬->
Ú_»£tq_št
)) {

243 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSE_WAIT
;

244 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_RESET
;

245 
	`Rai£Clo£Ev’t
(
mtı
, 
cur_¡»am
);

248  
TRUE
;

249 
	}
}

251 
šlše
 

252 
	$E¡im©eRTT
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
m¹t
)

256 
	#TCP_RTO_MIN
 0

	)

257 
m
 = 
m¹t
;

258 
ušt32_t
 
tı_¹o_mš
 = 
TCP_RTO_MIN
;

259 
tı_»cv_v¬s
 *
rcvv¬
 = 
cur_¡»am
->rcvvar;

261 ià(
m
 == 0) {

262 
m
 = 1;

264 ià(
rcvv¬
->
¤‰
 != 0) {

266 
m
 -ğ(
rcvv¬
->
¤‰
 >> 3);

267 
rcvv¬
->
¤‰
 +ğ
m
;

268 ià(
m
 < 0) {

269 
m
 = -m;

270 
m
 -ğ(
rcvv¬
->
mdev
 >> 2);

271 ià(
m
 > 0) {

272 
m
 >>= 3;

275 
m
 -ğ(
rcvv¬
->
mdev
 >> 2);

277 
rcvv¬
->
mdev
 +ğ
m
;

278 ià(
rcvv¬
->
mdev
 >„cvv¬->
mdev_max
) {

279 
rcvv¬
->
mdev_max
 =„cvv¬->
mdev
;

280 ià(
rcvv¬
->
mdev_max
 >„cvv¬->
¹tv¬
) {

281 
rcvv¬
->
¹tv¬
 =„cvv¬->
mdev_max
;

284 ià(
	`TCP_SEQ_GT
(
cur_¡»am
->
¢dv¬
->
¢d_uÇ
, 
rcvv¬
->
¹t_£q
)) {

285 ià(
rcvv¬
->
mdev_max
 <„cvv¬->
¹tv¬
) {

286 
rcvv¬
->
¹tv¬
 -ğÔcvv¬->¹tv¬ -„cvv¬->
mdev_max
) >> 2;

288 
rcvv¬
->
¹t_£q
 = 
cur_¡»am
->
¢d_nxt
;

289 
rcvv¬
->
mdev_max
 = 
tı_¹o_mš
;

293 
rcvv¬
->
¤‰
 = 
m
 << 3;

294 
rcvv¬
->
mdev
 = 
m
 << 1;

295 
rcvv¬
->
mdev_max
 =„cvv¬->
¹tv¬
 = 
	`MAX
Ôcvv¬->
mdev
, 
tı_¹o_mš
);

296 
rcvv¬
->
¹t_£q
 = 
cur_¡»am
->
¢d_nxt
;

299 
	`TRACE_RTT
("mrtt: %u (%uus), srtt: %u (%ums), mdev: %u, mdev_max: %u, "

300 "¹tv¬: %u,„‰_£q: %u\n", 
m¹t
, m¹ˆ* 
TIME_TICK
,

301 
rcvv¬
->
¤‰
, 
	`TS_TO_MSEC
(Ôcvv¬->¤‰è>> 3),„cvv¬->
mdev
,

302 
rcvv¬
->
mdev_max
,„cvv¬->
¹tv¬
,„cvv¬->
¹t_£q
);

303 
	}
}

305 
šlše
 

306 
	$ProûssACK
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
,

307 
tıhdr
 *
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

308 
ušt16_t
 
wšdow
, 
·ylßdËn
)

310 
tı_£nd_v¬s
 *
¢dv¬
 = 
cur_¡»am
->sndvar;

311 
ušt32_t
 
cwšdow
, 
cwšdow_´ev
;

312 
ušt32_t
 
rmËn
;

313 
ušt32_t
 
¢d_wnd_´ev
;

314 
ušt32_t
 
right_wnd_edge
;

315 
ušt8_t
 
dup
;

316 
»t
;

318 
cwšdow
 = 
wšdow
;

319 ià(!
tıh
->
syn
) {

320 
cwšdow
 = cwšdow << 
¢dv¬
->
wsÿË_³”
;

322 
right_wnd_edge
 = 
¢dv¬
->
³”_wnd
 + 
cur_¡»am
->
rcvv¬
->
¢d_wl2
;

325 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

326 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
 ||

327 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
 ||

328 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 ||

329 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
) {

330 ià(
¢dv¬
->
is_fš_£Á
 && 
ack_£q
 =ğ¢dv¬->
fss
 + 1) {

331 
ack_£q
--;

335 ià(
	`TCP_SEQ_GT
(
ack_£q
, 
¢dv¬
->
¢dbuf
->
h—d_£q
 + sndv¬->¢dbuf->
Ën
)) {

336 
	`TRACE_DBG
("Stream %d (%s): invalid‡cknologement. "

337 "ack_£q: %u,…ossibË max_ack_£q: %u\n", 
cur_¡»am
->
id
,

338 
	`TCPS‹ToSŒšg
(
cur_¡»am
), 
ack_£q
,

339 
¢dv¬
->
¢dbuf
->
h—d_£q
 + sndv¬->¢dbuf->
Ën
);

344 ià(
	`TCP_SEQ_LT
(
cur_¡»am
->
rcvv¬
->
¢d_wl1
, 
£q
) ||

345 (
cur_¡»am
->
rcvv¬
->
¢d_wl1
 =ğ
£q
 &&

346 
	`TCP_SEQ_LT
(
cur_¡»am
->
rcvv¬
->
¢d_wl2
, 
ack_£q
)) ||

347 (
cur_¡»am
->
rcvv¬
->
¢d_wl2
 =ğ
ack_£q
 &&

348 
cwšdow
 > 
¢dv¬
->
³”_wnd
)) {

349 
cwšdow_´ev
 = 
¢dv¬
->
³”_wnd
;

350 
¢dv¬
->
³”_wnd
 = 
cwšdow
;

351 
cur_¡»am
->
rcvv¬
->
¢d_wl1
 = 
£q
;

352 
cur_¡»am
->
rcvv¬
->
¢d_wl2
 = 
ack_£q
;

354 
	`TRACE_CLWND
("Window update. "

356 
ack_£q
, 
cwšdow
, 
cur_¡»am
->
¢d_nxt
 - 
¢dv¬
->
¢d_uÇ
);

358 ià(
cwšdow_´ev
 < 
cur_¡»am
->
¢d_nxt
 - 
¢dv¬
->
¢d_uÇ
 &&

359 
¢dv¬
->
³”_wnd
 >ğ
cur_¡»am
->
¢d_nxt
 - sndv¬->
¢d_uÇ
) {

360 
	`TRACE_CLWND
("%u Broadcasting client window update! "

363 
cur_¡»am
->
id
, 
ack_£q
, 
¢dv¬
->
³”_wnd
, 
cwšdow_´ev
,

364 
cur_¡»am
->
¢d_nxt
 - 
¢dv¬
->
¢d_uÇ
);

365 
	`Rai£Wr™eEv’t
(
mtı
, 
cur_¡»am
);

378 
dup
 = 
FALSE
;

379 ià(
	`TCP_SEQ_LT
(
ack_£q
, 
cur_¡»am
->
¢d_nxt
)) {

380 ià(
ack_£q
 =ğ
cur_¡»am
->
rcvv¬
->
Ï¡_ack_£q
 && 
·ylßdËn
 == 0) {

381 ià(
cur_¡»am
->
rcvv¬
->
¢d_wl2
 + 
¢dv¬
->
³”_wnd
 =ğ
right_wnd_edge
) {

382 ià(
cur_¡»am
->
rcvv¬
->
dup_acks
 + 1 > cur_stream->rcvvar->dup_acks) {

383 
cur_¡»am
->
rcvv¬
->
dup_acks
++;

385 
dup
 = 
TRUE
;

389 ià(!
dup
) {

390 
cur_¡»am
->
rcvv¬
->
dup_acks
 = 0;

391 
cur_¡»am
->
rcvv¬
->
Ï¡_ack_£q
 = 
ack_£q
;

395 ià(
dup
 && 
cur_¡»am
->
rcvv¬
->
dup_acks
 == 3) {

396 
	`TRACE_LOSS
("TrË du¶iÿ‹d ACKs!!‡ck_£q: %u\n", 
ack_£q
);

397 ià(
	`TCP_SEQ_LT
(
ack_£q
, 
cur_¡»am
->
¢d_nxt
)) {

398 
	`TRACE_LOSS
("Reducing snd_nxt from %uo %u\n",

399 
cur_¡»am
->
¢d_nxt
, 
ack_£q
);

400 #ià
RTM_STAT


401 
¢dv¬
->
r¡©
.
tdp_ack_út
++;

402 
¢dv¬
->
r¡©
.
tdp_ack_by‹s
 +ğ(
cur_¡»am
->
¢d_nxt
 - 
ack_£q
);

404 ià(
ack_£q
 !ğ
¢dv¬
->
¢d_uÇ
) {

405 
	`TRACE_DBG
("ack_seq‡nd snd_una mismatch ondp‡ck. "

407 
ack_£q
, 
¢dv¬
->
¢d_uÇ
);

409 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

414 
¢dv¬
->
s¡h»sh
 = 
	`MIN
(¢dv¬->
cwnd
, sndv¬->
³”_wnd
) / 2;

415 ià(
¢dv¬
->
s¡h»sh
 < 2 * sndv¬->
mss
) {

416 
¢dv¬
->
s¡h»sh
 = 2 * sndv¬->
mss
;

418 
¢dv¬
->
cwnd
 = sndv¬->
s¡h»sh
 + 3 * sndv¬->
mss
;

419 
	`TRACE_CONG
("Fast„etransmission. cwnd: %u, ssthresh: %u\n",

420 
¢dv¬
->
cwnd
, sndv¬->
s¡h»sh
);

423 ià(
¢dv¬
->
Ätx
 < 
TCP_MAX_RTX
) {

424 
¢dv¬
->
Ätx
++;

426 
	`TRACE_DBG
("Exceed MAX_RTX.\n");

429 
	`AddtoS’dLi¡
(
mtı
, 
cur_¡»am
);

431 } ià(
cur_¡»am
->
rcvv¬
->
dup_acks
 > 3) {

433 ià((
ušt32_t
)(
¢dv¬
->
cwnd
 + sndv¬->
mss
) > sndvar->cwnd) {

434 
¢dv¬
->
cwnd
 +ğ¢dv¬->
mss
;

435 
	`TRACE_CONG
("Dupack cwnd inflate. cwnd: %u, ssthresh: %u\n",

436 
¢dv¬
->
cwnd
, sndv¬->
s¡h»sh
);

440 #ià
TCP_OPT_SACK_ENABLED


441 
	`P¬£SACKO±iÚ
(
cur_¡»am
, 
ack_£q
, (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
,

442 (
tıh
->
doff
 << 2è- 
TCP_HEADER_LEN
);

445 #ià
RECOVERY_AFTER_LOSS


447 ià(
	`TCP_SEQ_GT
(
ack_£q
, 
cur_¡»am
->
¢d_nxt
)) {

448 #ià
RTM_STAT


449 
¢dv¬
->
r¡©
.
ack_upd_út
++;

450 
¢dv¬
->
r¡©
.
ack_upd_by‹s
 +ğ(
ack_£q
 - 
cur_¡»am
->
¢d_nxt
);

452 
	`TRACE_LOSS
("Updating snd_nxt from %uo %u\n",

453 
cur_¡»am
->
¢d_nxt
, 
ack_£q
);

454 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

455 ià(
¢dv¬
->
¢dbuf
->
Ën
 == 0) {

456 
	`RemoveFromS’dLi¡
(
mtı
, 
cur_¡»am
);

462 ià(
	`TCP_SEQ_GEQ
(
¢dv¬
->
¢dbuf
->
h—d_£q
, 
ack_£q
)) {

467 
rmËn
 = 
ack_£q
 - 
¢dv¬
->
¢dbuf
->
h—d_£q
;

468 ià(
rmËn
 > 0) {

470 
ušt16_t
 
·ck‘s
;

473 
·ck‘s
 = 
rmËn
 / 
¢dv¬
->
eff_mss
;

474 ià((
rmËn
 / 
¢dv¬
->
eff_mss
) * sndvar->eff_mss >„mlen) {

475 
·ck‘s
++;

479 ià(
cur_¡»am
->
§w_time¡amp
) {

480 
	`E¡im©eRTT
(
mtı
, 
cur_¡»am
,

481 
cur_ts
 - 
cur_¡»am
->
rcvv¬
->
ts_Ï¡ack_rcvd
);

482 
¢dv¬
->
¹o
 = (
cur_¡»am
->
rcvv¬
->
¤‰
 >> 3è+ cur_¡»am->rcvv¬->
¹tv¬
;

483 
	`as£¹
(
¢dv¬
->
¹o
 > 0);

486 
	`TRACE_RTT
("NOT IMPLEMENTED.\n");

490 ià(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
) {

491 ià(
¢dv¬
->
cwnd
 < sndv¬->
s¡h»sh
) {

492 ià((
¢dv¬
->
cwnd
 + sndv¬->
mss
) > sndvar->cwnd) {

493 
¢dv¬
->
cwnd
 +ğ(¢dv¬->
mss
 * 
·ck‘s
);

495 
	`TRACE_CONG
("slow start cwnd: %u, ssthresh: %u\n",

496 
¢dv¬
->
cwnd
, sndv¬->
s¡h»sh
);

498 
ušt32_t
 
Ãw_cwnd
 = 
¢dv¬
->
cwnd
 +

499 
·ck‘s
 * 
¢dv¬
->
mss
 * sndvar->mss /

500 
¢dv¬
->
cwnd
;

501 ià(
Ãw_cwnd
 > 
¢dv¬
->
cwnd
) {

502 
¢dv¬
->
cwnd
 = 
Ãw_cwnd
;

509 ià(
	`SBUF_LOCK
(&
¢dv¬
->
wr™e_lock
)) {

510 ià(
”ºo
 =ğ
EDEADLK
)

511 
	`³¼Ü
("ProcessACK: write_lock blocked\n");

512 
	`as£¹
(0);

514 
»t
 = 
	`SBRemove
(
mtı
->
rbm_¢d
, 
¢dv¬
->
¢dbuf
, 
rmËn
);

515 
¢dv¬
->
¢d_uÇ
 = 
ack_£q
;

516 
¢d_wnd_´ev
 = 
¢dv¬
->
¢d_wnd
;

517 
¢dv¬
->
¢d_wnd
 = sndv¬->
¢dbuf
->
size
 - sndv¬->¢dbuf->
Ën
;

521 #ià
SELECTIVE_WRITE_EVENT_NOTIFY


522 ià(
¢d_wnd_´ev
 <= 0) {

524 
	`Rai£Wr™eEv’t
(
mtı
, 
cur_¡»am
);

525 #ià
SELECTIVE_WRITE_EVENT_NOTIFY


529 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

530 
	`Upd©eR‘¿nsmissiÚTim”
(
mtı
, 
cur_¡»am
, 
cur_ts
);

533 
	`UNUSED
(
»t
);

534 
	}
}

540 
šlše
 

541 
	$ProûssTCPPaylßd
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
,

542 
ušt32_t
 
cur_ts
, 
ušt8_t
 *
·ylßd
, ušt32_ˆ
£q
, 
·ylßdËn
)

544 
tı_»cv_v¬s
 *
rcvv¬
 = 
cur_¡»am
->rcvvar;

545 
ušt32_t
 
´ev_rcv_nxt
;

546 
»t
;

549 ià(
	`TCP_SEQ_LT
(
£q
 + 
·ylßdËn
, 
cur_¡»am
->
rcv_nxt
)) {

550  
FALSE
;

553 ià(
	`TCP_SEQ_GT
(
£q
 + 
·ylßdËn
, 
cur_¡»am
->
rcv_nxt
 + 
rcvv¬
->
rcv_wnd
)) {

554  
FALSE
;

558 ià(!
rcvv¬
->
rcvbuf
) {

559 
rcvv¬
->
rcvbuf
 = 
	`RBIn™
(
mtı
->
rbm_rcv
,„cvv¬->
œs
 + 1);

560 ià(!
rcvv¬
->
rcvbuf
) {

561 
	`TRACE_ERROR
("Stream %d: Failedo‡llocate„eceive buffer.\n",

562 
cur_¡»am
->
id
);

563 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

564 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_NO_MEM
;

565 
	`Rai£E¼ÜEv’t
(
mtı
, 
cur_¡»am
);

567  
ERROR
;

571 ià(
	`SBUF_LOCK
(&
rcvv¬
->
»ad_lock
)) {

572 ià(
”ºo
 =ğ
EDEADLK
)

573 
	`³¼Ü
("ProcessTCPPayload:„ead_lock blocked\n");

574 
	`as£¹
(0);

577 
´ev_rcv_nxt
 = 
cur_¡»am
->
rcv_nxt
;

578 
»t
 = 
	`RBPut
(
mtı
->
rbm_rcv
,

579 
rcvv¬
->
rcvbuf
, 
·ylßd
, (
ušt32_t
)
·ylßdËn
, 
£q
);

580 ià(
»t
 < 0) {

581 
	`TRACE_ERROR
("CªnÙ m”g·ylßd.„—sÚ: %d\n", 
»t
);

586 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

587 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
) {

588 
	`RBRemove
(
mtı
->
rbm_rcv
,

589 
rcvv¬
->
rcvbuf
,„cvv¬->rcvbuf->
m”ged_Ën
, 
AT_MTCP
);

591 
cur_¡»am
->
rcv_nxt
 = 
rcvv¬
->
rcvbuf
->
h—d_£q
 +„cvv¬->rcvbuf->
m”ged_Ën
;

592 
rcvv¬
->
rcv_wnd
 =„cvv¬->
rcvbuf
->
size
 -„cvv¬->rcvbuf->
m”ged_Ën
;

594 
	`SBUF_UNLOCK
(&
rcvv¬
->
»ad_lock
);

596 ià(
	`TCP_SEQ_LEQ
(
cur_¡»am
->
rcv_nxt
, 
´ev_rcv_nxt
)) {

598  
FALSE
;

601 
	`TRACE_EPOLL
("Stream %d data‡rrived. "

603 
cur_¡»am
->
id
, 
·ylßdËn
,

604 
cur_¡»am
->
sock‘
? cur_¡»am->sock‘->
•Şl
 & 
MTCP_EPOLLET
 : 0,

605 
cur_¡»am
->
sock‘
? cur_¡»am->sock‘->
•Şl
 & 
MTCP_EPOLLIN
 : 0,

606 
cur_¡»am
->
sock‘
? cur_¡»am->sock‘->
•Şl
 & 
MTCP_EPOLLOUT
 : 0);

608 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

609 
	`Rai£R—dEv’t
(
mtı
, 
cur_¡»am
);

612  
TRUE
;

613 
	}
}

615 
šlše
 
tı_¡»am
 *

616 
	$C»©eNewFlowHTEÁry
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, cÚ¡ 
hdr
 *
h
,

617 
_Ën
, cÚ¡ 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

618 
·ylßdËn
, 
ušt16_t
 
wšdow
)

620 
tı_¡»am
 *
cur_¡»am
;

621 
»t
;

623 ià(
tıh
->
syn
 && !tıh->
ack
) {

625 
»t
 = 
	`F‹rSYNPack‘
(
mtı
, 
h
->
daddr
, 
tıh
->
de¡
);

626 ià(!
»t
) {

627 
	`TRACE_DBG
("Refusing SYN…acket.\n");

628 #ifdeà
DBGMSG


629 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

631 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

632 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

633 0, 
£q
 + 
·ylßdËn
 + 1, 0, 
TCP_FLAG_RST
 | 
TCP_FLAG_ACK
,

634 
NULL
, 0, 
cur_ts
, 0);

636  
NULL
;

640 
cur_¡»am
 = 
	`HªdËPassiveO³n
(
mtı
,

641 
cur_ts
, 
h
, 
tıh
, 
£q
, 
wšdow
);

642 ià(!
cur_¡»am
) {

643 
	`TRACE_DBG
("Not‡vailable space in flow…ool.\n");

644 #ifdeà
DBGMSG


645 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

647 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

648 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

649 0, 
£q
 + 
·ylßdËn
 + 1, 0, 
TCP_FLAG_RST
 | 
TCP_FLAG_ACK
,

650 
NULL
, 0, 
cur_ts
, 0);

652  
NULL
;

655  
cur_¡»am
;

656 } ià(
tıh
->
r¡
) {

657 
	`TRACE_DBG
("Reset…acket comes\n");

658 #ifdeà
DBGMSG


659 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

662  
NULL
;

664 
	`TRACE_DBG
("Weird…acket comes.\n");

665 #ifdeà
DBGMSG


666 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

674 ià(
tıh
->
ack
) {

675 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

676 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

677 
ack_£q
, 0, 0, 
TCP_FLAG_RST
, 
NULL
, 0, 
cur_ts
, 0);

679 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

680 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

681 0, 
£q
 + 
·ylßdËn
, 0, 
TCP_FLAG_RST
 | 
TCP_FLAG_ACK
,

682 
NULL
, 0, 
cur_ts
, 0);

684  
NULL
;

686 
	}
}

688 
šlše
 

689 
	$HªdË_TCP_ST_LISTEN
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

690 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
) {

692 ià(
tıh
->
syn
) {

693 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LISTEN
)

694 
cur_¡»am
->
rcv_nxt
++;

695 
cur_¡»am
->
¡©e
 = 
TCP_ST_SYN_RCVD
;

696 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_SYN_RCVD\n", 
cur_¡»am
->
id
);

697 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

699 
	`CTRACE_ERROR
("Stream %d (TCP_ST_LISTEN): "

700 "Pack‘ w™houˆSYN.\n", 
cur_¡»am
->
id
);

703 
	}
}

705 
šlše
 

706 
	$HªdË_TCP_ST_SYN_SENT
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

707 
tı_¡»am
* 
cur_¡»am
, cÚ¡ 
hdr
* 
h
, 
tıhdr
* 
tıh
,

708 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
·ylßdËn
, 
ušt16_t
 
wšdow
)

711 ià(
tıh
->
ack
) {

713 ià(
	`TCP_SEQ_LEQ
(
ack_£q
, 
cur_¡»am
->
¢dv¬
->
iss
) ||

714 
	`TCP_SEQ_GT
(
ack_£q
, 
cur_¡»am
->
¢d_nxt
)) {

715 ià(!
tıh
->
r¡
) {

716 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

717 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

718 
ack_£q
, 0, 0, 
TCP_FLAG_RST
, 
NULL
, 0, 
cur_ts
, 0);

723 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
++;

726 ià(
tıh
->
r¡
) {

727 ià(
tıh
->
ack
) {

728 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSE_WAIT
;

729 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_RESET
;

730 ià(
cur_¡»am
->
sock‘
) {

731 
	`Rai£E¼ÜEv’t
(
mtı
, 
cur_¡»am
);

733 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

739 ià(
tıh
->
syn
) {

740 ià(
tıh
->
ack
) {

741 
»t
 = 
	`HªdËAùiveO³n
(
mtı
,

742 
cur_¡»am
, 
cur_ts
, 
tıh
, 
£q
, 
ack_£q
, 
wšdow
);

743 ià(!
»t
) {

747 
cur_¡»am
->
¢dv¬
->
Ätx
 = 0;

748 
cur_¡»am
->
rcv_nxt
 = cur_¡»am->
rcvv¬
->
œs
 + 1;

749 
	`RemoveFromRTOLi¡
(
mtı
, 
cur_¡»am
);

750 
cur_¡»am
->
¡©e
 = 
TCP_ST_ESTABLISHED
;

752 ià(
cur_¡»am
->
sock‘
) {

753 
	`Rai£Wr™eEv’t
(
mtı
, 
cur_¡»am
);

755 
	`TRACE_STATE
("SŒ—m %d: ESTABLISHED, buˆnØsock‘\n", 
cur_¡»am
->
id
);

756 
	`S’dTCPPack‘Snd®Úe
(
mtı
,

757 
h
->
daddr
, 
tıh
->
de¡
, iph->
§ddr
,ıh->
sourû
,

758 0, 
£q
 + 
·ylßdËn
 + 1, 0, 
TCP_FLAG_RST
 | 
TCP_FLAG_ACK
,

759 
NULL
, 0, 
cur_ts
, 0);

760 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

761 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

763 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

765 ià(
CONFIG
.
tı_timeout
 > 0)

766 
	`AddtoTimeoutLi¡
(
mtı
, 
cur_¡»am
);

769 
cur_¡»am
->
¡©e
 = 
TCP_ST_SYN_RCVD
;

770 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_SYN_RCVD\n", 
cur_¡»am
->
id
);

771 
cur_¡»am
->
¢d_nxt
 = cur_¡»am->
¢dv¬
->
iss
;

772 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

775 
	}
}

777 
šlše
 

778 
	$HªdË_TCP_ST_SYN_RCVD
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

779 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
ack_£q
)

781 
tı_£nd_v¬s
 *
¢dv¬
 = 
cur_¡»am
->sndvar;

782 
»t
;

783 ià(
tıh
->
ack
) {

784 
tı_li¡’”
 *
li¡’”
;

785 
ušt32_t
 
´iÜ_cwnd
;

787 ià(
ack_£q
 !ğ
¢dv¬
->
iss
 + 1) {

788 
	`CTRACE_ERROR
("Stream %d (TCP_ST_SYN_RCVD): "

790 
cur_¡»am
->
id
, 
ack_£q
, 
¢dv¬
->
iss
);

791 
	`TRACE_DBG
("Stream %d (TCP_ST_SYN_RCVD): "

793 
cur_¡»am
->
id
, 
ack_£q
, 
¢dv¬
->
iss
);

797 
¢dv¬
->
¢d_uÇ
++;

798 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

799 
´iÜ_cwnd
 = 
¢dv¬
->
cwnd
;

800 
¢dv¬
->
cwnd
 = ((
´iÜ_cwnd
 == 1)?

801 (
¢dv¬
->
mss
 * 2): sndvar->mss);

804 
¢dv¬
->
Ätx
 = 0;

805 
cur_¡»am
->
rcv_nxt
 = cur_¡»am->
rcvv¬
->
œs
 + 1;

806 
	`RemoveFromRTOLi¡
(
mtı
, 
cur_¡»am
);

808 
cur_¡»am
->
¡©e
 = 
TCP_ST_ESTABLISHED
;

809 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_ESTABLISHED\n", 
cur_¡»am
->
id
);

812 
li¡’”
 = (
tı_li¡’”
 *)
	`Li¡’”HTS—rch
(
mtı
->
li¡’”s
, &
tıh
->
de¡
);

814 
»t
 = 
	`SŒ—mEnqueue
(
li¡’”
->
acû±q
, 
cur_¡»am
);

815 ià(
»t
 < 0) {

816 
	`TRACE_ERROR
("Stream %d: Failedoƒnqueueo "

817 "thli¡’ backlog!\n", 
cur_¡»am
->
id
);

818 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_NOT_ACCEPTED
;

819 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

820 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
cur_¡»am
->
id
);

821 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

824 ià(
CONFIG
.
tı_timeout
 > 0)

825 
	`AddtoTimeoutLi¡
(
mtı
, 
cur_¡»am
);

828 ià(
li¡’”
->
sock‘
 && (li¡’”->sock‘->
•Şl
 & 
MTCP_EPOLLIN
)) {

829 
	`AddEpŞlEv’t
(
mtı
->
•
,

830 
MTCP_EVENT_QUEUE
, 
li¡’”
->
sock‘
, 
MTCP_EPOLLIN
);

834 
	`TRACE_DBG
("Stream %d (TCP_ST_SYN_RCVD): No ACK.\n",

835 
cur_¡»am
->
id
);

837 
cur_¡»am
->
¢d_nxt
 = 
¢dv¬
->
iss
;

838 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

840 
	}
}

842 
šlše
 

843 
	$HªdË_TCP_ST_ESTABLISHED
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

844 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

845 
ušt8_t
 *
·ylßd
, 
·ylßdËn
, 
ušt16_t
 
wšdow
)

847 ià(
tıh
->
syn
) {

848 
	`TRACE_DBG
("Stream %d (TCP_ST_ESTABLISHED): weird SYN. "

850 
cur_¡»am
->
id
, 
£q
, cur_¡»am->
rcv_nxt
,

851 
ack_£q
, 
cur_¡»am
->
¢d_nxt
);

852 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

853 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

857 ià(
·ylßdËn
 > 0) {

858 ià(
	`ProûssTCPPaylßd
(
mtı
, 
cur_¡»am
,

859 
cur_ts
, 
·ylßd
, 
£q
, 
·ylßdËn
)) {

861 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

863 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

867 ià(
tıh
->
ack
) {

868 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

869 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

870 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

874 ià(
tıh
->
fš
) {

877 ià(
£q
 + 
·ylßdËn
 =ğ
cur_¡»am
->
rcv_nxt
) {

878 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSE_WAIT
;

879 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSE_WAIT\n", 
cur_¡»am
->
id
);

880 
cur_¡»am
->
rcv_nxt
++;

881 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

884 
	`Rai£R—dEv’t
(
mtı
, 
cur_¡»am
);

886 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

890 
	}
}

892 
šlše
 

893 
	$HªdË_TCP_ST_CLOSE_WAIT
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

894 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

895 
·ylßdËn
, 
ušt16_t
 
wšdow
)

897 ià(
	`TCP_SEQ_LT
(
£q
, 
cur_¡»am
->
rcv_nxt
)) {

898 
	`TRACE_DBG
("Stream %d (TCP_ST_CLOSE_WAIT): "

900 
cur_¡»am
->
id
, 
£q
, cur_¡»am->
rcv_nxt
);

901 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

905 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

906 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

907 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

909 
	}
}

911 
šlše
 

912 
	$HªdË_TCP_ST_LAST_ACK
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, cÚ¡ 
hdr
 *
h
,

913 
_Ën
, 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
,

914 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
·ylßdËn
, 
ušt16_t
 
wšdow
)

917 ià(
	`TCP_SEQ_LT
(
£q
, 
cur_¡»am
->
rcv_nxt
)) {

918 
	`TRACE_DBG
("Stream %d (TCP_ST_LAST_ACK): "

920 
cur_¡»am
->
id
, 
£q
, cur_¡»am->
rcv_nxt
);

924 ià(
tıh
->
ack
) {

925 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

926 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

927 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

930 ià(!
cur_¡»am
->
¢dv¬
->
is_fš_£Á
) {

933 
	`TRACE_DBG
("Stream %d (TCP_ST_LAST_ACK): "

934 "NØFIN s’ˆy‘.\n", 
cur_¡»am
->
id
);

935 #ifdeà
DBGMSG


936 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

938 #ià
DUMP_STREAM


939 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

940 
	`DumpCÚŒŞLi¡
(
mtı
, mtı->
n_£nd”
[0]);

946 ià(
ack_£q
 =ğ
cur_¡»am
->
¢dv¬
->
fss
 + 1) {

947 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
++;

948 
	`Upd©eR‘¿nsmissiÚTim”
(
mtı
, 
cur_¡»am
, 
cur_ts
);

949 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

950 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_PASSIVE_CLOSE
;

951 
	`TRACE_STATE
("Stream %d: TCP_ST_CLOSED\n",

952 
cur_¡»am
->
id
);

953 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

955 
	`TRACE_DBG
("Stream %d (TCP_ST_LAST_ACK): Not ACK of FIN. "

957 
cur_¡»am
->
id
, 
ack_£q
, cur_¡»am->
¢dv¬
->
fss
 + 1);

959 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

962 
	`CTRACE_ERROR
("Stream %d (TCP_ST_LAST_ACK): No ACK\n",

963 
cur_¡»am
->
id
);

965 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

967 
	}
}

969 
šlše
 

970 
	$HªdË_TCP_ST_FIN_WAIT_1
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

971 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

972 
ušt8_t
 *
·ylßd
, 
·ylßdËn
, 
ušt16_t
 
wšdow
)

975 ià(
	`TCP_SEQ_LT
(
£q
, 
cur_¡»am
->
rcv_nxt
)) {

976 
	`TRACE_DBG
("Stream %d (TCP_ST_LAST_ACK): "

978 
cur_¡»am
->
id
, 
£q
, cur_¡»am->
rcv_nxt
);

979 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

983 ià(
tıh
->
ack
) {

984 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

985 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

986 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

989 ià(
cur_¡»am
->
¢dv¬
->
is_fš_£Á
 &&

990 
ack_£q
 =ğ
cur_¡»am
->
¢dv¬
->
fss
 + 1) {

991 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
 = 
ack_£q
;

992 ià(
	`TCP_SEQ_GT
(
ack_£q
, 
cur_¡»am
->
¢d_nxt
)) {

993 
	`TRACE_DBG
("Stream %d: update snd_nxto %u\n",

994 
cur_¡»am
->
id
, 
ack_£q
);

995 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

999 
cur_¡»am
->
¢dv¬
->
Ätx
 = 0;

1000 
	`RemoveFromRTOLi¡
(
mtı
, 
cur_¡»am
);

1001 
cur_¡»am
->
¡©e
 = 
TCP_ST_FIN_WAIT_2
;

1002 
	`TRACE_STATE
("Stream %d: TCP_ST_FIN_WAIT_2\n",

1003 
cur_¡»am
->
id
);

1007 
	`TRACE_DBG
("Stream %d: does‚ot contain‡n‡ck!\n",

1008 
cur_¡»am
->
id
);

1012 ià(
·ylßdËn
 > 0) {

1013 ià(
	`ProûssTCPPaylßd
(
mtı
, 
cur_¡»am
,

1014 
cur_ts
, 
·ylßd
, 
£q
, 
·ylßdËn
)) {

1016 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

1018 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

1022 ià(
tıh
->
fš
) {

1025 ià(
£q
 + 
·ylßdËn
 =ğ
cur_¡»am
->
rcv_nxt
) {

1026 
cur_¡»am
->
rcv_nxt
++;

1028 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
) {

1029 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSING
;

1030 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSING\n", 
cur_¡»am
->
id
);

1032 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
) {

1033 
cur_¡»am
->
¡©e
 = 
TCP_ST_TIME_WAIT
;

1034 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_TIME_WAIT\n", 
cur_¡»am
->
id
);

1035 
	`AddtoTimewa™Li¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1037 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1040 
	}
}

1042 
šlše
 

1043 
	$HªdË_TCP_ST_FIN_WAIT_2
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

1044 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

1045 
ušt8_t
 *
·ylßd
, 
·ylßdËn
, 
ušt16_t
 
wšdow
)

1047 ià(
tıh
->
ack
) {

1048 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

1049 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

1050 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

1053 
	`TRACE_DBG
("Stream %d: does‚ot contain‡n‡ck!\n",

1054 
cur_¡»am
->
id
);

1058 ià(
·ylßdËn
 > 0) {

1059 ià(
	`ProûssTCPPaylßd
(
mtı
, 
cur_¡»am
,

1060 
cur_ts
, 
·ylßd
, 
£q
, 
·ylßdËn
)) {

1062 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_AGGREGATE
);

1064 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_NOW
);

1068 ià(
tıh
->
fš
) {

1071 ià(
£q
 + 
·ylßdËn
 =ğ
cur_¡»am
->
rcv_nxt
) {

1072 
cur_¡»am
->
¡©e
 = 
TCP_ST_TIME_WAIT
;

1073 
cur_¡»am
->
rcv_nxt
++;

1074 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_TIME_WAIT\n", 
cur_¡»am
->
id
);

1076 
	`AddtoTimewa™Li¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1077 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1081 
	`TRACE_DBG
("Stream %d (TCP_ST_FIN_WAIT_2): No FIN. "

1083 
cur_¡»am
->
id
, 
£q
, 
ack_£q
,

1084 
cur_¡»am
->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

1085 #ià
DBGMSG


1086 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

1091 
	}
}

1093 
šlše
 

1094 
	$HªdË_TCP_ST_CLOSING
 (
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
,

1095 
tı_¡»am
* 
cur_¡»am
, 
tıhdr
* 
tıh
, 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
,

1096 
·ylßdËn
, 
ušt16_t
 
wšdow
) {

1098 ià(
tıh
->
ack
) {

1099 ià(
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

1100 
	`ProûssACK
(
mtı
, 
cur_¡»am
, 
cur_ts
,

1101 
tıh
, 
£q
, 
ack_£q
, 
wšdow
, 
·ylßdËn
);

1104 ià(!
cur_¡»am
->
¢dv¬
->
is_fš_£Á
) {

1105 
	`TRACE_DBG
("Stream %d (TCP_ST_CLOSING): "

1106 "NØFIN s’ˆy‘.\n", 
cur_¡»am
->
id
);

1111 ià(
ack_£q
 !ğ
cur_¡»am
->
¢dv¬
->
fss
 + 1) {

1113 
	`CTRACE_ERROR
("Stream %d (TCP_ST_CLOSING): Not ACK of FIN. "

1115 
cur_¡»am
->
id
, 
ack_£q
, cur_¡»am->
¢d_nxt
,

1116 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
, cur_¡»am->¢dv¬->
fss
);

1117 
	`DumpIPPack‘ToFe
(
¡d”r
, 
h
, 
_Ën
);

1118 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

1125 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
 = 
ack_£q
;

1126 
cur_¡»am
->
¢d_nxt
 = 
ack_£q
;

1127 
	`Upd©eR‘¿nsmissiÚTim”
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1129 
cur_¡»am
->
¡©e
 = 
TCP_ST_TIME_WAIT
;

1130 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_TIME_WAIT\n", 
cur_¡»am
->
id
);

1132 
	`AddtoTimewa™Li¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1135 
	`CTRACE_ERROR
("Stream %d (TCP_ST_CLOSING): Not ACK\n",

1136 
cur_¡»am
->
id
);

1139 
	}
}

1142 
	$ProûssTCPPack‘
(
mtı_mªag”_t
 
mtı
,

1143 
ušt32_t
 
cur_ts
, cÚ¡ 
ifidx
, cÚ¡ 
hdr
 *
h
, 
_Ën
)

1146 
tıhdr
* 
tıh
 = (tıhd¸*è((
u_ch¬
 *)
h
 + (h->
ihl
 << 2));

1147 
ušt8_t
 *
·ylßd
 = (ušt8_ˆ*)
tıh
 + (tıh->
doff
 << 2);

1148 
·ylßdËn
 = 
_Ën
 - (
·ylßd
 - (
u_ch¬
 *)
h
);

1149 
tı_¡»am
 
s_¡»am
;

1150 
tı_¡»am
 *
cur_¡»am
 = 
NULL
;

1151 
ušt32_t
 
£q
 = 
	`Áohl
(
tıh
->seq);

1152 
ušt32_t
 
ack_£q
 = 
	`Áohl
(
tıh
->ack_seq);

1153 
ušt16_t
 
wšdow
 = 
	`Áohs
(
tıh
->window);

1154 
ušt16_t
 
check
;

1155 
»t
;

1156 
rc
 = -1;

1159 ià(
_Ën
 < ((
h
->
ihl
 + 
tıh
->
doff
) << 2))

1160  
ERROR
;

1162 #ià
VERIFY_RX_CHECKSUM


1163 #iâdeà
DISABLE_HWCSUM


1164 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

1165 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
ifidx
,

1166 
PKT_RX_TCP_CSUM
, 
NULL
);

1168 ià(
rc
 == -1) {

1169 
check
 = 
	`TCPC®cChecksum
((
ušt16_t
 *)
tıh
,

1170 (
tıh
->
doff
 << 2è+ 
·ylßdËn
, 
h
->
§ddr
, iph->
daddr
);

1171 ià(
check
) {

1173 
	`TRACE_DBG
("Checksum Error: Original: 0x%04x, calculated: 0x%04x\n",

1174 
tıh
->
check
, 
	`TCPC®cChecksum
((
ušt16_t
 *)tcph,

1175 (
tıh
->
doff
 << 2è+ 
·ylßdËn
, 
h
->
§ddr
, iph->
daddr
));

1176 
tıh
->
check
 = 0;

1177  
ERROR
;

1182 #ià
	`defšed
(
NETSTAT
è&& defšed(
ENABLELRO
)

1183 
mtı
->
n¡©
.
rx_gd±by‹s
 +ğ
·ylßdËn
;

1186 
s_¡»am
.
§ddr
 = 
h
->
daddr
;

1187 
s_¡»am
.
¥Üt
 = 
tıh
->
de¡
;

1188 
s_¡»am
.
daddr
 = 
h
->
§ddr
;

1189 
s_¡»am
.
dpÜt
 = 
tıh
->
sourû
;

1191 ià(!(
cur_¡»am
 = 
	`SŒ—mHTS—rch
(
mtı
->
tı_æow_bË
, &
s_¡»am
))) {

1194 
cur_¡»am
 = 
	`C»©eNewFlowHTEÁry
(
mtı
, 
cur_ts
, 
h
, 
_Ën
, 
tıh
,

1195 
£q
, 
ack_£q
, 
·ylßdËn
, 
wšdow
);

1196 ià(!
cur_¡»am
)

1197  
TRUE
;

1201 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_SYN_RCVD
) {

1202 
»t
 = 
	`V®id©eSequ’û
(
mtı
, 
cur_¡»am
,

1203 
cur_ts
, 
tıh
, 
£q
, 
ack_£q
, 
·ylßdËn
);

1204 ià(!
»t
) {

1205 
	`TRACE_DBG
("Stream %d: Unexpected sequence: %u,ƒxpected: %u\n",

1206 
cur_¡»am
->
id
, 
£q
, cur_¡»am->
rcv_nxt
);

1207 #ifdeà
DBGMSG


1208 
	`DumpIPPack‘
(
mtı
, 
h
, 
_Ën
);

1210 #ifdeà
DUMP_STREAM


1211 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

1213  
TRUE
;

1218 ià(
tıh
->
syn
) {

1219 
cur_¡»am
->
¢dv¬
->
³”_wnd
 = 
wšdow
;

1221 
cur_¡»am
->
¢dv¬
->
³”_wnd
 =

1222 (
ušt32_t
)
wšdow
 << 
cur_¡»am
->
¢dv¬
->
wsÿË_³”
;

1225 
cur_¡»am
->
Ï¡_aùive_ts
 = 
cur_ts
;

1226 
	`Upd©eTimeoutLi¡
(
mtı
, 
cur_¡»am
);

1229 ià(
tıh
->
r¡
) {

1230 
cur_¡»am
->
have_»£t
 = 
TRUE
;

1231 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_SYN_SENT
) {

1232 ià(
	`ProûssRST
(
mtı
, 
cur_¡»am
, 
ack_£q
)) {

1233  
TRUE
;

1238 
cur_¡»am
->
¡©e
) {

1239 
TCP_ST_LISTEN
:

1240 
	`HªdË_TCP_ST_LISTEN
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
);

1243 
TCP_ST_SYN_SENT
:

1244 
	`HªdË_TCP_ST_SYN_SENT
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
h
, 
tıh
,

1245 
£q
, 
ack_£q
, 
·ylßdËn
, 
wšdow
);

1248 
TCP_ST_SYN_RCVD
:

1250 ià(
tıh
->
syn
 && 
£q
 =ğ
cur_¡»am
->
rcvv¬
->
œs
)

1251 
	`HªdË_TCP_ST_LISTEN
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
);

1253 
	`HªdË_TCP_ST_SYN_RCVD
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
, 
ack_£q
);

1256 
TCP_ST_ESTABLISHED
:

1257 
	`HªdË_TCP_ST_ESTABLISHED
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
,

1258 
£q
, 
ack_£q
, 
·ylßd
, 
·ylßdËn
, 
wšdow
);

1261 
TCP_ST_CLOSE_WAIT
:

1262 
	`HªdË_TCP_ST_CLOSE_WAIT
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
, 
£q
, 
ack_£q
,

1263 
·ylßdËn
, 
wšdow
);

1266 
TCP_ST_LAST_ACK
:

1267 
	`HªdË_TCP_ST_LAST_ACK
(
mtı
, 
cur_ts
, 
h
, 
_Ën
, 
cur_¡»am
, 
tıh
,

1268 
£q
, 
ack_£q
, 
·ylßdËn
, 
wšdow
);

1271 
TCP_ST_FIN_WAIT_1
:

1272 
	`HªdË_TCP_ST_FIN_WAIT_1
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
, 
£q
, 
ack_£q
,

1273 
·ylßd
, 
·ylßdËn
, 
wšdow
);

1276 
TCP_ST_FIN_WAIT_2
:

1277 
	`HªdË_TCP_ST_FIN_WAIT_2
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
, 
£q
, 
ack_£q
,

1278 
·ylßd
, 
·ylßdËn
, 
wšdow
);

1281 
TCP_ST_CLOSING
:

1282 
	`HªdË_TCP_ST_CLOSING
(
mtı
, 
cur_ts
, 
cur_¡»am
, 
tıh
, 
£q
, 
ack_£q
,

1283 
·ylßdËn
, 
wšdow
);

1286 
TCP_ST_TIME_WAIT
:

1289 ià(
cur_¡»am
->
Ú_timewa™_li¡
) {

1290 
	`RemoveFromTimewa™Li¡
(
mtı
, 
cur_¡»am
);

1291 
	`AddtoTimewa™Li¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1293 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

1296 
TCP_ST_CLOSED
:

1301  
TRUE
;

1302 
	}
}

	@tcp_out.cpp

1 
	~<uni¡d.h
>

2 
	~"tı_out.h
"

3 
	~"mtı.h
"

4 
	~"_out.h
"

5 
	~"tı_š.h
"

6 
	~"tı_¡»am.h
"

7 
	~"ev’Şl.h
"

8 
	~"tim”.h
"

9 
	~"debug.h
"

10 
	~<io¡»am
>

12 
usšg
 
Çme¥aû
 
	g¡d
;

13 
	#TCP_CALCULATE_CHECKSUM
 
FALSE


	)

14 
	#ACK_PIGGYBACK
 
TRUE


	)

15 
	#TRY_SEND_BEFORE_QUEUE
 
FALSE


	)

17 
	#TCP_MAX_WINDOW
 65535

	)

19 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

20 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

23 
šlše
 
ušt16_t


24 
	$C®cuÏ‹O±iÚL’gth
(
ušt8_t
 
æags
)

26 
ušt16_t
 
İ’
 = 0;

28 ià(
æags
 & 
TCP_FLAG_SYN
) {

29 
İ’
 +ğ
TCP_OPT_MSS_LEN
;

30 #ià
TCP_OPT_SACK_ENABLED


31 
İ’
 +ğ
TCP_OPT_SACK_PERMIT_LEN
;

32 #ià!
TCP_OPT_TIMESTAMP_ENABLED


33 
İ’
 += 2;

37 #ià
TCP_OPT_TIMESTAMP_ENABLED


38 
İ’
 +ğ
TCP_OPT_TIMESTAMP_LEN
;

39 #ià!
TCP_OPT_SACK_ENABLED


40 
İ’
 += 2;

44 
İ’
 +ğ
TCP_OPT_WSCALE_LEN
 + 1;

48 #ià
TCP_OPT_TIMESTAMP_ENABLED


49 
İ’
 +ğ
TCP_OPT_TIMESTAMP_LEN
 + 2;

52 #ià
TCP_OPT_SACK_ENABLED


53 ià(
æags
 & 
TCP_FLAG_SACK
) {

54 
İ’
 +ğ
TCP_OPT_SACK_LEN
 + 2;

59 
	`as£¹
(
İ’
 % 4 == 0);

61  
İ’
;

62 
	}
}

64 
šlše
 

65 
	$G’”©eTCPTime¡amp
(
tı_¡»am
 *
cur_¡»am
, 
ušt8_t
 *
tıİt
, 
ušt32_t
 
cur_ts
)

67 
ušt32_t
 *
ts
 = (ušt32_ˆ*)(
tıİt
 + 2);

69 
tıİt
[0] = 
TCP_OPT_TIMESTAMP
;

70 
tıİt
[1] = 
TCP_OPT_TIMESTAMP_LEN
;

71 
ts
[0] = 
	`htÚl
(
cur_ts
);

72 
ts
[1] = 
	`htÚl
(
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
);

73 
	}
}

75 
šlše
 

76 
	$G’”©eTCPO±iÚs
(
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
,

77 
ušt8_t
 
æags
, ušt8_ˆ*
tıİt
, 
ušt16_t
 
İ’
)

79 
i
 = 0;

81 ià(
æags
 & 
TCP_FLAG_SYN
) {

82 
ušt16_t
 
mss
;

85 
mss
 = 
cur_¡»am
->
¢dv¬
->mss;

86 
tıİt
[
i
++] = 
TCP_OPT_MSS
;

87 
tıİt
[
i
++] = 
TCP_OPT_MSS_LEN
;

88 
tıİt
[
i
++] = 
mss
 >> 8;

89 
tıİt
[
i
++] = 
mss
 % 256;

92 #ià
TCP_OPT_SACK_ENABLED


93 #ià!
TCP_OPT_TIMESTAMP_ENABLED


94 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

95 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

97 
tıİt
[
i
++] = 
TCP_OPT_SACK_PERMIT
;

98 
tıİt
[
i
++] = 
TCP_OPT_SACK_PERMIT_LEN
;

99 
	`TRACE_SACK
("Local SACK…ermited.\n");

103 #ià
TCP_OPT_TIMESTAMP_ENABLED


104 #ià!
TCP_OPT_SACK_ENABLED


105 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

106 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

108 
	`G’”©eTCPTime¡amp
(
cur_¡»am
, 
tıİt
 + 
i
, 
cur_ts
);

109 
i
 +ğ
TCP_OPT_TIMESTAMP_LEN
;

113 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

114 
tıİt
[
i
++] = 
TCP_OPT_WSCALE
;

115 
tıİt
[
i
++] = 
TCP_OPT_WSCALE_LEN
;

116 
tıİt
[
i
++] = 
cur_¡»am
->
¢dv¬
->
wsÿË_mše
;

120 #ià
TCP_OPT_TIMESTAMP_ENABLED


121 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

122 
tıİt
[
i
++] = 
TCP_OPT_NOP
;

123 
	`G’”©eTCPTime¡amp
(
cur_¡»am
, 
tıİt
 + 
i
, 
cur_ts
);

124 
i
 +ğ
TCP_OPT_TIMESTAMP_LEN
;

127 #ià
TCP_OPT_SACK_ENABLED


128 ià(
æags
 & 
TCP_OPT_SACK
) {

134 
	`as£¹
 (
i
 =ğ
İ’
);

135 
	}
}

138 
	$S’dTCPPack‘Snd®Úe
(
mtı_mªag”
 *
mtı
,

139 
ušt32_t
 
§ddr
, 
ušt16_t
 
¥Üt
, ušt32_ˆ
daddr
, ušt16_ˆ
dpÜt
,

140 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
, 
ušt16_t
 
wšdow
, 
ušt8_t
 
æags
,

141 
ušt8_t
 *
·ylßd
, 
ušt16_t
 
·ylßdËn
,

142 
ušt32_t
 
cur_ts
, ušt32_ˆ
echo_ts
)

144 
tıhdr
 *
tıh
;

145 
ušt8_t
 *
tıİt
;

146 
ušt32_t
 *
ts
;

147 
ušt16_t
 
İ’
;

148 
rc
 = -1;

150 
İ’
 = 
	`C®cuÏ‹O±iÚL’gth
(
æags
);

151 ià(
·ylßdËn
 > 
TCP_DEFAULT_MSS
 + 
İ’
) {

152 
	`TRACE_ERROR
("Payload sizeƒxceeds MSS.\n");

153 
	`as£¹
(0);

154  
ERROR
;

157 
tıh
 = (
tıhdr
 *)
	`IPOuutSnd®Úe
(
mtı
, 
IPPROTO_TCP
, 0,

158 
§ddr
, 
daddr
, 
TCP_HEADER_LEN
 + 
İ’
 + 
·ylßdËn
);

159 ià(
tıh
 =ğ
NULL
) {

160  
ERROR
;

162 
	`mem£t
(
tıh
, 0, 
TCP_HEADER_LEN
 + 
İ’
);

164 
tıh
->
sourû
 = 
¥Üt
;

165 
tıh
->
de¡
 = 
dpÜt
;

167 ià(
æags
 & 
TCP_FLAG_SYN
)

168 
tıh
->
syn
 = 
TRUE
;

169 ià(
æags
 & 
TCP_FLAG_FIN
)

170 
tıh
->
fš
 = 
TRUE
;

171 ià(
æags
 & 
TCP_FLAG_RST
)

172 
tıh
->
r¡
 = 
TRUE
;

173 ià(
æags
 & 
TCP_FLAG_PSH
)

174 
tıh
->
psh
 = 
TRUE
;

176 
tıh
->
£q
 = 
	`htÚl
(seq);

177 ià(
æags
 & 
TCP_FLAG_ACK
) {

178 
tıh
->
ack
 = 
TRUE
;

179 
tıh
->
ack_£q
 = 
	`htÚl
(ack_seq);

182 
tıh
->
wšdow
 = 
	`htÚs
(
	`MIN
(wšdow, 
TCP_MAX_WINDOW
));

184 
tıİt
 = (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
;

185 
ts
 = (
ušt32_t
 *)(
tıİt
 + 4);

187 
tıİt
[0] = 
TCP_OPT_NOP
;

188 
tıİt
[1] = 
TCP_OPT_NOP
;

189 
tıİt
[2] = 
TCP_OPT_TIMESTAMP
;

190 
tıİt
[3] = 
TCP_OPT_TIMESTAMP_LEN
;

191 
ts
[0] = 
	`htÚl
(
cur_ts
);

192 
ts
[1] = 
	`htÚl
(
echo_ts
);

194 
tıh
->
doff
 = (
TCP_HEADER_LEN
 + 
İ’
) >> 2;

196 ià(
·ylßdËn
 > 0) {

197 
	`memıy
((
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
 + 
İ’
, 
·ylßd
, 
·ylßdËn
);

198 #ià
	`defšed
(
NETSTAT
è&& defšed(
ENABLELRO
)

199 
mtı
->
n¡©
.
tx_gd±by‹s
 +ğ
·ylßdËn
;

203 #ià
TCP_CALCULATE_CHECKSUM


204 #iâdeà
DISABLE_HWCSUM


205 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

206 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
	`G‘OuutIÁ”çû
(
daddr
),

207 
PKT_TX_TCPIP_CSUM
, 
NULL
);

209 ià(
rc
 == -1)

210 
tıh
->
check
 = 
	`TCPC®cChecksum
((
ušt16_t
 *)tcph,

211 
TCP_HEADER_LEN
 + 
İ’
 + 
·ylßdËn
,

212 
§ddr
, 
daddr
);

215 ià(
tıh
->
syn
 ||ıh->
fš
) {

216 
·ylßdËn
++;

219  
·ylßdËn
;

220 
	}
}

223 
	$S’dTCPPack‘
(
mtı_mªag”
 *
mtı
, 
tı_¡»am
 *
cur_¡»am
,

224 
ušt32_t
 
cur_ts
, 
ušt8_t
 
æags
, ušt8_ˆ*
·ylßd
, 
ušt16_t
 
·ylßdËn
)

226 
tıhdr
 *
tıh
;

227 
ušt16_t
 
İ’
;

228 
ušt8_t
 
wsÿË
 = 0;

229 
ušt32_t
 
wšdow32
 = 0;

230 
rc
 = -1;

232 
İ’
 = 
	`C®cuÏ‹O±iÚL’gth
(
æags
);

233 ià(
·ylßdËn
 > 
cur_¡»am
->
¢dv¬
->
mss
 + 
İ’
) {

234 
	`TRACE_ERROR
("Payload sizeƒxceeds MSS\n");

235  
ERROR
;

238 
tıh
 = (
tıhdr
 *)
	`IPOuut
(
mtı
, 
cur_¡»am
,

239 
TCP_HEADER_LEN
 + 
İ’
 + 
·ylßdËn
);

240 ià(
tıh
 =ğ
NULL
) {

243 
	`mem£t
(
tıh
, 0, 
TCP_HEADER_LEN
 + 
İ’
);

245 
tıh
->
sourû
 = 
cur_¡»am
->
¥Üt
;

246 
tıh
->
de¡
 = 
cur_¡»am
->
dpÜt
;

248 ià(
æags
 & 
TCP_FLAG_SYN
) {

249 
tıh
->
syn
 = 
TRUE
;

250 ià(
cur_¡»am
->
¢d_nxt
 !ğcur_¡»am->
¢dv¬
->
iss
) {

251 
	`TRACE_DBG
("Stream %d: weird SYN sequence. "

252 "¢d_nxt: %u, iss: %u\n", 
cur_¡»am
->
id
,

253 
cur_¡»am
->
¢d_nxt
, cur_¡»am->
¢dv¬
->
iss
);

256 
	`TRACE_FIN
("Stream %d: Sending SYN. seq: %u,‡ck_seq: %u\n",

257 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
rcv_nxt
);

260 ià(
æags
 & 
TCP_FLAG_RST
) {

261 
	`TRACE_FIN
("SŒ—m %d: S’dšg RST.\n", 
cur_¡»am
->
id
);

262 
tıh
->
r¡
 = 
TRUE
;

264 ià(
æags
 & 
TCP_FLAG_PSH
)

265 
tıh
->
psh
 = 
TRUE
;

267 ià(
æags
 & 
TCP_FLAG_WACK
) {

268 
tıh
->
£q
 = 
	`htÚl
(
cur_¡»am
->
¢d_nxt
 - 1);

269 
	`TRACE_CLWND
("%u Sending ACKo get‚ew window‡dvertisement. "

271 
cur_¡»am
->
id
,

272 
cur_¡»am
->
¢d_nxt
 - 1, cur_¡»am->
¢dv¬
->
³”_wnd
,

273 
cur_¡»am
->
¢d_nxt
 - cur_¡»am->
¢dv¬
->
¢d_uÇ
);

274 } ià(
æags
 & 
TCP_FLAG_FIN
) {

275 
tıh
->
fš
 = 
TRUE
;

277 ià(
cur_¡»am
->
¢dv¬
->
fss
 == 0) {

278 
	`TRACE_ERROR
("Stream %u:‚ot fss set. closed: %u\n",

279 
cur_¡»am
->
id
, cur_¡»am->
şo£d
);

281 
tıh
->
£q
 = 
	`htÚl
(
cur_¡»am
->
¢dv¬
->
fss
);

282 
cur_¡»am
->
¢dv¬
->
is_fš_£Á
 = 
TRUE
;

283 
	`TRACE_FIN
("Stream %d: Sending FIN. seq: %u,‡ck_seq: %u\n",

284 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
rcv_nxt
);

286 
tıh
->
£q
 = 
	`htÚl
(
cur_¡»am
->
¢d_nxt
);

289 ià(
æags
 & 
TCP_FLAG_ACK
) {

290 
tıh
->
ack
 = 
TRUE
;

291 
tıh
->
ack_£q
 = 
	`htÚl
(
cur_¡»am
->
rcv_nxt
);

292 
cur_¡»am
->
¢dv¬
->
ts_Ï¡ack_£Á
 = 
cur_ts
;

293 
cur_¡»am
->
Ï¡_aùive_ts
 = 
cur_ts
;

294 
	`Upd©eTimeoutLi¡
(
mtı
, 
cur_¡»am
);

297 ià(
æags
 & 
TCP_FLAG_SYN
) {

298 
wsÿË
 = 0;

300 
wsÿË
 = 
cur_¡»am
->
¢dv¬
->
wsÿË_mše
;

303 
wšdow32
 = 
cur_¡»am
->
rcvv¬
->
rcv_wnd
 >> 
wsÿË
;

304 
tıh
->
wšdow
 = 
	`htÚs
((
ušt16_t
)
	`MIN
(
wšdow32
, 
TCP_MAX_WINDOW
));

306 ià(
wšdow32
 == 0) {

307 
cur_¡»am
->
Ãed_wnd_adv
 = 
TRUE
;

310 
	`G’”©eTCPO±iÚs
(
cur_¡»am
, 
cur_ts
, 
æags
,

311 (
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
, 
İ’
);

313 
tıh
->
doff
 = (
TCP_HEADER_LEN
 + 
İ’
) >> 2;

315 ià(
·ylßdËn
 > 0) {

316 
	`memıy
((
ušt8_t
 *)
tıh
 + 
TCP_HEADER_LEN
 + 
İ’
, 
·ylßd
, 
·ylßdËn
);

317 #ià
	`defšed
(
NETSTAT
è&& defšed(
ENABLELRO
)

318 
mtı
->
n¡©
.
tx_gd±by‹s
 +ğ
·ylßdËn
;

322 #ià
TCP_CALCULATE_CHECKSUM


323 #iâdeà
DISABLE_HWCSUM


324 ià(
mtı
->
iom
->
dev_ioùl
 !ğ
NULL
)

325 
rc
 = 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 
cur_¡»am
->
¢dv¬
->
nif_out
,

326 
PKT_TX_TCPIP_CSUM
, 
NULL
);

328 ià(
rc
 == -1)

329 
tıh
->
check
 = 
	`TCPC®cChecksum
((
ušt16_t
 *)tcph,

330 
TCP_HEADER_LEN
 + 
İ’
 + 
·ylßdËn
,

331 
cur_¡»am
->
§ddr
, cur_¡»am->
daddr
);

334 
cur_¡»am
->
¢d_nxt
 +ğ
·ylßdËn
;

336 ià(
tıh
->
syn
 ||ıh->
fš
) {

337 
cur_¡»am
->
¢d_nxt
++;

338 
·ylßdËn
++;

341 ià(
·ylßdËn
 > 0) {

342 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_ESTABLISHED
) {

343 
	`TRACE_FIN
("Payload‡fter ESTABLISHED:†ength: %d, snd_nxt: %u\n",

344 
·ylßdËn
, 
cur_¡»am
->
¢d_nxt
);

348 
cur_¡»am
->
¢dv¬
->
ts_¹o
 = 
cur_ts
 + cur_¡»am->¢dv¬->
¹o
;

349 
	`TRACE_RTO
("Updating„etransmissionimer. "

351 
cur_ts
, 
cur_¡»am
->
¢dv¬
->
¹o
, cur_¡»am->¢dv¬->
ts_¹o
);

352 
	`AddtoRTOLi¡
(
mtı
, 
cur_¡»am
);

355  
·ylßdËn
;

356 
	}
}

359 
	$FlushTCPS’dšgBufãr
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
)

361 
tı_£nd_v¬s
 *
¢dv¬
 = 
cur_¡»am
->sndvar;

362 cÚ¡ 
ušt32_t
 
maxËn
 = 
¢dv¬
->
mss
 - 
	`C®cuÏ‹O±iÚL’gth
(
TCP_FLAG_ACK
);

363 
ušt8_t
 *
d©a
;

364 
ušt32_t
 
bufã»d_Ën
;

365 
ušt32_t
 
£q
;

366 
ušt16_t
 
Ën
;

367 
št16_t
 
¢dËn
;

368 
ušt32_t
 
wšdow
;

369 
·ck‘s
 = 0;

371 ià(!
¢dv¬
->
¢dbuf
) {

372 
	`TRACE_ERROR
("SŒ—m %d: NØ£nd bufã¸avaabË.\n", 
cur_¡»am
->
id
);

373 
	`as£¹
(0);

377 
	`SBUF_LOCK
(&
¢dv¬
->
wr™e_lock
);

379 ià(
¢dv¬
->
¢dbuf
->
Ën
 == 0) {

380 
·ck‘s
 = 0;

381 
out
;

384 
wšdow
 = 
	`MIN
(
¢dv¬
->
cwnd
, sndv¬->
³”_wnd
);

387 
£q
 = 
cur_¡»am
->
¢d_nxt
;

389 ià(
	`TCP_SEQ_LT
(
£q
, 
¢dv¬
->
¢dbuf
->
h—d_£q
)) {

390 
	`TRACE_ERROR
("Stream %d: Invalid sequenceo send. "

392 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream),

393 
£q
, 
¢dv¬
->
¢dbuf
->
h—d_£q
);

394 
	`as£¹
(0);

397 
bufã»d_Ën
 = 
¢dv¬
->
¢dbuf
->
h—d_£q
 + sndv¬->¢dbuf->
Ën
 - 
£q
;

398 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_ESTABLISHED
) {

399 
	`TRACE_FIN
("head_seq: %u,†en: %u, seq: %u, "

400 "bufã»d_Ën: %u\n", 
¢dv¬
->
¢dbuf
->
h—d_£q
,

401 
¢dv¬
->
¢dbuf
->
Ën
, 
£q
, 
bufã»d_Ën
);

403 ià(
bufã»d_Ën
 == 0)

406 
d©a
 = 
¢dv¬
->
¢dbuf
->
h—d
 +

407 (
£q
 - 
¢dv¬
->
¢dbuf
->
h—d_£q
);

409 ià(
bufã»d_Ën
 > 
maxËn
) {

410 
Ën
 = 
maxËn
;

412 
Ën
 = 
bufã»d_Ën
;

415 ià(
Ën
 <= 0)

418 ià(
cur_¡»am
->
¡©e
 > 
TCP_ST_ESTABLISHED
) {

419 
	`TRACE_FIN
("Flushing‡fter ESTABLISHED: seq: %u,†en: %u, "

420 "bufã»d_Ën: %u\n", 
£q
, 
Ën
, 
bufã»d_Ën
);

423 ià(
£q
 - 
¢dv¬
->
¢d_uÇ
 + 
Ën
 > 
wšdow
) {

425 ià(
£q
 - 
¢dv¬
->
¢d_uÇ
 + 
Ën
 > sndv¬->
³”_wnd
) {

427 
	`TRACE_CLWND
("Full…eer window. "

429 
¢dv¬
->
³”_wnd
, 
£q
 - sndv¬->
¢d_uÇ
);

431 ià(
	`TS_TO_MSEC
(
cur_ts
 - 
¢dv¬
->
ts_Ï¡ack_£Á
) > 500) {

432 
	`EnqueueACK
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
ACK_OPT_WACK
);

435 
·ck‘s
 = -3;

436 
out
;

439 
¢dËn
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

440 
TCP_FLAG_ACK
, 
d©a
, 
Ën
);

441 ià(
¢dËn
 < 0) {

442 
·ck‘s
 = 
¢dËn
;

443 
out
;

445 
·ck‘s
++;

448 
out
:

449 
	`SBUF_UNLOCK
(&
¢dv¬
->
wr™e_lock
);

450  
·ck‘s
;

451 
	}
}

453 
šlše
 

454 
	$S’dCÚŒŞPack‘
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
)

456 
tı_£nd_v¬s
 *
¢dv¬
 = 
cur_¡»am
->sndvar;

457 
»t
 = 0;

459 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_SENT
) {

461 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_SYN
, 
NULL
, 0);

463 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_RCVD
) {

465 
cur_¡»am
->
¢d_nxt
 = 
¢dv¬
->
iss
;

466 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

467 
TCP_FLAG_SYN
 | 
TCP_FLAG_ACK
, 
NULL
, 0);

469 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

471 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_ACK
, 
NULL
, 0);

473 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

475 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_ACK
, 
NULL
, 0);

477 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
) {

479 ià(
¢dv¬
->
Ú_£nd_li¡
 || sndv¬->
Ú_ack_li¡
) {

480 
»t
 = -1;

483 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

484 
TCP_FLAG_FIN
 | 
TCP_FLAG_ACK
, 
NULL
, 0);

486 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
) {

488 ià(
¢dv¬
->
Ú_£nd_li¡
 || sndv¬->
Ú_ack_li¡
) {

489 
»t
 = -1;

492 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

493 
TCP_FLAG_FIN
 | 
TCP_FLAG_ACK
, 
NULL
, 0);

496 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
) {

498 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_ACK
, 
NULL
, 0);

500 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
) {

501 ià(
¢dv¬
->
is_fš_£Á
) {

503 ià(
cur_¡»am
->
¢d_nxt
 =ğ
¢dv¬
->
fss
) {

504 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

505 
TCP_FLAG_FIN
 | 
TCP_FLAG_ACK
, 
NULL
, 0);

507 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

508 
TCP_FLAG_ACK
, 
NULL
, 0);

512 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
,

513 
TCP_FLAG_FIN
 | 
TCP_FLAG_ACK
, 
NULL
, 0);

516 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_TIME_WAIT
) {

518 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_ACK
, 
NULL
, 0);

520 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSED
) {

522 
	`TRACE_DBG
("Stream %d: Try sending RST (TCP_ST_CLOSED)\n",

523 
cur_¡»am
->
id
);

525 ià(
¢dv¬
->
Ú_£nd_li¡
 || sndv¬->
Ú_ack_li¡
) {

526 
»t
 = -1;

528 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
, 
TCP_FLAG_RST
, 
NULL
, 0);

529 ià(
»t
 >= 0) {

530 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

535  
»t
;

536 
	}
}

539 
	$Wr™eTCPCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
,

540 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
)

542 
tı_¡»am
 *
cur_¡»am
;

543 
tı_¡»am
 *
Ãxt
, *
Ï¡
;

544 
út
 = 0;

545 
»t
;

547 
th»sh
 = 
	`MIN
Ñh»sh, 
£nd”
->
cÚŒŞ_li¡_út
);

550 
út
 = 0;

551 
cur_¡»am
 = 
	`TAILQ_FIRST
(&
£nd”
->
cÚŒŞ_li¡
);

552 
Ï¡
 = 
	`TAILQ_LAST
(&
£nd”
->
cÚŒŞ_li¡
, 
mtı_£nd”
::
cÚŒŞ_h—d
);

553 
cur_¡»am
) {

554 ià(++
út
 > 
th»sh
)

557 
	`TRACE_LOOP
("Inside control†oop. cnt: %u, stream: %d\n",

558 
út
, 
cur_¡»am
->
id
);

559 
Ãxt
 = 
	`TAILQ_NEXT
(
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

561 
	`TAILQ_REMOVE
(&
£nd”
->
cÚŒŞ_li¡
, 
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

562 
£nd”
->
cÚŒŞ_li¡_út
--;

564 ià(
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

565 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 = 
FALSE
;

567 
»t
 = 
	`S’dCÚŒŞPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
);

568 ià(
»t
 < 0) {

569 
	`TAILQ_INSERT_HEAD
(&
£nd”
->
cÚŒŞ_li¡
,

570 
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

571 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 = 
TRUE
;

572 
£nd”
->
cÚŒŞ_li¡_út
++;

577 
	`TRACE_ERROR
("SŒ—m %d:‚Ù oÀcÚŒŞ†i¡.\n", 
cur_¡»am
->
id
);

580 ià(
cur_¡»am
 =ğ
Ï¡
)

582 
cur_¡»am
 = 
Ãxt
;

585  
út
;

586 
	}
}

589 
	$Wr™eTCPD©aLi¡
(
mtı_mªag”_t
 
mtı
,

590 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
)

592 
tı_¡»am
 *
cur_¡»am
;

593 
tı_¡»am
 *
Ãxt
, *
Ï¡
;

594 
út
 = 0;

595 
»t
;

598 
út
 = 0;

599 
cur_¡»am
 = 
	`TAILQ_FIRST
(&
£nd”
->
£nd_li¡
);

600 
Ï¡
 = 
	`TAILQ_LAST
(&
£nd”
->
£nd_li¡
, 
mtı_£nd”
::
£nd_h—d
);

601 
cur_¡»am
) {

602 ià(++
út
 > 
th»sh
)

605 
	`TRACE_LOOP
("Inside send†oop. cnt: %u, stream: %d\n",

606 
út
, 
cur_¡»am
->
id
);

607 
Ãxt
 = 
	`TAILQ_NEXT
(
cur_¡»am
, 
¢dv¬
->
£nd_lšk
);

609 
	`TAILQ_REMOVE
(&
£nd”
->
£nd_li¡
, 
cur_¡»am
, 
¢dv¬
->
£nd_lšk
);

610 ià(
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
) {

611 
»t
 = 0;

615 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

616 ià(
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

619 
»t
 = -1;

621 
»t
 = 
	`FlushTCPS’dšgBufãr
(
mtı
, 
cur_¡»am
, 
cur_ts
);

623 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 ||

624 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

625 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
) {

626 
»t
 = 
	`FlushTCPS’dšgBufãr
(
mtı
, 
cur_¡»am
, 
cur_ts
);

628 
	`TRACE_DBG
("Stream %d: on_send_list‡t state %s\n",

629 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream));

630 #ià
DUMP_STREAM


631 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

635 ià(
»t
 < 0) {

636 
	`TAILQ_INSERT_TAIL
(&
£nd”
->
£nd_li¡
, 
cur_¡»am
, 
¢dv¬
->
£nd_lšk
);

641 
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
 = 
FALSE
;

642 
£nd”
->
£nd_li¡_út
--;

645 #ià
ACK_PIGGYBACK


646 ià(
cur_¡»am
->
¢dv¬
->
ack_út
 > 0) {

647 ià(
cur_¡»am
->
¢dv¬
->
ack_út
 > 
»t
) {

648 
cur_¡»am
->
¢dv¬
->
ack_út
 -ğ
»t
;

650 
cur_¡»am
->
¢dv¬
->
ack_út
 = 0;

655 ià(
cur_¡»am
->
cÚŒŞ_li¡_wa™šg
) {

656 ià(!
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
) {

657 
cur_¡»am
->
cÚŒŞ_li¡_wa™šg
 = 
FALSE
;

658 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

664 
	`TRACE_ERROR
("SŒ—m %d:‚Ù oÀ£nd†i¡.\n", 
cur_¡»am
->
id
);

665 #ifdeà
DUMP_STREAM


666 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

670 ià(
cur_¡»am
 =ğ
Ï¡
)

672 
cur_¡»am
 = 
Ãxt
;

675  
út
;

676 
	}
}

679 
	$Wr™eTCPACKLi¡
(
mtı_mªag”_t
 
mtı
,

680 
mtı_£nd”
 *
£nd”
, 
ušt32_t
 
cur_ts
, 
th»sh
)

682 
tı_¡»am
 *
cur_¡»am
;

683 
tı_¡»am
 *
Ãxt
, *
Ï¡
;

684 
to_ack
;

685 
út
 = 0;

686 
»t
;

689 
út
 = 0;

690 
cur_¡»am
 = 
	`TAILQ_FIRST
(&
£nd”
->
ack_li¡
);

691 
Ï¡
 = 
	`TAILQ_LAST
(&
£nd”
->
ack_li¡
, 
mtı_£nd”
::
ack_h—d
);

692 
cur_¡»am
) {

693 ià(++
út
 > 
th»sh
)

696 
	`TRACE_LOOP
("Insidack†oİ. cÁ: %u\n", 
út
);

697 
Ãxt
 = 
	`TAILQ_NEXT
(
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

699 ià(
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
) {

702 
to_ack
 = 
FALSE
;

703 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
 ||

704 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 ||

705 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

706 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
 ||

707 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_TIME_WAIT
) {

710 ià(
cur_¡»am
->
rcvv¬
->
rcvbuf
) {

711 ià(
	`TCP_SEQ_LEQ
(
cur_¡»am
->
rcv_nxt
,

712 
cur_¡»am
->
rcvv¬
->
rcvbuf
->
h—d_£q
 +

713 
cur_¡»am
->
rcvv¬
->
rcvbuf
->
m”ged_Ën
)) {

714 
to_ack
 = 
TRUE
;

718 
	`TRACE_DBG
("Stream %u (%s): "

721 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream),

722 
cur_¡»am
->
¢d_nxt
, cur_¡»am->
rcv_nxt
,

723 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
);

724 #ifdeà
DUMP_STREAM


725 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

729 ià(
to_ack
) {

731 
cur_¡»am
->
¢dv¬
->
ack_út
 > 0) {

732 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
,

733 
cur_ts
, 
TCP_FLAG_ACK
, 
NULL
, 0);

734 ià(
»t
 < 0) {

738 
cur_¡»am
->
¢dv¬
->
ack_út
--;

742 ià(
cur_¡»am
->
¢dv¬
->
is_wack
) {

743 
cur_¡»am
->
¢dv¬
->
is_wack
 = 
FALSE
;

744 
»t
 = 
	`S’dTCPPack‘
(
mtı
, 
cur_¡»am
,

745 
cur_ts
, 
TCP_FLAG_ACK
 | 
TCP_FLAG_WACK
, 
NULL
, 0);

746 ià(
»t
 < 0) {

748 
cur_¡»am
->
¢dv¬
->
is_wack
 = 
TRUE
;

752 ià(!(
cur_¡»am
->
¢dv¬
->
ack_út
 || cur_¡»am->¢dv¬->
is_wack
)) {

753 
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
 = 
FALSE
;

754 
	`TAILQ_REMOVE
(&
£nd”
->
ack_li¡
, 
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

755 
£nd”
->
ack_li¡_út
--;

758 
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
 = 
FALSE
;

759 
cur_¡»am
->
¢dv¬
->
ack_út
 = 0;

760 
cur_¡»am
->
¢dv¬
->
is_wack
 = 0;

761 
	`TAILQ_REMOVE
(&
£nd”
->
ack_li¡
, 
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

762 
£nd”
->
ack_li¡_út
--;

765 ià(
cur_¡»am
->
cÚŒŞ_li¡_wa™šg
) {

766 ià(!
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
) {

767 
cur_¡»am
->
cÚŒŞ_li¡_wa™šg
 = 
FALSE
;

768 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

772 
	`TRACE_ERROR
("SŒ—m %d:‚Ù oÀack†i¡.\n", 
cur_¡»am
->
id
);

773 
	`TAILQ_REMOVE
(&
£nd”
->
ack_li¡
, 
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

774 
£nd”
->
ack_li¡_út
--;

775 #ifdeà
DUMP_STREAM


776 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

777 "SŒ—m %u:‚Ù oÀack†i¡.\n", 
cur_¡»am
->
id
);

778 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

782 ià(
cur_¡»am
 =ğ
Ï¡
)

784 
cur_¡»am
 = 
Ãxt
;

787  
út
;

788 
	}
}

790 
šlše
 
mtı_£nd”
 *

791 
	$G‘S’d”
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

793 ià(
cur_¡»am
->
¢dv¬
->
nif_out
 < 0) {

795  
mtı
->
g_£nd”
;

797 } ià(
cur_¡»am
->
¢dv¬
->
nif_out
 >ğ
CONFIG
.
‘hs_num
) {

798 
	`TRACE_ERROR
("(NEVER HAPPEN) Failedo find‡ppropriate sender.\n");

799  
NULL
;

803  
mtı
->
n_£nd”
[
cur_¡»am
->
¢dv¬
->
nif_out
];

805 
	}
}

808 
	$AddtoCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
)

810 #ià
TRY_SEND_BEFORE_QUEUE


811 
»t
;

812 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

813 
	`as£¹
(
£nd”
 !ğ
NULL
);

815 
»t
 = 
	`S’dCÚŒŞPack‘
(
mtı
, 
cur_¡»am
, 
cur_ts
);

816 ià(
»t
 < 0) {

818 ià(!
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

819 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

820 
	`as£¹
(
£nd”
 !ğ
NULL
);

822 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 = 
TRUE
;

823 
	`TAILQ_INSERT_TAIL
(&
£nd”
->
cÚŒŞ_li¡
, 
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

824 
£nd”
->
cÚŒŞ_li¡_út
++;

828 #ià
TRY_SEND_BEFORE_QUEUE


830 ià(
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

831 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 = 
FALSE
;

832 
	`TAILQ_REMOVE
(&
£nd”
->
cÚŒŞ_li¡
, 
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

833 
£nd”
->
cÚŒŞ_li¡_út
--;

837 
	}
}

840 
	$AddtoS’dLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

842 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

843 
	`as£¹
(
£nd”
 !ğ
NULL
);

845 if(!
cur_¡»am
->
¢dv¬
->
¢dbuf
) {

846 
	`TRACE_ERROR
("[%d] Stream %d: No send buffer‡vailable.\n",

847 
mtı
->
ùx
->
ıu
,

848 
cur_¡»am
->
id
);

849 
	`as£¹
(0);

853 ià(!
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
) {

854 
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
 = 
TRUE
;

855 
	`TAILQ_INSERT_TAIL
(&
£nd”
->
£nd_li¡
, 
cur_¡»am
, 
¢dv¬
->
£nd_lšk
);

856 
£nd”
->
£nd_li¡_út
++;

858 
	}
}

861 
	$AddtoACKLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

863 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

864 
	`as£¹
(
£nd”
 !ğ
NULL
);

866 ià(!
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
) {

867 
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
 = 
TRUE
;

868 
	`TAILQ_INSERT_TAIL
(&
£nd”
->
ack_li¡
, 
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

869 
£nd”
->
ack_li¡_út
++;

871 
	}
}

874 
	$RemoveFromCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

876 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

877 
	`as£¹
(
£nd”
 !ğ
NULL
);

879 ià(
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

880 
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
 = 
FALSE
;

881 
	`TAILQ_REMOVE
(&
£nd”
->
cÚŒŞ_li¡
, 
cur_¡»am
, 
¢dv¬
->
cÚŒŞ_lšk
);

882 
£nd”
->
cÚŒŞ_li¡_út
--;

886 
	}
}

889 
	$RemoveFromS’dLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

891 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

892 
	`as£¹
(
£nd”
 !ğ
NULL
);

894 ià(
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
) {

895 
cur_¡»am
->
¢dv¬
->
Ú_£nd_li¡
 = 
FALSE
;

896 
	`TAILQ_REMOVE
(&
£nd”
->
£nd_li¡
, 
cur_¡»am
, 
¢dv¬
->
£nd_lšk
);

897 
£nd”
->
£nd_li¡_út
--;

899 
	}
}

902 
	$RemoveFromACKLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

904 
mtı_£nd”
 *
£nd”
 = 
	`G‘S’d”
(
mtı
, 
cur_¡»am
);

905 
	`as£¹
(
£nd”
 !ğ
NULL
);

907 ià(
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
) {

908 
cur_¡»am
->
¢dv¬
->
Ú_ack_li¡
 = 
FALSE
;

909 
	`TAILQ_REMOVE
(&
£nd”
->
ack_li¡
, 
cur_¡»am
, 
¢dv¬
->
ack_lšk
);

910 
£nd”
->
ack_li¡_út
--;

912 
	}
}

915 
	$EnqueueACK
(
mtı_mªag”_t
 
mtı
,

916 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
, 
ušt8_t
 
İt
)

918 ià(!(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
 ||

919 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
 ||

920 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

921 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_2
)) {

922 
	`TRACE_DBG
("Stream %u: Enqueueing‡ck‡t state %s\n",

923 
cur_¡»am
->
id
, 
	`TCPS‹ToSŒšg
(cur_stream));

926 ià(
İt
 =ğ
ACK_OPT_NOW
) {

927 ià(
cur_¡»am
->
¢dv¬
->
ack_út
 < cur_stream->sndvar->ack_cnt + 1) {

928 
cur_¡»am
->
¢dv¬
->
ack_út
++;

930 } ià(
İt
 =ğ
ACK_OPT_AGGREGATE
) {

931 ià(
cur_¡»am
->
¢dv¬
->
ack_út
 == 0) {

932 
cur_¡»am
->
¢dv¬
->
ack_út
 = 1;

934 } ià(
İt
 =ğ
ACK_OPT_WACK
) {

935 
cur_¡»am
->
¢dv¬
->
is_wack
 = 
TRUE
;

937 
	`AddtoACKLi¡
(
mtı
, 
cur_¡»am
);

938 
	}
}

941 
	$DumpCÚŒŞLi¡
(
mtı_mªag”_t
 
mtı
, 
mtı_£nd”
 *
£nd”
)

943 
tı_¡»am
 *
¡»am
;

945 
	`TRACE_DBG
("Dumpšg cÚŒŞ†i¡ (couÁ: %d):\n", 
£nd”
->
cÚŒŞ_li¡_út
);

946 
	`TAILQ_FOREACH
(
¡»am
, &
£nd”
->
cÚŒŞ_li¡
, 
¢dv¬
->
cÚŒŞ_lšk
) {

947 
	`TRACE_DBG
("SŒ—m id: %u iÀcÚŒŞ†i¡\n", 
¡»am
->
id
);

949 
	}
}

	@tcp_rb_frag_queue.cpp

23 
	~"tı_rb_äag_queue.h
"

24 
	~"debug.h
"

27 #iâdeà
_INDEX_TYPE_


28 
	#_INDEX_TYPE_


	)

29 
ušt32_t
 
	tšdex_ty³
;

30 
št32_t
 
	tsigÃd_šdex_ty³
;

33 
	srb_äag_queue


35 
šdex_ty³
 
	m_ÿ·c™y
;

36 vŞ©
šdex_ty³
 
	m_h—d
;

37 vŞ©
šdex_ty³
 
	m_
;

39 
äagm’t_ùx
 * vŞ©* 
	m_q
;

42 
šlše
 
šdex_ty³


43 
	$NextIndex
(
rb_äag_queue_t
 
rb_äagq
, 
šdex_ty³
 
i
)

45  (
i
 !ğ
rb_äagq
->
_ÿ·c™y
 ? i + 1: 0);

46 
	}
}

48 
šlše
 
šdex_ty³


49 
	$P»vIndex
(
rb_äag_queue_t
 
rb_äagq
, 
šdex_ty³
 
i
)

51  (
i
 !ğ0 ? i - 1: 
rb_äagq
->
_ÿ·c™y
);

52 
	}
}

54 
šlše
 

55 
	$RBF¿gMemÜyB¬r›r
(
äagm’t_ùx
 * vŞ©
äag
, vŞ©
šdex_ty³
 
šdex
)

57 
__asm__
 vŞ©e("" : : "m" (
äag
), "m" (
šdex
));

58 
	}
}

60 
rb_äag_queue_t


61 
	$C»©eRBF¿gQueue
(
ÿ·c™y
)

63 
rb_äag_queue_t
 
rb_äagq
;

65 
rb_äagq
 = (
rb_äag_queue_t
)
	`ÿÎoc
(1, (
rb_äag_queue
));

66 ià(!
rb_äagq
)

67  
NULL
;

69 
rb_äagq
->
_q
 = (
äagm’t_ùx
 **)

70 
	`ÿÎoc
(
ÿ·c™y
 + 1, (
äagm’t_ùx
 *));

71 ià(!
rb_äagq
->
_q
) {

72 
	`ä“
(
rb_äagq
);

73  
NULL
;

76 
rb_äagq
->
_ÿ·c™y
 = 
ÿ·c™y
;

77 
rb_äagq
->
_h—d
 =„b_äagq->
_
 = 0;

79  
rb_äagq
;

80 
	}
}

83 
	$De¡royRBF¿gQueue
(
rb_äag_queue_t
 
rb_äagq
)

85 ià(!
rb_äagq
)

88 ià(
rb_äagq
->
_q
) {

89 
	`ä“
((*)
rb_äagq
->
_q
);

90 
rb_äagq
->
_q
 = 
NULL
;

93 
	`ä“
(
rb_äagq
);

94 
	}
}

97 
	$RBF¿gEnqueue
(
rb_äag_queue_t
 
rb_äagq
, 
äagm’t_ùx
 *
äag
)

99 
šdex_ty³
 
h
 = 
rb_äagq
->
_h—d
;

100 
šdex_ty³
 
t
 = 
rb_äagq
->
_
;

101 
šdex_ty³
 
Á
 = 
	`NextIndex
(
rb_äagq
, 
t
);

103 ià(
Á
 !ğ
h
) {

104 
rb_äagq
->
_q
[
t
] = 
äag
;

105 
	`RBF¿gMemÜyB¬r›r
(
rb_äagq
->
_q
[
t
],„b_äagq->
_
);

106 
rb_äagq
->
_
 = 
Á
;

110 
	`TRACE_ERROR
("Exceed capacity of frag queue!\n");

112 
	}
}

114 
äagm’t_ùx
 *

115 
	$RBF¿gDequeue
(
rb_äag_queue_t
 
rb_äagq
)

117 
šdex_ty³
 
h
 = 
rb_äagq
->
_h—d
;

118 
šdex_ty³
 
t
 = 
rb_äagq
->
_
;

120 ià(
h
 !ğ
t
) {

121 
äagm’t_ùx
 *
äag
 = 
rb_äagq
->
_q
[
h
];

122 
	`RBF¿gMemÜyB¬r›r
(
rb_äagq
->
_q
[
h
],„b_äagq->
_h—d
);

123 
rb_äagq
->
_h—d
 = 
	`NextIndex
Ôb_äagq, 
h
);

124 
	`as£¹
(
äag
);

126  
äag
;

129  
NULL
;

130 
	}
}

	@tcp_ring_buffer.cpp

1 
	~<¡dlib.h
>

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

4 
	~<as£¹.h
>

5 
	~<sys/ty³s.h
>

7 
	~"tı_ršg_bufãr.h
"

8 
	~"tı_rb_äag_queue.h
"

9 
	~"memÜy_mgt.h
"

10 
	~"debug.h
"

12 
	#MAX_RB_SIZE
 (16*1024*1024)

	)

13 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

14 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

15 #ifdeà
ENABLELRO


16 
	#__MEMCPY_DATA_2_BUFFER
 \

17 
mtı_mªag”_t
 
mtı
 = 
rbm
->mtcp; \

18 ià(
mtı
->
iom
 =ğ&
dpdk_moduË_func
 && 
Ën
 > 
TCP_DEFAULT_MSS
) \

19 
mtı
->
iom
->
	`dev_ioùl
(mtı->
ùx
, 0, 
PKT_RX_TCP_LROSEG
, 
buff
->
h—d
 + 
putx
); \

21 
	`memıy
(
buff
->
h—d
 + 
putx
, 
d©a
, 
Ën
);

	)

24 
	srb_mªag”


26 
size_t
 
	mchunk_size
;

27 
ušt32_t
 
	mcur_num
;

28 
ušt32_t
 
	múum
;

30 
mem_poŞ_t
 
	mmp
;

31 
mem_poŞ_t
 
	mäag_mp
;

33 
rb_äag_queue_t
 
	mä“_äagq
;

34 
rb_äag_queue_t
 
	mä“_äagq_št
;

35 #ifdeà
ENABLELRO


36 
mtı_mªag”_t
 
	mmtı
;

38 } 
	grb_mªag”
;

40 
ušt32_t


41 
	$RBG‘Cuºum
(
rb_mªag”_t
 
rbm
)

43  
rbm
->
cur_num
;

44 
	}
}

47 
	$RBPrštInfo
(
tı_ršg_bufãr
* 
buff
)

49 
	`´štf
("buff_data %p, buff_size %d, buff_mlen %d, "

51 
buff
->
d©a
, buff->
size
, buff->
m”ged_Ën
, buff->
cum_Ën
,

52 
buff
->
h—d
, buff->
h—d_off£t
, buff->
_off£t
);

53 
	}
}

56 
	$RBPrštSŒ
(
tı_ršg_bufãr
* 
buff
)

58 
	`RBPrštInfo
(
buff
);

59 
	`´štf
("%s\n", 
buff
->
h—d
);

60 
	}
}

63 
	$RBPrštHex
(
tı_ršg_bufãr
* 
buff
)

65 
i
;

67 
	`RBPrštInfo
(
buff
);

69 
i
 = 0; i < 
buff
->
m”ged_Ën
; i++) {

70 ià(
i
 != 0 && i % 16 == 0)

71 
	`´štf
("\n");

72 
	`´štf
("%0x ", *Ğ(*è
buff
->
h—d
 + 
i
));

74 
	`´štf
("\n");

75 
	}
}

77 
	grb_mªag”_t


78 #ifdeà
ENABLELRO


79 
	$RBMªag”C»©e
(
mtı_mªag”_t
 
mtı
, 
size_t
 
chunk_size
, 
ušt32_t
 
úum
)

81 
	$RBMªag”C»©e
(
size_t
 
chunk_size
, 
ušt32_t
 
úum
)

84 
rb_mªag”_t
 
rbm
 = (rb_mªag”_tè
	`ÿÎoc
(1, (
rb_mªag”
));

86 ià(!
rbm
) {

87 
	`³¼Ü
("rbm_create calloc");

88  
NULL
;

91 
rbm
->
chunk_size
 = chunk_size;

92 
rbm
->
úum
 = cnum;

93 
rbm
->
mp
 = (
mem_poŞ_t
)
	`MPC»©e
(
chunk_size
, (
ušt64_t
)chunk_siz* 
úum
, 0);

94 ià(!
rbm
->
mp
) {

95 
	`TRACE_ERROR
("Failedo‡llocate mp…ool.\n");

96 
	`ä“
(
rbm
);

97  
NULL
;

100 
rbm
->
äag_mp
 = (
mem_poŞ_t
)
	`MPC»©e
((
äagm’t_ùx
),

101 (
äagm’t_ùx
è* 
úum
, 0);

102 ià(!
rbm
->
äag_mp
) {

103 
	`TRACE_ERROR
("Failedo‡llocate frag_mp…ool.\n");

104 
	`MPDe¡roy
(
rbm
->
mp
);

105 
	`ä“
(
rbm
);

106  
NULL
;

109 
rbm
->
ä“_äagq
 = 
	`C»©eRBF¿gQueue
(
úum
);

110 ià(!
rbm
->
ä“_äagq
) {

111 
	`TRACE_ERROR
("Failedo create free fragment queue.\n");

112 
	`MPDe¡roy
(
rbm
->
mp
);

113 
	`MPDe¡roy
(
rbm
->
äag_mp
);

114 
	`ä“
(
rbm
);

115  
NULL
;

117 
rbm
->
ä“_äagq_št
 = 
	`C»©eRBF¿gQueue
(
úum
);

118 ià(!
rbm
->
ä“_äagq_št
) {

119 
	`TRACE_ERROR
("Failedo create internal free fragment queue.\n");

120 
	`MPDe¡roy
(
rbm
->
mp
);

121 
	`MPDe¡roy
(
rbm
->
äag_mp
);

122 
	`De¡royRBF¿gQueue
(
rbm
->
ä“_äagq
);

123 
	`ä“
(
rbm
);

124  
NULL
;

127 #ifdeà
ENABLELRO


128 
rbm
->
mtı
 = mtcp;

130  
rbm
;

131 
	}
}

133 
šlše
 

134 
	$F»eF¿gm’tCÚ‹xtSšgË
(
rb_mªag”_t
 
rbm
, 
äagm’t_ùx
* 
äag
)

136 ià(
äag
->
is_ÿÎoc
)

137 
	`ä“
(
äag
);

139 
	`MPF»eChunk
(
rbm
->
äag_mp
, 
äag
);

140 
	}
}

143 
	$F»eF¿gm’tCÚ‹xt
(
rb_mªag”_t
 
rbm
, 
äagm’t_ùx
* 
fùx
)

145 
äagm’t_ùx
 *
»move
;

147 
	`as£¹
(
fùx
);

148 ià(
fùx
 =ğ
NULL
)

151 
fùx
) {

152 
»move
 = 
fùx
;

153 
fùx
 = fùx->
Ãxt
;

154 
	`F»eF¿gm’tCÚ‹xtSšgË
(
rbm
, 
»move
);

156 
	}
}

158 
äagm’t_ùx
 *

159 
	$AÎoÿ‹F¿gm’tCÚ‹xt
(
rb_mªag”_t
 
rbm
)

162 
äagm’t_ùx
 *
äag
;

165 
äag
 = 
	`RBF¿gDequeue
(
rbm
->
ä“_äagq
);

166 ià(!
äag
) {

167 
äag
 = 
	`RBF¿gDequeue
(
rbm
->
ä“_äagq_št
);

168 ià(!
äag
) {

170 
äag
 = 
	`MPAÎoÿ‹Chunk
(
rbm
->
äag_mp
);

171 ià(!
äag
) {

172 
	`TRACE_ERROR
("fragments depleted, fall backo calloc\n");

173 
äag
 = 
	`ÿÎoc
(1, (
äagm’t_ùx
));

174 ià(
äag
 =ğ
NULL
) {

175 
	`TRACE_ERROR
("calloc failed\n");

176 
	`ex™
(-1);

178 
äag
->
is_ÿÎoc
 = 1;

182 
	`mem£t
(
äag
, 0, (*frag));

183  
äag
;

184 
	}
}

186 
tı_ršg_bufãr
*

187 
	$RBIn™
(
rb_mªag”_t
 
rbm
, 
ušt32_t
 
š™_£q
)

189 
tı_ršg_bufãr
* 
buff
 =

190 (
tı_ršg_bufãr
*)
	`ÿÎoc
(1, (tcp_ring_buffer));

192 ià(
buff
 =ğ
NULL
){

193 
	`³¼Ü
("rb_init buff");

194  
NULL
;

197 
buff
->
d©a
 = 
	`MPAÎoÿ‹Chunk
(
rbm
->
mp
);

198 if(!
buff
->
d©a
){

199 
	`³¼Ü
("rb_init MPAllocateChunk");

200  
NULL
;

205 
buff
->
size
 = 
rbm
->
chunk_size
;

206 
buff
->
h—d
 = buff->
d©a
;

207 
buff
->
h—d_£q
 = 
š™_£q
;

208 
buff
->
š™_£q
 = init_seq;

210 
rbm
->
cur_num
++;

212  
buff
;

213 
	}
}

216 
	$RBF»e
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
)

218 
	`as£¹
(
buff
);

219 ià(
buff
->
fùx
) {

220 
	`F»eF¿gm’tCÚ‹xt
(
rbm
, 
buff
->
fùx
);

221 
buff
->
fùx
 = 
NULL
;

224 ià(
buff
->
d©a
) {

225 
	`MPF»eChunk
(
rbm
->
mp
, 
buff
->
d©a
);

228 
rbm
->
cur_num
--;

230 
	`ä“
(
buff
);

231 
	}
}

233 
	#MAXSEQ
 ((
ušt32_t
)(0xFFFFFFFF))

	)

235 
šlše
 
ušt32_t


236 
	$G‘MšSeq
(
ušt32_t
 
a
, ušt32_ˆ
b
)

238 ià(
a
 =ğ
b
) ‡;

239 ià(
a
 < 
b
)

240  ((
b
 - 
a
è<ğ
MAXSEQ
/2) ?‡ : b;

242  ((
a
 - 
b
è<ğ
MAXSEQ
/2) ? b :‡;

243 
	}
}

245 
šlše
 
ušt32_t


246 
	$G‘MaxSeq
(
ušt32_t
 
a
, ušt32_ˆ
b
)

248 ià(
a
 =ğ
b
) ‡;

249 ià(
a
 < 
b
)

250  ((
b
 - 
a
è<ğ
MAXSEQ
/2) ? b :‡;

252  ((
a
 - 
b
è<ğ
MAXSEQ
/2) ?‡ : b;

253 
	}
}

255 
šlše
 

256 
	$CªM”ge
(cÚ¡ 
äagm’t_ùx
 *
a
, cÚ¡ äagm’t_ùx *
b
)

258 
ušt32_t
 
a_’d
 = 
a
->
£q
 +‡->
Ën
 + 1;

259 
ušt32_t
 
b_’d
 = 
b
->
£q
 + b->
Ën
 + 1;

261 ià(
	`G‘MšSeq
(
a_’d
, 
b
->
£q
) ==‡_end ||

262 
	`G‘MšSeq
(
b_’d
, 
a
->
£q
) == b_end)

265 
	}
}

267 
šlše
 

268 
	$M”geF¿gm’ts
(
äagm’t_ùx
 *
a
, äagm’t_ùx *
b
)

271 
ušt32_t
 
mš_£q
, 
max_£q
;

273 
mš_£q
 = 
	`G‘MšSeq
(
a
->
£q
, 
b
->seq);

274 
max_£q
 = 
	`G‘MaxSeq
(
a
->
£q
 +‡->
Ën
, 
b
->seq + b->len);

275 
b
->
£q
 = 
mš_£q
;

276 
b
->
Ën
 = 
max_£q
 - 
mš_£q
;

277 
	}
}

280 
	$RBPut
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
,

281 * 
d©a
, 
ušt32_t
 
Ën
, ušt32_ˆ
cur_£q
)

283 
putx
, 
’d_off
;

284 
äagm’t_ùx
 *
Ãw_ùx
;

285 
äagm’t_ùx
* 
™”
;

286 
äagm’t_ùx
* 
´ev
, *
µ»v
;

287 
m”ged
 = 0;

289 ià(
Ën
 <= 0)

293 ià(
	`G‘MšSeq
(
buff
->
h—d_£q
, 
cur_£q
) != buff->head_seq)

296 
putx
 = 
cur_£q
 - 
buff
->
h—d_£q
;

297 
’d_off
 = 
putx
 + 
Ën
;

298 ià(
buff
->
size
 < 
’d_off
) {

303 ià(
buff
->
size
 <ğ(buff->
h—d_off£t
 + 
’d_off
)) {

304 
	`memmove
(
buff
->
d©a
, buff->
h—d
, buff->
Ï¡_Ën
);

305 
buff
->
_off£t
 -ğbuff->
h—d_off£t
;

306 
buff
->
h—d_off£t
 = 0;

307 
buff
->
h—d
 = buff->
d©a
;

309 #ifdeà
ENABLELRO


311 
__MEMCPY_DATA_2_BUFFER
;

314 
	`memıy
(
buff
->
h—d
 + 
putx
, 
d©a
, 
Ën
);

316 ià(
buff
->
_off£t
 < buff->
h—d_off£t
 + 
’d_off
)

317 
buff
->
_off£t
 = buff->
h—d_off£t
 + 
’d_off
;

318 
buff
->
Ï¡_Ën
 = buff->
_off£t
 - buff->
h—d_off£t
;

321 
Ãw_ùx
 = 
	`AÎoÿ‹F¿gm’tCÚ‹xt
(
rbm
);

322 ià(!
Ãw_ùx
) {

323 
	`³¼Ü
("allocating‚ew_ctx failed");

326 
Ãw_ùx
->
£q
 = 
cur_£q
;

327 
Ãw_ùx
->
Ën
 =†en;

328 
Ãw_ùx
->
Ãxt
 = 
NULL
;

331 
™”
 = 
buff
->
fùx
, 
´ev
 = 
NULL
, 
µ»v
 = NULL;

332 
™”
 !ğ
NULL
;

333 
µ»v
 = 
´ev
,…»v = 
™”
, i‹¸ğ™”->
Ãxt
) {

335 ià(
	`CªM”ge
(
Ãw_ùx
, 
™”
)) {

337 
	`M”geF¿gm’ts
(
Ãw_ùx
, 
™”
);

340 ià(
´ev
 =ğ
Ãw_ùx
) {

341 ià(
µ»v
)

342 
µ»v
->
Ãxt
 = 
™”
;

344 
buff
->
fùx
 = 
™”
;

345 
´ev
 = 
µ»v
;

347 
	`F»eF¿gm’tCÚ‹xtSšgË
(
rbm
, 
Ãw_ùx
);

348 
Ãw_ùx
 = 
™”
;

349 
m”ged
 = 1;

351 ià(
m”ged
 ||

352 
	`G‘MaxSeq
(
cur_£q
 + 
Ën
, 
™”
->
£q
) == iter->seq) {

359 ià(!
m”ged
) {

360 ià(
buff
->
fùx
 =ğ
NULL
) {

361 
buff
->
fùx
 = 
Ãw_ùx
;

362 } ià(
	`G‘MšSeq
(
cur_£q
, 
buff
->
fùx
->
£q
) == cur_seq) {

364 
Ãw_ùx
->
Ãxt
 = 
buff
->
fùx
;

365 
buff
->
fùx
 = 
Ãw_ùx
;

369 
	`as£¹
(
	`G‘MšSeq
(
cur_£q
, 
´ev
->
£q
 +…»v->
Ën
) ==

370 
´ev
->
£q
 +…»v->
Ën
);

371 
´ev
->
Ãxt
 = 
Ãw_ùx
;

372 
Ãw_ùx
->
Ãxt
 = 
™”
;

375 ià(
buff
->
h—d_£q
 =ğbuff->
fùx
->
£q
) {

376 
buff
->
cum_Ën
 +ğbuff->
fùx
->
Ën
 - buff->
m”ged_Ën
;

377 
buff
->
m”ged_Ën
 = buff->
fùx
->
Ën
;

380  
Ën
;

381 
	}
}

383 
size_t


384 
	$RBRemove
(
rb_mªag”_t
 
rbm
, 
tı_ršg_bufãr
* 
buff
, 
size_t
 
Ën
, 
İtiÚ
)

388 ià(
buff
->
m”ged_Ën
 < 
Ën
)

389 
Ën
 = 
buff
->
m”ged_Ën
;

391 ià(
Ën
 == 0)

394 
buff
->
h—d_off£t
 +ğ
Ën
;

395 
buff
->
h—d
 = buff->
d©a
 + buff->
h—d_off£t
;

396 
buff
->
h—d_£q
 +ğ
Ën
;

398 
buff
->
m”ged_Ën
 -ğ
Ën
;

399 
buff
->
Ï¡_Ën
 -ğ
Ën
;

402 ià(
Ën
 =ğ
buff
->
fùx
->len) {

403 
äagm’t_ùx
* 
»move
 = 
buff
->
fùx
;

404 
buff
->
fùx
 = buff->fùx->
Ãxt
;

405 ià(
İtiÚ
 =ğ
AT_APP
) {

406 
	`RBF¿gEnqueue
(
rbm
->
ä“_äagq
, 
»move
);

407 } ià(
İtiÚ
 =ğ
AT_MTCP
) {

408 
	`RBF¿gEnqueue
(
rbm
->
ä“_äagq_št
, 
»move
);

411 ià(
Ën
 < 
buff
->
fùx
->len) {

412 
buff
->
fùx
->
£q
 +ğ
Ën
;

413 
buff
->
fùx
->
Ën
 -=†en;

416 
	`as£¹
(0);

419  
Ën
;

420 
	}
}

	@tcp_sb_queue.cpp

23 
	~"tı_sb_queue.h
"

24 
	~"debug.h
"

27 #iâdeà
_INDEX_TYPE_


28 
	#_INDEX_TYPE_


	)

29 
ušt32_t
 
	tšdex_ty³
;

30 
št32_t
 
	tsigÃd_šdex_ty³
;

33 
	ssb_queue


35 
šdex_ty³
 
	m_ÿ·c™y
;

36 vŞ©
šdex_ty³
 
	m_h—d
;

37 vŞ©
šdex_ty³
 
	m_
;

39 
tı_£nd_bufãr
 * vŞ©* 
	m_q
;

42 
šlše
 
šdex_ty³


43 
	$NextIndex
(
sb_queue_t
 
sq
, 
šdex_ty³
 
i
)

45  (
i
 !ğ
sq
->
_ÿ·c™y
 ? i + 1: 0);

46 
	}
}

48 
šlše
 
šdex_ty³


49 
	$P»vIndex
(
sb_queue_t
 
sq
, 
šdex_ty³
 
i
)

51  (
i
 !ğ0 ? i - 1: 
sq
->
_ÿ·c™y
);

52 
	}
}

54 
šlše
 

55 
	$SBMemÜyB¬r›r
(
tı_£nd_bufãr
 * vŞ©
buf
, vŞ©
šdex_ty³
 
šdex
)

57 
__asm__
 vŞ©e("" : : "m" (
buf
), "m" (
šdex
));

58 
	}
}

60 
sb_queue_t


61 
	$C»©eSBQueue
(
ÿ·c™y
)

63 
sb_queue_t
 
sq
;

65 
sq
 = (
sb_queue_t
)
	`ÿÎoc
(1, (
sb_queue
));

66 ià(!
sq
)

67  
NULL
;

69 
sq
->
_q
 = (
tı_£nd_bufãr
 **)

70 
	`ÿÎoc
(
ÿ·c™y
 + 1, (
tı_£nd_bufãr
 *));

71 ià(!
sq
->
_q
) {

72 
	`ä“
(
sq
);

73  
NULL
;

76 
sq
->
_ÿ·c™y
 = 
ÿ·c™y
;

77 
sq
->
_h—d
 = sq->
_
 = 0;

79  
sq
;

80 
	}
}

83 
	$De¡roySBQueue
(
sb_queue_t
 
sq
)

85 ià(!
sq
)

88 ià(
sq
->
_q
) {

89 
	`ä“
((*)
sq
->
_q
);

90 
sq
->
_q
 = 
NULL
;

93 
	`ä“
(
sq
);

94 
	}
}

97 
	$SBEnqueue
(
sb_queue_t
 
sq
, 
tı_£nd_bufãr
 *
buf
)

99 
šdex_ty³
 
h
 = 
sq
->
_h—d
;

100 
šdex_ty³
 
t
 = 
sq
->
_
;

101 
šdex_ty³
 
Á
 = 
	`NextIndex
(
sq
, 
t
);

103 ià(
Á
 !ğ
h
) {

104 
sq
->
_q
[
t
] = 
buf
;

105 
	`SBMemÜyB¬r›r
(
sq
->
_q
[
t
], sq->
_
);

106 
sq
->
_
 = 
Á
;

110 
	`TRACE_ERROR
("Exceed capacity of buf queue!\n");

112 
	}
}

114 
tı_£nd_bufãr
 *

115 
	$SBDequeue
(
sb_queue_t
 
sq
)

117 
šdex_ty³
 
h
 = 
sq
->
_h—d
;

118 
šdex_ty³
 
t
 = 
sq
->
_
;

120 ià(
h
 !ğ
t
) {

121 
tı_£nd_bufãr
 *
buf
 = 
sq
->
_q
[
h
];

122 
	`SBMemÜyB¬r›r
(
sq
->
_q
[
h
], sq->
_h—d
);

123 
sq
->
_h—d
 = 
	`NextIndex
(sq, 
h
);

124 
	`as£¹
(
buf
);

126  
buf
;

129  
NULL
;

130 
	}
}

	@tcp_send_buffer.cpp

1 
	~<¡ršg.h
>

3 
	~"memÜy_mgt.h
"

4 
	~"debug.h
"

5 
	~"tı_£nd_bufãr.h
"

6 
	~"tı_sb_queue.h
"

8 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

9 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

12 
	ssb_mªag”


14 
size_t
 
	mchunk_size
;

15 
ušt32_t
 
	mcur_num
;

16 
ušt32_t
 
	múum
;

17 
mem_poŞ_t
 
	mmp
;

18 
sb_queue_t
 
	mä“q
;

20 } 
	gsb_mªag”
;

22 
ušt32_t


23 
	$SBG‘Cuºum
(
sb_mªag”_t
 
sbm
)

25  
sbm
->
cur_num
;

26 
	}
}

28 
sb_mªag”_t


29 
	$SBMªag”C»©e
(
size_t
 
chunk_size
, 
ušt32_t
 
úum
)

31 
sb_mªag”_t
 
sbm
 = (sb_mªag”_t)
	`ÿÎoc
(1, (
sb_mªag”
));

32 ià(!
sbm
) {

33 
	`TRACE_ERROR
("SBMªag”C»©e(èçed. %s\n", 
	`¡»¼Ü
(
”ºo
));

34  
NULL
;

37 
sbm
->
chunk_size
 = chunk_size;

38 
sbm
->
úum
 = cnum;

39 
sbm
->
mp
 = (
mem_poŞ_t
)
	`MPC»©e
(
chunk_size
, (
ušt64_t
)chunk_siz* 
úum
, 0);

40 ià(!
sbm
->
mp
) {

41 
	`TRACE_ERROR
("Failedo create mem…ool for sb.\n");

42 
	`ä“
(
sbm
);

43  
NULL
;

46 
sbm
->
ä“q
 = 
	`C»©eSBQueue
(
úum
);

47 ià(!
sbm
->
ä“q
) {

48 
	`TRACE_ERROR
("Failedo create free buffer queue.\n");

49  
NULL
;

52  
sbm
;

53 
	}
}

55 
tı_£nd_bufãr
 *

56 
	$SBIn™
(
sb_mªag”_t
 
sbm
, 
ušt32_t
 
š™_£q
)

58 
tı_£nd_bufãr
 *
buf
;

61 
buf
 = 
	`SBDequeue
(
sbm
->
ä“q
);

62 ià(!
buf
) {

63 
buf
 = (
tı_£nd_bufãr
 *)
	`m®loc
((tcp_send_buffer));

64 ià(!
buf
) {

65 
	`³¼Ü
("calloc() for buf");

66  
NULL
;

68 
buf
->
d©a
 = 
	`MPAÎoÿ‹Chunk
(
sbm
->
mp
);

69 ià(!
buf
->
d©a
) {

70 
	`TRACE_ERROR
("Failedo fetch memory chunk for data.\n");

71  
NULL
;

73 
sbm
->
cur_num
++;

76 
buf
->
h—d
 = buf->
d©a
;

78 
buf
->
h—d_off
 = buf->
_off
 = 0;

79 
buf
->
Ën
 = buf->
cum_Ën
 = 0;

80 
buf
->
size
 = 
sbm
->
chunk_size
;

82 
buf
->
š™_£q
 = buf->
h—d_£q
 = init_seq;

84  
buf
;

85 
	}
}

89 
	$SBF»eIÁ”Çl
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
)

91 ià(!
buf
)

94 ià(
buf
->
d©a
) {

95 
	`MPF»eChunk
(
sbm
->
mp
, 
buf
->
d©a
);

96 
buf
->
d©a
 = 
NULL
;

99 
sbm
->
cur_num
--;

100 
	`ä“
(
buf
);

101 
	}
}

105 
	$SBF»e
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
)

107 ià(!
buf
)

110 
	`SBEnqueue
(
sbm
->
ä“q
, 
buf
);

111 
	}
}

113 
size_t


114 
	$SBPut
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

116 
size_t
 
to_put
;

118 ià(
Ën
 <= 0)

122 
to_put
 = 
	`MIN
(
Ën
, 
buf
->
size
 - buf->len);

123 ià(
to_put
 <= 0) {

127 ià(
buf
->
_off
 + 
to_put
 < buf->
size
) {

129 
	`memıy
(
buf
->
d©a
 + buf->
_off
, d©a, 
to_put
);

130 
buf
->
_off
 +ğ
to_put
;

133 
	`memmove
(
buf
->
d©a
, buf->
h—d
, buf->
Ën
);

134 
buf
->
h—d
 = buf->
d©a
;

135 
buf
->
h—d_off
 = 0;

136 
	`memıy
(
buf
->
h—d
 + buf->
Ën
, 
d©a
, 
to_put
);

137 
buf
->
_off
 = buf->
Ën
 + 
to_put
;

139 
buf
->
Ën
 +ğ
to_put
;

140 
buf
->
cum_Ën
 +ğ
to_put
;

142  
to_put
;

143 
	}
}

145 
size_t


146 
	$SBRemove
(
sb_mªag”_t
 
sbm
, 
tı_£nd_bufãr
 *
buf
, 
size_t
 
Ën
)

148 
size_t
 
to_»move
;

150 ià(
Ën
 <= 0)

153 
to_»move
 = 
	`MIN
(
Ën
, 
buf
->len);

154 ià(
to_»move
 <= 0) {

158 
buf
->
h—d_off
 +ğ
to_»move
;

159 
buf
->
h—d
 = buf->
d©a
 + buf->
h—d_off
;

160 
buf
->
h—d_£q
 +ğ
to_»move
;

161 
buf
->
Ën
 -ğ
to_»move
;

164 ià(
buf
->
Ën
 =ğ0 && buf->
h—d_off
 > 0) {

165 
buf
->
h—d
 = buf->
d©a
;

166 
buf
->
h—d_off
 = buf->
_off
 = 0;

169  
to_»move
;

170 
	}
}

	@tcp_stream.cpp

1 
	~"tı_¡»am.h
"

2 
	~"fhash.h
"

3 
	~"tı_š.h
"

4 
	~"tı_out.h
"

5 
	~"tı_ršg_bufãr.h
"

6 
	~"tı_£nd_bufãr.h
"

7 
	~"ev’Şl.h
"

8 
	~"_out.h
"

9 
	~"tim”.h
"

10 
	~"debug.h
"

12 
	#TCP_MAX_SEQ
 4294967295

	)

15 *
	g¡©e_¡r
[] = {"TCP_ST_CLOSED",

28 *
	gşo£_»asÚ_¡r
[] = {

41 
__th»ad
 
	gÃxt_£ed
;

44 
	$TCPS‹ToSŒšg
(cÚ¡ 
tı_¡»am
 *
¡»am
)

46  
¡©e_¡r
[
¡»am
->
¡©e
];

47 
	}
}

50 
	$In™ŸlizeTCPSŒ—mMªag”
()

52 
Ãxt_£ed
 = 
	`time
(
NULL
);

53 
	}
}

56 
	$HashFlow
(cÚ¡ *
f
)

58 
tı_¡»am
 *
æow
 = (tı_¡»am *)
f
;

60 
hash
 = 5381;

61 
c
;

62 
šdex
;

64 *
¡r
 = (*)&
æow
->
§ddr
;

65 
šdex
 = 0;

67 (
c
 = *
¡r
++è&& 
šdex
++ < 12) {

68 ià(
šdex
 == 8) {

69 
¡r
 = (*)&
æow
->
¥Üt
;

71 
hash
 = ((hash << 5è+ hashè+ 
c
;

74  
hash
 & (
NUM_BINS_FLOWS
 - 1);

76 
hash
, 
i
;

77 *
key
 = (*)&
æow
->
§ddr
;

79 
hash
 = 
i
 = 0; i < 12; ++i) {

80 
hash
 +ğ
key
[
i
];

81 
hash
 += (hash << 10);

82 
hash
 ^= (hash >> 6);

84 
hash
 += (hash << 3);

85 
hash
 ^= (hash >> 11);

86 
hash
 += (hash << 15);

88  
hash
 & (
NUM_BINS_FLOWS
 - 1);

90 
	}
}

93 
	$Equ®Flow
(cÚ¡ *
f1
, cÚ¡ *
f2
)

95 
tı_¡»am
 *
æow1
 = (tı_¡»am *)
f1
;

96 
tı_¡»am
 *
æow2
 = (tı_¡»am *)
f2
;

98  (
æow1
->
§ddr
 =ğ
æow2
->saddr &&

99 
æow1
->
¥Üt
 =ğ
æow2
->sport &&

100 
æow1
->
daddr
 =ğ
æow2
->daddr &&

101 
æow1
->
dpÜt
 =ğ
æow2
->dport);

102 
	}
}

105 
	$Rai£R—dEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

107 ià(
¡»am
->
sock‘
) {

108 ià(
¡»am
->
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

109 
	`AddEpŞlEv’t
(
mtı
->
•
,

110 
MTCP_EVENT_QUEUE
, 
¡»am
->
sock‘
, 
MTCP_EPOLLIN
);

111 #ià
BLOCKING_SUPPORT


112 } ià(!(
¡»am
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

113 ià(!
¡»am
->
Ú_rcv_br_li¡
) {

114 
¡»am
->
Ú_rcv_br_li¡
 = 
TRUE
;

115 
	`TAILQ_INSERT_TAIL
(&
mtı
->
rcv_br_li¡
, 
¡»am
, 
rcvv¬
->
rcv_br_lšk
);

116 
mtı
->
rcv_br_li¡_út
++;

121 
	`TRACE_EPOLL
("SŒ—m %d: Raisšg„—d w™houˆ¨sock‘!\n", 
¡»am
->
id
);

123 
	}
}

126 
	$Rai£Wr™eEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

128 ià(
¡»am
->
sock‘
) {

129 ià(
¡»am
->
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
) {

130 
	`AddEpŞlEv’t
(
mtı
->
•
,

131 
MTCP_EVENT_QUEUE
, 
¡»am
->
sock‘
, 
MTCP_EPOLLOUT
);

132 #ià
BLOCKING_SUPPORT


133 } ià(!(
¡»am
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

134 ià(!
¡»am
->
Ú_¢d_br_li¡
) {

135 
¡»am
->
Ú_¢d_br_li¡
 = 
TRUE
;

136 
	`TAILQ_INSERT_TAIL
(&
mtı
->
¢d_br_li¡
, 
¡»am
, 
¢dv¬
->
¢d_br_lšk
);

137 
mtı
->
¢d_br_li¡_út
++;

142 
	`TRACE_EPOLL
("SŒ—m %d: Raisšg wr™w™houˆ¨sock‘!\n", 
¡»am
->
id
);

144 
	}
}

147 
	$Rai£Clo£Ev’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

149 ià(
¡»am
->
sock‘
) {

150 ià(
¡»am
->
sock‘
->
•Şl
 & 
MTCP_EPOLLRDHUP
) {

151 
	`AddEpŞlEv’t
(
mtı
->
•
,

152 
MTCP_EVENT_QUEUE
, 
¡»am
->
sock‘
, 
MTCP_EPOLLRDHUP
);

153 } ià(
¡»am
->
sock‘
->
•Şl
 & 
MTCP_EPOLLIN
) {

154 
	`AddEpŞlEv’t
(
mtı
->
•
,

155 
MTCP_EVENT_QUEUE
, 
¡»am
->
sock‘
, 
MTCP_EPOLLIN
);

156 #ià
BLOCKING_SUPPORT


157 } ià(!(
¡»am
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

160 ià(!
¡»am
->
Ú_rcv_br_li¡
) {

161 
¡»am
->
Ú_rcv_br_li¡
 = 
TRUE
;

162 
	`TAILQ_INSERT_TAIL
(&
mtı
->
rcv_br_li¡
, 
¡»am
, 
rcvv¬
->
rcv_br_lšk
);

163 
mtı
->
rcv_br_li¡_út
++;

165 ià(!
¡»am
->
Ú_¢d_br_li¡
) {

166 
¡»am
->
Ú_¢d_br_li¡
 = 
TRUE
;

167 
	`TAILQ_INSERT_TAIL
(&
mtı
->
¢d_br_li¡
, 
¡»am
, 
¢dv¬
->
¢d_br_lšk
);

168 
mtı
->
¢d_br_li¡_út
++;

173 
	`TRACE_EPOLL
("SŒ—m %d: Raisšg clo£ w™houˆ¨sock‘!\n", 
¡»am
->
id
);

175 
	}
}

178 
	$Rai£E¼ÜEv’t
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

180 ià(
¡»am
->
sock‘
) {

181 ià(
¡»am
->
sock‘
->
•Şl
 & 
MTCP_EPOLLERR
) {

182 
	`AddEpŞlEv’t
(
mtı
->
•
,

183 
MTCP_EVENT_QUEUE
, 
¡»am
->
sock‘
, 
MTCP_EPOLLERR
);

184 #ià
BLOCKING_SUPPORT


185 } ià(!(
¡»am
->
sock‘
->
İts
 & 
MTCP_NONBLOCK
)) {

186 ià(!
¡»am
->
Ú_rcv_br_li¡
) {

187 
¡»am
->
Ú_rcv_br_li¡
 = 
TRUE
;

188 
	`TAILQ_INSERT_TAIL
(&
mtı
->
rcv_br_li¡
, 
¡»am
, 
rcvv¬
->
rcv_br_lšk
);

189 
mtı
->
rcv_br_li¡_út
++;

191 ià(!
¡»am
->
Ú_¢d_br_li¡
) {

192 
¡»am
->
Ú_¢d_br_li¡
 = 
TRUE
;

193 
	`TAILQ_INSERT_TAIL
(&
mtı
->
¢d_br_li¡
, 
¡»am
, 
¢dv¬
->
¢d_br_lšk
);

194 
mtı
->
¢d_br_li¡_út
++;

199 
	`TRACE_EPOLL
("SŒ—m %d: Raisšgƒ¼Ü w™houˆ¨sock‘!\n", 
¡»am
->
id
);

201 
	}
}

203 
tı_¡»am
 *

204 
	$C»©eTCPSŒ—m
(
mtı_mªag”_t
 
mtı
, 
sock‘_m­_t
 
sock‘
, 
ty³
,

205 
ušt32_t
 
§ddr
, 
ušt16_t
 
¥Üt
, ušt32_ˆ
daddr
, ušt16_ˆ
dpÜt
)

207 
tı_¡»am
 *
¡»am
 = 
NULL
;

208 
»t
;

210 
ušt8_t
 *
§
;

211 
ušt8_t
 *
da
;

213 
	`±h»ad_mu‹x_lock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

215 
¡»am
 = (
tı_¡»am
 *)
	`MPAÎoÿ‹Chunk
(
mtı
->
æow_poŞ
);

216 ià(!
¡»am
) {

217 
	`TRACE_ERROR
("Cannot‡llocate memory forhe stream. "

219 
CONFIG
.
max_cÚcu¼’cy
, 
mtı
->
æow_út
);

220 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

221  
NULL
;

223 
	`mem£t
(
¡»am
, 0, (
tı_¡»am
));

225 
¡»am
->
rcvv¬
 = (
tı_»cv_v¬s
 *)
	`MPAÎoÿ‹Chunk
(
mtı
->
rv_poŞ
);

226 ià(!
¡»am
->
rcvv¬
) {

227 
	`MPF»eChunk
(
mtı
->
æow_poŞ
, 
¡»am
);

228 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

229  
NULL
;

231 
¡»am
->
¢dv¬
 = (
tı_£nd_v¬s
 *)
	`MPAÎoÿ‹Chunk
(
mtı
->
sv_poŞ
);

232 ià(!
¡»am
->
¢dv¬
) {

233 
	`MPF»eChunk
(
mtı
->
rv_poŞ
, 
¡»am
->
rcvv¬
);

234 
	`MPF»eChunk
(
mtı
->
æow_poŞ
, 
¡»am
);

235 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

236  
NULL
;

238 
	`mem£t
(
¡»am
->
rcvv¬
, 0, (
tı_»cv_v¬s
));

239 
	`mem£t
(
¡»am
->
¢dv¬
, 0, (
tı_£nd_v¬s
));

241 
¡»am
->
id
 = 
mtı
->
g_id
++;

242 
¡»am
->
§ddr
 = saddr;

243 
¡»am
->
¥Üt
 = sport;

244 
¡»am
->
daddr
 = daddr;

245 
¡»am
->
dpÜt
 = dport;

247 
»t
 = 
	`SŒ—mHTIn£¹
(
mtı
->
tı_æow_bË
, 
¡»am
);

248 ià(
»t
 < 0) {

249 
	`TRACE_ERROR
("Stream %d: "

250 "FaedØš£¹h¡»am iÁØhashabË.\n", 
¡»am
->
id
);

251 
	`MPF»eChunk
(
mtı
->
æow_poŞ
, 
¡»am
);

252 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

253  
NULL
;

255 
¡»am
->
Ú_hash_bË
 = 
TRUE
;

256 
mtı
->
æow_út
++;

258 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

260 ià(
sock‘
) {

261 
¡»am
->
sock‘
 = socket;

262 
sock‘
->
¡»am
 = stream;

265 
¡»am
->
¡»am_ty³
 = 
ty³
;

266 
¡»am
->
¡©e
 = 
TCP_ST_LISTEN
;

268 
¡»am
->
Ú_¹o_idx
 = -1;

270 
¡»am
->
¢dv¬
->
_id
 = 0;

271 
¡»am
->
¢dv¬
->
mss
 = 
TCP_DEFAULT_MSS
;

272 
¡»am
->
¢dv¬
->
wsÿË_mše
 = 
TCP_DEFAULT_WSCALE
;

273 
¡»am
->
¢dv¬
->
wsÿË_³”
 = 0;

274 
¡»am
->
¢dv¬
->
nif_out
 = 
	`G‘OuutIÁ”çû
(¡»am->
daddr
);

276 
¡»am
->
¢dv¬
->
iss
 = 
	`¿nd_r
(&
Ãxt_£ed
è% 
TCP_MAX_SEQ
;

278 
¡»am
->
rcvv¬
->
œs
 = 0;

280 
¡»am
->
¢d_nxt
 = sŒ—m->
¢dv¬
->
iss
;

281 
¡»am
->
¢dv¬
->
¢d_uÇ
 = sŒ—m->¢dv¬->
iss
;

282 
¡»am
->
¢dv¬
->
¢d_wnd
 = 
CONFIG
.
¢dbuf_size
;

283 
¡»am
->
rcv_nxt
 = 0;

284 
¡»am
->
rcvv¬
->
rcv_wnd
 = 
TCP_INITIAL_WINDOW
;

286 
¡»am
->
rcvv¬
->
¢d_wl1
 = sŒ—m->rcvv¬->
œs
 - 1;

288 
¡»am
->
¢dv¬
->
¹o
 = 
TCP_INITIAL_RTO
;

290 #ià
BLOCKING_SUPPORT


291 ià(
	`±h»ad_cÚd_š™
(&
¡»am
->
rcvv¬
->
»ad_cÚd
, 
NULL
)) {

292 
	`³¼Ü
("pthread_cond_init of„ead_cond");

293  
NULL
;

295 ià(
	`±h»ad_cÚd_š™
(&
¡»am
->
¢dv¬
->
wr™e_cÚd
, 
NULL
)) {

296 
	`³¼Ü
("pthread_cond_init of write_cond");

297  
NULL
;

301 #ià
USE_SPIN_LOCK


302 ià(
	`±h»ad_¥š_š™
(&
¡»am
->
rcvv¬
->
»ad_lock
, 
PTHREAD_PROCESS_PRIVATE
)) {

304 ià(
	`±h»ad_mu‹x_š™
(&
¡»am
->
rcvv¬
->
»ad_lock
, 
NULL
)) {

306 
	`³¼Ü
("pthread_mutex_init of„ead_lock");

307 #ià
BLOCKING_SUPPORT


308 
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
rcvv¬
->
»ad_cÚd
);

309 
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
¢dv¬
->
wr™e_cÚd
);

311  
NULL
;

313 #ià
USE_SPIN_LOCK


314 ià(
	`±h»ad_¥š_š™
(&
¡»am
->
¢dv¬
->
wr™e_lock
, 
PTHREAD_PROCESS_PRIVATE
)) {

315 
	`³¼Ü
("pthread_spin_init of write_lock");

316 
	`±h»ad_¥š_de¡roy
(&
¡»am
->
rcvv¬
->
»ad_lock
);

318 ià(
	`±h»ad_mu‹x_š™
(&
¡»am
->
¢dv¬
->
wr™e_lock
, 
NULL
)) {

319 
	`³¼Ü
("pthread_mutex_init of write_lock");

320 
	`±h»ad_mu‹x_de¡roy
(&
¡»am
->
rcvv¬
->
»ad_lock
);

322 #ià
BLOCKING_SUPPORT


323 
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
rcvv¬
->
»ad_cÚd
);

324 
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
¢dv¬
->
wr™e_cÚd
);

326  
NULL
;

329 
§
 = (
ušt8_t
 *)&
¡»am
->
§ddr
;

330 
da
 = (
ušt8_t
 *)&
¡»am
->
daddr
;

331 
	`TRACE_STREAM
("CREATED NEW TCP STREAM %d: "

332 "%u.%u.%u.%u(%dè-> %u.%u.%u.%u(%dè(ISS: %u)\n", 
¡»am
->
id
,

333 
§
[0], sa[1], sa[2], sa[3], 
	`Áohs
(
¡»am
->
¥Üt
),

334 
da
[0], da[1], da[2], da[3], 
	`Áohs
(
¡»am
->
dpÜt
),

335 
¡»am
->
¢dv¬
->
iss
);

337 
	`UNUSED
(
da
);

338 
	`UNUSED
(
§
);

339  
¡»am
;

340 
	}
}

343 
	$De¡royTCPSŒ—m
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

345 
sockaddr_š
 
addr
;

346 
bound_addr
 = 
FALSE
;

347 
ušt8_t
 *
§
, *
da
;

348 
»t
;

350 #ifdeà
DUMP_STREAM


351 ià(
¡»am
->
şo£_»asÚ
 !ğ
TCP_ACTIVE_CLOSE
 &&

352 
¡»am
->
şo£_»asÚ
 !ğ
TCP_PASSIVE_CLOSE
) {

353 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

354 "SŒ—m %d‡bnÜm®ly clo£d.\n", 
¡»am
->
id
);

355 
	`DumpSŒ—m
(
mtı
, 
¡»am
);

356 
	`DumpCÚŒŞLi¡
(
mtı
, mtı->
n_£nd”
[0]);

360 
§
 = (
ušt8_t
 *)&
¡»am
->
§ddr
;

361 
da
 = (
ušt8_t
 *)&
¡»am
->
daddr
;

362 if(
mtı
->
ùx
->
ıu
 == 1)

363 
	`TRACE_STREAM
("DESTROY TCP STREAM %d: "

364 "%u.%u.%u.%u(%dè-> %u.%u.%u.%u(%dè(%s)\n", 
¡»am
->
id
,

365 
§
[0], sa[1], sa[2], sa[3], 
	`Áohs
(
¡»am
->
¥Üt
),

366 
da
[0], da[1], da[2], da[3], 
	`Áohs
(
¡»am
->
dpÜt
),

367 
şo£_»asÚ_¡r
[
¡»am
->
şo£_»asÚ
]);

369 ià(
¡»am
->
¢dv¬
->
¢dbuf
) {

370 
	`TRACE_FSTAT
("Stream %d: send buffer "

371 "cum_Ën: %lu,†’: %u\n", 
¡»am
->
id
,

372 
¡»am
->
¢dv¬
->
¢dbuf
->
cum_Ën
,

373 
¡»am
->
¢dv¬
->
¢dbuf
->
Ën
);

375 ià(
¡»am
->
rcvv¬
->
rcvbuf
) {

376 
	`TRACE_FSTAT
("Stream %d:„ecv buffer "

377 "cum_Ën: %lu, m”ged_Ën: %u,†a¡_Ën: %u\n", 
¡»am
->
id
,

378 
¡»am
->
rcvv¬
->
rcvbuf
->
cum_Ën
,

379 
¡»am
->
rcvv¬
->
rcvbuf
->
m”ged_Ën
,

380 
¡»am
->
rcvv¬
->
rcvbuf
->
Ï¡_Ën
);

383 #ià
RTM_STAT


385 ià(
¡»am
->
¢dv¬
->
r¡©
.
tdp_ack_út
) {

386 
	`TRACE_FSTAT
("Stream %d:riple duplicated‡ck: %u, "

388 
¡»am
->
id
,

389 
¡»am
->
¢dv¬
->
r¡©
.
tdp_ack_út
, sŒ—m->¢dv¬->r¡©.
tdp_ack_by‹s
,

390 
¡»am
->
¢dv¬
->
r¡©
.
tdp_ack_by‹s
 / sŒ—m->¢dv¬->r¡©.
tdp_ack_út
);

394 ià(
¡»am
->
¢dv¬
->
r¡©
.
¹o_út
 > 0) {

395 
	`TRACE_FSTAT
("SŒ—m %d:imeouˆcouÁ: %u, by‹s: %u\n", 
¡»am
->
id
,

396 
¡»am
->
¢dv¬
->
r¡©
.
¹o_út
, sŒ—m->¢dv¬->r¡©.
¹o_by‹s
);

400 ià(
¡»am
->
¢dv¬
->
r¡©
.
ack_upd_út
) {

401 
	`TRACE_FSTAT
("Stream %d: snd_nxt update count: %u, "

403 
¡»am
->
id
,

404 
¡»am
->
¢dv¬
->
r¡©
.
ack_upd_út
, sŒ—m->¢dv¬->r¡©.
ack_upd_by‹s
,

405 
¡»am
->
¢dv¬
->
r¡©
.
ack_upd_by‹s
 / sŒ—m->¢dv¬->r¡©.
ack_upd_út
);

407 #ià
TCP_OPT_SACK_ENABLED


408 ià(
¡»am
->
¢dv¬
->
r¡©
.
§ck_út
) {

409 
	`TRACE_FSTAT
("Selective‡ck count: %u, bytes: %u, "

411 
¡»am
->
¢dv¬
->
r¡©
.
§ck_út
, sŒ—m->¢dv¬->r¡©.
§ck_by‹s
,

412 
¡»am
->
¢dv¬
->
r¡©
.
§ck_by‹s
 / sŒ—m->¢dv¬->r¡©.
§ck_út
);

414 
	`TRACE_FSTAT
("Selective‡ck count: %u, bytes: %u\n",

415 
¡»am
->
¢dv¬
->
r¡©
.
§ck_út
, sŒ—m->¢dv¬->r¡©.
§ck_by‹s
);

417 ià(
¡»am
->
¢dv¬
->
r¡©
.
tdp_§ck_út
) {

418 
	`TRACE_FSTAT
("Selectivedp‡ck count: %u, bytes: %u, "

420 
¡»am
->
¢dv¬
->
r¡©
.
tdp_§ck_út
, sŒ—m->¢dv¬->r¡©.
tdp_§ck_by‹s
,

421 
¡»am
->
¢dv¬
->
r¡©
.
tdp_§ck_by‹s
 / sŒ—m->¢dv¬->r¡©.
tdp_§ck_út
);

423 
	`TRACE_FSTAT
("Selective‡ck count: %u, bytes: %u\n",

424 
¡»am
->
¢dv¬
->
r¡©
.
tdp_§ck_út
, sŒ—m->¢dv¬->r¡©.
tdp_§ck_by‹s
);

429 ià(
¡»am
->
is_bound_addr
) {

430 
bound_addr
 = 
TRUE
;

431 
addr
.
sš_addr
.
s_addr
 = 
¡»am
->
§ddr
;

432 
addr
.
sš_pÜt
 = 
¡»am
->
¥Üt
;

435 
	`RemoveFromCÚŒŞLi¡
(
mtı
, 
¡»am
);

436 
	`RemoveFromS’dLi¡
(
mtı
, 
¡»am
);

437 
	`RemoveFromACKLi¡
(
mtı
, 
¡»am
);

439 ià(
¡»am
->
Ú_¹o_idx
 >= 0)

440 
	`RemoveFromRTOLi¡
(
mtı
, 
¡»am
);

442 ià(
¡»am
->
Ú_timewa™_li¡
)

443 
	`RemoveFromTimewa™Li¡
(
mtı
, 
¡»am
);

445 ià(
CONFIG
.
tı_timeout
 > 0)

446 
	`RemoveFromTimeoutLi¡
(
mtı
, 
¡»am
);

448 #ià
BLOCKING_SUPPORT


449 ià(
¡»am
->
Ú_¢d_br_li¡
) {

450 
¡»am
->
Ú_¢d_br_li¡
 = 
FALSE
;

451 
	`TAILQ_REMOVE
(&
mtı
->
¢d_br_li¡
, 
¡»am
, 
¢dv¬
->
¢d_br_lšk
);

452 
mtı
->
¢d_br_li¡_út
--;

454 ià(
¡»am
->
Ú_rcv_br_li¡
) {

455 
¡»am
->
Ú_rcv_br_li¡
 = 
FALSE
;

456 
	`TAILQ_REMOVE
(&
mtı
->
rcv_br_li¡
, 
¡»am
, 
rcvv¬
->
rcv_br_lšk
);

457 
mtı
->
rcv_br_li¡_út
--;

460 ià(!
¡»am
->
•Şl
) {

461 
	`±h»ad_cÚd_sigÇl
(&
¡»am
->
rcvv¬
->
»ad_cÚd
);

462 
	`±h»ad_cÚd_sigÇl
(&
¡»am
->
¢dv¬
->
wr™e_cÚd
);

465 ià(
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
rcvv¬
->
»ad_cÚd
)) {

466 
	`³¼Ü
("pthread_cond_destroy of„ead_cond");

468 ià(
	`±h»ad_cÚd_de¡roy
(&
¡»am
->
¢dv¬
->
wr™e_cÚd
)) {

469 
	`³¼Ü
("pthread_cond_destroy of write_cond");

472 
	`SBUF_LOCK_DESTROY
(&
¡»am
->
rcvv¬
->
»ad_lock
);

473 
	`SBUF_LOCK_DESTROY
(&
¡»am
->
¢dv¬
->
wr™e_lock
);

475 
	`as£¹
(
¡»am
->
Ú_hash_bË
 =ğ
TRUE
);

478 ià(
¡»am
->
¢dv¬
->
¢dbuf
) {

479 
	`SBF»e
(
mtı
->
rbm_¢d
, 
¡»am
->
¢dv¬
->
¢dbuf
);

480 
¡»am
->
¢dv¬
->
¢dbuf
 = 
NULL
;

482 ià(
¡»am
->
rcvv¬
->
rcvbuf
) {

483 
	`RBF»e
(
mtı
->
rbm_rcv
, 
¡»am
->
rcvv¬
->
rcvbuf
);

484 
¡»am
->
rcvv¬
->
rcvbuf
 = 
NULL
;

487 
	`±h»ad_mu‹x_lock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

490 
	`SŒ—mHTRemove
(
mtı
->
tı_æow_bË
, 
¡»am
);

491 
¡»am
->
Ú_hash_bË
 = 
FALSE
;

493 
mtı
->
æow_út
--;

495 
	`MPF»eChunk
(
mtı
->
rv_poŞ
, 
¡»am
->
rcvv¬
);

496 
	`MPF»eChunk
(
mtı
->
sv_poŞ
, 
¡»am
->
¢dv¬
);

497 
	`MPF»eChunk
(
mtı
->
æow_poŞ
, 
¡»am
);

498 
	`±h»ad_mu‹x_uÆock
(&
mtı
->
ùx
->
æow_poŞ_lock
);

500 ià(
bound_addr
) {

501 ià(
mtı
->
­
) {

502 
»t
 = 
	`F»eAdd»ss
(
mtı
->
­
, &
addr
);

504 
nif
;

505 
nif
 = 
	`G‘OuutIÁ”çû
(
addr
.
sš_addr
.
s_addr
);

506 
»t
 = 
	`F»eAdd»ss
(
­
[
nif
], &
addr
);

508 ià(
»t
 < 0) {

509 
	`TRACE_ERROR
("(NEVER HAPPEN) Failedo free‡ddress.\n");

514 #ifdeà
NETSTAT


515 #ià
NETSTAT_PERTHREAD


516 
	`TRACE_STREAM
("De¡royed. Remaššg flows: %u\n", 
mtı
->
æow_út
);

520 
	`UNUSED
(
da
);

521 
	`UNUSED
(
§
);

522 
	}
}

525 
	$DumpSŒ—m
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
¡»am
)

527 
ušt8_t
 *
§
, *
da
;

528 
tı_£nd_v¬s
 *
¢dv¬
 = 
¡»am
->sndvar;

529 
tı_»cv_v¬s
 *
rcvv¬
 = 
¡»am
->rcvvar;

531 
§
 = (
ušt8_t
 *)&
¡»am
->
§ddr
;

532 
da
 = (
ušt8_t
 *)&
¡»am
->
daddr
;

533 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "========== Stream %u: "

534 "%u.%u.%u.%u(%uè-> %u.%u.%u.%u(%uè==========\n", 
¡»am
->
id
,

535 
§
[0], sa[1], sa[2], sa[3], 
	`Áohs
(
¡»am
->
¥Üt
),

536 
da
[0], da[1], da[2], da[3], 
	`Áohs
(
¡»am
->
dpÜt
));

537 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

539 
¡»am
->
id
, sŒ—m->
¡»am_ty³
,

540 
	`TCPS‹ToSŒšg
(
¡»am
), 
şo£_»asÚ_¡r
[¡»am->
şo£_»asÚ
]);

541 ià(
¡»am
->
sock‘
) {

542 
sock‘_m­_t
 
sock‘
 = 
¡»am
->socket;

543 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Socket id: %d,ype: %d, opts: %u\n"

546 
sock‘
->
id
, sock‘->
sockty³
, sock‘->
İts
,

547 
sock‘
->
•Şl
, sock‘->•ŞÈ& 
MTCP_EPOLLIN
,

548 
sock‘
->
•Şl
 & 
MTCP_EPOLLOUT
, sock‘->•ŞÈ& 
MTCP_EPOLLERR
,

549 
sock‘
->
•Şl
 & 
MTCP_EPOLLRDHUP
, sock‘->•ŞÈ& 
MTCP_EPOLLET
,

550 
sock‘
->
ev’ts
, sock‘->ev’t & 
MTCP_EPOLLIN
,

551 
sock‘
->
ev’ts
 & 
MTCP_EPOLLOUT
, sock‘->ev’t & 
MTCP_EPOLLERR
,

552 
sock‘
->
ev’ts
 & 
MTCP_EPOLLRDHUP
, sock‘->ev’t & 
MTCP_EPOLLET
);

554 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Socket: (null)\n");

557 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

566 "is_bound_addr: %u,‚“d_wnd_adv: %u\n", 
¡»am
->
Ú_hash_bË
,

567 
¢dv¬
->
Ú_cÚŒŞ_li¡
, 
¡»am
->
cÚŒŞ_li¡_wa™šg
, sndv¬->
Ú_£nd_li¡
,

568 
¢dv¬
->
Ú_ack_li¡
, sndv¬->
is_wack
, sndv¬->
ack_út
,

569 
¡»am
->
Ú_¹o_idx
, sŒ—m->
Ú_timewa™_li¡
, sŒ—m->
Ú_timeout_li¡
,

570 
¡»am
->
Ú_rcv_br_li¡
, sŒ—m->
Ú_¢d_br_li¡
,

571 
¢dv¬
->
Ú_£ndq
, sndv¬->
Ú_ackq
,

572 
¡»am
->
şo£d
, 
¢dv¬
->
Ú_şo£q
, sndv¬->
Ú_şo£q_št
,

573 
¢dv¬
->
Ú_»£tq
, sndv¬->
Ú_»£tq_št
,

574 
¡»am
->
have_»£t
, 
¢dv¬
->
is_fš_£Á
,

575 
¢dv¬
->
is_fš_ackd
, 
¡»am
->
§w_time¡amp
, sŒ—m->
§ck_³rm™
,

576 
¡»am
->
is_bound_addr
, sŒ—m->
Ãed_wnd_adv
);

578 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "========== Send variables ==========\n");

579 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

582 
¢dv¬
->
_id
, sndv¬->
mss
, sndv¬->
eff_mss
,

583 
¢dv¬
->
wsÿË_mše
, sndv¬->
wsÿË_³”
, sndv¬->
nif_out
);

584 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

587 
¡»am
->
¢d_nxt
, 
¢dv¬
->
¢d_uÇ
, sndv¬->
iss
, sndv¬->
fss
,

588 
¢dv¬
->
¢d_wnd
, sndv¬->
³”_wnd
, sndv¬->
cwnd
, sndv¬->
s¡h»sh
);

590 ià(
¢dv¬
->
¢dbuf
) {

591 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

594 
¢dv¬
->
¢dbuf
->
š™_£q
, sndv¬->¢dbuf->
h—d_£q
,

595 
¢dv¬
->
¢dbuf
->
Ën
, sndv¬->¢dbuf->
cum_Ën
, sndv¬->¢dbuf->
size
);

597 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Send buffer: (null)\n");

599 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

601 "ts_Ï¡ack_£Á: %u\n", 
¢dv¬
->
Ätx
, sndv¬->
max_Ätx
,

602 
¢dv¬
->
¹o
, sndv¬->
ts_¹o
, sndv¬->
ts_Ï¡ack_£Á
);

604 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

606 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

609 
¡»am
->
rcv_nxt
, 
rcvv¬
->
œs
,

610 
rcvv¬
->
rcv_wnd
,„cvv¬->
¢d_wl1
,„cvv¬->
¢d_wl2
);

611 ià(
rcvv¬
->
rcvbuf
) {

612 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

615 
rcvv¬
->
rcvbuf
->
š™_£q
,„cvv¬->rcvbuf->
h—d_£q
,

616 
rcvv¬
->
rcvbuf
->
m”ged_Ën
,„cvv¬->rcvbuf->
cum_Ën
,

617 
rcvv¬
->
rcvbuf
->
Ï¡_Ën
,„cvv¬->rcvbuf->
size
);

619 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "Receive buffer: (null)\n");

621 
	`th»ad_´štf
(
mtı
, mtı->
log_å
, "last_ack_seq: %u, dup_acks: %u\n",

622 
rcvv¬
->
Ï¡_ack_£q
,„cvv¬->
dup_acks
);

623 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

625 "ts_tw_expœe: %u\n", 
rcvv¬
->
ts_»ûÁ
,„cvv¬->
ts_Ï¡ack_rcvd
,

626 
rcvv¬
->
ts_Ï¡_ts_upd
,„cvv¬->
ts_tw_expœe
);

627 
	`th»ad_´štf
(
mtı
, mtı->
log_å
,

629 
rcvv¬
->
¤‰
,„cvv¬->
mdev
,„cvv¬->
mdev_max
,

630 
rcvv¬
->
¹tv¬
,„cvv¬->
¹t_£q
);

631 
	}
}

	@tcp_stream_queue.cpp

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

26 
	~"tı_¡»am_queue.h
"

27 
	~"debug.h
"

29 #iâdeà
_INDEX_TYPE_


30 
	#_INDEX_TYPE_


	)

31 
ušt32_t
 
	tšdex_ty³
;

32 
št32_t
 
	tsigÃd_šdex_ty³
;

35 
	s¡»am_queue


37 
šdex_ty³
 
	m_ÿ·c™y
;

38 vŞ©
šdex_ty³
 
	m_h—d
;

39 vŞ©
šdex_ty³
 
	m_
;

41 
tı_¡»am
 * vŞ©* 
	m_q
;

44 
¡»am_queue_št
 *

45 
	$C»©eIÁ”ÇlSŒ—mQueue
(
size
)

47 
¡»am_queue_št
 *
sq
;

49 
sq
 = (
¡»am_queue_št
 *)
	`ÿÎoc
(1, (stream_queue_int));

50 ià(!
sq
) {

51  
NULL
;

54 
sq
->
¬¿y
 = (
tı_¡»am
 **)
	`ÿÎoc
(
size
, (tcp_stream *));

55 ià(!
sq
->
¬¿y
) {

56 
	`ä“
(
sq
);

57  
NULL
;

60 
sq
->
size
 = size;

61 
sq
->
fœ¡
 = sq->
Ï¡
 = 0;

62 
sq
->
couÁ
 = 0;

64  
sq
;

65 
	}
}

68 
	$De¡royIÁ”ÇlSŒ—mQueue
(
¡»am_queue_št
 *
sq
)

70 ià(!
sq
)

73 ià(
sq
->
¬¿y
) {

74 
	`ä“
(
sq
->
¬¿y
);

75 
sq
->
¬¿y
 = 
NULL
;

78 
	`ä“
(
sq
);

79 
	}
}

82 
	$SŒ—mIÁ”ÇlEnqueue
(
¡»am_queue_št
 *
sq
, 
tı_¡»am
 *
¡»am
)

84 ià(
sq
->
couÁ
 >ğsq->
size
) {

86 
	`TRACE_INFO
("[WARNING] Queue overflow. Set†arger queue size! "

87 "couÁ: %d, size: %d\n", 
sq
->
couÁ
, sq->
size
);

91 
sq
->
¬¿y
[sq->
Ï¡
++] = 
¡»am
;

92 
sq
->
couÁ
++;

93 ià(
sq
->
Ï¡
 >ğsq->
size
) {

94 
sq
->
Ï¡
 = 0;

96 
	`as£¹
 (
sq
->
couÁ
 <ğsq->
size
);

99 
	}
}

101 
tı_¡»am
 *

102 
	$SŒ—mIÁ”ÇlDequeue
(
¡»am_queue_št
 *
sq
)

104 
tı_¡»am
 *
¡»am
 = 
NULL
;

106 ià(
sq
->
couÁ
 <= 0) {

107  
NULL
;

110 
¡»am
 = 
sq
->
¬¿y
[sq->
fœ¡
++];

111 
	`as£¹
(
¡»am
 !ğ
NULL
);

112 ià(
sq
->
fœ¡
 >ğsq->
size
) {

113 
sq
->
fœ¡
 = 0;

115 
sq
->
couÁ
--;

116 
	`as£¹
(
sq
->
couÁ
 >= 0);

118  
¡»am
;

119 
	}
}

121 
šlše
 
šdex_ty³


122 
	$NextIndex
(
¡»am_queue_t
 
sq
, 
šdex_ty³
 
i
)

124  (
i
 !ğ
sq
->
_ÿ·c™y
 ? i + 1: 0);

125 
	}
}

127 
šlše
 
šdex_ty³


128 
	$P»vIndex
(
¡»am_queue_t
 
sq
, 
šdex_ty³
 
i
)

130  (
i
 !ğ0 ? i - 1: 
sq
->
_ÿ·c™y
);

131 
	}
}

134 
	$SŒ—mQueueIsEm±y
(
¡»am_queue_t
 
sq
)

136  (
sq
->
_h—d
 =ğsq->
_
);

137 
	}
}

139 
šlše
 

140 
	$SŒ—mMemÜyB¬r›r
(
tı_¡»am
 * vŞ©
¡»am
, vŞ©
šdex_ty³
 
šdex
)

142 
__asm__
 vŞ©e("" : : "m" (
¡»am
), "m" (
šdex
));

143 
	}
}

145 
¡»am_queue_t


146 
	$C»©eSŒ—mQueue
(
ÿ·c™y
)

148 
¡»am_queue_t
 
sq
;

150 
sq
 = (
¡»am_queue_t
)
	`ÿÎoc
(1, (
¡»am_queue
));

151 ià(!
sq
)

152  
NULL
;

154 
sq
->
_q
 = (
tı_¡»am
 **)
	`ÿÎoc
(
ÿ·c™y
 + 1, (tcp_stream *));

155 ià(!
sq
->
_q
) {

156 
	`ä“
(
sq
);

157  
NULL
;

160 
sq
->
_ÿ·c™y
 = 
ÿ·c™y
;

161 
sq
->
_h—d
 = sq->
_
 = 0;

163  
sq
;

164 
	}
}

167 
	$De¡roySŒ—mQueue
(
¡»am_queue_t
 
sq
)

169 ià(!
sq
)

172 ià(
sq
->
_q
) {

173 
	`ä“
((*)
sq
->
_q
);

174 
sq
->
_q
 = 
NULL
;

177 
	`ä“
(
sq
);

178 
	}
}

181 
	$SŒ—mEnqueue
(
¡»am_queue_t
 
sq
, 
tı_¡»am
 *
¡»am
)

183 
šdex_ty³
 
h
 = 
sq
->
_h—d
;

184 
šdex_ty³
 
t
 = 
sq
->
_
;

185 
šdex_ty³
 
Á
 = 
	`NextIndex
(
sq
, 
t
);

187 ià(
Á
 !ğ
h
) {

188 
sq
->
_q
[
t
] = 
¡»am
;

189 
	`SŒ—mMemÜyB¬r›r
(
sq
->
_q
[
t
], sq->
_
);

190 
sq
->
_
 = 
Á
;

194 
	`TRACE_ERROR
("Exceed capacity of stream queue!\n");

196 
	}
}

198 
tı_¡»am
 *

199 
	$SŒ—mDequeue
(
¡»am_queue_t
 
sq
)

201 
šdex_ty³
 
h
 = 
sq
->
_h—d
;

202 
šdex_ty³
 
t
 = 
sq
->
_
;

204 ià(
h
 !ğ
t
) {

205 
tı_¡»am
 *
¡»am
 = 
sq
->
_q
[
h
];

206 
	`SŒ—mMemÜyB¬r›r
(
sq
->
_q
[
h
], sq->
_h—d
);

207 
sq
->
_h—d
 = 
	`NextIndex
(sq, 
h
);

208 
	`as£¹
(
¡»am
);

209  
¡»am
;

212  
NULL
;

213 
	}
}

	@tcp_util.cpp

1 
	~<as£¹.h
>

3 
	~"tı_ut.h
"

4 
	~"tı_ršg_bufãr.h
"

5 
	~"ev’Şl.h
"

6 
	~"debug.h
"

7 
	~"tim”.h
"

8 
	~"_š.h
"

10 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

11 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

15 
	$P¬£TCPO±iÚs
(
tı_¡»am
 *
cur_¡»am
,

16 
ušt32_t
 
cur_ts
, 
ušt8_t
 *
tıİt
, 
Ën
)

18 
i
;

19 
İt
, 
İ’
;

21 
i
 = 0; i < 
Ën
; ) {

22 
İt
 = *(
tıİt
 + 
i
++);

24 ià(
İt
 =ğ
TCP_OPT_END
) {

26 } ià(
İt
 =ğ
TCP_OPT_NOP
) {

30 
İ’
 = *(
tıİt
 + 
i
++);

31 ià(
i
 + 
İ’
 - 2 > 
Ën
) {

35 ià(
İt
 =ğ
TCP_OPT_MSS
) {

36 
cur_¡»am
->
¢dv¬
->
mss
 = *(
tıİt
 + 
i
++) << 8;

37 
cur_¡»am
->
¢dv¬
->
mss
 +ğ*(
tıİt
 + 
i
++);

38 
cur_¡»am
->
¢dv¬
->
eff_mss
 = cur_¡»am->¢dv¬->
mss
;

39 #ià
TCP_OPT_TIMESTAMP_ENABLED


40 
cur_¡»am
->
¢dv¬
->
eff_mss
 -ğ(
TCP_OPT_TIMESTAMP_LEN
 + 2);

42 } ià(
İt
 =ğ
TCP_OPT_WSCALE
) {

43 
cur_¡»am
->
¢dv¬
->
wsÿË_³”
 = *(
tıİt
 + 
i
++);

44 } ià(
İt
 =ğ
TCP_OPT_SACK_PERMIT
) {

45 
cur_¡»am
->
§ck_³rm™
 = 
TRUE
;

46 
	`TRACE_SACK
("Remote SACK…ermited.\n");

47 } ià(
İt
 =ğ
TCP_OPT_TIMESTAMP
) {

48 
	`TRACE_TSTAMP
("Saw…eerimestamp!\n");

49 
cur_¡»am
->
§w_time¡amp
 = 
TRUE
;

50 
cur_¡»am
->
rcvv¬
->
ts_»ûÁ
 = 
	`Áohl
(*(
ušt32_t
 *)(
tıİt
 + 
i
));

51 
cur_¡»am
->
rcvv¬
->
ts_Ï¡_ts_upd
 = 
cur_ts
;

52 
i
 += 8;

55 
i
 +ğ
İ’
 - 2;

59 
	}
}

62 
	$P¬£TCPTime¡amp
(
tı_¡»am
 *
cur_¡»am
,

63 
tı_time¡amp
 *
ts
, 
ušt8_t
 *
tıİt
, 
Ën
)

65 
i
;

66 
İt
, 
İ’
;

68 
i
 = 0; i < 
Ën
; ) {

69 
İt
 = *(
tıİt
 + 
i
++);

71 ià(
İt
 =ğ
TCP_OPT_END
) {

73 } ià(
İt
 =ğ
TCP_OPT_NOP
) {

76 
İ’
 = *(
tıİt
 + 
i
++);

77 ià(
i
 + 
İ’
 - 2 > 
Ën
) {

81 ià(
İt
 =ğ
TCP_OPT_TIMESTAMP
) {

82 
ts
->
ts_v®
 = 
	`Áohl
(*(
ušt32_t
 *)(
tıİt
 + 
i
));

83 
ts
->
ts_»f
 = 
	`Áohl
(*(
ušt32_t
 *)(
tıİt
 + 
i
 + 4));

84  
TRUE
;

87 
i
 +ğ
İ’
 - 2;

91  
FALSE
;

92 
	}
}

93 #ià
TCP_OPT_SACK_ENABLED


96 
	$P¬£SACKO±iÚ
(
tı_¡»am
 *
cur_¡»am
,

97 
ušt32_t
 
ack_£q
, 
ušt8_t
 *
tıİt
, 
Ën
)

99 
i
, 
j
;

100 
İt
, 
İ’
;

101 
ušt32_t
 
Ëá_edge
, 
right_edge
;

103 
i
 = 0; i < 
Ën
; ) {

104 
İt
 = *(
tıİt
 + 
i
++);

106 ià(
İt
 =ğ
TCP_OPT_END
) {

108 } ià(
İt
 =ğ
TCP_OPT_NOP
) {

111 
İ’
 = *(
tıİt
 + 
i
++);

112 ià(
i
 + 
İ’
 - 2 > 
Ën
) {

116 ià(
İt
 =ğ
TCP_OPT_SACK
) {

117 
j
 = 0;

118 
j
 < 
İ’
 - 2) {

119 
Ëá_edge
 = 
	`Áohl
(*(
ušt32_t
 *)(
tıİt
 + 
i
 + 
j
));

120 
right_edge
 = 
	`Áohl
(*(
ušt32_t
 *)(
tıİt
 + 
i
 + 
j
 + 4));

122 
cur_¡»am
->
rcvv¬
->
§ck_bË


123 [
cur_¡»am
->
rcvv¬
->
§cks
].
Ëá_edge
 =†eft_edge;

124 
cur_¡»am
->
rcvv¬
->
§ck_bË


125 [
cur_¡»am
->
rcvv¬
->
§cks
].
right_edge
 =„ight_edge;

126 
cur_¡»am
->
rcvv¬
->
§cks
++;

127 
j
 += 8;

128 #ià
RTM_STAT


129 
cur_¡»am
->
r¡©
->
§ck_út
++;

130 
cur_¡»am
->
r¡©
->
§ck_by‹s
 +ğ(
right_edge
 - 
Ëá_edge
);

132 ià(
cur_¡»am
->
rcvv¬
->
dup_acks
 == 3) {

133 #ià
RTM_STAT


134 
cur_¡»am
->
r¡©
->
tdp_§ck_út
++;

135 
cur_¡»am
->

136 
r¡©
->
tdp_§ck_by‹s
 +ğ(
right_edge
 - 
Ëá_edge
);

138 
	`TRACE_LOSS
("SACKƒntry. "

140 
Ëá_edge
, 
right_edge
, 
ack_£q
);

143 
	`TRACE_SACK
("Found SACKƒntry. "

145 
Ëá_edge
, 
right_edge
);

147 
i
 +ğ
j
;

150 
i
 +ğ
İ’
 - 2;

154 
	}
}

157 
ušt16_t


158 
	$TCPC®cChecksum
(
ušt16_t
 *
buf
, ušt16_ˆ
Ën
, 
ušt32_t
 
§ddr
, ušt32_ˆ
daddr
)

160 
ušt32_t
 
sum
;

161 
ušt16_t
 *
w
;

162 
Æeá
;

164 
sum
 = 0;

165 
Æeá
 = 
Ën
;

166 
w
 = 
buf
;

168 
Æeá
 > 1)

170 
sum
 +ğ*
w
++;

171 
Æeá
 -= 2;

175 ià(
Æeá
)

176 
sum
 +ğ*
w
 & 
	`Áohs
(0xFF00);

179 
sum
 +ğ(
§ddr
 & 0x0000FFFF) + (saddr >> 16);

180 
sum
 +ğ(
daddr
 & 0x0000FFFF) + (daddr >> 16);

181 
sum
 +ğ
	`htÚs
(
Ën
);

182 
sum
 +ğ
	`htÚs
(
IPPROTO_TCP
);

184 
sum
 = (sum >> 16) + (sum & 0xFFFF);

185 
sum
 += (sum >> 16);

187 
sum
 = ~sum;

189  (
ušt16_t
)
sum
;

190 
	}
}

193 
	$PrštTCPO±iÚs
(
ušt8_t
 *
tıİt
, 
Ën
)

195 
i
;

196 
İt
, 
İ’
;

198 
i
 = 0; i < 
Ën
; i++) {

199 
	`´štf
("%u ", 
tıİt
[
i
]);

201 
	`´štf
("\n");

203 
i
 = 0; i < 
Ën
; ) {

204 
İt
 = *(
tıİt
 + 
i
++);

206 ià(
İt
 =ğ
TCP_OPT_END
) {

208 } ià(
İt
 =ğ
TCP_OPT_NOP
) {

212 
İ’
 = *(
tıİt
 + 
i
++);

214 
	`´štf
("O±iÚ: %d", 
İt
);

215 
	`´štf
(",†’gth: %d", 
İ’
);

217 ià(
İt
 =ğ
TCP_OPT_MSS
) {

218 
ušt16_t
 
mss
;

219 
mss
 = *(
tıİt
 + 
i
++) << 8;

220 
mss
 +ğ*(
tıİt
 + 
i
++);

221 
	`´štf
(", MSS: %u", 
mss
);

222 } ià(
İt
 =ğ
TCP_OPT_SACK_PERMIT
) {

223 
	`´štf
(", SACK…ermit");

224 } ià(
İt
 =ğ
TCP_OPT_TIMESTAMP
) {

225 
ušt32_t
 
ts_v®
, 
ts_»f
;

226 
ts_v®
 = *(
ušt32_t
 *)(
tıİt
 + 
i
);

227 
i
 += 4;

228 
ts_»f
 = *(
ušt32_t
 *)(
tıİt
 + 
i
);

229 
i
 += 4;

230 
	`´štf
(", TSv®: %u, TS»f: %u", 
ts_v®
, 
ts_»f
);

231 } ià(
İt
 =ğ
TCP_OPT_WSCALE
) {

232 
ušt8_t
 
wsÿË
;

233 
wsÿË
 = *(
tıİt
 + 
i
++);

234 
	`´štf
(", WsÿË: %u", 
wsÿË
);

237 
i
 +ğ
İ’
 - 2;

239 
	`´štf
("\n");

242 
	}
}

	@testing/TestClient/client.cpp

1 
	#_LARGEFILE64_SOURCE


	)

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<¡dšt.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

12 
	~<dœ’t.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

15 
	~<±h»ad.h
>

16 
	~<sigÇl.h
>

17 
	~<io¡»am
>

18 
	~<mtı_­i.h
>

19 
	~<mtı_•Şl.h
>

20 
	~<lim™s.h
>

21 
	~"ıu.h
"

22 
	~"debug.h
"

23 
	~"Ãtm­_­i.h
"

25 
	#MAX_EVENTS
 65536

	)

27 
usšg
 
Çme¥aû
 
	g¡d
;

28 
	gdÚe
;

29 
mùx_t
 
	gmùx
;

32 
	$SigÇlHªdËr
(
signum
)

35 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

36 
	`mtı_de¡roy
();

37 
dÚe
 = 1;

38 
	}
}

41 
	$maš
(
¬gc
, **
¬gv
){

43 
cÜe
 = 0;

44 
»t
 = -1;

45 
dÚe
 = 0;

47 ià(
¬gc
 != 3) {

48 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

49 
	`ex™
(0);

51 * 
ho¡Çme
 = 
¬gv
[1];

52 
pÜŠo
 = 
	`©oi
(
¬gv
[2]);

54 * 
cÚf_fe
 = "client.conf";

56 ià(
cÚf_fe
 =ğ
NULL
) {

57 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

58 
	`ex™
(
EXIT_FAILURE
);

62 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

63 ià(
»t
) {

64 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

65 
	`ex™
(
EXIT_FAILURE
);

69 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

71 
	`TRACE_INFO
("Application initialization finished.\n");

74 
	`mtı_cÜe_affš™ize
(
cÜe
);

79 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

80 ià(!
mùx
) {

81 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

82  
NULL
;

86 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

87 ià(
•
 < 0) {

88 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

89  
NULL
;

93 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

94 ià(
sockid
 < 0) {

95 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

98 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

99 ià(
»t
 < 0) {

100 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

104 
sockaddr_š
 
daddr
;

106 
daddr
.
sš_çmy
 = 
AF_INET
;

107 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

108 
daddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

110 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

111 ià(
»t
 < 0) {

112 ià(
”ºo
 !ğ
EINPROGRESS
) {

113 
	`³¼Ü
("mtcp_connect");

114 
	`mtı_şo£
(
mùx
, 
sockid
);

123 
mtı_•Şl_ev’t
 
ev
;

124 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

125 
ev
.
d©a
.
sockid
 = sockid;

126 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

129 
mtı_•Şl_ev’t
 *
ev’ts
;

130 
Ãv’ts
;

131 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

132 ià(!
ev’ts
) {

133 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

134 
	`ex™
(-1);

136 
Ãwsockfd
 = -1;

137 
couÁ
 = 0;

138 
bur¡_šü—£d
 = 0;

139 
d©a
[128];

140 !
dÚe
){

141 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

143 ià(
Ãv’ts
 < 0) {

144 ià(
”ºo
 !ğ
EINTR
)

145 
	`³¼Ü
("mtcp_epoll_wait");

148 
i
=0;i<
Ãv’ts
;i++) {

149 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLIN
) {

152 if(!
bur¡_šü—£d
) {

153 
bur¡_šü—£d
 = 1;

154 
Ãtm­u£
.
šc_bur¡
 = 1;

155 
	`D
("Burst increased");

157 
rd
 = 
	`mtı_»ad
(
mùx
, 
sockid
, 
d©a
, 1408);

158 ià(
rd
 <= 0) {

159  
rd
;

168 
	}
}

	@testing/TestServer/server.cpp

1 
	#_LARGEFILE64_SOURCE


	)

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<¡dšt.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

12 
	~<dœ’t.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

15 
	~<±h»ad.h
>

16 
	~<sigÇl.h
>

17 
	~<io¡»am
>

18 
	~<mtı_­i.h
>

19 
	~<mtı_•Şl.h
>

20 
	~<io¡»am
>

21 
	~"ıu.h
"

22 
	~"debug.h
"

24 
	#MAX_EVENTS
 1024

	)

26 
usšg
 
Çme¥aû
 
	g¡d
;

27 
	gdÚe
;

30 
	$SigÇlHªdËr
(
signum
)

33 
dÚe
 = 1;

34 
	}
}

37 
	$maš
(
¬gc
, **
¬gv
){

39 
cÜe
 = 0;

40 
»t
 = -1;

41 
dÚe
 = 0;

43 ià(
¬gc
 != 2) {

44 
	`årštf
(
¡d”r
,"u§ge: <pÜt>\n", 
¬gv
[0]);

45 
	`ex™
(0);

47 
pÜŠo
 = 
	`©oi
(
¬gv
[1]);

49 * 
cÚf_fe
 = "server.conf";

51 ià(
cÚf_fe
 =ğ
NULL
) {

52 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

53 
	`ex™
(
EXIT_FAILURE
);

56 
	`TRACE_INFO
("R—dšg cÚfigu¿tiÚ from %s\n",
cÚf_fe
);

59 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

60 ià(
»t
) {

61 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

62 
	`ex™
(
EXIT_FAILURE
);

66 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

68 
	`TRACE_INFO
("Application initialization finished.\n");

71 
	`mtı_cÜe_affš™ize
(
cÜe
);

76 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

77 ià(!
mùx
) {

78 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

79  
NULL
;

82 
	`TRACE_INFO
("mtcp context created.\n");

85 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

86 ià(
•
 < 0) {

87 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

88  
NULL
;

92 
li¡’”
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

93 ià(
li¡’”
 < 0) {

94 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

97 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
li¡’”
);

98 ià(
»t
 < 0) {

99 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

103 
sockaddr_š
 
§ddr
;

105 
§ddr
.
sš_çmy
 = 
AF_INET
;

106 
§ddr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

107 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

109 
»t
 = 
	`mtı_bšd
(
mùx
, 
li¡’”
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

110 ià(
»t
 < 0) {

111 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

117 
»t
 = 
	`mtı_li¡’
(
mùx
, 
li¡’”
, 4096);

118 ià(
»t
 < 0) {

119 
	`TRACE_ERROR
("mtcp_listen() failed!\n");

124 
mtı_•Şl_ev’t
 
ev
;

125 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

126 
ev
.
d©a
.
sockid
 = 
li¡’”
;

127 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
li¡’”
, &
ev
);

130 
mtı_•Şl_ev’t
 *
ev’ts
;

131 
Ãv’ts
;

132 
Ãwsockfd
 = -1;

133 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

134 ià(!
ev’ts
) {

135 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

136 
	`ex™
(-1);

138 
cout
 << "Wa™šg fÜƒv’ts" << 
’dl
;

139 !
dÚe
){

140 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

142 ià(
Ãv’ts
 < 0) {

143 ià(
”ºo
 !ğ
EINTR
)

144 
	`³¼Ü
("mtcp_epoll_wait");

148 
i
=0;i<
Ãv’ts
;i++) {

149 ià(
ev’ts
[
i
].
d©a
.
sockid
 =ğ
li¡’”
) {

151 
Ãwsockfd
 = 
	`mtı_acû±
(
mùx
, 
li¡’”
, 
NULL
, NULL);

152 
	`TRACE_APP
("New cÚÃùiÚ %d‡cû±ed.\n", 
c
);

153 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

154 
ev
.
d©a
.
sockid
 = 
Ãwsockfd
;

155 
	`mtı_£tsock_nÚblock
(
mùx
, 
Ãwsockfd
);

156 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
Ãwsockfd
, &
ev
);

159 *
d©a
 = "hello";

160 
»t
 = 1;

161 
»t
 > 0) {

162 
»t
 = 
	`mtı_wr™e
(
mùx
, 
Ãwsockfd
, 
d©a
, 5);

163 ià(
»t
 < 0) {

164 
	`TRACE_APP
("Connection closed with client.\n");

169 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

171 *
d©a
 = "hello";

172 
»t
 = 1;

173 
»t
 > 0) {

174 
»t
 = 
	`mtı_wr™e
(
mùx
, 
Ãwsockfd
, 
d©a
, 5);

175 ià(
»t
 < 0) {

176 
	`TRACE_APP
("Connection closed with client.\n");

185 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

186 
	}
}

	@testing/epserver/epserver.cpp

1 
	#_LARGEFILE64_SOURCE


	)

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<¡dšt.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

12 
	~<dœ’t.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

15 
	~<±h»ad.h
>

16 
	~<sigÇl.h
>

17 
	~<io¡»am
>

18 
	~<mtı_­i.h
>

19 
	~<mtı_•Şl.h
>

21 
	~"ıu.h
"

22 
	~"h‰p_·rsšg.h
"

23 
	~"debug.h
"

25 
usšg
 
Çme¥aû
 
	g¡d
;

27 
	#MAX_FLOW_NUM
 (10000)

	)

29 
	#RCVBUF_SIZE
 (2*1024)

	)

30 
	#SNDBUF_SIZE
 (8*1024)

	)

32 
	#MAX_EVENTS
 (
MAX_FLOW_NUM
 * 3)

	)

34 
	#HTTP_HEADER_LEN
 1024

	)

35 
	#URL_LEN
 128

	)

37 
	#MAX_CPUS
 16

	)

38 
	#MAX_FILES
 30

	)

40 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

41 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

43 #iâdeà
TRUE


44 
	#TRUE
 (1)

	)

47 #iâdeà
FALSE


48 
	#FALSE
 (0)

	)

51 #iâdeà
ERROR


52 
	#ERROR
 (-1)

	)

55 
	#HT_SUPPORT
 
FALSE


	)

58 
	sfe_ÿche


60 
	mÇme
[128];

61 
	mfuÎÇme
[256];

62 
ušt64_t
 
	msize
;

63 *
	mfe
;

66 
	s£rv”_v¬s


68 
	m»que¡
[
HTTP_HEADER_LEN
];

69 
	m»cv_Ën
;

70 
	m»que¡_Ën
;

71 
	mtÙ®_»ad
, 
	mtÙ®_£Á
;

72 
ušt8_t
 
	mdÚe
;

73 
ušt8_t
 
	mr¥h—d”_£Á
;

74 
ušt8_t
 
	mk“p_®ive
;

76 
	mfidx
;

77 
	mâame
[128];

78 
	mfsize
;

81 
	sth»ad_cÚ‹xt


83 
mùx_t
 
	mmùx
;

84 
	m•
;

85 
£rv”_v¬s
 *
	msv¬s
;

88 
	gnum_cÜes
;

89 
	gcÜe_lim™
;

90 
±h»ad_t
 
	g­p_th»ad
[
MAX_CPUS
];

91 
	gdÚe
[
MAX_CPUS
];

92 *
	gcÚf_fe
 = 
NULL
;

94 cÚ¡ *
	gwww_maš
;

95 
fe_ÿche
 
	gfÿche
[
MAX_FILES
];

96 
	gnfes
;

98 
	gfšished
;

101 
	$StusCodeToSŒšg
(
scode
)

103 
scode
) {

113  
NULL
;

114 
	}
}

117 
	$CËªS”v”V¬ŸbË
(
£rv”_v¬s
 *
sv
)

119 
sv
->
»cv_Ën
 = 0;

120 
sv
->
»que¡_Ën
 = 0;

121 
sv
->
tÙ®_»ad
 = 0;

122 
sv
->
tÙ®_£Á
 = 0;

123 
sv
->
dÚe
 = 0;

124 
sv
->
r¥h—d”_£Á
 = 0;

125 
sv
->
k“p_®ive
 = 0;

126 
	}
}

129 
	$Clo£CÚÃùiÚ
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

131 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_DEL
, 
sockid
, 
NULL
);

132 
	`mtı_şo£
(
ùx
->
mùx
, 
sockid
);

133 
	}
}

136 
	$S’dUÁAvaabË
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

138 
»t
;

139 
£Á
;

140 
Ën
;

142 ià(
sv
->
dÚe
 || !sv->
r¥h—d”_£Á
) {

146 
£Á
 = 0;

147 
»t
 = 1;

148 
d
[1024];

149 
	`bz”o
(
d
,1024);

150 
d
 = "hello";

151 
»t
 > 0) {

159 
»t
 = 
	`mtı_wr™e
(
ùx
->
mùx
, 
sockid
, 
d
, 5);

160 ià(
»t
 < 0) {

161 
	`TRACE_APP
("Connection closed with client.\n");

164 
	`TRACE_APP
("Sock‘ %d: mtı_wr™Œy: %d,„‘: %d\n", 
sockid
, 
Ën
, 
»t
);

165 
£Á
 +ğ
»t
;

166 
sv
->
tÙ®_£Á
 +ğ
»t
;

187  
£Á
;

188 
	}
}

191 
	$HªdËR—dEv’t
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

193 
mtı_•Şl_ev’t
 
ev
;

194 
buf
[
HTTP_HEADER_LEN
];

195 
u¾
[
URL_LEN
];

196 
»¥Ú£
[
HTTP_HEADER_LEN
];

197 
scode
;

198 
time_t
 
t_now
;

199 
t_¡r
[128];

200 
k“·live_¡r
[128];

201 
rd
;

202 
i
;

203 
Ën
;

204 
£Á
;

207 
rd
 = 
	`mtı_»ad
(
ùx
->
mùx
, 
sockid
, 
buf
, 
HTTP_HEADER_LEN
);

208 ià(
rd
 <= 0) {

209  
rd
;

211 
	`memıy
(
sv
->
»que¡
 + sv->
»cv_Ën
,

212 (*)
buf
, 
	`MIN
(
rd
, 
HTTP_HEADER_LEN
 - 
sv
->
»cv_Ën
));

213 
sv
->
»cv_Ën
 +ğ
rd
;

216 
sv
->
»que¡_Ën
 = 
	`fšd_h‰p_h—d”
(sv->
»que¡
, sv->
»cv_Ën
);

217 ià(
sv
->
»que¡_Ën
 <= 0) {

218 
	`TRACE_ERROR
("Socket %d: Failedo…arse HTTP„equest header.\n"

221 
sockid
, 
rd
, 
sv
->
»cv_Ën
,

222 
sv
->
»que¡_Ën
, 
	`¡¾’
(sv->
»que¡
), sv->request);

223  
rd
;

226 
	`h‰p_g‘_u¾
(
sv
->
»que¡
, sv->
»que¡_Ën
, 
u¾
, 
URL_LEN
);

227 
	`TRACE_APP
("Sock‘ %d URL: %s\n", 
sockid
, 
u¾
);

228 
	`¥rštf
(
sv
->
âame
, "%s%s", 
www_maš
, 
u¾
);

229 
	`TRACE_APP
("Sock‘ %d FÇme: %s\n", 
sockid
, 
sv
->
âame
);

231 
sv
->
k“p_®ive
 = 
FALSE
;

232 ià(
	`h‰p_h—d”_¡r_v®
(
sv
->
»que¡
, "Connection: ",

233 
	`¡¾’
("CÚÃùiÚ: "), 
k“·live_¡r
, 128)) {

234 ià(
	`¡r¡r
(
k“·live_¡r
, "Keep-Alive")) {

235 
sv
->
k“p_®ive
 = 
TRUE
;

236 } ià(
	`¡r¡r
(
k“·live_¡r
, "Close")) {

237 
sv
->
k“p_®ive
 = 
FALSE
;

242 
scode
 = 404;

243 
i
 = 0; i < 
nfes
; i++) {

244 ià(
	`¡rcmp
(
sv
->
âame
, 
fÿche
[
i
].
fuÎÇme
) == 0) {

245 
sv
->
fsize
 = 
fÿche
[
i
].
size
;

246 
sv
->
fidx
 = 
i
;

247 
scode
 = 200;

251 
	`TRACE_APP
("Socket %d File size: %ld (%ldMB)\n",

252 
sockid
, 
sv
->
fsize
, sv->fsize / 1024 / 1024);

255 
	`time
(&
t_now
);

256 
	`¡ráime
(
t_¡r
, 128, "%a, %d %b %Y %X GMT", 
	`gmtime
(&
t_now
));

257 ià(
sv
->
k“p_®ive
)

258 
	`¥rštf
(
k“·live_¡r
, "Keep-Alive");

260 
	`¥rštf
(
k“·live_¡r
, "Close");

262 
	`¥rštf
(
»¥Ú£
, "HTTP/1.1 %d %s\r\n"

267 
scode
, 
	`StusCodeToSŒšg
(scode), 
t_¡r
, 
sv
->
fsize
, 
k“·live_¡r
);

268 
Ën
 = 
	`¡¾’
(
»¥Ú£
);

269 
	`TRACE_APP
("Sock‘ %d HTTP Re¥Ú£: \n%s", 
sockid
, 
»¥Ú£
);

270 
£Á
 = 
	`mtı_wr™e
(
ùx
->
mùx
, 
sockid
, 
»¥Ú£
, 
Ën
);

271 
	`TRACE_APP
("Socket %d Sent„esponse header:ry: %d, sent: %d\n",

272 
sockid
, 
Ën
, 
£Á
);

273 
	`as£¹
(
£Á
 =ğ
Ën
);

274 
sv
->
r¥h—d”_£Á
 = 
TRUE
;

276 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
 | 
MTCP_EPOLLOUT
;

277 
ev
.
d©a
.
sockid
 = sockid;

278 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_MOD
, 
sockid
, &
ev
);

280 
	`S’dUÁAvaabË
(
ùx
, 
sockid
, 
sv
);

282  
rd
;

283 
	}
}

286 
	$Acû±CÚÃùiÚ
(
th»ad_cÚ‹xt
 *
ùx
, 
li¡’”
)

288 
mùx_t
 
mùx
 = 
ùx
->mctx;

289 
£rv”_v¬s
 *
sv
;

290 
mtı_•Şl_ev’t
 
ev
;

291 
c
;

293 
c
 = 
	`mtı_acû±
(
mùx
, 
li¡’”
, 
NULL
, NULL);

295 ià(
c
 >= 0) {

296 ià(
c
 >ğ
MAX_FLOW_NUM
) {

297 
	`TRACE_ERROR
("Inv®id sock‘ id %d.\n", 
c
);

301 
sv
 = &
ùx
->
sv¬s
[
c
];

302 
	`CËªS”v”V¬ŸbË
(
sv
);

303 
	`TRACE_APP
("New cÚÃùiÚ %d‡cû±ed.\n", 
c
);

304 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

305 
ev
.
d©a
.
sockid
 = 
c
;

306 
	`mtı_£tsock_nÚblock
(
ùx
->
mùx
, 
c
);

307 
	`mtı_•Şl_ùl
(
mùx
, 
ùx
->
•
, 
MTCP_EPOLL_CTL_ADD
, 
c
, &
ev
);

308 
	`TRACE_APP
("Sock‘ %d„egi¡”ed.\n", 
c
);

311 ià(
”ºo
 !ğ
EAGAIN
) {

312 
	`TRACE_ERROR
("mtcp_accept()ƒrror %s\n",

313 
	`¡»¼Ü
(
”ºo
));

317  
c
;

318 
	}
}

320 
th»ad_cÚ‹xt
 *

321 
	$In™ŸlizeS”v”Th»ad
(
cÜe
)

323 
th»ad_cÚ‹xt
 *
ùx
;

326 #ià
HT_SUPPORT


327 
	`mtı_cÜe_affš™ize
(
cÜe
 + (
num_cÜes
 / 2));

329 
	`mtı_cÜe_affš™ize
(
cÜe
);

332 
ùx
 = (
th»ad_cÚ‹xt
 *)
	`ÿÎoc
(1, (thread_context));

333 ià(!
ùx
) {

334 
	`TRACE_ERROR
("Failedo createhread context!\n");

335  
NULL
;

339 
ùx
->
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

340 ià(!
ùx
->
mùx
) {

341 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

342  
NULL
;

346 
ùx
->
•
 = 
	`mtı_•Şl_ü—‹
(ùx->
mùx
, 
MAX_EVENTS
);

347 ià(
ùx
->
•
 < 0) {

348 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

349  
NULL
;

353 
ùx
->
sv¬s
 = (
£rv”_v¬s
 *)

354 
	`ÿÎoc
(
MAX_FLOW_NUM
, (
£rv”_v¬s
));

355 ià(!
ùx
->
sv¬s
) {

356 
	`TRACE_ERROR
("Failedo create server_vars struct!\n");

357  
NULL
;

360  
ùx
;

361 
	}
}

364 
	$C»©eLi¡’šgSock‘
(
th»ad_cÚ‹xt
 *
ùx
)

366 
li¡’”
;

367 
mtı_•Şl_ev’t
 
ev
;

368 
sockaddr_š
 
§ddr
;

369 
»t
;

372 
li¡’”
 = 
	`mtı_sock‘
(
ùx
->
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

373 ià(
li¡’”
 < 0) {

374 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

377 
»t
 = 
	`mtı_£tsock_nÚblock
(
ùx
->
mùx
, 
li¡’”
);

378 ià(
»t
 < 0) {

379 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

384 
§ddr
.
sš_çmy
 = 
AF_INET
;

385 
§ddr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

386 
§ddr
.
sš_pÜt
 = 
	`htÚs
(9999);

387 
»t
 = 
	`mtı_bšd
(
ùx
->
mùx
, 
li¡’”
,

388 (
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

389 ià(
»t
 < 0) {

390 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

395 
»t
 = 
	`mtı_li¡’
(
ùx
->
mùx
, 
li¡’”
, 4096);

396 ià(
»t
 < 0) {

397 
	`TRACE_ERROR
("mtcp_listen() failed!\n");

402 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

403 
ev
.
d©a
.
sockid
 = 
li¡’”
;

404 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_ADD
, 
li¡’”
, &
ev
);

406  
li¡’”
;

407 
	}
}

410 
	$RunS”v”Th»ad
(*
¬g
)

412 
cÜe
 = *(*)
¬g
;

413 
th»ad_cÚ‹xt
 *
ùx
;

414 
mùx_t
 
mùx
;

415 
li¡’”
;

416 
•
;

417 
mtı_•Şl_ev’t
 *
ev’ts
;

418 
Ãv’ts
;

419 
i
, 
»t
;

420 
do_acû±
;

423 
ùx
 = 
	`In™ŸlizeS”v”Th»ad
(
cÜe
);

424 ià(!
ùx
) {

425 
	`TRACE_ERROR
("Failedo initialize serverhread.\n");

426  
NULL
;

428 
mùx
 = 
ùx
->mctx;

429 
•
 = 
ùx
->ep;

431 
ev’ts
 = (
mtı_•Şl_ev’t
 *)

432 
	`ÿÎoc
(
MAX_EVENTS
, (
mtı_•Şl_ev’t
));

433 ià(!
ev’ts
) {

434 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

435 
	`ex™
(-1);

438 
li¡’”
 = 
	`C»©eLi¡’šgSock‘
(
ùx
);

439 ià(
li¡’”
 < 0) {

440 
	`TRACE_ERROR
("Failedo create†istening socket.\n");

441 
	`ex™
(-1);

443 !
dÚe
[
cÜe
]) {

444 
cout
 << "H”e" << 
’dl
;

446 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

448 ià(
Ãv’ts
 < 0) {

449 ià(
”ºo
 !ğ
EINTR
)

450 
	`³¼Ü
("mtcp_epoll_wait");

454 
do_acû±
 = 
FALSE
;

455 
i
 = 0; i < 
Ãv’ts
; i++) {

457 ià(
ev’ts
[
i
].
d©a
.
sockid
 =ğ
li¡’”
) {

459 
do_acû±
 = 
TRUE
;

461 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLERR
) {

462 
”r
;

463 
sockËn_t
 
Ën
 = (
”r
);

466 
	`TRACE_APP
("[CPU %d] Error on socket %d\n",

467 
cÜe
, 
ev’ts
[
i
].
d©a
.
sockid
);

468 ià(
	`mtı_g‘sockİt
(
mùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

469 
SOL_SOCKET
, 
SO_ERROR
, (*)&
”r
, &
Ën
) == 0) {

470 ià(
”r
 !ğ
ETIMEDOUT
) {

471 
	`årštf
(
¡d”r
, "Error on socket %d: %s\n",

472 
ev’ts
[
i
].
d©a
.
sockid
, 
	`¡»¼Ü
(
”r
));

475 
	`³¼Ü
("mtcp_getsockopt");

477 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

478 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

480 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLIN
) {

481 
»t
 = 
	`HªdËR—dEv’t
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

482 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

484 ià(
»t
 == 0) {

486 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

487 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

488 } ià(
»t
 < 0) {

490 ià(
”ºo
 !ğ
EAGAIN
) {

491 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

492 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

496 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

497 
£rv”_v¬s
 *
sv
 = &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
];

498 ià(
sv
->
r¥h—d”_£Á
) {

499 
	`S’dUÁAvaabË
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
, 
sv
);

501 
	`TRACE_APP
("Socket %d: Response header‚ot sent yet.\n",

502 
ev’ts
[
i
].
d©a
.
sockid
);

506 
	`as£¹
(0);

511 ià(
do_acû±
) {

513 
»t
 = 
	`Acû±CÚÃùiÚ
(
ùx
, 
li¡’”
);

514 ià(
»t
 < 0)

522 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

523 
	`±h»ad_ex™
(
NULL
);

525  
NULL
;

526 
	}
}

529 
	$SigÇlHªdËr
(
signum
)

531 
i
;

533 
i
 = 0; i < 
cÜe_lim™
; i++) {

534 ià(
­p_th»ad
[
i
] =ğ
	`±h»ad_£lf
()) {

536 
dÚe
[
i
] = 
TRUE
;

538 ià(!
dÚe
[
i
]) {

539 
	`±h»ad_kl
(
­p_th»ad
[
i
], 
signum
);

543 
	}
}

546 
	$´štH–p
(cÚ¡ *
´og_Çme
)

548 
	`TRACE_CONFIG
("%s -p <path_to_www/> -f <mtcp_conf_file> "

550 
´og_Çme
);

551 
	`ex™
(
EXIT_SUCCESS
);

552 
	}
}

555 
	$maš
(
¬gc
, **
¬gv
)

557 
DIR
 *
dœ
;

558 
dœ’t
 *
’t
;

559 
fd
;

560 
»t
;

561 
ušt64_t
 
tÙ®_»ad
;

562 
mtı_cÚf
 
mcfg
;

563 
cÜes
[
MAX_CPUS
];

564 
´oûss_ıu
;

565 
i
, 
o
;

567 
num_cÜes
 = 
	`G‘NumCPUs
();

568 
cÜe_lim™
 = 
num_cÜes
;

569 
´oûss_ıu
 = -1;

570 
dœ
 = 
NULL
;

572 ià(
¬gc
 < 2) {

573 
	`TRACE_CONFIG
("$% dœeùÜy_to_£rviû\n", 
¬gv
[0]);

574  
FALSE
;

577 -1 !ğ(
o
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "N:f:p:c:h"))) {

578 
o
) {

581 
www_maš
 = 
İrg
;

582 
dœ
 = 
	`İ’dœ
(
www_maš
);

583 ià(!
dœ
) {

584 
	`TRACE_CONFIG
("FaedØİ’ %s.\n", 
www_maš
);

585 
	`³¼Ü
("opendir");

586  
FALSE
;

590 
cÜe_lim™
 = 
	`©oi
(
İrg
);

591 ià(
cÜe_lim™
 > 
num_cÜes
) {

592 
	`TRACE_CONFIG
("CPU†imit should be smallerhanhe "

593 "numb” oàCPUs: %d\n", 
num_cÜes
);

594  
FALSE
;

601 
	`mtı_g‘cÚf
(&
mcfg
);

602 
mcfg
.
num_cÜes
 = 
cÜe_lim™
;

603 
	`mtı_£tcÚf
(&
mcfg
);

606 
cÚf_fe
 = 
İrg
;

609 
´oûss_ıu
 = 
	`©oi
(
İrg
);

610 ià(
´oûss_ıu
 > 
cÜe_lim™
) {

611 
	`TRACE_CONFIG
("Starting CPU is way off†imits!\n");

612  
FALSE
;

616 
	`´štH–p
(
¬gv
[0]);

621 ià(
dœ
 =ğ
NULL
) {

622 
	`TRACE_CONFIG
("You did‚ot…ass‡ valid www_path!\n");

623 
	`ex™
(
EXIT_FAILURE
);

626 
nfes
 = 0;

627 (
’t
 = 
	`»addœ
(
dœ
)è!ğ
NULL
) {

628 ià(
	`¡rcmp
(
’t
->
d_Çme
, ".") == 0)

630 ià(
	`¡rcmp
(
’t
->
d_Çme
, "..") == 0)

633 
	`¡rıy
(
fÿche
[
nfes
].
Çme
, 
’t
->
d_Çme
);

634 
	`¥rštf
(
fÿche
[
nfes
].
fuÎÇme
, "%s/%s", 
www_maš
, 
’t
->
d_Çme
);

635 
fd
 = 
	`İ’
(
fÿche
[
nfes
].
fuÎÇme
, 
O_RDONLY
);

636 ià(
fd
 < 0) {

637 
	`³¼Ü
("open");

640 
fÿche
[
nfes
].
size
 = 
	`l£ek64
(
fd
, 0, 
SEEK_END
);

641 
	`l£ek64
(
fd
, 0, 
SEEK_SET
);

644 
fÿche
[
nfes
].
fe
 = (*)
	`m®loc
(fÿche[nfes].
size
);

645 ià(!
fÿche
[
nfes
].
fe
) {

646 
	`TRACE_CONFIG
("Failedo‡llocate memory for file %s\n",

647 
fÿche
[
nfes
].
Çme
);

648 
	`³¼Ü
("malloc");

652 
	`TRACE_INFO
("Reading %s (%lu bytes)\n",

653 
fÿche
[
nfes
].
Çme
, fÿche[nfes].
size
);

654 
tÙ®_»ad
 = 0;

656 
»t
 = 
	`»ad
(
fd
, 
fÿche
[
nfes
].
fe
 + 
tÙ®_»ad
,

657 
fÿche
[
nfes
].
size
 - 
tÙ®_»ad
);

658 ià(
»t
 < 0) {

660 } ià(
»t
 == 0) {

663 
tÙ®_»ad
 +ğ
»t
;

665 ià(
tÙ®_»ad
 < 
fÿche
[
nfes
].
size
) {

666 
	`ä“
(
fÿche
[
nfes
].
fe
);

669 
	`şo£
(
fd
);

670 
nfes
++;

672 ià(
nfes
 >ğ
MAX_FILES
)

676 
fšished
 = 0;

679 ià(
cÚf_fe
 =ğ
NULL
) {

680 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

681 
	`ex™
(
EXIT_FAILURE
);

684 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

685 ià(
»t
) {

686 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

687 
	`ex™
(
EXIT_FAILURE
);

691 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

693 
	`TRACE_INFO
("Application initialization finished.\n");

695 
i
 = ((
´oûss_ıu
 =ğ-1è? 0 :…roûss_ıu); i < 
cÜe_lim™
; i++) {

696 
cÜes
[
i
] = i;

697 
dÚe
[
i
] = 
FALSE
;

699 ià(
	`±h»ad_ü—‹
(&
­p_th»ad
[
i
],

700 
NULL
, 
RunS”v”Th»ad
, (*)&
cÜes
[
i
])) {

701 
	`³¼Ü
("pthread_create");

702 
	`TRACE_CONFIG
("Failedo create serverhread.\n");

703 
	`ex™
(
EXIT_FAILURE
);

705 ià(
´oûss_ıu
 != -1)

709 
i
 = ((
´oûss_ıu
 =ğ-1è? 0 :…roûss_ıu); i < 
cÜe_lim™
; i++) {

710 
	`±h»ad_još
(
­p_th»ad
[
i
], 
NULL
);

712 ià(
´oûss_ıu
 != -1)

716 
	`mtı_de¡roy
();

717 
	`şo£dœ
(
dœ
);

719 
	}
}

	@testing/epserver/http_parsing.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<ùy³.h
>

4 
	#_GNU_SOURCE


	)

5 
	~<¡ršg.h
>

6 
	~<”ºo.h
>

7 
	~"h‰p_·rsšg.h
"

8 
	~"td©e_·r£.h
"

10 
	#SPACE_OR_TAB
(
x
è((xè=ğ' ' || (xè=ğ'\t')

	)

11 
	#CR_OR_NEWLINE
(
x
è((xè=ğ'\r' || (xè=ğ'\n')

	)

15 
	$Äe_¡rÿ£¡r
(cÚ¡ * 
buf
, cÚ¡ * 
key
)

17 
n
 = 
	`¡¾’
(
key
) - 1;

18 cÚ¡ *
p
 = 
buf
;

20 *
p
) {

21 *
p
 && *°!ğ*
key
)

22 
p
++;

24 ià(*
p
 == '\0')

25  (
NULL
);

27 ià(!
	`¡ºÿ£cmp
(
p
 + 1, 
key
 + 1, 
n
))

28  (*)
p
;

29 
p
++;

31  
NULL
;

32 
	}
}

35 
	$fšd_h‰p_h—d”
(*
d©a
, 
Ën
)

37 *
‹mp
 = 
d©a
;

38 
hdr_Ën
 = 0;

39 
ch
 = 
d©a
[
Ën
];

42 
d©a
[
Ën
] = 0;

43 !
hdr_Ën
 && (
‹mp
 = 
	`¡rchr
Ñemp, '\n')è!ğ
NULL
) {

44 
‹mp
++;

45 ià(*
‹mp
 == '\n')

46 
hdr_Ën
 = 
‹mp
 - 
d©a
 + 1;

47 ià(
Ën
 > 0 && *
‹mp
 == '\r' && *(temp + 1) == '\n')

48 
hdr_Ën
 = 
‹mp
 - 
d©a
 + 2;

50 
d©a
[
Ën
] = 
ch
;

53 ià(
hdr_Ën
)

54 
d©a
[
hdr_Ën
-1] = 0;

56  
hdr_Ën
;

57 
	}
}

60 
	$is_h‰p_»que¡
(* 
d©a
, 
Ën
)

62 ià(
Ën
 >ğ(
HTTP_GET
)-1 &&

63 !
	`¡ºcmp
(
d©a
, 
HTTP_GET
, (HTTP_GET)-1))

64  
GET
;

66 ià(
Ën
 >ğ(
HTTP_POST
)-1 &&

67 !
	`¡ºcmp
(
d©a
, 
HTTP_POST
, (HTTP_POST)-1))

68  
POST
;

71 
	}
}

74 
	$is_h‰p_»¥Ú£
(* 
d©a
, 
Ën
)

76 ià(
Ën
 < ((
HTTP_STR
)-1))

79 ià(!
	`¡ºcmp
(
d©a
, 
HTTP_STR
, (HTTP_STR)-1))

83 
	}
}

86 
	$h‰p_h—d”_¡r_v®
(cÚ¡ * 
buf
, cÚ¡ *
key
, cÚ¡ 
keyËn
,

87 * 
v®ue
, 
v®ue_Ën
)

89 *
‹mp
 = 
	`Äe_¡rÿ£¡r
(
buf
, 
key
);

90 
i
 = 0;

92 ià(
‹mp
 =ğ
NULL
) {

93 *
v®ue
 = 0;

94  
NULL
;

98 
‹mp
 +ğ
keyËn
;

99 *
‹mp
 && 
	`SPACE_OR_TAB
(*temp))

100 
‹mp
++;

103 ià(*
‹mp
 =ğ'\0' || 
	`CR_OR_NEWLINE
(*temp)) {

104 *
v®ue
 = 0;

105  
NULL
;

109 ià(
‹mp
) {

110 *
‹mp
 && !
	`CR_OR_NEWLINE
(*‹mpè&& 
i
 < 
v®ue_Ën
-1)

111 
v®ue
[
i
++] = *
‹mp
++;

112 
v®ue
[
i
] = 0;

115 ià(
i
 == 0) {

116 *
v®ue
 = 0;

117  
NULL
;

120  
v®ue
;

121 
	}
}

124 
	$h‰p_h—d”_lÚg_v®
(cÚ¡ * 
»¥Ú£
, cÚ¡ * 
key
, 
key_Ën
)

126 
	#C_TYPE_LEN
 50

	)

127 
Ën
;

128 
v®ue
[
C_TYPE_LEN
];

129 *
‹mp
 = 
	`h‰p_h—d”_¡r_v®
(
»¥Ú£
, 
key
, 
key_Ën
, 
v®ue
, 
C_TYPE_LEN
);

131 ià(
‹mp
 =ğ
NULL
)

134 
Ën
 = 
	`¡¹Ş
(
‹mp
, 
NULL
, 10);

135 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

138  
Ën
;

139 
	}
}

142 
	$h‰p_·r£_fœ¡_»¥_lše
(cÚ¡ * 
d©a
, 
Ën
, * 
scode
, * 
v”
)

144 cÚ¡ *
p
 = 
d©a
;

147 ià(
	`¡ºcmp
(
p
, 
HTTP_STR
, (HTTP_STR)-1) != 0)

151 
p
 +ğ(
HTTP_STR
);

152 ià(
	`¡ºcmp
(
p
, "1.1", 3) == 0)

153 *
v”
 = 
HTTP_11
;

154 ià(
	`¡ºcmp
(
p
, "1.0", 3) == 0)

155 *
v”
 = 
HTTP_10
;

157 *
v”
 = 
HTTP_09
;

160 
p
 += ("1.1");

161 *
scode
 = 
	`¡¹Ş
(
p
, 
NULL
, 10);

162 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

165 
	}
}

167 
time_t


168 
	$h‰p_h—d”_d©e
(cÚ¡ * 
d©a
, cÚ¡ * 
f›ld
, 
Ën
)

170 
buf
[256];

172 ià(!
	`h‰p_h—d”_¡r_v®
(
d©a
, 
f›ld
, 
Ën
, 
buf
, (buf)))

173  (
time_t
)-1;

174  
	`h‰pd©e_to_tim‘
(
buf
);

175 
	}
}

178 
	$h‰p_check_h—d”_f›ld
(cÚ¡ * 
d©a
, cÚ¡ * 
f›ld
)

180 ià(
	`Äe_¡rÿ£¡r
(
d©a
, 
f›ld
))

183 
	}
}

186 
	$h‰p_g‘_h‰p_v”siÚ_»¥
(* 
d©a
, 
Ën
, * 
v®ue
, 
v®ue_Ën
)

189 * 
‹mp
 = 
d©a
;

190 
i
 = 0;

192 ià(
Ën
 < ((
HTTP_STR
)-1)) {

193 *
v®ue
 = 0;

194  
NULL
;

197 ià(
	`¡ºcmp
(
d©a
, 
HTTP_STR
, (HTTP_STR)-1)) {

198 *
v®ue
 = 0;

199  
NULL
;

202 *
‹mp
 && !
	`SPACE_OR_TAB
(*‹mpè&& 
i
 < 
v®ue_Ën
 - 1)

203 
v®ue
[
i
++] = *
‹mp
++;

204 
v®ue
[
i
] = 0;

206  
v®ue
;

207 
	}
}

210 
	$h‰p_g‘_u¾
(* 
d©a
, 
d©a_Ën
, * 
v®ue
, 
v®ue_Ën
)

212 *
»t
 = 
d©a
;

213 *
‹mp
;

214 
i
 = 0;

216 ià(
	`¡ºcmp
(
d©a
, 
HTTP_GET
, (HTTP_GET)-1)) {

217 *
v®ue
 = 0;

218  
NULL
;

221 
»t
 +ğ(
HTTP_GET
);

222 *
»t
 && 
	`SPACE_OR_TAB
(*ret))

223 
»t
++;

225 
‹mp
 = 
»t
;

226 *
‹mp
 && *‹m°!ğ' ' && 
i
 < 
v®ue_Ën
 - 1) {

227 
v®ue
[
i
++] = *
‹mp
++;

229 
v®ue
[
i
] = 0;

231  
»t
;

232 
	}
}

235 
	$h‰p_g‘_¡©us_code
(* 
»¥Ú£
)

237 
code
 = 0;

238 * 
‹mp
 = 
»¥Ú£
;

240 *
‹mp
 && !
	`SPACE_OR_TAB
(*temp++));

242 
code
 = 
	`¡¹Ş
(
‹mp
, 
NULL
, 10);

243 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

246  
code
;

247 
	}
}

250 
	$h‰p_g‘_maxage
(*
ÿche_ùl
, 
Ën
)

252 
	#MAXAGE
 "max-age="

	)

253 
	#SMAXAGE
 "s-maxage="

	)

255 if(!*
ÿche_ùl
)

258 * 
‹mp
 = 
NULL
;

260 
‹mp
 = 
	`Äe_¡rÿ£¡r
(
ÿche_ùl
, 
MAXAGE
);

261 ià(
‹mp
) {

262 
Ën
 = 
	`¡¹Ş
(
‹mp
+(
MAXAGE
), 
NULL
, 10);

263 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

265  
Ën
;

268 
‹mp
 = 
	`Äe_¡rÿ£¡r
(
ÿche_ùl
, 
SMAXAGE
);

269 if(
‹mp
) {

270 
Ën
 = 
	`¡¹Ş
(
‹mp
+(
SMAXAGE
), 
NULL
, 10);

271 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
)

273  
Ën
;

276 
	}
}

	@testing/epserver/http_parsing.h

2 #iâdeà
__NRE_HTTP_PARSING


3 
	#__NRE_HTTP_PARSING


	)

5 
	#HTTP_STR
 "HTTP"

	)

6 
	#HTTPV0_STR
 "HTTP/1.0"

	)

7 
	#HTTPV1_STR
 "HTTP/1.1"

	)

8 
	#HTTP_GET
 "GET"

	)

9 
	#HTTP_POST
 "POST"

	)

10 
	#HTTP_CLOSE
 "Clo£"

	)

11 
	#HTTP_KEEP_ALIVE
 "K“p-Alive"

	)

12 
	#HOST_HDR
 "\nHo¡:"

	)

13 
	#CONTENT_LENGTH_HDR
 "\nCÚ‹Á-L’gth:"

	)

14 
	#CONTENT_TYPE_HDR
 "\nCÚ‹Á-Ty³:"

	)

15 
	#CACHE_CONTROL_HDR
 "\nCache-CÚŒŞ:"

	)

16 
	#CONNECTION_HDR
 "\nCÚÃùiÚ:"

	)

17 
	#DATE_HDR
 "\nD©e:"

	)

18 
	#EXPIRES_HDR
 "\nExpœes:"

	)

19 
	#AGE_HDR
 "\nAge:"

	)

20 
	#LAST_MODIFIED_HDR
 "\nLa¡-Modif›d:"

	)

21 
	#IF_MODIFIED_SINCE_HDR
 "\nIf-Modif›d_Sšû:"

	)

22 
	#PRAGMA_HDR
 "\nP¿gma:"

	)

23 
	#RANGE_HDR
 "\nRªge:"

	)

24 
	#IF_RANGE_HDR
 "\nIf-Rªge:"

	)

25 
	#ETAG_HDR
 "\nETag:"

	)

28 
	mGET
 = 1,

29 
	mPOST


32 
fšd_h‰p_h—d”
(*
d©a
, 
Ën
);

33 
is_h‰p_»¥Ú£
(*
d©a
, 
Ën
);

34 
is_h‰p_»que¡
(*
d©a
, 
Ën
);

36 * 
h‰p_h—d”_¡r_v®
(cÚ¡ * 
buf
, cÚ¡ *
key
, cÚ¡ 
key_Ën
, * 
v®ue
, 
v®ue_Ën
);

37 
h‰p_h—d”_lÚg_v®
(cÚ¡ * 
buf
, cÚ¡ *
key
, 
key_Ën
);

39 * 
h‰p_g‘_h‰p_v”siÚ_»¥
(* 
d©a
, 
Ën
, * 
v®ue
, 
v®ue_Ën
);

40 * 
h‰p_g‘_u¾
(* 
d©a
, 
d©a_Ën
, * 
v®ue
, 
v®ue_Ën
);

41 
h‰p_g‘_¡©us_code
(*
»¥Ú£
);

42 
h‰p_g‘_maxage
(*
ÿche_ùl
, 
Ën
);

44 
time_t
 
h‰p_h—d”_d©e
(cÚ¡ * 
d©a
, cÚ¡ * 
f›ld
, 
Ën
);

46 ’um {
	mHTTP_09
, 
	mHTTP_10
, 
	mHTTP_11
};

47 
h‰p_·r£_fœ¡_»¥_lše
(cÚ¡ * 
d©a
, 
Ën
, * 
scode
, * 
v”
);

48 
h‰p_check_h—d”_f›ld
(cÚ¡ * 
d©a
, cÚ¡ * 
f›ld
);

	@testing/epserver/tdate_parse.cpp

31 
	~<sys/ty³s.h
>

33 
	~<ùy³.h
>

34 #ifdeà
HAVE_MEMORY_H


35 
	~<memÜy.h
>

37 
	~<¡dio.h
>

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

42 
	~"td©e_·r£.h
"

45 
	s¡¾Úg
 {

46 * 
	ms
;

47 
	ml
;

52 
	$pound_ÿ£
Ğ* 
¡r
 )

54  ; *
¡r
 != '\0'; ++str )

56 iàĞ
	`isuµ”
Ğ*
¡r
 ) )

57 *
¡r
 = 
	`tŞow”
( *str );

59 
	}
}

62 
	$¡¾Úg_com·»
Ğ*
v1
, *
v2
 )

64  
	`¡rcmp
Ğ((
¡¾Úg
*è
v1
)->
s
, ((¡¾Úg*è
v2
)->s );

65 
	}
}

69 
	$¡¾Úg_£¬ch
Ğ* 
¡r
, 
¡¾Úg
* 
b
, 
n
, * 
lP
 )

71 
i
, 
h
, 
l
, 
r
;

73 
l
 = 0;

74 
h
 = 
n
 - 1;

77 
i
 = ( 
h
 + 
l
 ) / 2;

78 
r
 = 
	`¡rcmp
Ğ
¡r
, 
b
[
i
].
s
 );

79 iàĞ
r
 < 0 )

80 
h
 = 
i
 - 1;

81 iàĞ
r
 > 0 )

82 
l
 = 
i
 + 1;

85 *
lP
 = 
b
[
i
].
l
;

88 iàĞ
h
 < 
l
 )

91 
	}
}

95 
	$sÿn_wday
Ğ* 
¡r_wday
, * 
tm_wdayP
 )

97 
¡¾Úg
 
wday_b
[] = {

106 
sÜ‹d
 = 0;

108 iàĞ! 
sÜ‹d
 )

110 (è
	`qsÜt
(

111 
wday_b
, (wday_b)/(
¡¾Úg
),

112 (
¡¾Úg
), 
¡¾Úg_com·»
 );

113 
sÜ‹d
 = 1;

115 
	`pound_ÿ£
Ğ
¡r_wday
 );

116  
	`¡¾Úg_£¬ch
(

117 
¡r_wday
, 
wday_b
, (wday_b)/(
¡¾Úg
), 
tm_wdayP
 );

118 
	}
}

122 
	$sÿn_mÚ
Ğ* 
¡r_mÚ
, * 
tm_mÚP
 )

124 
¡¾Úg
 
mÚ_b
[] = {

138 
sÜ‹d
 = 0;

140 iàĞ! 
sÜ‹d
 )

142 (è
	`qsÜt
(

143 
mÚ_b
, (mÚ_b)/(
¡¾Úg
),

144 (
¡¾Úg
), 
¡¾Úg_com·»
 );

145 
sÜ‹d
 = 1;

147 
	`pound_ÿ£
Ğ
¡r_mÚ
 );

148  
	`¡¾Úg_£¬ch
(

149 
¡r_mÚ
, 
mÚ_b
, (mÚ_b)/(
¡¾Úg
), 
tm_mÚP
 );

150 
	}
}

154 
	$is_Ë­
Ğ
y—r
 )

156  
y—r
 % 400? ( year % 100 ? ( year % 4 ? 0 : 1 ) : 0 ) : 1;

157 
	}
}

161 
time_t


162 
	$tm_to_time
Ğ
tm
* 
tmP
 )

164 
time_t
 
t
;

165 
mÚthb
[12] = {

169 
t
 = ( 
tmP
->
tm_y—r
 - 70 ) * 365;

171 
t
 +ğĞ
tmP
->
tm_y—r
 - 1 - 68 ) / 4;

174 ià(
tmP
->
tm_y—r
 > 200)

175 
t
 -ğ(
tmP
->
tm_y—r
 - 1 - 100) / 100;

176 ià(
tmP
->
tm_y—r
 > 500)

177 
t
 +ğ(
tmP
->
tm_y—r
 - 1 - 100) / 400;

180 
t
 +ğ
mÚthb
[
tmP
->
tm_mÚ
];

182 iàĞ
tmP
->
tm_mÚ
 >ğ2 && 
	`is_Ë­
ĞtmP->
tm_y—r
 ) )

183 ++
t
;

185 
t
 +ğ
tmP
->
tm_mday
 - 1;

187 
t
 = * 24 + 
tmP
->
tm_hour
;

188 
t
 = * 60 + 
tmP
->
tm_mš
;

189 
t
 = * 60 + 
tmP
->
tm_£c
;

191  
t
;

192 
	}
}

195 
time_t


196 
	$h‰pd©e_to_tim‘
ĞcÚ¡ * 
¡r
 )

198 
tm
m;

199 cÚ¡ * 
ı
;

200 
¡r_mÚ
[500], 
¡r_wday
[500];

201 
tm_£c
, 
tm_mš
, 
tm_hour
, 
tm_mday
, 
tm_y—r
;

202 
tm_mÚ
, 
tm_wday
;

203 
time_t
 
t
;

206 
	`mem£t
Ğ(*è&
tm
, 0, (tm) );

209  
ı
 = 
¡r
; *cp == ' ' || *cp == '\t'; ++cp )

218 iàĞ
	`ssÿnf
Ğ
ı
, "%d-%[a-zA-Z]-%d %d:%d:%d GMT",

219 &
tm_mday
, 
¡r_mÚ
, &
tm_y—r
, &
tm_hour
, &
tm_mš
,

220 &
tm_£c
 ) == 6 &&

221 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

223 
tm
.
tm_mday
 =m_mday;

224 
tm
.
tm_mÚ
 =m_mon;

225 
tm
.
tm_y—r
 =m_year;

226 
tm
.
tm_hour
 =m_hour;

227 
tm
.
tm_mš
 =m_min;

228 
tm
.
tm_£c
 =m_sec;

232 iàĞ
	`ssÿnf
Ğ
ı
, "%d %[a-zA-Z] %d %d:%d:%d GMT",

233 &
tm_mday
, 
¡r_mÚ
, &
tm_y—r
, &
tm_hour
, &
tm_mš
,

234 &
tm_£c
) == 6 &&

235 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

237 
tm
.
tm_mday
 =m_mday;

238 
tm
.
tm_mÚ
 =m_mon;

239 
tm
.
tm_y—r
 =m_year;

240 
tm
.
tm_hour
 =m_hour;

241 
tm
.
tm_mš
 =m_min;

242 
tm
.
tm_£c
 =m_sec;

246 iàĞ
	`ssÿnf
Ğ
ı
, "%d:%d:%d GMT %d-%[a-zA-Z]-%d",

247 &
tm_hour
, &
tm_mš
, &
tm_£c
, &
tm_mday
, 
¡r_mÚ
,

248 &
tm_y—r
 ) == 6 &&

249 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

251 
tm
.
tm_hour
 =m_hour;

252 
tm
.
tm_mš
 =m_min;

253 
tm
.
tm_£c
 =m_sec;

254 
tm
.
tm_mday
 =m_mday;

255 
tm
.
tm_mÚ
 =m_mon;

256 
tm
.
tm_y—r
 =m_year;

260 iàĞ
	`ssÿnf
Ğ
ı
, "%d:%d:%d GMT %d %[a-zA-Z] %d",

261 &
tm_hour
, &
tm_mš
, &
tm_£c
, &
tm_mday
, 
¡r_mÚ
,

262 &
tm_y—r
 ) == 6 &&

263 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

265 
tm
.
tm_hour
 =m_hour;

266 
tm
.
tm_mš
 =m_min;

267 
tm
.
tm_£c
 =m_sec;

268 
tm
.
tm_mday
 =m_mday;

269 
tm
.
tm_mÚ
 =m_mon;

270 
tm
.
tm_y—r
 =m_year;

274 iàĞ
	`ssÿnf
Ğ
ı
, "%[a-zA-Z], %d-%[a-zA-Z]-%d %d:%d:%d GMT",

275 
¡r_wday
, &
tm_mday
, 
¡r_mÚ
, &
tm_y—r
, &
tm_hour
, &
tm_mš
,

276 &
tm_£c
 ) == 7 &&

277 
	`sÿn_wday
Ğ
¡r_wday
, &
tm_wday
 ) &&

278 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

280 
tm
.
tm_wday
 =m_wday;

281 
tm
.
tm_mday
 =m_mday;

282 
tm
.
tm_mÚ
 =m_mon;

283 
tm
.
tm_y—r
 =m_year;

284 
tm
.
tm_hour
 =m_hour;

285 
tm
.
tm_mš
 =m_min;

286 
tm
.
tm_£c
 =m_sec;

290 iàĞ
	`ssÿnf
Ğ
ı
, "%[a-zA-Z], %d %[a-zA-Z] %d %d:%d:%d GMT",

291 
¡r_wday
, &
tm_mday
, 
¡r_mÚ
, &
tm_y—r
, &
tm_hour
, &
tm_mš
,

292 &
tm_£c
 ) == 7 &&

293 
	`sÿn_wday
Ğ
¡r_wday
, &
tm_wday
 ) &&

294 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

296 
tm
.
tm_wday
 =m_wday;

297 
tm
.
tm_mday
 =m_mday;

298 
tm
.
tm_mÚ
 =m_mon;

299 
tm
.
tm_y—r
 =m_year;

300 
tm
.
tm_hour
 =m_hour;

301 
tm
.
tm_mš
 =m_min;

302 
tm
.
tm_£c
 =m_sec;

306 iàĞ
	`ssÿnf
Ğ
ı
, "%[a-zA-Z] %[a-zA-Z] %d %d:%d:%d GMT %d",

307 
¡r_wday
, 
¡r_mÚ
, &
tm_mday
, &
tm_hour
, &
tm_mš
, &
tm_£c
,

308 &
tm_y—r
 ) == 7 &&

309 
	`sÿn_wday
Ğ
¡r_wday
, &
tm_wday
 ) &&

310 
	`sÿn_mÚ
Ğ
¡r_mÚ
, &
tm_mÚ
 ) )

312 
tm
.
tm_wday
 =m_wday;

313 
tm
.
tm_mÚ
 =m_mon;

314 
tm
.
tm_mday
 =m_mday;

315 
tm
.
tm_hour
 =m_hour;

316 
tm
.
tm_mš
 =m_min;

317 
tm
.
tm_£c
 =m_sec;

318 
tm
.
tm_y—r
 =m_year;

321  (
time_t
) -1;

323 iàĞ
tm
.
tm_y—r
 > 1900 )

324 
tm
.
tm_y—r
 -= 1900;

325 iàĞ
tm
.
tm_y—r
 < 70 )

326 
tm
.
tm_y—r
 += 100;

328 
t
 = 
	`tm_to_time
Ğ&
tm
 );

330  
t
;

331 
	}
}

346 
	$tim‘_to_h‰pd©e
(
time_t
 
t
, * 
¡r
, 
¡¾’
 )

348 cÚ¡ * 
day_of_w“k
[] = {"Sun", "Mon","Tue",

351 cÚ¡ * 
mÚths
[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun",

353 
tm
 
gm
;

355 ià(
	`gmtime_r
(&
t
, &
gm
è=ğ
NULL
)

359 ià(
	`¢´štf
(
¡r
, 
¡¾’
,

361 
day_of_w“k
[
gm
.
tm_wday
],

362 
gm
.
tm_mday
,

363 
mÚths
[
gm
.
tm_mÚ
],

364 
gm
.
tm_y—r
 + 1900,

365 
gm
.
tm_hour
,

366 
gm
.
tm_mš
,

367 
gm
.
tm_£c
è=ğ
¡¾’
)

371 
	}
}

	@testing/epserver/tdate_parse.h

27 #iâdeà
_TDATE_PARSE_H_


28 
	#_TDATE_PARSE_H_


	)

32 #ifdeà
__ılu¥lus


35 
time_t
 
h‰pd©e_to_tim‘
ĞcÚ¡ * 
¡r
 );

50 
tim‘_to_h‰pd©e
(
time_t
 
t
, * 
¡r
, 
¡¾’
);

52 #ifdeà
__ılu¥lus


	@testing/epserver/www_home/epserver.c

1 
	#_LARGEFILE64_SOURCE


	)

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<¡dšt.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

12 
	~<dœ’t.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

15 
	~<±h»ad.h
>

16 
	~<sigÇl.h
>

18 
	~<mtı_­i.h
>

19 
	~<mtı_•Şl.h
>

21 
	~"ıu.h
"

22 
	~"h‰p_·rsšg.h
"

23 
	~"debug.h
"

25 
	#MAX_FLOW_NUM
 (10000)

	)

27 
	#RCVBUF_SIZE
 (2*1024)

	)

28 
	#SNDBUF_SIZE
 (8*1024)

	)

30 
	#MAX_EVENTS
 (
MAX_FLOW_NUM
 * 3)

	)

32 
	#HTTP_HEADER_LEN
 1024

	)

33 
	#URL_LEN
 128

	)

35 
	#MAX_CPUS
 16

	)

36 
	#MAX_FILES
 30

	)

38 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

39 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

41 #iâdeà
TRUE


42 
	#TRUE
 (1)

	)

45 #iâdeà
FALSE


46 
	#FALSE
 (0)

	)

49 #iâdeà
ERROR


50 
	#ERROR
 (-1)

	)

53 
	#HT_SUPPORT
 
FALSE


	)

56 
	sfe_ÿche


58 
	mÇme
[128];

59 
	mfuÎÇme
[256];

60 
ušt64_t
 
	msize
;

61 *
	mfe
;

64 
	s£rv”_v¬s


66 
	m»que¡
[
HTTP_HEADER_LEN
];

67 
	m»cv_Ën
;

68 
	m»que¡_Ën
;

69 
	mtÙ®_»ad
, 
	mtÙ®_£Á
;

70 
ušt8_t
 
	mdÚe
;

71 
ušt8_t
 
	mr¥h—d”_£Á
;

72 
ušt8_t
 
	mk“p_®ive
;

74 
	mfidx
;

75 
	mâame
[128];

76 
	mfsize
;

79 
	sth»ad_cÚ‹xt


81 
mùx_t
 
	mmùx
;

82 
	m•
;

83 
£rv”_v¬s
 *
	msv¬s
;

86 
	gnum_cÜes
;

87 
	gcÜe_lim™
;

88 
±h»ad_t
 
	g­p_th»ad
[
MAX_CPUS
];

89 
	gdÚe
[
MAX_CPUS
];

90 *
	gcÚf_fe
 = 
NULL
;

92 cÚ¡ *
	gwww_maš
;

93 
fe_ÿche
 
	gfÿche
[
MAX_FILES
];

94 
	gnfes
;

96 
	gfšished
;

99 
	$StusCodeToSŒšg
(
scode
)

101 
scode
) {

111  
NULL
;

112 
	}
}

115 
	$CËªS”v”V¬ŸbË
(
£rv”_v¬s
 *
sv
)

117 
sv
->
»cv_Ën
 = 0;

118 
sv
->
»que¡_Ën
 = 0;

119 
sv
->
tÙ®_»ad
 = 0;

120 
sv
->
tÙ®_£Á
 = 0;

121 
sv
->
dÚe
 = 0;

122 
sv
->
r¥h—d”_£Á
 = 0;

123 
sv
->
k“p_®ive
 = 0;

124 
	}
}

127 
	$Clo£CÚÃùiÚ
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

129 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_DEL
, 
sockid
, 
NULL
);

130 
	`mtı_şo£
(
ùx
->
mùx
, 
sockid
);

131 
	}
}

134 
	$S’dUÁAvaabË
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

136 
»t
;

137 
£Á
;

138 
Ën
;

140 ià(
sv
->
dÚe
 || !sv->
r¥h—d”_£Á
) {

144 
£Á
 = 0;

145 
»t
 = 1;

146 
»t
 > 0) {

147 
Ën
 = 
	`MIN
(
SNDBUF_SIZE
, 
sv
->
fsize
 - sv->
tÙ®_£Á
);

148 ià(
Ën
 <= 0) {

151 
»t
 = 
	`mtı_wr™e
(
ùx
->
mùx
, 
sockid
,

152 
fÿche
[
sv
->
fidx
].
fe
 + sv->
tÙ®_£Á
, 
Ën
);

153 ià(
»t
 < 0) {

154 
	`TRACE_APP
("Connection closed with client.\n");

157 
	`TRACE_APP
("Sock‘ %d: mtı_wr™Œy: %d,„‘: %d\n", 
sockid
, 
Ën
, 
»t
);

158 
£Á
 +ğ
»t
;

159 
sv
->
tÙ®_£Á
 +ğ
»t
;

162 ià(
sv
->
tÙ®_£Á
 >ğ
fÿche
[sv->
fidx
].
size
) {

163 
mtı_•Şl_ev’t
 
ev
;

164 
sv
->
dÚe
 = 
TRUE
;

165 
fšished
++;

167 ià(
sv
->
k“p_®ive
) {

169 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

170 
ev
.
d©a
.
sockid
 = sockid;

171 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_MOD
, 
sockid
, &
ev
);

173 
	`CËªS”v”V¬ŸbË
(
sv
);

176 
	`Clo£CÚÃùiÚ
(
ùx
, 
sockid
, 
sv
);

180  
£Á
;

181 
	}
}

184 
	$HªdËR—dEv’t
(
th»ad_cÚ‹xt
 *
ùx
, 
sockid
, 
£rv”_v¬s
 *
sv
)

186 
mtı_•Şl_ev’t
 
ev
;

187 
buf
[
HTTP_HEADER_LEN
];

188 
u¾
[
URL_LEN
];

189 
»¥Ú£
[
HTTP_HEADER_LEN
];

190 
scode
;

191 
time_t
 
t_now
;

192 
t_¡r
[128];

193 
k“·live_¡r
[128];

194 
rd
;

195 
i
;

196 
Ën
;

197 
£Á
;

200 
rd
 = 
	`mtı_»ad
(
ùx
->
mùx
, 
sockid
, 
buf
, 
HTTP_HEADER_LEN
);

201 ià(
rd
 <= 0) {

202  
rd
;

204 
	`memıy
(
sv
->
»que¡
 + sv->
»cv_Ën
,

205 (*)
buf
, 
	`MIN
(
rd
, 
HTTP_HEADER_LEN
 - 
sv
->
»cv_Ën
));

206 
sv
->
»cv_Ën
 +ğ
rd
;

209 
sv
->
»que¡_Ën
 = 
	`fšd_h‰p_h—d”
(sv->
»que¡
, sv->
»cv_Ën
);

210 ià(
sv
->
»que¡_Ën
 <= 0) {

211 
	`TRACE_ERROR
("Socket %d: Failedo…arse HTTP„equest header.\n"

214 
sockid
, 
rd
, 
sv
->
»cv_Ën
,

215 
sv
->
»que¡_Ën
, 
	`¡¾’
(sv->
»que¡
), sv->request);

216  
rd
;

219 
	`h‰p_g‘_u¾
(
sv
->
»que¡
, sv->
»que¡_Ën
, 
u¾
, 
URL_LEN
);

220 
	`TRACE_APP
("Sock‘ %d URL: %s\n", 
sockid
, 
u¾
);

221 
	`¥rštf
(
sv
->
âame
, "%s%s", 
www_maš
, 
u¾
);

222 
	`TRACE_APP
("Sock‘ %d FÇme: %s\n", 
sockid
, 
sv
->
âame
);

224 
sv
->
k“p_®ive
 = 
FALSE
;

225 ià(
	`h‰p_h—d”_¡r_v®
(
sv
->
»que¡
, "Connection: ",

226 
	`¡¾’
("CÚÃùiÚ: "), 
k“·live_¡r
, 128)) {

227 ià(
	`¡r¡r
(
k“·live_¡r
, "Keep-Alive")) {

228 
sv
->
k“p_®ive
 = 
TRUE
;

229 } ià(
	`¡r¡r
(
k“·live_¡r
, "Close")) {

230 
sv
->
k“p_®ive
 = 
FALSE
;

235 
scode
 = 404;

236 
i
 = 0; i < 
nfes
; i++) {

237 ià(
	`¡rcmp
(
sv
->
âame
, 
fÿche
[
i
].
fuÎÇme
) == 0) {

238 
sv
->
fsize
 = 
fÿche
[
i
].
size
;

239 
sv
->
fidx
 = 
i
;

240 
scode
 = 200;

244 
	`TRACE_APP
("Socket %d File size: %ld (%ldMB)\n",

245 
sockid
, 
sv
->
fsize
, sv->fsize / 1024 / 1024);

248 
	`time
(&
t_now
);

249 
	`¡ráime
(
t_¡r
, 128, "%a, %d %b %Y %X GMT", 
	`gmtime
(&
t_now
));

250 ià(
sv
->
k“p_®ive
)

251 
	`¥rštf
(
k“·live_¡r
, "Keep-Alive");

253 
	`¥rštf
(
k“·live_¡r
, "Close");

255 
	`¥rštf
(
»¥Ú£
, "HTTP/1.1 %d %s\r\n"

260 
scode
, 
	`StusCodeToSŒšg
(scode), 
t_¡r
, 
sv
->
fsize
, 
k“·live_¡r
);

261 
Ën
 = 
	`¡¾’
(
»¥Ú£
);

262 
	`TRACE_APP
("Sock‘ %d HTTP Re¥Ú£: \n%s", 
sockid
, 
»¥Ú£
);

263 
£Á
 = 
	`mtı_wr™e
(
ùx
->
mùx
, 
sockid
, 
»¥Ú£
, 
Ën
);

264 
	`TRACE_APP
("Socket %d Sent„esponse header:ry: %d, sent: %d\n",

265 
sockid
, 
Ën
, 
£Á
);

266 
	`as£¹
(
£Á
 =ğ
Ën
);

267 
sv
->
r¥h—d”_£Á
 = 
TRUE
;

269 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
 | 
MTCP_EPOLLOUT
;

270 
ev
.
d©a
.
sockid
 = sockid;

271 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_MOD
, 
sockid
, &
ev
);

273 
	`S’dUÁAvaabË
(
ùx
, 
sockid
, 
sv
);

275  
rd
;

276 
	}
}

279 
	$Acû±CÚÃùiÚ
(
th»ad_cÚ‹xt
 *
ùx
, 
li¡’”
)

281 
mùx_t
 
mùx
 = 
ùx
->mctx;

282 
£rv”_v¬s
 *
sv
;

283 
mtı_•Şl_ev’t
 
ev
;

284 
c
;

286 
c
 = 
	`mtı_acû±
(
mùx
, 
li¡’”
, 
NULL
, NULL);

288 ià(
c
 >= 0) {

289 ià(
c
 >ğ
MAX_FLOW_NUM
) {

290 
	`TRACE_ERROR
("Inv®id sock‘ id %d.\n", 
c
);

294 
sv
 = &
ùx
->
sv¬s
[
c
];

295 
	`CËªS”v”V¬ŸbË
(
sv
);

296 
	`TRACE_APP
("New cÚÃùiÚ %d‡cû±ed.\n", 
c
);

297 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

298 
ev
.
d©a
.
sockid
 = 
c
;

299 
	`mtı_£tsock_nÚblock
(
ùx
->
mùx
, 
c
);

300 
	`mtı_•Şl_ùl
(
mùx
, 
ùx
->
•
, 
MTCP_EPOLL_CTL_ADD
, 
c
, &
ev
);

301 
	`TRACE_APP
("Sock‘ %d„egi¡”ed.\n", 
c
);

304 ià(
”ºo
 !ğ
EAGAIN
) {

305 
	`TRACE_ERROR
("mtcp_accept()ƒrror %s\n",

306 
	`¡»¼Ü
(
”ºo
));

310  
c
;

311 
	}
}

313 
th»ad_cÚ‹xt
 *

314 
	$In™ŸlizeS”v”Th»ad
(
cÜe
)

316 
th»ad_cÚ‹xt
 *
ùx
;

319 #ià
HT_SUPPORT


320 
	`mtı_cÜe_affš™ize
(
cÜe
 + (
num_cÜes
 / 2));

322 
	`mtı_cÜe_affš™ize
(
cÜe
);

325 
ùx
 = (
th»ad_cÚ‹xt
 *)
	`ÿÎoc
(1, (thread_context));

326 ià(!
ùx
) {

327 
	`TRACE_ERROR
("Failedo createhread context!\n");

328  
NULL
;

332 
ùx
->
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

333 ià(!
ùx
->
mùx
) {

334 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

335  
NULL
;

339 
ùx
->
•
 = 
	`mtı_•Şl_ü—‹
(ùx->
mùx
, 
MAX_EVENTS
);

340 ià(
ùx
->
•
 < 0) {

341 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

342  
NULL
;

346 
ùx
->
sv¬s
 = (
£rv”_v¬s
 *)

347 
	`ÿÎoc
(
MAX_FLOW_NUM
, (
£rv”_v¬s
));

348 ià(!
ùx
->
sv¬s
) {

349 
	`TRACE_ERROR
("Failedo create server_vars struct!\n");

350  
NULL
;

353  
ùx
;

354 
	}
}

357 
	$C»©eLi¡’šgSock‘
(
th»ad_cÚ‹xt
 *
ùx
)

359 
li¡’”
;

360 
mtı_•Şl_ev’t
 
ev
;

361 
sockaddr_š
 
§ddr
;

362 
»t
;

365 
li¡’”
 = 
	`mtı_sock‘
(
ùx
->
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

366 ià(
li¡’”
 < 0) {

367 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

370 
»t
 = 
	`mtı_£tsock_nÚblock
(
ùx
->
mùx
, 
li¡’”
);

371 ià(
»t
 < 0) {

372 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

377 
§ddr
.
sš_çmy
 = 
AF_INET
;

378 
§ddr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

379 
§ddr
.
sš_pÜt
 = 
	`htÚs
(80);

380 
»t
 = 
	`mtı_bšd
(
ùx
->
mùx
, 
li¡’”
,

381 (
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

382 ià(
»t
 < 0) {

383 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

388 
»t
 = 
	`mtı_li¡’
(
ùx
->
mùx
, 
li¡’”
, 4096);

389 ià(
»t
 < 0) {

390 
	`TRACE_ERROR
("mtcp_listen() failed!\n");

395 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

396 
ev
.
d©a
.
sockid
 = 
li¡’”
;

397 
	`mtı_•Şl_ùl
(
ùx
->
mùx
, ctx->
•
, 
MTCP_EPOLL_CTL_ADD
, 
li¡’”
, &
ev
);

399  
li¡’”
;

400 
	}
}

403 
	$RunS”v”Th»ad
(*
¬g
)

405 
cÜe
 = *(*)
¬g
;

406 
th»ad_cÚ‹xt
 *
ùx
;

407 
mùx_t
 
mùx
;

408 
li¡’”
;

409 
•
;

410 
mtı_•Şl_ev’t
 *
ev’ts
;

411 
Ãv’ts
;

412 
i
, 
»t
;

413 
do_acû±
;

416 
ùx
 = 
	`In™ŸlizeS”v”Th»ad
(
cÜe
);

417 ià(!
ùx
) {

418 
	`TRACE_ERROR
("Failedo initialize serverhread.\n");

419  
NULL
;

421 
mùx
 = 
ùx
->mctx;

422 
•
 = 
ùx
->ep;

424 
ev’ts
 = (
mtı_•Şl_ev’t
 *)

425 
	`ÿÎoc
(
MAX_EVENTS
, (
mtı_•Şl_ev’t
));

426 ià(!
ev’ts
) {

427 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

428 
	`ex™
(-1);

431 
li¡’”
 = 
	`C»©eLi¡’šgSock‘
(
ùx
);

432 ià(
li¡’”
 < 0) {

433 
	`TRACE_ERROR
("Failedo create†istening socket.\n");

434 
	`ex™
(-1);

437 !
dÚe
[
cÜe
]) {

438 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

439 ià(
Ãv’ts
 < 0) {

440 ià(
”ºo
 !ğ
EINTR
)

441 
	`³¼Ü
("mtcp_epoll_wait");

445 
do_acû±
 = 
FALSE
;

446 
i
 = 0; i < 
Ãv’ts
; i++) {

448 ià(
ev’ts
[
i
].
d©a
.
sockid
 =ğ
li¡’”
) {

450 
do_acû±
 = 
TRUE
;

452 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLERR
) {

453 
”r
;

454 
sockËn_t
 
Ën
 = (
”r
);

457 
	`TRACE_APP
("[CPU %d] Error on socket %d\n",

458 
cÜe
, 
ev’ts
[
i
].
d©a
.
sockid
);

459 ià(
	`mtı_g‘sockİt
(
mùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

460 
SOL_SOCKET
, 
SO_ERROR
, (*)&
”r
, &
Ën
) == 0) {

461 ià(
”r
 !ğ
ETIMEDOUT
) {

462 
	`årštf
(
¡d”r
, "Error on socket %d: %s\n",

463 
ev’ts
[
i
].
d©a
.
sockid
, 
	`¡»¼Ü
(
”r
));

466 
	`³¼Ü
("mtcp_getsockopt");

468 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

469 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

471 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLIN
) {

472 
»t
 = 
	`HªdËR—dEv’t
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

473 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

475 ià(
»t
 == 0) {

477 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

478 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

479 } ià(
»t
 < 0) {

481 ià(
”ºo
 !ğ
EAGAIN
) {

482 
	`Clo£CÚÃùiÚ
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
,

483 &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
]);

487 } ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

488 
£rv”_v¬s
 *
sv
 = &
ùx
->
sv¬s
[
ev’ts
[
i
].
d©a
.
sockid
];

489 ià(
sv
->
r¥h—d”_£Á
) {

490 
	`S’dUÁAvaabË
(
ùx
, 
ev’ts
[
i
].
d©a
.
sockid
, 
sv
);

492 
	`TRACE_APP
("Socket %d: Response header‚ot sent yet.\n",

493 
ev’ts
[
i
].
d©a
.
sockid
);

497 
	`as£¹
(0);

502 ià(
do_acû±
) {

504 
»t
 = 
	`Acû±CÚÃùiÚ
(
ùx
, 
li¡’”
);

505 ià(
»t
 < 0)

513 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

514 
	`±h»ad_ex™
(
NULL
);

516  
NULL
;

517 
	}
}

520 
	$SigÇlHªdËr
(
signum
)

522 
i
;

524 
i
 = 0; i < 
cÜe_lim™
; i++) {

525 ià(
­p_th»ad
[
i
] =ğ
	`±h»ad_£lf
()) {

527 
dÚe
[
i
] = 
TRUE
;

529 ià(!
dÚe
[
i
]) {

530 
	`±h»ad_kl
(
­p_th»ad
[
i
], 
signum
);

534 
	}
}

537 
	$´štH–p
(cÚ¡ *
´og_Çme
)

539 
	`TRACE_CONFIG
("%s -p <path_to_www/> -f <mtcp_conf_file> "

541 
´og_Çme
);

542 
	`ex™
(
EXIT_SUCCESS
);

543 
	}
}

546 
	$maš
(
¬gc
, **
¬gv
)

548 
DIR
 *
dœ
;

549 
dœ’t
 *
’t
;

550 
fd
;

551 
»t
;

552 
ušt64_t
 
tÙ®_»ad
;

553 
mtı_cÚf
 
mcfg
;

554 
cÜes
[
MAX_CPUS
];

555 
´oûss_ıu
;

556 
i
, 
o
;

558 
num_cÜes
 = 
	`G‘NumCPUs
();

559 
cÜe_lim™
 = 
num_cÜes
;

560 
´oûss_ıu
 = -1;

561 
dœ
 = 
NULL
;

563 ià(
¬gc
 < 2) {

564 
	`TRACE_CONFIG
("$% dœeùÜy_to_£rviû\n", 
¬gv
[0]);

565  
FALSE
;

568 -1 !ğ(
o
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "N:f:p:c:h"))) {

569 
o
) {

572 
www_maš
 = 
İrg
;

573 
dœ
 = 
	`İ’dœ
(
www_maš
);

574 ià(!
dœ
) {

575 
	`TRACE_CONFIG
("FaedØİ’ %s.\n", 
www_maš
);

576 
	`³¼Ü
("opendir");

577  
FALSE
;

581 
cÜe_lim™
 = 
	`©oi
(
İrg
);

582 ià(
cÜe_lim™
 > 
num_cÜes
) {

583 
	`TRACE_CONFIG
("CPU†imit should be smallerhanhe "

584 "numb” oàCPUs: %d\n", 
num_cÜes
);

585  
FALSE
;

592 
	`mtı_g‘cÚf
(&
mcfg
);

593 
mcfg
.
num_cÜes
 = 
cÜe_lim™
;

594 
	`mtı_£tcÚf
(&
mcfg
);

597 
cÚf_fe
 = 
İrg
;

600 
´oûss_ıu
 = 
	`©oi
(
İrg
);

601 ià(
´oûss_ıu
 > 
cÜe_lim™
) {

602 
	`TRACE_CONFIG
("Starting CPU is way off†imits!\n");

603  
FALSE
;

607 
	`´štH–p
(
¬gv
[0]);

612 ià(
dœ
 =ğ
NULL
) {

613 
	`TRACE_CONFIG
("You did‚ot…ass‡ valid www_path!\n");

614 
	`ex™
(
EXIT_FAILURE
);

617 
nfes
 = 0;

618 (
’t
 = 
	`»addœ
(
dœ
)è!ğ
NULL
) {

619 ià(
	`¡rcmp
(
’t
->
d_Çme
, ".") == 0)

621 ià(
	`¡rcmp
(
’t
->
d_Çme
, "..") == 0)

624 
	`¡rıy
(
fÿche
[
nfes
].
Çme
, 
’t
->
d_Çme
);

625 
	`¥rštf
(
fÿche
[
nfes
].
fuÎÇme
, "%s/%s", 
www_maš
, 
’t
->
d_Çme
);

626 
fd
 = 
	`İ’
(
fÿche
[
nfes
].
fuÎÇme
, 
O_RDONLY
);

627 ià(
fd
 < 0) {

628 
	`³¼Ü
("open");

631 
fÿche
[
nfes
].
size
 = 
	`l£ek64
(
fd
, 0, 
SEEK_END
);

632 
	`l£ek64
(
fd
, 0, 
SEEK_SET
);

635 
fÿche
[
nfes
].
fe
 = (*)
	`m®loc
(fÿche[nfes].
size
);

636 ià(!
fÿche
[
nfes
].
fe
) {

637 
	`TRACE_CONFIG
("Failedo‡llocate memory for file %s\n",

638 
fÿche
[
nfes
].
Çme
);

639 
	`³¼Ü
("malloc");

643 
	`TRACE_INFO
("Reading %s (%lu bytes)\n",

644 
fÿche
[
nfes
].
Çme
, fÿche[nfes].
size
);

645 
tÙ®_»ad
 = 0;

647 
»t
 = 
	`»ad
(
fd
, 
fÿche
[
nfes
].
fe
 + 
tÙ®_»ad
,

648 
fÿche
[
nfes
].
size
 - 
tÙ®_»ad
);

649 ià(
»t
 < 0) {

651 } ià(
»t
 == 0) {

654 
tÙ®_»ad
 +ğ
»t
;

656 ià(
tÙ®_»ad
 < 
fÿche
[
nfes
].
size
) {

657 
	`ä“
(
fÿche
[
nfes
].
fe
);

660 
	`şo£
(
fd
);

661 
nfes
++;

663 ià(
nfes
 >ğ
MAX_FILES
)

667 
fšished
 = 0;

670 ià(
cÚf_fe
 =ğ
NULL
) {

671 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

672 
	`ex™
(
EXIT_FAILURE
);

675 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

676 ià(
»t
) {

677 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

678 
	`ex™
(
EXIT_FAILURE
);

682 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

684 
	`TRACE_INFO
("Application initialization finished.\n");

686 
i
 = ((
´oûss_ıu
 =ğ-1è? 0 :…roûss_ıu); i < 
cÜe_lim™
; i++) {

687 
cÜes
[
i
] = i;

688 
dÚe
[
i
] = 
FALSE
;

690 ià(
	`±h»ad_ü—‹
(&
­p_th»ad
[
i
],

691 
NULL
, 
RunS”v”Th»ad
, (*)&
cÜes
[
i
])) {

692 
	`³¼Ü
("pthread_create");

693 
	`TRACE_CONFIG
("Failedo create serverhread.\n");

694 
	`ex™
(
EXIT_FAILURE
);

696 ià(
´oûss_ıu
 != -1)

700 
i
 = ((
´oûss_ıu
 =ğ-1è? 0 :…roûss_ıu); i < 
cÜe_lim™
; i++) {

701 
	`±h»ad_još
(
­p_th»ad
[
i
], 
NULL
);

703 ià(
´oûss_ıu
 != -1)

707 
	`mtı_de¡roy
();

708 
	`şo£dœ
(
dœ
);

710 
	}
}

	@testing_multi/TestMultiClient/client.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

21 
	~<¡ršgs.h
>

22 
	~<veùÜ
>

24 
	#__FAVOR_BSD


	)

27 
	~<sys/ty³s.h
>

29 
	~<Ãtš‘/š.h
>

31 
	~<Ãtš‘/.h
>

33 
	~<Ãtš‘/6.h
>

38 
	~<lšux/udp.h
>

40 
	~<Ãt/‘h”Ãt.h
>

42 
	~<¡ršg.h
>

43 
	~<Ãtš‘/.h
>

44 
	~<Ãtš‘/š.h
>

45 
	~<uni¡d.h
>

46 
	~<içddrs.h
>

47 
	~<sys/ioùl.h
>

48 
	~<sys/pŞl.h
>

49 
	~<sys/sock‘.h
>

50 
	~<sys/ty³s.h
>

51 
	~<¬·/š‘.h
>

52 
	~<Ãt/‘h”Ãt.h
>

53 
	~<Ãt/if.h
>

54 
	~<Ãtš‘/š.h
>

56 
	~<lšux/udp.h
>

57 
	~<lšux/tı.h
>

58 
	~<Ãtš‘/.h
>

59 
	~<Ãtš‘/‘h”.h
>

60 
	~"Ãtm­_­i.h
"

62 
usšg
 
Çme¥aû
 
	g¡d
;

64 
	#MSB32
 0x80000000

	)

65 
	#MSB16
 0x8000

	)

66 
	#KEY_CACHE_LEN
 96

	)

67 
	#SEED
 'B'

	)

68 
	#CLIENT_IP
 "169.254.9.18"

	)

69 
	#SERVER_IP
 "169.254.9.28"

	)

70 
	#SERVER_PORT
 9999

	)

71 
	#CLIENT_START_PORT
 5900

	)

72 
	#IMSI
 10000000

	)

73 
	#MQ_NIC
 0

	)

82 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

84 cÚ¡ 
ušt8_t
 
key
[] = {

96 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

97 (((
ušt32_t
)
key
[1]) << 16) |

98 (((
ušt32_t
)
key
[2]) << 8) |

99 ((
ušt32_t
)
key
[3]);

101 
ušt32_t
 
idx
 = 32;

102 
i
;

104 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

105 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

106 
ušt32_t
 
b™
;

108 
ÿche
[
i
] = 
»suÉ
;

109 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

111 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

113 
	}
}

119 
ušt32_t


120 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

123 
ušt32_t
 
rc
 = 0;

124 
i
;

125 
fœ¡_time
 = 1;

126 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

128 ià(
fœ¡_time
) {

129 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

130 
fœ¡_time
 = 0;

133 
i
 = 0; i < 32; i++) {

134 ià(
s
 & 
MSB32
)

135 
rc
 ^ğ
key_ÿche
[
i
];

136 
s
 <<= 1;

138 
i
 = 0; i < 32; i++) {

139 ià(
d
 & 
MSB32
)

140 
rc
 ^ğ
key_ÿche
[32+
i
];

141 
d
 <<= 1;

143 
i
 = 0; i < 16; i++) {

144 ià(
¥
 & 
MSB16
)

145 
rc
 ^ğ
key_ÿche
[64+
i
];

146 
¥
 <<= 1;

148 
i
 = 0; i < 16; i++) {

149 ià(
dp
 & 
MSB16
)

150 
rc
 ^ğ
key_ÿche
[80+
i
];

151 
dp
 <<= 1;

154  
rc
;

155 
	}
}

157 
	~"ıu.h
"

158 
	~"debug.h
"

160 
	#MAX_EVENTS
 1024

	)

161 
	#MAX_THREADS
 4

	)

163 
usšg
 
Çme¥aû
 
	g¡d
;

165 
	s¬g
{

166 
	mid
;

167 
ušt32_t
 
	mimsi
;

168 
	mcÜ’o
;

169 
	mpÜŠo
;

172 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

173 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

174 
	gdÚe
[
MAX_THREADS
];

176 *
	gho¡Çme
;

181 
	gveùÜ
 < 
	gcompu‹_¡©s
 > 
	g¡©s
;

182 
timev®
 
	gbegš_t
;

183 
timev®
 
	g’d_t
;

184 
boŞ
 
	g§ã_to_compu‹_ut
 = 
çl£
;

185 
ušt64_t
 
	gtÙ®
;

186 
	g¿‹_t
, 
	gdiff_t
;

187 
©omic_ušt
 
	g§ã_to_šc_bur¡
;

189 
	gmq_pÜts
[6][6] = {{5900}, {5900, 5902}, {5900, 5904, 5901}, {5900, 5902, 5901, 5903}, {5901, 5947, 5903, 5900, 5905}, {5900, 5910, 5901, 5902, 5904, 5903}};

193 
	$Clo£CÚÃùiÚ
(
mùx_t
 
mùx
, 
•
, 
sockid
)

195 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_DEL
, 
sockid
, 
NULL
);

196 
	`mtı_şo£
(
mùx
, 
sockid
);

197 
	}
}

199 
	$­p_Ëv–_¡©s
() {

201 
	`g‘timeofday
(&
’d_t
, 
NULL
);

202 
diff_t
 = (
’d_t
.
tv_£c
 - 
begš_t
.tv_sec) +

203 ((
’d_t
.
tv_u£c
 - 
begš_t
.tv_usec)/1000000.0);

205 
i
=0;i<
MAX_THREADS
;i++){

206 
tÙ®
+ğ
¡©s
[
i
].
fÜw¬ded
;

209 
¿‹_t
 = (
tÙ®
*8è/ (
diff_t
*1024*1024*1024);

210 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

212 
	}
}

215 
	$SigÇlHªdËr
(
signum
)

218 
Ãtm­u£
.
do_abÜt
 = 1;

219 
i
 = 0;i<
MAX_THREADS
;i++){

220 
dÚe
[
i
] = 1;

222 
	`­p_Ëv–_¡©s
();

223 
	`D
("Sig1");

224 
	`mtı_de¡roy
();

225 
	`D
("Sig2");

227 
	}
}

229 *
	$ş›ÁTh»adFunc
(* 
¬g1
){

231 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

232 
cÜe
 = 
¬gum’t
.
cÜ’o
;

233 
id
 = 
¬gum’t
.id;

234 
imsi
 = 
¬gum’t
.imsi;

235 
pÜŠo
 = 
¬gum’t
.portno;

237 
	`mtı_cÜe_affš™ize
(
cÜe
);

238 
	`D
("CÜ’Øğ%d, PÜˆnØğ%d", 
cÜe
, 
pÜŠo
);

242 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

243 ià(!
mùx
) {

244 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

245  
NULL
;

248 
	`¦“p
(10);

250 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

251 ià(
•
 < 0) {

252 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

253  
NULL
;

257 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

258 ià(
sockid
 < 0) {

259 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

262 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

263 ià(
»t
 < 0) {

264 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

268 
sockaddr_š
 
§ddr
;

270 
§ddr
.
sš_çmy
 = 
AF_INET
;

271 
	`š‘_©Ú
("169.254.9.18",&
§ddr
.
sš_addr
);

273 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

275 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

276 ià(
»t
 < 0) {

277 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

281 
sockaddr_š
 
daddr
;

283 
daddr
.
sš_çmy
 = 
AF_INET
;

284 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

285 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

286 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

287 ià(
»t
 < 0) {

288 ià(
”ºo
 !ğ
EINPROGRESS
) {

289 
	`³¼Ü
("mtcp_connect");

290 
	`mtı_şo£
(
mùx
, 
sockid
);

299 
mtı_•Şl_ev’t
 
ev
;

300 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

301 
ev
.
d©a
.
sockid
 = sockid;

302 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

305 
mtı_•Şl_ev’t
 *
ev’ts
;

306 
Ãv’ts
;

307 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

308 ià(!
ev’ts
) {

309 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

310 
	`ex™
(-1);

312 
Ãwsockfd
 = -1;

313 
bur¡_šü—£d
 = 0;

315 
d©a
[
DATA_LEN
] = "netmap…kt-gen DIRECT…ayload\n"

359 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, 
d©a
, 
DATA_LEN
);

361 ià(
»t
 < 0) {

362 
	`TRACE_APP
("Connection closed with server.\n");

366 
timev®
 
begš_t
;

367 
timev®
 
’d_t
;

369 
·ck‘s_£Á
 = 0;

370 
Ï‹ncy_sum
 = 0;

371 
diff_t
;

377 !
Ãtm­u£
.
do_abÜt
){

378 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

380 ià(
Ãv’ts
 < 0) {

381 ià(
”ºo
 !ğ
EINTR
)

382 
	`³¼Ü
("mtcp_epoll_wait");

385 
i
=0;i<
Ãv’ts
;i++) {

386 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

405 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, 
d©a
, 
DATA_LEN
);

407 ià(
»t
 < 0) {

408 
	`TRACE_APP
("Connection closed with server.\n");

413 if(
§ã_to_compu‹_ut
) {

414 
¡©s
[
cÜe
].
fÜw¬ded
 +ğ
»t
;

421 
	`D
("Clo£ %d",
cÜe
);

422 
	`Clo£CÚÃùiÚ
(
mùx
,
•
,
sockid
);

423 
	`D
("Clo£d %d",
cÜe
);

424  
NULL
;

427 
	}
}

430 
	$maš
(
¬gc
, **
¬gv
){

432 
cÜe
 = 0;

433 
»t
 = -1;

434 
ıu_£t_t
 
ıu_£t
;

437 ià(
¬gc
 != 3) {

438 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

439 
	`ex™
(0);

441 
ho¡Çme
 = 
¬gv
[1];

444 * 
cÚf_fe
 = "client.conf";

446 ià(
cÚf_fe
 =ğ
NULL
) {

447 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

448 
	`ex™
(
EXIT_FAILURE
);

452 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

453 ià(
»t
) {

454 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

455 
	`ex™
(
EXIT_FAILURE
);

459 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

461 
	`TRACE_INFO
("Application initialization finished.\n");

463 
i
=0;i<
MAX_THREADS
;i++){

464 
dÚe
[
i
] = 0;

467 
š_addr
 
¤c
,
de¡
;

468 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

469 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

470 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

471 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

473 
¡©s
.
	`»size
(
MAX_THREADS
);

475 
i
=0;i<
MAX_THREADS
;i++){

476 
	`mem£t
(&
¡©s
[
i
], 0, (
compu‹_¡©s
));

480 
i
=0;i<
MAX_THREADS
;i++){

481 ià(!
MQ_NIC
) {

482 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

483 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

484 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

485 
¬gum’ts
[
i
].
imsi
 = 
IMSI
+i;

486 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

487 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

489 
¬gum’ts
[
i
].
cÜ’o
 = i;

490 
cout
<<"CÚÃùiÚ from cÜe-mq "<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

491 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

492 
¬gum’ts
[
i
].
imsi
 = 
IMSI
+i;

493 
¬gum’ts
[
i
].
pÜŠo
 = 
mq_pÜts
[
MAX_THREADS
-1][i];

494 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

495 
	`CPU_ZERO
(&
ıu_£t
);

496 
	`CPU_SET
(
¬gum’ts
[
i
].
cÜ’o
, &
ıu_£t
);

497 
rc
 = 
	`±h»ad_£ffš™y_Å
(
ş›Ás
[
i
], (
ıu_£t_t
), &
ıu_£t
);

498 if(
rc
!=0) {

499 
	`D
("UÇbËØ£ˆaffš™y: %s", 
	`¡»¼Ü
(
”ºo
));

502 
j
 = 0; j < 
CPU_SETSIZE
; j++)

503 ià(
	`CPU_ISSET
(
j
, &
ıu_£t
)) {

504 
	`D
("CPU %d s‘ fÜ %u\n", 
j
, 
¬gum’ts
[
i
].
cÜ’o
);

537 
	`¦“p
(180);

539 
§ã_to_compu‹_ut
 = 
Œue
;

540 
	`g‘timeofday
(&
begš_t
, 
NULL
);

544 
Ãtm­u£
.
do_abÜt
 = 1;

545 
i
 = 0;i<
MAX_THREADS
;i++){

546 
dÚe
[
i
] = 1;

548 
	`D
("Before join");

549 
i
=0;i<
MAX_THREADS
;i++){

550 
	`D
("IÀjoš %d", 
i
);

551 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

553 
	`D
("After join");

562 
	}
}

	@testing_multi/TestMultiClient/client_app.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

22 
	#__FAVOR_BSD


	)

25 
	~<sys/ty³s.h
>

27 
	~<Ãtš‘/š.h
>

29 
	~<Ãtš‘/.h
>

31 
	~<Ãtš‘/6.h
>

36 
	~<lšux/udp.h
>

38 
	~<Ãt/‘h”Ãt.h
>

40 
	~<¡ršg.h
>

41 
	~<Ãtš‘/.h
>

42 
	~<Ãtš‘/š.h
>

43 
	~<uni¡d.h
>

44 
	~<içddrs.h
>

45 
	~<sys/ioùl.h
>

46 
	~<sys/pŞl.h
>

47 
	~<sys/sock‘.h
>

48 
	~<sys/ty³s.h
>

49 
	~<¬·/š‘.h
>

50 
	~<Ãt/‘h”Ãt.h
>

51 
	~<Ãt/if.h
>

52 
	~<Ãtš‘/š.h
>

54 
	~<lšux/udp.h
>

55 
	~<lšux/tı.h
>

56 
	~<Ãtš‘/.h
>

57 
	~<Ãtš‘/‘h”.h
>

58 
	~"Ãtm­_­i.h
"

60 
usšg
 
Çme¥aû
 
	g¡d
;

62 
	#MSB32
 0x80000000

	)

63 
	#MSB16
 0x8000

	)

64 
	#KEY_CACHE_LEN
 96

	)

65 
	#SEED
 'B'

	)

66 
	#CLIENT_IP
 "169.254.9.3"

	)

67 
	#SERVER_IP
 "169.254.9.8"

	)

68 
	#SERVER_PORT
 9999

	)

69 
	#CLIENT_START_PORT
 5900

	)

71 
	#NO_OF_PKTS
 8

	)

80 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

82 cÚ¡ 
ušt8_t
 
key
[] = {

94 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

95 (((
ušt32_t
)
key
[1]) << 16) |

96 (((
ušt32_t
)
key
[2]) << 8) |

97 ((
ušt32_t
)
key
[3]);

99 
ušt32_t
 
idx
 = 32;

100 
i
;

102 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

103 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

104 
ušt32_t
 
b™
;

106 
ÿche
[
i
] = 
»suÉ
;

107 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

109 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

111 
	}
}

117 
ušt32_t


118 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

121 
ušt32_t
 
rc
 = 0;

122 
i
;

123 
fœ¡_time
 = 1;

124 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

126 ià(
fœ¡_time
) {

127 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

128 
fœ¡_time
 = 0;

131 
i
 = 0; i < 32; i++) {

132 ià(
s
 & 
MSB32
)

133 
rc
 ^ğ
key_ÿche
[
i
];

134 
s
 <<= 1;

136 
i
 = 0; i < 32; i++) {

137 ià(
d
 & 
MSB32
)

138 
rc
 ^ğ
key_ÿche
[32+
i
];

139 
d
 <<= 1;

141 
i
 = 0; i < 16; i++) {

142 ià(
¥
 & 
MSB16
)

143 
rc
 ^ğ
key_ÿche
[64+
i
];

144 
¥
 <<= 1;

146 
i
 = 0; i < 16; i++) {

147 ià(
dp
 & 
MSB16
)

148 
rc
 ^ğ
key_ÿche
[80+
i
];

149 
dp
 <<= 1;

152  
rc
;

153 
	}
}

155 
	~"ıu.h
"

156 
	~"debug.h
"

158 
	#MAX_EVENTS
 1024

	)

159 
	#MAX_THREADS
 4

	)

161 
usšg
 
Çme¥aû
 
	g¡d
;

163 
	s¬g
{

164 
	mid
;

165 
ušt32_t
 
	mimsi
;

166 
	mcÜ’o
;

167 
	mpÜŠo
;

170 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

171 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

172 
	gdÚe
[
MAX_THREADS
];

174 *
	gho¡Çme
;

175 
	gmsg_d©a
[] = "To Sherlock Holmes she is‡lways THE woman. I have seldom heard\
 mention her under‡ny other‚ame. In hisƒyes sheƒclipses\
…redominateshe whole of her sex. It was‚othat he felt\
ƒmotion‡kino†ove for Irene Adler. Allƒmotions,‡ndhat\
…articularly, were‡bhorrento his cold,…recise but\
 balanced mind. He was, Iake it,he most…erfect\
‡nd observing machinehathe world has seen, but‡s‡\
 he would have…laced himself in‡ false…osition. He‚ever\
 ofhe softer…assions, save with‡ gibe‡nd‡ sneer. They\
‡dmirablehings forhe observer--excellent for drawinghe\
 from men's motives‡nd‡ctions. But forherained„easoner\
‡dmit such intrusions into his own delicate‡nd finely\
emperament waso introduce‡ distracting factor which\
hrow‡ doubt upon‡ll his mental„esults. Grit in‡\
 instrument, or‡ crack in one of his own high-power\
, would‚ot be more disturbinghan‡ strongƒmotion in‡\
 such‡s his. And yethere was but one womano him,‡nd\
 woman washe†ate Irene Adler, of dubious‡nd questionable\
.\
";

198 
	gveùÜ
 < 
	gcompu‹_¡©s
 > 
	g¡©s
;

199 
	gveùÜ
 < 
	gušt32_t
 > 
	gkey£t
[
MAX_THREADS
];

200 
timev®
 
	gbegš_t
;

201 
timev®
 
	g’d_t
;

202 
boŞ
 
	g§ã_to_compu‹_ut
 = 
çl£
;

203 
ušt64_t
 
	gtÙ®
;

204 
	g¿‹_t
, 
	gdiff_t
;

205 
©omic_ušt
 
	g§ã_to_šc_bur¡
;

206 
	gveùÜ
 < 
	gušt32_t
 > 
	g­p_pÜts
[
MAX_THREADS
];

210 
	$­p_Ëv–_¡©s
() {

212 
	`g‘timeofday
(&
’d_t
, 
NULL
);

213 
diff_t
 = (
’d_t
.
tv_£c
 - 
begš_t
.tv_sec) +

214 ((
’d_t
.
tv_u£c
 - 
begš_t
.tv_usec)/1000000.0);

216 
i
=0;i<
MAX_THREADS
;i++){

217 
tÙ®
+ğ
¡©s
[
i
].
fÜw¬ded
;

220 
¿‹_t
 = (
tÙ®
*8è/ (
diff_t
*1024*1024*1024);

221 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

223 
	}
}

226 
ušt32_t
 
	$hash_­p
Ğ
ušt32_t
 
a
)

228 
a
 = (a+0x7ed55d16) + (a<<12);

229 
a
 = (a^0xc761c23c) ^ (a>>19);

230 
a
 = (a+0x165667b1) + (a<<5);

231 
a
 = (a+0xd3a2646c) ^ (a<<9);

232 
a
 = (a+0xfd7046c5) + (a<<3);

233 
a
 = (a^0xb55a4f09) ^ (a>>16);

234  
a
;

235 
	}
}

238 
	$SigÇlHªdËr
(
signum
)

241 
i
 = 0;i<
MAX_THREADS
;i++){

242 
dÚe
[
i
] = 1;

244 
	`­p_Ëv–_¡©s
();

245 
	`¦“p
(5);

246 
	`mtı_de¡roy
();

248 
	}
}

250 
	$Clo£CÚÃùiÚ
(
mùx_t
 
mùx
, 
•
, 
sockid
)

252 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_DEL
, 
sockid
, 
NULL
);

253 
	`mtı_şo£
(
mùx
, 
sockid
);

254 
	}
}

257 
	$ş›ÁTh»adFunc
(* 
¬g1
){

259 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

260 
cÜe
 = 
¬gum’t
.
cÜ’o
;

261 
id
 = 
¬gum’t
.id;

262 
imsi
 = 
¬gum’t
.imsi;

263 
ušt32_t
 
pÜŠo
 = 
¬gum’t
.portno;

264 
num_pÜts
 = 
­p_pÜts
[
cÜe
].
	`size
();

267 
	`mtı_cÜe_affš™ize
(
cÜe
);

270 
buf
[
DATA_LEN
];

277 
	`¡rıy
(
buf
+(
ušt32_t
),
msg_d©a
);

282 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

283 ià(!
mùx
) {

284 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

285  
NULL
;

288 
	`¦“p
(3);

290 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

291 ià(
•
 < 0) {

292 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

293  
NULL
;

296 
sockaddr_š
 
§ddr
;

298 
§ddr
.
sš_çmy
 = 
AF_INET
;

299 
	`š‘_©Ú
("169.254.9.3",&
§ddr
.
sš_addr
);

301 
sockaddr_š
 
daddr
;

303 
daddr
.
sš_çmy
 = 
AF_INET
;

304 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

305 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

306 
ušt32_t
 
cÚn_couÁ”
 = 0,
p£Á
=0,
key£t_size
;

307 
key£t_size
 = 
key£t
[
cÜe
].
	`size
();

308 !
Ãtm­u£
.
do_abÜt
){

309 
cÚn_couÁ”
++;

310 
ušt32_t
 
ouut
 = 
key£t
[
cÜe
][
cÚn_couÁ”
%
key£t_size
];

311 *
±r
 =(*è&
ouut
;

312 
	`memıy
(
buf
,
±r
,(
ušt32_t
));

314 
pÜŠo
 = 
­p_pÜts
[
cÜe
][
cÚn_couÁ”
%
num_pÜts
];

315 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

319 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

320 ià(
sockid
 < 0) {

321 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

324 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

325 ià(
»t
 < 0) {

326 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

329 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

330 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

331 ià(
»t
 < 0) {

332 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

338 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

339 ià(
»t
 < 0) {

340 ià(
”ºo
 !ğ
EINPROGRESS
) {

341 
	`³¼Ü
("mtcp_connect");

342 
	`mtı_şo£
(
mùx
, 
sockid
);

353 
mtı_•Şl_ev’t
 
ev
;

354 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

355 
ev
.
d©a
.
sockid
 = sockid;

356 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

359 
mtı_•Şl_ev’t
 *
ev’ts
;

360 
Ãv’ts
;

361 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

362 ià(!
ev’ts
) {

363 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

364 
	`ex™
(-1);

366 
Ãwsockfd
 = -1;

367 
bur¡_šü—£d
 = 0;

368 
pkt_couÁ”
 = 0;

370 
pkt_couÁ”
++ < 
NO_OF_PKTS
){

372 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

374 ià(
Ãv’ts
 < 0) {

375 ià(
”ºo
 !ğ
EINTR
)

376 
	`³¼Ü
("mtcp_epoll_wait");

379 
i
=0;i<
Ãv’ts
;i++) {

380 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

384 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, 
buf
, 
DATA_LEN
);

386 ià(
»t
 < 0) {

387 
	`TRACE_APP
("Connection closed with server.\n");

392 if(
§ã_to_compu‹_ut
) {

393 
¡©s
[
cÜe
].
fÜw¬ded
 +ğ
»t
;

400 
	`Clo£CÚÃùiÚ
(
mùx
,
•
,
sockid
);

409 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

411 
	}
}

414 
	$maš
(
¬gc
, **
¬gv
){

416 
cÜe
 = 0;

417 
»t
 = -1;

420 ià(
¬gc
 != 3) {

421 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

422 
	`ex™
(0);

424 
ho¡Çme
 = 
¬gv
[1];

427 * 
cÚf_fe
 = "client.conf";

429 ià(
cÚf_fe
 =ğ
NULL
) {

430 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

431 
	`ex™
(
EXIT_FAILURE
);

435 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

436 ià(
»t
) {

437 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

438 
	`ex™
(
EXIT_FAILURE
);

442 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

444 
	`TRACE_INFO
("Application initialization finished.\n");

446 
i
=0;i<
MAX_THREADS
;i++){

447 
dÚe
[
i
] = 0;

450 
š_addr
 
¤c
,
de¡
;

451 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

452 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

453 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

454 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

456 
¡©s
.
	`»size
(
MAX_THREADS
);

458 
i
=0;i<
MAX_THREADS
;i++){

459 
	`mem£t
(&
¡©s
[
i
], 0, (
compu‹_¡©s
));

462 
i
=0;i<100;i++) {

463 
ušt32_t
 
‹mp
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+
i
+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

464 
­p_pÜts
[
‹mp
].
	`push_back
(
CLIENT_START_PORT
+
i
);

468 
i
=1;i<=1000;i++) {

469 
key£t
[
	`hash_­p
(
i
)%
MAX_THREADS
].
	`push_back
(i);

473 
i
=0;i<
MAX_THREADS
;i++){

474 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

475 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

476 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

477 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

478 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

481 
	`¦“p
(60);

483 
§ã_to_compu‹_ut
 = 
Œue
;

484 
	`g‘timeofday
(&
begš_t
, 
NULL
);

487 
i
=0;i<
MAX_THREADS
;i++){

488 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

491 
	}
}

	@testing_multi/TestMultiClient/client_new.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

22 
	#__FAVOR_BSD


	)

25 
	~<sys/ty³s.h
>

27 
	~<Ãtš‘/š.h
>

29 
	~<Ãtš‘/.h
>

31 
	~<Ãtš‘/6.h
>

36 
	~<lšux/udp.h
>

38 
	~<Ãt/‘h”Ãt.h
>

40 
	~<¡ršg.h
>

41 
	~<Ãtš‘/.h
>

42 
	~<Ãtš‘/š.h
>

43 
	~<uni¡d.h
>

44 
	~<içddrs.h
>

45 
	~<sys/ioùl.h
>

46 
	~<sys/pŞl.h
>

47 
	~<sys/sock‘.h
>

48 
	~<sys/ty³s.h
>

49 
	~<¬·/š‘.h
>

50 
	~<Ãt/‘h”Ãt.h
>

51 
	~<Ãt/if.h
>

52 
	~<Ãtš‘/š.h
>

54 
	~<lšux/udp.h
>

55 
	~<lšux/tı.h
>

56 
	~<Ãtš‘/.h
>

57 
	~<Ãtš‘/‘h”.h
>

58 
	~"Ãtm­_­i.h
"

60 
usšg
 
Çme¥aû
 
	g¡d
;

62 
	#MSB32
 0x80000000

	)

63 
	#MSB16
 0x8000

	)

64 
	#KEY_CACHE_LEN
 96

	)

65 
	#SEED
 'B'

	)

66 
	#CLIENT_IP
 "169.254.9.3"

	)

67 
	#SERVER_IP
 "169.254.9.8"

	)

68 
	#SERVER_PORT
 9999

	)

69 
	#CLIENT_START_PORT
 5900

	)

77 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

79 cÚ¡ 
ušt8_t
 
key
[] = {

91 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

92 (((
ušt32_t
)
key
[1]) << 16) |

93 (((
ušt32_t
)
key
[2]) << 8) |

94 ((
ušt32_t
)
key
[3]);

96 
ušt32_t
 
idx
 = 32;

97 
i
;

99 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

100 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

101 
ušt32_t
 
b™
;

103 
ÿche
[
i
] = 
»suÉ
;

104 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

106 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

108 
	}
}

114 
ušt32_t


115 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

118 
ušt32_t
 
rc
 = 0;

119 
i
;

120 
fœ¡_time
 = 1;

121 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

123 ià(
fœ¡_time
) {

124 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

125 
fœ¡_time
 = 0;

128 
i
 = 0; i < 32; i++) {

129 ià(
s
 & 
MSB32
)

130 
rc
 ^ğ
key_ÿche
[
i
];

131 
s
 <<= 1;

133 
i
 = 0; i < 32; i++) {

134 ià(
d
 & 
MSB32
)

135 
rc
 ^ğ
key_ÿche
[32+
i
];

136 
d
 <<= 1;

138 
i
 = 0; i < 16; i++) {

139 ià(
¥
 & 
MSB16
)

140 
rc
 ^ğ
key_ÿche
[64+
i
];

141 
¥
 <<= 1;

143 
i
 = 0; i < 16; i++) {

144 ià(
dp
 & 
MSB16
)

145 
rc
 ^ğ
key_ÿche
[80+
i
];

146 
dp
 <<= 1;

149  
rc
;

150 
	}
}

152 
	~"ıu.h
"

153 
	~"debug.h
"

155 
	#MAX_EVENTS
 1024

	)

156 
	#MAX_THREADS
 1

	)

158 
usšg
 
Çme¥aû
 
	g¡d
;

160 
	s¬g
{

161 
	mid
;

162 
ušt32_t
 
	mimsi
;

163 
	mcÜ’o
;

164 
	mpÜŠo
;

167 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

168 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

169 
	gdÚe
[
MAX_THREADS
];

170 
©omic_ušt
 
	g§ã_to_šc_bur¡
;

172 *
	gho¡Çme
;

176 
	$SigÇlHªdËr
(
signum
)

179 
i
 = 0;i<
MAX_THREADS
;i++){

180 
dÚe
[
i
] = 1;

182 
	`mtı_de¡roy
();

184 
	}
}

186 
	$ş›ÁTh»adFunc
(* 
¬g1
){

188 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

189 
cÜe
 = 
¬gum’t
.
cÜ’o
;

190 
id
 = 
¬gum’t
.id;

191 
imsi
 = 
¬gum’t
.imsi;

192 
pÜŠo
 = 
¬gum’t
.portno;

195 
	`mtı_cÜe_affš™ize
(
cÜe
);

200 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

201 ià(!
mùx
) {

202 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

203  
NULL
;

206 
	`¦“p
(10);

208 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

209 ià(
•
 < 0) {

210 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

211  
NULL
;

215 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

216 ià(
sockid
 < 0) {

217 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

220 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

221 ià(
»t
 < 0) {

222 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

226 
sockaddr_š
 
§ddr
;

228 
§ddr
.
sš_çmy
 = 
AF_INET
;

229 
	`š‘_©Ú
("169.254.9.3",&
§ddr
.
sš_addr
);

231 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

233 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

234 ià(
»t
 < 0) {

235 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

239 
sockaddr_š
 
daddr
;

241 
daddr
.
sš_çmy
 = 
AF_INET
;

242 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

243 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

244 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

245 ià(
»t
 < 0) {

246 ià(
”ºo
 !ğ
EINPROGRESS
) {

247 
	`³¼Ü
("mtcp_connect");

248 
	`mtı_şo£
(
mùx
, 
sockid
);

257 
mtı_•Şl_ev’t
 
ev
;

258 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

259 
ev
.
d©a
.
sockid
 = sockid;

260 
cout
<<"h–lo1"<<
’dl
;

261 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

264 
mtı_•Şl_ev’t
 *
ev’ts
;

265 
Ãv’ts
;

266 
cout
<<"h–lo2"<<
’dl
;

267 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

268 ià(!
ev’ts
) {

269 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

270 
	`ex™
(-1);

272 
cout
<<"h–lo3"<<
’dl
;

273 
Ãwsockfd
 = -1;

274 
bur¡_šü—£d
 = 0;

276 
d©a_¡ruù
 
ds
;

277 
ds
.
imsi
 = imsi;

279 !
dÚe
[
id
]){

280 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

282 ià(
Ãv’ts
 < 0) {

283 ià(
”ºo
 !ğ
EINTR
)

284 
	`³¼Ü
("mtcp_epoll_wait");

287 
i
=0;i<
Ãv’ts
;i++) {

288 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLIN
) {

291 if(!
bur¡_šü—£d
) {

292 
bur¡_šü—£d
 = 1;

293 
§ã_to_šc_bur¡
++;

295 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, (*)&
ds
, (
d©a_¡ruù
));

296 ià(
»t
 < 0) {

297 
	`TRACE_APP
("Connection closed with server.\n");

305 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

307 
	}
}

310 
	$maš
(
¬gc
, **
¬gv
){

312 
cÜe
 = 0;

313 
»t
 = -1;

316 ià(
¬gc
 != 3) {

317 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

318 
	`ex™
(0);

320 
ho¡Çme
 = 
¬gv
[1];

323 * 
cÚf_fe
 = "client.conf";

325 ià(
cÚf_fe
 =ğ
NULL
) {

326 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

327 
	`ex™
(
EXIT_FAILURE
);

331 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

332 ià(
»t
) {

333 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

334 
	`ex™
(
EXIT_FAILURE
);

338 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

340 
	`TRACE_INFO
("Application initialization finished.\n");

342 
i
=0;i<
MAX_THREADS
;i++){

343 
dÚe
[
i
] = 0;

346 
š_addr
 
¤c
,
de¡
;

347 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

348 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

349 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

350 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

353 
i
=0;i<
MAX_THREADS
;i++){

354 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

355 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

356 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

357 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

358 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

361 
§ã_to_šc_bur¡
!=
MAX_THREADS
) {

362 
this_th»ad
::
	`y›ld
();

365 
Ãtm­u£
.
šc_bur¡
 = 1;

366 
	`D
("Burst increased");

369 
i
=0;i<
MAX_THREADS
;i++){

370 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

373 
	}
}

	@testing_multi/TestMultiClient/client_old.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

22 
	#__FAVOR_BSD


	)

25 
	~<sys/ty³s.h
>

27 
	~<Ãtš‘/š.h
>

29 
	~<Ãtš‘/.h
>

31 
	~<Ãtš‘/6.h
>

36 
	~<lšux/udp.h
>

38 
	~<Ãt/‘h”Ãt.h
>

40 
	~<¡ršg.h
>

41 
	~<Ãtš‘/.h
>

42 
	~<Ãtš‘/š.h
>

43 
	~<uni¡d.h
>

44 
	~<içddrs.h
>

45 
	~<sys/ioùl.h
>

46 
	~<sys/pŞl.h
>

47 
	~<sys/sock‘.h
>

48 
	~<sys/ty³s.h
>

49 
	~<¬·/š‘.h
>

50 
	~<Ãt/‘h”Ãt.h
>

51 
	~<Ãt/if.h
>

52 
	~<Ãtš‘/š.h
>

54 
	~<lšux/udp.h
>

55 
	~<lšux/tı.h
>

56 
	~<Ãtš‘/.h
>

57 
	~<Ãtš‘/‘h”.h
>

58 
	~"Ãtm­_­i.h
"

60 
usšg
 
Çme¥aû
 
	g¡d
;

62 
	#MSB32
 0x80000000

	)

63 
	#MSB16
 0x8000

	)

64 
	#KEY_CACHE_LEN
 96

	)

65 
	#SEED
 'B'

	)

66 
	#CLIENT_IP
 "169.254.9.3"

	)

67 
	#SERVER_IP
 "169.254.9.8"

	)

68 
	#SERVER_PORT
 9999

	)

69 
	#CLIENT_START_PORT
 5900

	)

77 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

79 cÚ¡ 
ušt8_t
 
key
[] = {

91 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

92 (((
ušt32_t
)
key
[1]) << 16) |

93 (((
ušt32_t
)
key
[2]) << 8) |

94 ((
ušt32_t
)
key
[3]);

96 
ušt32_t
 
idx
 = 32;

97 
i
;

99 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

100 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

101 
ušt32_t
 
b™
;

103 
ÿche
[
i
] = 
»suÉ
;

104 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

106 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

108 
	}
}

114 
ušt32_t


115 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

118 
ušt32_t
 
rc
 = 0;

119 
i
;

120 
fœ¡_time
 = 1;

121 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

123 ià(
fœ¡_time
) {

124 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

125 
fœ¡_time
 = 0;

128 
i
 = 0; i < 32; i++) {

129 ià(
s
 & 
MSB32
)

130 
rc
 ^ğ
key_ÿche
[
i
];

131 
s
 <<= 1;

133 
i
 = 0; i < 32; i++) {

134 ià(
d
 & 
MSB32
)

135 
rc
 ^ğ
key_ÿche
[32+
i
];

136 
d
 <<= 1;

138 
i
 = 0; i < 16; i++) {

139 ià(
¥
 & 
MSB16
)

140 
rc
 ^ğ
key_ÿche
[64+
i
];

141 
¥
 <<= 1;

143 
i
 = 0; i < 16; i++) {

144 ià(
dp
 & 
MSB16
)

145 
rc
 ^ğ
key_ÿche
[80+
i
];

146 
dp
 <<= 1;

149  
rc
;

150 
	}
}

152 
	~"ıu.h
"

153 
	~"debug.h
"

155 
	#MAX_EVENTS
 1024

	)

156 
	#MAX_THREADS
 1

	)

158 
usšg
 
Çme¥aû
 
	g¡d
;

160 
	s¬g
{

161 
	mid
;

162 
	mcÜ’o
;

163 
	mpÜŠo
;

166 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

167 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

168 
	gdÚe
[
MAX_THREADS
];

169 
©omic_ušt
 
	g§ã_to_šc_bur¡
;

171 *
	gho¡Çme
;

175 
	$SigÇlHªdËr
(
signum
)

178 
i
 = 0;i<
MAX_THREADS
;i++){

179 
dÚe
[
i
] = 1;

181 
	`mtı_de¡roy
();

183 
	}
}

185 
	$ş›ÁTh»adFunc
(* 
¬g1
){

187 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

188 
cÜe
 = 
¬gum’t
.
cÜ’o
;

189 
id
 = 
¬gum’t
.id;

190 
pÜŠo
 = 
¬gum’t
.portno;

193 
	`mtı_cÜe_affš™ize
(
cÜe
);

198 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

199 ià(!
mùx
) {

200 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

201  
NULL
;

204 
	`¦“p
(10);

206 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

207 ià(
•
 < 0) {

208 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

209  
NULL
;

213 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

214 ià(
sockid
 < 0) {

215 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

218 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

219 ià(
»t
 < 0) {

220 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

224 
sockaddr_š
 
§ddr
;

226 
§ddr
.
sš_çmy
 = 
AF_INET
;

227 
	`š‘_©Ú
("169.254.9.3",&
§ddr
.
sš_addr
);

229 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

231 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

232 ià(
»t
 < 0) {

233 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

237 
sockaddr_š
 
daddr
;

239 
daddr
.
sš_çmy
 = 
AF_INET
;

240 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

241 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

242 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

243 ià(
»t
 < 0) {

244 ià(
”ºo
 !ğ
EINPROGRESS
) {

245 
	`³¼Ü
("mtcp_connect");

246 
	`mtı_şo£
(
mùx
, 
sockid
);

255 
mtı_•Şl_ev’t
 
ev
;

256 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

257 
ev
.
d©a
.
sockid
 = sockid;

258 
cout
<<"h–lo1"<<
’dl
;

259 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

262 
mtı_•Şl_ev’t
 *
ev’ts
;

263 
Ãv’ts
;

264 
cout
<<"h–lo2"<<
’dl
;

265 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

266 ià(!
ev’ts
) {

267 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

268 
	`ex™
(-1);

270 
cout
<<"h–lo3"<<
’dl
;

271 
Ãwsockfd
 = -1;

272 
bur¡_šü—£d
 = 0;

273 
d©a
[1500];

275 !
dÚe
[
id
]){

276 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

278 ià(
Ãv’ts
 < 0) {

279 ià(
”ºo
 !ğ
EINTR
)

280 
	`³¼Ü
("mtcp_epoll_wait");

283 
i
=0;i<
Ãv’ts
;i++) {

284 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLIN
) {

287 if(!
bur¡_šü—£d
) {

288 
bur¡_šü—£d
 = 1;

289 
§ã_to_šc_bur¡
++;

291 
rd
 = 
	`mtı_»ad
(
mùx
, 
sockid
, 
d©a
, 1408);

292 ià(
rd
 <= 0) {

300 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

302 
	}
}

305 
	$maš
(
¬gc
, **
¬gv
){

307 
cÜe
 = 0;

308 
»t
 = -1;

311 ià(
¬gc
 != 3) {

312 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

313 
	`ex™
(0);

315 
ho¡Çme
 = 
¬gv
[1];

318 * 
cÚf_fe
 = "client.conf";

320 ià(
cÚf_fe
 =ğ
NULL
) {

321 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

322 
	`ex™
(
EXIT_FAILURE
);

326 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

327 ià(
»t
) {

328 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

329 
	`ex™
(
EXIT_FAILURE
);

333 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

335 
	`TRACE_INFO
("Application initialization finished.\n");

337 
i
=0;i<
MAX_THREADS
;i++){

338 
dÚe
[
i
] = 0;

341 
š_addr
 
¤c
,
de¡
;

342 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

343 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

344 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

345 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

348 
i
=0;i<
MAX_THREADS
;i++){

349 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

350 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

351 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

352 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

353 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

356 
§ã_to_šc_bur¡
!=
MAX_THREADS
) {

357 
this_th»ad
::
	`y›ld
();

360 
Ãtm­u£
.
šc_bur¡
 = 1;

361 
	`D
("Burst increased");

364 
i
=0;i<
MAX_THREADS
;i++){

365 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

368 
	}
}

	@testing_multi/TestMultiClient/client_old_new.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

21 
	~<¡ršgs.h
>

22 
	~<veùÜ
>

24 
	#__FAVOR_BSD


	)

27 
	~<sys/ty³s.h
>

29 
	~<Ãtš‘/š.h
>

31 
	~<Ãtš‘/.h
>

33 
	~<Ãtš‘/6.h
>

38 
	~<lšux/udp.h
>

40 
	~<Ãt/‘h”Ãt.h
>

42 
	~<¡ršg.h
>

43 
	~<Ãtš‘/.h
>

44 
	~<Ãtš‘/š.h
>

45 
	~<uni¡d.h
>

46 
	~<içddrs.h
>

47 
	~<sys/ioùl.h
>

48 
	~<sys/pŞl.h
>

49 
	~<sys/sock‘.h
>

50 
	~<sys/ty³s.h
>

51 
	~<¬·/š‘.h
>

52 
	~<Ãt/‘h”Ãt.h
>

53 
	~<Ãt/if.h
>

54 
	~<Ãtš‘/š.h
>

56 
	~<lšux/udp.h
>

57 
	~<lšux/tı.h
>

58 
	~<Ãtš‘/.h
>

59 
	~<Ãtš‘/‘h”.h
>

60 
	~"Ãtm­_­i.h
"

62 
usšg
 
Çme¥aû
 
	g¡d
;

64 
	#MSB32
 0x80000000

	)

65 
	#MSB16
 0x8000

	)

66 
	#KEY_CACHE_LEN
 96

	)

67 
	#SEED
 'B'

	)

68 
	#CLIENT_IP
 "169.254.9.3"

	)

69 
	#SERVER_IP
 "169.254.9.8"

	)

70 
	#SERVER_PORT
 9999

	)

71 
	#CLIENT_START_PORT
 5900

	)

80 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

82 cÚ¡ 
ušt8_t
 
key
[] = {

94 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

95 (((
ušt32_t
)
key
[1]) << 16) |

96 (((
ušt32_t
)
key
[2]) << 8) |

97 ((
ušt32_t
)
key
[3]);

99 
ušt32_t
 
idx
 = 32;

100 
i
;

102 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

103 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

104 
ušt32_t
 
b™
;

106 
ÿche
[
i
] = 
»suÉ
;

107 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

109 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

111 
	}
}

117 
ušt32_t


118 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

121 
ušt32_t
 
rc
 = 0;

122 
i
;

123 
fœ¡_time
 = 1;

124 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

126 ià(
fœ¡_time
) {

127 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

128 
fœ¡_time
 = 0;

131 
i
 = 0; i < 32; i++) {

132 ià(
s
 & 
MSB32
)

133 
rc
 ^ğ
key_ÿche
[
i
];

134 
s
 <<= 1;

136 
i
 = 0; i < 32; i++) {

137 ià(
d
 & 
MSB32
)

138 
rc
 ^ğ
key_ÿche
[32+
i
];

139 
d
 <<= 1;

141 
i
 = 0; i < 16; i++) {

142 ià(
¥
 & 
MSB16
)

143 
rc
 ^ğ
key_ÿche
[64+
i
];

144 
¥
 <<= 1;

146 
i
 = 0; i < 16; i++) {

147 ià(
dp
 & 
MSB16
)

148 
rc
 ^ğ
key_ÿche
[80+
i
];

149 
dp
 <<= 1;

152  
rc
;

153 
	}
}

155 
	~"ıu.h
"

156 
	~"debug.h
"

158 
	#MAX_EVENTS
 1024

	)

159 
	#MAX_THREADS
 1

	)

161 
usšg
 
Çme¥aû
 
	g¡d
;

163 
	s¬g
{

164 
	mid
;

165 
	mcÜ’o
;

166 
	mpÜŠo
;

169 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

170 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

171 
	gdÚe
[
MAX_THREADS
];

173 *
	gho¡Çme
;

178 
	gveùÜ
 < 
	gcompu‹_¡©s
 > 
	g¡©s
;

179 
timev®
 
	gbegš_t
;

180 
timev®
 
	g’d_t
;

181 
boŞ
 
	g§ã_to_compu‹_ut
 = 
çl£
;

182 
ušt64_t
 
	gtÙ®
;

183 
	g¿‹_t
, 
	gdiff_t
;

187 
	$­p_Ëv–_¡©s
() {

189 
	`g‘timeofday
(&
’d_t
, 
NULL
);

190 
diff_t
 = (
’d_t
.
tv_£c
 - 
begš_t
.tv_sec) +

191 ((
’d_t
.
tv_u£c
 - 
begš_t
.tv_usec)/1000000.0);

193 
i
=0;i<
MAX_THREADS
;i++){

194 
tÙ®
+ğ
¡©s
[
i
].
fÜw¬ded
;

197 
¿‹_t
 = (
tÙ®
*8è/ (
diff_t
*1024*1024*1024);

198 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

200 
	}
}

203 
	$SigÇlHªdËr
(
signum
)

206 
Ãtm­u£
.
do_abÜt
 = 1;

207 
i
 = 0;i<
MAX_THREADS
;i++){

208 
dÚe
[
i
] = 1;

210 
	`¦“p
(5);

211 
	`­p_Ëv–_¡©s
();

212 
	`mtı_de¡roy
();

214 
	}
}

216 
	$ş›ÁTh»adFunc
(* 
¬g1
){

218 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

219 
cÜe
 = 
¬gum’t
.
cÜ’o
;

220 
id
 = 
¬gum’t
.id;

221 
pÜŠo
 = 
¬gum’t
.portno;

224 
	`mtı_cÜe_affš™ize
(
cÜe
);

229 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

230 ià(!
mùx
) {

231 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

232  
NULL
;

235 
	`¦“p
(10);

237 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

238 ià(
•
 < 0) {

239 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

240  
NULL
;

244 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

245 ià(
sockid
 < 0) {

246 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

249 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

250 ià(
»t
 < 0) {

251 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

255 
sockaddr_š
 
§ddr
;

257 
§ddr
.
sš_çmy
 = 
AF_INET
;

258 
	`š‘_©Ú
("169.254.9.3",&
§ddr
.
sš_addr
);

260 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

262 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

263 ià(
»t
 < 0) {

264 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

268 
sockaddr_š
 
daddr
;

270 
daddr
.
sš_çmy
 = 
AF_INET
;

271 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

272 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

273 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

274 ià(
»t
 < 0) {

275 ià(
”ºo
 !ğ
EINPROGRESS
) {

276 
	`³¼Ü
("mtcp_connect");

277 
	`mtı_şo£
(
mùx
, 
sockid
);

286 
mtı_•Şl_ev’t
 
ev
;

287 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

288 
ev
.
d©a
.
sockid
 = sockid;

289 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

292 
mtı_•Şl_ev’t
 *
ev’ts
;

293 
Ãv’ts
;

294 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

295 ià(!
ev’ts
) {

296 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

297 
	`ex™
(-1);

299 
Ãwsockfd
 = -1;

300 
bur¡_šü—£d
 = 0;

302 *
d©a
 = "netmap…kt-gen DIRECT…ayload\n"

343 !
Ãtm­u£
.
do_abÜt
){

344 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

346 ià(
Ãv’ts
 < 0) {

347 ià(
”ºo
 !ğ
EINTR
)

348 
	`³¼Ü
("mtcp_epoll_wait");

351 
i
=0;i<
Ãv’ts
;i++) {

352 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

355 
rd
 = 1;

356  
rd
>0 ) {

357 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, 
d©a
, 1408);

359 ià(
»t
 < 0) {

360 
	`TRACE_APP
("Connection closed with server.\n");

365 if(
§ã_to_compu‹_ut
) {

366 
¡©s
[
cÜe
].
fÜw¬ded
 +ğ
»t
;

373 
	`¦“p
(20);

374 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

376 
	}
}

379 
	$maš
(
¬gc
, **
¬gv
){

381 
cÜe
 = 0;

382 
»t
 = -1;

385 ià(
¬gc
 != 3) {

386 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

387 
	`ex™
(0);

389 
ho¡Çme
 = 
¬gv
[1];

392 * 
cÚf_fe
 = "client.conf";

394 ià(
cÚf_fe
 =ğ
NULL
) {

395 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

396 
	`ex™
(
EXIT_FAILURE
);

400 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

401 ià(
»t
) {

402 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

403 
	`ex™
(
EXIT_FAILURE
);

407 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

409 
	`TRACE_INFO
("Application initialization finished.\n");

411 
i
=0;i<
MAX_THREADS
;i++){

412 
dÚe
[
i
] = 0;

415 
š_addr
 
¤c
,
de¡
;

416 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

417 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

418 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

419 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

421 
¡©s
.
	`»size
(
MAX_THREADS
);

423 
i
=0;i<
MAX_THREADS
;i++){

424 
	`mem£t
(&
¡©s
[
i
], 0, (
compu‹_¡©s
));

428 
i
=0;i<
MAX_THREADS
;i++){

429 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

430 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

431 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

432 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

433 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

463 
	`¦“p
(60);

465 
§ã_to_compu‹_ut
 = 
Œue
;

466 
	`g‘timeofday
(&
begš_t
, 
NULL
);

469 
i
=0;i<
MAX_THREADS
;i++){

470 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

480 
	}
}

	@testing_multi/TestMultiClient/client_rss.cpp

2 
	#_LARGEFILE64_SOURCE


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<uni¡d.h
>

6 
	~<¡dšt.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

12 
	~<fú.h
>

13 
	~<dœ’t.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<±h»ad.h
>

17 
	~<sigÇl.h
>

18 
	~<io¡»am
>

19 
	~<mtı_­i.h
>

20 
	~<mtı_•Şl.h
>

22 
	#__FAVOR_BSD


	)

25 
	~<sys/ty³s.h
>

27 
	~<Ãtš‘/š.h
>

29 
	~<Ãtš‘/.h
>

31 
	~<Ãtš‘/6.h
>

36 
	~<lšux/udp.h
>

38 
	~<Ãt/‘h”Ãt.h
>

40 
	~<¡ršg.h
>

41 
	~<Ãtš‘/.h
>

42 
	~<Ãtš‘/š.h
>

43 
	~<uni¡d.h
>

44 
	~<içddrs.h
>

45 
	~<sys/ioùl.h
>

46 
	~<sys/pŞl.h
>

47 
	~<sys/sock‘.h
>

48 
	~<sys/ty³s.h
>

49 
	~<¬·/š‘.h
>

50 
	~<Ãt/‘h”Ãt.h
>

51 
	~<Ãt/if.h
>

52 
	~<Ãtš‘/š.h
>

54 
	~<lšux/udp.h
>

55 
	~<lšux/tı.h
>

56 
	~<Ãtš‘/.h
>

57 
	~<Ãtš‘/‘h”.h
>

58 
	~"Ãtm­_­i.h
"

60 
usšg
 
Çme¥aû
 
	g¡d
;

62 
	#MSB32
 0x80000000

	)

63 
	#MSB16
 0x8000

	)

64 
	#KEY_CACHE_LEN
 96

	)

65 
	#SEED
 'B'

	)

66 
	#CLIENT_IP
 "169.254.9.3"

	)

67 
	#SERVER_IP
 "169.254.9.8"

	)

68 
	#SERVER_PORT
 9999

	)

69 
	#CLIENT_START_PORT
 5900

	)

71 
	#NO_OF_PKTS
 524288

	)

80 
	$bud_sym_key_ÿche
(
ušt32_t
 *
ÿche
, 
ÿche_Ën
)

82 cÚ¡ 
ušt8_t
 
key
[] = {

94 
ušt32_t
 
»suÉ
 = (((ušt32_t)
key
[0]) << 24) |

95 (((
ušt32_t
)
key
[1]) << 16) |

96 (((
ušt32_t
)
key
[2]) << 8) |

97 ((
ušt32_t
)
key
[3]);

99 
ušt32_t
 
idx
 = 32;

100 
i
;

102 
i
 = 0; i < 
ÿche_Ën
; i++, 
idx
++) {

103 
ušt8_t
 
shiá
 = (
idx
 % ((uint8_t) * 8));

104 
ušt32_t
 
b™
;

106 
ÿche
[
i
] = 
»suÉ
;

107 
b™
 = ((
key
[
idx
/((
ušt8_t
è* 8)] << 
shiá
)

109 
»suÉ
 = (ÔesuÉ << 1è| 
b™
);

111 
	}
}

117 
ušt32_t


118 
	$sym_hash_â
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt32_ˆ
dp
)

121 
ušt32_t
 
rc
 = 0;

122 
i
;

123 
fœ¡_time
 = 1;

124 
ušt32_t
 
key_ÿche
[
KEY_CACHE_LEN
] = {0};

126 ià(
fœ¡_time
) {

127 
	`bud_sym_key_ÿche
(
key_ÿche
, 
KEY_CACHE_LEN
);

128 
fœ¡_time
 = 0;

131 
i
 = 0; i < 32; i++) {

132 ià(
s
 & 
MSB32
)

133 
rc
 ^ğ
key_ÿche
[
i
];

134 
s
 <<= 1;

136 
i
 = 0; i < 32; i++) {

137 ià(
d
 & 
MSB32
)

138 
rc
 ^ğ
key_ÿche
[32+
i
];

139 
d
 <<= 1;

141 
i
 = 0; i < 16; i++) {

142 ià(
¥
 & 
MSB16
)

143 
rc
 ^ğ
key_ÿche
[64+
i
];

144 
¥
 <<= 1;

146 
i
 = 0; i < 16; i++) {

147 ià(
dp
 & 
MSB16
)

148 
rc
 ^ğ
key_ÿche
[80+
i
];

149 
dp
 <<= 1;

152  
rc
;

153 
	}
}

155 
	~"ıu.h
"

156 
	~"debug.h
"

158 
	#MAX_EVENTS
 1024

	)

159 
	#MAX_THREADS
 4

	)

161 
usšg
 
Çme¥aû
 
	g¡d
;

163 
	s¬g
{

164 
	mid
;

165 
ušt32_t
 
	mimsi
;

166 
	mcÜ’o
;

167 
	mpÜŠo
;

170 
±h»ad_t
 
	gş›Ás
[
MAX_THREADS
];

171 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

172 
	gdÚe
[
MAX_THREADS
];

174 *
	gho¡Çme
;

179 
	gveùÜ
 < 
	gcompu‹_¡©s
 > 
	g¡©s
;

180 
timev®
 
	gbegš_t
;

181 
timev®
 
	g’d_t
;

182 
boŞ
 
	g§ã_to_compu‹_ut
 = 
çl£
;

183 
ušt64_t
 
	gtÙ®
;

184 
	g¿‹_t
, 
	gdiff_t
;

185 
©omic_ušt
 
	g§ã_to_šc_bur¡
;

186 
	gveùÜ
 < 
	gušt32_t
 > 
	g­p_pÜts
[
MAX_THREADS
];

190 
	$­p_Ëv–_¡©s
() {

192 
	`g‘timeofday
(&
’d_t
, 
NULL
);

193 
diff_t
 = (
’d_t
.
tv_£c
 - 
begš_t
.tv_sec) +

194 ((
’d_t
.
tv_u£c
 - 
begš_t
.tv_usec)/1000000.0);

196 
i
=0;i<
MAX_THREADS
;i++){

197 
tÙ®
+ğ
¡©s
[
i
].
fÜw¬ded
;

200 
¿‹_t
 = (
tÙ®
*8è/ (
diff_t
*1024*1024*1024);

201 
	`D
("R©š Gbps: %lf", 
¿‹_t
);

203 
	}
}

206 
	$SigÇlHªdËr
(
signum
)

209 
i
 = 0;i<
MAX_THREADS
;i++){

210 
dÚe
[
i
] = 1;

212 
	`­p_Ëv–_¡©s
();

213 
	`¦“p
(5);

214 
	`mtı_de¡roy
();

216 
	}
}

218 
	$Clo£CÚÃùiÚ
(
mùx_t
 
mùx
, 
•
, 
sockid
)

220 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_DEL
, 
sockid
, 
NULL
);

221 
	`mtı_şo£
(
mùx
, 
sockid
);

222 
	}
}

225 
	$ş›ÁTh»adFunc
(* 
¬g1
){

227 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

228 
cÜe
 = 
¬gum’t
.
cÜ’o
;

229 
id
 = 
¬gum’t
.id;

230 
imsi
 = 
¬gum’t
.imsi;

231 
ušt32_t
 
pÜŠo
 = 
¬gum’t
.portno;

232 
num_pÜts
 = 
­p_pÜts
[
cÜe
].
	`size
();

235 
	`mtı_cÜe_affš™ize
(
cÜe
);

236 
buf
[
DATA_LEN
];

237 
ušt8_t
 *
±r
 =(ušt8_ˆ*è&
imsi
;

238 
	`memıy
(
buf
,
±r
,(
ušt32_t
));

242 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

243 ià(!
mùx
) {

244 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

245  
NULL
;

248 
	`¦“p
(10);

250 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

251 ià(
•
 < 0) {

252 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

253  
NULL
;

256 
sockaddr_š
 
§ddr
;

258 
§ddr
.
sš_çmy
 = 
AF_INET
;

259 
	`š‘_©Ú
("169.254.9.3",&
§ddr
.
sš_addr
);

261 
sockaddr_š
 
daddr
;

263 
daddr
.
sš_çmy
 = 
AF_INET
;

264 
daddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡Çme
);

265 
daddr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

266 
ušt32_t
 
cÚn_couÁ”
 = 0,
p£Á
=0;

267 !
Ãtm­u£
.
do_abÜt
){

268 
cÚn_couÁ”
++;

269 
pÜŠo
 = 
­p_pÜts
[
cÜe
][
cÚn_couÁ”
%
num_pÜts
];

270 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

273 
sockid
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

274 ià(
sockid
 < 0) {

275 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

278 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
sockid
);

279 ià(
»t
 < 0) {

280 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

283 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

284 
»t
 = 
	`mtı_bšd
(
mùx
, 
sockid
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

285 ià(
»t
 < 0) {

286 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

291 
»t
 = 
	`mtı_cÚÃù
(
mùx
, 
sockid
, (
sockaddr
 *)&
daddr
, (
sockaddr_š
));

292 ià(
»t
 < 0) {

293 ià(
”ºo
 !ğ
EINPROGRESS
) {

294 
	`³¼Ü
("mtcp_connect");

295 
	`mtı_şo£
(
mùx
, 
sockid
);

305 
mtı_•Şl_ev’t
 
ev
;

306 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

307 
ev
.
d©a
.
sockid
 = sockid;

308 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
sockid
, &
ev
);

311 
mtı_•Şl_ev’t
 *
ev’ts
;

312 
Ãv’ts
;

313 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

314 ià(!
ev’ts
) {

315 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

316 
	`ex™
(-1);

318 
Ãwsockfd
 = -1;

319 
bur¡_šü—£d
 = 0;

320 
pkt_couÁ”
 = 0;

322 
pkt_couÁ”
++ < 
NO_OF_PKTS
){

324 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

326 ià(
Ãv’ts
 < 0) {

327 ià(
”ºo
 !ğ
EINTR
)

328 
	`³¼Ü
("mtcp_epoll_wait");

331 
i
=0;i<
Ãv’ts
;i++) {

332 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

336 
»t
 = 
	`mtı_wr™e
(
mùx
, 
sockid
, 
buf
, 
DATA_LEN
);

338 ià(
»t
 < 0) {

339 
	`TRACE_APP
("Connection closed with server.\n");

344 if(
§ã_to_compu‹_ut
) {

345 
¡©s
[
cÜe
].
fÜw¬ded
 +ğ
»t
;

352 
	`Clo£CÚÃùiÚ
(
mùx
,
•
,
sockid
);

359 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

361 
	}
}

364 
	$maš
(
¬gc
, **
¬gv
){

366 
cÜe
 = 0;

367 
»t
 = -1;

370 ià(
¬gc
 != 3) {

371 
	`årštf
(
¡d”r
,"u§ge: <ho¡Çme> <pÜt>\n", 
¬gv
[0]);

372 
	`ex™
(0);

374 
ho¡Çme
 = 
¬gv
[1];

377 * 
cÚf_fe
 = "client.conf";

379 ià(
cÚf_fe
 =ğ
NULL
) {

380 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

381 
	`ex™
(
EXIT_FAILURE
);

385 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

386 ià(
»t
) {

387 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

388 
	`ex™
(
EXIT_FAILURE
);

392 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

394 
	`TRACE_INFO
("Application initialization finished.\n");

396 
i
=0;i<
MAX_THREADS
;i++){

397 
dÚe
[
i
] = 0;

400 
š_addr
 
¤c
,
de¡
;

401 
	`š‘_©Ú
(
CLIENT_IP
, &
¤c
);

402 
	`š‘_©Ú
(
SERVER_IP
, &
de¡
);

403 
ušt32_t
 
s
 = 
	`Áohl
(
¤c
.
s_addr
);

404 
ušt32_t
 
d
 = 
	`Áohl
(
de¡
.
s_addr
);

406 
¡©s
.
	`»size
(
MAX_THREADS
);

408 
i
=0;i<
MAX_THREADS
;i++){

409 
	`mem£t
(&
¡©s
[
i
], 0, (
compu‹_¡©s
));

412 
i
=0;i<100;i++) {

413 
ušt32_t
 
‹mp
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+
i
+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

414 
­p_pÜts
[
‹mp
].
	`push_back
(
CLIENT_START_PORT
+
i
);

419 
i
=0;i<
MAX_THREADS
;i++){

420 
¬gum’ts
[
i
].
cÜ’o
 = 
	`sym_hash_â
(
s
,
d
,
CLIENT_START_PORT
+i+
SEED
,
SERVER_PORT
+SEED)%
MAX_THREADS
;

421 
cout
<<"CÚÃùiÚ from cÜ"<<
¬gum’ts
[
i
].
cÜ’o
<<
’dl
;

422 
¬gum’ts
[
i
].
id
 =‡rgum’ts[i].
cÜ’o
;

423 
¬gum’ts
[
i
].
pÜŠo
 = 
CLIENT_START_PORT
+i;

424 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
],
NULL
,
ş›ÁTh»adFunc
,&
¬gum’ts
[i]);

427 
	`¦“p
(60);

429 
§ã_to_compu‹_ut
 = 
Œue
;

430 
	`g‘timeofday
(&
begš_t
, 
NULL
);

433 
i
=0;i<
MAX_THREADS
;i++){

434 
	`±h»ad_još
(
ş›Ás
[
i
],
NULL
);

437 
	}
}

	@testing_multi/TestMultiServer/server.cpp

1 
	#_LARGEFILE64_SOURCE


	)

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<¡dšt.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

12 
	~<dœ’t.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

15 
	~<±h»ad.h
>

16 
	~<sigÇl.h
>

17 
	~<io¡»am
>

18 
	~<mtı_­i.h
>

19 
	~<mtı_•Şl.h
>

20 
	~<io¡»am
>

21 
	~"ıu.h
"

22 
	~"debug.h
"

24 
	#MAX_EVENTS
 1024

	)

25 
	#MAX_THREADS
 1

	)

26 
usšg
 
Çme¥aû
 
	g¡d
;

29 
	s¬g
{

30 
	mid
;

31 
	mcÜ’o
;

34 
±h»ad_t
 
	g£rv”s
[
MAX_THREADS
];

35 
¬g
 
	g¬gum’ts
[
MAX_THREADS
];

36 
	gdÚe
[
MAX_THREADS
];

37 
	gpÜŠo
;

41 
	$SigÇlHªdËr
(
signum
)

44 
	`mtı_de¡roy
();

46 
i
 = 0;i<
MAX_THREADS
;i++){

47 
dÚe
[
i
] = 1;

49 
	}
}

51 
	$£rv”Th»adFunc
(* 
¬g1
){

53 
¬g
 
¬gum’t
 = *((¬g*)
¬g1
);

54 
cÜe
 = 
¬gum’t
.
cÜ’o
;

55 
id
 = 
¬gum’t
.id;

57 
	`mtı_cÜe_affš™ize
(
cÜe
);

62 
mùx_t
 
mùx
 = 
	`mtı_ü—‹_cÚ‹xt
(
cÜe
);

63 ià(!
mùx
) {

64 
	`TRACE_ERROR
("Failedo create mtcp context!\n");

65  
NULL
;

68 
	`TRACE_INFO
("mtcp context created.\n");

71 
•
 = 
	`mtı_•Şl_ü—‹
(
mùx
, 
MAX_EVENTS
);

72 ià(
•
 < 0) {

73 
	`TRACE_ERROR
("Failedo createƒpoll descriptor!\n");

74  
NULL
;

78 
li¡’”
 = 
	`mtı_sock‘
(
mùx
, 
AF_INET
, 
SOCK_STREAM
, 0);

79 ià(
li¡’”
 < 0) {

80 
	`TRACE_ERROR
("Failedo create†istening socket!\n");

83 
»t
 = 
	`mtı_£tsock_nÚblock
(
mùx
, 
li¡’”
);

84 ià(
»t
 < 0) {

85 
	`TRACE_ERROR
("Failedo set socket in‚onblocking mode.\n");

89 
sockaddr_š
 
§ddr
;

91 
§ddr
.
sš_çmy
 = 
AF_INET
;

92 
§ddr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

93 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
pÜŠo
);

95 
»t
 = 
	`mtı_bšd
(
mùx
, 
li¡’”
,(
sockaddr
 *)&
§ddr
, (
sockaddr_š
));

96 ià(
»t
 < 0) {

97 
	`TRACE_ERROR
("Failedo bindohe†istening socket!\n");

103 
»t
 = 
	`mtı_li¡’
(
mùx
, 
li¡’”
, 4096);

104 ià(
»t
 < 0) {

105 
	`TRACE_ERROR
("mtcp_listen() failed!\n");

110 
mtı_•Şl_ev’t
 
ev
;

111 
ev
.
ev’ts
 = 
MTCP_EPOLLIN
;

112 
ev
.
d©a
.
sockid
 = 
li¡’”
;

113 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
li¡’”
, &
ev
);

116 
mtı_•Şl_ev’t
 *
ev’ts
;

117 
Ãv’ts
;

118 
Ãwsockfd
 = -1;

119 
ev’ts
 = (
mtı_•Şl_ev’t
 *)
	`ÿÎoc
(
MAX_EVENTS
, (mtcp_epoll_event));

120 ià(!
ev’ts
) {

121 
	`TRACE_ERROR
("Failedo createƒvent struct!\n");

122 
	`ex™
(-1);

124 
cout
 << "Wa™šg fÜƒv’ts" << 
’dl
;

125 !
dÚe
[
id
]){

126 
Ãv’ts
 = 
	`mtı_•Şl_wa™
(
mùx
, 
•
, 
ev’ts
, 
MAX_EVENTS
, -1);

128 ià(
Ãv’ts
 < 0) {

129 ià(
”ºo
 !ğ
EINTR
)

130 
	`³¼Ü
("mtcp_epoll_wait");

134 
i
=0;i<
Ãv’ts
;i++) {

135 ià(
ev’ts
[
i
].
d©a
.
sockid
 =ğ
li¡’”
) {

137 
Ãwsockfd
 = 
	`mtı_acû±
(
mùx
, 
li¡’”
, 
NULL
, NULL);

138 
	`TRACE_APP
("New cÚÃùiÚ %d‡cû±ed.\n", 
c
);

139 
ev
.
ev’ts
 = 
MTCP_EPOLLOUT
;

140 
ev
.
d©a
.
sockid
 = 
Ãwsockfd
;

141 
	`mtı_£tsock_nÚblock
(
mùx
, 
Ãwsockfd
);

142 
	`mtı_•Şl_ùl
(
mùx
, 
•
, 
MTCP_EPOLL_CTL_ADD
, 
Ãwsockfd
, &
ev
);

145 *
d©a
 = "hello";

146 
»t
 = 1;

147 
»t
 > 0) {

148 
»t
 = 
	`mtı_wr™e
(
mùx
, 
Ãwsockfd
, 
d©a
, 5);

149 ià(
»t
 < 0) {

150 
	`TRACE_APP
("Connection closed with client.\n");

155 ià(
ev’ts
[
i
].ev’t & 
MTCP_EPOLLOUT
) {

157 
cout
 << "IÀh”e." << 
’dl
;

158 *
d©a
 = "hello";

159 
»t
 = 1;

160 
»t
 > 0) {

161 
»t
 = 
	`mtı_wr™e
(
mùx
, 
Ãwsockfd
, 
d©a
, 5);

162 ià(
»t
 < 0) {

163 
	`TRACE_APP
("Connection closed with client.\n");

172 
	`mtı_de¡roy_cÚ‹xt
(
mùx
);

173 
	}
}

175 
	$maš
(
¬gc
, **
¬gv
){

177 
cÜe
 = 0;

178 
»t
 = -1;

181 ià(
¬gc
 != 2) {

182 
	`årštf
(
¡d”r
,"u§ge: <pÜt>\n", 
¬gv
[0]);

183 
	`ex™
(0);

185 
pÜŠo
 = 
	`©oi
(
¬gv
[1]);

187 * 
cÚf_fe
 = "server.conf";

189 ià(
cÚf_fe
 =ğ
NULL
) {

190 
	`TRACE_CONFIG
("You forgoto…asshe mTCP startup config file!\n");

191 
	`ex™
(
EXIT_FAILURE
);

194 
	`TRACE_INFO
("R—dšg cÚfigu¿tiÚ from %s\n",
cÚf_fe
);

197 
»t
 = 
	`mtı_š™
(
cÚf_fe
);

198 ià(
»t
) {

199 
	`TRACE_CONFIG
("Failedo initialize mtcp\n");

200 
	`ex™
(
EXIT_FAILURE
);

204 
	`mtı_»gi¡”_sigÇl
(
SIGINT
, 
SigÇlHªdËr
);

206 
	`TRACE_INFO
("Application initialization finished.\n");

207 
i
=0;i<
MAX_THREADS
;i++){

208 
dÚe
[
i
] = 0;

211 
i
=0;i<
MAX_THREADS
;i++){

212 
¬gum’ts
[
i
].
cÜ’o
 = i;

213 
¬gum’ts
[
i
].
id
 = i;

214 
	`±h»ad_ü—‹
(&
£rv”s
[
i
],
NULL
,
£rv”Th»adFunc
,&
¬gum’ts
[i]);

218 
i
=0;i<
MAX_THREADS
;i++){

219 
	`±h»ad_još
(
£rv”s
[
i
],
NULL
);

222 
	}
}

	@timer.cpp

1 
	~"tim”.h
"

2 
	~"tı_š.h
"

3 
	~"tı_out.h
"

4 
	~"¡©.h
"

5 
	~"debug.h
"

7 
	#MAX
(
a
, 
b
è(×)>(b)?×):(b))

	)

8 
	#MIN
(
a
, 
b
è(×)<(b)?×):(b))

	)

11 
¹o_hash¡Üe
*

12 
	$In™RTOHash¡Üe
()

14 
i
;

15 
¹o_hash¡Üe
* 
hs
 = 
	`ÿÎoc
(1, (rto_hashstore));

16 ià(!
hs
) {

17 
	`TRACE_ERROR
("calloc: InitHashStore");

21 
i
 = 0; i < 
RTO_HASH
; i++)

22 
	`TAILQ_INIT
(&
hs
->
¹o_li¡
[
i
]);

24 
	`TAILQ_INIT
(&
hs
->
¹o_li¡
[
RTO_HASH
]);

26  
hs
;

27 
	}
}

30 
	$AddtoRTOLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

32 ià(!
mtı
->
¹o_li¡_út
) {

33 
mtı
->
¹o_¡Üe
->
¹o_now_idx
 = 0;

34 
mtı
->
¹o_¡Üe
->
¹o_now_ts
 = 
cur_¡»am
->
¢dv¬
->
ts_¹o
;

37 ià(
cur_¡»am
->
Ú_¹o_idx
 < 0 ) {

38 ià(
cur_¡»am
->
Ú_timewa™_li¡
) {

39 
	`TRACE_ERROR
("Stream %u: cannot be in both "

40 "¹Øªdimewa™†i¡.\n", 
cur_¡»am
->
id
);

41 #ifdeà
DUMP_STREAM


42 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

47 
diff
 = (
št32_t
)(
cur_¡»am
->
¢dv¬
->
ts_¹o
 - 
mtı
->
¹o_¡Üe
->
¹o_now_ts
);

48 ià(
diff
 < 
RTO_HASH
) {

49 
off£t
ğ(
diff
 + 
mtı
->
¹o_¡Üe
->
¹o_now_idx
è% 
RTO_HASH
;

50 
cur_¡»am
->
Ú_¹o_idx
 = 
off£t
;

51 
	`TAILQ_INSERT_TAIL
(&(
mtı
->
¹o_¡Üe
->
¹o_li¡
[
off£t
]),

52 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

54 
cur_¡»am
->
Ú_¹o_idx
 = 
RTO_HASH
;

55 
	`TAILQ_INSERT_TAIL
(&(
mtı
->
¹o_¡Üe
->
¹o_li¡
[
RTO_HASH
]),

56 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

58 
mtı
->
¹o_li¡_út
++;

60 
	}
}

63 
	$RemoveFromRTOLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

65 ià(
cur_¡»am
->
Ú_¹o_idx
 < 0) {

70 
	`TAILQ_REMOVE
(&
mtı
->
¹o_¡Üe
->
¹o_li¡
[
cur_¡»am
->
Ú_¹o_idx
],

71 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

72 
cur_¡»am
->
Ú_¹o_idx
 = -1;

74 
mtı
->
¹o_li¡_út
--;

75 
	}
}

78 
	$AddtoTimewa™Li¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
)

80 
cur_¡»am
->
rcvv¬
->
ts_tw_expœe
 = 
cur_ts
 + 
CONFIG
.
tı_timewa™
;

82 ià(
cur_¡»am
->
Ú_timewa™_li¡
) {

84 
	`TAILQ_REMOVE
(&
mtı
->
timewa™_li¡
, 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

85 
	`TAILQ_INSERT_TAIL
(&
mtı
->
timewa™_li¡
, 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

87 ià(
cur_¡»am
->
Ú_¹o_idx
 >= 0) {

88 
	`TRACE_DBG
("Stream %u: cannot be in both "

89 "timewa™‡nd„tØli¡.\n", 
cur_¡»am
->
id
);

91 #ifdeà
DUMP_STREAM


92 
	`DumpSŒ—m
(
mtı
, 
cur_¡»am
);

94 
	`RemoveFromRTOLi¡
(
mtı
, 
cur_¡»am
);

97 
cur_¡»am
->
Ú_timewa™_li¡
 = 
TRUE
;

98 
	`TAILQ_INSERT_TAIL
(&
mtı
->
timewa™_li¡
, 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

99 
mtı
->
timewa™_li¡_út
++;

101 
	}
}

104 
	$RemoveFromTimewa™Li¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

106 ià(!
cur_¡»am
->
Ú_timewa™_li¡
) {

107 
	`as£¹
(0);

111 
	`TAILQ_REMOVE
(&
mtı
->
timewa™_li¡
, 
cur_¡»am
, 
¢dv¬
->
tim”_lšk
);

112 
cur_¡»am
->
Ú_timewa™_li¡
 = 
FALSE
;

113 
mtı
->
timewa™_li¡_út
--;

114 
	}
}

117 
	$AddtoTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

119 ià(
cur_¡»am
->
Ú_timeout_li¡
) {

120 
	`as£¹
(0);

124 
cur_¡»am
->
Ú_timeout_li¡
 = 
TRUE
;

125 
	`TAILQ_INSERT_TAIL
(&
mtı
->
timeout_li¡
, 
cur_¡»am
, 
¢dv¬
->
timeout_lšk
);

126 
mtı
->
timeout_li¡_út
++;

127 
	}
}

130 
	$RemoveFromTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

132 ià(
cur_¡»am
->
Ú_timeout_li¡
) {

133 
cur_¡»am
->
Ú_timeout_li¡
 = 
FALSE
;

134 
	`TAILQ_REMOVE
(&
mtı
->
timeout_li¡
, 
cur_¡»am
, 
¢dv¬
->
timeout_lšk
);

135 
mtı
->
timeout_li¡_út
--;

137 
	}
}

140 
	$Upd©eTimeoutLi¡
(
mtı_mªag”_t
 
mtı
, 
tı_¡»am
 *
cur_¡»am
)

142 ià(
cur_¡»am
->
Ú_timeout_li¡
) {

143 
	`TAILQ_REMOVE
(&
mtı
->
timeout_li¡
, 
cur_¡»am
, 
¢dv¬
->
timeout_lšk
);

144 
	`TAILQ_INSERT_TAIL
(&
mtı
->
timeout_li¡
, 
cur_¡»am
, 
¢dv¬
->
timeout_lšk
);

146 
	}
}

149 
	$Upd©eR‘¿nsmissiÚTim”
(
mtı_mªag”_t
 
mtı
,

150 
tı_¡»am
 *
cur_¡»am
, 
ušt32_t
 
cur_ts
)

153 
	`as£¹
(
cur_¡»am
->
¢dv¬
->
¹o
 > 0);

154 
cur_¡»am
->
¢dv¬
->
Ätx
 = 0;

157 ià(
cur_¡»am
->
Ú_¹o_idx
 >= 0) {

158 
	`RemoveFromRTOLi¡
(
mtı
, 
cur_¡»am
);

162 ià(
	`TCP_SEQ_GT
(
cur_¡»am
->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
)) {

165 
cur_¡»am
->
¢dv¬
->
ts_¹o
 = 
cur_ts
 + cur_¡»am->¢dv¬->
¹o
;

166 
	`AddtoRTOLi¡
(
mtı
, 
cur_¡»am
);

170 
	`TRACE_RTO
("All…ackets‡re‡cked. snd_una: %u, snd_nxt: %u\n",

171 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
, cur_¡»am->
¢d_nxt
);

173 
	}
}

176 
	$HªdËRTO
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
tı_¡»am
 *
cur_¡»am
)

178 
ušt8_t
 
backoff
;

180 
	`TRACE_RTO
("Stream %d Timeout!„to: %u (%ums), snd_una: %u, snd_nxt: %u\n",

181 
cur_¡»am
->
id
, cur_¡»am->
¢dv¬
->
¹o
, 
	`TS_TO_MSEC
(cur_stream->sndvar->rto),

182 
cur_¡»am
->
¢dv¬
->
¢d_uÇ
, cur_¡»am->
¢d_nxt
);

183 
	`as£¹
(
cur_¡»am
->
¢dv¬
->
¹o
 > 0);

186 ià(
cur_¡»am
->
¢dv¬
->
Ätx
 < 
TCP_MAX_RTX
) {

187 
cur_¡»am
->
¢dv¬
->
Ätx
++;

190 
	`TRACE_RTO
("SŒ—m %d: Exûed MAX_RTX\n", 
cur_¡»am
->
id
);

191 ià(
cur_¡»am
->
¡©e
 < 
TCP_ST_ESTABLISHED
) {

192 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

193 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_CONN_FAIL
;

194 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

196 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

197 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_CONN_LOST
;

198 ià(
cur_¡»am
->
sock‘
) {

199 
	`Rai£E¼ÜEv’t
(
mtı
, 
cur_¡»am
);

201 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

205  
ERROR
;

207 ià(
cur_¡»am
->
¢dv¬
->
Ätx
 > cur_¡»am->¢dv¬->
max_Ätx
) {

208 
cur_¡»am
->
¢dv¬
->
max_Ätx
 = cur_¡»am->¢dv¬->
Ätx
;

212 ià(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_ESTABLISHED
) {

213 
ušt32_t
 
¹o_´ev
;

214 
backoff
 = 
	`MIN
(
cur_¡»am
->
¢dv¬
->
Ätx
, 
TCP_MAX_BACKOFF
);

216 
¹o_´ev
 = 
cur_¡»am
->
¢dv¬
->
¹o
;

217 
cur_¡»am
->
¢dv¬
->
¹o
 = ((cur_¡»am->
rcvv¬
->
¤‰
 >> 3) +

218 
cur_¡»am
->
rcvv¬
->
¹tv¬
è<< 
backoff
;

219 ià(
cur_¡»am
->
¢dv¬
->
¹o
 <= 0) {

220 
	`TRACE_RTO
("Stream %d current„to: %u,…rev: %u, state: %s\n",

221 
cur_¡»am
->
id
, cur_¡»am->
¢dv¬
->
¹o
, 
¹o_´ev
,

222 
	`TCPS‹ToSŒšg
(
cur_¡»am
));

223 
cur_¡»am
->
¢dv¬
->
¹o
 = 
¹o_´ev
;

225 } ià(
cur_¡»am
->
¡©e
 >ğ
TCP_ST_SYN_SENT
) {

227 ià(
cur_¡»am
->
¢dv¬
->
Ätx
 < 
TCP_MAX_BACKOFF
) {

228 
cur_¡»am
->
¢dv¬
->
¹o
 <<= 1;

234 
cur_¡»am
->
¢dv¬
->
s¡h»sh
 = 
	`MIN
(cur_¡»am->¢dv¬->
cwnd
, cur_¡»am->¢dv¬->
³”_wnd
) / 2;

235 ià(
cur_¡»am
->
¢dv¬
->
s¡h»sh
 < (2 * cur_¡»am->¢dv¬->
mss
)) {

236 
cur_¡»am
->
¢dv¬
->
s¡h»sh
 = cur_¡»am->¢dv¬->
mss
 * 2;

238 
cur_¡»am
->
¢dv¬
->
cwnd
 = cur_¡»am->¢dv¬->
mss
;

239 
	`TRACE_CONG
("Stream %d Timeout. cwnd: %u, ssthresh: %u\n",

240 
cur_¡»am
->
id
, cur_¡»am->
¢dv¬
->
cwnd
, cur_¡»am->¢dv¬->
s¡h»sh
);

242 #ià
RTM_STAT


244 
cur_¡»am
->
¢dv¬
->
r¡©
.
¹o_út
++;

245 
cur_¡»am
->
¢dv¬
->
r¡©
.
¹o_by‹s
 +ğ(cur_¡»am->
¢d_nxt
 - cur_¡»am->¢dv¬->
¢d_uÇ
);

249 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_SENT
) {

251 ià(
cur_¡»am
->
¢dv¬
->
Ätx
 > 
TCP_MAX_SYN_RETRY
) {

252 
cur_¡»am
->
¡©e
 = 
TCP_ST_CLOSED
;

253 
cur_¡»am
->
şo£_»asÚ
 = 
TCP_CONN_FAIL
;

254 
	`TRACE_RTO
("Stream %d: SYN„etriesƒxceed maximum„etries.\n",

255 
cur_¡»am
->
id
);

256 ià(
cur_¡»am
->
sock‘
) {

257 
	`Rai£E¼ÜEv’t
(
mtı
, 
cur_¡»am
);

259 
	`De¡royTCPSŒ—m
(
mtı
, 
cur_¡»am
);

262  
ERROR
;

264 
	`TRACE_RTO
("Stream %d Retransmit SYN. snd_nxt: %u, snd_una: %u\n",

265 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

267 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_SYN_RCVD
) {

269 
	`TRACE_RTO
("Stream %d: Retransmit SYN/ACK. snd_nxt: %u, snd_una: %u\n",

270 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

272 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
) {

274 
	`TRACE_RTO
("Stream %d: Retransmit data. snd_nxt: %u, snd_una: %u\n",

275 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

277 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

279 
	`TRACE_RTO
("Stream %d: Retransmit data. snd_nxt: %u, snd_una: %u\n",

280 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

282 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
) {

284 
	`TRACE_RTO
("Stream %d: Retransmit FIN/ACK. "

286 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

288 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
) {

290 
	`TRACE_RTO
("Stream %d: Retransmit FIN. snd_nxt: %u, snd_una: %u\n",

291 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

292 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
) {

293 
	`TRACE_RTO
("Stream %d: Retransmit ACK. snd_nxt: %u, snd_una: %u\n",

294 
cur_¡»am
->
id
, cur_¡»am->
¢d_nxt
, cur_¡»am->
¢dv¬
->
¢d_uÇ
);

298 
	`TRACE_ERROR
("Stream %d:‚ot implemented state! state: %s,„to: %u\n",

299 
cur_¡»am
->
id
,

300 
	`TCPS‹ToSŒšg
(
cur_¡»am
), cur_¡»am->
¢dv¬
->
¹o
);

301 
	`as£¹
(0);

302  
ERROR
;

305 
cur_¡»am
->
¢d_nxt
 = cur_¡»am->
¢dv¬
->
¢d_uÇ
;

306 ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_ESTABLISHED
 ||

307 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSE_WAIT
) {

309 
	`AddtoS’dLi¡
(
mtı
, 
cur_¡»am
);

311 } ià(
cur_¡»am
->
¡©e
 =ğ
TCP_ST_FIN_WAIT_1
 ||

312 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_CLOSING
 ||

313 
cur_¡»am
->
¡©e
 =ğ
TCP_ST_LAST_ACK
) {

315 ià(
cur_¡»am
->
¢dv¬
->
fss
 == 0) {

316 
	`TRACE_ERROR
("SŒ—m %u: fs nÙ s‘.\n", 
cur_¡»am
->
id
);

319 ià(
	`TCP_SEQ_LT
(
cur_¡»am
->
¢d_nxt
, cur_¡»am->
¢dv¬
->
fss
)) {

321 ià(
cur_¡»am
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

322 
	`RemoveFromCÚŒŞLi¡
(
mtı
, 
cur_¡»am
);

324 
cur_¡»am
->
cÚŒŞ_li¡_wa™šg
 = 
TRUE
;

325 
	`AddtoS’dLi¡
(
mtı
, 
cur_¡»am
);

329 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

333 
	`AddtoCÚŒŞLi¡
(
mtı
, 
cur_¡»am
, 
cur_ts
);

337 
	}
}

339 
šlše
 

340 
	$R—¼ªgeRTOStÜe
(
mtı_mªag”_t
 
mtı
) {

341 
tı_¡»am
 *
w®k
, *
Ãxt
;

342 
¹o_hash¡Üe
::
¹o_h—d
* 
¹o_li¡
 = &
mtı
->
¹o_¡Üe
->¹o_li¡[
RTO_HASH
];

343 
út
 = 0;

345 
w®k
 = 
	`TAILQ_FIRST
(
¹o_li¡
);

346 
w®k
 !ğ
NULL
; w®k = 
Ãxt
) {

347 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
¢dv¬
->
tim”_lšk
);

349 
diff
 = (
št32_t
)(
mtı
->
¹o_¡Üe
->
¹o_now_ts
 - 
w®k
->
¢dv¬
->
ts_¹o
);

350 ià(
diff
 < 
RTO_HASH
) {

351 
off£t
 = (
diff
 + 
mtı
->
¹o_¡Üe
->
¹o_now_idx
è% 
RTO_HASH
;

352 
	`TAILQ_REMOVE
(&
mtı
->
¹o_¡Üe
->
¹o_li¡
[
RTO_HASH
],

353 
w®k
, 
¢dv¬
->
tim”_lšk
);

354 
w®k
->
Ú_¹o_idx
 = 
off£t
;

355 
	`TAILQ_INSERT_TAIL
(&(
mtı
->
¹o_¡Üe
->
¹o_li¡
[
off£t
]),

356 
w®k
, 
¢dv¬
->
tim”_lšk
);

358 
út
++;

360 
	}
}

363 
	$CheckRtmTimeout
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
)

365 
tı_¡»am
 *
w®k
, *
Ãxt
;

366 
¹o_hash¡Üe
::
¹o_h—d
* 
¹o_li¡
;

367 
út
;

369 ià(!
mtı
->
¹o_li¡_út
) {

373 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_¹ocheck
);

375 
út
 = 0;

379 
¹o_li¡
 = &
mtı
->
¹o_¡Üe
->¹o_li¡[mtı->¹o_¡Üe->
¹o_now_idx
];

380 ià((
št32_t
)(
cur_ts
 - 
mtı
->
¹o_¡Üe
->
¹o_now_ts
) < 0) {

384 
w®k
 = 
	`TAILQ_FIRST
(
¹o_li¡
);

385 
w®k
 !ğ
NULL
; w®k = 
Ãxt
) {

386 ià(++
út
 > 
th»sh
) {

389 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
¢dv¬
->
tim”_lšk
);

391 
	`TRACE_LOOP
("Inside„to†ist. cnt: %u, stream: %d\n",

392 
út
, 
w®k
->
s_id
);

394 ià(
w®k
->
Ú_¹o_idx
 >= 0) {

395 
	`TAILQ_REMOVE
(
¹o_li¡
, 
w®k
, 
¢dv¬
->
tim”_lšk
);

396 
mtı
->
¹o_li¡_út
--;

397 
w®k
->
Ú_¹o_idx
 = -1;

398 
	`HªdËRTO
(
mtı
, 
cur_ts
, 
w®k
);

400 
	`TRACE_ERROR
("SŒ—m %d:‚Ù oÀ¹Øli¡.\n", 
w®k
->
id
);

401 #ifdeà
DUMP_STREAM


402 
	`DumpSŒ—m
(
mtı
, 
w®k
);

407 ià(
út
 > 
th»sh
) {

410 
mtı
->
¹o_¡Üe
->
¹o_now_idx
 = (mtı->¹o_¡Üe->¹o_now_idx + 1è% 
RTO_HASH
;

411 
mtı
->
¹o_¡Üe
->
¹o_now_ts
++;

412 ià(!(
mtı
->
¹o_¡Üe
->
¹o_now_idx
 % 1000)) {

413 
	`R—¼ªgeRTOStÜe
(
mtı
);

419 
	`TRACE_ROUND
("Checkšg„‘¿nsmissiÚimeout. cÁ: %d\n", 
út
);

420 
	}
}

423 
	$CheckTimewa™Expœe
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
)

425 
tı_¡»am
 *
w®k
, *
Ãxt
;

426 
út
;

428 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_twcheck
);

430 
út
 = 0;

432 
w®k
 = 
	`TAILQ_FIRST
(&
mtı
->
timewa™_li¡
);

433 
w®k
 !ğ
NULL
; w®k = 
Ãxt
) {

434 ià(++
út
 > 
th»sh
)

436 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
¢dv¬
->
tim”_lšk
);

438 
	`TRACE_LOOP
("Insideimewait†ist. cnt: %u, stream: %d\n",

439 
út
, 
w®k
->
s_id
);

441 ià(
w®k
->
Ú_timewa™_li¡
) {

442 ià((
št32_t
)(
cur_ts
 - 
w®k
->
rcvv¬
->
ts_tw_expœe
) >= 0) {

443 ià(!
w®k
->
¢dv¬
->
Ú_cÚŒŞ_li¡
) {

445 
	`TAILQ_REMOVE
(&
mtı
->
timewa™_li¡
, 
w®k
, 
¢dv¬
->
tim”_lšk
);

446 
w®k
->
Ú_timewa™_li¡
 = 
FALSE
;

447 
mtı
->
timewa™_li¡_út
--;

449 
w®k
->
¡©e
 = 
TCP_ST_CLOSED
;

450 
w®k
->
şo£_»asÚ
 = 
TCP_ACTIVE_CLOSE
;

451 
	`TRACE_STATE
("SŒ—m %d: TCP_ST_CLOSED\n", 
w®k
->
id
);

452 
	`De¡royTCPSŒ—m
(
mtı
, 
w®k
);

458 
	`TRACE_ERROR
("SŒ—m %d:‚Ù oÀtimewa™†i¡.\n", 
w®k
->
id
);

459 #ifdeà
DUMP_STREAM


460 
	`DumpSŒ—m
(
mtı
, 
w®k
);

465 
	`TRACE_ROUND
("Checkšgimewa™imeout. cÁ: %d\n", 
út
);

466 
	}
}

469 
	$CheckCÚÃùiÚTimeout
(
mtı_mªag”_t
 
mtı
, 
ušt32_t
 
cur_ts
, 
th»sh
)

471 
tı_¡»am
 *
w®k
, *
Ãxt
;

472 
út
;

474 
	`STAT_COUNT
(
mtı
->
run¡©
.
rounds_tocheck
);

476 
út
 = 0;

477 
w®k
 = 
	`TAILQ_FIRST
(&
mtı
->
timeout_li¡
);

478 
w®k
 !ğ
NULL
; w®k = 
Ãxt
) {

479 ià(++
út
 > 
th»sh
)

481 
Ãxt
 = 
	`TAILQ_NEXT
(
w®k
, 
¢dv¬
->
timeout_lšk
);

483 ià((
št32_t
)(
cur_ts
 - 
w®k
->
Ï¡_aùive_ts
) >=

484 
CONFIG
.
tı_timeout
) {

486 
w®k
->
Ú_timeout_li¡
 = 
FALSE
;

487 
	`TAILQ_REMOVE
(&
mtı
->
timeout_li¡
, 
w®k
, 
¢dv¬
->
timeout_lšk
);

488 
mtı
->
timeout_li¡_út
--;

489 
w®k
->
¡©e
 = 
TCP_ST_CLOSED
;

490 
w®k
->
şo£_»asÚ
 = 
TCP_TIMEDOUT
;

491 ià(
w®k
->
sock‘
) {

492 
	`Rai£E¼ÜEv’t
(
mtı
, 
w®k
);

494 
	`De¡royTCPSŒ—m
(
mtı
, 
w®k
);

501 
	}
}

	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


88 
	#as£¹
(
ex´
) \

89 ((
ex´
) \

90 ? 
	`__ASSERT_VOID_CAST
 (0) \

91 : 
	`__as£¹_ç
 (
	`__STRING
(
ex´
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

93 #ifdef 
__USE_GNU


94 
	#as£¹_³¼Ü
(
”ºum
) \

95 (!(
”ºum
) \

96 ? 
	`__ASSERT_VOID_CAST
 (0) \

97 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

105 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

106 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

108 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

109 
	#__ASSERT_FUNCTION
 
__func__


	)

111 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

118 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


120 #undeà
¡©ic_as£¹


121 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/dirent.h

22 #iâdef 
_DIRENT_H


23 
	#_DIRENT_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/ty³s.h
>

31 #ifdeà
__USE_XOPEN


32 #iâdeà
__šo_t_defšed


33 #iâdeà
__USE_FILE_OFFSET64


34 
__šo_t
 
	tšo_t
;

36 
__šo64_t
 
	tšo_t
;

38 
	#__šo_t_defšed


	)

40 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__šo64_t_defšed


41 
__šo64_t
 
	tšo64_t
;

42 
	#__šo64_t_defšed


	)

61 
	~<b™s/dœ’t.h
>

63 #ià(
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
è&& !defšed 
d_f’o


64 
	#d_šo
 
d_f’o


	)

81 #ifdeà
_DIRENT_HAVE_D_NAMLEN


82 
	#_D_EXACT_NAMLEN
(
d
è((d)->
d_ÇmËn
)

	)

83 
	#_D_ALLOC_NAMLEN
(
d
è(
	`_D_EXACT_NAMLEN
 (dè+ 1)

	)

85 
	#_D_EXACT_NAMLEN
(
d
è(
	`¡¾’
 ((d)->
d_Çme
))

	)

86 #ifdeà
_DIRENT_HAVE_D_RECLEN


87 
	#_D_ALLOC_NAMLEN
(
d
è(((*è(dè+ (d)->
d_»ş’
è- &(d)->
d_Çme
[0])

	)

89 
	#_D_ALLOC_NAMLEN
(
d
è( (d)->
d_Çme
 > 1 ?  (d)->d_name : \

90 
	`_D_EXACT_NAMLEN
 (
d
è+ 1)

	)

95 #ifdeà
__USE_BSD


99 
	mDT_UNKNOWN
 = 0,

100 
	#DT_UNKNOWN
 
DT_UNKNOWN


	)

101 
	mDT_FIFO
 = 1,

102 
	#DT_FIFO
 
DT_FIFO


	)

103 
	mDT_CHR
 = 2,

104 
	#DT_CHR
 
DT_CHR


	)

105 
	mDT_DIR
 = 4,

106 
	#DT_DIR
 
DT_DIR


	)

107 
	mDT_BLK
 = 6,

108 
	#DT_BLK
 
DT_BLK


	)

109 
	mDT_REG
 = 8,

110 
	#DT_REG
 
DT_REG


	)

111 
	mDT_LNK
 = 10,

112 
	#DT_LNK
 
DT_LNK


	)

113 
	mDT_SOCK
 = 12,

114 
	#DT_SOCK
 
DT_SOCK


	)

115 
	mDT_WHT
 = 14

116 
	#DT_WHT
 
DT_WHT


	)

120 
	#IFTODT
(
mode
è(((modeè& 0170000è>> 12)

	)

121 
	#DTTOIF
(
dœty³
è((dœty³è<< 12)

	)

127 
__dœ¡»am
 
	tDIR
;

134 
DIR
 *
	$İ’dœ
 (cÚ¡ *
__Çme
è
	`__nÚnuÎ
 ((1));

136 #ifdeà
__USE_XOPEN2K8


141 
DIR
 *
	`fdİ’dœ
 (
__fd
);

149 
	$şo£dœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

161 #iâdeà
__USE_FILE_OFFSET64


162 
dœ’t
 *
	$»addœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

164 #ifdeà
__REDIRECT


165 
dœ’t
 *
	`__REDIRECT
 (
»addœ
, (
DIR
 *
__dœp
), 
»addœ64
)

166 
	`__nÚnuÎ
 ((1));

168 
	#»addœ
 
»addœ64


	)

172 #ifdeà
__USE_LARGEFILE64


173 
dœ’t64
 *
	$»addœ64
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

176 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


182 #iâdeà
__USE_FILE_OFFSET64


183 
	$»addœ_r
 (
DIR
 *
__»¡riù
 
__dœp
,

184 
dœ’t
 *
__»¡riù
 
__’Œy
,

185 
dœ’t
 **
__»¡riù
 
__»suÉ
)

186 
	`__nÚnuÎ
 ((1, 2, 3));

188 #ifdeà
__REDIRECT


189 
	`__REDIRECT
 (
»addœ_r
,

190 (
DIR
 *
__»¡riù
 
__dœp
,

191 
dœ’t
 *
__»¡riù
 
__’Œy
,

192 
dœ’t
 **
__»¡riù
 
__»suÉ
),

193 
»addœ64_r
è
	`__nÚnuÎ
 ((1, 2, 3));

195 
	#»addœ_r
 
»addœ64_r


	)

199 #ifdeà
__USE_LARGEFILE64


200 
	$»addœ64_r
 (
DIR
 *
__»¡riù
 
__dœp
,

201 
dœ’t64
 *
__»¡riù
 
__’Œy
,

202 
dœ’t64
 **
__»¡riù
 
__»suÉ
)

203 
	`__nÚnuÎ
 ((1, 2, 3));

208 
	$»wšddœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

210 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


211 
	~<b™s/ty³s.h
>

214 
	$£ekdœ
 (
DIR
 *
__dœp
, 
__pos
è
__THROW
 
	`__nÚnuÎ
 ((1));

217 
	$‹Îdœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

220 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN2K8


223 
	$dœfd
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 #ià
defšed
 
__OPTIMIZE__
 && defšed 
_DIR_dœfd


226 
	#dœfd
(
dœp
è
	`_DIR_dœfd
 (dœp)

	)

229 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC


230 #iâdeà
MAXNAMLEN


232 
	~<b™s/posix1_lim.h
>

235 #ifdeà
NAME_MAX


236 
	#MAXNAMLEN
 
NAME_MAX


	)

238 
	#MAXNAMLEN
 255

	)

243 
	#__Ãed_size_t


	)

244 
	~<¡ddef.h
>

253 #iâdeà
__USE_FILE_OFFSET64


254 
	`sÿndœ
 (cÚ¡ *
__»¡riù
 
__dœ
,

255 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

256 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

257 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

258 cÚ¡ 
dœ’t
 **))

259 
	`__nÚnuÎ
 ((1, 2));

261 #ifdeà
__REDIRECT


262 
	`__REDIRECT
 (
sÿndœ
,

263 (cÚ¡ *
__»¡riù
 
__dœ
,

264 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

265 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

266 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

267 cÚ¡ 
dœ’t
 **)),

268 
sÿndœ64
è
	`__nÚnuÎ
 ((1, 2));

270 
	#sÿndœ
 
sÿndœ64


	)

274 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


277 
	`sÿndœ64
 (cÚ¡ *
__»¡riù
 
__dœ
,

278 
dœ’t64
 ***
__»¡riù
 
__Çm–i¡
,

279 (*
__£ËùÜ
è(cÚ¡ 
dœ’t64
 *),

280 (*
__cmp
è(cÚ¡ 
dœ’t64
 **,

281 cÚ¡ 
dœ’t64
 **))

282 
	`__nÚnuÎ
 ((1, 2));

285 #ifdeà
__USE_GNU


291 #iâdeà
__USE_FILE_OFFSET64


292 
	`sÿndœ©
 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

293 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

294 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

295 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

296 cÚ¡ 
dœ’t
 **))

297 
	`__nÚnuÎ
 ((2, 3));

299 #ifdeà
__REDIRECT


300 
	`__REDIRECT
 (
sÿndœ©
,

301 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

302 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

303 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

304 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

305 cÚ¡ 
dœ’t
 **)),

306 
sÿndœ©64
è
	`__nÚnuÎ
 ((2, 3));

308 
	#sÿndœ©
 
sÿndœ©64


	)

314 
	`sÿndœ©64
 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

315 
dœ’t64
 ***
__»¡riù
 
__Çm–i¡
,

316 (*
__£ËùÜ
è(cÚ¡ 
dœ’t64
 *),

317 (*
__cmp
è(cÚ¡ 
dœ’t64
 **,

318 cÚ¡ 
dœ’t64
 **))

319 
	`__nÚnuÎ
 ((2, 3));

323 #iâdeà
__USE_FILE_OFFSET64


324 
	$®phasÜt
 (cÚ¡ 
dœ’t
 **
__e1
,

325 cÚ¡ 
dœ’t
 **
__e2
)

326 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

328 #ifdeà
__REDIRECT


329 
	`__REDIRECT_NTH
 (
®phasÜt
,

330 (cÚ¡ 
dœ’t
 **
__e1
,

331 cÚ¡ 
dœ’t
 **
__e2
),

332 
®phasÜt64
è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

334 
	#®phasÜt
 
®phasÜt64


	)

338 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


339 
	$®phasÜt64
 (cÚ¡ 
dœ’t64
 **
__e1
,

340 cÚ¡ 
dœ’t64
 **
__e2
)

341 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

346 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC


351 #iâdeà
__USE_FILE_OFFSET64


352 
__ssize_t
 
	$g‘dœ’Œ›s
 (
__fd
, *
__»¡riù
 
__buf
,

353 
size_t
 
__nby‹s
,

354 
__off_t
 *
__»¡riù
 
__ba£p
)

355 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

357 #ifdeà
__REDIRECT


358 
__ssize_t
 
	`__REDIRECT_NTH
 (
g‘dœ’Œ›s
,

359 (
__fd
, *
__»¡riù
 
__buf
,

360 
size_t
 
__nby‹s
,

361 
__off64_t
 *
__»¡riù
 
__ba£p
),

362 
g‘dœ’Œ›s64
è
	`__nÚnuÎ
 ((2, 4));

364 
	#g‘dœ’Œ›s
 
g‘dœ’Œ›s64


	)

368 #ifdeà
__USE_LARGEFILE64


369 
__ssize_t
 
	$g‘dœ’Œ›s64
 (
__fd
, *
__»¡riù
 
__buf
,

370 
size_t
 
__nby‹s
,

371 
__off64_t
 *
__»¡riù
 
__ba£p
)

372 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

376 #ifdeà
__USE_GNU


378 #iâdeà
__USE_FILE_OFFSET64


379 
	$v”siÚsÜt
 (cÚ¡ 
dœ’t
 **
__e1
,

380 cÚ¡ 
dœ’t
 **
__e2
)

381 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

383 #ifdeà
__REDIRECT


384 
	`__REDIRECT_NTH
 (
v”siÚsÜt
,

385 (cÚ¡ 
dœ’t
 **
__e1
,

386 cÚ¡ 
dœ’t
 **
__e2
),

387 
v”siÚsÜt64
)

388 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

390 
	#v”siÚsÜt
 
v”siÚsÜt64


	)

394 #ifdeà
__USE_LARGEFILE64


395 
	$v”siÚsÜt64
 (cÚ¡ 
dœ’t64
 **
__e1
,

396 cÚ¡ 
dœ’t64
 **
__e2
)

397 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

401 
__END_DECLS


	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


26 #iâdef 
__Ãed_Em©h


27 
	#_ERRNO_H
 1

	)

28 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


35 
	~<b™s/”ºo.h
>

36 #undeà
__Ãed_Em©h


38 #ifdef 
_ERRNO_H


45 #iâdef 
”ºo


46 
”ºo
;

49 #ifdeà
__USE_GNU


54 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

58 
	g__END_DECLS


66 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


67 #iâdeà
__”rÜ_t_defšed


68 
	t”rÜ_t
;

69 
	#__”rÜ_t_defšed
 1

	)

71 #undeà
__Ãed_”rÜ_t


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

40 #iâdeà
__mode_t_defšed


41 
__mode_t
 
	tmode_t
;

42 
	#__mode_t_defšed


	)

45 #iâdeà
__off_t_defšed


46 #iâdeà
__USE_FILE_OFFSET64


47 
__off_t
 
	toff_t
;

49 
__off64_t
 
	toff_t
;

51 
	#__off_t_defšed


	)

54 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


55 
__off64_t
 
	toff64_t
;

56 
	#__off64_t_defšed


	)

59 #iâdeà
__pid_t_defšed


60 
__pid_t
 
	tpid_t
;

61 
	#__pid_t_defšed


	)

65 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


66 
	#__Ãed_time¥ec


	)

67 
	~<time.h
>

68 
	~<b™s/¡©.h
>

70 
	#S_IFMT
 
__S_IFMT


	)

71 
	#S_IFDIR
 
__S_IFDIR


	)

72 
	#S_IFCHR
 
__S_IFCHR


	)

73 
	#S_IFBLK
 
__S_IFBLK


	)

74 
	#S_IFREG
 
__S_IFREG


	)

75 #ifdeà
__S_IFIFO


76 
	#S_IFIFO
 
__S_IFIFO


	)

78 #ifdeà
__S_IFLNK


79 
	#S_IFLNK
 
__S_IFLNK


	)

81 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


82 
	#S_IFSOCK
 
__S_IFSOCK


	)

87 
	#S_ISUID
 
__S_ISUID


	)

88 
	#S_ISGID
 
__S_ISGID


	)

90 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


92 
	#S_ISVTX
 
__S_ISVTX


	)

95 
	#S_IRUSR
 
__S_IREAD


	)

96 
	#S_IWUSR
 
__S_IWRITE


	)

97 
	#S_IXUSR
 
__S_IEXEC


	)

99 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

101 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

102 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

103 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

105 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

107 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

108 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

109 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

111 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

114 #ifdef 
__USE_MISC


115 #iâdeà
R_OK


118 
	#R_OK
 4

	)

119 
	#W_OK
 2

	)

120 
	#X_OK
 1

	)

121 
	#F_OK
 0

	)

126 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


127 
	#SEEK_SET
 0

	)

128 
	#SEEK_CUR
 1

	)

129 
	#SEEK_END
 2

	)

137 
fú
 (
__fd
, 
__cmd
, ...);

145 #iâdeà
__USE_FILE_OFFSET64


146 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

148 #ifdeà
__REDIRECT


149 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

150 
	`__nÚnuÎ
 ((1));

152 
	#İ’
 
İ’64


	)

155 #ifdeà
__USE_LARGEFILE64


156 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

159 #ifdeà
__USE_ATFILE


169 #iâdeà
__USE_FILE_OFFSET64


170 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

171 
	`__nÚnuÎ
 ((2));

173 #ifdeà
__REDIRECT


174 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

175 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

177 
	#İ’©
 
İ’©64


	)

180 #ifdeà
__USE_LARGEFILE64


181 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

182 
	`__nÚnuÎ
 ((2));

191 #iâdeà
__USE_FILE_OFFSET64


192 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

194 #ifdeà
__REDIRECT


195 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

196 
ü—t64
è
	`__nÚnuÎ
 ((1));

198 
	#ü—t
 
ü—t64


	)

201 #ifdeà
__USE_LARGEFILE64


202 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

205 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

206 && !
defšed
 
__USE_POSIX
))

215 
	#F_ULOCK
 0

	)

216 
	#F_LOCK
 1

	)

217 
	#F_TLOCK
 2

	)

218 
	#F_TEST
 3

	)

220 #iâdeà
__USE_FILE_OFFSET64


221 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

223 #ifdeà
__REDIRECT


224 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

226 
	#lockf
 
lockf64


	)

229 #ifdeà
__USE_LARGEFILE64


230 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

234 #ifdeà
__USE_XOPEN2K


237 #iâdeà
__USE_FILE_OFFSET64


238 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

239 
__advi£
è
__THROW
;

241 #ifdeà
__REDIRECT_NTH


242 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

243 
__off64_t
 
__Ën
, 
__advi£
),

244 
posix_çdvi£64
);

246 
	#posix_çdvi£
 
posix_çdvi£64


	)

249 #ifdeà
__USE_LARGEFILE64


250 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

251 
__advi£
è
__THROW
;

259 #iâdeà
__USE_FILE_OFFSET64


260 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

262 #ifdeà
__REDIRECT


263 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

264 
__off64_t
 
__Ën
),

265 
posix_çÎoÿ‹64
);

267 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

270 #ifdeà
__USE_LARGEFILE64


271 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

277 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

278 && 
defšed
 
__va_¬g_·ck_Ën


279 
	~<b™s/fú2.h
>

282 
__END_DECLS


	@/usr/include/ifaddrs.h

19 #iâdeà
_IFADDRS_H


20 
	#_IFADDRS_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<sys/sock‘.h
>

25 
__BEGIN_DECLS


29 
	siçddrs


31 
içddrs
 *
	miç_Ãxt
;

33 *
	miç_Çme
;

34 
	miç_æags
;

36 
sockaddr
 *
	miç_addr
;

37 
sockaddr
 *
	miç_Ãtmask
;

44 
sockaddr
 *
	mifu_brßdaddr
;

45 
sockaddr
 *
	mifu_d¡addr
;

46 } 
	miç_ifu
;

49 #iâdeà
iç_brßdaddr


50 
	#iç_brßdaddr
 
iç_ifu
.
ifu_brßdaddr


	)

52 #iâdeà
iç_d¡addr


53 
	#iç_d¡addr
 
iç_ifu
.
ifu_d¡addr


	)

56 *
	miç_d©a
;

66 
	$g‘içddrs
 (
içddrs
 **
__içp
è
__THROW
;

69 
	$ä“içddrs
 (
içddrs
 *
__iç
è
__THROW
;

71 
__END_DECLS


	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/linux/if_ether.h

21 #iâdeà
_LINUX_IF_ETHER_H


22 
	#_LINUX_IF_ETHER_H


	)

24 
	~<lšux/ty³s.h
>

31 
	#ETH_ALEN
 6

	)

32 
	#ETH_HLEN
 14

	)

33 
	#ETH_ZLEN
 60

	)

34 
	#ETH_DATA_LEN
 1500

	)

35 
	#ETH_FRAME_LEN
 1514

	)

36 
	#ETH_FCS_LEN
 4

	)

42 
	#ETH_P_LOOP
 0x0060

	)

43 
	#ETH_P_PUP
 0x0200

	)

44 
	#ETH_P_PUPAT
 0x0201

	)

45 
	#ETH_P_IP
 0x0800

	)

46 
	#ETH_P_X25
 0x0805

	)

47 
	#ETH_P_ARP
 0x0806

	)

48 
	#ETH_P_BPQ
 0x08FF

	)

49 
	#ETH_P_IEEEPUP
 0x0a00

	)

50 
	#ETH_P_IEEEPUPAT
 0x0a01

	)

51 
	#ETH_P_BATMAN
 0x4305

	)

52 
	#ETH_P_DEC
 0x6000

	)

53 
	#ETH_P_DNA_DL
 0x6001

	)

54 
	#ETH_P_DNA_RC
 0x6002

	)

55 
	#ETH_P_DNA_RT
 0x6003

	)

56 
	#ETH_P_LAT
 0x6004

	)

57 
	#ETH_P_DIAG
 0x6005

	)

58 
	#ETH_P_CUST
 0x6006

	)

59 
	#ETH_P_SCA
 0x6007

	)

60 
	#ETH_P_TEB
 0x6558

	)

61 
	#ETH_P_RARP
 0x8035

	)

62 
	#ETH_P_ATALK
 0x809B

	)

63 
	#ETH_P_AARP
 0x80F3

	)

64 
	#ETH_P_8021Q
 0x8100

	)

65 
	#ETH_P_IPX
 0x8137

	)

66 
	#ETH_P_IPV6
 0x86DD

	)

67 
	#ETH_P_PAUSE
 0x8808

	)

68 
	#ETH_P_SLOW
 0x8809

	)

69 
	#ETH_P_WCCP
 0x883E

	)

71 
	#ETH_P_PPP_DISC
 0x8863

	)

72 
	#ETH_P_PPP_SES
 0x8864

	)

73 
	#ETH_P_MPLS_UC
 0x8847

	)

74 
	#ETH_P_MPLS_MC
 0x8848

	)

75 
	#ETH_P_ATMMPOA
 0x884ø

	)

76 
	#ETH_P_LINK_CTL
 0x886ø

	)

77 
	#ETH_P_ATMFATE
 0x8884

	)

80 
	#ETH_P_PAE
 0x888E

	)

81 
	#ETH_P_AOE
 0x88A2

	)

82 
	#ETH_P_8021AD
 0x88A8

	)

83 
	#ETH_P_802_EX1
 0x88B5

	)

84 
	#ETH_P_TIPC
 0x88CA

	)

85 
	#ETH_P_8021AH
 0x88E7

	)

86 
	#ETH_P_MVRP
 0x88F5

	)

87 
	#ETH_P_1588
 0x88F7

	)

88 
	#ETH_P_PRP
 0x88FB

	)

89 
	#ETH_P_FCOE
 0x8906

	)

90 
	#ETH_P_TDLS
 0x890D

	)

91 
	#ETH_P_FIP
 0x8914

	)

92 
	#ETH_P_QINQ1
 0x9100

	)

93 
	#ETH_P_QINQ2
 0x9200

	)

94 
	#ETH_P_QINQ3
 0x9300

	)

95 
	#ETH_P_EDSA
 0xDADA

	)

96 
	#ETH_P_AF_IUCV
 0xFBFB

	)

98 
	#ETH_P_802_3_MIN
 0x0600

	)

105 
	#ETH_P_802_3
 0x0001

	)

106 
	#ETH_P_AX25
 0x0002

	)

107 
	#ETH_P_ALL
 0x0003

	)

108 
	#ETH_P_802_2
 0x0004

	)

109 
	#ETH_P_SNAP
 0x0005

	)

110 
	#ETH_P_DDCMP
 0x0006

	)

111 
	#ETH_P_WAN_PPP
 0x0007

	)

112 
	#ETH_P_PPP_MP
 0x0008

	)

113 
	#ETH_P_LOCALTALK
 0x0009

	)

114 
	#ETH_P_CAN
 0x000C

	)

115 
	#ETH_P_CANFD
 0x000D

	)

116 
	#ETH_P_PPPTALK
 0x0010

	)

117 
	#ETH_P_TR_802_2
 0x0011

	)

118 
	#ETH_P_MOBITEX
 0x0015

	)

119 
	#ETH_P_CONTROL
 0x0016

	)

120 
	#ETH_P_IRDA
 0x0017

	)

121 
	#ETH_P_ECONET
 0x0018

	)

122 
	#ETH_P_HDLC
 0x0019

	)

123 
	#ETH_P_ARCNET
 0x001A

	)

124 
	#ETH_P_DSA
 0x001B

	)

125 
	#ETH_P_TRAILER
 0x001C

	)

126 
	#ETH_P_PHONET
 0x00F5

	)

127 
	#ETH_P_IEEE802154
 0x00F6

	)

128 
	#ETH_P_CAIF
 0x00F7

	)

134 
	s‘hhdr
 {

135 
	mh_de¡
[
ETH_ALEN
];

136 
	mh_sourû
[
ETH_ALEN
];

137 
__be16
 
	mh_´Ùo
;

138 } 
__©Œibu‹__
((
·cked
));

	@/usr/include/linux/tcp.h

17 #iâdeà
_LINUX_TCP_H


18 
	#_LINUX_TCP_H


	)

20 
	~<lšux/ty³s.h
>

21 
	~<asm/by‹Üd”.h
>

22 
	~<lšux/sock‘.h
>

24 
	stıhdr
 {

25 
__be16
 
	msourû
;

26 
__be16
 
	mde¡
;

27 
__be32
 
	m£q
;

28 
__be32
 
	mack_£q
;

29 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

30 
__u16
 
	m»s1
:4,

31 
	mdoff
:4,

32 
	mfš
:1,

33 
	msyn
:1,

34 
	mr¡
:1,

35 
	mpsh
:1,

36 
	mack
:1,

37 
	murg
:1,

38 
	meû
:1,

39 
	mcwr
:1;

40 #–ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

41 
__u16
 
	mdoff
:4,

42 
	m»s1
:4,

43 
	mcwr
:1,

44 
	meû
:1,

45 
	murg
:1,

46 
	mack
:1,

47 
	mpsh
:1,

48 
	mr¡
:1,

49 
	msyn
:1,

50 
	mfš
:1;

54 
__be16
 
	mwšdow
;

55 
__sum16
 
	mcheck
;

56 
__be16
 
	murg_±r
;

64 
	utı_wÜd_hdr
 {

65 
tıhdr
 
	mhdr
;

66 
__be32
 
	mwÜds
[5];

69 
	#tı_æag_wÜd
(

èĞ((
tı_wÜd_hdr
 *)Ñp))->
wÜds
 [3])

	)

72 
	mTCP_FLAG_CWR
 = 
__cÚ¡ªt_ıu_to_be32
(0x00800000),

73 
	mTCP_FLAG_ECE
 = 
__cÚ¡ªt_ıu_to_be32
(0x00400000),

74 
	mTCP_FLAG_URG
 = 
__cÚ¡ªt_ıu_to_be32
(0x00200000),

75 
	mTCP_FLAG_ACK
 = 
__cÚ¡ªt_ıu_to_be32
(0x00100000),

76 
	mTCP_FLAG_PSH
 = 
__cÚ¡ªt_ıu_to_be32
(0x00080000),

77 
	mTCP_FLAG_RST
 = 
__cÚ¡ªt_ıu_to_be32
(0x00040000),

78 
	mTCP_FLAG_SYN
 = 
__cÚ¡ªt_ıu_to_be32
(0x00020000),

79 
	mTCP_FLAG_FIN
 = 
__cÚ¡ªt_ıu_to_be32
(0x00010000),

80 
	mTCP_RESERVED_BITS
 = 
__cÚ¡ªt_ıu_to_be32
(0x0F000000),

81 
	mTCP_DATA_OFFSET
 = 
__cÚ¡ªt_ıu_to_be32
(0xF0000000)

87 
	#TCP_MSS_DEFAULT
 536U

	)

88 
	#TCP_MSS_DESIRED
 1220U

	)

91 
	#TCP_NODELAY
 1

	)

92 
	#TCP_MAXSEG
 2

	)

93 
	#TCP_CORK
 3

	)

94 
	#TCP_KEEPIDLE
 4

	)

95 
	#TCP_KEEPINTVL
 5

	)

96 
	#TCP_KEEPCNT
 6

	)

97 
	#TCP_SYNCNT
 7

	)

98 
	#TCP_LINGER2
 8

	)

99 
	#TCP_DEFER_ACCEPT
 9

	)

100 
	#TCP_WINDOW_CLAMP
 10

	)

101 
	#TCP_INFO
 11

	)

102 
	#TCP_QUICKACK
 12

	)

103 
	#TCP_CONGESTION
 13

	)

104 
	#TCP_MD5SIG
 14

	)

105 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

106 
	#TCP_THIN_DUPACK
 17

	)

107 
	#TCP_USER_TIMEOUT
 18

	)

108 
	#TCP_REPAIR
 19

	)

109 
	#TCP_REPAIR_QUEUE
 20

	)

110 
	#TCP_QUEUE_SEQ
 21

	)

111 
	#TCP_REPAIR_OPTIONS
 22

	)

112 
	#TCP_FASTOPEN
 23

	)

113 
	#TCP_TIMESTAMP
 24

	)

114 
	#TCP_NOTSENT_LOWAT
 25

	)

116 
	stı_»·œ_İt
 {

117 
__u32
 
	mİt_code
;

118 
__u32
 
	mİt_v®
;

122 
	mTCP_NO_QUEUE
,

123 
	mTCP_RECV_QUEUE
,

124 
	mTCP_SEND_QUEUE
,

125 
	mTCP_QUEUES_NR
,

129 
	#TCPI_OPT_TIMESTAMPS
 1

	)

130 
	#TCPI_OPT_SACK
 2

	)

131 
	#TCPI_OPT_WSCALE
 4

	)

132 
	#TCPI_OPT_ECN
 8

	)

133 
	#TCPI_OPT_ECN_SEEN
 16

	)

134 
	#TCPI_OPT_SYN_DATA
 32

	)

136 
	etı_ÿ_¡©e
 {

137 
	mTCP_CA_O³n
 = 0,

138 
	#TCPF_CA_O³n
 (1<<
TCP_CA_O³n
)

	)

139 
	mTCP_CA_DisÜd”
 = 1,

140 
	#TCPF_CA_DisÜd”
 (1<<
TCP_CA_DisÜd”
)

	)

141 
	mTCP_CA_CWR
 = 2,

142 
	#TCPF_CA_CWR
 (1<<
TCP_CA_CWR
)

	)

143 
	mTCP_CA_Recov”y
 = 3,

144 
	#TCPF_CA_Recov”y
 (1<<
TCP_CA_Recov”y
)

	)

145 
	mTCP_CA_Loss
 = 4

146 
	#TCPF_CA_Loss
 (1<<
TCP_CA_Loss
)

	)

149 
	stı_šfo
 {

150 
__u8
 
	mtıi_¡©e
;

151 
__u8
 
	mtıi_ÿ_¡©e
;

152 
__u8
 
	mtıi_»Œªsm™s
;

153 
__u8
 
	mtıi_´obes
;

154 
__u8
 
	mtıi_backoff
;

155 
__u8
 
	mtıi_İtiÚs
;

156 
__u8
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

158 
__u32
 
	mtıi_¹o
;

159 
__u32
 
	mtıi_©o
;

160 
__u32
 
	mtıi_¢d_mss
;

161 
__u32
 
	mtıi_rcv_mss
;

163 
__u32
 
	mtıi_uÇcked
;

164 
__u32
 
	mtıi_§cked
;

165 
__u32
 
	mtıi_lo¡
;

166 
__u32
 
	mtıi_»Œªs
;

167 
__u32
 
	mtıi_çck‘s
;

170 
__u32
 
	mtıi_Ï¡_d©a_£Á
;

171 
__u32
 
	mtıi_Ï¡_ack_£Á
;

172 
__u32
 
	mtıi_Ï¡_d©a_»cv
;

173 
__u32
 
	mtıi_Ï¡_ack_»cv
;

176 
__u32
 
	mtıi_pmtu
;

177 
__u32
 
	mtıi_rcv_s¡h»sh
;

178 
__u32
 
	mtıi_¹t
;

179 
__u32
 
	mtıi_¹tv¬
;

180 
__u32
 
	mtıi_¢d_s¡h»sh
;

181 
__u32
 
	mtıi_¢d_cwnd
;

182 
__u32
 
	mtıi_advmss
;

183 
__u32
 
	mtıi_»Üd”šg
;

185 
__u32
 
	mtıi_rcv_¹t
;

186 
__u32
 
	mtıi_rcv_¥aû
;

188 
__u32
 
	mtıi_tÙ®_»Œªs
;

192 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

194 
	stı_md5sig
 {

195 
__k”Ãl_sockaddr_¡Üage
 
	mtım_addr
;

196 
__u16
 
	m__tım_·d1
;

197 
__u16
 
	mtım_keyËn
;

198 
__u32
 
	m__tım_·d2
;

199 
__u8
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/udp.h

17 #iâdeà
_LINUX_UDP_H


18 
	#_LINUX_UDP_H


	)

20 
	~<lšux/ty³s.h
>

22 
	sudphdr
 {

23 
__be16
 
	msourû
;

24 
__be16
 
	mde¡
;

25 
__be16
 
	mËn
;

26 
__sum16
 
	mcheck
;

30 
	#UDP_CORK
 1

	)

31 
	#UDP_ENCAP
 100

	)

34 
	#UDP_ENCAP_ESPINUDP_NON_IKE
 1

	)

35 
	#UDP_ENCAP_ESPINUDP
 2

	)

36 
	#UDP_ENCAP_L2TPINUDP
 3

	)

	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


32 
	~<b™s/huge_v®.h
>

33 #ifdeà
__USE_ISOC99


34 
	~<b™s/huge_v®f.h
>

35 
	~<b™s/huge_v®l.h
>

38 
	~<b™s/šf.h
>

41 
	~<b™s/Çn.h
>

45 
	~<b™s/m©hdef.h
>

52 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

53 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

54 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

55 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

56 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

57 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

58 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

59 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

60 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

61 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

62 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

63 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

65 
	#_MdoubË_
 

	)

66 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

67 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

68 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

69 
	~<b™s/m©hÿÎs.h
>

70 #undeà
_MdoubË_


71 #undeà
_MdoubË_BEGIN_NAMESPACE


72 #undeà
_MdoubË_END_NAMESPACE


73 #undeà
__MATH_PRECNAME


75 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


81 #iâdeà
_Mæßt_


82 
	#_Mæßt_
 

	)

84 
	#_MdoubË_
 
_Mæßt_


	)

85 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

86 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

87 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

88 
	~<b™s/m©hÿÎs.h
>

89 #undeà
_MdoubË_


90 #undeà
_MdoubË_BEGIN_NAMESPACE


91 #undeà
_MdoubË_END_NAMESPACE


92 #undeà
__MATH_PRECNAME


94 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

95 || 
defšed
 
__LDBL_COMPAT


96 #ifdeà
__LDBL_COMPAT


98 #ifdeà
__USE_ISOC99


99 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

100 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

101 #ifdeà
__REDIRECT_NTH


102 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

103 
__Ædbl_Ãx‰ow¬df
)

104 
	`__©Œibu‹__
 ((
__cÚ¡__
));

105 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

106 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

107 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

108 (
__x
, 
__y
),

109 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

113 #undeà
__MATHDECL_1


114 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

115 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

116 
¬gs
, 
®Ÿs
)

	)

117 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

118 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

124 #iâdeà
_MlÚg_doubË_


125 
	#_MlÚg_doubË_
 

	)

127 
	#_MdoubË_
 
_MlÚg_doubË_


	)

128 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

129 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

130 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

131 
	#__MATH_DECLARE_LDOUBLE
 1

	)

132 
	~<b™s/m©hÿÎs.h
>

133 #undeà
_MdoubË_


134 #undeà
_MdoubË_BEGIN_NAMESPACE


135 #undeà
_MdoubË_END_NAMESPACE


136 #undeà
__MATH_PRECNAME


141 #undeà
__MATHDECL_1


142 #undeà
__MATHDECL


143 #undeà
__MATHCALL


146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


148 
signgam
;

153 #ifdeà
__USE_ISOC99


191 
FP_NAN
 =

192 
	#FP_NAN
 0

	)

193 
FP_NAN
,

194 
FP_INFINITE
 =

195 
	#FP_INFINITE
 1

	)

196 
FP_INFINITE
,

197 
FP_ZERO
 =

198 
	#FP_ZERO
 2

	)

199 
FP_ZERO
,

200 
FP_SUBNORMAL
 =

201 
	#FP_SUBNORMAL
 3

	)

202 
FP_SUBNORMAL
,

203 
FP_NORMAL
 =

204 
	#FP_NORMAL
 4

	)

205 
FP_NORMAL


209 #ifdeà
__NO_LONG_DOUBLE_MATH


210 
	#åşassify
(
x
) \

211 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

213 
	#åşassify
(
x
) \

214 ( (
x
) ==  () \

215 ? 
	`__åşassifyf
 (
x
) \

216 :  (
x
) ==  () \

217 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

221 #ifdeà
__NO_LONG_DOUBLE_MATH


222 
	#signb™
(
x
) \

223 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

225 
	#signb™
(
x
) \

226 ( (
x
) ==  () \

227 ? 
	`__signb™f
 (
x
) \

228 :  (
x
) ==  () \

229 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

233 #ifdeà
__NO_LONG_DOUBLE_MATH


234 
	#isfš™e
(
x
) \

235 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

237 
	#isfš™e
(
x
) \

238 ( (
x
) ==  () \

239 ? 
	`__fš™ef
 (
x
) \

240 :  (
x
) ==  () \

241 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

245 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

249 #ifdeà
__NO_LONG_DOUBLE_MATH


250 
	#i¢ª
(
x
) \

251 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

253 
	#i¢ª
(
x
) \

254 ( (
x
) ==  () \

255 ? 
	`__i¢ªf
 (
x
) \

256 :  (
x
) ==  () \

257 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

261 #ifdeà
__NO_LONG_DOUBLE_MATH


262 
	#isšf
(
x
) \

263 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

265 
	#isšf
(
x
) \

266 ( (
x
) ==  () \

267 ? 
	`__isšff
 (
x
) \

268 :  (
x
) ==  () \

269 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

273 
	#MATH_ERRNO
 1

	)

274 
	#MATH_ERREXCEPT
 2

	)

279 #iâdeà
__FAST_MATH__


280 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

285 #ifdeà
__USE_GNU


287 #ifdeà
__NO_LONG_DOUBLE_MATH


288 
	#issigÇlšg
(
x
) \

289 ( (
x
è=ğ (è? 
	`__issigÇlšgf
 (xè: 
	`__issigÇlšg
 (x))

	)

291 
	#issigÇlšg
(
x
) \

292 ( (
x
) ==  () \

293 ? 
	`__issigÇlšgf
 (
x
) \

294 :  (
x
) ==  () \

295 ? 
	`__issigÇlšg
 (
x
è: 
	`__issigÇlšgl
 (x))

	)

299 #ifdef 
__USE_MISC


303 
_IEEE_
 = -1,

304 
_SVID_
,

305 
_XOPEN_
,

306 
_POSIX_
,

307 
_ISOC_


308 } 
	t_LIB_VERSION_TYPE
;

313 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

317 #ifdeà
__USE_SVID


323 #ifdeà
__ılu¥lus


324 
__exû±iÚ


326 
exû±iÚ


329 
ty³
;

330 *
Çme
;

331 
¬g1
;

332 
¬g2
;

333 
»tv®
;

334 
	}
};

336 #ifdeà
__ılu¥lus


337 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

339 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

342 
	#X_TLOSS
 1.41484755040568800000e+16

	)

345 
	#DOMAIN
 1

	)

346 
	#SING
 2

	)

347 
	#OVERFLOW
 3

	)

348 
	#UNDERFLOW
 4

	)

349 
	#TLOSS
 5

	)

350 
	#PLOSS
 6

	)

353 
	#HUGE
 3.40282347e+38F

	)

357 #ifdeà
__USE_XOPEN


359 
	#MAXFLOAT
 3.40282347e+38F

	)

366 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


367 
	#M_E
 2.7182818284590452354

	)

368 
	#M_LOG2E
 1.4426950408889634074

	)

369 
	#M_LOG10E
 0.43429448190325182765

	)

370 
	#M_LN2
 0.69314718055994530942

	)

371 
	#M_LN10
 2.30258509299404568402

	)

372 
	#M_PI
 3.14159265358979323846

	)

373 
	#M_PI_2
 1.57079632679489661923

	)

374 
	#M_PI_4
 0.78539816339744830962

	)

375 
	#M_1_PI
 0.31830988618379067154

	)

376 
	#M_2_PI
 0.63661977236758134308

	)

377 
	#M_2_SQRTPI
 1.12837916709551257390

	)

378 
	#M_SQRT2
 1.41421356237309504880

	)

379 
	#M_SQRT1_2
 0.70710678118654752440

	)

385 #ifdeà
__USE_GNU


386 
	#M_El
 2.718281828459045235360287471352662498L

	)

387 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

388 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

389 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

390 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

391 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

392 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

393 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

394 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

395 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

396 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

397 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

398 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

405 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


406 
	#__NO_MATH_INLINES
 1

	)

409 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

416 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

417 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

418 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

419 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

420 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

421 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

425 #ifdeà
__USE_EXTERN_INLINES


426 
	~<b™s/m©hšlše.h
>

431 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

432 
	~<b™s/m©h-fš™e.h
>

435 #ifdeà
__USE_ISOC99


439 #iâdeà
isg»©”


440 
	#isg»©”
(
x
, 
y
) \

441 (
__ex‹nsiÚ__
 \

442 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

443 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

447 #iâdeà
isg»©”equ®


448 
	#isg»©”equ®
(
x
, 
y
) \

449 (
__ex‹nsiÚ__
 \

450 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

451 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

455 #iâdeà
i¦ess


456 
	#i¦ess
(
x
, 
y
) \

457 (
__ex‹nsiÚ__
 \

458 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

459 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

463 #iâdeà
i¦es£qu®


464 
	#i¦es£qu®
(
x
, 
y
) \

465 (
__ex‹nsiÚ__
 \

466 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

467 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

471 #iâdeà
i¦essg»©”


472 
	#i¦essg»©”
(
x
, 
y
) \

473 (
__ex‹nsiÚ__
 \

474 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

475 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

479 #iâdeà
isunÜd”ed


480 
	#isunÜd”ed
(
u
, 
v
) \

481 (
__ex‹nsiÚ__
 \

482 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

483 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

488 
	g__END_DECLS


	@/usr/include/memory.h

22 #iâdef 
_MEMORY_H


23 
	#_MEMORY_H
 1

	)

25 
	~<ã©u»s.h
>

28 #iâdef 
_STRING_H


29 
	~<¡ršg.h
>

	@/usr/include/net/ethernet.h

21 #iâdeà
__NET_ETHERNET_H


22 
	#__NET_ETHERNET_H
 1

	)

24 
	~<sys/cdefs.h
>

25 
	~<sys/ty³s.h
>

26 
	~<lšux/if_‘h”.h
>

28 
__BEGIN_DECLS


32 
	s‘h”_addr


34 
u_št8_t
 
	m‘h”_addr_où‘
[
ETH_ALEN
];

35 } 
__©Œibu‹__
 ((
__·cked__
));

38 
	s‘h”_h—d”


40 
u_št8_t
 
	m‘h”_dho¡
[
ETH_ALEN
];

41 
u_št8_t
 
	m‘h”_sho¡
[
ETH_ALEN
];

42 
u_št16_t
 
	m‘h”_ty³
;

43 } 
__©Œibu‹__
 ((
__·cked__
));

46 
	#ETHERTYPE_PUP
 0x0200

	)

47 
	#ETHERTYPE_SPRITE
 0x0500

	)

48 
	#ETHERTYPE_IP
 0x0800

	)

49 
	#ETHERTYPE_ARP
 0x0806

	)

50 
	#ETHERTYPE_REVARP
 0x8035

	)

51 
	#ETHERTYPE_AT
 0x809B

	)

52 
	#ETHERTYPE_AARP
 0x80F3

	)

53 
	#ETHERTYPE_VLAN
 0x8100

	)

54 
	#ETHERTYPE_IPX
 0x8137

	)

55 
	#ETHERTYPE_IPV6
 0x86dd

	)

56 
	#ETHERTYPE_LOOPBACK
 0x9000

	)

59 
	#ETHER_ADDR_LEN
 
ETH_ALEN


	)

60 
	#ETHER_TYPE_LEN
 2

	)

61 
	#ETHER_CRC_LEN
 4

	)

62 
	#ETHER_HDR_LEN
 
ETH_HLEN


	)

63 
	#ETHER_MIN_LEN
 (
ETH_ZLEN
 + 
ETHER_CRC_LEN
è

	)

64 
	#ETHER_MAX_LEN
 (
ETH_FRAME_LEN
 + 
ETHER_CRC_LEN
è

	)

67 
	#ETHER_IS_VALID_LEN
(
foo
) \

68 ((
foo
è>ğ
ETHER_MIN_LEN
 && (fooè<ğ
ETHER_MAX_LEN
)

	)

75 
	#ETHERTYPE_TRAIL
 0x1000

	)

76 
	#ETHERTYPE_NTRAILER
 16

	)

78 
	#ETHERMTU
 
ETH_DATA_LEN


	)

79 
	#ETHERMIN
 (
ETHER_MIN_LEN
 - 
ETHER_HDR_LEN
 - 
ETHER_CRC_LEN
)

	)

81 
	g__END_DECLS


	@/usr/include/net/if.h

19 #iâdeà
_NET_IF_H


20 
	#_NET_IF_H
 1

	)

22 
	~<ã©u»s.h
>

24 #ifdeà
__USE_MISC


25 
	~<sys/ty³s.h
>

26 
	~<sys/sock‘.h
>

31 
	#IF_NAMESIZE
 16

	)

33 
	sif_Çmešdex


35 
	mif_šdex
;

36 *
	mif_Çme
;

40 #ifdeà
__USE_MISC


44 
	mIFF_UP
 = 0x1,

45 
	#IFF_UP
 
IFF_UP


	)

46 
	mIFF_BROADCAST
 = 0x2,

47 
	#IFF_BROADCAST
 
IFF_BROADCAST


	)

48 
	mIFF_DEBUG
 = 0x4,

49 
	#IFF_DEBUG
 
IFF_DEBUG


	)

50 
	mIFF_LOOPBACK
 = 0x8,

51 
	#IFF_LOOPBACK
 
IFF_LOOPBACK


	)

52 
	mIFF_POINTOPOINT
 = 0x10,

53 
	#IFF_POINTOPOINT
 
IFF_POINTOPOINT


	)

54 
	mIFF_NOTRAILERS
 = 0x20,

55 
	#IFF_NOTRAILERS
 
IFF_NOTRAILERS


	)

56 
	mIFF_RUNNING
 = 0x40,

57 
	#IFF_RUNNING
 
IFF_RUNNING


	)

58 
	mIFF_NOARP
 = 0x80,

59 
	#IFF_NOARP
 
IFF_NOARP


	)

60 
	mIFF_PROMISC
 = 0x100,

61 
	#IFF_PROMISC
 
IFF_PROMISC


	)

64 
	mIFF_ALLMULTI
 = 0x200,

65 
	#IFF_ALLMULTI
 
IFF_ALLMULTI


	)

67 
	mIFF_MASTER
 = 0x400,

68 
	#IFF_MASTER
 
IFF_MASTER


	)

69 
	mIFF_SLAVE
 = 0x800,

70 
	#IFF_SLAVE
 
IFF_SLAVE


	)

72 
	mIFF_MULTICAST
 = 0x1000,

73 
	#IFF_MULTICAST
 
IFF_MULTICAST


	)

75 
	mIFF_PORTSEL
 = 0x2000,

76 
	#IFF_PORTSEL
 
IFF_PORTSEL


	)

77 
	mIFF_AUTOMEDIA
 = 0x4000,

78 
	#IFF_AUTOMEDIA
 
IFF_AUTOMEDIA


	)

79 
	mIFF_DYNAMIC
 = 0x8000

80 
	#IFF_DYNAMIC
 
IFF_DYNAMIC


	)

88 
	siçddr


90 
sockaddr
 
	miç_addr
;

93 
sockaddr
 
	mifu_brßdaddr
;

94 
sockaddr
 
	mifu_d¡addr
;

95 } 
	miç_ifu
;

96 
içû
 *
	miç_iå
;

97 
içddr
 *
	miç_Ãxt
;

100 
	#iç_brßdaddr
 
iç_ifu
.
ifu_brßdaddr


	)

101 
	#iç_d¡addr
 
iç_ifu
.
ifu_d¡addr


	)

111 
	sifm­


113 
	mmem_¡¬t
;

114 
	mmem_’d
;

115 
	mba£_addr
;

116 
	mœq
;

117 
	mdma
;

118 
	mpÜt
;

126 
	siäeq


128 
	#IFHWADDRLEN
 6

	)

129 
	#IFNAMSIZ
 
IF_NAMESIZE


	)

132 
	miän_Çme
[
IFNAMSIZ
];

133 } 
	miä_iän
;

137 
sockaddr
 
	miäu_addr
;

138 
sockaddr
 
	miäu_d¡addr
;

139 
sockaddr
 
	miäu_brßdaddr
;

140 
sockaddr
 
	miäu_Ãtmask
;

141 
sockaddr
 
	miäu_hwaddr
;

142 
	miäu_æags
;

143 
	miäu_iv®ue
;

144 
	miäu_mtu
;

145 
ifm­
 
	miäu_m­
;

146 
	miäu_¦ave
[
IFNAMSIZ
];

147 
	miäu_ÃwÇme
[
IFNAMSIZ
];

148 
__ÿddr_t
 
	miäu_d©a
;

149 } 
	miä_iäu
;

151 
	#iä_Çme
 
iä_iän
.
iän_Çme


	)

152 
	#iä_hwaddr
 
iä_iäu
.
iäu_hwaddr


	)

153 
	#iä_addr
 
iä_iäu
.
iäu_addr


	)

154 
	#iä_d¡addr
 
iä_iäu
.
iäu_d¡addr


	)

155 
	#iä_brßdaddr
 
iä_iäu
.
iäu_brßdaddr


	)

156 
	#iä_Ãtmask
 
iä_iäu
.
iäu_Ãtmask


	)

157 
	#iä_æags
 
iä_iäu
.
iäu_æags


	)

158 
	#iä_m‘ric
 
iä_iäu
.
iäu_iv®ue


	)

159 
	#iä_mtu
 
iä_iäu
.
iäu_mtu


	)

160 
	#iä_m­
 
iä_iäu
.
iäu_m­


	)

161 
	#iä_¦ave
 
iä_iäu
.
iäu_¦ave


	)

162 
	#iä_d©a
 
iä_iäu
.
iäu_d©a


	)

163 
	#iä_ifšdex
 
iä_iäu
.
iäu_iv®ue


	)

164 
	#iä_bªdwidth
 
iä_iäu
.
iäu_iv®ue


	)

165 
	#iä_qËn
 
iä_iäu
.
iäu_iv®ue


	)

166 
	#iä_ÃwÇme
 
iä_iäu
.
iäu_ÃwÇme


	)

167 
	#_IOT_iäeq
 
	`_IOT
(
	`_IOTS
(),
IFNAMSIZ
,_IOTS(),16,0,0)

	)

168 
	#_IOT_iäeq_shÜt
 
	`_IOT
(
	`_IOTS
(),
IFNAMSIZ
,_IOTS(),1,0,0)

	)

169 
	#_IOT_iäeq_št
 
	`_IOT
(
	`_IOTS
(),
IFNAMSIZ
,_IOTS(),1,0,0)

	)

176 
	sifcÚf


178 
	mifc_Ën
;

181 
__ÿddr_t
 
	mifcu_buf
;

182 
iäeq
 *
	mifcu_»q
;

183 } 
	mifc_ifcu
;

185 
	#ifc_buf
 
ifc_ifcu
.
ifcu_buf


	)

186 
	#ifc_»q
 
ifc_ifcu
.
ifcu_»q


	)

187 
	#_IOT_ifcÚf
 
	`_IOT
(
	`_IOTS
(
ifcÚf
),1,0,0,0,0è

	)

190 
__BEGIN_DECLS


193 
	$if_Çm‘ošdex
 (cÚ¡ *
__iâame
è
__THROW
;

194 *
	$if_šdextÚame
 (
__ifšdex
, *
__iâame
è
__THROW
;

197 
if_Çmešdex
 *
	$if_Çmešdex
 (è
__THROW
;

200 
	$if_ä“Çmešdex
 (
if_Çmešdex
 *
__±r
è
__THROW
;

202 
__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<¡dšt.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	#__Ãed_sigev’t_t


	)

37 
	~<b™s/sigšfo.h
>

38 
	#__Ãed_time¥ec


	)

39 
	~<time.h
>

42 
	~<b™s/Ãtdb.h
>

45 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

46 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

47 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

48 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

49 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

50 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

53 
	g__BEGIN_DECLS


55 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


58 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

61 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

65 
	#HOST_NOT_FOUND
 1

	)

66 
	#TRY_AGAIN
 2

	)

68 
	#NO_RECOVERY
 3

	)

70 
	#NO_DATA
 4

	)

73 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


74 
	#NETDB_INTERNAL
 -1

	)

75 
	#NETDB_SUCCESS
 0

	)

76 
	#NO_ADDRESS
 
NO_DATA


	)

79 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


81 
	#IPPORT_RESERVED
 1024

	)

84 #ifdeà
__USE_GNU


86 
	#SCOPE_DELIMITER
 '%'

	)

89 #ifdeà
__USE_MISC


92 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

95 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

100 
	sho¡’t


102 *
h_Çme
;

103 **
h_®Ÿ£s
;

104 
h_add¹y³
;

105 
h_Ëngth
;

106 **
h_addr_li¡
;

107 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


108 
	#h_addr
 
h_addr_li¡
[0]

	)

117 
	`£tho¡’t
 (
__¡ay_İ’
);

123 
	`’dho¡’t
 ();

130 
ho¡’t
 *
	`g‘ho¡’t
 ();

137 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

138 
__ty³
);

144 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

146 #ifdeà
__USE_MISC


155 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

167 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

168 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

169 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

170 *
__»¡riù
 
__h_”ºİ
);

172 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

173 
__ty³
,

174 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

175 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

176 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

177 *
__»¡riù
 
__h_”ºİ
);

179 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

180 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

181 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

182 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

183 *
__»¡riù
 
__h_”ºİ
);

185 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

186 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

187 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

188 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

189 *
__»¡riù
 
__h_”ºİ
);

198 
	`£Š‘’t
 (
__¡ay_İ’
);

204 
	`’dÃ‹Á
 ();

211 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

218 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

224 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

226 #ifdef 
__USE_MISC


237 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

238 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

239 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

240 *
__»¡riù
 
__h_”ºİ
);

242 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

243 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

244 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

245 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

246 *
__»¡riù
 
__h_”ºİ
);

248 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

249 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

250 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

251 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

252 *
__»¡riù
 
__h_”ºİ
);

257 
	s£rv’t


259 *
s_Çme
;

260 **
s_®Ÿ£s
;

261 
s_pÜt
;

262 *
s_´Ùo
;

270 
	`£t£rv’t
 (
__¡ay_İ’
);

276 
	`’d£rv’t
 ();

283 
£rv’t
 *
	`g‘£rv’t
 ();

290 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

297 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

300 #ifdef 
__USE_MISC


308 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

309 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

310 
£rv’t
 **
__»¡riù
 
__»suÉ
);

312 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

313 cÚ¡ *
__»¡riù
 
__´Ùo
,

314 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

315 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

316 
£rv’t
 **
__»¡riù
 
__»suÉ
);

318 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

319 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

320 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

321 
£rv’t
 **
__»¡riù
 
__»suÉ
);

326 
	s´ÙÛÁ


328 *
p_Çme
;

329 **
p_®Ÿ£s
;

330 
p_´Ùo
;

338 
	`£rÙÛÁ
 (
__¡ay_İ’
);

344 
	`’d´ÙÛÁ
 ();

351 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

357 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

363 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

366 #ifdef 
__USE_MISC


374 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

375 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

376 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

378 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

379 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

380 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

381 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

383 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

384 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

385 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

386 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

395 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

403 
	`’dÃtg»Á
 ();

412 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

413 **
__»¡riù
 
__u£½
,

414 **
__»¡riù
 
__domašp
);

423 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

424 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

432 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

433 **
__»¡riù
 
__u£½
,

434 **
__»¡riù
 
__domašp
,

435 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

439 #ifdeà
__USE_BSD


451 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

452 cÚ¡ *
__»¡riù
 
__locu£r
,

453 cÚ¡ *
__»¡riù
 
__»mu£r
,

454 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

463 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

464 cÚ¡ *
__»¡riù
 
__locu£r
,

465 cÚ¡ *
__»¡riù
 
__»mu£r
,

466 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

467 
§_çmy_t
 
__af
);

479 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

480 cÚ¡ *
__»¡riù
 
__Çme
,

481 cÚ¡ *
__»¡riù
 
__·ss
,

482 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

491 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

492 cÚ¡ *
__»¡riù
 
__Çme
,

493 cÚ¡ *
__»¡riù
 
__·ss
,

494 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

495 
§_çmy_t
 
__af
);

505 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

506 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

515 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

516 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

517 
§_çmy_t
 
__af
);

528 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

529 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

539 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

540 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

541 
§_çmy_t
 
__af
);

551 
	`¼esvpÜt
 (*
__®pÜt
);

560 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

565 #ifdef 
__USE_POSIX


567 
	saddršfo


569 
ai_æags
;

570 
ai_çmy
;

571 
ai_sockty³
;

572 
ai_´ÙocŞ
;

573 
sockËn_t
 
ai_add¾’
;

574 
sockaddr
 *
ai_addr
;

575 *
ai_ÿnÚÇme
;

576 
addršfo
 *
ai_Ãxt
;

579 #ifdeà
__USE_GNU


581 
	sgaicb


583 cÚ¡ *
¬_Çme
;

584 cÚ¡ *
¬_£rviû
;

585 cÚ¡ 
addršfo
 *
¬_»que¡
;

586 
addršfo
 *
¬_»suÉ
;

588 
__»tuº
;

589 
__glibc_»£rved
[5];

593 
	#GAI_WAIT
 0

	)

594 
	#GAI_NOWAIT
 1

	)

598 
	#AI_PASSIVE
 0x0001

	)

599 
	#AI_CANONNAME
 0x0002

	)

600 
	#AI_NUMERICHOST
 0x0004

	)

601 
	#AI_V4MAPPED
 0x0008

	)

602 
	#AI_ALL
 0x0010

	)

603 
	#AI_ADDRCONFIG
 0x0020

	)

605 #ifdeà
__USE_GNU


606 
	#AI_IDN
 0x0040

	)

609 
	#AI_CANONIDN
 0x0080

	)

610 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

612 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

615 
	#AI_NUMERICSERV
 0x0400

	)

618 
	#EAI_BADFLAGS
 -1

	)

619 
	#EAI_NONAME
 -2

	)

620 
	#EAI_AGAIN
 -3

	)

621 
	#EAI_FAIL
 -4

	)

622 
	#EAI_FAMILY
 -6

	)

623 
	#EAI_SOCKTYPE
 -7

	)

624 
	#EAI_SERVICE
 -8

	)

625 
	#EAI_MEMORY
 -10

	)

626 
	#EAI_SYSTEM
 -11

	)

627 
	#EAI_OVERFLOW
 -12

	)

628 #ifdeà
__USE_GNU


629 
	#EAI_NODATA
 -5

	)

630 
	#EAI_ADDRFAMILY
 -9

	)

631 
	#EAI_INPROGRESS
 -100

	)

632 
	#EAI_CANCELED
 -101

	)

633 
	#EAI_NOTCANCELED
 -102

	)

634 
	#EAI_ALLDONE
 -103

	)

635 
	#EAI_INTR
 -104

	)

636 
	#EAI_IDN_ENCODE
 -105

	)

639 #ifdeà
__USE_MISC


640 
	#NI_MAXHOST
 1025

	)

641 
	#NI_MAXSERV
 32

	)

644 
	#NI_NUMERICHOST
 1

	)

645 
	#NI_NUMERICSERV
 2

	)

646 
	#NI_NOFQDN
 4

	)

647 
	#NI_NAMEREQD
 8

	)

648 
	#NI_DGRAM
 16

	)

649 #ifdeà
__USE_GNU


650 
	#NI_IDN
 32

	)

651 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

653 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

662 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

663 cÚ¡ *
__»¡riù
 
__£rviû
,

664 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

665 
addršfo
 **
__»¡riù
 
__·i
);

668 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

671 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

677 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

678 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

679 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

680 
sockËn_t
 
__£rvËn
, 
__æags
);

683 #ifdeà
__USE_GNU


692 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

693 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

703 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

704 cÚ¡ 
time¥ec
 *
__timeout
);

707 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

710 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

713 
__END_DECLS


	@/usr/include/netinet/ether.h

19 #iâdeà
_NETINET_ETHER_H


20 
	#_NETINET_ETHER_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<Ãtš‘/if_‘h”.h
>

27 
__BEGIN_DECLS


30 *
	$‘h”_Áß
 (cÚ¡ 
‘h”_addr
 *
__addr
è
__THROW
;

31 *
	$‘h”_Áß_r
 (cÚ¡ 
‘h”_addr
 *
__addr
, *
__buf
)

32 
__THROW
;

35 
‘h”_addr
 *
	$‘h”_©Ú
 (cÚ¡ *
__asc
è
__THROW
;

36 
‘h”_addr
 *
	$‘h”_©Ú_r
 (cÚ¡ *
__asc
,

37 
‘h”_addr
 *
__addr
è
__THROW
;

40 
	$‘h”_Áoho¡
 (*
__ho¡Çme
, cÚ¡ 
‘h”_addr
 *
__addr
)

41 
__THROW
;

44 
	$‘h”_ho¡tÚ
 (cÚ¡ *
__ho¡Çme
, 
‘h”_addr
 *
__addr
)

45 
__THROW
;

48 
	$‘h”_lše
 (cÚ¡ *
__lše
, 
‘h”_addr
 *
__addr
,

49 *
__ho¡Çme
è
__THROW
;

51 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_RAW
 = 255,

89 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

90 
	mIPPROTO_MAX


96 #iâdeà
__USE_KERNEL_IPV6_DEFS


99 
	mIPPROTO_HOPOPTS
 = 0,

100 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

101 
	mIPPROTO_ROUTING
 = 43,

102 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

103 
	mIPPROTO_FRAGMENT
 = 44,

104 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

105 
	mIPPROTO_ICMPV6
 = 58,

106 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

107 
	mIPPROTO_NONE
 = 59,

108 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

109 
	mIPPROTO_DSTOPTS
 = 60,

110 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

111 
	mIPPROTO_MH
 = 135

112 
	#IPPROTO_MH
 
IPPROTO_MH


	)

117 
ušt16_t
 
	tš_pÜt_t
;

122 
	mIPPORT_ECHO
 = 7,

123 
	mIPPORT_DISCARD
 = 9,

124 
	mIPPORT_SYSTAT
 = 11,

125 
	mIPPORT_DAYTIME
 = 13,

126 
	mIPPORT_NETSTAT
 = 15,

127 
	mIPPORT_FTP
 = 21,

128 
	mIPPORT_TELNET
 = 23,

129 
	mIPPORT_SMTP
 = 25,

130 
	mIPPORT_TIMESERVER
 = 37,

131 
	mIPPORT_NAMESERVER
 = 42,

132 
	mIPPORT_WHOIS
 = 43,

133 
	mIPPORT_MTP
 = 57,

135 
	mIPPORT_TFTP
 = 69,

136 
	mIPPORT_RJE
 = 77,

137 
	mIPPORT_FINGER
 = 79,

138 
	mIPPORT_TTYLINK
 = 87,

139 
	mIPPORT_SUPDUP
 = 95,

142 
	mIPPORT_EXECSERVER
 = 512,

143 
	mIPPORT_LOGINSERVER
 = 513,

144 
	mIPPORT_CMDSERVER
 = 514,

145 
	mIPPORT_EFSSERVER
 = 520,

148 
	mIPPORT_BIFFUDP
 = 512,

149 
	mIPPORT_WHOSERVER
 = 513,

150 
	mIPPORT_ROUTESERVER
 = 520,

153 
	mIPPORT_RESERVED
 = 1024,

156 
	mIPPORT_USERRESERVED
 = 5000

164 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

165 
	#IN_CLASSA_NET
 0xff000000

	)

166 
	#IN_CLASSA_NSHIFT
 24

	)

167 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

168 
	#IN_CLASSA_MAX
 128

	)

170 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

171 
	#IN_CLASSB_NET
 0xffff0000

	)

172 
	#IN_CLASSB_NSHIFT
 16

	)

173 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

174 
	#IN_CLASSB_MAX
 65536

	)

176 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

177 
	#IN_CLASSC_NET
 0xffffff00

	)

178 
	#IN_CLASSC_NSHIFT
 8

	)

179 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

181 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

182 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

184 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

185 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

188 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

190 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

192 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

195 
	#IN_LOOPBACKNET
 127

	)

197 #iâdeà
INADDR_LOOPBACK


198 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

202 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

203 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

204 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

205 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

207 #iâdeà
__USE_KERNEL_IPV6_DEFS


209 
	sš6_addr


213 
ušt8_t
 
	m__u6_addr8
[16];

214 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


215 
ušt16_t
 
	m__u6_addr16
[8];

216 
ušt32_t
 
	m__u6_addr32
[4];

218 } 
	m__š6_u
;

219 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

220 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


221 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

222 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

227 cÚ¡ 
š6_addr
 
š6addr_ªy
;

228 cÚ¡ 
š6_addr
 
š6addr_loİback
;

229 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

230 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

232 
	#INET_ADDRSTRLEN
 16

	)

233 
	#INET6_ADDRSTRLEN
 46

	)

237 
	ssockaddr_š


239 
__SOCKADDR_COMMON
 (
sš_
);

240 
š_pÜt_t
 
	msš_pÜt
;

241 
š_addr
 
	msš_addr
;

244 
	msš_z”o
[ (
sockaddr
) -

245 
__SOCKADDR_COMMON_SIZE
 -

246  (
š_pÜt_t
) -

247  (
š_addr
)];

250 #iâdeà
__USE_KERNEL_IPV6_DEFS


252 
	ssockaddr_š6


254 
__SOCKADDR_COMMON
 (
sš6_
);

255 
š_pÜt_t
 
	msš6_pÜt
;

256 
ušt32_t
 
	msš6_æowšfo
;

257 
š6_addr
 
	msš6_addr
;

258 
ušt32_t
 
	msš6_scİe_id
;

262 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


264 
	s_m»q


267 
š_addr
 
	mimr_muÉŸddr
;

270 
š_addr
 
	mimr_š‹rçû
;

273 
	s_m»q_sourû


276 
š_addr
 
	mimr_muÉŸddr
;

279 
š_addr
 
	mimr_š‹rçû
;

282 
š_addr
 
	mimr_sourûaddr
;

286 #iâdeà
__USE_KERNEL_IPV6_DEFS


288 
	sv6_m»q


291 
š6_addr
 
	mv6mr_muÉŸddr
;

294 
	mv6mr_š‹rçû
;

298 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


300 
	sgroup_»q


303 
ušt32_t
 
	mgr_š‹rçû
;

306 
sockaddr_¡Üage
 
	mgr_group
;

309 
	sgroup_sourû_»q


312 
ušt32_t
 
	mg¤_š‹rçû
;

315 
sockaddr_¡Üage
 
	mg¤_group
;

318 
sockaddr_¡Üage
 
	mg¤_sourû
;

323 
	s_msf‹r


326 
š_addr
 
	mimsf_muÉŸddr
;

329 
š_addr
 
	mimsf_š‹rçû
;

332 
ušt32_t
 
	mimsf_fmode
;

335 
ušt32_t
 
	mimsf_num¤c
;

337 
š_addr
 
	mimsf_¦i¡
[1];

340 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

341 -  (
š_addr
) \

342 + (
num¤c
è*  (
š_addr
))

	)

344 
	sgroup_f‹r


347 
ušt32_t
 
	mgf_š‹rçû
;

350 
sockaddr_¡Üage
 
	mgf_group
;

353 
ušt32_t
 
	mgf_fmode
;

356 
ušt32_t
 
	mgf_num¤c
;

358 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

361 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

362 -  (
sockaddr_¡Üage
) \

363 + ((
num¤c
) \

364 *  (
sockaddr_¡Üage
)))

	)

374 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

375 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

376 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

382 
	~<’dŸn.h
>

385 
	~<b™s/by‹sw­.h
>

387 #ifdeà
__OPTIMIZE__


391 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


394 
	#Áohl
(
x
è(x)

	)

395 
	#Áohs
(
x
è(x)

	)

396 
	#htÚl
(
x
è(x)

	)

397 
	#htÚs
(
x
è(x)

	)

399 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


400 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

401 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

402 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

403 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

408 #ifdeà
__GNUC__


409 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

410 (
__ex‹nsiÚ__
 \

411 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

412 
__a
->
s6_addr32
[0] == 0 \

413 && 
__a
->
s6_addr32
[1] == 0 \

414 && 
__a
->
s6_addr32
[2] == 0 \

415 && 
__a
->
s6_addr32
[3] =ğ0; 
	}
}))

	)

417 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

418 (
__ex‹nsiÚ__
 \

419 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

420 
__a
->
s6_addr32
[0] == 0 \

421 && 
__a
->
s6_addr32
[1] == 0 \

422 && 
__a
->
s6_addr32
[2] == 0 \

423 && 
__a
->
s6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

425 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

426 (
__ex‹nsiÚ__
 \

427 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

428 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

430 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

431 (
__ex‹nsiÚ__
 \

432 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

433 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

435 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

436 (
__ex‹nsiÚ__
 \

437 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

438 
__a
->
s6_addr32
[0] == 0 \

439 && 
__a
->
s6_addr32
[1] == 0 \

440 && 
__a
->
s6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

442 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

443 (
__ex‹nsiÚ__
 \

444 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

445 
__a
->
s6_addr32
[0] == 0 \

446 && 
__a
->
s6_addr32
[1] == 0 \

447 && 
__a
->
s6_addr32
[2] == 0 \

448 && 
	`Áohl
 (
__a
->
s6_addr32
[3]è> 1; }))

	)

450 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

451 (
__ex‹nsiÚ__
 \

452 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

453 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

454 
__a
->
s6_addr32
[0] =ğ
__b
->s6_addr32[0] \

455 && 
__a
->
s6_addr32
[1] =ğ
__b
->s6_addr32[1] \

456 && 
__a
->
s6_addr32
[2] =ğ
__b
->s6_addr32[2] \

457 && 
__a
->
s6_addr32
[3] =ğ
__b
->s6_addr32[3]; }))

	)

459 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

460 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

461 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

462 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

465 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

466 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

467 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

468 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

471 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

472 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

473 =ğ
	`htÚl
 (0xã800000))

	)

475 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

476 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

477 =ğ
	`htÚl
 (0xãc00000))

	)

479 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

480 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

481 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

482 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

484 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

485 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

486 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

487 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

488 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

490 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

491 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

492 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

493 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

497 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

499 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


501 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

504 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

505 
__THROW
;

509 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

510 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

511 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

513 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

514 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

515 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

517 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

518 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

519 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

521 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

522 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

523 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

525 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

526 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

527 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

530 #ifdeà
__USE_GNU


531 
cmsghdr
;

534 
	sš6_pktšfo


536 
š6_addr
 
i6_addr
;

537 
i6_ifšdex
;

541 
	s6_mtušfo


543 
sockaddr_š6
 
6m_addr
;

544 
ušt32_t
 
6m_mtu
;

549 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

550 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

551 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

552 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

553 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

554 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

555 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

556 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

557 
__muÉx
, 
__¶usy
)

558 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

559 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

560 
ušt8_t
 **
__Œp
)

561 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

562 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

563 
ušt8_t
 **
__Œp
, 
__ty³
)

564 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

568 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

569 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

570 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

571 **
__d©abuå
è
__THROW
;

572 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

573 
__THROW
;

574 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

575 
sockËn_t
 
__v®Ën
è
__THROW
;

576 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

577 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

578 **
__d©abuå
è
__THROW
;

579 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

580 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

581 **
__d©abuå
è
__THROW
;

582 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

583 
sockËn_t
 
__v®Ën
è
__THROW
;

587 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

588 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

589 
__£gm’ts
è
__THROW
;

590 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

591 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

592 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

593 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

594 
__THROW
;

600 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

601 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

602 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

603 
__THROW
;

606 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

607 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

608 
ušt32_t
 
__num¤c
,

609 cÚ¡ 
š_addr
 *
__¦i¡
)

610 
__THROW
;

614 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

615 cÚ¡ 
sockaddr
 *
__group
,

616 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

617 
ušt32_t
 *
__num¤c
,

618 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

621 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

622 cÚ¡ 
sockaddr
 *
__group
,

623 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

624 
ušt32_t
 
__num¤c
,

625 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

628 
__END_DECLS


	@/usr/include/netinet/ip.h

18 #iâdeà
__NETINET_IP_H


19 
	#__NETINET_IP_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<sys/ty³s.h
>

24 
	~<Ãtš‘/š.h
>

26 
__BEGIN_DECLS


28 
	stime¡amp


30 
u_št8_t
 
	mËn
;

31 
u_št8_t
 
	m±r
;

32 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


33 
	mæags
:4;

34 
	mov”æow
:4;

35 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


36 
	mov”æow
:4;

37 
	mæags
:4;

41 
u_št32_t
 
	md©a
[9];

44 
	shdr


46 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


47 
	mihl
:4;

48 
	mv”siÚ
:4;

49 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


50 
	mv”siÚ
:4;

51 
	mihl
:4;

55 
u_št8_t
 
	mtos
;

56 
u_št16_t
 
	mtÙ_Ën
;

57 
u_št16_t
 
	mid
;

58 
u_št16_t
 
	mäag_off
;

59 
u_št8_t
 
	m‰l
;

60 
u_št8_t
 
	m´ÙocŞ
;

61 
u_št16_t
 
	mcheck
;

62 
u_št32_t
 
	m§ddr
;

63 
u_št32_t
 
	mdaddr
;

67 #ifdeà
__USE_BSD


107 
	s


109 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


110 
	m_hl
:4;

111 
	m_v
:4;

113 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


114 
	m_v
:4;

115 
	m_hl
:4;

117 
u_št8_t
 
	m_tos
;

118 
u_shÜt
 
	m_Ën
;

119 
u_shÜt
 
	m_id
;

120 
u_shÜt
 
	m_off
;

121 
	#IP_RF
 0x8000

	)

122 
	#IP_DF
 0x4000

	)

123 
	#IP_MF
 0x2000

	)

124 
	#IP_OFFMASK
 0x1ffà

	)

125 
u_št8_t
 
	m_‰l
;

126 
u_št8_t
 
	m_p
;

127 
u_shÜt
 
	m_sum
;

128 
š_addr
 
	m_¤c
, 
	m_d¡
;

134 
	s_time¡amp


136 
u_št8_t
 
	mt_code
;

137 
u_št8_t
 
	mt_Ën
;

138 
u_št8_t
 
	mt_±r
;

139 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


140 
	mt_æg
:4;

141 
	mt_oæw
:4;

143 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


144 
	mt_oæw
:4;

145 
	mt_æg
:4;

147 
u_št32_t
 
	md©a
[9];

151 
	#IPVERSION
 4

	)

152 
	#IP_MAXPACKET
 65535

	)

160 
	#IPTOS_ECN_MASK
 0x03

	)

161 
	#IPTOS_ECN
(
x
è((xè& 
IPTOS_ECN_MASK
)

	)

162 
	#IPTOS_ECN_NOT_ECT
 0x00

	)

163 
	#IPTOS_ECN_ECT1
 0x01

	)

164 
	#IPTOS_ECN_ECT0
 0x02

	)

165 
	#IPTOS_ECN_CE
 0x03

	)

173 
	#IPTOS_DSCP_MASK
 0xfc

	)

174 
	#IPTOS_DSCP
(
x
è((xè& 
IPTOS_DSCP_MASK
)

	)

175 
	#IPTOS_DSCP_AF11
 0x28

	)

176 
	#IPTOS_DSCP_AF12
 0x30

	)

177 
	#IPTOS_DSCP_AF13
 0x38

	)

178 
	#IPTOS_DSCP_AF21
 0x48

	)

179 
	#IPTOS_DSCP_AF22
 0x50

	)

180 
	#IPTOS_DSCP_AF23
 0x58

	)

181 
	#IPTOS_DSCP_AF31
 0x68

	)

182 
	#IPTOS_DSCP_AF32
 0x70

	)

183 
	#IPTOS_DSCP_AF33
 0x78

	)

184 
	#IPTOS_DSCP_AF41
 0x88

	)

185 
	#IPTOS_DSCP_AF42
 0x90

	)

186 
	#IPTOS_DSCP_AF43
 0x98

	)

187 
	#IPTOS_DSCP_EF
 0xb8

	)

194 
	#IPTOS_CLASS_MASK
 0xe0

	)

195 
	#IPTOS_CLASS
(
şass
è((şassè& 
IPTOS_CLASS_MASK
)

	)

196 
	#IPTOS_CLASS_CS0
 0x00

	)

197 
	#IPTOS_CLASS_CS1
 0x20

	)

198 
	#IPTOS_CLASS_CS2
 0x40

	)

199 
	#IPTOS_CLASS_CS3
 0x60

	)

200 
	#IPTOS_CLASS_CS4
 0x80

	)

201 
	#IPTOS_CLASS_CS5
 0xa0

	)

202 
	#IPTOS_CLASS_CS6
 0xc0

	)

203 
	#IPTOS_CLASS_CS7
 0xe0

	)

205 
	#IPTOS_CLASS_DEFAULT
 
IPTOS_CLASS_CS0


	)

211 
	#IPTOS_TOS_MASK
 0x1E

	)

212 
	#IPTOS_TOS
(
tos
è(Ñosè& 
IPTOS_TOS_MASK
)

	)

213 
	#IPTOS_LOWDELAY
 0x10

	)

214 
	#IPTOS_THROUGHPUT
 0x08

	)

215 
	#IPTOS_RELIABILITY
 0x04

	)

216 
	#IPTOS_LOWCOST
 0x02

	)

217 
	#IPTOS_MINCOST
 
IPTOS_LOWCOST


	)

222 
	#IPTOS_PREC_MASK
 
IPTOS_CLASS_MASK


	)

223 
	#IPTOS_PREC
(
tos
è
	`IPTOS_CLASS
Ños)

	)

224 
	#IPTOS_PREC_NETCONTROL
 
IPTOS_CLASS_CS7


	)

225 
	#IPTOS_PREC_INTERNETCONTROL
 
IPTOS_CLASS_CS6


	)

226 
	#IPTOS_PREC_CRITIC_ECP
 
IPTOS_CLASS_CS5


	)

227 
	#IPTOS_PREC_FLASHOVERRIDE
 
IPTOS_CLASS_CS4


	)

228 
	#IPTOS_PREC_FLASH
 
IPTOS_CLASS_CS3


	)

229 
	#IPTOS_PREC_IMMEDIATE
 
IPTOS_CLASS_CS2


	)

230 
	#IPTOS_PREC_PRIORITY
 
IPTOS_CLASS_CS1


	)

231 
	#IPTOS_PREC_ROUTINE
 
IPTOS_CLASS_CS0


	)

236 
	#IPOPT_COPY
 0x80

	)

237 
	#IPOPT_CLASS_MASK
 0x60

	)

238 
	#IPOPT_NUMBER_MASK
 0x1f

	)

240 
	#IPOPT_COPIED
(
o
è((oè& 
IPOPT_COPY
)

	)

241 
	#IPOPT_CLASS
(
o
è((oè& 
IPOPT_CLASS_MASK
)

	)

242 
	#IPOPT_NUMBER
(
o
è((oè& 
IPOPT_NUMBER_MASK
)

	)

244 
	#IPOPT_CONTROL
 0x00

	)

245 
	#IPOPT_RESERVED1
 0x20

	)

246 
	#IPOPT_DEBMEAS
 0x40

	)

247 
	#IPOPT_MEASUREMENT
 
IPOPT_DEBMEAS


	)

248 
	#IPOPT_RESERVED2
 0x60

	)

250 
	#IPOPT_EOL
 0

	)

251 
	#IPOPT_END
 
IPOPT_EOL


	)

252 
	#IPOPT_NOP
 1

	)

253 
	#IPOPT_NOOP
 
IPOPT_NOP


	)

255 
	#IPOPT_RR
 7

	)

256 
	#IPOPT_TS
 68

	)

257 
	#IPOPT_TIMESTAMP
 
IPOPT_TS


	)

258 
	#IPOPT_SECURITY
 130

	)

259 
	#IPOPT_SEC
 
IPOPT_SECURITY


	)

260 
	#IPOPT_LSRR
 131

	)

261 
	#IPOPT_SATID
 136

	)

262 
	#IPOPT_SID
 
IPOPT_SATID


	)

263 
	#IPOPT_SSRR
 137

	)

264 
	#IPOPT_RA
 148

	)

269 
	#IPOPT_OPTVAL
 0

	)

270 
	#IPOPT_OLEN
 1

	)

271 
	#IPOPT_OFFSET
 2

	)

272 
	#IPOPT_MINOFF
 4

	)

274 
	#MAX_IPOPTLEN
 40

	)

277 
	#IPOPT_TS_TSONLY
 0

	)

278 
	#IPOPT_TS_TSANDADDR
 1

	)

279 
	#IPOPT_TS_PRESPEC
 3

	)

282 
	#IPOPT_SECUR_UNCLASS
 0x0000

	)

283 
	#IPOPT_SECUR_CONFID
 0xf135

	)

284 
	#IPOPT_SECUR_EFTO
 0x789a

	)

285 
	#IPOPT_SECUR_MMMM
 0xbc4d

	)

286 
	#IPOPT_SECUR_RESTR
 0xaf13

	)

287 
	#IPOPT_SECUR_SECRET
 0xd788

	)

288 
	#IPOPT_SECUR_TOPSECRET
 0x6bc5

	)

293 
	#MAXTTL
 255

	)

294 
	#IPDEFTTL
 64

	)

295 
	#IPFRAGTTL
 60

	)

296 
	#IPTTLDEC
 1

	)

298 
	#IP_MSS
 576

	)

300 
	g__END_DECLS


	@/usr/include/netinet/ip6.h

18 #iâdeà
_NETINET_IP6_H


19 
	#_NETINET_IP6_H
 1

	)

21 
	~<š‰y³s.h
>

22 
	~<Ãtš‘/š.h
>

24 
	s6_hdr


28 
	s6_hdrùl


30 
ušt32_t
 
	m6_un1_æow
;

32 
ušt16_t
 
	m6_un1_¶’
;

33 
ušt8_t
 
	m6_un1_nxt
;

34 
ušt8_t
 
	m6_un1_hlim
;

35 } 
	m6_un1
;

36 
ušt8_t
 
	m6_un2_vfc
;

37 } 
	m6_ùlun
;

38 
š6_addr
 
	m6_¤c
;

39 
š6_addr
 
	m6_d¡
;

42 
	#6_vfc
 
6_ùlun
.
6_un2_vfc


	)

43 
	#6_æow
 
6_ùlun
.
6_un1
.
6_un1_æow


	)

44 
	#6_¶’
 
6_ùlun
.
6_un1
.
6_un1_¶’


	)

45 
	#6_nxt
 
6_ùlun
.
6_un1
.
6_un1_nxt


	)

46 
	#6_hlim
 
6_ùlun
.
6_un1
.
6_un1_hlim


	)

47 
	#6_hİs
 
6_ùlun
.
6_un1
.
6_un1_hlim


	)

50 
	s6_ext


52 
ušt8_t
 
	m6e_nxt
;

53 
ušt8_t
 
	m6e_Ën
;

57 
	s6_hbh


59 
ušt8_t
 
	m6h_nxt
;

60 
ušt8_t
 
	m6h_Ën
;

65 
	s6_de¡


67 
ušt8_t
 
	m6d_nxt
;

68 
ušt8_t
 
	m6d_Ën
;

73 
	s6_¹hdr


75 
ušt8_t
 
	m6r_nxt
;

76 
ušt8_t
 
	m6r_Ën
;

77 
ušt8_t
 
	m6r_ty³
;

78 
ušt8_t
 
	m6r_£gËá
;

83 
	s6_¹hdr0


85 
ušt8_t
 
	m6r0_nxt
;

86 
ušt8_t
 
	m6r0_Ën
;

87 
ušt8_t
 
	m6r0_ty³
;

88 
ušt8_t
 
	m6r0_£gËá
;

89 
ušt8_t
 
	m6r0_»£rved
;

90 
ušt8_t
 
	m6r0_¦m­
[3];

92 
š6_addr
 
	m6r0_addr
[0];

96 
	s6_äag


98 
ušt8_t
 
	m6f_nxt
;

99 
ušt8_t
 
	m6f_»£rved
;

100 
ušt16_t
 
	m6f_ofæg
;

101 
ušt32_t
 
	m6f_id’t
;

104 #ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


105 
	#IP6F_OFF_MASK
 0xfff8

	)

106 
	#IP6F_RESERVED_MASK
 0x0006

	)

107 
	#IP6F_MORE_FRAG
 0x0001

	)

109 
	#IP6F_OFF_MASK
 0xf8fà

	)

110 
	#IP6F_RESERVED_MASK
 0x0600

	)

111 
	#IP6F_MORE_FRAG
 0x0100

	)

115 
	s6_İt


117 
ušt8_t
 
	m6o_ty³
;

118 
ušt8_t
 
	m6o_Ën
;

125 
	#IP6OPT_TYPE
(
o
è((oè& 0xc0)

	)

126 
	#IP6OPT_TYPE_SKIP
 0x00

	)

127 
	#IP6OPT_TYPE_DISCARD
 0x40

	)

128 
	#IP6OPT_TYPE_FORCEICMP
 0x80

	)

129 
	#IP6OPT_TYPE_ICMP
 0xc0

	)

130 
	#IP6OPT_TYPE_MUTABLE
 0x20

	)

133 
	#IP6OPT_PAD1
 0

	)

134 
	#IP6OPT_PADN
 1

	)

136 
	#IP6OPT_JUMBO
 0xc2

	)

137 
	#IP6OPT_NSAP_ADDR
 0xc3

	)

138 
	#IP6OPT_TUNNEL_LIMIT
 0x04

	)

139 
	#IP6OPT_ROUTER_ALERT
 0x05

	)

142 
	s6_İt_jumbo


144 
ušt8_t
 
	m6oj_ty³
;

145 
ušt8_t
 
	m6oj_Ën
;

146 
ušt8_t
 
	m6oj_jumbo_Ën
[4];

148 
	#IP6OPT_JUMBO_LEN
 6

	)

151 
	s6_İt_n§p


153 
ušt8_t
 
	m6Ú_ty³
;

154 
ušt8_t
 
	m6Ú_Ën
;

155 
ušt8_t
 
	m6Ú_¤c_n§p_Ën
;

156 
ušt8_t
 
	m6Ú_d¡_n§p_Ën
;

162 
	s6_İt_tuÂ–


164 
ušt8_t
 
	m6Ù_ty³
;

165 
ušt8_t
 
	m6Ù_Ën
;

166 
ušt8_t
 
	m6Ù_’ÿp_lim™
;

170 
	s6_İt_rou‹r


172 
ušt8_t
 
	m6Ü_ty³
;

173 
ušt8_t
 
	m6Ü_Ën
;

174 
ušt8_t
 
	m6Ü_v®ue
[2];

178 #ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


179 
	#IP6_ALERT_MLD
 0x0000

	)

180 
	#IP6_ALERT_RSVP
 0x0001

	)

181 
	#IP6_ALERT_AN
 0x0002

	)

183 
	#IP6_ALERT_MLD
 0x0000

	)

184 
	#IP6_ALERT_RSVP
 0x0100

	)

185 
	#IP6_ALERT_AN
 0x0200

	)

	@/usr/include/numa.h

17 #iâdeà
_NUMA_H


18 
	#_NUMA_H
 1

	)

21 
	#LIBNUMA_API_VERSION
 2

	)

25 
	~<¡ddef.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/ty³s.h
>

28 
	~<¡dlib.h
>

30 #ià
defšed
(
__x86_64__
è|| defšed(
__i386__
)

31 
	#NUMA_NUM_NODES
 128

	)

33 
	#NUMA_NUM_NODES
 2048

	)

36 #ifdeà
__ılu¥lus


41 
n
[
NUMA_NUM_NODES
/(()*8)];

42 } 
	tnodemask_t
;

44 
	sb™mask
 {

45 
size
;

46 *
maskp
;

50 
numa_b™mask_isb™£t
(cÚ¡ 
b™mask
 *, );

51 
b™mask
 *
numa_b™mask_£Î
(bitmask *);

52 
b™mask
 *
numa_b™mask_ş—¿Î
(bitmask *);

53 
b™mask
 *
numa_b™mask_£tb™
(bitmask *, );

54 
b™mask
 *
numa_b™mask_ş—rb™
(bitmask *, );

55 
numa_b™mask_nby‹s
(
b™mask
 *);

56 
numa_b™mask_weight
(cÚ¡ 
b™mask
 *);

57 
b™mask
 *
numa_b™mask_®loc
();

58 
numa_b™mask_ä“
(
b™mask
 *);

59 
numa_b™mask_equ®
(cÚ¡ 
b™mask
 *, const bitmask *);

60 
cİy_nodemask_to_b™mask
(
nodemask_t
 *, 
b™mask
 *);

61 
cİy_b™mask_to_nodemask
(
b™mask
 *, 
nodemask_t
 *);

62 
cİy_b™mask_to_b™mask
(
b™mask
 *, bitmask *);

66 
šlše
 
nodemask_z”o
(
nodemask_t
 *
mask
)

68 
b™mask
 
tmp
;

70 
tmp
.
maskp
 = (*)
mask
;

71 
tmp
.
size
 = (
nodemask_t
) * 8;

72 
numa_b™mask_ş—¿Î
(&
tmp
);

75 
šlše
 
nodemask_z”o_com·t
(
nodemask_t
 *
mask
)

77 
b™mask
 
tmp
;

79 
tmp
.
maskp
 = (*)
mask
;

80 
tmp
.
size
 = (
nodemask_t
) * 8;

81 
numa_b™mask_ş—¿Î
(&
tmp
);

84 
šlše
 
nodemask_£t_com·t
(
nodemask_t
 *
mask
, 
node
)

86 
mask
->
n
[
node
 / (8*())] |=

87 (1UL<<(
node
%(8*())));

90 
šlše
 
nodemask_şr_com·t
(
nodemask_t
 *
mask
, 
node
)

92 
mask
->
n
[
node
 / (8*())] &=

93 ~(1UL<<(
node
%(8*())));

96 
šlše
 
nodemask_is£t_com·t
(cÚ¡ 
nodemask_t
 *
mask
, 
node
)

98 ià(()
node
 >ğ
NUMA_NUM_NODES
)

100 ià(
mask
->
n
[
node
 / (8*())] &

101 (1UL<<(
node
%(8*()))))

106 
šlše
 
nodemask_equ®
(cÚ¡ 
nodemask_t
 *
a
, cÚ¡‚odemask_ˆ*
b
)

108 
b™mask
 
tmp_a
, 
tmp_b
;

110 
tmp_a
.
maskp
 = (*)
a
;

111 
tmp_a
.
size
 = (
nodemask_t
) * 8;

113 
tmp_b
.
maskp
 = (*)
b
;

114 
tmp_b
.
size
 = (
nodemask_t
) * 8;

116  
numa_b™mask_equ®
(&
tmp_a
, &
tmp_b
);

119 
šlše
 
nodemask_equ®_com·t
(cÚ¡ 
nodemask_t
 *
a
, cÚ¡‚odemask_ˆ*
b
)

121 
b™mask
 
tmp_a
, 
tmp_b
;

123 
tmp_a
.
maskp
 = (*)
a
;

124 
tmp_a
.
size
 = (
nodemask_t
) * 8;

126 
tmp_b
.
maskp
 = (*)
b
;

127 
tmp_b
.
size
 = (
nodemask_t
) * 8;

129  
numa_b™mask_equ®
(&
tmp_a
, &
tmp_b
);

134 
numa_avaabË
();

139 
numa_max_node
();

140 
numa_max_possibË_node
();

142 
numa_´eã¼ed
();

145 
numa_node_size64
(
node
, *
ä“p
);

146 
numa_node_size
(
node
, *
ä“p
);

148 
numa_·gesize
();

152 
b™mask
 *
numa_®l_nodes_±r
;

155 
b™mask
 *
numa_nodes_±r
;

158 
nodemask_t
 
numa_®l_nodes
;

161 
b™mask
 *
numa_®l_ıus_±r
;

164 
b™mask
 *
numa_no_nodes_±r
;

167 
nodemask_t
 
numa_no_nodes
;

170 
numa_bšd
(
b™mask
 *
nodes
);

173 
numa_£t_š‹¾—ve_mask
(
b™mask
 *
nodemask
);

176 
b™mask
 *
numa_g‘_š‹¾—ve_mask
();

179 
b™mask
 *
numa_®loÿ‹_nodemask
();

181 
šlše
 
numa_ä“_nodemask
(
b™mask
 *
b
)

183 
numa_b™mask_ä“
(
b
);

187 
numa_£t_´eã¼ed
(
node
);

190 
numa_£t_loÿÏÎoc
();

193 
numa_£t_membšd
(
b™mask
 *
nodemask
);

196 
b™mask
 *
numa_g‘_membšd
();

199 
b™mask
 *
numa_g‘_mems_®lowed
();

201 
numa_g‘_š‹¾—ve_node
();

207 *
numa_®loc_š‹¾—ved_sub£t
(
size_t
 
size
, 
b™mask
 *
nodemask
);

209 *
numa_®loc_š‹¾—ved
(
size_t
 
size
);

211 *
numa_®loc_Únode
(
size_t
 
size
, 
node
);

213 *
numa_®loc_loÿl
(
size_t
 
size
);

215 *
numa_®loc
(
size_t
 
size
);

217 *
numa_»®loc
(*
Şd_addr
, 
size_t
 
Şd_size
, size_ˆ
Ãw_size
);

219 
numa_ä“
(*
mem
, 
size_t
 
size
);

225 
numa_š‹¾—ve_memÜy
(*
mem
, 
size_t
 
size
, 
b™mask
 *
mask
);

228 
numa_tÚode_memÜy
(*
¡¬t
, 
size_t
 
size
, 
node
);

231 
numa_tÚodemask_memÜy
(*
mem
, 
size_t
 
size
, 
b™mask
 *
mask
);

234 
numa_£oÿl_memÜy
(*
¡¬t
, 
size_t
 
size
);

237 
numa_pŞiû_memÜy
(*
¡¬t
, 
size_t
 
size
);

240 
numa_run_Ú_node_mask
(
b™mask
 *
mask
);

242 
numa_run_Ú_node_mask_®l
(
b™mask
 *
mask
);

244 
numa_run_Ú_node
(
node
);

246 
b™mask
 * 
numa_g‘_run_node_mask
();

249 
numa_£t_bšd_pŞicy
(
¡riù
);

252 
numa_£t_¡riù
(
æag
);

255 
numa_num_possibË_nodes
();

258 
numa_num_possibË_ıus
();

261 
numa_num_cÚfigu»d_nodes
();

264 
numa_num_cÚfigu»d_ıus
();

267 
numa_num_sk_ıus
();

268 
numa_num_th»ad_ıus
();

271 
numa_num_sk_nodes
();

272 
numa_num_th»ad_nodes
();

275 
b™mask
 *
numa_®loÿ‹_ıumask
();

277 
šlše
 
numa_ä“_ıumask
(
b™mask
 *
b
)

279 
numa_b™mask_ä“
(
b
);

283 
numa_node_to_ıus
(, 
b™mask
 *);

286 
numa_node_of_ıu
(
ıu
);

289 
numa_di¡ªû
(
node1
, 
node2
);

295 
numa_”rÜ
(*
wh”e
);

299 
numa_ex™_Ú_”rÜ
;

302 
numa_w¬n
(
num
, *
fmt
, ...);

305 
numa_ex™_Ú_w¬n
;

307 
numa_mig¿‹_·ges
(
pid
, 
b™mask
 *
äom
, b™mask *
to
);

309 
numa_move_·ges
(
pid
, 
couÁ
, **
·ges
,

310 cÚ¡ *
nodes
, *
¡©us
, 
æags
);

312 
numa_sched_g‘affš™y
(
pid_t
, 
b™mask
 *);

313 
numa_sched_£ffš™y
(
pid_t
, 
b™mask
 *);

316 
b™mask
 *
numa_·r£_node¡ršg
(const *);

320 
b™mask
 *
numa_·r£_node¡ršg_®l
(const *);

323 
b™mask
 *
numa_·r£_ıu¡ršg
(const *);

327 
b™mask
 *
numa_·r£_ıu¡ršg_®l
(const *);

335 
šlše
 
numa_£t_š‹¾—ve_mask_com·t
(
nodemask_t
 *
nodemask
)

337 
b™mask
 
	gtmp
;

339 
	gtmp
.
	gmaskp
 = (*)
nodemask
;

340 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

341 
numa_£t_š‹¾—ve_mask
(&
tmp
);

344 
šlše
 
nodemask_t
 
numa_g‘_š‹¾—ve_mask_com·t
()

346 
b™mask
 *
	g
;

347 
nodemask_t
 
	gmask
;

349 
	g
 = 
numa_g‘_š‹¾—ve_mask
();

350 
cİy_b™mask_to_nodemask
(

, &
mask
);

351 
numa_b™mask_ä“
(

);

352  
	gmask
;

355 
šlše
 
numa_bšd_com·t
(
nodemask_t
 *
mask
)

357 
b™mask
 *
	g
;

359 
	g
 = 
numa_®loÿ‹_nodemask
();

360 
cİy_nodemask_to_b™mask
(
mask
, 

);

361 
numa_bšd
(

);

362 
numa_b™mask_ä“
(

);

365 
šlše
 
numa_£t_membšd_com·t
(
nodemask_t
 *
mask
)

367 
b™mask
 
	gtmp
;

369 
	gtmp
.
	gmaskp
 = (*)
mask
;

370 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

371 
numa_£t_membšd
(&
tmp
);

374 
šlše
 
nodemask_t
 
numa_g‘_membšd_com·t
()

376 
b™mask
 *
	g
;

377 
nodemask_t
 
	gmask
;

379 
	g
 = 
numa_g‘_membšd
();

380 
cİy_b™mask_to_nodemask
(

, &
mask
);

381 
numa_b™mask_ä“
(

);

382  
	gmask
;

385 
šlše
 *
numa_®loc_š‹¾—ved_sub£t_com·t
(
size_t
 
size
,

386 cÚ¡ 
nodemask_t
 *
mask
)

388 
b™mask
 
	gtmp
;

390 
	gtmp
.
	gmaskp
 = (*)
mask
;

391 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

392  
numa_®loc_š‹¾—ved_sub£t
(
size
, &
tmp
);

395 
šlše
 
numa_run_Ú_node_mask_com·t
(cÚ¡ 
nodemask_t
 *
mask
)

397 
b™mask
 
	gtmp
;

399 
	gtmp
.
	gmaskp
 = (*)
mask
;

400 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

401  
numa_run_Ú_node_mask
(&
tmp
);

404 
šlše
 
nodemask_t
 
numa_g‘_run_node_mask_com·t
()

406 
b™mask
 *
	g
;

407 
nodemask_t
 
	gmask
;

409 
	g
 = 
numa_g‘_run_node_mask
();

410 
cİy_b™mask_to_nodemask
(

, &
mask
);

411 
numa_b™mask_ä“
(

);

412  
	gmask
;

415 
šlše
 
numa_š‹¾—ve_memÜy_com·t
(*
mem
, 
size_t
 
size
,

416 cÚ¡ 
nodemask_t
 *
mask
)

418 
b™mask
 
	gtmp
;

420 
	gtmp
.
	gmaskp
 = (*)
mask
;

421 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

422 
numa_š‹¾—ve_memÜy
(
mem
, 
size
, &
tmp
);

425 
šlše
 
numa_tÚodemask_memÜy_com·t
(*
mem
, 
size_t
 
size
,

426 cÚ¡ 
nodemask_t
 *
mask
)

428 
b™mask
 
	gtmp
;

430 
	gtmp
.
	gmaskp
 = (*)
mask
;

431 
	gtmp
.
	gsize
 = (
nodemask_t
) * 8;

432 
numa_tÚodemask_memÜy
(
mem
, 
size
, &
tmp
);

435 
šlše
 
numa_sched_g‘affš™y_com·t
(
pid_t
 
pid
, 
Ën
,

436 *
mask
)

438 
b™mask
 
	gtmp
;

440 
	gtmp
.
	gmaskp
 = (*)
mask
;

441 
	gtmp
.
	gsize
 = 
Ën
 * 8;

442  
numa_sched_g‘affš™y
(
pid
, &
tmp
);

445 
šlše
 
numa_sched_£ffš™y_com·t
(
pid_t
 
pid
, 
Ën
,

446 *
mask
)

448 
b™mask
 
	gtmp
;

450 
	gtmp
.
	gmaskp
 = (*)
mask
;

451 
	gtmp
.
	gsize
 = 
Ën
 * 8;

452  
numa_sched_£ffš™y
(
pid
, &
tmp
);

455 
šlše
 
numa_node_to_ıus_com·t
(
node
, *
bufãr
,

456 
bufãr_Ën
)

458 
b™mask
 
	gtmp
;

460 
	gtmp
.
	gmaskp
 = (*)
bufãr
;

461 
	gtmp
.
	gsize
 = 
bufãr_Ën
 * 8;

462  
numa_node_to_ıus
(
node
, &
tmp
);

471 #ifdeà
NUMA_VERSION1_COMPATIBILITY


472 
	~<numacom·t1.h
>

475 #ifdeà
__ılu¥lus


	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

34 
	mPTHREAD_CREATE_JOINABLE
,

35 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

36 
	mPTHREAD_CREATE_DETACHED


37 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

44 
	mPTHREAD_MUTEX_TIMED_NP
,

45 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

46 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

47 
	mPTHREAD_MUTEX_ADAPTIVE_NP


48 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


50 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

51 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

52 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

53 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


55 #ifdeà
__USE_GNU


57 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


62 #ifdeà
__USE_XOPEN2K


66 
	mPTHREAD_MUTEX_STALLED
,

67 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_ROBUST
,

69 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


74 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


78 
	mPTHREAD_PRIO_NONE
,

79 
	mPTHREAD_PRIO_INHERIT
,

80 
	mPTHREAD_PRIO_PROTECT


86 #ià
__PTHREAD_MUTEX_HAVE_ELISION
 == 1

87 
	#__PTHREAD_SPINS
 0, 0

	)

88 #–ià
__PTHREAD_MUTEX_HAVE_ELISION
 == 2

89 
	#__PTHREAD_SPINS
 { 0, 0 }

	)

91 
	#__PTHREAD_SPINS
 0

	)

94 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


95 
	#PTHREAD_MUTEX_INITIALIZER
 \

96 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

97 #ifdeà
__USE_GNU


98 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

99 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

100 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

101 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

102 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

103 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

104 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

105 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

109 
	#PTHREAD_MUTEX_INITIALIZER
 \

110 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

111 #ifdeà
__USE_GNU


112 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

113 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

114 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

115 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

116 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

117 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

124 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


127 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

128 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

129 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

130 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


136 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


137 #ià
__WORDSIZE
 == 64

138 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

143 
	#PTHREAD_RWLOCK_INITIALIZER
 \

144 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 } }

	)

145 #ifdeà
__USE_GNU


146 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


147 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

149 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

151 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


152 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

153 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

154 0, 0, 0, 0 } }

	)

156 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

157 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

158 0 } }

	)

168 
	mPTHREAD_INHERIT_SCHED
,

169 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

170 
	mPTHREAD_EXPLICIT_SCHED


171 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

178 
	mPTHREAD_SCOPE_SYSTEM
,

179 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

180 
	mPTHREAD_SCOPE_PROCESS


181 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

188 
	mPTHREAD_PROCESS_PRIVATE
,

189 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

190 
	mPTHREAD_PROCESS_SHARED


191 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

197 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

201 
	s_±h»ad_ş—nup_bufãr


203 (*
	m__routše
) (*);

204 *
	m__¬g
;

205 
	m__ÿnûÉy³
;

206 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

212 
	mPTHREAD_CANCEL_ENABLE
,

213 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

214 
	mPTHREAD_CANCEL_DISABLE


215 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

219 
	mPTHREAD_CANCEL_DEFERRED
,

220 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

221 
	mPTHREAD_CANCEL_ASYNCHRONOUS


222 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

224 
	#PTHREAD_CANCELED
 ((*è-1)

	)

228 
	#PTHREAD_ONCE_INIT
 0

	)

231 #ifdeà
__USE_XOPEN2K


235 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

239 
__BEGIN_DECLS


244 
±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

245 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

246 *(*
__¡¬t_routše
) (*),

247 *
__»¡riù
 
__¬g
è
__THROWNL
 
__nÚnuÎ
 ((1, 3));

253 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

261 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

263 #ifdeà
__USE_GNU


266 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

274 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

275 cÚ¡ 
time¥ec
 *
__ab¡ime
);

282 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

286 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

289 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

290 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

298 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

301 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

302 
__THROW
 
	`__nÚnuÎ
 ((1));

305 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

306 *
__d‘ach¡©e
)

307 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

310 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

311 
__d‘ach¡©e
)

312 
__THROW
 
	`__nÚnuÎ
 ((1));

316 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

317 
size_t
 *
__gu¬dsize
)

318 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

321 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

322 
size_t
 
__gu¬dsize
)

323 
__THROW
 
	`__nÚnuÎ
 ((1));

327 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

328 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

333 cÚ¡ 
sched_·¿m
 *
__»¡riù


334 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

337 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


338 
__©Œ
, *
__»¡riù
 
__pŞicy
)

339 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

342 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

343 
__THROW
 
	`__nÚnuÎ
 ((1));

346 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


347 
__©Œ
, *
__»¡riù
 
__šh”™
)

348 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

351 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

352 
__šh”™
)

353 
__THROW
 
	`__nÚnuÎ
 ((1));

357 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

358 *
__»¡riù
 
__scİe
)

359 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

362 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

363 
__THROW
 
	`__nÚnuÎ
 ((1));

366 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


367 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

368 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

374 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

375 *
__¡ackaddr
)

376 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

379 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


380 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

381 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

387 
size_t
 
__¡acksize
)

388 
__THROW
 
	`__nÚnuÎ
 ((1));

390 #ifdeà
__USE_XOPEN2K


392 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

393 **
__»¡riù
 
__¡ackaddr
,

394 
size_t
 *
__»¡riù
 
__¡acksize
)

395 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

400 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

401 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

404 #ifdeà
__USE_GNU


407 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

408 
size_t
 
__ıu£tsize
,

409 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

410 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

414 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

415 
size_t
 
__ıu£tsize
,

416 
ıu_£t_t
 *
__ıu£t
)

417 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

420 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

421 
__THROW
 
	`__nÚnuÎ
 ((1));

425 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

426 
__THROW
 
	`__nÚnuÎ
 ((1));

431 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

440 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

441 cÚ¡ 
sched_·¿m
 *
__·¿m
)

442 
__THROW
 
	`__nÚnuÎ
 ((3));

445 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

446 *
__»¡riù
 
__pŞicy
,

447 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

448 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

451 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

452 
__THROW
;

455 #ifdeà
__USE_GNU


457 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

458 
size_t
 
__buæ’
)

459 
__THROW
 
	`__nÚnuÎ
 ((2));

462 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

463 
__THROW
 
	`__nÚnuÎ
 ((2));

467 #ifdeà
__USE_UNIX98


469 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

472 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

475 #ifdeà
__USE_GNU


480 
	$±h»ad_y›ld
 (è
__THROW
;

485 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

486 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

487 
__THROW
 
	`__nÚnuÎ
 ((3));

490 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

491 
ıu_£t_t
 *
__ıu£t
)

492 
__THROW
 
	`__nÚnuÎ
 ((3));

505 
	`±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

506 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

517 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

521 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

524 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

529 
	`±h»ad_‹¡ÿnûl
 ();

538 
__jmp_buf
 
__ÿnûl_jmp_buf
;

539 
__mask_was_§ved
;

540 } 
__ÿnûl_jmp_buf
[1];

541 *
__·d
[4];

542 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

545 #iâdeà
__ş—nup_fù_©Œibu‹


546 
	#__ş—nup_fù_©Œibu‹


	)

551 
	s__±h»ad_ş—nup_äame


553 (*
__ÿnûl_routše
) (*);

554 *
__ÿnûl_¬g
;

555 
__do_™
;

556 
__ÿnûl_ty³
;

559 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


560 #ifdeà
__ılu¥lus


562 şas 
	c__±h»ad_ş—nup_şass


564 (*
__ÿnûl_routše
) (*);

565 *
__ÿnûl_¬g
;

566 
__do_™
;

567 
__ÿnûl_ty³
;

569 
public
:

570 
	`__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

571 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

572 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

573 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

574 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

575 &
__ÿnûl_ty³
); 
	}
}

576 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

586 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

588 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

592 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

593 
__şäame
.
	`__£tdo™
 (
execu‹
); \

594 } 0)

	)

596 #ifdeà
__USE_GNU


600 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

602 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

603 
__şäame
.
	`__deãr
 ()

	)

608 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

609 
__şäame
.
	`__»¡Üe
 (); \

610 
__şäame
.
	`__£tdo™
 (
execu‹
); \

611 } 0)

	)

618 
__ex‹º_šlše
 

619 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

621 ià(
__äame
->
__do_™
)

622 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

623 
	}
}

632 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

634 
__±h»ad_ş—nup_äame
 
__şäame
 \

635 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

636 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

637 .
__do_™
 = 1 };

	)

641 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

642 
__şäame
.
__do_™
 = (
execu‹
); \

643 } 0)

	)

645 #ifdeà
__USE_GNU


649 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

651 
__±h»ad_ş—nup_äame
 
__şäame
 \

652 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

653 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

654 .
__do_™
 = 1 }; \

655 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

656 &
__şäame
.
__ÿnûl_ty³
)

	)

661 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

662 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

663 
__şäame
.
__do_™
 = (
execu‹
); \

664 } 0)

	)

675 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

677 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

678 (*
__ÿnûl_routše
è(*èğ(
routše
); \

679 *
__ÿnûl_¬g
 = (
¬g
); \

680 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

681 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

682 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

684 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

685 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

689 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

690 dØ{

	)

691 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

692 
__ş—nup_fù_©Œibu‹
;

696 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

699 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

700 ià(
execu‹
) \

701 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

702 } 0)

	)

703 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

704 
__ş—nup_fù_©Œibu‹
;

706 #ifdeà
__USE_GNU


710 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

712 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

713 (*
__ÿnûl_routše
è(*èğ(
routše
); \

714 *
__ÿnûl_¬g
 = (
¬g
); \

715 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

716 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

717 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

719 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

720 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

724 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

725 dØ{

	)

726 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

727 
__ş—nup_fù_©Œibu‹
;

732 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

735 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

736 ià(
execu‹
) \

737 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

738 
	}
} 0)

	)

739 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

740 
__ş—nup_fù_©Œibu‹
;

744 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

745 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

746 #iâdeà
SHARED


747 
	`__©Œibu‹__
 ((
__w—k__
))

753 
__jmp_buf_g
;

754 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

760 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

761 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

762 
__THROW
 
	`__nÚnuÎ
 ((1));

765 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

766 
__THROW
 
	`__nÚnuÎ
 ((1));

769 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

770 
__THROWNL
 
	`__nÚnuÎ
 ((1));

773 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

774 
__THROWNL
 
	`__nÚnuÎ
 ((1));

776 #ifdeà
__USE_XOPEN2K


778 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

779 cÚ¡ 
time¥ec
 *
__»¡riù


780 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

784 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

785 
__THROWNL
 
	`__nÚnuÎ
 ((1));

789 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

790 
__»¡riù
 
__mu‹x
,

791 *
__»¡riù
 
__´ioûšg
)

792 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

796 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

797 
__´ioûšg
,

798 *
__»¡riù
 
__Şd_ûšg
)

799 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

802 #ifdeà
__USE_XOPEN2K8


804 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

805 
__THROW
 
	`__nÚnuÎ
 ((1));

806 #ifdeà
__USE_GNU


807 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

808 
__THROW
 
	`__nÚnuÎ
 ((1));

817 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

818 
__THROW
 
	`__nÚnuÎ
 ((1));

821 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

822 
__THROW
 
	`__nÚnuÎ
 ((1));

825 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

826 
__»¡riù
 
__©Œ
,

827 *
__»¡riù
 
__psh¬ed
)

828 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

831 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

832 
__psh¬ed
)

833 
__THROW
 
	`__nÚnuÎ
 ((1));

835 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


837 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


838 
__©Œ
, *
__»¡riù
 
__kšd
)

839 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

844 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

845 
__THROW
 
	`__nÚnuÎ
 ((1));

849 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

850 
__»¡riù
 
__©Œ
,

851 *
__»¡riù
 
__´ÙocŞ
)

852 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__´ÙocŞ
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

861 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

862 
__»¡riù
 
__©Œ
,

863 *
__»¡riù
 
__´ioûšg
)

864 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

867 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

868 
__´ioûšg
)

869 
__THROW
 
	`__nÚnuÎ
 ((1));

871 #ifdeà
__USE_XOPEN2K


873 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

874 *
__robu¡Ãss
)

875 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

876 #ifdeà
__USE_GNU


877 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

878 *
__robu¡Ãss
)

879 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

883 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

884 
__robu¡Ãss
)

885 
__THROW
 
	`__nÚnuÎ
 ((1));

886 #ifdeà
__USE_GNU


887 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

888 
__robu¡Ãss
)

889 
__THROW
 
	`__nÚnuÎ
 ((1));

894 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


899 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

900 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


901 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

904 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

905 
__THROW
 
	`__nÚnuÎ
 ((1));

908 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

909 
__THROWNL
 
	`__nÚnuÎ
 ((1));

912 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

913 
__THROWNL
 
	`__nÚnuÎ
 ((1));

915 #ifdeà
__USE_XOPEN2K


917 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

918 cÚ¡ 
time¥ec
 *
__»¡riù


919 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

923 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

924 
__THROWNL
 
	`__nÚnuÎ
 ((1));

927 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

928 
__THROWNL
 
	`__nÚnuÎ
 ((1));

930 #ifdeà
__USE_XOPEN2K


932 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

933 cÚ¡ 
time¥ec
 *
__»¡riù


934 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

938 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

939 
__THROWNL
 
	`__nÚnuÎ
 ((1));

945 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

946 
__THROW
 
	`__nÚnuÎ
 ((1));

949 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

950 
__THROW
 
	`__nÚnuÎ
 ((1));

953 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

954 
__»¡riù
 
__©Œ
,

955 *
__»¡riù
 
__psh¬ed
)

956 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

959 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

960 
__psh¬ed
)

961 
__THROW
 
	`__nÚnuÎ
 ((1));

964 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

965 
__»¡riù
 
__©Œ
,

966 *
__»¡riù
 
__´ef
)

967 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

970 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

971 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

979 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

980 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

981 
__THROW
 
	`__nÚnuÎ
 ((1));

984 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

985 
__THROW
 
	`__nÚnuÎ
 ((1));

988 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

989 
__THROWNL
 
	`__nÚnuÎ
 ((1));

992 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

993 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1000 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1001 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

1002 
	`__nÚnuÎ
 ((1, 2));

1011 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1012 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1013 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1014 
	`__nÚnuÎ
 ((1, 2, 3));

1019 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1));

1023 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1024 
__THROW
 
	`__nÚnuÎ
 ((1));

1027 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1028 
__»¡riù
 
__©Œ
,

1029 *
__»¡riù
 
__psh¬ed
)

1030 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1033 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1034 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1036 #ifdeà
__USE_XOPEN2K


1038 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1039 
__»¡riù
 
__©Œ
,

1040 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1041 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1044 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1045 
__şockid_t
 
__şock_id
)

1046 
__THROW
 
	`__nÚnuÎ
 ((1));

1050 #ifdeà
__USE_XOPEN2K


1055 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1056 
__THROW
 
	`__nÚnuÎ
 ((1));

1059 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1060 
__THROW
 
	`__nÚnuÎ
 ((1));

1063 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1064 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1067 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1068 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1071 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1072 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1079 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1080 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1081 
__©Œ
, 
__couÁ
)

1082 
__THROW
 
	`__nÚnuÎ
 ((1));

1085 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1086 
__THROW
 
	`__nÚnuÎ
 ((1));

1089 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1090 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1094 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1095 
__THROW
 
	`__nÚnuÎ
 ((1));

1098 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1099 
__THROW
 
	`__nÚnuÎ
 ((1));

1102 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1103 
__»¡riù
 
__©Œ
,

1104 *
__»¡riù
 
__psh¬ed
)

1105 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1108 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1109 
__psh¬ed
)

1110 
__THROW
 
	`__nÚnuÎ
 ((1));

1122 
	`±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1123 (*
__de¡r_funùiÚ
) (*))

1124 
__THROW
 
	`__nÚnuÎ
 ((1));

1127 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1130 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1133 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1134 cÚ¡ *
__poš‹r
è
__THROW
 ;

1137 #ifdeà
__USE_XOPEN2K


1139 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1140 
__şockid_t
 *
__şock_id
)

1141 
__THROW
 
	`__nÚnuÎ
 ((2));

1156 
	`±h»ad_©fÜk
 ((*
__´•¬e
) (),

1157 (*
__·»Á
) (),

1158 (*
__chd
è()è
__THROW
;

1161 #ifdeà
__USE_EXTERN_INLINES


1163 
__ex‹º_šlše
 

1164 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1166  
__th»ad1
 =ğ
__th»ad2
;

1167 
	}
}

1170 
	g__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

30 
	#__Ãed_time_t


	)

31 
	#__Ãed_time¥ec


	)

32 
	~<time.h
>

34 #iâdeà
__pid_t_defšed


35 
__pid_t
 
	tpid_t
;

36 
	#__pid_t_defšed


	)

41 
	~<b™s/sched.h
>

43 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

46 
__BEGIN_DECLS


49 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

50 
__THROW
;

53 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

56 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

57 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

60 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

63 
	$sched_y›ld
 (è
__THROW
;

66 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

69 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

72 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

75 #ifdeà
__USE_GNU


77 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

78 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

79 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

80 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

81 
ıu£
)

	)

82 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

83 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

86 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

87 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

88 
ıu£
)

	)

89 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

90 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

92 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

93 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

94 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

97 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

98 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

99 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

101 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

103 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

105 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

107 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

110 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

111 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

112 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

116 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

117 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

120 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

121 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

124 
__END_DECLS


	@/usr/include/semaphore.h

18 #iâdeà
_SEMAPHORE_H


19 
	#_SEMAPHORE_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<sys/ty³s.h
>

23 #ifdeà
__USE_XOPEN2K


24 
	#__Ãed_time¥ec


	)

25 
	~<time.h
>

29 
	~<b™s/£m­hÜe.h
>

32 
__BEGIN_DECLS


36 
	$£m_š™
 (
£m_t
 *
__£m
, 
__psh¬ed
, 
__v®ue
)

37 
__THROW
;

39 
	$£m_de¡roy
 (
£m_t
 *
__£m
è
__THROW
;

42 
£m_t
 *
	$£m_İ’
 (cÚ¡ *
__Çme
, 
__oæag
, ...è
__THROW
;

45 
	$£m_şo£
 (
£m_t
 *
__£m
è
__THROW
;

48 
	$£m_uÆšk
 (cÚ¡ *
__Çme
è
__THROW
;

54 
	`£m_wa™
 (
£m_t
 *
__£m
);

56 #ifdeà
__USE_XOPEN2K


61 
	`£m_timedwa™
 (
£m_t
 *
__»¡riù
 
__£m
,

62 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
);

66 
	$£m_Œywa™
 (
£m_t
 *
__£m
è
__THROWNL
;

69 
	$£m_po¡
 (
£m_t
 *
__£m
è
__THROWNL
;

72 
	$£m_g‘v®ue
 (
£m_t
 *
__»¡riù
 
__£m
, *__»¡riù 
__sv®
)

73 
__THROW
;

76 
__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


24 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


25 
	#_SIGNAL_H


	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	~<b™s/sig£t.h
>

36 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


37 #iâdeà
__sig_©omic_t_defšed


38 
	#__sig_©omic_t_defšed


	)

39 
__BEGIN_NAMESPACE_STD


40 
__sig_©omic_t
 
	tsig_©omic_t
;

41 
	g__END_NAMESPACE_STD


43 #undeà
__Ãed_sig_©omic_t


46 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

47 #iâdeà
__sig£t_t_defšed


48 
	#__sig£t_t_defšed


	)

49 
__sig£t_t
 
	tsig£t_t
;

51 #undeà
__Ãed_sig£t_t


54 #ifdeà
_SIGNAL_H


56 
	~<b™s/ty³s.h
>

57 
	~<b™s/signum.h
>

59 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


60 #iâdeà
__pid_t_defšed


61 
__pid_t
 
	tpid_t
;

62 
	#__pid_t_defšed


	)

64 #ifdeà
__USE_XOPEN


66 #iâdeà
__uid_t_defšed


67 
__uid_t
 
	tuid_t
;

68 
	#__uid_t_defšed


	)

72 #ifdeà
__USE_POSIX199309


74 
	#__Ãed_time¥ec


	)

75 
	~<time.h
>

78 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


80 
	~<b™s/sigšfo.h
>

85 (*
	t__sighªdËr_t
) ();

90 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

91 
__THROW
;

92 #ifdeà
__USE_GNU


93 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

94 
__THROW
;

100 
__BEGIN_NAMESPACE_STD


101 #ifdeà
__USE_BSD


102 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

103 
__THROW
;

106 #ifdeà
__REDIRECT_NTH


107 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

108 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

109 
__sysv_sigÇl
);

111 
	#sigÇl
 
__sysv_sigÇl


	)

114 
__END_NAMESPACE_STD


116 #ifdeà
__USE_XOPEN


119 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

120 
__THROW
;

126 #ifdeà
__USE_POSIX


127 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

130 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


134 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

137 
__BEGIN_NAMESPACE_STD


139 
	$¿i£
 (
__sig
è
__THROW
;

140 
__END_NAMESPACE_STD


142 #ifdeà
__USE_SVID


144 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

145 
__THROW
;

146 
	$gsigÇl
 (
__sig
è
__THROW
;

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K


151 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

154 #ifdeà
__USE_XOPEN2K


156 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

167 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

169 #ifdeà
__USE_XOPEN


170 #ifdeà
__GNUC__


171 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

174 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

179 #ifdeà
__USE_BSD


186 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

189 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

192 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

195 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

199 #ifdeà
__USE_MISC


200 
	#NSIG
 
_NSIG


	)

203 #ifdeà
__USE_GNU


204 
__sighªdËr_t
 
	tsighªdËr_t
;

208 #ifdeà
__USE_BSD


209 
__sighªdËr_t
 
	tsig_t
;

212 #ifdeà
__USE_POSIX


215 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

218 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

221 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

224 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

227 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

228 
__THROW
 
	`__nÚnuÎ
 ((1));

230 #ifdeà
__USE_GNU


232 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

235 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

236 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

239 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

240 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

245 
	~<b™s/sigaùiÚ.h
>

248 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

249 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

256 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

259 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

260 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

263 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

270 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

271 
	`__nÚnuÎ
 ((1, 2));

273 #ifdeà
__USE_POSIX199309


278 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

279 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

286 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

287 
sigšfo_t
 *
__»¡riù
 
__šfo
,

288 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

289 
	`__nÚnuÎ
 ((1));

293 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

294 
__THROW
;

299 #ifdeà
__USE_BSD


303 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

304 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

307 
	ssigvec


309 
__sighªdËr_t
 
sv_hªdËr
;

310 
sv_mask
;

312 
sv_æags
;

313 
	#sv_Ú¡ack
 
sv_æags


	)

317 
	#SV_ONSTACK
 (1 << 0)

	)

318 
	#SV_INTERRUPT
 (1 << 1)

	)

319 
	#SV_RESETHAND
 (1 << 2)

	)

327 
	$sigvec
 (
__sig
, cÚ¡ 
sigvec
 *
__vec
,

328 
sigvec
 *
__ovec
è
__THROW
;

332 
	~<b™s/sigcÚ‹xt.h
>

335 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

340 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


341 
	#__Ãed_size_t


	)

342 
	~<¡ddef.h
>

347 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

349 
	~<b™s/sig¡ack.h
>

350 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


352 
	~<sys/ucÚ‹xt.h
>

358 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

359 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

363 
	$sig®t¡ack
 (cÚ¡ 
sig®t¡ack
 *
__»¡riù
 
__ss
,

364 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

368 #ifdeà
__USE_XOPEN_EXTENDED


372 
	$sighŞd
 (
__sig
è
__THROW
;

375 
	$sig»l£
 (
__sig
è
__THROW
;

378 
	$sigignÜe
 (
__sig
è
__THROW
;

381 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

384 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


387 
	~<b™s/±h»adty³s.h
>

388 
	~<b™s/sigth»ad.h
>

395 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

397 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

401 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 
	#SIZE_MAX
 (4294967295U)

	)

267 #iâdeà
WCHAR_MIN


269 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

270 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

274 
	#WINT_MIN
 (0u)

	)

275 
	#WINT_MAX
 (4294967295u)

	)

278 
	#INT8_C
(
c
è
	)
c

279 
	#INT16_C
(
c
è
	)
c

280 
	#INT32_C
(
c
è
	)
c

281 #ià
__WORDSIZE
 == 64

282 
	#INT64_C
(
c
èø## 
L


	)

284 
	#INT64_C
(
c
èø## 
LL


	)

288 
	#UINT8_C
(
c
è
	)
c

289 
	#UINT16_C
(
c
è
	)
c

290 
	#UINT32_C
(
c
èø## 
U


	)

291 #ià
__WORDSIZE
 == 64

292 
	#UINT64_C
(
c
èø## 
UL


	)

294 
	#UINT64_C
(
c
èø## 
ULL


	)

298 #ià
__WORDSIZE
 == 64

299 
	#INTMAX_C
(
c
èø## 
L


	)

300 
	#UINTMAX_C
(
c
èø## 
UL


	)

302 
	#INTMAX_C
(
c
èø## 
LL


	)

303 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_SVID
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_BSD
 || defšed 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_BSD


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ià(
defšed
 
__USE_POSIX2
 || defšed 
__USE_SVID
 || defšed 
__USE_BSD
 || \

868 
defšed
 
__USE_MISC
)

873 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

879 
	`pşo£
 (
FILE
 *
__¡»am
);

883 #ifdef 
__USE_POSIX


885 *
	$ù”mid
 (*
__s
è
__THROW
;

889 #ifdeà
__USE_XOPEN


891 *
	`cu£rid
 (*
__s
);

895 #ifdef 
__USE_GNU


896 
ob¡ack
;

899 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

900 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

901 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

902 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

903 cÚ¡ *
__»¡riù
 
__fÜm©
,

904 
_G_va_li¡
 
__¬gs
)

905 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

909 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


913 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

917 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

920 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

923 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


927 
	#__Ãed_g‘İt


	)

928 
	~<g‘İt.h
>

933 #ifdeà
__USE_EXTERN_INLINES


934 
	~<b™s/¡dio.h
>

936 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


937 
	~<b™s/¡dio2.h
>

939 #ifdeà
__LDBL_COMPAT


940 
	~<b™s/¡dio-ldbl.h
>

943 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_BSD


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_MISC


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_BSD


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_MISC


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_BSD


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ià
defšed
 
__USE_GNU
 || defšed 
__USE_BSD
 || defšed 
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_BSD


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	`©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	`©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	`©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	`Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 \

610 || 
defšed
 
__USE_XOPEN2K8


619 #iâdeà
__USE_FILE_OFFSET64


620 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

622 #ifdeà
__REDIRECT


623 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

624 
	`__nÚnuÎ
 ((1)è
__wur
;

626 
	#mk¡emp
 
mk¡emp64


	)

629 #ifdeà
__USE_LARGEFILE64


630 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

634 #ifdeà
__USE_MISC


641 #iâdeà
__USE_FILE_OFFSET64


642 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

644 #ifdeà
__REDIRECT


645 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

646 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

648 
	#mk¡emps
 
mk¡emps64


	)

651 #ifdeà
__USE_LARGEFILE64


652 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

653 
	`__nÚnuÎ
 ((1)è
__wur
;

657 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K8


663 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

666 #ifdeà
__USE_GNU


673 #iâdeà
__USE_FILE_OFFSET64


674 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

676 #ifdeà
__REDIRECT


677 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

678 
	`__nÚnuÎ
 ((1)è
__wur
;

680 
	#mko¡emp
 
mko¡emp64


	)

683 #ifdeà
__USE_LARGEFILE64


684 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

693 #iâdeà
__USE_FILE_OFFSET64


694 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

695 
	`__nÚnuÎ
 ((1)è
__wur
;

697 #ifdeà
__REDIRECT


698 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

699 
__æags
), 
mko¡emps64
)

700 
	`__nÚnuÎ
 ((1)è
__wur
;

702 
	#mko¡emps
 
mko¡emps64


	)

705 #ifdeà
__USE_LARGEFILE64


706 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

707 
	`__nÚnuÎ
 ((1)è
__wur
;

712 
__BEGIN_NAMESPACE_STD


717 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

718 
__END_NAMESPACE_STD


721 #ifdef 
__USE_GNU


724 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

725 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

728 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


734 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

735 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

740 #iâdeà
__COMPAR_FN_T


741 
	#__COMPAR_FN_T


	)

742 (*
	t__com·r_â_t
) (const *, const *);

744 #ifdef 
__USE_GNU


745 
__com·r_â_t
 
	tcom·risÚ_â_t
;

748 #ifdeà
__USE_GNU


749 (*
	t__com·r_d_â_t
) (const *, const *, *);

752 
__BEGIN_NAMESPACE_STD


755 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

756 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

757 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

759 #ifdeà
__USE_EXTERN_INLINES


760 
	~<b™s/¡dlib-b£¬ch.h
>

765 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

766 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

767 #ifdeà
__USE_GNU


768 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

769 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

770 
	`__nÚnuÎ
 ((1, 4));

775 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

777 
__END_NAMESPACE_STD


779 #ifdeà
__USE_ISOC99


780 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

781 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

785 
__BEGIN_NAMESPACE_STD


789 
div_t
 
	$div
 (
__num”
, 
__d’om
)

790 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

791 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

792 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

793 
__END_NAMESPACE_STD


795 #ifdeà
__USE_ISOC99


796 
__BEGIN_NAMESPACE_C99


797 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

798 
__d’om
)

799 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

800 
__END_NAMESPACE_C99


804 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

805 || 
defšed
 
__USE_SVID


812 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

813 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

818 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

819 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

824 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

825 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

828 #ifdeà
__USE_MISC


830 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

831 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

832 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

833 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

834 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

835 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

836 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

837 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

842 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

843 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

844 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

845 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

846 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

847 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

849 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

850 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

851 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

852 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

853 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

854 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

855 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

856 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

860 
__BEGIN_NAMESPACE_STD


863 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

866 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

867 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

870 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

874 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

875 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

877 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

878 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

879 
__THROW
;

880 
__END_NAMESPACE_STD


883 #ifdeà
__USE_SVID


888 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

892 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


899 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

900 *cÚ¡ *
__»¡riù
 
__tok’s
,

901 **
__»¡riù
 
__v®u•
)

902 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

906 #ifdeà
__USE_XOPEN


908 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

914 #ifdeà
__USE_XOPEN2KXSI


916 
	$posix_İ’±
 (
__oæag
è
__wur
;

919 #ifdeà
__USE_XOPEN


924 
	$g¿Á±
 (
__fd
è
__THROW
;

928 
	$uÆock±
 (
__fd
è
__THROW
;

933 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

936 #ifdeà
__USE_GNU


940 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

941 
__THROW
 
	`__nÚnuÎ
 ((2));

944 
	`g‘±
 ();

947 #ifdeà
__USE_BSD


951 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

952 
__THROW
 
	`__nÚnuÎ
 ((1));

955 
	~<b™s/¡dlib-æßt.h
>

958 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


959 
	~<b™s/¡dlib.h
>

961 #ifdeà
__LDBL_COMPAT


962 
	~<b™s/¡dlib-ldbl.h
>

966 #undeà
__Ãed_m®loc_ªd_ÿÎoc


968 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

39 #ià
defšed
 
__ılu¥lus
 && (__ılu¥lu >ğ199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

47 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

50 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

51 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN


58 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

69 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

73 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ifdeà
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


91  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifdeà
__USE_GNU


104 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

107 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

110 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

111 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

115 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

118 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

133 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

137 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

138 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

141 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

144 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

151 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

152 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

154 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

155 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

156 
__THROW
 
	`__nÚnuÎ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifdeà
__USE_XOPEN2K8


163 
	~<xloÿË.h
>

166 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

169 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

170 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

173 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 \

174 || 
defšed
 
__USE_XOPEN2K8


176 *
	$¡rdup
 (cÚ¡ *
__s
)

177 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_XOPEN2K8


184 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

185 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

188 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


190 
	#¡rdu·
(
s
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

196 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

197 
	}
}))

	)

200 
	#¡ºdu·
(
s
, 
n
) \

201 (
__ex‹nsiÚ__
 \

203 cÚ¡ *
__Şd
 = (
s
); \

204 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

205 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

206 
__Ãw
[
__Ën
] = '\0'; \

207 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
¡rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

218 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

221 #ifdeà
__OPTIMIZE__


222 
__ex‹º_®ways_šlše
 *

223 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


225  
__butš_¡rchr
 (
__s
, 
__c
);

228 
__ex‹º_®ways_šlše
 const *

229 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


231  
__butš_¡rchr
 (
__s
, 
__c
);

236 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

237 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`¡¼chr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

245 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

248 #ifdeà
__OPTIMIZE__


249 
__ex‹º_®ways_šlše
 *

250 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


252  
	`__butš_¡¼chr
 (
__s
, 
__c
);

255 
__ex‹º_®ways_šlše
 const *

256 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


258  
	`__butš_¡¼chr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

264 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifdeà
__USE_GNU


271 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

274 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

278 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

286 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

289 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

290 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

296 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

297 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

298 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

300 #ifdeà
__OPTIMIZE__


301 
__ex‹º_®ways_šlše
 *

302 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


304  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

307 
__ex‹º_®ways_šlše
 const *

308 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


310  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

313 
	}
}

315 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

316 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

323 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

324 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

325 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__OPTIMIZE__


328 
__ex‹º_®ways_šlše
 *

329 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


331  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

334 
__ex‹º_®ways_šlše
 const *

335 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


337  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

340 
	}
}

342 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

343 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

348 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

349 
__THROW
 
	`__nÚnuÎ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

355 cÚ¡ *
__»¡riù
 
__d–im
,

356 **
__»¡riù
 
__§ve_±r
)

357 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

358 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


359 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

360 **
__»¡riù
 
__§ve_±r
)

361 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

364 #ifdeà
__USE_GNU


366 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

368 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

369 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

370 cÚ¡ *
__ÃedË
)

371 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

374 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

378 #ifdeà
__USE_GNU


382 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

383 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

384 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

388 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

389 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

390 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

391 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

392 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

393 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

400 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

407 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

414 
__END_NAMESPACE_STD


415 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_MISC


423 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


426 #ifdeà
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

428 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

429 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

431 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

433 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

438 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

439 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

443 #ifdeà
__USE_XOPEN2K8


445 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

451 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

453 #ifdeà
__USE_BSD


455 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

462 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

466 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`šdex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

471 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

474 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__ex‹º_®ways_šlše
 *

476 
	`šdex
 (*
__s
, 
__c
è
__THROW


478  
	`__butš_šdex
 (
__s
, 
__c
);

481 
__ex‹º_®ways_šlše
 const *

482 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


484  
	`__butš_šdex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

490 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`ršdex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

499 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

502 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__ex‹º_®ways_šlše
 *

504 
	`ršdex
 (*
__s
, 
__c
è
__THROW


506  
	`__butš_ršdex
 (
__s
, 
__c
);

509 
__ex‹º_®ways_šlše
 const *

510 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


512  
	`__butš_ršdex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

518 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

523 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

527 #ifdef 
__USE_GNU


528 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

530 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

534 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

535 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

538 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

546 
__loÿË_t
 
__loc
)

547 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

549 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

550 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

551 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

558 cÚ¡ *
__»¡riù
 
__d–im
)

559 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

567 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

568 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

570 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

574 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

575 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

578 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

585 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

588 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

593 #iâdeà
ba£Çme


598 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£Çme
 (*
__f’ame
)

600 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

601 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

602 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

604 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

610 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

611 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

612 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


632 
	~<b™s/¡ršg.h
>

635 
	~<b™s/¡ršg2.h
>

638 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


640 
	~<b™s/¡ršg3.h
>

644 
__END_DECLS


	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

24 #ià!
defšed
 
_STRING_H
 || !defšed 
__USE_BSD


26 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && (__ılu¥lu >ğ199711L || 
__GNUC_PREREQ
 (4, 4))

36 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

39 
	g__BEGIN_DECLS


41 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


43 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

44 
__THROW
 
__©Œibu‹_pu»__
;

47 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
è
__THROW
;

50 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
;

53 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


56 *
	`šdex
 (*
__s
, 
__c
)

57 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

58 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

59 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

61 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRING_H_PROTO


62 
__ex‹º_®ways_šlše
 *

63 
	`šdex
 (*
__s
, 
__c
è
__THROW


65  
	`__butš_šdex
 (
__s
, 
__c
);

68 
__ex‹º_®ways_šlše
 const *

69 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


71  
	`__butš_šdex
 (
__s
, 
__c
);

74 
	}
}

76 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

77 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


84 *
	`ršdex
 (*
__s
, 
__c
)

85 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

86 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

87 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

89 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRING_H_PROTO


90 
__ex‹º_®ways_šlše
 *

91 
	`ršdex
 (*
__s
, 
__c
è
__THROW


93  
	`__butš_ršdex
 (
__s
, 
__c
);

96 
__ex‹º_®ways_šlše
 const *

97 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


99  
	`__butš_ršdex
 (
__s
, 
__c
);

102 
	}
}

104 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

105 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

109 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


112 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((const));

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
;

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
;

123 #ifdef 
__USE_XOPEN2K8


127 
	~<xloÿË.h
>

131 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__loc
)

132 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

134 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

135 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

136 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

139 
__END_DECLS


	@/usr/include/syslog.h

1 
	~<sys/sy¦og.h
>

	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_SVID


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

71 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

75 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

79 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

83 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

86 #ifdeà
__USE_XOPEN2K8


87 
	#_XOPEN_VERSION
 700

	)

88 #–ià
defšed
 
__USE_XOPEN2K


89 
	#_XOPEN_VERSION
 600

	)

90 #–ià
defšed
 
__USE_UNIX98


91 
	#_XOPEN_VERSION
 500

	)

93 
	#_XOPEN_VERSION
 4

	)

97 
	#_XOPEN_XCU_VERSION
 4

	)

100 
	#_XOPEN_XPG2
 1

	)

101 
	#_XOPEN_XPG3
 1

	)

102 
	#_XOPEN_XPG4
 1

	)

105 
	#_XOPEN_UNIX
 1

	)

108 
	#_XOPEN_CRYPT
 1

	)

112 
	#_XOPEN_ENH_I18N
 1

	)

115 
	#_XOPEN_LEGACY
 1

	)

202 
	~<b™s/posix_İt.h
>

205 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


206 
	~<b™s/’vœÚm’ts.h
>

210 
	#STDIN_FILENO
 0

	)

211 
	#STDOUT_FILENO
 1

	)

212 
	#STDERR_FILENO
 2

	)

217 
	~<b™s/ty³s.h
>

219 #iâdef 
__ssize_t_defšed


220 
__ssize_t
 
	tssize_t
;

221 
	#__ssize_t_defšed


	)

224 
	#__Ãed_size_t


	)

225 
	#__Ãed_NULL


	)

226 
	~<¡ddef.h
>

228 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


231 #iâdeà
__gid_t_defšed


232 
__gid_t
 
	tgid_t
;

233 
	#__gid_t_defšed


	)

236 #iâdeà
__uid_t_defšed


237 
__uid_t
 
	tuid_t
;

238 
	#__uid_t_defšed


	)

241 #iâdeà
__off_t_defšed


242 #iâdeà
__USE_FILE_OFFSET64


243 
__off_t
 
	toff_t
;

245 
__off64_t
 
	toff_t
;

247 
	#__off_t_defšed


	)

249 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


250 
__off64_t
 
	toff64_t
;

251 
	#__off64_t_defšed


	)

254 #iâdeà
__u£cÚds_t_defšed


255 
__u£cÚds_t
 
	tu£cÚds_t
;

256 
	#__u£cÚds_t_defšed


	)

259 #iâdeà
__pid_t_defšed


260 
__pid_t
 
	tpid_t
;

261 
	#__pid_t_defšed


	)

265 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


266 #iâdeà
__šŒ_t_defšed


267 
__šŒ_t
 
	tšŒ_t
;

268 
	#__šŒ_t_defšed


	)

272 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


273 #iâdeà
__sockËn_t_defšed


274 
__sockËn_t
 
	tsockËn_t
;

275 
	#__sockËn_t_defšed


	)

281 
	#R_OK
 4

	)

282 
	#W_OK
 2

	)

283 
	#X_OK
 1

	)

284 
	#F_OK
 0

	)

287 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

289 #ifdeà
__USE_GNU


292 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

293 
__THROW
 
	`__nÚnuÎ
 ((1));

296 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

297 
__THROW
 
	`__nÚnuÎ
 ((1));

300 #ifdeà
__USE_ATFILE


304 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

305 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

310 #iâdef 
_STDIO_H


311 
	#SEEK_SET
 0

	)

312 
	#SEEK_CUR
 1

	)

313 
	#SEEK_END
 2

	)

314 #ifdeà
__USE_GNU


315 
	#SEEK_DATA
 3

	)

316 
	#SEEK_HOLE
 4

	)

320 #ià
defšed
 
__USE_BSD
 && !defšed 
L_SET


322 
	#L_SET
 
SEEK_SET


	)

323 
	#L_INCR
 
SEEK_CUR


	)

324 
	#L_XTND
 
SEEK_END


	)

333 #iâdeà
__USE_FILE_OFFSET64


334 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

336 #ifdeà
__REDIRECT_NTH


337 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

338 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

339 
l£ek64
);

341 
	#l£ek
 
l£ek64


	)

344 #ifdeà
__USE_LARGEFILE64


345 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

346 
__THROW
;

353 
	`şo£
 (
__fd
);

360 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

366 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

368 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


369 #iâdeà
__USE_FILE_OFFSET64


376 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

377 
__off_t
 
__off£t
è
__wur
;

384 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

385 
__off_t
 
__off£t
è
__wur
;

387 #ifdeà
__REDIRECT


388 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

389 
__off64_t
 
__off£t
),

390 
´—d64
è
__wur
;

391 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

392 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

393 
pwr™e64
è
__wur
;

395 
	#´—d
 
´—d64


	)

396 
	#pwr™e
 
pwr™e64


	)

400 #ifdeà
__USE_LARGEFILE64


404 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

405 
__off64_t
 
__off£t
è
__wur
;

408 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

409 
__off64_t
 
__off£t
è
__wur
;

417 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

419 #ifdeà
__USE_GNU


422 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

432 
	$®¬m
 (
__£cÚds
è
__THROW
;

444 
	`¦“p
 (
__£cÚds
);

446 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

447 || 
defšed
 
__USE_BSD


452 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

453 
__THROW
;

460 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

469 
	`·u£
 ();

473 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

474 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

476 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


478 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

483 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

484 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

488 #ifdeà
__USE_ATFILE


491 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

492 
__gid_t
 
__group
, 
__æag
)

493 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

497 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

499 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


501 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

511 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

513 #ifdef 
__USE_GNU


517 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

520 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

521 || 
defšed
 
__USE_BSD


525 *
	$g‘wd
 (*
__buf
)

526 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

531 
	$dup
 (
__fd
è
__THROW
 
__wur
;

534 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

536 #ifdeà
__USE_GNU


539 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

543 **
__’vœÚ
;

544 #ifdeà
__USE_GNU


545 **
’vœÚ
;

551 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

552 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

554 #ifdeà
__USE_XOPEN2K8


557 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

558 
__THROW
 
	`__nÚnuÎ
 ((2));

563 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

564 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

568 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

569 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

573 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

578 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

585 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 #ifdeà
__USE_GNU


590 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

591 *cÚ¡ 
__’vp
[])

592 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

596 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


598 
	$niû
 (
__šc
è
__THROW
 
__wur
;

603 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

609 
	~<b™s/cÚâame.h
>

612 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

613 
__THROW
 
	`__nÚnuÎ
 ((1));

616 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

619 
	$syscÚf
 (
__Çme
è
__THROW
;

621 #ifdef 
__USE_POSIX2


623 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

628 
__pid_t
 
	$g‘pid
 (è
__THROW
;

631 
__pid_t
 
	$g‘µid
 (è
__THROW
;

634 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

637 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

638 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


639 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

646 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

648 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


660 
	$£g½
 (è
__THROW
;

667 
__pid_t
 
	$£tsid
 (è
__THROW
;

669 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


671 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

675 
__uid_t
 
	$g‘uid
 (è
__THROW
;

678 
__uid_t
 
	$g‘euid
 (è
__THROW
;

681 
__gid_t
 
	$g‘gid
 (è
__THROW
;

684 
__gid_t
 
	$g‘egid
 (è
__THROW
;

689 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

691 #ifdef 
__USE_GNU


693 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

700 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

702 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


705 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

708 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


710 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

717 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

719 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


722 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

725 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


727 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

730 #ifdeà
__USE_GNU


733 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

734 
__THROW
;

738 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

739 
__THROW
;

743 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

744 
__THROW
 
__wur
;

748 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

749 
__THROW
 
__wur
;

756 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

758 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

759 || 
defšed
 
__USE_BSD


764 
__pid_t
 
	$vfÜk
 (è
__THROW
;

770 *
	$‰yÇme
 (
__fd
è
__THROW
;

774 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

775 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

779 
	$i§‰y
 (
__fd
è
__THROW
;

781 #ià
defšed
 
__USE_BSD
 \

782 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

785 
	$‰y¦Ù
 (è
__THROW
;

790 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

791 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

793 #ifdeà
__USE_ATFILE


796 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

797 cÚ¡ *
__to
, 
__æags
)

798 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

801 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


803 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

804 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

809 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

810 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

811 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

814 #ifdeà
__USE_ATFILE


816 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

817 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

820 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

821 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

822 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

826 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

828 #ifdeà
__USE_ATFILE


830 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

831 
__THROW
 
	`__nÚnuÎ
 ((2));

835 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

839 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

842 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

849 *
	`g‘logš
 ();

850 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


857 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

860 #ifdef 
__USE_BSD


862 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

866 #ifdef 
__USE_POSIX2


870 
	#__Ãed_g‘İt


	)

871 
	~<g‘İt.h
>

875 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


879 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

886 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

887 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

897 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

898 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

899 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

900 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

906 
	$vhªgup
 (è
__THROW
;

909 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

917 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

918 
size_t
 
__off£t
, 
__sÿË
)

919 
__THROW
 
	`__nÚnuÎ
 ((1));

925 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

929 *
	$g‘u£rsh–l
 (è
__THROW
;

930 
	$’du£rsh–l
 (è
__THROW
;

931 
	$£tu£rsh–l
 (è
__THROW
;

937 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

941 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

944 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

948 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

956 
	`fsync
 (
__fd
);

959 #ifdeà
__USE_GNU


962 
	$syncfs
 (
__fd
è
__THROW
;

966 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


969 
	`g‘ho¡id
 ();

972 
	$sync
 (è
__THROW
;

975 #ià
defšed
 
__USE_BSD
 || !defšed 
__USE_XOPEN2K


978 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

983 
	$g‘dbËsize
 (è
__THROW
;

989 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


992 #iâdeà
__USE_FILE_OFFSET64


993 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

994 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

996 #ifdeà
__REDIRECT_NTH


997 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

998 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

999 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1001 
	#Œunÿ‹
 
Œunÿ‹64


	)

1004 #ifdeà
__USE_LARGEFILE64


1005 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1006 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1011 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_POSIX199309
 \

1012 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1015 #iâdeà
__USE_FILE_OFFSET64


1016 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1018 #ifdeà
__REDIRECT_NTH


1019 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1020 
árunÿ‹64
è
__wur
;

1022 
	#árunÿ‹
 
árunÿ‹64


	)

1025 #ifdeà
__USE_LARGEFILE64


1026 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1032 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1033 || 
defšed
 
__USE_MISC


1037 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1043 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1047 #ifdeà
__USE_MISC


1058 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1063 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1075 
	#F_ULOCK
 0

	)

1076 
	#F_LOCK
 1

	)

1077 
	#F_TLOCK
 2

	)

1078 
	#F_TEST
 3

	)

1080 #iâdeà
__USE_FILE_OFFSET64


1081 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1083 #ifdeà
__REDIRECT


1084 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1085 
lockf64
è
__wur
;

1087 
	#lockf
 
lockf64


	)

1090 #ifdeà
__USE_LARGEFILE64


1091 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1096 #ifdeà
__USE_GNU


1101 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1102 (
__ex‹nsiÚ__
 \

1103 ({ 
__»suÉ
; \

1104 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1105 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1106 
__»suÉ
; 
	}
}))

	)

1109 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1112 
fd©async
 (
__fdes
);

1118 #ifdef 
__USE_XOPEN


1120 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1121 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1125 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1126 
__THROW
 
	`__nÚnuÎ
 ((1));

1133 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1134 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1140 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1142 *
	$ù”mid
 (*
__s
è
__THROW
;

1147 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1148 
	~<b™s/uni¡d.h
>

1151 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_BSD


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_BSD
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #undeà
__USE_ISOC11


102 #undeà
__USE_ISOC99


103 #undeà
__USE_ISOC95


104 #undeà
__USE_ISOCXX11


105 #undeà
__USE_POSIX


106 #undeà
__USE_POSIX2


107 #undeà
__USE_POSIX199309


108 #undeà
__USE_POSIX199506


109 #undeà
__USE_XOPEN


110 #undeà
__USE_XOPEN_EXTENDED


111 #undeà
__USE_UNIX98


112 #undeà
__USE_XOPEN2K


113 #undeà
__USE_XOPEN2KXSI


114 #undeà
__USE_XOPEN2K8


115 #undeà
__USE_XOPEN2K8XSI


116 #undeà
__USE_LARGEFILE


117 #undeà
__USE_LARGEFILE64


118 #undeà
__USE_FILE_OFFSET64


119 #undeà
__USE_BSD


120 #undeà
__USE_SVID


121 #undeà
__USE_MISC


122 #undeà
__USE_ATFILE


123 #undeà
__USE_GNU


124 #undeà
__USE_REENTRANT


125 #undeà
__USE_FORTIFY_LEVEL


126 #undeà
__KERNEL_STRICT_NAMES


130 #iâdeà
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

143 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

150 #ifdeà
_GNU_SOURCE


151 #undeà
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #undeà
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #undeà
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #undeà
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #undeà
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #undeà
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #undeà
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(
defšed
 
_DEFAULT_SOURCE
 \

180 || (!
defšed
 
	g__STRICT_ANSI__
 \

181 && !
defšed
 
	g_ISOC99_SOURCE
 \

182 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

183 && !
defšed
 
	g_XOPEN_SOURCE
 \

184 && !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
))

185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #undeà
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #undeà
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #ià(
defšed
 
_ISOC11_SOURCE
 \

195 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

201 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

207 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

216 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifdeà
_DEFAULT_SOURCE


224 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #undeà
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #undeà
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #undeà
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #undeà
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #undeà
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #ià(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #undeà
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #ià(
_XOPEN_SOURCE
 - 0) >= 600

285 #ià(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #undeà
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #undeà
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifdeà
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifdeà
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifdeà
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #ià
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<¡dc-´edef.h
>

360 #undeà
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

369 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

372 #iâdeà
__ASSEMBLER__


373 #iâdeà
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

388 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

389 && 
defšed
 
	g__ex‹º_šlše


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


148 #ià
defšed
 
__GLIBC__
 && __GLIBC__ >= 2

149 
	~<b™s/¡dio-lock.h
>

154 
	t_IO_lock_t
;

160 
	s_IO_m¬k”
 {

161 
_IO_m¬k”
 *
	m_Ãxt
;

162 
_IO_FILE
 *
	m_sbuf
;

166 
	m_pos
;

168 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

169 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

170 
	mpublic
:

171 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

172 ~
¡»amm¬k”
();

173 
§všg
(è{  
	m_¥os
 == -2; }

174 
d–
(
¡»amm¬k”
&);

175 
d–
();

180 
	e__codecvt_»suÉ


182 
	m__codecvt_ok
,

183 
	m__codecvt_·¹Ÿl
,

184 
	m__codecvt_”rÜ
,

185 
	m__codecvt_nocÚv


188 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


191 
	s_IO_codecvt


193 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

194 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

195 
	m__mb¡©e_t
 *,

196 cÚ¡ 
	mwch¬_t
 *,

197 cÚ¡ 
	mwch¬_t
 *,

198 cÚ¡ 
	mwch¬_t
 **, *,

200 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

201 
	m__mb¡©e_t
 *, *,

203 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

204 
	m__mb¡©e_t
 *,

206 cÚ¡ **, 
	mwch¬_t
 *,

207 
	mwch¬_t
 *, wchar_t **);

208 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

209 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

210 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

211 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

212 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

214 
_IO_icÚv_t
 
	m__cd_š
;

215 
_IO_icÚv_t
 
	m__cd_out
;

219 
	s_IO_wide_d©a


221 
wch¬_t
 *
	m_IO_»ad_±r
;

222 
wch¬_t
 *
	m_IO_»ad_’d
;

223 
wch¬_t
 *
	m_IO_»ad_ba£
;

224 
wch¬_t
 *
	m_IO_wr™e_ba£
;

225 
wch¬_t
 *
	m_IO_wr™e_±r
;

226 
wch¬_t
 *
	m_IO_wr™e_’d
;

227 
wch¬_t
 *
	m_IO_buf_ba£
;

228 
wch¬_t
 *
	m_IO_buf_’d
;

230 
wch¬_t
 *
	m_IO_§ve_ba£
;

231 
wch¬_t
 *
	m_IO_backup_ba£
;

233 
wch¬_t
 *
	m_IO_§ve_’d
;

235 
__mb¡©e_t
 
	m_IO_¡©e
;

236 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

237 
_IO_codecvt
 
	m_codecvt
;

239 
wch¬_t
 
	m_shÜtbuf
[1];

241 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

245 
	s_IO_FILE
 {

246 
	m_æags
;

247 
	#_IO_fe_æags
 
_æags


	)

251 * 
	m_IO_»ad_±r
;

252 * 
	m_IO_»ad_’d
;

253 * 
	m_IO_»ad_ba£
;

254 * 
	m_IO_wr™e_ba£
;

255 * 
	m_IO_wr™e_±r
;

256 * 
	m_IO_wr™e_’d
;

257 * 
	m_IO_buf_ba£
;

258 * 
	m_IO_buf_’d
;

260 *
	m_IO_§ve_ba£
;

261 *
	m_IO_backup_ba£
;

262 *
	m_IO_§ve_’d
;

264 
_IO_m¬k”
 *
	m_m¬k”s
;

266 
_IO_FILE
 *
	m_chaš
;

268 
	m_f’o
;

270 
	m_blksize
;

272 
	m_æags2
;

274 
_IO_off_t
 
	m_Şd_off£t
;

276 
	#__HAVE_COLUMN


	)

278 
	m_cur_cŞumn
;

279 sigÃd 
	m_vbË_off£t
;

280 
	m_shÜtbuf
[1];

284 
_IO_lock_t
 *
	m_lock
;

285 #ifdeà
_IO_USE_OLD_IO_FILE


288 
	s_IO_FILE_com¶‘e


290 
_IO_FILE
 
	m_fe
;

292 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

293 
_IO_off64_t
 
	m_off£t
;

294 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


296 
_IO_codecvt
 *
	m_codecvt
;

297 
_IO_wide_d©a
 *
	m_wide_d©a
;

298 
_IO_FILE
 *
	m_ä“»s_li¡
;

299 *
	m_ä“»s_buf
;

300 
size_t
 
	m_ä“»s_size
;

302 *
	m__·d1
;

303 *
	m__·d2
;

304 *
	m__·d3
;

305 *
	m__·d4
;

306 
size_t
 
	m__·d5
;

308 
	m_mode
;

310 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

314 #iâdeà
__ılu¥lus


315 
_IO_FILE
 
	t_IO_FILE
;

318 
	g_IO_FILE_¶us
;

320 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

321 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

322 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

323 #iâdeà
_LIBC


324 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

325 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

326 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

328 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

329 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

330 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

338 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

346 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

347 
	tsize_t
 
	t__n
);

355 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

358 
	t__io_şo£_â
 (*
	t__cook›
);

361 #ifdeà
_GNU_SOURCE


363 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

364 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

365 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

366 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

371 
__io_»ad_â
 *
	m»ad
;

372 
__io_wr™e_â
 *
	mwr™e
;

373 
__io_£ek_â
 *
	m£ek
;

374 
__io_şo£_â
 *
	mşo£
;

375 } 
	t_IO_cook›_io_funùiÚs_t
;

376 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

378 
	g_IO_cook›_fe
;

381 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

382 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

386 #ifdeà
__ılu¥lus


390 
__und”æow
 (
_IO_FILE
 *);

391 
__uæow
 (
_IO_FILE
 *);

392 
__ov”æow
 (
_IO_FILE
 *, );

393 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


394 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

395 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

396 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

399 #ià 
__GNUC__
 >= 3

400 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

402 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

405 
	#_IO_g‘c_uÆocked
(
_å
) \

406 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

407 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

408 
	#_IO_³ekc_uÆocked
(
_å
) \

409 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

410 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

411 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

412 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

413 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

414 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

415 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

417 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


418 
	#_IO_g‘wc_uÆocked
(
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

422 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

423 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

424 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

425 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

426 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

427 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

428 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

431 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

432 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

434 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

435 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

436 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

437 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

439 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

442 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

443 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

445 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

446 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

447 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

449 #ifdeà
_IO_MTSAFE_IO


450 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

451 
	#_IO_æockfe
(
_å
) \

452 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

453 
	#_IO_fuÆockfe
(
_å
) \

454 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

456 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

457 
	#_IO_æockfe
(
_å
è

	)

458 
	#_IO_fuÆockfe
(
_å
è

	)

459 
	#_IO_árylockfe
(
_å
è

	)

460 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

461 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

464 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

465 
_IO_va_li¡
, *
__»¡riù
);

466 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

467 
_IO_va_li¡
);

468 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

469 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

471 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

472 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

474 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

476 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


477 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

478 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

479 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

480 #ià
__GNUC__
 >= 2

483 #ià
defšed
 
_LIBC
 && defšed 
SHARED


484 
	~<shlib-com·t.h
>

485 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

486 
	#_IO_fwide_maybe_šcom·tibË
 \

487 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

488 cÚ¡ 
_IO_¡dš_u£d
;

489 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

492 #iâdeà
_IO_fwide_maybe_šcom·tibË


493 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

497 
	#_IO_fwide
(
__å
, 
__mode
) \

498 ({ 
__»suÉ
 = (
__mode
); \

499 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

501 ià((
__å
)->
_mode
 == 0) \

503 (
__å
)->
_mode
 = -1; \

504 
__»suÉ
 = (
__å
)->
_mode
; \

506 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

507 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

509 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

510 
__»suÉ
; })

	)

513 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

514 
_IO_va_li¡
, *
__»¡riù
);

515 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

516 
_IO_va_li¡
);

517 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

518 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

521 #ifdeà
__LDBL_COMPAT


522 
	~<b™s/libio-ldbl.h
>

525 #ifdeà
__ılu¥lus


	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__k”Ãl_fd_£t
;

29 (*
	t__k”Ãl_sighªdËr_t
)();

32 
	t__k”Ãl_key_t
;

33 
	t__k”Ãl_mqd_t
;

35 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/socket.h

1 #iâdeà
_LINUX_SOCKET_H


2 
	#_LINUX_SOCKET_H


	)

7 
	#_K_SS_MAXSIZE
 128

	)

8 
	#_K_SS_ALIGNSIZE
 (
	`__®ignof__
 (
sockaddr
 *))

	)

11 
	t__k”Ãl_§_çmy_t
;

13 
	s__k”Ãl_sockaddr_¡Üage
 {

14 
__k”Ãl_§_çmy_t
 
	mss_çmy
;

16 
	m__d©a
[
_K_SS_MAXSIZE
 - ()];

19 } 
__©Œibu‹__
 ((
®igÃd
(
_K_SS_ALIGNSIZE
)));

	@/usr/include/netinet/if_ether.h

18 #iâdeà
__NETINET_IF_ETHER_H


20 
	#__NETINET_IF_ETHER_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<sys/ty³s.h
>

25 
	~<lšux/if_‘h”.h
>

27 #ifdeà
__USE_BSD


60 
	~<Ãt/‘h”Ãt.h
>

61 
	~<Ãt/if_¬p.h
>

63 
__BEGIN_DECLS


71 
	s‘h”_¬p
 {

72 
¬phdr
 
	m—_hdr
;

73 
u_št8_t
 
	m¬p_sha
[
ETH_ALEN
];

74 
u_št8_t
 
	m¬p_¥a
[4];

75 
u_št8_t
 
	m¬p_tha
[
ETH_ALEN
];

76 
u_št8_t
 
	m¬p_a
[4];

78 
	#¬p_hrd
 
—_hdr
.
¬_hrd


	)

79 
	#¬p_´o
 
—_hdr
.
¬_´o


	)

80 
	#¬p_hÊ
 
—_hdr
.
¬_hÊ


	)

81 
	#¬p_¶n
 
—_hdr
.
¬_¶n


	)

82 
	#¬p_İ
 
—_hdr
.
¬_İ


	)

89 
	#ETHER_MAP_IP_MULTICAST
(
addr
, 
’addr
) \

93 (
’addr
)[0] = 0x01; \

94 (
’addr
)[1] = 0x00; \

95 (
’addr
)[2] = 0x5e; \

96 (
’addr
)[3] = ((
u_št8_t
 *)
addr
)[1] & 0x7f; \

97 (
’addr
)[4] = ((
u_št8_t
 *)
addr
)[2]; \

98 (
’addr
)[5] = ((
u_št8_t
 *)
addr
)[3]; \

99 }

	)

101 
	g__END_DECLS


	@/usr/include/numacompat1.h

1 
	#numa_£t_š‹¾—ve_mask
(
m
è
	`numa_£t_š‹¾—ve_mask_com·t
(m)

	)

2 
	#numa_g‘_š‹¾—ve_mask
(è
	`numa_g‘_š‹¾—ve_mask_com·t
()

	)

3 
	#numa_bšd
(
m
è
	`numa_bšd_com·t
(m)

	)

4 
	#numa_g‘_membšd
(
m
è
	`numa_g‘_membšd_com·t
(m)

	)

5 
	#numa_£t_membšd
(
m
è
	`numa_£t_membšd_com·t
(m)

	)

6 
	#numa_®loc_š‹¾—ved_sub£t
(
s
,
m
è
	`numa_®loc_š‹¾—ved_sub£t_com·t
(s,m)

	)

7 
	#numa_run_Ú_node_mask
(
m
è
	`numa_run_Ú_node_mask_com·t
(m)

	)

8 
	#numa_g‘_run_node_mask
(è
	`numa_g‘_run_node_mask_com·t
()

	)

9 
	#numa_š‹¾—ve_memÜy
(
¡
,
si
,
m
è
	`numa_š‹¾—ve_memÜy_com·t
(¡,si,m)

	)

10 
	#numa_tÚodemask_memÜy
(
¡
,
si
,
m
è
	`numa_tÚodemask_memÜy_com·t
(¡,si,m)

	)

11 
	#numa_sched_g‘affš™y
(
p
,
l
,
m
è
	`numa_sched_g‘affš™y_com·t
Õ,l,m)

	)

12 
	#numa_sched_£ffš™y
(
p
,
l
,
m
è
	`numa_sched_£ffš™y_com·t
Õ,l,m)

	)

13 
	#numa_node_to_ıus
(
n
,
b
,
bl
è
	`numa_node_to_ıus_com·t
Ò,b,bl)

	)

14 
	#nodemask_z”o
(
m
è
	`nodemask_z”o_com·t
(m)

	)

15 
	#nodemask_£t
(
m
, 
n
è
	`nodemask_£t_com·t
(m,‚)

	)

16 
	#nodemask_şr
(
m
, 
n
è
	`nodemask_şr_com·t
(m,‚)

	)

17 
	#nodemask_is£t
(
m
, 
n
è
	`nodemask_is£t_com·t
(m,‚)

	)

18 
	#nodemask_equ®
(
a
, 
b
è
	`nodemask_equ®_com·t
×, b)

	)

	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/linux/stddef.h

	@/usr/include/net/if_arp.h

22 #iâdeà
_NET_IF_ARP_H


24 
	#_NET_IF_ARP_H
 1

	)

25 
	~<sys/cdefs.h
>

27 
	~<sys/ty³s.h
>

28 
	~<sys/sock‘.h
>

30 
	g__BEGIN_DECLS


33 
	#MAX_ADDR_LEN
 7

	)

39 
	#ARPOP_REQUEST
 1

	)

40 
	#ARPOP_REPLY
 2

	)

41 
	#ARPOP_RREQUEST
 3

	)

42 
	#ARPOP_RREPLY
 4

	)

43 
	#ARPOP_InREQUEST
 8

	)

44 
	#ARPOP_InREPLY
 9

	)

45 
	#ARPOP_NAK
 10

	)

54 
	s¬phdr


56 
	m¬_hrd
;

57 
	m¬_´o
;

58 
	m¬_hÊ
;

59 
	m¬_¶n
;

60 
	m¬_İ
;

64 
	m__¬_sha
[
ETH_ALEN
];

65 
	m__¬_s
[4];

66 
	m__¬_tha
[
ETH_ALEN
];

67 
	m__¬_t
[4];

73 
	#ARPHRD_NETROM
 0

	)

74 
	#ARPHRD_ETHER
 1

	)

75 
	#ARPHRD_EETHER
 2

	)

76 
	#ARPHRD_AX25
 3

	)

77 
	#ARPHRD_PRONET
 4

	)

78 
	#ARPHRD_CHAOS
 5

	)

79 
	#ARPHRD_IEEE802
 6

	)

80 
	#ARPHRD_ARCNET
 7

	)

81 
	#ARPHRD_APPLETLK
 8

	)

82 
	#ARPHRD_DLCI
 15

	)

83 
	#ARPHRD_ATM
 19

	)

84 
	#ARPHRD_METRICOM
 23

	)

85 
	#ARPHRD_IEEE1394
 24

	)

86 
	#ARPHRD_EUI64
 27

	)

87 
	#ARPHRD_INFINIBAND
 32

	)

90 
	#ARPHRD_SLIP
 256

	)

91 
	#ARPHRD_CSLIP
 257

	)

92 
	#ARPHRD_SLIP6
 258

	)

93 
	#ARPHRD_CSLIP6
 259

	)

94 
	#ARPHRD_RSRVD
 260

	)

95 
	#ARPHRD_ADAPT
 264

	)

96 
	#ARPHRD_ROSE
 270

	)

97 
	#ARPHRD_X25
 271

	)

98 
	#ARPHRD_HWX25
 272

	)

99 
	#ARPHRD_PPP
 512

	)

100 
	#ARPHRD_CISCO
 513

	)

101 
	#ARPHRD_HDLC
 
ARPHRD_CISCO


	)

102 
	#ARPHRD_LAPB
 516

	)

103 
	#ARPHRD_DDCMP
 517

	)

104 
	#ARPHRD_RAWHDLC
 518

	)

106 
	#ARPHRD_TUNNEL
 768

	)

107 
	#ARPHRD_TUNNEL6
 769

	)

108 
	#ARPHRD_FRAD
 770

	)

109 
	#ARPHRD_SKIP
 771

	)

110 
	#ARPHRD_LOOPBACK
 772

	)

111 
	#ARPHRD_LOCALTLK
 773

	)

112 
	#ARPHRD_FDDI
 774

	)

113 
	#ARPHRD_BIF
 775

	)

114 
	#ARPHRD_SIT
 776

	)

115 
	#ARPHRD_IPDDP
 777

	)

116 
	#ARPHRD_IPGRE
 778

	)

117 
	#ARPHRD_PIMREG
 779

	)

118 
	#ARPHRD_HIPPI
 780

	)

119 
	#ARPHRD_ASH
 781

	)

120 
	#ARPHRD_ECONET
 782

	)

121 
	#ARPHRD_IRDA
 783

	)

122 
	#ARPHRD_FCPP
 784

	)

123 
	#ARPHRD_FCAL
 785

	)

124 
	#ARPHRD_FCPL
 786

	)

125 
	#ARPHRD_FCFABRIC
 787

	)

126 
	#ARPHRD_IEEE802_TR
 800

	)

127 
	#ARPHRD_IEEE80211
 801

	)

128 
	#ARPHRD_IEEE80211_PRISM
 802

	)

129 
	#ARPHRD_IEEE80211_RADIOTAP
 803

	)

130 
	#ARPHRD_IEEE802154
 804

	)

131 
	#ARPHRD_IEEE802154_PHY
 805

	)

133 
	#ARPHRD_VOID
 0xFFFF

	)

134 
	#ARPHRD_NONE
 0xFFFE

	)

138 
	s¬´eq


140 
sockaddr
 
	m¬p_·
;

141 
sockaddr
 
	m¬p_ha
;

142 
	m¬p_æags
;

143 
sockaddr
 
	m¬p_Ãtmask
;

144 
	m¬p_dev
[16];

147 
	s¬´eq_Şd


149 
sockaddr
 
	m¬p_·
;

150 
sockaddr
 
	m¬p_ha
;

151 
	m¬p_æags
;

152 
sockaddr
 
	m¬p_Ãtmask
;

156 
	#ATF_COM
 0x02

	)

157 
	#ATF_PERM
 0x04

	)

158 
	#ATF_PUBL
 0x08

	)

159 
	#ATF_USETRAILERS
 0x10

	)

160 
	#ATF_NETMASK
 0x20

	)

162 
	#ATF_DONTPUB
 0x40

	)

163 
	#ATF_MAGIC
 0x80

	)

167 
	#ARPD_UPDATE
 0x01

	)

168 
	#ARPD_LOOKUP
 0x02

	)

169 
	#ARPD_FLUSH
 0x03

	)

171 
	s¬pd_»que¡


173 
	m»q
;

174 
u_št32_t
 
	m
;

175 
	mdev
;

176 
	m¡amp
;

177 
	mupd©ed
;

178 
	mha
[
MAX_ADDR_LEN
];

181 
	g__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004

64 
	g__gcÚv_¡•
;

65 
	g__gcÚv_¡•_d©a
;

66 
	g__gcÚv_lßded_objeù
;

67 
	g__gcÚv_Œªs_d©a
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 (*
	t__gcÚv_Œªs_fù
è(
	t__gcÚv_¡•
 *,

85 
	t__gcÚv_¡•_d©a
 *, *,

89 
	tsize_t
 *);

92 (*
	t__gcÚv_Œªs_cÚ‹xt_fù
) (*, const *,

97 (*
	t__gcÚv_Œªs_qu”y_fù
) (const *, const ***,

98 
	tsize_t
 *);

101 (*
	t__gcÚv_Œªs_š™_fù
) (**, const *);

102 (*
	t__gcÚv_Œªs_’d_fù
) (*);

104 
	s__gcÚv_Œªs_d©a


107 
__gcÚv_Œªs_fù
 
__Œªs_fù
;

108 
__gcÚv_Œªs_cÚ‹xt_fù
 
__Œªs_cÚ‹xt_fù
;

109 
__gcÚv_Œªs_’d_fù
 
__Œªs_’d_fù
;

110 *
__d©a
;

111 
__gcÚv_Œªs_d©a
 *
__Ãxt
;

116 
	s__gcÚv_¡•


118 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

119 cÚ¡ *
__modÇme
;

121 
__couÁ”
;

123 *
__äom_Çme
;

124 *
__to_Çme
;

126 
__gcÚv_fù
 
__fù
;

127 
__gcÚv_btowc_fù
 
__btowc_fù
;

128 
__gcÚv_š™_fù
 
__š™_fù
;

129 
__gcÚv_’d_fù
 
__’d_fù
;

133 
__mš_Ãeded_äom
;

134 
__max_Ãeded_äom
;

135 
__mš_Ãeded_to
;

136 
__max_Ãeded_to
;

139 
__¡©eful
;

141 *
__d©a
;

146 
	s__gcÚv_¡•_d©a


148 *
__outbuf
;

149 *
__outbuãnd
;

153 
__æags
;

157 
__švoÿtiÚ_couÁ”
;

161 
__š‹º®_u£
;

163 
__mb¡©e_t
 *
__¡©•
;

164 
__mb¡©e_t
 
__¡©e
;

168 
__gcÚv_Œªs_d©a
 *
__Œªs
;

173 
	s__gcÚv_šfo


175 
size_t
 
__n¡•s
;

176 
__gcÚv_¡•
 *
__¡•s
;

177 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

178 } *
	t__gcÚv_t
;

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

150 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

151 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
;

155 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

156 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

158 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

159 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

160 
__THROW
;

163 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

164 
__THROW
 
__©Œibu‹_pu»__
;

166 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

167 
__THROW
 
__©Œibu‹_pu»__
;

168 
__END_NAMESPACE_STD


170 #ifdeà
__USE_XOPEN2K8


172 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

175 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

176 
size_t
 
__n
è
__THROW
;

180 
	~<xloÿË.h
>

182 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

183 
__loÿË_t
 
__loc
è
__THROW
;

185 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


192 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

196 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

197 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

198 
__END_NAMESPACE_STD


200 #ifdeà
__USE_XOPEN2K8


206 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

207 
__loÿË_t
 
__loc
è
__THROW
;

212 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

213 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

216 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

219 
__BEGIN_NAMESPACE_STD


221 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


222 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

223 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

224 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

225 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
__©Œibu‹_pu»__
;

231 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


232 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

233 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

234 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

235 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
__©Œibu‹_pu»__
;

240 
__END_NAMESPACE_STD


242 #ifdeà
__USE_GNU


245 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

246 
__THROW
 
__©Œibu‹_pu»__
;

249 
__BEGIN_NAMESPACE_STD


252 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

253 
__THROW
 
__©Œibu‹_pu»__
;

256 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

257 
__THROW
 
__©Œibu‹_pu»__
;

259 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


260 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

261 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

262 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

263 cÚ¡ 
wch¬_t
 *
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

266 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

267 
__THROW
 
__©Œibu‹_pu»__
;

270 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


271 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

272 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

273 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

274 cÚ¡ 
wch¬_t
 *
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

277 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

278 
__THROW
 
__©Œibu‹_pu»__
;

282 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

283 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

284 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

287 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

288 
__END_NAMESPACE_STD


290 #ifdeà
__USE_XOPEN


292 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


293 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

294 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

295 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

296 cÚ¡ 
wch¬_t
 *
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

299 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

300 
__THROW
 
__©Œibu‹_pu»__
;

304 #ifdeà
__USE_XOPEN2K8


306 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

307 
__THROW
 
__©Œibu‹_pu»__
;

311 
__BEGIN_NAMESPACE_STD


313 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


314 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

315 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

316 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

317 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

320 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

321 
__THROW
 
__©Œibu‹_pu»__
;

325 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

326 
__THROW
 
__©Œibu‹_pu»__
;

329 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

330 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

334 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

335 
__THROW
;

338 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

339 
__END_NAMESPACE_STD


341 #ifdeà
__USE_GNU


344 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

345 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

346 
__THROW
;

350 
__BEGIN_NAMESPACE_STD


353 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

357 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

361 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

365 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

366 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

367 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

370 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

371 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

374 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

375 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

376 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

377 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

378 
__END_NAMESPACE_STD


380 #ifdeà
__USE_EXTERN_INLINES


386 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

387 
__ex‹º_šlše
 
wšt_t


388 
	`__NTH
 (
	$btowc
 (
__c
))

389 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

390 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

392 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

393 
__ex‹º_šlše
 

394 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

395 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

396 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

398 
__ex‹º_šlše
 
size_t


399 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

400 
mb¡©e_t
 *
__»¡riù
 
__ps
))

401 {  (
__ps
 !ğ
NULL


402 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

405 
__BEGIN_NAMESPACE_STD


408 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

409 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

410 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

414 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

415 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

416 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
__END_NAMESPACE_STD


420 #ifdef 
__USE_XOPEN2K8


423 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

424 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

425 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

429 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

430 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

431 
size_t
 
__nwc
, size_ˆ
__Ën
,

432 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

437 #ifdeà
__USE_XOPEN


439 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

443 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

447 
__BEGIN_NAMESPACE_STD


450 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

451 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

452 
__END_NAMESPACE_STD


454 #ifdeà
__USE_ISOC99


455 
__BEGIN_NAMESPACE_C99


457 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

458 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

459 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

460 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

461 
__END_NAMESPACE_C99


465 
__BEGIN_NAMESPACE_STD


468 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

469 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

473 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

474 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

475 
__THROW
;

476 
__END_NAMESPACE_STD


478 #ifdeà
__USE_ISOC99


479 
__BEGIN_NAMESPACE_C99


482 
__ex‹nsiÚ__


483 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

484 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

485 
__THROW
;

489 
__ex‹nsiÚ__


490 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

491 
wch¬_t
 **
__»¡riù
 
__’d±r
,

492 
__ba£
è
__THROW
;

493 
__END_NAMESPACE_C99


496 #ifdeà
__USE_GNU


499 
__ex‹nsiÚ__


500 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

501 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

502 
__THROW
;

506 
__ex‹nsiÚ__


507 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

508 
wch¬_t
 **
__»¡riù
 
__’d±r
,

509 
__ba£
è
__THROW
;

512 #ifdeà
__USE_GNU


526 
	~<xloÿË.h
>

530 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

531 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

532 
__loÿË_t
 
__loc
è
__THROW
;

534 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

535 
wch¬_t
 **
__»¡riù
 
__’d±r
,

536 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

538 
__ex‹nsiÚ__


539 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

540 
wch¬_t
 **
__»¡riù
 
__’d±r
,

541 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

543 
__ex‹nsiÚ__


544 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

545 
wch¬_t
 **
__»¡riù
 
__’d±r
,

546 
__ba£
, 
__loÿË_t
 
__loc
)

547 
__THROW
;

549 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

550 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

551 
__THROW
;

553 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

554 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

555 
__THROW
;

557 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

558 
wch¬_t
 **
__»¡riù
 
__’d±r
,

559 
__loÿË_t
 
__loc
è
__THROW
;

563 #ifdeà
__USE_XOPEN2K8


566 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

567 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

571 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

572 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

573 
__THROW
;

580 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

583 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


584 
__BEGIN_NAMESPACE_STD


587 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

594 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

595 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

601 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

605 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

606 
__THROW
 ;

612 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

613 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

614 
__gnuc_va_li¡
 
__¬g
)

620 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

621 
__gnuc_va_li¡
 
__¬g
)

625 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

626 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

627 
__gnuc_va_li¡
 
__¬g
)

628 
__THROW
 ;

635 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

636 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

642 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

646 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

647 
__THROW
 ;

649 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

650 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

651 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

652 #ifdeà
__REDIRECT


656 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

657 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

658 
__isoc99_fwsÿnf
)

660 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_wsÿnf
)

663 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

664 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

665 ...), 
__isoc99_swsÿnf
)

668 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

669 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

670 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

671 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

673 
__THROW
;

674 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

675 
	#wsÿnf
 
__isoc99_wsÿnf


	)

676 
	#swsÿnf
 
__isoc99_swsÿnf


	)

680 
__END_NAMESPACE_STD


683 #ifdeà
__USE_ISOC99


684 
__BEGIN_NAMESPACE_C99


689 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

690 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

691 
__gnuc_va_li¡
 
__¬g
)

697 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

698 
__gnuc_va_li¡
 
__¬g
)

701 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

702 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

703 
__gnuc_va_li¡
 
__¬g
)

704 
__THROW
 ;

706 #ià!
defšed
 
__USE_GNU
 \

707 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

708 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

709 #ifdeà
__REDIRECT


710 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

711 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

712 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

714 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

717 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

718 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

719 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

722 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

723 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

724 
__gnuc_va_li¡
 
__¬g
);

725 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

726 
__gnuc_va_li¡
 
__¬g
);

727 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

728 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

730 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

731 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

732 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

736 
__END_NAMESPACE_C99


740 
__BEGIN_NAMESPACE_STD


745 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

746 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

752 
wšt_t
 
	`g‘wch¬
 ();

759 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

760 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

766 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

774 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

775 
__FILE
 *
__»¡riù
 
__¡»am
);

781 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

782 
__FILE
 *
__»¡riù
 
__¡»am
);

789 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

790 
__END_NAMESPACE_STD


793 #ifdeà
__USE_GNU


801 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

802 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

810 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

818 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

827 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

828 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

837 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

838 
__FILE
 *
__»¡riù
 
__¡»am
);

846 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

847 
__FILE
 *
__»¡riù
 
__¡»am
);

851 
__BEGIN_NAMESPACE_C99


855 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

856 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

857 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

858 
__END_NAMESPACE_C99


860 #ifdeà
__USE_GNU


861 
	~<xloÿË.h
>

865 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

866 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

867 cÚ¡ 
tm
 *
__»¡riù
 
__
,

868 
__loÿË_t
 
__loc
è
__THROW
;

877 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


878 
	#__Ãed_iswxxx


	)

879 
	~<wùy³.h
>

883 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


884 
	~<b™s/wch¬2.h
>

887 #ifdeà
__LDBL_COMPAT


888 
	~<b™s/wch¬-ldbl.h
>

891 
__END_DECLS


899 #undeà
__Ãed_mb¡©e_t


900 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
160
3521
addr_pool.cpp
api.cpp
arp.cpp
config.cpp
core.cpp
cpu.cpp
debug.cpp
dpdk_module.cpp
eth_in.cpp
eth_out.cpp
eventpoll.cpp
fhash.cpp
icmp.cpp
include/addr_pool.h
include/arp.h
include/config.h
include/cpu.h
include/ctrs.h
include/debug.h
include/eth_in.h
include/eth_out.h
include/eventpoll.h
include/fhash.h
include/icmp.h
include/io_module.h
include/ip_in.h
include/ip_out.h
include/logger.h
include/memory_mgt.h
include/mtcp.h
include/mtcp_api.h
include/mtcp_epoll.h
include/netmap.h
include/netmap_api.h
include/netmap_api_arp_tested.h
include/netmap_api_cache_friendly.h
include/netmap_api_cache_unfriendly.cpp
include/netmap_api_cache_unfriendly.h
include/netmap_api_original.h
include/netmap_user.h
include/pipe.h
include/ps.h
include/rss.h
include/socket.h
include/stat.h
include/tcp_in.h
include/tcp_out.h
include/tcp_rb_frag_queue.h
include/tcp_ring_buffer.h
include/tcp_sb_queue.h
include/tcp_send_buffer.h
include/tcp_stream.h
include/tcp_stream_queue.h
include/tcp_util.h
include/timer.h
io_module.cpp
ip_check.cpp
ip_in.cpp
ip_out.cpp
logger.cpp
memory_mgt.cpp
netmap_api.cpp
netmap_api_arp_alt.cpp
netmap_api_arp_tested.cpp
netmap_api_bak.cpp
netmap_api_bak_new.cpp
netmap_api_cache_friendly.cpp
netmap_api_cache_unfriendly.cpp
netmap_api_hp_bk.cpp
netmap_api_mod.cpp
netmap_api_newbak1.cpp
netmap_api_newbak2.cpp
netmap_api_old.cpp
netmap_api_original.cpp
netmap_api_parts3.cpp
netmap_api_tested_final_uncleaned.cpp
netmap_api_working_without_1core.cpp
netmap_module.cpp
pipe.cpp
psio_module.cpp
rss.cpp
socket.cpp
tcp_in.cpp
tcp_out.cpp
tcp_rb_frag_queue.cpp
tcp_ring_buffer.cpp
tcp_sb_queue.cpp
tcp_send_buffer.cpp
tcp_stream.cpp
tcp_stream_queue.cpp
tcp_util.cpp
testing/TestClient/client.cpp
testing/TestServer/server.cpp
testing/epserver/epserver.cpp
testing/epserver/http_parsing.cpp
testing/epserver/http_parsing.h
testing/epserver/tdate_parse.cpp
testing/epserver/tdate_parse.h
testing/epserver/www_home/epserver.c
testing_multi/TestMultiClient/client.cpp
testing_multi/TestMultiClient/client_app.cpp
testing_multi/TestMultiClient/client_new.cpp
testing_multi/TestMultiClient/client_old.cpp
testing_multi/TestMultiClient/client_old_new.cpp
testing_multi/TestMultiClient/client_rss.cpp
testing_multi/TestMultiServer/server.cpp
timer.cpp
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/dirent.h
/usr/include/errno.h
/usr/include/fcntl.h
/usr/include/ifaddrs.h
/usr/include/inttypes.h
/usr/include/limits.h
/usr/include/linux/if_ether.h
/usr/include/linux/tcp.h
/usr/include/linux/types.h
/usr/include/linux/udp.h
/usr/include/math.h
/usr/include/memory.h
/usr/include/net/ethernet.h
/usr/include/net/if.h
/usr/include/netdb.h
/usr/include/netinet/ether.h
/usr/include/netinet/in.h
/usr/include/netinet/ip.h
/usr/include/netinet/ip6.h
/usr/include/numa.h
/usr/include/pthread.h
/usr/include/sched.h
/usr/include/semaphore.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/strings.h
/usr/include/syslog.h
/usr/include/time.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/linux/posix_types.h
/usr/include/linux/socket.h
/usr/include/netinet/if_ether.h
/usr/include/numacompat1.h
/usr/include/rpc/netdb.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/linux/stddef.h
/usr/include/net/if_arp.h
/usr/include/stdc-predef.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
